<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>2</storyId>
    <title>Development Quality Tools & CI/CD Pipeline</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs-bmad/sprint-artifacts/1-2-development-quality-tools-cicd-pipeline.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer</asA>
    <iWant>pre-commit hooks and CI/CD pipeline configured for code quality enforcement</iWant>
    <soThat>code quality is maintained automatically and issues are caught early</soThat>
    <tasks>
      - Task 1: Install and Configure Pre-commit (AC: #1, #2)
        - Add pre-commit and isort to dev dependencies in pyproject.toml
        - Create .pre-commit-config.yaml in repository root
        - Configure black hook with version (>=24.1) and args
        - Configure isort hook with version (~=5.12) and args
        - Configure mypy hook with version (>=1.8) and additional dependencies
        - Configure ruff hook with version (>=0.2)
        - Test hooks and verify configuration
        - Document pre-commit setup in README.md

      - Task 2: Configure Development Tools in pyproject.toml (AC: #6)
        - Add [tool.black] section with line-length and target-version
        - Add [tool.isort] section with black-compatible profile
        - Add [tool.ruff] section with rule selection
        - Add [tool.mypy] section with strict configuration
        - Add [tool.pytest.ini_options] section with coverage settings
        - Test each tool locally

      - Task 3: Create GitHub Actions CI/CD Workflow (AC: #3, #4, #5)
        - Create .github/workflows/ directory
        - Create .github/workflows/ci.yml workflow file
        - Configure workflow triggers (pull_request, push to main)
        - Define job matrix for Python 3.12 and 3.13
        - Add steps for checkout, setup, dependencies, tests, linting, type checking
        - Configure caching for uv dependencies
        - Test workflow by creating pull request

      - Task 4: Configure Coverage Reporting (AC: #4)
        - Configure coverage threshold in pyproject.toml (>80%)
        - Configure coverage run and report sections
        - Add coverage report step to CI workflow
        - Test locally and verify CI fails when coverage drops below 80%

      - Task 5: Update Documentation (AC: #7)
        - Add Development Workflow section to README.md
        - Document pre-commit hook installation
        - Document running quality checks locally
        - Document CI/CD pipeline behavior
        - Add CI and coverage badges to README.md
        - Update .gitignore to exclude coverage files

      - Task 6: Test Complete Development Workflow (AC: #2, #4)
        - Create test branch with intentional issues
        - Verify pre-commit hooks catch and block commit
        - Push branch and create pull request
        - Verify CI pipeline runs and catches issues
        - Merge successful PR to main
        - Test all acceptance criteria validation
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Pre-commit Configuration Created
       - .pre-commit-config.yaml file exists in repository root
       - Configured hooks: black, isort, mypy, ruff
       - Each hook has pinned version in configuration
       - Hooks can be installed via `pre-commit install` command

    2. Pre-commit Hooks Function Correctly
       - Hooks run automatically before each git commit
       - Black enforces consistent code formatting (88 character line length)
       - isort sorts imports alphabetically with black-compatible profile
       - mypy performs strict type checking (disallow_untyped_defs=true, warn_return_any=true, strict_optional=true)
       - ruff lints code for common issues (replaces flake8/pylint)
       - Commit is blocked if any hook fails (must fix before committing)

    3. GitHub Actions CI/CD Pipeline Created
       - .github/workflows/ci.yml file exists
       - Pipeline triggers on: pull requests to main, pushes to main branch
       - Workflow runs on multiple Python versions: 3.12 and 3.13
       - Workflow includes jobs: install dependencies, run tests, run linting, run type checking, generate coverage report

    4. CI/CD Quality Gates Enforced
       - All tests must pass (pytest with zero failures)
       - Linting must pass (ruff check with zero errors)
       - Type checking must pass (mypy --strict with zero errors)
       - Code coverage must be >80% (pytest-cov with coverage threshold)
       - Pipeline fails and blocks merge if any validation fails

    5. CI/CD Performance Optimized
       - Dependencies cached between runs (uv cache, pip cache)
       - Typical pipeline execution time <5 minutes for standard changes
       - Parallel job execution where possible (linting, type checking, tests can run concurrently)

    6. Development Tool Configuration
       - pyproject.toml contains tool configurations: [tool.black], [tool.isort], [tool.ruff], [tool.mypy], [tool.pytest.ini_options]
       - Black: line-length = 88, target-version = ['py312']
       - isort: profile = "black" (compatible with black formatting)
       - Ruff: select common rule sets (E, F, W, I, N), ignore specific patterns as needed
       - Mypy: strict = true, disallow_untyped_defs = true, warn_return_any = true
       - Pytest: asyncio_mode = "auto", testpaths = ["tests"], coverage threshold configured

    7. Documentation Updated
       - README.md includes section on development workflow: "Contributing" or "Development"
       - Documents how to install pre-commit hooks: `uv run pre-commit install`
       - Documents how to run quality checks locally before committing
       - Documents CI/CD pipeline behavior and quality gates
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs-bmad/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Overview</section>
        <snippet>Epic 1 establishes foundational infrastructure for RabbitMQ MCP Server implementing OpenAPI-driven code generation pipeline and 3-tool semantic discovery pattern. Epic includes project repository setup with Python 3.12+, uv package manager, pre-commit hooks (black, isort, mypy, ruff), and GitHub Actions CI/CD pipeline.</snippet>
      </doc>
      <doc>
        <path>docs-bmad/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Test Strategy Summary</section>
        <snippet>Coverage targets: >80% overall code coverage, >95% coverage for critical paths (search, validation, execution). Generated code and trivial functions may have lower coverage. Coverage threshold enforced in CI to prevent regression.</snippet>
      </doc>
      <doc>
        <path>docs-bmad/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Dependencies and Integrations</section>
        <snippet>Dev dependency versions: pytest>=8.0, mypy>=1.8, black>=24.1, ruff>=0.2, pre-commit, isort~=5.12. Quality tools configured in pyproject.toml for centralized configuration.</snippet>
      </doc>
      <doc>
        <path>docs-bmad/architecture/implementation-patterns.md</path>
        <title>Implementation Patterns</title>
        <section>Code Quality Standards</section>
        <snippet>Pre-commit hooks provide immediate feedback before commit (shift-left quality). CI/CD pipeline provides automated validation on all branches before merge. Dual validation (local + CI) catches issues early and prevents bad code from reaching production. Quality gates are non-negotiable.</snippet>
      </doc>
      <doc>
        <path>docs-bmad/architecture/technology-stack-details.md</path>
        <title>Technology Stack Details</title>
        <section>Code Quality</section>
        <snippet>mypy 1.8+ with --strict mode for static type checking, black 24.0+ for code formatting (88 char line length), isort 5.13+ for import sorting (black-compatible profile), ruff 0.2+ for fast Python linting (replaces flake8/pylint), pre-commit for Git hooks enforcing quality.</snippet>
      </doc>
      <doc>
        <path>docs-bmad/architecture/consistency-rules.md</path>
        <title>Consistency Rules</title>
        <section>Configuration Management</section>
        <snippet>All tool configurations centralized in pyproject.toml following PEP 518 standard. Do NOT use separate config files (.coveragerc, setup.cfg) - use pyproject.toml [tool.*] sections for black, isort, ruff, mypy, pytest, coverage.</snippet>
      </doc>
      <doc>
        <path>docs-bmad/epics/epic-1-foundation-mcp-protocol.md</path>
        <title>Epic 1: Foundation & MCP Protocol</title>
        <section>Story 1.2</section>
        <snippet>Story 1.2 configures pre-commit hooks and CI/CD pipeline for code quality enforcement. Hooks run automatically on commit validating black formatting, isort imports, mypy type checking, ruff linting. GitHub Actions CI/CD pipeline runs on pull requests validating tests pass, linting passes, type checking passes, coverage >80%.</snippet>
      </doc>
      <doc>
        <path>docs-bmad/sprint-artifacts/1-1-project-setup-repository-structure.md</path>
        <title>Story 1.1 Completion</title>
        <section>Dev Agent Record</section>
        <snippet>Story 1.1 completed: Project structure created (src/, tests/, scripts/, data/, config/, docs/, logs/). uv configured and working. pytest, pytest-asyncio, pytest-cov, pytest-mock installed. black, ruff, mypy in dev dependencies. Python version >=3.12,&lt;4.0 enforced. src-layout pattern used. pyproject.toml has packages enumerated correctly.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>pyproject.toml</path>
        <kind>config</kind>
        <symbol>project configuration</symbol>
        <lines>1-196</lines>
        <reason>Contains existing [tool.ruff], [tool.black], [tool.mypy] sections that need to be preserved and potentially extended for Story 1.2. Line-length currently 100 (may need adjustment to 88 per AC). Python version >=3.12,&lt;4.0 already configured.</reason>
      </artifact>
      <artifact>
        <path>.pre-commit-config.yaml</path>
        <kind>config</kind>
        <symbol>pre-commit hooks configuration</symbol>
        <lines>1-90</lines>
        <reason>Already exists with black, ruff, bandit hooks configured. mypy hook is commented out. Story 1.2 needs to enable mypy hook and verify all hook configurations match AC requirements (versions, args, additional dependencies).</reason>
      </artifact>
      <artifact>
        <path>.github/workflows/release.yml</path>
        <kind>workflow</kind>
        <symbol>GitHub Actions release workflow</symbol>
        <lines>all</lines>
        <reason>Existing GitHub Actions workflow for releases. Story 1.2 needs to create separate ci.yml workflow for quality checks (tests, linting, type checking, coverage) that runs on pull requests and pushes to main.</reason>
      </artifact>
      <artifact>
        <path>README.md</path>
        <kind>documentation</kind>
        <symbol>project documentation</symbol>
        <lines>all</lines>
        <reason>Needs to be extended with Development Workflow or Contributing section documenting pre-commit hook installation, local quality checks, CI/CD pipeline behavior, and quality gates. Must preserve existing content.</reason>
      </artifact>
      <artifact>
        <path>.gitignore</path>
        <kind>config</kind>
        <symbol>git ignore patterns</symbol>
        <lines>all</lines>
        <reason>Needs to be verified to include coverage files (.coverage, htmlcov/, coverage.xml). Story 1.1 review noted dist/ should be excluded. Must check existing patterns before adding.</reason>
      </artifact>
      <artifact>
        <path>tests/unit/test_project_setup.py</path>
        <kind>test</kind>
        <symbol>Story 1.1 tests</symbol>
        <lines>all</lines>
        <reason>Example test pattern from Story 1.1 with 17 comprehensive tests covering all ACs. Story 1.2 should follow same pattern creating tests/unit/test_quality_tools.py for pre-commit and CI validation.</reason>
      </artifact>
      <artifact>
        <path>tests/conftest.py</path>
        <kind>test</kind>
        <symbol>pytest configuration and fixtures</symbol>
        <lines>all</lines>
        <reason>Contains shared test fixtures and pytest configuration. May need extensions for testing pre-commit hooks (temporary git repository fixture) and CI workflow validation.</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="pre-commit" version="latest" scope="dev">Pre-commit hook framework (not yet in dependencies, needs to be added)</package>
        <package name="isort" version="~=5.12" scope="dev">Import sorting tool (not yet in dependencies, needs to be added)</package>
        <package name="black" version=">=24.1" scope="dev">Code formatter (already in dependencies)</package>
        <package name="ruff" version=">=0.2" scope="dev">Fast Python linter (already in dependencies)</package>
        <package name="mypy" version=">=1.8" scope="dev">Static type checker (already in dependencies)</package>
        <package name="pytest" version=">=8.0" scope="dev">Test framework (already in dependencies)</package>
        <package name="pytest-cov" version=">=4.1" scope="dev">Coverage plugin (already in dependencies)</package>
        <package name="pytest-asyncio" version=">=0.23" scope="dev">Async test support (already in dependencies)</package>
        <package name="types-pyyaml" version=">=6.0" scope="dev">Type stubs for PyYAML (already in dependencies)</package>
      </python>
      <github_actions>
        <action name="actions/checkout" version="v4">Checkout repository code</action>
        <action name="actions/setup-python" version="v5">Setup Python environment</action>
        <action name="actions/cache" version="v4">Cache dependencies for faster runs</action>
        <action name="codecov/codecov-action" version="v4" optional="true">Upload coverage reports to Codecov</action>
      </github_actions>
    </dependencies>
  </artifacts>

  <constraints>
    - Pre-commit hooks must block commits if validation fails (non-optional enforcement)
    - CI/CD pipeline must fail and block merge if any validation fails (prevent broken code in main)
    - All tool configurations must be in pyproject.toml (do NOT create .coveragerc, setup.cfg, or other config files)
    - Line length: Story specifies 88 chars (Black default), but current pyproject.toml has 100 chars - need to align with architecture decision
    - Multi-version testing: CI must test Python 3.12 and 3.13 (project requires >=3.12,&lt;4.0)
    - Coverage threshold: >80% overall, >95% for critical paths (enforced via pytest-cov --cov-fail-under)
    - Type checking: mypy --strict mode with disallow_untyped_defs=true, warn_return_any=true, strict_optional=true
    - Import sorting: isort with black-compatible profile to prevent conflicts
    - Caching strategy: Cache uv dependencies and pip packages to optimize CI runtime (<5 minutes target)
    - Parallel execution: Run linting, type checking, tests concurrently where possible
    - Fail-fast disabled: Allow all Python versions to run even if one fails (visibility into version-specific issues)
    - src-layout pattern: Type checking targets src/ directory, tests have separate path
    - Coverage configuration: Use package names (rabbitmq_mcp_server, rabbitmq_mcp_connection) not directory paths for src-layout compatibility
  </constraints>

  <interfaces>
    <interface>
      <name>pre-commit hook configuration</name>
      <kind>YAML configuration file</kind>
      <signature>.pre-commit-config.yaml with repos list containing hook definitions (id, args, additional_dependencies)</signature>
      <path>.pre-commit-config.yaml</path>
    </interface>
    <interface>
      <name>GitHub Actions workflow</name>
      <kind>YAML workflow file</kind>
      <signature>.github/workflows/ci.yml with on (triggers), jobs (matrix, steps), and caching configuration</signature>
      <path>.github/workflows/ci.yml</path>
    </interface>
    <interface>
      <name>pyproject.toml tool configurations</name>
      <kind>TOML configuration sections</kind>
      <signature>[tool.black], [tool.isort], [tool.ruff], [tool.mypy], [tool.pytest.ini_options], [tool.coverage.run], [tool.coverage.report]</signature>
      <path>pyproject.toml</path>
    </interface>
    <interface>
      <name>uv package manager commands</name>
      <kind>CLI commands</kind>
      <signature>uv add --dev &lt;package&gt; (add dev dependency), uv run &lt;command&gt; (run tool), uv sync (install dependencies)</signature>
      <path>command line</path>
    </interface>
    <interface>
      <name>pytest with coverage</name>
      <kind>CLI command</kind>
      <signature>pytest --cov=&lt;package&gt; --cov-report=term-missing --cov-report=xml --cov-fail-under=80</signature>
      <path>command line / CI workflow</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing standards for Story 1.2 follow the pattern established in Story 1.1: comprehensive unit tests validating all acceptance criteria using file existence checks, configuration parsing, and subprocess calls. Tests should be organized in tests/unit/test_quality_tools.py with clear test class structure (TestPrecommitConfiguration, TestCIWorkflow, TestToolConfiguration). Each AC should have corresponding test methods. Integration tests should create temporary git repository to verify pre-commit hooks actually block commits. Contract tests should validate CI workflow YAML structure against GitHub Actions schema.
    </standards>
    <locations>
      - tests/unit/test_quality_tools.py (new file for Story 1.2 tests)
      - tests/unit/ (existing unit tests directory)
      - tests/integration/ (existing integration tests directory)
      - tests/contract/ (existing contract tests directory)
    </locations>
    <ideas>
      <idea ac="1">Test .pre-commit-config.yaml exists and contains required hooks (black, isort, mypy, ruff) with correct versions and args. Parse YAML and validate hook ids, repos, and configurations.</idea>
      <idea ac="2">Test pre-commit hooks run and block commits. Create temporary git repository, install hooks, create file with formatting issues, attempt commit, verify hook blocks and provides error message.</idea>
      <idea ac="3">Test .github/workflows/ci.yml exists and has correct structure. Parse YAML and validate triggers (pull_request, push to main), job matrix (Python 3.12, 3.13), steps (checkout, setup, install, test, lint, type check, coverage).</idea>
      <idea ac="4">Test CI enforces quality gates. Mock pytest, ruff, mypy commands to simulate failures and verify workflow would fail. Validate coverage threshold configuration in pyproject.toml.</idea>
      <idea ac="5">Test CI caching configuration. Validate actions/cache step exists in workflow with correct cache key pattern (uv-${{ hashFiles('uv.lock') }}).</idea>
      <idea ac="6">Test tool configurations exist in pyproject.toml. Parse TOML and validate [tool.black], [tool.isort], [tool.ruff], [tool.mypy], [tool.pytest.ini_options] sections with expected values (line-length, profiles, rules, strict settings).</idea>
      <idea ac="7">Test README.md contains Development Workflow section. Parse markdown and verify section exists with pre-commit installation instructions, local quality check commands, and CI/CD documentation.</idea>
      <idea ac="all">Create integration test that exercises complete workflow: initialize git repo, install pre-commit, make changes, commit, verify hooks run. Create contract test validating CI workflow against GitHub Actions JSON schema.</idea>
    </ideas>
  </tests>
</story-context>
