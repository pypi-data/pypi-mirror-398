"""Simple test to verify storage layer functionality.""" import os import tempfile import json from datetime import datetime from pathlib import Path from .database import DatabaseConfig, configure_database, init_database from .repository import SnapshotRepository, SessionRepository from .artifacts import ArtifactManager def test_storage_integration: """Basic integration test for storage components.""" # Use temporary database for testing with tempfile.TemporaryDirectory as temp_dir: db_path = Path(temp_dir) / "test.db" storage_path = Path(temp_dir) / "artifacts" # Configure test database config = DatabaseConfig(url=f"sqlite:///{db_path}", echo=False) configure_database(config) init_database # Test session creation session_repo = SessionRepository session_id = "test_session_001" session = session_repo.create_session( session_id=session_id, name="Test Session", description="Integration test session", metadata={"test": True} ) print(f"Created session: {session}") # Test snapshot creation snapshot_repo = SnapshotRepository snapshot_id = "snapshot_001" input_data = {"prompt": "Hello, world.", "temperature": 0.7} output_data = {"response": "Hello. How can I help you today?", "tokens": 42} snapshot = snapshot_repo.create_snapshot( snapshot_id=snapshot_id, session_id=session_id, model_name="test-model", model_version="v1.0", input_data=input_data, output_data=output_data, metadata={"test_run": True} ) print(f"Created snapshot: {snapshot}") # Test artifact storage artifact_manager = ArtifactManager(storage_path=str(storage_path)) # Store a configuration artifact config_data = {"temperature": 0.7, "max_tokens": 100} config_artifact = artifact_manager.store_artifact( snapshot_id=snapshot_id, name="model_config.json", content=json.dumps(config_data).encode, artifact_type="config", metadata={"format": "json"} ) print(f"Created artifact: {config_artifact}") # Test retrieval retrieved_snapshot = snapshot_repo.get_snapshot(snapshot_id) print(f"Retrieved snapshot: {retrieved_snapshot}") retrieved_artifacts = artifact_manager.get_artifacts(snapshot_id) print(f"Retrieved artifacts: {retrieved_artifacts}") # Test content retrieval content = artifact_manager.get_artifact_content(config_artifact) retrieved_config = json.loads(content.decode) print(f"Retrieved config: {retrieved_config}") # Test storage stats stats = artifact_manager.get_storage_stats print(f"Storage stats: {stats}") print(" Storage integration test completed successfully.") return True if __name__ == "__main__": test_storage_integration