name: Build MSIX for Microsoft Store

on:
  push:
    branches: [dev]  # Change to [main, dev] when ready

jobs:
  build-msix:
    runs-on: windows-latest

    steps:
      # ... (all your existing build steps remain unchanged) ...

      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: msix
          path: pdflinkcheck.msix

  create-submission:
    needs: build-msix
    runs-on: windows-latest
    outputs:
      submission_id: ${{ steps.create-submission.outputs.SUBMISSION_ID }}
      upload_url:    ${{ steps.create-submission.outputs.UPLOAD_URL }}
    steps:
      - name: Download MSIX artifact
        uses: actions/download-artifact@v4
        with:
          name: msix

      # Call the reusable workflow
      - name: Create submission with retry
        id: create-submission
        uses: ./.github/workflows/_create-msix-submission-retry.yml@main
        with:
          app_id: "9N11HXVLS1WG"
          target_time_minutes: 480
          retry_delay_minutes: 5
        secrets:
          azure_tenant_id:     ${{ secrets.AZURE_TENANT_ID }}
          entra_client_id:     ${{ secrets.ENTRA_CLIENT_ID }}
          entra_client_secret: ${{ secrets.ENTRA_CLIENT_SECRET }}

  upload-and-commit:
    needs: create-submission
    if: false  # Change to true when ready for production
    runs-on: windows-latest
    steps:
      - name: Download MSIX artifact (again, for this job)
        uses: actions/download-artifact@v4
        with:
          name: msix

      - name: Get fresh token for commit
        id: get_token
        shell: pwsh
        run: |
          $body = @{
            grant_type    = "client_credentials"
            client_id     = "${{ secrets.ENTRA_CLIENT_ID }}"
            client_secret = "${{ secrets.ENTRA_CLIENT_SECRET }}"
            resource      = "https://manage.devcenter.microsoft.com"
          }

          $response = Invoke-RestMethod -Method Post `
            -Uri "https://login.microsoftonline.com/${{ secrets.AZURE_TENANT_ID }}/oauth2/token" `
            -Body $body `
            -ContentType "application/x-www-form-urlencoded"

          echo "TOKEN=$($response.access_token)" >> $env:GITHUB_OUTPUT

      - name: Upload MSIX to Azure Blob
        shell: pwsh
        run: |
          $uploadUrl = "${{ needs.create-submission.outputs.upload_url }}"
          $file = "pdflinkcheck.msix"

          Write-Host "Uploading to $uploadUrl"
          Invoke-RestMethod -Method PUT -Uri $uploadUrl -InFile $file -ContentType "application/octet-stream"

      - name: Commit submission
        shell: pwsh
        run: |
          $token = "${{ steps.get_token.outputs.TOKEN }}"
          $appId = "9N11HXVLS1WG"
          $submissionId = "${{ needs.create-submission.outputs.submission_id }}"

          # The submission.json was created inside the reusable workflow
          # But since it's in a different job, we can't access it directly.
          # Instead, we'll GET the submission details fresh (recommended by Microsoft docs)
          $headers = @{ Authorization = "Bearer $token" }
          $submission = Invoke-RestMethod `
            -Method GET `
            -Uri "https://manage.devcenter.microsoft.com/v1.0/my/applications/$appId/submissions/$submissionId" `
            -Headers $headers

          # Commit (PUT) the submission with minimal changes or just the status
          # (Usually you just PUT the same object or set status to "PendingCommit")
          Invoke-RestMethod `
            -Method PUT `
            -Uri "https://manage.devcenter.microsoft.com/v1.0/my/applications/$appId/submissions/$submissionId" `
            -Headers $headers `
            -Body ($submission | ConvertTo-Json -Depth 20) `
            -ContentType "application/json"

          Write-Host "Submission committed successfully."

      - name: Done
        run: |
          Write-Host "Microsoft Store submission created, uploaded, and committed."