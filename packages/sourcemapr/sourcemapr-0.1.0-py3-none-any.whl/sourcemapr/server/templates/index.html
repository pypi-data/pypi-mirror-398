<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SourceMapR - RAG Observability</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF.js for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-light">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="hljs-dark" disabled>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Google Fonts - JetBrains Mono for code -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        apple: {
                            bg: 'var(--bg)',
                            card: 'var(--card)',
                            border: 'var(--border)',
                            text: 'var(--text)',
                            secondary: 'var(--secondary)',
                            tertiary: 'var(--tertiary)',
                            blue: '#0071e3',
                            green: '#34c759',
                            orange: '#ff9500',
                            purple: '#af52de',
                            pink: '#ff2d55',
                            red: '#ff3b30',
                        },
                        // Framework colors
                        langchain: '#1C3C3C',
                        llamaindex: '#6366f1',
                        openai: '#10a37f',
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg: #f5f5f7;
            --card: #ffffff;
            --border: #d2d2d7;
            --text: #1d1d1f;
            --secondary: #86868b;
            --tertiary: #a1a1a6;
            --code-bg: #f6f8fa;
        }
        .dark {
            --bg: #1c1c1e;
            --card: #2c2c2e;
            --border: #3a3a3c;
            --text: #f5f5f7;
            --secondary: #98989d;
            --tertiary: #636366;
            --code-bg: #161618;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif; }

        /* Card styles with better shadows */
        .card {
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .dark .card { box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .dark .card:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.4); }

        /* Code blocks */
        pre, code { font-family: 'JetBrains Mono', monospace; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .code-block {
            background: var(--code-bg);
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
            line-height: 1.5;
            overflow-x: auto;
        }

        /* Animations */
        .live-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Skeleton loader */
        .skeleton {
            background: linear-gradient(90deg, var(--border) 25%, var(--bg) 50%, var(--border) 75%);
            background-size: 200% 100%;
            animation: skeleton 1.5s infinite;
        }
        @keyframes skeleton { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Chunk highlight */
        .chunk-highlight { background: #fde68a; color: #78350f; padding: 2px 4px; border-radius: 3px; }
        .dark .chunk-highlight { background: #854d0e; color: #fef3c7; }

        /* Status badges */
        .badge { padding: 2px 8px; border-radius: 9999px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-error { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .dark .badge-success { background: #166534; color: #dcfce7; }
        .dark .badge-error { background: #991b1b; color: #fee2e2; }
        .dark .badge-warning { background: #92400e; color: #fef3c7; }

        /* Sparkline container */
        .sparkline { height: 24px; width: 60px; }

        /* Copy button */
        .copy-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .copy-parent:hover .copy-btn { opacity: 1; }

        /* Provider logos */
        .provider-logo { width: 20px; height: 20px; }

        /* PDF.js viewer styles */
        .pdf-container { position: relative; overflow: auto; background: #525659; }
        .pdf-page-wrapper { position: relative; margin: 0 auto 16px auto; box-shadow: 0 2px 8px rgba(0,0,0,0.3); background: white; }
        .pdf-page-wrapper canvas { display: block; }

        /* Text layer for selection */
        .textLayer {
            position: absolute; left: 0; top: 0; right: 0; bottom: 0;
            overflow: hidden; opacity: 0.2; line-height: 1.0;
        }
        .textLayer > span { color: transparent; position: absolute; white-space: pre; cursor: text; transform-origin: 0% 0%; }
        .textLayer ::selection { background: rgba(0, 0, 255, 0.3); }
        .textLayer .highlight { margin: -1px; padding: 1px; background-color: rgba(251, 191, 36, 0.6); border-radius: 2px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--secondary); }

        /* Latency bar */
        .latency-bar { height: 4px; border-radius: 2px; background: linear-gradient(90deg, #34c759, #ff9500, #ff3b30); }
    </style>
</head>
<body class="bg-apple-bg text-apple-text h-screen flex flex-col overflow-hidden">
    <!-- SVG Definitions for Framework Logos -->
    <svg style="display: none;">
        <defs>
            <!-- LangChain Logo -->
            <symbol id="logo-langchain" viewBox="0 0 24 24">
                <path fill="currentColor" d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </symbol>
            <!-- LlamaIndex Logo -->
            <symbol id="logo-llamaindex" viewBox="0 0 24 24">
                <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
            </symbol>
            <!-- OpenAI Logo -->
            <symbol id="logo-openai" viewBox="0 0 24 24">
                <path fill="currentColor" d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364l2.0201-1.1638a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z"/>
            </symbol>
            <!-- SourceMapR Logo - Document with evidence trace nodes -->
            <symbol id="logo-sourcemapr" viewBox="0 0 32 32">
                <defs>
                    <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#6366f1"/>
                        <stop offset="50%" style="stop-color:#a855f7"/>
                        <stop offset="100%" style="stop-color:#ec4899"/>
                    </linearGradient>
                </defs>
                <rect x="2" y="2" width="28" height="28" rx="6" fill="url(#grad1)"/>
                <!-- Document outline -->
                <path d="M20 6H10a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10z" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M20 6v4h4" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <!-- Evidence trace nodes -->
                <circle cx="13" cy="15" r="2" fill="white"/>
                <circle cx="19" cy="18" r="2" fill="white"/>
                <circle cx="11" cy="21" r="1.5" fill="white"/>
                <!-- Connecting lines -->
                <path d="M13 15 L17 17 M19 18 L13 20" stroke="white" stroke-width="1" stroke-linecap="round" opacity="0.8"/>
            </symbol>
        </defs>
    </svg>

    <!-- Header -->
    <header class="bg-apple-card border-b border-apple-border px-6 py-3 flex-shrink-0">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="flex items-center gap-2.5">
                    <svg class="w-7 h-7"><use href="#logo-sourcemapr"/></svg>
                    <span class="text-base font-semibold text-apple-text tracking-tight">SourceMapR</span>
                    <span class="live-dot w-1.5 h-1.5 bg-apple-green rounded-full" title="Auto-refreshing"></span>
                </div>
                <!-- Dynamic framework badges - shown based on experiment data -->
                <div id="framework-badges" class="hidden md:flex items-center gap-2 ml-4 pl-4 border-l border-apple-border">
                    <!-- Framework badges will be dynamically inserted here -->
                </div>
            </div>
            <div class="flex items-center space-x-3 text-xs">
                <!-- Dark mode toggle -->
                <button onclick="toggleDarkMode()" class="flex items-center gap-1.5 text-apple-secondary hover:text-apple-text px-2 py-1.5 rounded hover:bg-apple-bg transition-colors" title="Toggle dark mode">
                    <i data-lucide="sun" class="w-4 h-4 dark:hidden"></i>
                    <i data-lucide="moon" class="w-4 h-4 hidden dark:block"></i>
                </button>
                <!-- Back to Experiments button -->
                <button onclick="exitToExperimentSelect()" class="flex items-center gap-1.5 text-apple-secondary hover:text-apple-text px-2 py-1.5 rounded hover:bg-apple-bg transition-colors">
                    <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
                    Experiments
                </button>
                <span class="text-apple-border">|</span>
                <!-- Current Experiment Display -->
                <div class="flex items-center gap-2 bg-violet-50 text-violet-700 px-3 py-1.5 rounded-lg">
                    <i data-lucide="flask-conical" class="w-3.5 h-3.5"></i>
                    <span id="current-experiment-name" class="font-medium">Experiment</span>
                </div>
                <span class="text-apple-border">|</span>
                <button onclick="clearData()" class="flex items-center gap-1.5 text-apple-secondary hover:text-apple-text px-3 py-1.5 rounded hover:bg-apple-bg transition-colors">
                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                    Clear
                </button>
                <button onclick="refreshData()" class="flex items-center gap-1.5 bg-apple-text hover:bg-apple-text/80 text-white px-3 py-1.5 rounded font-medium transition-colors">
                    <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
                    Refresh
                </button>
            </div>
        </div>
    </header>

    <!-- Experiment Management Modal -->
    <div id="experiment-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <div class="px-6 py-4 border-b border-apple-border flex items-center justify-between">
                <h2 class="text-lg font-semibold text-apple-text">Manage Experiments</h2>
                <button onclick="closeExperimentModal()" class="p-1 hover:bg-apple-bg rounded transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-apple-secondary"></i>
                </button>
            </div>
            <div class="p-6">
                <button onclick="openCreateExperimentModal()" class="w-full flex items-center justify-center gap-2 bg-apple-blue hover:bg-apple-blue/90 text-white px-4 py-2.5 rounded-lg font-medium transition-colors mb-4">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Create New Experiment
                </button>
                <div id="experiment-modal-list" class="space-y-3 max-h-80 overflow-y-auto">
                    <!-- Experiment cards will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Experiment Modal -->
    <div id="create-experiment-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="px-6 py-4 border-b border-apple-border flex items-center justify-between">
                <h2 id="create-experiment-title" class="text-lg font-semibold text-apple-text">Create Experiment</h2>
                <button onclick="closeCreateExperimentModal()" class="p-1 hover:bg-apple-bg rounded transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-apple-secondary"></i>
                </button>
            </div>
            <div class="p-6">
                <input type="hidden" id="edit-experiment-id" value="">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-apple-text mb-1">Name</label>
                    <input type="text" id="experiment-name-input" placeholder="e.g., Chunking Strategy Test"
                           class="w-full bg-white border border-apple-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-apple-blue/30">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-apple-text mb-1">Description (optional)</label>
                    <textarea id="experiment-desc-input" placeholder="Describe the purpose of this experiment..."
                              rows="3" class="w-full bg-white border border-apple-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-apple-blue/30"></textarea>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeCreateExperimentModal()" class="flex-1 px-4 py-2 border border-apple-border rounded-lg text-apple-secondary hover:bg-apple-bg transition-colors">
                        Cancel
                    </button>
                    <button onclick="saveExperiment()" class="flex-1 bg-apple-blue hover:bg-apple-blue/90 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Experiment Selection Screen -->
    <div id="experiment-select-screen" class="flex-1 flex items-center justify-center bg-apple-bg">
        <div class="w-full max-w-2xl mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-violet-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="flask-conical" class="w-8 h-8 text-violet-600"></i>
                </div>
                <h1 class="text-2xl font-semibold text-apple-text mb-2">Select an Experiment</h1>
                <p class="text-apple-secondary">Choose an experiment to view its data, or create a new one</p>
            </div>

            <div class="bg-white rounded-xl border border-apple-border shadow-sm overflow-hidden">
                <div class="p-4 border-b border-apple-border flex gap-3">
                    <button onclick="openCreateExperimentModal()" class="flex-1 flex items-center justify-center gap-2 bg-apple-blue hover:bg-apple-blue/90 text-white px-4 py-2.5 rounded-lg font-medium transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Create New Experiment
                    </button>
                    <button onclick="openExperimentModal()" class="flex items-center justify-center gap-2 bg-apple-bg hover:bg-apple-border/50 text-apple-secondary px-4 py-2.5 rounded-lg font-medium transition-colors">
                        <i data-lucide="settings" class="w-4 h-4"></i>
                        Manage
                    </button>
                </div>
                <div id="experiment-select-list" class="divide-y divide-apple-border max-h-96 overflow-y-auto">
                    <!-- Experiments will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard (hidden until experiment selected) -->
    <div id="main-dashboard" class="hidden flex flex-1 overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside class="w-48 bg-white border-r border-apple-border p-3 flex-shrink-0">
            <nav class="space-y-0.5">
                <button onclick="showTab('overview')" data-tab="overview" class="tab-btn w-full text-left px-3 py-2 rounded hover:bg-apple-bg bg-apple-bg text-sm font-medium transition-colors flex items-center gap-2">
                    <i data-lucide="layout-dashboard" class="w-4 h-4 text-apple-secondary"></i>
                    Overview
                </button>
                <button onclick="showTab('documents')" data-tab="documents" class="tab-btn w-full text-left px-3 py-2 rounded hover:bg-apple-bg flex items-center gap-2 text-sm text-apple-secondary transition-colors">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    <span>Documents</span>
                    <span class="ml-auto text-xs text-apple-tertiary" id="nav-doc-count">0</span>
                </button>
                <button onclick="showTab('traces')" data-tab="traces" class="tab-btn w-full text-left px-3 py-2 rounded hover:bg-apple-bg flex items-center gap-2 text-sm text-apple-secondary transition-colors">
                    <i data-lucide="message-square" class="w-4 h-4"></i>
                    <span>Queries</span>
                    <span class="ml-auto text-xs text-apple-tertiary" id="nav-trace-count">0</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex overflow-hidden bg-apple-bg">
            <!-- Overview Tab -->
            <div id="tab-overview" class="tab-content flex-1 p-6 overflow-y-auto">
                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                    <div class="bg-white rounded-xl p-4 border border-apple-border shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-emerald-50 rounded-lg flex items-center justify-center">
                                <i data-lucide="file-text" class="w-5 h-5 text-emerald-600"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-semibold text-apple-text" id="stat-docs">0</p>
                                <p class="text-xs text-apple-secondary">Documents</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-apple-border shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-amber-50 rounded-lg flex items-center justify-center">
                                <i data-lucide="scissors" class="w-5 h-5 text-amber-600"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-semibold text-apple-text" id="stat-chunks">0</p>
                                <p class="text-xs text-apple-secondary">Chunks</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-apple-border shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
                                <i data-lucide="database" class="w-5 h-5 text-blue-600"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-semibold text-apple-text" id="stat-emb">0</p>
                                <p class="text-xs text-apple-secondary">Embeddings</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-apple-border shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-violet-50 rounded-lg flex items-center justify-center">
                                <i data-lucide="search" class="w-5 h-5 text-violet-600"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-semibold text-apple-text" id="stat-retrievals">0</p>
                                <p class="text-xs text-apple-secondary">Retrievals</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-apple-border shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-sky-50 rounded-lg flex items-center justify-center">
                                <i data-lucide="message-square" class="w-5 h-5 text-sky-600"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-semibold text-apple-text" id="stat-traces">0</p>
                                <p class="text-xs text-apple-secondary">Queries</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-apple-border shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-rose-50 rounded-lg flex items-center justify-center">
                                <i data-lucide="sparkles" class="w-5 h-5 text-rose-600"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-semibold text-apple-text" id="stat-llm">0</p>
                                <p class="text-xs text-apple-secondary">LLM Calls</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pipeline Flow -->
                <div class="bg-white rounded-xl p-6 mb-6 border border-apple-border shadow-sm">
                    <div class="flex items-center gap-2 mb-5">
                        <i data-lucide="git-branch" class="w-4 h-4 text-apple-secondary"></i>
                        <p class="text-sm font-medium text-apple-text">RAG Pipeline</p>
                    </div>
                    <div class="flex items-center justify-between py-2">
                        <div class="flex flex-col items-center cursor-pointer hover:opacity-70 transition-opacity" onclick="showTab('documents')">
                            <div class="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center mb-2 border border-emerald-100">
                                <i data-lucide="file-text" class="w-6 h-6 text-emerald-600"></i>
                            </div>
                            <span class="text-sm font-medium text-apple-text">Documents</span>
                            <span class="text-lg font-semibold text-apple-text" id="flow-docs">0</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-apple-tertiary"></i>
                        <div class="flex flex-col items-center cursor-pointer hover:opacity-70 transition-opacity" onclick="showTab('documents')">
                            <div class="w-12 h-12 bg-amber-50 rounded-xl flex items-center justify-center mb-2 border border-amber-100">
                                <i data-lucide="scissors" class="w-6 h-6 text-amber-600"></i>
                            </div>
                            <span class="text-sm font-medium text-apple-text">Chunks</span>
                            <span class="text-lg font-semibold text-apple-text" id="flow-chunks">0</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-apple-tertiary"></i>
                        <div class="flex flex-col items-center">
                            <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center mb-2 border border-blue-100">
                                <i data-lucide="database" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <span class="text-sm font-medium text-apple-text">Embeddings</span>
                            <span class="text-lg font-semibold text-apple-text" id="flow-emb">0</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-apple-tertiary"></i>
                        <div class="flex flex-col items-center cursor-pointer hover:opacity-70 transition-opacity" onclick="showTab('traces')">
                            <div class="w-12 h-12 bg-violet-50 rounded-xl flex items-center justify-center mb-2 border border-violet-100">
                                <i data-lucide="search" class="w-6 h-6 text-violet-600"></i>
                            </div>
                            <span class="text-sm font-medium text-apple-text">Retrieval</span>
                            <span class="text-lg font-semibold text-apple-text" id="flow-ret">0</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-apple-tertiary"></i>
                        <div class="flex flex-col items-center cursor-pointer hover:opacity-70 transition-opacity" onclick="showTab('traces')">
                            <div class="w-12 h-12 bg-rose-50 rounded-xl flex items-center justify-center mb-2 border border-rose-100">
                                <i data-lucide="sparkles" class="w-6 h-6 text-rose-600"></i>
                            </div>
                            <span class="text-sm font-medium text-apple-text">LLM</span>
                            <span class="text-lg font-semibold text-apple-text" id="flow-llm">0</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl p-5 border border-apple-border shadow-sm">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="clock" class="w-4 h-4 text-apple-secondary"></i>
                            <p class="text-sm font-medium text-apple-text">Recent Documents</p>
                        </div>
                        <div id="recent-docs" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="flex flex-col items-center justify-center py-6 text-apple-tertiary">
                                <i data-lucide="file-plus" class="w-8 h-8 mb-2 opacity-50"></i>
                                <p class="text-sm">No documents yet</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-5 border border-apple-border shadow-sm">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="clock" class="w-4 h-4 text-apple-secondary"></i>
                            <p class="text-sm font-medium text-apple-text">Recent Queries</p>
                        </div>
                        <div id="recent-retrievals" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="flex flex-col items-center justify-center py-6 text-apple-tertiary">
                                <i data-lucide="search" class="w-8 h-8 mb-2 opacity-50"></i>
                                <p class="text-sm">No queries yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents Tab -->
            <div id="tab-documents" class="tab-content hidden flex-1 flex overflow-hidden">
                <!-- Document List View (shown when no doc selected) -->
                <div id="doc-list-view" class="flex-1 flex flex-col overflow-hidden bg-white">
                    <div class="flex items-center justify-between px-6 py-4 border-b border-apple-border">
                        <div class="flex items-center gap-2">
                            <i data-lucide="folder" class="w-5 h-5 text-apple-secondary"></i>
                            <span class="text-sm font-medium text-apple-text">Documents</span>
                        </div>
                        <div class="flex items-center gap-3 text-xs text-apple-secondary">
                            <span id="doc-count-label">0 documents</span>
                            <span class="text-apple-border">Â·</span>
                            <span id="chunk-count-label">0 chunks</span>
                        </div>
                    </div>
                    <div id="documents-list" class="flex-1 overflow-y-auto">
                        <div class="flex flex-col items-center justify-center py-16 text-apple-tertiary">
                            <i data-lucide="folder-open" class="w-12 h-12 mb-3 opacity-40"></i>
                            <p class="text-sm">No documents yet</p>
                            <p class="text-xs mt-1 opacity-70">Upload documents to start indexing</p>
                        </div>
                    </div>
                </div>

                <!-- Simple Document Viewer (no chunks panel) -->
                <div id="doc-viewer-simple" class="hidden flex-1 flex flex-col overflow-hidden bg-white">
                    <div class="px-4 py-3 border-b border-apple-border bg-white flex items-center gap-4">
                        <button onclick="closeDocumentViewer()" class="flex items-center gap-1.5 text-xs text-apple-secondary hover:text-apple-text transition-colors">
                            <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
                            Back
                        </button>
                        <div class="flex-1">
                            <span id="doc-viewer-title-simple" class="text-sm font-medium text-apple-text"></span>
                            <span id="doc-viewer-subtitle-simple" class="text-xs text-apple-secondary ml-2"></span>
                        </div>
                        <button onclick="showChunksPanel()" class="flex items-center gap-1.5 text-xs bg-apple-bg hover:bg-apple-border/50 text-apple-text px-3 py-1.5 rounded-lg transition-colors">
                            <i data-lucide="layers" class="w-3.5 h-3.5"></i>
                            Show Chunks
                        </button>
                        <a id="doc-download-btn-simple" href="#" download class="flex items-center gap-1.5 text-xs text-apple-secondary hover:text-apple-text transition-colors">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i>
                            Download
                        </a>
                    </div>
                    <!-- View mode toggle -->
                    <div class="flex items-center gap-2 px-4 py-2 border-b border-apple-border bg-apple-bg/30">
                        <span class="text-xs text-apple-secondary">View:</span>
                        <button onclick="setSimpleViewMode('split')" id="simple-mode-split" class="simple-mode-btn text-xs px-3 py-1 rounded-md bg-apple-blue text-white font-medium">Split</button>
                        <button onclick="setSimpleViewMode('pdf')" id="simple-mode-pdf" class="simple-mode-btn text-xs px-3 py-1 rounded-md bg-apple-bg text-apple-secondary hover:bg-apple-border/50 transition-colors">Original</button>
                        <button onclick="setSimpleViewMode('parsed')" id="simple-mode-parsed" class="simple-mode-btn text-xs px-3 py-1 rounded-md bg-apple-bg text-apple-secondary hover:bg-apple-border/50 transition-colors">Parsed</button>
                    </div>
                    <div id="doc-simple-content" class="flex-1 flex overflow-hidden bg-apple-bg/50"></div>
                </div>

                <!-- Chunk Origin Viewer (with chunks panel - for tracing chunk sources) -->
                <div id="doc-viewer-chunks" class="hidden flex-1 flex flex-col overflow-hidden bg-white">
                    <div class="px-4 py-3 border-b border-apple-border bg-white flex items-center gap-4">
                        <button onclick="closeDocumentViewer()" class="flex items-center gap-1.5 text-xs text-apple-secondary hover:text-apple-text transition-colors">
                            <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
                            Back
                        </button>
                        <div class="flex-1">
                            <span id="doc-viewer-title-chunks" class="text-sm font-medium text-apple-text"></span>
                        </div>
                        <button onclick="hideChunksPanel()" class="flex items-center gap-1.5 text-xs bg-amber-100 hover:bg-amber-200 text-amber-700 px-3 py-1.5 rounded-lg transition-colors">
                            <i data-lucide="x" class="w-3.5 h-3.5"></i>
                            Hide Chunks
                        </button>
                        <span id="page-indicator" class="text-xs text-apple-secondary"></span>
                        <a id="doc-download-btn-chunks" href="#" download class="flex items-center gap-1.5 text-xs text-apple-secondary hover:text-apple-text transition-colors">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i>
                            Download
                        </a>
                    </div>
                    <div class="flex-1 flex overflow-hidden">
                        <!-- Chunks list -->
                        <div class="w-72 border-r border-apple-border flex flex-col flex-shrink-0 bg-apple-bg/30">
                            <div class="p-3 border-b border-apple-border">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="layers" class="w-4 h-4 text-amber-600"></i>
                                        <h3 class="font-medium text-sm text-apple-text">Chunks</h3>
                                    </div>
                                    <span id="chunks-panel-count" class="text-xs text-apple-secondary"></span>
                                </div>
                                <div class="relative">
                                    <i data-lucide="search" class="w-3.5 h-3.5 text-apple-tertiary absolute left-2.5 top-1/2 -translate-y-1/2"></i>
                                    <input type="text" id="doc-chunk-search" placeholder="Search chunks..."
                                           class="bg-white border border-apple-border rounded-lg pl-8 pr-3 py-1.5 w-full text-xs focus:outline-none focus:ring-2 focus:ring-apple-blue/30"
                                           oninput="filterDocChunks()">
                                </div>
                            </div>
                            <div id="doc-chunks-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                        </div>
                        <!-- Source view -->
                        <div class="flex-1 flex flex-col overflow-hidden">
                            <div class="flex items-center gap-2 px-4 py-2 border-b border-apple-border bg-apple-bg/30">
                                <span class="text-xs text-apple-secondary">View:</span>
                                <button onclick="setDocViewMode('split')" id="view-mode-split" class="view-mode-btn text-xs px-3 py-1 rounded-md bg-apple-blue text-white font-medium">Split</button>
                                <button onclick="setDocViewMode('pdf')" id="view-mode-pdf" class="view-mode-btn text-xs px-3 py-1 rounded-md bg-apple-bg text-apple-secondary hover:bg-apple-border/50 transition-colors">Original</button>
                                <button onclick="setDocViewMode('parsed')" id="view-mode-parsed" class="view-mode-btn text-xs px-3 py-1 rounded-md bg-apple-bg text-apple-secondary hover:bg-apple-border/50 transition-colors">Parsed</button>
                            </div>
                            <div id="doc-source-content" class="flex-1 flex overflow-hidden bg-apple-bg/50"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Queries Tab -->
            <div id="tab-traces" class="tab-content hidden flex-1 flex overflow-hidden">
                <!-- Queries List View -->
                <div id="requests-list-view" class="flex-1 flex flex-col overflow-hidden bg-white">
                    <div class="flex items-center justify-between px-6 py-4 border-b border-apple-border">
                        <div class="flex items-center gap-2">
                            <i data-lucide="message-circle" class="w-5 h-5 text-apple-secondary"></i>
                            <span class="text-sm font-medium text-apple-text">Queries</span>
                        </div>
                        <span class="text-apple-secondary text-xs" id="requests-count-label">0 queries</span>
                    </div>
                    <div id="requests-list" class="flex-1 overflow-y-auto">
                        <div class="flex flex-col items-center justify-center py-16 text-apple-tertiary">
                            <i data-lucide="message-circle" class="w-12 h-12 mb-3 opacity-40"></i>
                            <p class="text-sm">No queries yet</p>
                            <p class="text-xs mt-1 opacity-70">Run queries to see them here</p>
                        </div>
                    </div>
                </div>

                <!-- Query Detail View -->
                <div id="request-detail-view" class="hidden flex-1 flex overflow-hidden">
                    <!-- Main content -->
                    <div class="flex-1 flex flex-col overflow-hidden bg-white">
                        <div class="px-4 py-3 border-b border-apple-border bg-white flex items-center gap-4">
                            <button onclick="closeRequestDetail()" class="flex items-center gap-1.5 text-xs text-apple-secondary hover:text-apple-text transition-colors">
                                <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
                                Back
                            </button>
                            <div class="flex-1 min-w-0">
                                <span id="request-detail-name" class="text-sm font-medium text-apple-text truncate block"></span>
                                <span id="request-detail-title" class="text-xs text-apple-tertiary"></span>
                            </div>
                        </div>
                        <div id="request-detail-content" class="flex-1 overflow-y-auto">
                        </div>
                    </div>
                    <!-- Source Sidebar (hidden by default) - Shows parsed text or original PDF for RAG debugging -->
                    <div id="source-sidebar" class="hidden w-[650px] border-l border-apple-border flex flex-col bg-white flex-shrink-0">
                        <div class="px-4 py-3 border-b border-apple-border bg-white flex items-center gap-3">
                            <i data-lucide="file-text" class="w-4 h-4 text-apple-secondary flex-shrink-0"></i>
                            <div class="flex-1 min-w-0">
                                <p id="source-sidebar-title" class="text-sm font-medium text-apple-text truncate"></p>
                            </div>
                            <button onclick="openFullDocumentView()" class="flex items-center gap-1 text-xs text-apple-blue hover:underline flex-shrink-0">
                                <i data-lucide="external-link" class="w-3 h-3"></i>
                                Full View
                            </button>
                            <button onclick="closeSourceSidebar()" class="p-1 hover:bg-apple-bg rounded text-apple-secondary hover:text-apple-text flex-shrink-0 transition-colors">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="px-4 py-2 border-b border-apple-border bg-apple-bg/30 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <button onclick="setSidebarViewMode('parsed')" id="sidebar-mode-parsed" class="sidebar-mode-btn text-xs px-3 py-1 rounded-md bg-apple-blue text-white font-medium">Parsed</button>
                                <button onclick="setSidebarViewMode('source')" id="sidebar-mode-source" class="sidebar-mode-btn text-xs px-3 py-1 rounded-md bg-apple-bg text-apple-secondary hover:bg-apple-border/50 transition-colors">Source</button>
                                <span class="text-apple-border mx-1">|</span>
                                <div class="flex items-center gap-1">
                                    <button onclick="sidebarGoToPage(sidebarPage - 1)" id="sidebar-prev" class="p-1 hover:bg-black/5 rounded transition-colors">
                                        <i data-lucide="chevron-left" class="w-4 h-4 text-apple-secondary"></i>
                                    </button>
                                    <span id="source-sidebar-page" class="text-xs text-apple-secondary"></span>
                                    <button onclick="sidebarGoToPage(sidebarPage + 1)" id="sidebar-next" class="p-1 hover:bg-black/5 rounded transition-colors">
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-apple-secondary"></i>
                                    </button>
                                </div>
                            </div>
                            <span id="sidebar-highlight-badge" class="hidden bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs">Highlighted</span>
                            <span id="sidebar-fuzzy-note" class="hidden bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs" title="LangChain/LlamaIndex don't provide page numbers for HTML documents, so chunk location is determined via fuzzy text matching">Fuzzy Match</span>
                        </div>
                        <div id="source-sidebar-content" class="flex-1 flex flex-col overflow-hidden bg-apple-bg/30">
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div> <!-- End main-dashboard -->

    <script>
        let allData = {};
        let autoRefresh = null;
        let selectedDoc = null;
        let selectedTrace = null;
        let currentExperimentId = null; // null = all data
        let isDarkMode = false;

        // PDF.js configuration
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // PDF viewer state
        let pdfDocCache = {}; // Cache loaded PDF documents
        let currentPdfDoc = null;
        let pdfScale = 1.2;

        // ========== Dark Mode ==========
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.documentElement.classList.toggle('dark', isDarkMode);
            localStorage.setItem('darkMode', isDarkMode);

            // Toggle highlight.js theme
            document.getElementById('hljs-light').disabled = isDarkMode;
            document.getElementById('hljs-dark').disabled = !isDarkMode;

            lucide.createIcons();
        }

        function initDarkMode() {
            isDarkMode = localStorage.getItem('darkMode') === 'true' ||
                         window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.classList.toggle('dark', isDarkMode);
            document.getElementById('hljs-light').disabled = isDarkMode;
            document.getElementById('hljs-dark').disabled = !isDarkMode;
        }

        // ========== Utility Functions ==========
        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const originalIcon = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="check" class="w-3.5 h-3.5 text-apple-green"></i>';
                lucide.createIcons();
                setTimeout(() => {
                    btn.innerHTML = originalIcon;
                    lucide.createIcons();
                }, 1500);
            });
        }

        function formatLatency(ms) {
            if (!ms && ms !== 0) return '-';
            if (ms < 1000) return `${Math.round(ms)}ms`;
            return `${(ms / 1000).toFixed(1)}s`;
        }

        function getLatencyColor(ms) {
            if (ms < 500) return 'text-apple-green';
            if (ms < 2000) return 'text-apple-orange';
            return 'text-apple-red';
        }

        function getLatencyBarWidth(ms, maxMs = 5000) {
            return Math.min((ms / maxMs) * 100, 100);
        }

        function getProviderLogo(model) {
            if (!model) return '';
            const m = model.toLowerCase();
            if (m.includes('gpt') || m.includes('openai') || m.includes('text-embedding')) {
                return '<svg class="w-4 h-4 text-openai"><use href="#logo-openai"/></svg>';
            }
            if (m.includes('claude') || m.includes('anthropic')) {
                return '<svg class="w-4 h-4 text-purple-600"><use href="#logo-llamaindex"/></svg>';
            }
            return '<i data-lucide="cpu" class="w-4 h-4 text-apple-secondary"></i>';
        }

        function getStatusBadge(status) {
            if (!status) return '';
            const s = status.toLowerCase();
            if (s === 'success' || s === 'ok' || s === 'completed') {
                return '<span class="badge badge-success">Success</span>';
            }
            if (s === 'error' || s === 'failed') {
                return '<span class="badge badge-error">Error</span>';
            }
            return `<span class="badge badge-warning">${status}</span>`;
        }

        // ========== Charts ==========
        let latencyChart = null;
        let tokenChart = null;

        function createLatencyChart(containerId, data) {
            const ctx = document.getElementById(containerId);
            if (!ctx) return;

            if (latencyChart) latencyChart.destroy();

            latencyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i + 1),
                    datasets: [{
                        data: data,
                        borderColor: '#0071e3',
                        backgroundColor: 'rgba(0, 113, 227, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
        }

        function createTokenChart(containerId, promptTokens, completionTokens) {
            const ctx = document.getElementById(containerId);
            if (!ctx) return;

            if (tokenChart) tokenChart.destroy();

            tokenChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Prompt', 'Completion'],
                    datasets: [{
                        data: [promptTokens, completionTokens],
                        backgroundColor: ['#0071e3', '#af52de'],
                        borderWidth: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            initDarkMode();
            lucide.createIcons();
            await initializeExperiments();
        });

        async function initializeExperiments(autoSelect = false) {
            // Load experiments list
            const res = await fetch('/api/experiments');
            const experiments = await res.json();

            // Create "Default" experiment if no experiments exist
            if (experiments.length === 0) {
                await fetch('/api/experiments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: 'Default', description: 'Default experiment for general use' })
                });
                // Reload experiments
                const res2 = await fetch('/api/experiments');
                allData.experiments = await res2.json();
            } else {
                allData.experiments = experiments;
            }

            // Render experiment selection list
            updateExperimentSelectList();

            // Always show experiment selection screen on load - user must choose
            // Don't auto-select anymore
        }

        function updateExperimentSelectList() {
            const experiments = allData.experiments || [];
            const listEl = document.getElementById('experiment-select-list');

            // Calculate totals for "All" option
            const totalDocs = experiments.reduce((sum, e) => sum + (e.doc_count || 0), 0);
            const totalQueries = experiments.reduce((sum, e) => sum + (e.retrieval_count || 0), 0);
            const totalLlm = experiments.reduce((sum, e) => sum + (e.llm_count || 0), 0);

            // "All Experiments" option
            const allOption = `
                <button onclick="enterExperiment(null)" class="w-full text-left px-4 py-4 hover:bg-apple-bg transition-colors flex items-center gap-4 border-b border-apple-border">
                    <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i data-lucide="layers" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-medium text-apple-text">All Experiments</h3>
                        <p class="text-sm text-apple-secondary truncate">View all data across experiments</p>
                        <div class="flex items-center gap-3 mt-1 text-xs text-apple-tertiary">
                            <span>${totalDocs} docs</span>
                            <span>${totalQueries} queries</span>
                            <span>${totalLlm} LLM calls</span>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-apple-tertiary flex-shrink-0"></i>
                </button>
            `;

            if (!experiments.length) {
                listEl.innerHTML = `
                    <div class="p-8 text-center text-apple-secondary">
                        <p>No experiments yet. Create one to get started!</p>
                    </div>
                `;
            } else {
                listEl.innerHTML = allOption + experiments.map(exp => `
                    <button onclick="enterExperiment(${exp.id})" class="w-full text-left px-4 py-4 hover:bg-apple-bg transition-colors flex items-center gap-4">
                        <div class="w-10 h-10 ${exp.name === 'Default' ? 'bg-gray-100' : 'bg-violet-50'} rounded-lg flex items-center justify-center flex-shrink-0">
                            <i data-lucide="${exp.name === 'Default' ? 'inbox' : 'flask-conical'}" class="w-5 h-5 ${exp.name === 'Default' ? 'text-gray-600' : 'text-violet-600'}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <h3 class="font-medium text-apple-text">${escapeHtml(exp.name)}</h3>
                                ${getFrameworkBadgesHTML(exp.framework)}
                            </div>
                            ${exp.description ? `<p class="text-sm text-apple-secondary truncate">${escapeHtml(exp.description)}</p>` : ''}
                            <div class="flex items-center gap-3 mt-1 text-xs text-apple-tertiary">
                                <span>${exp.doc_count || 0} docs</span>
                                <span>${exp.retrieval_count || 0} queries</span>
                                <span>${exp.llm_count || 0} LLM calls</span>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-apple-tertiary flex-shrink-0"></i>
                    </button>
                `).join('');
            }
            lucide.createIcons();
        }

        function enterExperiment(expId) {
            currentExperimentId = expId;
            const exp = expId ? (allData.experiments || []).find(e => e.id === expId) : null;
            document.getElementById('current-experiment-name').textContent = exp?.name || 'All Experiments';

            // Update framework badges
            updateFrameworkBadges(exp?.framework);

            // Hide experiment selection, show dashboard
            document.getElementById('experiment-select-screen').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');

            // Start data refresh
            refreshData();
            autoRefresh = setInterval(refreshData, 3000);
        }

        function getFrameworkBadgesHTML(frameworkStr, small = false) {
            if (!frameworkStr) return '';

            const frameworks = frameworkStr.split(',').filter(f => f.trim());
            const sizeClass = small ? 'w-3 h-3' : 'w-3.5 h-3.5';
            const textClass = small ? 'text-[9px]' : 'text-[10px]';
            const paddingClass = small ? 'px-1.5 py-0.5' : 'px-2 py-1';

            return frameworks.map(fw => {
                const fwLower = fw.toLowerCase().trim();
                if (fwLower === 'langchain') {
                    return `<div class="flex items-center gap-1 ${paddingClass} rounded-full bg-langchain/10 text-langchain" title="LangChain">
                        <svg class="${sizeClass}"><use href="#logo-langchain"/></svg>
                        <span class="${textClass} font-medium">LangChain</span>
                    </div>`;
                } else if (fwLower === 'llamaindex') {
                    return `<div class="flex items-center gap-1 ${paddingClass} rounded-full bg-llamaindex/10 text-llamaindex" title="LlamaIndex">
                        <svg class="${sizeClass}"><use href="#logo-llamaindex"/></svg>
                        <span class="${textClass} font-medium">LlamaIndex</span>
                    </div>`;
                } else if (fwLower === 'openai') {
                    return `<div class="flex items-center gap-1 ${paddingClass} rounded-full bg-openai/10 text-openai" title="OpenAI">
                        <svg class="${sizeClass}"><use href="#logo-openai"/></svg>
                        <span class="${textClass} font-medium">OpenAI</span>
                    </div>`;
                }
                return '';
            }).filter(b => b).join('');
        }

        function updateFrameworkBadges(frameworkStr) {
            const container = document.getElementById('framework-badges');
            container.innerHTML = getFrameworkBadgesHTML(frameworkStr);
        }

        function exitToExperimentSelect() {
            // Stop auto-refresh
            if (autoRefresh) {
                clearInterval(autoRefresh);
                autoRefresh = null;
            }

            currentExperimentId = null;

            // Clear framework badges
            updateFrameworkBadges(null);

            // Show experiment selection, hide dashboard
            document.getElementById('experiment-select-screen').classList.remove('hidden');
            document.getElementById('main-dashboard').classList.add('hidden');

            // Refresh experiment list (don't auto-select)
            initializeExperiments(false);
        }

        // ========== PDF.js Viewer ==========
        async function loadPdfDocument(url) {
            if (pdfDocCache[url]) {
                return pdfDocCache[url];
            }
            try {
                const loadingTask = pdfjsLib.getDocument(url);
                const pdfDoc = await loadingTask.promise;
                pdfDocCache[url] = pdfDoc;
                return pdfDoc;
            } catch (e) {
                console.error('Error loading PDF:', e);
                return null;
            }
        }

        async function renderPdfPage(pdfDoc, pageNum, container, highlightText = null) {
            try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: pdfScale });

                // Create wrapper
                const wrapper = document.createElement('div');
                wrapper.className = 'pdf-page-wrapper';
                wrapper.style.width = viewport.width + 'px';
                wrapper.style.height = viewport.height + 'px';

                // Create canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                // Render PDF page to canvas
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                wrapper.appendChild(canvas);

                // Create text layer for selection/highlighting
                const textContent = await page.getTextContent();
                const textLayer = document.createElement('div');
                textLayer.className = 'textLayer';
                textLayer.style.width = viewport.width + 'px';
                textLayer.style.height = viewport.height + 'px';

                // Render text layer
                await renderTextLayer(textContent, textLayer, viewport, highlightText);

                wrapper.appendChild(textLayer);
                container.appendChild(wrapper);

                return { wrapper, textLayer };
            } catch (e) {
                console.error('Error rendering PDF page:', e);
                return null;
            }
        }

        async function renderTextLayer(textContent, textLayerDiv, viewport, highlightText = null) {
            const textItems = textContent.items;
            const styles = textContent.styles;

            // Normalize highlight text for matching
            const normalizedHighlight = highlightText ? normalizeText(highlightText) : null;

            for (const item of textItems) {
                const tx = pdfjsLib.Util.transform(viewport.transform, item.transform);
                const fontHeight = Math.sqrt((tx[2] * tx[2]) + (tx[3] * tx[3]));
                const angle = Math.atan2(tx[1], tx[0]);

                const span = document.createElement('span');
                span.textContent = item.str;
                span.style.left = tx[4] + 'px';
                span.style.top = (tx[5] - fontHeight) + 'px';
                span.style.fontSize = fontHeight + 'px';
                span.style.fontFamily = styles[item.fontName]?.fontFamily || 'sans-serif';

                if (angle !== 0) {
                    span.style.transform = `rotate(${angle}rad)`;
                }

                // Check if this text should be highlighted
                if (normalizedHighlight && item.str.trim()) {
                    const normalizedItem = normalizeText(item.str);
                    if (normalizedHighlight.includes(normalizedItem) || normalizedItem.includes(normalizedHighlight.substring(0, 30))) {
                        span.classList.add('highlight');
                    }
                }

                textLayerDiv.appendChild(span);
            }
        }

        function normalizeText(text) {
            return text.toLowerCase().replace(/\s+/g, ' ').trim();
        }

        async function renderPdfViewer(containerId, pdfUrl, pageNum = 1, highlightText = null, showAllPages = false) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '<div class="flex items-center justify-center h-full text-white"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mr-2"></i>Loading PDF...</div>';
            lucide.createIcons();

            const pdfDoc = await loadPdfDocument(pdfUrl);
            if (!pdfDoc) {
                container.innerHTML = '<div class="flex items-center justify-center h-full text-apple-secondary"><p>Could not load PDF</p></div>';
                return;
            }

            container.innerHTML = '';
            container.className = 'pdf-container flex-1 flex flex-col min-h-0';

            // Add zoom controls bar
            const controlsBar = document.createElement('div');
            controlsBar.className = 'flex items-center justify-center gap-2 px-2 py-1.5 bg-gray-700 flex-shrink-0';
            controlsBar.innerHTML = `
                <button onclick="adjustPdfZoom('${containerId}', '${pdfUrl}', ${pageNum}, ${highlightText ? `'${escapeForJs(highlightText)}'` : 'null'}, ${showAllPages}, -0.2)" class="p-1 hover:bg-gray-600 rounded text-white" title="Zoom Out">
                    <i data-lucide="zoom-out" class="w-4 h-4"></i>
                </button>
                <span class="text-white text-xs min-w-[50px] text-center">${Math.round(pdfScale * 100)}%</span>
                <button onclick="adjustPdfZoom('${containerId}', '${pdfUrl}', ${pageNum}, ${highlightText ? `'${escapeForJs(highlightText)}'` : 'null'}, ${showAllPages}, 0.2)" class="p-1 hover:bg-gray-600 rounded text-white" title="Zoom In">
                    <i data-lucide="zoom-in" class="w-4 h-4"></i>
                </button>
                <span class="text-gray-400 mx-2">|</span>
                <button onclick="pdfScale = 1.0; renderPdfViewer('${containerId}', '${pdfUrl}', ${pageNum}, ${highlightText ? `'${escapeForJs(highlightText)}'` : 'null'}, ${showAllPages})" class="text-xs text-gray-300 hover:text-white px-2 py-0.5 hover:bg-gray-600 rounded" title="Reset Zoom">
                    Reset
                </button>
            `;
            container.appendChild(controlsBar);
            lucide.createIcons();

            // Create scroll container for pages
            const scrollContainer = document.createElement('div');
            scrollContainer.className = 'flex-1 overflow-auto p-4 min-h-0';
            scrollContainer.id = containerId + '-scroll';
            container.appendChild(scrollContainer);

            if (showAllPages) {
                // Render all pages
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    await renderPdfPage(pdfDoc, i, scrollContainer, i === pageNum ? highlightText : null);
                }
            } else {
                // Render single page
                await renderPdfPage(pdfDoc, pageNum, scrollContainer, highlightText);
            }

            // Scroll to first highlight if present (with retry for slow renders)
            // Use 'instant' behavior to avoid jarring scroll from top after render
            const scrollToHighlight = (retries = 3) => {
                const firstHighlight = scrollContainer.querySelector('.textLayer .highlight');
                if (firstHighlight) {
                    firstHighlight.scrollIntoView({ behavior: 'instant', block: 'center' });
                } else if (retries > 0) {
                    setTimeout(() => scrollToHighlight(retries - 1), 200);
                }
            };
            setTimeout(scrollToHighlight, 150);
        }

        function adjustPdfZoom(containerId, pdfUrl, pageNum, highlightText, showAllPages, delta) {
            pdfScale = Math.max(0.5, Math.min(3.0, pdfScale + delta));
            renderPdfViewer(containerId, pdfUrl, pageNum, highlightText, showAllPages);
        }


        // Enhanced highlight function that searches across text spans
        function highlightTextInPdf(container, searchText) {
            if (!searchText || !container) return;

            const normalizedSearch = normalizeText(searchText).substring(0, 100); // Use first 100 chars
            const spans = container.querySelectorAll('.textLayer span');

            // Build continuous text and map positions
            let fullText = '';
            const spanMap = [];

            spans.forEach((span, idx) => {
                const start = fullText.length;
                fullText += span.textContent;
                spanMap.push({ span, start, end: fullText.length });
            });

            const normalizedFull = normalizeText(fullText);
            const matchIdx = normalizedFull.indexOf(normalizedSearch.substring(0, 50));

            if (matchIdx !== -1) {
                // Find which spans contain the match
                const matchEnd = matchIdx + Math.min(searchText.length, 200);

                spanMap.forEach(({ span, start, end }) => {
                    // Rough position mapping (normalized vs original may differ)
                    const ratio = fullText.length / normalizedFull.length;
                    const origStart = start;
                    const origEnd = end;
                    const normStart = origStart / ratio;
                    const normEnd = origEnd / ratio;

                    if (normEnd > matchIdx && normStart < matchEnd) {
                        span.classList.add('highlight');
                    }
                });
            }
        }

        async function refreshData() {
            try {
                // If no experiment selected, fetch all data
                const url = currentExperimentId
                    ? `/api/data?experiment_id=${currentExperimentId}`
                    : '/api/data';
                const res = await fetch(url);
                const newData = await res.json();

                // Refresh experiments list
                const expRes = await fetch('/api/experiments');
                const experiments = await expRes.json();
                allData = newData;
                allData.experiments = experiments;

                // Check if current experiment still exists
                if (currentExperimentId) {
                    const exp = experiments.find(e => e.id === currentExperimentId);
                    if (!exp) {
                        console.log('Current experiment not found, returning to selection');
                        exitToExperimentSelect();
                        return;
                    }
                    // Update framework badges in case they changed
                    updateFrameworkBadges(exp.framework);
                }

                updateUI();
            } catch (e) {
                console.error('Error refreshing data:', e);
                // On error, go back to experiment selection
                exitToExperimentSelect();
            }
        }

        // ========== Experiment Management ==========

        function updateExperimentModalList() {
            const experiments = allData.experiments || [];
            const listEl = document.getElementById('experiment-modal-list');

            if (!experiments.length) {
                listEl.innerHTML = '<p class="text-apple-secondary text-sm text-center py-8">No experiments yet. Create one to get started!</p>';
            } else {
                listEl.innerHTML = experiments.map(exp => `
                    <div class="bg-apple-bg rounded-lg p-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="flask-conical" class="w-4 h-4 text-violet-600 flex-shrink-0"></i>
                                    <h3 class="font-medium text-apple-text truncate">${escapeHtml(exp.name)}</h3>
                                </div>
                                ${exp.description ? `<p class="text-sm text-apple-secondary mt-1 line-clamp-2">${escapeHtml(exp.description)}</p>` : ''}
                                <div class="flex items-center gap-3 mt-2 text-xs text-apple-tertiary">
                                    <span>${exp.doc_count || 0} docs</span>
                                    <span>${exp.retrieval_count || 0} queries</span>
                                    <span>${exp.llm_count || 0} LLM calls</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 ml-2">
                                <button onclick="editExperiment(${exp.id})" class="p-1.5 hover:bg-white rounded transition-colors" title="Edit">
                                    <i data-lucide="pencil" class="w-4 h-4 text-apple-secondary"></i>
                                </button>
                                <button onclick="deleteExperiment(${exp.id})" class="p-1.5 hover:bg-white rounded transition-colors" title="Delete">
                                    <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function openExperimentModal() {
            document.getElementById('experiment-modal').classList.remove('hidden');
            updateExperimentModalList();
            lucide.createIcons();
        }

        function closeExperimentModal() {
            document.getElementById('experiment-modal').classList.add('hidden');
        }

        function openCreateExperimentModal(expId = null) {
            document.getElementById('edit-experiment-id').value = expId || '';
            document.getElementById('experiment-name-input').value = '';
            document.getElementById('experiment-desc-input').value = '';

            if (expId) {
                const exp = (allData.experiments || []).find(e => e.id === expId);
                if (exp) {
                    document.getElementById('experiment-name-input').value = exp.name || '';
                    document.getElementById('experiment-desc-input').value = exp.description || '';
                }
                document.getElementById('create-experiment-title').textContent = 'Edit Experiment';
            } else {
                document.getElementById('create-experiment-title').textContent = 'Create Experiment';
            }

            document.getElementById('create-experiment-modal').classList.remove('hidden');
            document.getElementById('experiment-name-input').focus();
            lucide.createIcons();
        }

        function closeCreateExperimentModal() {
            document.getElementById('create-experiment-modal').classList.add('hidden');
        }

        async function saveExperiment() {
            const expId = document.getElementById('edit-experiment-id').value;
            const name = document.getElementById('experiment-name-input').value.trim();
            const description = document.getElementById('experiment-desc-input').value.trim();

            if (!name) {
                alert('Please enter an experiment name');
                return;
            }

            try {
                if (expId) {
                    // Update existing
                    await fetch(`/api/experiments/${expId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description })
                    });
                } else {
                    // Create new
                    await fetch('/api/experiments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description })
                    });
                }

                closeCreateExperimentModal();

                // Refresh experiments list
                const res = await fetch('/api/experiments');
                allData.experiments = await res.json();

                // Update both selection screen and modal list
                updateExperimentSelectList();
                updateExperimentModalList();

                // If inside dashboard, also refresh data
                if (currentExperimentId) {
                    refreshData();
                }
            } catch (e) {
                console.error('Error saving experiment:', e);
                alert('Failed to save experiment');
            }
        }

        function editExperiment(expId) {
            openCreateExperimentModal(expId);
        }

        async function deleteExperiment(expId) {
            const exp = (allData.experiments || []).find(e => e.id === expId);
            if (!confirm(`Delete experiment "${exp?.name}"? Data will be unassigned but not deleted.`)) {
                return;
            }

            try {
                await fetch(`/api/experiments/${expId}`, { method: 'DELETE' });

                // Refresh experiments list
                const res = await fetch('/api/experiments');
                allData.experiments = await res.json();

                // Update both selection screen and modal list
                updateExperimentSelectList();
                updateExperimentModalList();

                // If we were viewing this experiment, go back to selection
                if (currentExperimentId === expId) {
                    exitToExperimentSelect();
                }
            } catch (e) {
                console.error('Error deleting experiment:', e);
                alert('Failed to delete experiment');
            }
        }

        async function assignToExperiment(expId, docIds = [], retrievalIds = [], llmIds = []) {
            try {
                await fetch(`/api/experiments/${expId}/assign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ doc_ids: docIds, retrieval_ids: retrievalIds, llm_ids: llmIds })
                });
                refreshData();
            } catch (e) {
                console.error('Error assigning to experiment:', e);
            }
        }

        async function unassignFromExperiment(docIds = [], retrievalIds = [], llmIds = []) {
            try {
                await fetch(`/api/experiments/0/unassign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ doc_ids: docIds, retrieval_ids: retrievalIds, llm_ids: llmIds })
                });
                refreshData();
            } catch (e) {
                console.error('Error unassigning from experiment:', e);
            }
        }

        function getExperimentName(expId) {
            const exp = (allData.experiments || []).find(e => e.id === expId);
            return exp ? exp.name : null;
        }

        function showAssignMenu(event, type, id, currentExpId) {
            event.stopPropagation();
            // Remove any existing menu
            const existing = document.getElementById('assign-menu');
            if (existing) existing.remove();

            const experiments = allData.experiments || [];
            const menu = document.createElement('div');
            menu.id = 'assign-menu';
            menu.className = 'fixed bg-white border border-apple-border rounded-lg shadow-lg z-50 py-1 min-w-48';
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';

            let html = '<div class="px-3 py-1.5 text-xs font-medium text-apple-secondary">Assign to Experiment</div>';

            if (currentExpId) {
                html += `<button onclick="handleAssign('${type}', '${id}', null)" class="w-full text-left px-3 py-1.5 text-sm hover:bg-apple-bg flex items-center gap-2 text-red-600">
                    <i data-lucide="x" class="w-3 h-3"></i> Unassign
                </button>`;
                html += '<div class="border-t border-apple-border/50 my-1"></div>';
            }

            if (experiments.length === 0) {
                html += '<div class="px-3 py-2 text-sm text-apple-tertiary">No experiments yet</div>';
            } else {
                experiments.forEach(exp => {
                    const isSelected = exp.id === currentExpId;
                    html += `<button onclick="handleAssign('${type}', '${id}', ${exp.id})" class="w-full text-left px-3 py-1.5 text-sm hover:bg-apple-bg flex items-center gap-2 ${isSelected ? 'bg-apple-bg' : ''}">
                        <i data-lucide="${isSelected ? 'check' : 'folder'}" class="w-3 h-3"></i>
                        ${escapeHtml(exp.name)}
                    </button>`;
                });
            }

            html += '<div class="border-t border-apple-border/50 my-1"></div>';
            html += `<button onclick="openCreateExperimentModal(); document.getElementById('assign-menu')?.remove();" class="w-full text-left px-3 py-1.5 text-sm hover:bg-apple-bg flex items-center gap-2 text-apple-secondary">
                <i data-lucide="plus" class="w-3 h-3"></i> New Experiment
            </button>`;

            menu.innerHTML = html;
            document.body.appendChild(menu);
            lucide.createIcons();

            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }

        async function handleAssign(type, id, expId) {
            document.getElementById('assign-menu')?.remove();
            if (expId === null) {
                // Unassign
                if (type === 'doc') {
                    await unassignFromExperiment([id], [], []);
                } else if (type === 'retrieval') {
                    await unassignFromExperiment([], [parseInt(id)], []);
                }
            } else {
                // Assign
                if (type === 'doc') {
                    await assignToExperiment(expId, [id], [], []);
                } else if (type === 'retrieval') {
                    await assignToExperiment(expId, [], [parseInt(id)], []);
                }
            }
        }

        async function clearData() {
            const msg = currentExperimentId
                ? 'Clear data for this experiment? (Data will be unassigned)'
                : 'Clear all trace data?';
            if (confirm(msg)) {
                const url = currentExperimentId
                    ? `/api/clear?experiment_id=${currentExperimentId}`
                    : '/api/clear';
                await fetch(url, { method: 'POST' });
                selectedDoc = null;
                selectedChunkInDoc = null;
                selectedTrace = null;
                refreshData();
            }
        }

        function updateUI() {
            const s = allData.stats || {};

            // Stats
            document.getElementById('stat-docs').textContent = s.total_documents || 0;
            document.getElementById('stat-chunks').textContent = s.total_chunks || 0;
            document.getElementById('stat-emb').textContent = s.total_embeddings || 0;
            document.getElementById('stat-retrievals').textContent = s.total_retrievals || 0;
            document.getElementById('stat-traces').textContent = s.total_traces || 0;
            document.getElementById('stat-llm').textContent = s.total_llm_calls || 0;

            // Nav counts
            document.getElementById('nav-doc-count').textContent = s.total_documents || 0;
            // Show retrievals count for Requests tab (more meaningful than traces)
            document.getElementById('nav-trace-count').textContent = s.total_retrievals || s.total_traces || 0;

            // Flow
            document.getElementById('flow-docs').textContent = s.total_documents || 0;
            document.getElementById('flow-chunks').textContent = s.total_chunks || 0;
            document.getElementById('flow-emb').textContent = s.total_embeddings || 0;
            document.getElementById('flow-ret').textContent = s.total_retrievals || 0;
            document.getElementById('flow-llm').textContent = s.total_llm_calls || 0;

            updateDocumentsList();
            updateTracesList();
            updateRecentActivity();
        }

        // ========== Documents ==========
        let docViewMode = 'split'; // 'split', 'pdf', 'parsed'

        // Supported document types for original view
        const supportedOriginalTypes = ['pdf', 'htm', 'html'];

        function getDocType(filePath) {
            if (!filePath) return null;
            return filePath.toLowerCase().split('.').pop();
        }

        function isOriginalViewSupported(filePath) {
            const ext = getDocType(filePath);
            return supportedOriginalTypes.includes(ext);
        }

        async function loadParsedDoc(docId) {
            try {
                const res = await fetch(`/api/parsed/${encodeURIComponent(docId)}`);
                const parsed = await res.json();
                if (!parsed.error) {
                    if (!allData.parsed) allData.parsed = {};
                    allData.parsed[docId] = parsed;
                    // Re-render the view if this doc is still selected
                    if (selectedDoc === docId) {
                        renderCurrentView();
                    }
                }
            } catch (e) {
                console.error('Error loading parsed doc:', e);
            }
        }

        function renderCurrentView() {
            const docChunks = Object.values(allData.chunks || {}).filter(c => c.doc_id === selectedDoc);
            if (docChunks.length > 0) {
                renderDocSourceView();
            } else {
                renderSimpleSourceView();
            }
        }

        function updateViewModeButtons(filePath, prefix = 'view-mode') {
            const hasOriginal = isOriginalViewSupported(filePath);
            const splitBtn = document.getElementById(`${prefix}-split`);
            const originalBtn = document.getElementById(`${prefix}-pdf`);
            const parsedBtn = document.getElementById(`${prefix}-parsed`);
            const ext = getDocType(filePath);

            if (splitBtn && originalBtn) {
                if (hasOriginal) {
                    // Enable split and original buttons
                    splitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    splitBtn.disabled = false;
                    originalBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    originalBtn.disabled = false;

                    // Update original button text based on type
                    if (ext === 'pdf') {
                        originalBtn.textContent = 'PDF';
                    } else if (ext === 'htm' || ext === 'html') {
                        originalBtn.textContent = 'HTML';
                    } else {
                        originalBtn.textContent = 'Original';
                    }

                } else {
                    // Disable split and original buttons, switch to parsed view
                    splitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    splitBtn.disabled = true;
                    originalBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    originalBtn.disabled = true;
                    originalBtn.textContent = 'Original';

                    // Auto-switch to parsed view if currently on unsupported view
                    if (prefix === 'view-mode' && (docViewMode === 'split' || docViewMode === 'pdf')) {
                        setDocViewMode('parsed');
                    } else if (prefix === 'simple-mode' && (simpleViewMode === 'split' || simpleViewMode === 'pdf')) {
                        setSimpleViewMode('parsed');
                    }
                }
            }
        }
        let selectedChunkInDoc = null;
        let simpleViewMode = 'split';
        let currentPage = 1;
        let highlightChunkText = null; // Text to highlight in parsed view
        let highlightChunkIdx = null; // Character indices for precise highlighting {start: number, end: number}

        // Pagination state for different lists
        const PAGE_SIZE = 20;
        let docsPage = 1;
        let queriesPage = 1;
        let docChunksPage = 1;

        // Pagination helper - renders pagination controls
        function renderPagination(totalItems, currentPage, pageSize, onPageChange) {
            const totalPages = Math.ceil(totalItems / pageSize);
            if (totalPages <= 1) return '';

            const startItem = (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(currentPage * pageSize, totalItems);

            return `
                <div class="flex items-center justify-between px-4 py-3 border-t border-apple-border/50 bg-apple-bg/30">
                    <span class="text-xs text-apple-secondary">
                        Showing ${startItem}-${endItem} of ${totalItems}
                    </span>
                    <div class="flex items-center gap-1">
                        <button onclick="${onPageChange}(1)"
                                class="p-1.5 rounded hover:bg-apple-border/50 ${currentPage === 1 ? 'opacity-30 cursor-not-allowed' : ''}"
                                ${currentPage === 1 ? 'disabled' : ''}>
                            <i data-lucide="chevrons-left" class="w-4 h-4"></i>
                        </button>
                        <button onclick="${onPageChange}(${currentPage - 1})"
                                class="p-1.5 rounded hover:bg-apple-border/50 ${currentPage === 1 ? 'opacity-30 cursor-not-allowed' : ''}"
                                ${currentPage === 1 ? 'disabled' : ''}>
                            <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        </button>
                        <span class="px-3 text-xs text-apple-text">
                            Page ${currentPage} of ${totalPages}
                        </span>
                        <button onclick="${onPageChange}(${currentPage + 1})"
                                class="p-1.5 rounded hover:bg-apple-border/50 ${currentPage === totalPages ? 'opacity-30 cursor-not-allowed' : ''}"
                                ${currentPage === totalPages ? 'disabled' : ''}>
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                        <button onclick="${onPageChange}(${totalPages})"
                                class="p-1.5 rounded hover:bg-apple-border/50 ${currentPage === totalPages ? 'opacity-30 cursor-not-allowed' : ''}"
                                ${currentPage === totalPages ? 'disabled' : ''}>
                            <i data-lucide="chevrons-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function setDocsPage(page) {
            docsPage = page;
            updateDocumentsList();
        }

        function setQueriesPage(page) {
            queriesPage = page;
            updateTracesList();
        }

        function setDocChunksPage(page) {
            docChunksPage = page;
            renderDocChunksList();
        }

        function updateDocumentsList() {
            const el = document.getElementById('documents-list');
            const docs = Object.values(allData.documents || {});
            const chunks = Object.values(allData.chunks || {});

            // Update count labels
            document.getElementById('doc-count-label').textContent = `${docs.length} document${docs.length !== 1 ? 's' : ''}`;
            document.getElementById('chunk-count-label').textContent = `${chunks.length} chunk${chunks.length !== 1 ? 's' : ''}`;

            if (!docs.length) {
                el.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-16 text-apple-tertiary">
                        <i data-lucide="folder-open" class="w-12 h-12 mb-3 opacity-40"></i>
                        <p class="text-sm">No documents yet</p>
                        <p class="text-xs mt-1 opacity-70">Upload documents to start indexing</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Paginate
            const totalPages = Math.ceil(docs.length / PAGE_SIZE);
            if (docsPage > totalPages) docsPage = totalPages;
            const startIdx = (docsPage - 1) * PAGE_SIZE;
            const paginatedDocs = docs.slice(startIdx, startIdx + PAGE_SIZE);

            el.innerHTML = `
                <table class="w-full">
                    <thead class="bg-apple-bg/50 border-b border-apple-border">
                        <tr class="text-xs text-apple-secondary uppercase tracking-wide">
                            <th class="text-left py-2 px-4 font-medium">Document</th>
                            <th class="text-left py-2 px-3 font-medium w-24">Pages</th>
                            <th class="text-left py-2 px-3 font-medium w-24">Chunks</th>
                            <th class="text-left py-2 px-3 font-medium w-32">Experiment</th>
                            <th class="w-16"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginatedDocs.map(d => {
                            const docChunks = Object.values(allData.chunks || {}).filter(c => c.doc_id === d.doc_id).length;
                            const expName = getExperimentName(d.experiment_id);
                            return `
                            <tr class="border-b border-apple-border/50 cursor-pointer hover:bg-apple-bg/50 transition-colors group"
                                onclick="openDocumentViewer('${d.doc_id}')">
                                <td class="py-2.5 px-4">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="file-text" class="w-4 h-4 text-apple-secondary flex-shrink-0"></i>
                                        <span class="text-sm text-apple-text truncate">${d.filename || 'Document'}</span>
                                    </div>
                                </td>
                                <td class="py-2.5 px-3 text-sm text-apple-secondary">${d.num_pages || '-'}</td>
                                <td class="py-2.5 px-3 text-sm text-apple-secondary">${docChunks}</td>
                                <td class="py-2.5 px-3">
                                    ${expName ? `<span class="inline-flex items-center gap-1 text-xs text-blue-600"><i data-lucide="folder" class="w-3 h-3"></i>${escapeHtml(expName)}</span>` : '<span class="text-apple-tertiary text-xs">-</span>'}
                                </td>
                                <td class="py-2.5 px-3 text-right">
                                    <div class="flex items-center justify-end gap-1">
                                        <button onclick="event.stopPropagation(); showAssignMenu(event, 'doc', '${d.doc_id}', ${d.experiment_id || 'null'})"
                                                class="p-1 rounded hover:bg-apple-border/50 opacity-0 group-hover:opacity-100 transition-opacity"
                                                title="Assign to experiment">
                                            <i data-lucide="tag" class="w-3.5 h-3.5 text-apple-secondary"></i>
                                        </button>
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-apple-tertiary"></i>
                                    </div>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                ${renderPagination(docs.length, docsPage, PAGE_SIZE, 'setDocsPage')}
            `;
            lucide.createIcons();
        }

        function openDocumentViewer(id) {
            // Clear highlight unless navigating from viewChunkInPdf (which sets highlightChunkText first)
            const isFromChunkNav = (highlightChunkText !== null || highlightChunkIdx !== null) && selectedDoc !== id;
            if (selectedDoc !== id && !isFromChunkNav) {
                highlightChunkText = null;
                highlightChunkIdx = null;
            }
            // Don't reset page if coming from chunk navigation (page already set)
            if (!isFromChunkNav) {
                currentPage = 1;
            }
            // Reset chunk pagination when opening new document
            if (selectedDoc !== id) {
                docChunksPage = 1;
            }
            selectedDoc = id;
            selectedChunkInDoc = null;
            const doc = allData.documents?.[id];
            if (!doc) return;

            const filePath = doc.file_path || '';

            // Update view mode buttons based on document type
            updateViewModeButtons(filePath, 'simple-mode');
            updateViewModeButtons(filePath, 'view-mode');

            // Lazy load parsed doc if not already loaded
            if (!allData.parsed?.[id]) {
                loadParsedDoc(id);
            }

            const docChunks = Object.values(allData.chunks || {}).filter(c => c.doc_id === id);

            document.getElementById('doc-list-view').classList.add('hidden');
            document.getElementById('doc-viewer-simple').classList.remove('hidden');
            document.getElementById('doc-viewer-chunks').classList.add('hidden');

            document.getElementById('doc-viewer-title-simple').textContent = doc.filename || 'Document';
            document.getElementById('doc-viewer-subtitle-simple').textContent = `${doc.num_pages || '?'} pages | ${docChunks.length} chunks`;

            const downloadBtn = document.getElementById('doc-download-btn-simple');
            downloadBtn.href = `/api/files/${encodeURIComponent(filePath)}`;
            downloadBtn.download = doc.filename;

            renderSimpleSourceView();
            lucide.createIcons();
        }

        function showChunksPanel() {
            const doc = allData.documents?.[selectedDoc];
            if (!doc) return;

            const filePath = doc.file_path || '';

            document.getElementById('doc-viewer-simple').classList.add('hidden');
            document.getElementById('doc-viewer-chunks').classList.remove('hidden');

            document.getElementById('doc-viewer-title-chunks').textContent = doc.filename || 'Document';

            const downloadBtn = document.getElementById('doc-download-btn-chunks');
            downloadBtn.href = `/api/files/${encodeURIComponent(filePath)}`;
            downloadBtn.download = doc.filename;

            const docChunks = Object.values(allData.chunks || {}).filter(c => c.doc_id === selectedDoc);
            document.getElementById('chunks-panel-count').textContent = `${docChunks.length} chunks`;

            if (currentPage > 1) {
                document.getElementById('page-indicator').textContent = `Page ${currentPage}`;
            }

            renderDocChunksList();
            renderDocSourceView();
            lucide.createIcons();
        }

        function hideChunksPanel() {
            selectedChunkInDoc = null;
            document.getElementById('doc-viewer-chunks').classList.add('hidden');
            document.getElementById('doc-viewer-simple').classList.remove('hidden');
            document.getElementById('page-indicator').innerHTML = '';
            renderSimpleSourceView();
        }

        function setSimpleViewMode(mode) {
            simpleViewMode = mode;
            document.querySelectorAll('.simple-mode-btn').forEach(btn => {
                btn.classList.remove('bg-apple-blue', 'text-white', 'font-medium');
                btn.classList.add('bg-apple-bg', 'text-apple-secondary');
            });
            const activeBtn = document.getElementById(`simple-mode-${mode}`);
            activeBtn.classList.remove('bg-apple-bg', 'text-apple-secondary');
            activeBtn.classList.add('bg-apple-blue', 'text-white', 'font-medium');
            renderSimpleSourceView();
        }

        function getParsedPages(parsed, docId = null) {
            // If we have parsed text, show it
            if (parsed?.text) {
                const text = parsed.text;
                // Check if text has page break markers
                if (text.includes('\n\n--- PAGE BREAK ---\n\n')) {
                    return text.split('\n\n--- PAGE BREAK ---\n\n');
                }
                // No page breaks - return as single page (the full extracted text)
                return [text];
            }

            // Fallback: if no parsed text, show chunks
            if (docId) {
                const docChunks = Object.values(allData.chunks || {})
                    .filter(c => c.doc_id === docId)
                    .sort((a, b) => (a.index || 0) - (b.index || 0));

                if (docChunks.length > 0) {
                    // Combine all chunks as the parsed view
                    const text = docChunks.map((c, idx) => c.text || '').join('\n\n');
                    return [text];
                }
            }

            return [];
        }

        function highlightTextInContent(text, highlightStr, charIndices = null) {
            if (!text) return escapeHtml(text);
            if (!highlightStr && !charIndices) return escapeHtml(text);

            // Method 1: Use character indices if available (most precise)
            if (charIndices && charIndices.start !== null && charIndices.end !== null) {
                const start = Math.max(0, charIndices.start);
                const end = Math.min(text.length, charIndices.end);

                if (start < end && start < text.length) {
                    const before = text.slice(0, start);
                    const matched = text.slice(start, end);
                    const after = text.slice(end);

                    return escapeHtml(before) +
                        '<mark class="chunk-highlight bg-amber-200 text-amber-900 rounded px-0.5" data-char-start="' + start + '" data-char-end="' + end + '">' +
                        escapeHtml(matched) + '</mark>' + escapeHtml(after);
                }
            }

            // Method 2: Fall back to fuzzy text matching
            if (!highlightStr) return escapeHtml(text);

            // Clean up the search string - take first portion for matching
            const cleanSearch = highlightStr.trim().replace(/\s+/g, ' ');
            const cleanText = text.replace(/\s+/g, ' ');

            // Search for the first 80 chars of the chunk in the text
            const searchPortion = cleanSearch.slice(0, 80).toLowerCase();
            const matchIdx = cleanText.toLowerCase().indexOf(searchPortion);

            if (matchIdx === -1) {
                // Try with even shorter portion
                const shortSearch = cleanSearch.slice(0, 40).toLowerCase();
                const shortIdx = cleanText.toLowerCase().indexOf(shortSearch);
                if (shortIdx === -1) return escapeHtml(text);

                // Found with short search
                const matchLen = Math.min(cleanSearch.length, cleanText.length - shortIdx, 500);
                const before = text.slice(0, shortIdx);
                const matched = text.slice(shortIdx, shortIdx + matchLen);
                const after = text.slice(shortIdx + matchLen);
                return escapeHtml(before) +
                    '<mark class="chunk-highlight bg-amber-200 text-amber-900 rounded px-0.5">' +
                    escapeHtml(matched) + '</mark>' + escapeHtml(after);
            }

            // Found the match - highlight the chunk length
            const matchLen = Math.min(cleanSearch.length, cleanText.length - matchIdx, 500);
            const before = text.slice(0, matchIdx);
            const matched = text.slice(matchIdx, matchIdx + matchLen);
            const after = text.slice(matchIdx + matchLen);

            return escapeHtml(before) +
                '<mark class="chunk-highlight bg-amber-200 text-amber-900 rounded px-0.5">' +
                escapeHtml(matched) + '</mark>' + escapeHtml(after);
        }

        function highlightTextInHtmlIframe(iframeId, searchText) {
            if (!searchText) return;

            const iframe = document.getElementById(iframeId);
            if (!iframe) return;

            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                if (!iframeDoc || !iframeDoc.body) return;

                // Remove any existing highlights
                const existingHighlights = iframeDoc.querySelectorAll('.sourcemapr-highlight');
                existingHighlights.forEach(el => {
                    const parent = el.parentNode;
                    if (parent) {
                        parent.replaceChild(iframeDoc.createTextNode(el.textContent), el);
                        parent.normalize();
                    }
                });

                // Add highlight style if not already added
                if (!iframeDoc.getElementById('sourcemapr-highlight-style')) {
                    const style = iframeDoc.createElement('style');
                    style.id = 'sourcemapr-highlight-style';
                    style.textContent = '.sourcemapr-highlight { background-color: #fef08a !important; color: #92400e !important; padding: 2px 4px; border-radius: 3px; box-shadow: 0 0 0 2px rgba(254, 240, 138, 0.5); }';
                    iframeDoc.head.appendChild(style);
                }

                // Normalize whitespace in search text (same as highlightTextInContent)
                const cleanSearch = searchText.trim().replace(/\s+/g, ' ');

                // Get all text content from body, preserving node references
                const textNodes = [];
                const walker = iframeDoc.createTreeWalker(
                    iframeDoc.body,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );

                let node;
                let fullText = '';
                while ((node = walker.nextNode())) {
                    const nodeText = node.textContent;
                    textNodes.push({
                        node: node,
                        start: fullText.length,
                        end: fullText.length + nodeText.length,
                        text: nodeText
                    });
                    fullText += nodeText;
                }

                // Normalize full text for searching
                const normalizedFull = fullText.replace(/\s+/g, ' ');

                // Try to find match with 80 chars first, then 40 (same as parsed view)
                let searchPortion = cleanSearch.slice(0, 80).toLowerCase();
                let matchIdx = normalizedFull.toLowerCase().indexOf(searchPortion);

                if (matchIdx === -1) {
                    searchPortion = cleanSearch.slice(0, 40).toLowerCase();
                    matchIdx = normalizedFull.toLowerCase().indexOf(searchPortion);
                }

                if (matchIdx === -1) {
                    console.log('Could not find text in HTML iframe');
                    return;
                }

                // Map normalized position back to original position
                // Count characters while normalizing to find original position
                let origPos = 0;
                let normPos = 0;
                let lastWasSpace = false;

                for (let i = 0; i < fullText.length && normPos < matchIdx; i++) {
                    const char = fullText[i];
                    if (/\s/.test(char)) {
                        if (!lastWasSpace) {
                            normPos++;
                            lastWasSpace = true;
                        }
                    } else {
                        normPos++;
                        lastWasSpace = false;
                    }
                    origPos = i + 1;
                }

                // Find which text node contains this position
                const matchLen = Math.min(cleanSearch.length, 300);
                for (const tn of textNodes) {
                    if (origPos >= tn.start && origPos < tn.end) {
                        const nodeOffset = origPos - tn.start;
                        const availableLen = tn.text.length - nodeOffset;
                        const highlightLen = Math.min(matchLen, availableLen);

                        if (highlightLen > 5) {  // Only highlight if we have meaningful text
                            try {
                                const range = iframeDoc.createRange();
                                range.setStart(tn.node, nodeOffset);
                                range.setEnd(tn.node, nodeOffset + highlightLen);

                                const highlight = iframeDoc.createElement('span');
                                highlight.className = 'sourcemapr-highlight';
                                range.surroundContents(highlight);

                                // Scroll to the highlight
                                highlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            } catch (rangeErr) {
                                console.log('Range error:', rangeErr);
                            }
                        }
                        break;
                    }
                }
            } catch (e) {
                console.log('Could not highlight in iframe:', e);
            }
        }

        function renderSimpleSourceView() {
            const doc = allData.documents?.[selectedDoc];
            if (!doc) return;

            const parsed = allData.parsed?.[selectedDoc] || {};
            const filePath = doc.file_path || '';
            const fileExt = filePath.toLowerCase().split('.').pop();
            const isPdf = fileExt === 'pdf';
            const isHtml = ['htm', 'html', 'xhtml'].includes(fileExt);
            const content = document.getElementById('doc-simple-content');

            const pages = getParsedPages(parsed, selectedDoc);
            const totalPages = pages.length || 1;
            const safePage = Math.min(Math.max(1, currentPage), totalPages);
            const pageText = pages[safePage - 1] || 'No content for this page';

            const pdfUrl = `/api/files/${encodeURIComponent(filePath)}`;

            if (simpleViewMode === 'split') {
                content.innerHTML = `
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <div class="flex items-center justify-center gap-2 px-3 py-2 bg-white border-b border-apple-border">
                            <button onclick="goToPage(1)" class="p-1.5 hover:bg-apple-bg rounded ${safePage <= 1 ? 'opacity-30' : ''}">
                                <i data-lucide="chevrons-left" class="w-4 h-4 text-apple-secondary"></i>
                            </button>
                            <button onclick="goToPage(${safePage - 1})" class="p-1.5 hover:bg-apple-bg rounded ${safePage <= 1 ? 'opacity-30' : ''}">
                                <i data-lucide="chevron-left" class="w-4 h-4 text-apple-secondary"></i>
                            </button>
                            <div class="flex items-center gap-2">
                                <input type="number" min="1" max="${totalPages}" value="${safePage}"
                                       onchange="goToPage(parseInt(this.value) || 1)"
                                       class="w-12 bg-white border border-apple-border rounded-md px-2 py-1 text-center text-sm">
                                <span class="text-sm text-apple-secondary">of ${totalPages}</span>
                            </div>
                            <button onclick="goToPage(${safePage + 1})" class="p-1.5 hover:bg-apple-bg rounded ${safePage >= totalPages ? 'opacity-30' : ''}">
                                <i data-lucide="chevron-right" class="w-4 h-4 text-apple-secondary"></i>
                            </button>
                            <button onclick="goToPage(${totalPages})" class="p-1.5 hover:bg-apple-bg rounded ${safePage >= totalPages ? 'opacity-30' : ''}">
                                <i data-lucide="chevrons-right" class="w-4 h-4 text-apple-secondary"></i>
                            </button>
                            ${highlightChunkText ? '<span class="ml-4 bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs flex items-center gap-1"><i data-lucide="highlighter" class="w-3 h-3"></i>Highlighted</span>' : ''}
                        </div>
                        <div class="flex-1 flex overflow-hidden">
                            <div class="flex flex-col border-r border-apple-border overflow-hidden" style="flex: 2;">
                                <div class="px-3 py-1.5 bg-apple-bg/50 border-b border-apple-border text-xs text-apple-secondary flex items-center gap-1">
                                    <i data-lucide="file-text" class="w-3 h-3"></i>
                                    Original ${isPdf ? 'PDF' : isHtml ? 'HTML' : 'Document'} ${highlightChunkText ? '(with highlights)' : ''}
                                </div>
                                ${isPdf ? `<div id="simple-pdf-viewer" class="flex-1"></div>` :
                                  isHtml ? `<div id="simple-html-container" class="flex-1 flex flex-col">
                                    <div id="simple-html-loading" class="flex-1 flex items-center justify-center bg-gray-50">
                                        <div class="text-center">
                                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-apple-blue mx-auto mb-2"></div>
                                            <p class="text-sm text-apple-secondary">Loading HTML document...</p>
                                        </div>
                                    </div>
                                    <iframe id="simple-html-viewer" src="${pdfUrl}" class="flex-1 w-full bg-white hidden" sandbox="allow-same-origin" onload="document.getElementById('simple-html-loading')?.classList.add('hidden'); this.classList.remove('hidden'); ${highlightChunkText ? `setTimeout(() => highlightTextInHtmlIframe('simple-html-viewer', '${escapeForJs(highlightChunkText)}'), 500);` : ''}"></iframe>
                                </div>` :
                                `<div class="flex-1 flex items-center justify-center text-apple-secondary"><p>No source document available</p></div>`}
                            </div>
                            <div class="flex flex-col overflow-hidden" style="flex: 1;">
                                <div class="px-3 py-1.5 bg-apple-bg/50 border-b border-apple-border text-xs text-apple-secondary">
                                    Parsed Text (Page ${safePage})
                                </div>
                                <pre class="flex-1 p-3 text-xs overflow-y-auto bg-apple-bg/30 text-apple-text">${highlightTextInContent(pageText, highlightChunkText, highlightChunkIdx)}</pre>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                // Render PDF with PDF.js
                if (isPdf) {
                    renderPdfViewer('simple-pdf-viewer', pdfUrl, safePage, highlightChunkText, false);
                }
            } else if (simpleViewMode === 'pdf') {
                if (isPdf) {
                    // PDF only view - show all pages with scrolling
                    content.innerHTML = `
                        <div class="flex-1 flex flex-col overflow-hidden">
                            <div class="px-3 py-1.5 bg-apple-bg/50 border-b border-apple-border text-xs text-apple-secondary flex items-center gap-2">
                                <i data-lucide="file" class="w-3 h-3"></i>
                                <span>Original PDF (${totalPages} pages) - Scroll to navigate</span>
                                ${highlightChunkText ? '<span class="ml-2 bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs flex items-center gap-1"><i data-lucide="highlighter" class="w-3 h-3"></i>Highlighted</span>' : ''}
                            </div>
                            <div id="simple-pdf-viewer-full" class="flex-1"></div>
                        </div>
                    `;
                    lucide.createIcons();
                    // Render all pages for scrolling
                    renderPdfViewer('simple-pdf-viewer-full', pdfUrl, safePage, highlightChunkText, true);
                } else if (isHtml) {
                    // HTML only view - render in iframe with loading state
                    content.innerHTML = `
                        <div class="flex-1 flex flex-col overflow-hidden">
                            <div class="px-3 py-1.5 bg-apple-bg/50 border-b border-apple-border text-xs text-apple-secondary flex items-center gap-2">
                                <i data-lucide="code" class="w-3 h-3"></i>
                                <span>Original HTML Document</span>
                                ${highlightChunkText ? '<span class="ml-2 bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs flex items-center gap-1"><i data-lucide="highlighter" class="w-3 h-3"></i>Highlighted in Parsed view</span>' : ''}
                            </div>
                            <div class="flex-1 flex flex-col relative">
                                <div id="simple-html-full-loading" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-10">
                                    <div class="text-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-apple-blue mx-auto mb-2"></div>
                                        <p class="text-sm text-apple-secondary">Loading HTML document...</p>
                                    </div>
                                </div>
                                <iframe id="simple-html-viewer-full" src="${pdfUrl}" class="flex-1 w-full bg-white" sandbox="allow-same-origin" onload="document.getElementById('simple-html-full-loading')?.classList.add('hidden'); ${highlightChunkText ? `setTimeout(() => highlightTextInHtmlIframe('simple-html-viewer-full', '${escapeForJs(highlightChunkText)}'), 500);` : ''}"></iframe>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                } else {
                    content.innerHTML = `<div class="flex-1 flex items-center justify-center text-apple-secondary"><p>No source document available</p></div>`;
                }
            } else if (simpleViewMode === 'parsed') {
                // Parsed only view - show all text with scrolling
                const allParsedText = pages.join('\n\nââââââââââ PAGE BREAK ââââââââââ\n\n');
                const hasHighlightParsed = highlightChunkText || (highlightChunkIdx && highlightChunkIdx.start !== null);
                const fuzzyMatchNote = isHtml && hasHighlightParsed ? '<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs" title="LangChain/LlamaIndex don\'t provide page numbers for HTML documents, so chunk location is determined via fuzzy text matching">Fuzzy Match</span>' : '';
                content.innerHTML = `
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <div class="px-3 py-1.5 bg-apple-bg/50 border-b border-apple-border text-xs text-apple-secondary flex items-center gap-2">
                            <i data-lucide="file-text" class="w-3 h-3"></i>
                            <span>Parsed Text (${totalPages} pages) - Scroll to navigate</span>
                            ${hasHighlightParsed ? '<span class="ml-2 bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs">Highlighted</span>' : ''}
                            ${fuzzyMatchNote}
                            ${hasHighlightParsed ? '<button onclick="clearHighlight(); renderSimpleSourceView();" class="ml-auto text-xs text-apple-secondary hover:text-apple-text px-2 py-0.5 bg-apple-bg rounded hover:bg-apple-border/50">Clear Highlight</button>' : ''}
                        </div>
                        <pre class="flex-1 p-4 text-sm overflow-y-auto bg-apple-bg/30 text-apple-text">${highlightTextInContent(allParsedText, highlightChunkText, highlightChunkIdx)}</pre>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function goToPage(page) {
            const parsed = allData.parsed?.[selectedDoc] || {};
            const pages = getParsedPages(parsed, selectedDoc);
            const totalPages = pages.length || 1;
            currentPage = Math.min(Math.max(1, page), totalPages);

            if (document.getElementById('doc-viewer-simple').classList.contains('hidden')) {
                renderDocSourceView();
            } else {
                renderSimpleSourceView();
            }
        }

        function renderDocChunksList() {
            const doc = allData.documents?.[selectedDoc];
            if (!doc) return;

            const docChunks = Object.values(allData.chunks || {}).filter(c => c.doc_id === selectedDoc);
            const el = document.getElementById('doc-chunks-list');

            if (!docChunks.length) {
                el.innerHTML = '<p class="text-apple-secondary text-xs p-2">No chunks</p>';
                return;
            }

            // Paginate chunks
            const totalPages = Math.ceil(docChunks.length / PAGE_SIZE);
            if (docChunksPage > totalPages) docChunksPage = totalPages;
            const startIdx = (docChunksPage - 1) * PAGE_SIZE;
            const paginatedChunks = docChunks.slice(startIdx, startIdx + PAGE_SIZE);

            el.innerHTML = `
                <table class="w-full text-xs">
                    <thead class="bg-apple-bg/50 border-b border-apple-border sticky top-0">
                        <tr class="text-apple-secondary uppercase tracking-wide">
                            <th class="text-left py-1.5 px-2 font-medium w-12">#</th>
                            <th class="text-left py-1.5 px-2 font-medium w-14">Page</th>
                            <th class="text-left py-1.5 px-2 font-medium">Preview</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginatedChunks.map(c => `
                            <tr class="doc-chunk-item border-b border-apple-border/30 cursor-pointer transition-all
                                        ${selectedChunkInDoc === c.chunk_id ? 'bg-apple-blue/10' : 'hover:bg-apple-border/30'}"
                                 data-chunk-id="${c.chunk_id}"
                                 data-text="${escapeHtml((c.text || '').toLowerCase())}"
                                 onclick="selectChunkInDoc('${c.chunk_id}')">
                                <td class="py-2 px-2 text-apple-text font-medium">${c.index ?? '?'}</td>
                                <td class="py-2 px-2 text-apple-secondary">${c.page_number || '-'}</td>
                                <td class="py-2 px-2 text-apple-secondary truncate max-w-0">${(c.text || '').slice(0, 60)}...</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${docChunks.length > PAGE_SIZE ? `
                <div class="flex items-center justify-between px-2 py-2 border-t border-apple-border/50 bg-apple-bg/30 text-xs">
                    <span class="text-apple-secondary">${startIdx + 1}-${Math.min(startIdx + PAGE_SIZE, docChunks.length)} of ${docChunks.length}</span>
                    <div class="flex items-center gap-1">
                        <button onclick="setDocChunksPage(${docChunksPage - 1})"
                                class="p-1 rounded hover:bg-apple-border/50 ${docChunksPage === 1 ? 'opacity-30 cursor-not-allowed' : ''}"
                                ${docChunksPage === 1 ? 'disabled' : ''}>
                            <i data-lucide="chevron-left" class="w-3 h-3"></i>
                        </button>
                        <span class="px-2">${docChunksPage}/${totalPages}</span>
                        <button onclick="setDocChunksPage(${docChunksPage + 1})"
                                class="p-1 rounded hover:bg-apple-border/50 ${docChunksPage === totalPages ? 'opacity-30 cursor-not-allowed' : ''}"
                                ${docChunksPage === totalPages ? 'disabled' : ''}>
                            <i data-lucide="chevron-right" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>
                ` : ''}
            `;
            lucide.createIcons();
        }

        function filterDocChunks() {
            const q = document.getElementById('doc-chunk-search').value.toLowerCase();
            document.querySelectorAll('.doc-chunk-item').forEach(el => {
                const text = el.dataset.text || '';
                el.style.display = text.includes(q) ? 'block' : 'none';
            });
        }

        function selectChunkInDoc(chunkId) {
            selectedChunkInDoc = chunkId;
            const chunk = allData.chunks?.[chunkId];

            document.querySelectorAll('.doc-chunk-item').forEach(el => {
                if (el.dataset.chunkId === chunkId) {
                    el.classList.add('bg-apple-blue/10', 'border-apple-blue/30');
                    el.classList.remove('border-transparent');
                    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    el.classList.remove('bg-apple-blue/10', 'border-apple-blue/30');
                    el.classList.add('border-transparent');
                }
            });

            if (chunk?.page_number) {
                const pageIndicator = document.getElementById('page-indicator');
                if (pageIndicator) {
                    pageIndicator.textContent = `Page ${chunk.page_number}`;
                }
                currentPage = chunk.page_number;
            }

            renderDocSourceView();

            // Scroll to highlighted chunk text in both parsed view and PDF after render
            // Use 'instant' behavior to avoid jarring scroll from top after render
            setTimeout(() => {
                // Scroll parsed text
                const highlighted = document.querySelector('.chunk-highlight');
                if (highlighted) {
                    highlighted.scrollIntoView({ behavior: 'instant', block: 'center' });
                }
                // Scroll PDF to highlight (with retry for slow renders)
                const scrollPdfToHighlight = (retries = 3) => {
                    const pdfHighlight = document.querySelector('#doc-pdf-viewer .textLayer .highlight, #doc-pdf-viewer-full .textLayer .highlight');
                    if (pdfHighlight) {
                        pdfHighlight.scrollIntoView({ behavior: 'instant', block: 'center' });
                    } else if (retries > 0) {
                        setTimeout(() => scrollPdfToHighlight(retries - 1), 200);
                    }
                };
                scrollPdfToHighlight();
            }, 200);
        }

        function setDocViewMode(mode) {
            docViewMode = mode;
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.remove('bg-apple-blue', 'text-white', 'font-medium');
                btn.classList.add('bg-apple-bg', 'text-apple-secondary');
            });
            const modeBtn = document.getElementById(`view-mode-${mode}`);
            if (modeBtn) {
                modeBtn.classList.remove('bg-apple-bg', 'text-apple-secondary');
                modeBtn.classList.add('bg-apple-blue', 'text-white', 'font-medium');
            }
            renderDocSourceView();
        }

        function renderDocSourceView() {
            const doc = allData.documents?.[selectedDoc];
            if (!doc) return;

            const parsed = allData.parsed?.[selectedDoc] || {};
            const filePath = doc.file_path || '';
            const fileExt = filePath.toLowerCase().split('.').pop();
            const isPdf = fileExt === 'pdf';
            const isHtml = ['htm', 'html', 'xhtml'].includes(fileExt);
            const content = document.getElementById('doc-source-content');

            const pages = getParsedPages(parsed, selectedDoc);
            const totalPages = pages.length || 1;
            const safePage = Math.min(Math.max(1, currentPage), totalPages);
            const pageText = pages[safePage - 1] || 'No content for this page';

            const pdfUrl = `/api/files/${encodeURIComponent(filePath)}`;

            // Get highlight text from selected chunk
            const selectedChunk = selectedChunkInDoc ? allData.chunks?.[selectedChunkInDoc] : null;
            const chunkHighlightText = selectedChunk?.text || null;

            if (docViewMode === 'split') {
                content.innerHTML = `
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <div class="flex items-center justify-center gap-2 px-3 py-2 bg-white border-b border-apple-border">
                            <button onclick="goToPage(1)" class="p-1.5 hover:bg-apple-bg rounded ${safePage <= 1 ? 'opacity-30' : ''}">
                                <i data-lucide="chevrons-left" class="w-4 h-4 text-apple-secondary"></i>
                            </button>
                            <button onclick="goToPage(${safePage - 1})" class="p-1.5 hover:bg-apple-bg rounded ${safePage <= 1 ? 'opacity-30' : ''}">
                                <i data-lucide="chevron-left" class="w-4 h-4 text-apple-secondary"></i>
                            </button>
                            <div class="flex items-center gap-2">
                                <input type="number" min="1" max="${totalPages}" value="${safePage}"
                                       onchange="goToPage(parseInt(this.value) || 1)"
                                       class="w-12 bg-white border border-apple-border rounded-md px-2 py-1 text-center text-sm">
                                <span class="text-sm text-apple-secondary">of ${totalPages}</span>
                            </div>
                            <button onclick="goToPage(${safePage + 1})" class="p-1.5 hover:bg-apple-bg rounded ${safePage >= totalPages ? 'opacity-30' : ''}">
                                <i data-lucide="chevron-right" class="w-4 h-4 text-apple-secondary"></i>
                            </button>
                            <button onclick="goToPage(${totalPages})" class="p-1.5 hover:bg-apple-bg rounded ${safePage >= totalPages ? 'opacity-30' : ''}">
                                <i data-lucide="chevrons-right" class="w-4 h-4 text-apple-secondary"></i>
                            </button>
                            ${chunkHighlightText ? '<span class="ml-4 bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs flex items-center gap-1"><i data-lucide="highlighter" class="w-3 h-3"></i>Chunk Highlighted</span>' : ''}
                        </div>
                        <div class="flex-1 flex overflow-hidden">
                            <div class="flex flex-col border-r border-apple-border overflow-hidden" style="flex: 2;">
                                <div class="px-3 py-1.5 bg-apple-bg/50 border-b border-apple-border text-xs text-apple-secondary flex items-center gap-1">
                                    <i data-lucide="file-text" class="w-3 h-3"></i>
                                    Original ${isPdf ? 'PDF' : isHtml ? 'HTML' : 'Document'} ${chunkHighlightText ? '(with highlights)' : ''}
                                </div>
                                ${isPdf ? `<div id="doc-pdf-viewer" class="flex-1"></div>` :
                                  isHtml ? `<div id="doc-html-container" class="flex-1 flex flex-col">
                                    <div id="doc-html-loading" class="flex-1 flex items-center justify-center bg-gray-50">
                                        <div class="text-center">
                                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-apple-blue mx-auto mb-2"></div>
                                            <p class="text-sm text-apple-secondary">Loading HTML document...</p>
                                        </div>
                                    </div>
                                    <iframe id="doc-html-viewer" src="${pdfUrl}" class="flex-1 w-full bg-white hidden" sandbox="allow-same-origin" onload="document.getElementById('doc-html-loading')?.classList.add('hidden'); this.classList.remove('hidden'); ${chunkHighlightText ? `setTimeout(() => highlightTextInHtmlIframe('doc-html-viewer', '${escapeForJs(chunkHighlightText)}'), 500);` : ''}"></iframe>
                                </div>` :
                                `<div class="flex-1 flex items-center justify-center text-apple-secondary"><p>No source document available</p></div>`}
                            </div>
                            <div class="flex flex-col overflow-hidden" style="flex: 1;">
                                <div class="px-3 py-1.5 bg-apple-bg/50 border-b border-apple-border text-xs text-apple-secondary">
                                    Parsed Text (Page ${safePage})
                                </div>
                                <pre class="flex-1 p-3 text-xs overflow-y-auto bg-apple-bg/30 text-apple-text">${highlightTextInContent(pageText, chunkHighlightText)}</pre>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                // Render PDF with PDF.js and chunk highlighting
                if (isPdf) {
                    renderPdfViewer('doc-pdf-viewer', pdfUrl, safePage, chunkHighlightText, false);
                }
            } else if (docViewMode === 'pdf') {
                if (isPdf) {
                    // PDF only view - show all pages with scrolling
                    content.innerHTML = `
                        <div class="flex-1 flex flex-col overflow-hidden">
                            <div class="px-3 py-1.5 bg-apple-bg/50 border-b border-apple-border text-xs text-apple-secondary flex items-center gap-2">
                                <i data-lucide="file" class="w-3 h-3"></i>
                                <span>Original PDF (${totalPages} pages) - Scroll to navigate</span>
                                ${chunkHighlightText ? '<span class="ml-2 bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs flex items-center gap-1"><i data-lucide="highlighter" class="w-3 h-3"></i>Chunk Highlighted</span>' : ''}
                            </div>
                            <div id="doc-pdf-viewer-full" class="flex-1"></div>
                        </div>
                    `;
                    lucide.createIcons();
                    // Render all pages for scrolling
                    renderPdfViewer('doc-pdf-viewer-full', pdfUrl, safePage, chunkHighlightText, true);
                } else if (isHtml) {
                    // HTML only view - render in iframe with loading state
                    content.innerHTML = `
                        <div class="flex-1 flex flex-col overflow-hidden">
                            <div class="px-3 py-1.5 bg-apple-bg/50 border-b border-apple-border text-xs text-apple-secondary flex items-center gap-2">
                                <i data-lucide="code" class="w-3 h-3"></i>
                                <span>Original HTML Document</span>
                                ${chunkHighlightText ? '<span class="ml-2 bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs flex items-center gap-1"><i data-lucide="highlighter" class="w-3 h-3"></i>Chunk highlighted in Parsed view</span>' : ''}
                            </div>
                            <div class="flex-1 flex flex-col relative">
                                <div id="doc-html-full-loading" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-10">
                                    <div class="text-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-apple-blue mx-auto mb-2"></div>
                                        <p class="text-sm text-apple-secondary">Loading HTML document...</p>
                                    </div>
                                </div>
                                <iframe id="doc-html-viewer-full" src="${pdfUrl}" class="flex-1 w-full bg-white" sandbox="allow-same-origin" onload="document.getElementById('doc-html-full-loading')?.classList.add('hidden'); ${chunkHighlightText ? `setTimeout(() => highlightTextInHtmlIframe('doc-html-viewer-full', '${escapeForJs(chunkHighlightText)}'), 500);` : ''}"></iframe>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                } else {
                    content.innerHTML = `<div class="flex-1 flex items-center justify-center text-apple-secondary"><p>No source document available</p></div>`;
                }
            } else if (docViewMode === 'parsed') {
                // Parsed only view - show all text with scrolling and page markers
                const pagesWithMarkers = pages.map((pageText, i) => {
                    const pageNum = i + 1;
                    return `<div class="parsed-page-marker" data-page="${pageNum}">
<div class="sticky top-0 bg-apple-bg/90 backdrop-blur-sm px-2 py-1 mb-2 rounded text-xs font-medium text-apple-secondary border-b border-apple-border">Page ${pageNum}</div>
${highlightTextInContent(pageText, chunkHighlightText)}
</div>`;
                }).join('\n\n');

                content.innerHTML = `
                    <div class="flex-1 flex flex-col overflow-hidden relative">
                        <div class="px-3 py-1.5 bg-apple-bg/50 border-b border-apple-border text-xs text-apple-secondary flex items-center gap-2">
                            <i data-lucide="file-text" class="w-3 h-3"></i>
                            <span>Parsed Text (${totalPages} pages) - Scroll to navigate</span>
                            ${chunkHighlightText ? '<span class="ml-2 bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs">Chunk Highlighted</span>' : ''}
                            <span id="floating-page-indicator" class="ml-auto bg-apple-text text-white px-2 py-0.5 rounded text-xs font-medium">Page 1 / ${totalPages}</span>
                        </div>
                        <pre id="parsed-text-container" class="flex-1 p-4 text-sm overflow-y-auto bg-apple-bg/30 text-apple-text">${pagesWithMarkers}</pre>
                    </div>
                `;
                lucide.createIcons();
                // Set up scroll tracking for page indicator
                setupParsedTextScrollTracking(totalPages);
            }
        }

        function setupParsedTextScrollTracking(totalPages) {
            const container = document.getElementById('parsed-text-container');
            const indicator = document.getElementById('floating-page-indicator');
            if (!container || !indicator) return;

            const pageMarkers = container.querySelectorAll('.parsed-page-marker');
            if (!pageMarkers.length) return;

            // Use Intersection Observer to track visible pages
            const observer = new IntersectionObserver((entries) => {
                let visiblePage = 1;
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        visiblePage = parseInt(entry.target.dataset.page) || 1;
                    }
                });
                // Find the topmost visible page
                for (const marker of pageMarkers) {
                    const rect = marker.getBoundingClientRect();
                    const containerRect = container.getBoundingClientRect();
                    if (rect.top <= containerRect.top + 100 && rect.bottom > containerRect.top) {
                        visiblePage = parseInt(marker.dataset.page) || 1;
                        break;
                    }
                }
                indicator.textContent = `Page ${visiblePage} / ${totalPages}`;
                currentPage = visiblePage;
            }, {
                root: container,
                threshold: 0.1,
                rootMargin: '-10% 0px -80% 0px'
            });

            pageMarkers.forEach(marker => observer.observe(marker));

            // Also use scroll event for more responsive updates
            container.addEventListener('scroll', () => {
                const containerRect = container.getBoundingClientRect();
                let visiblePage = 1;
                for (const marker of pageMarkers) {
                    const rect = marker.getBoundingClientRect();
                    if (rect.top <= containerRect.top + 50) {
                        visiblePage = parseInt(marker.dataset.page) || 1;
                    }
                }
                indicator.textContent = `Page ${visiblePage} / ${totalPages}`;
                currentPage = visiblePage;
            });
        }

        function closeDocumentViewer() {
            selectedDoc = null;
            selectedChunkInDoc = null;
            currentPage = 1;
            document.getElementById('doc-viewer-simple').classList.add('hidden');
            document.getElementById('doc-viewer-chunks').classList.add('hidden');
            document.getElementById('doc-list-view').classList.remove('hidden');
        }

        function selectDocument(id) {
            openDocumentViewer(id);
        }

        // ========== Chunk Navigation (from Retrievals) ==========
        function viewChunkInPdf(docId, pageNumber, searchText, chunkId) {
            // Get the full chunk text and indices for highlighting
            const chunk = allData.chunks?.[chunkId];
            highlightChunkText = chunk?.text || searchText || null;

            // Extract character indices for precise highlighting if available
            highlightChunkIdx = (chunk?.start_char_idx !== null && chunk?.start_char_idx !== undefined)
                ? { start: chunk.start_char_idx, end: chunk.end_char_idx }
                : null;

            // Navigate to document and show parsed view with highlighting
            showTab('documents');
            setTimeout(() => {
                currentPage = pageNumber || 1;
                openDocumentViewer(docId);
                // Switch to parsed view to show highlighting
                setTimeout(() => {
                    setSimpleViewMode('parsed');
                    // Scroll to highlighted text after render
                    // Use 'instant' behavior to avoid jarring scroll from top after render
                    setTimeout(() => {
                        const highlighted = document.querySelector('.chunk-highlight');
                        if (highlighted) {
                            highlighted.scrollIntoView({ behavior: 'instant', block: 'center' });
                        }
                    }, 100);
                }, 100);
            }, 100);
        }

        function clearHighlight() {
            highlightChunkText = null;
            highlightChunkIdx = null;
        }

        // ========== Source Sidebar (in Requests view) ==========
        let sidebarPage = 1;
        let sidebarDocId = null;
        let sidebarViewMode = 'parsed'; // 'parsed' or 'source'

        // Pagination state for chunks
        let chunksPage = 1;
        const chunksPerPage = 10;

        function showMoreChunks(btn, results) {
            const container = document.getElementById('chunks-container');
            if (!container) return;

            // Render all remaining chunks
            const startIdx = 10;
            const remainingChunks = results.slice(startIdx);

            remainingChunks.forEach((res, idx) => {
                const i = startIdx + idx;
                const chunk = allData.chunks?.[res.chunk_id];
                const doc = chunk ? allData.documents?.[chunk.doc_id] : (res.doc_id ? allData.documents?.[res.doc_id] : null);
                const docName = doc?.filename || res.doc_id || '';
                const pageNum = chunk?.page_number || res.page_number;

                const div = document.createElement('div');
                div.className = 'chunk-item bg-apple-bg/50 rounded-lg p-3 border border-apple-border/50 hover:border-apple-border transition-colors';
                div.innerHTML = `
                    <div class="flex items-center gap-2 mb-2 flex-wrap text-xs">
                        <span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded font-medium">#${i + 1}</span>
                        <span class="text-apple-tertiary">score: ${res.score?.toFixed(4)}</span>
                        ${docName ? `<span class="text-apple-text flex items-center gap-1"><i data-lucide="file-text" class="w-3 h-3"></i>${escapeHtml(docName)}</span>` : ''}
                        ${pageNum ? `<span class="text-apple-tertiary">p.${pageNum}</span>` : ''}
                        ${chunk || res.doc_id ? `
                        <button onclick="event.stopPropagation(); viewChunkSource('${res.chunk_id}', '${res.doc_id || ''}', ${res.page_number || 'null'}, decodeURIComponent('${encodeURIComponent(res.text || '')}'))"
                                class="ml-auto text-xs text-apple-blue hover:underline flex items-center gap-1">
                            <i data-lucide="eye" class="w-3 h-3"></i>
                            View Source
                        </button>
                        ` : ''}
                    </div>
                    <p class="text-sm text-apple-secondary line-clamp-3">${escapeHtml(res.text || '')}</p>
                `;
                container.appendChild(div);
            });

            // Remove the button
            btn.remove();
            lucide.createIcons();
        }

        function viewChunkSource(chunkId, fallbackDocId = null, fallbackPage = null, fallbackText = null) {
            const chunk = allData.chunks?.[chunkId];
            const docId = chunk?.doc_id || fallbackDocId;
            const pageNumber = chunk?.page_number || fallbackPage || 1;
            const text = chunk?.text || fallbackText || '';

            // Extract character indices for precise highlighting if available
            const charIndices = (chunk?.start_char_idx !== null && chunk?.start_char_idx !== undefined)
                ? { start: chunk.start_char_idx, end: chunk.end_char_idx }
                : null;

            if (!docId) {
                console.log('viewChunkSource: No doc_id found for chunk', chunkId);
                return;
            }
            openSourceSidebar(docId, pageNumber, text, charIndices);
        }

        function openSourceSidebar(docId, pageNumber, chunkText, charIndices = null) {
            let doc = allData.documents?.[docId];
            let parsed = allData.parsed?.[docId];

            // Try to find by filename if doc_id lookup fails
            if (!doc && docId) {
                const docs = Object.values(allData.documents || {});
                doc = docs.find(d => d.filename === docId || d.doc_id === docId);
                if (doc) {
                    parsed = allData.parsed?.[doc.doc_id];
                }
            }

            if (!doc || !parsed) {
                console.log('openSourceSidebar: Document or parsed content not found', { docId, doc: !!doc, parsed: !!parsed });
                console.log('Available docs:', Object.keys(allData.documents || {}));
                alert('Source document not found. The document may not have been indexed yet.');
                return;
            }

            sidebarDocId = docId;
            sidebarPage = pageNumber || 1;
            highlightChunkText = chunkText || null;
            highlightChunkIdx = charIndices; // Store character indices for precise highlighting
            sidebarViewMode = 'parsed'; // Always start with parsed view

            document.getElementById('source-sidebar').classList.remove('hidden');
            document.getElementById('source-sidebar-title').textContent = doc.filename || 'Document';

            // Reset toggle buttons
            document.querySelectorAll('.sidebar-mode-btn').forEach(btn => {
                btn.classList.remove('bg-apple-blue', 'text-white', 'font-medium');
                btn.classList.add('bg-apple-bg', 'text-apple-secondary');
            });
            document.getElementById('sidebar-mode-parsed').classList.remove('bg-apple-bg', 'text-apple-secondary');
            document.getElementById('sidebar-mode-parsed').classList.add('bg-apple-blue', 'text-white', 'font-medium');

            renderSourceSidebar();
            lucide.createIcons();

            // Scroll to highlight after render
            // Use 'instant' behavior to avoid jarring scroll from top after render
            setTimeout(() => {
                const highlighted = document.querySelector('#source-sidebar-content .chunk-highlight');
                if (highlighted) {
                    highlighted.scrollIntoView({ behavior: 'instant', block: 'center' });
                }
            }, 100);
        }

        function setSidebarViewMode(mode) {
            sidebarViewMode = mode;
            document.querySelectorAll('.sidebar-mode-btn').forEach(btn => {
                btn.classList.remove('bg-apple-blue', 'text-white', 'font-medium');
                btn.classList.add('bg-apple-bg', 'text-apple-secondary');
            });
            const activeBtn = document.getElementById(`sidebar-mode-${mode}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-apple-bg', 'text-apple-secondary');
                activeBtn.classList.add('bg-apple-blue', 'text-white', 'font-medium');
            }
            renderSourceSidebar();
            lucide.createIcons();
        }

        function renderSourceSidebar() {
            const doc = allData.documents?.[sidebarDocId];
            const parsed = allData.parsed?.[sidebarDocId];
            const content = document.getElementById('source-sidebar-content');

            if (!parsed?.text) {
                content.innerHTML = '<p class="text-apple-secondary p-4">No parsed content available</p>';
                return;
            }

            const pages = parsed.text.split('\n\n--- PAGE BREAK ---\n\n');
            const totalPages = pages.length || 1;
            const safePage = Math.min(Math.max(1, sidebarPage), totalPages);
            const pageText = pages[safePage - 1] || '';

            // Update page indicator
            document.getElementById('source-sidebar-page').textContent = `Page ${safePage} of ${totalPages}`;

            // Update nav button states
            document.getElementById('sidebar-prev').classList.toggle('opacity-30', safePage <= 1);
            document.getElementById('sidebar-prev').classList.toggle('pointer-events-none', safePage <= 1);
            document.getElementById('sidebar-next').classList.toggle('opacity-30', safePage >= totalPages);
            document.getElementById('sidebar-next').classList.toggle('pointer-events-none', safePage >= totalPages);

            // Detect document type
            const filePath = doc?.file_path || '';
            const fileExt = filePath.toLowerCase().split('.').pop();
            const isPdf = fileExt === 'pdf';
            const isHtml = ['htm', 'html', 'xhtml'].includes(fileExt);

            // Show/hide highlight badge and fuzzy matching note
            const hasHighlight = highlightChunkText || (highlightChunkIdx && highlightChunkIdx.start !== null);
            document.getElementById('sidebar-highlight-badge').classList.toggle('hidden', !hasHighlight || sidebarViewMode !== 'parsed');

            // Show fuzzy matching note for HTML (since LangChain/LlamaIndex don't provide page numbers for HTML)
            const fuzzyNote = document.getElementById('sidebar-fuzzy-note');
            if (fuzzyNote) {
                fuzzyNote.classList.toggle('hidden', !isHtml || !hasHighlight || sidebarViewMode !== 'parsed');
            }

            if (sidebarViewMode === 'parsed') {
                // Render parsed text with highlighting (use char indices if available, fall back to fuzzy)
                content.innerHTML = `<pre class="text-xs whitespace-pre-wrap text-apple-text leading-relaxed p-4 h-full overflow-y-auto">${highlightTextInContent(pageText, highlightChunkText, highlightChunkIdx)}</pre>`;
            } else {
                // Render source document
                if (isPdf) {
                    const pdfUrl = `/api/files/${encodeURIComponent(filePath)}`;
                    content.innerHTML = '<div id="sidebar-pdf-viewer" class="flex-1 flex flex-col min-h-0"></div>';
                    // Render with PDF.js, highlighting the chunk text
                    renderPdfViewer('sidebar-pdf-viewer', pdfUrl, safePage, highlightChunkText, false);
                    // Show highlight badge for source view too when we have highlight text
                    document.getElementById('sidebar-highlight-badge').classList.toggle('hidden', !highlightChunkText);
                } else if (isHtml) {
                    // Render HTML in iframe with highlighting
                    const htmlUrl = `/api/files/${encodeURIComponent(filePath)}`;
                    content.innerHTML = `<iframe id="sidebar-html-iframe" src="${htmlUrl}" class="w-full h-full border-0 bg-white"></iframe>`;
                    // Try to highlight in iframe after load
                    if (highlightChunkText) {
                        const iframe = document.getElementById('sidebar-html-iframe');
                        iframe.onload = () => highlightTextInHtmlIframe(iframe, highlightChunkText);
                    }
                } else {
                    content.innerHTML = `<div class="flex items-center justify-center h-full text-apple-secondary"><p>No source document available</p></div>`;
                }
            }
        }

        function sidebarGoToPage(page) {
            const parsed = allData.parsed?.[sidebarDocId];
            if (!parsed?.text) return;
            const pages = parsed.text.split('\n\n--- PAGE BREAK ---\n\n');
            const totalPages = pages.length || 1;
            sidebarPage = Math.min(Math.max(1, page), totalPages);
            renderSourceSidebar();
        }

        function openFullDocumentView() {
            if (!sidebarDocId) return;
            const docId = sidebarDocId;
            const pageToOpen = sidebarPage;
            const textToHighlight = highlightChunkText;

            // Close sidebar but preserve values for navigation
            document.getElementById('source-sidebar').classList.add('hidden');

            // Navigate to Documents tab and open the document
            highlightChunkText = textToHighlight;
            currentPage = pageToOpen;
            showTab('documents');
            setTimeout(() => {
                openDocumentViewer(docId);
                setTimeout(() => setSimpleViewMode('parsed'), 100);
            }, 100);

            // Clear sidebar state after navigation
            sidebarDocId = null;
        }

        function closeSourceSidebar() {
            document.getElementById('source-sidebar').classList.add('hidden');
            sidebarDocId = null;
            highlightChunkText = null;
            highlightChunkIdx = null;
        }

        // ========== Requests (Unified Traces + Retrievals + LLM) ==========
        function getRequestItems() {
            const traces = Object.values(allData.traces || {});
            const retrievals = allData.retrievals || [];
            const llmCalls = allData.llm_calls || [];

            // Build request items: combine traces with their retrievals and LLM calls
            let items = traces.map(t => {
                const traceRetrievals = retrievals.filter(r => r.trace_id === t.trace_id);
                const traceLLMCalls = llmCalls.filter(l => l.trace_id === t.trace_id);
                const query = traceRetrievals[0]?.query;
                return {
                    type: 'trace',
                    id: t.trace_id,
                    trace: t,
                    retrievals: traceRetrievals,
                    llmCalls: traceLLMCalls,
                    query: query,
                    time: t.start_time
                };
            });

            // Add orphan retrievals (no trace_id) - pair with closest LLM call by timestamp
            const orphanRetrievals = retrievals.filter(r => !r.trace_id);
            orphanRetrievals.forEach((r, i) => {
                const retTime = new Date(r.timestamp || 0).getTime();
                const nearbyLLM = llmCalls.filter(l => {
                    if (l.trace_id) return false;
                    const llmTime = new Date(l.timestamp || 0).getTime();
                    return Math.abs(llmTime - retTime) < 30000;
                });
                items.push({
                    type: 'retrieval',
                    id: `ret-${i}`,
                    retrievals: [r],
                    llmCalls: nearbyLLM,
                    query: r.query,
                    time: r.timestamp
                });
            });

            // Sort by time, newest first
            items.sort((a, b) => new Date(b.time || 0) - new Date(a.time || 0));
            return items;
        }

        function updateTracesList() {
            const el = document.getElementById('requests-list');
            const items = getRequestItems();

            // Update count
            document.getElementById('requests-count-label').textContent = `${items.length} quer${items.length !== 1 ? 'ies' : 'y'}`;

            if (!items.length) {
                el.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-16 text-apple-tertiary">
                        <i data-lucide="message-circle" class="w-12 h-12 mb-3 opacity-40"></i>
                        <p class="text-sm">No queries yet</p>
                        <p class="text-xs mt-1 opacity-70">Run queries to see them here</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Paginate
            const totalPages = Math.ceil(items.length / PAGE_SIZE);
            if (queriesPage > totalPages) queriesPage = totalPages;
            const startIdx = (queriesPage - 1) * PAGE_SIZE;
            const paginatedItems = items.slice(startIdx, startIdx + PAGE_SIZE);

            el.innerHTML = `
                <table class="w-full">
                    <thead class="bg-apple-bg/50 border-b border-apple-border">
                        <tr class="text-xs text-apple-secondary uppercase tracking-wide">
                            <th class="text-left py-2 px-4 font-medium">Query</th>
                            <th class="text-left py-2 px-3 font-medium w-28">Time</th>
                            <th class="text-left py-2 px-3 font-medium w-20">Chunks</th>
                            <th class="text-left py-2 px-3 font-medium w-28">Model</th>
                            <th class="text-left py-2 px-3 font-medium w-20">Latency</th>
                            <th class="text-left py-2 px-3 font-medium w-32">Experiment</th>
                            <th class="w-16"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginatedItems.map(item => {
                            const hasLLM = item.llmCalls?.length > 0;
                            const llmModel = item.llmCalls?.[0]?.model || '';
                            const queryPreview = item.query ? (item.query.length > 60 ? item.query.slice(0, 60) + '...' : item.query) : (item.trace?.name || 'Query');
                            const chunkCount = item.retrievals?.[0]?.num_results || 0;
                            const latency = item.llmCalls?.[0]?.duration_ms;
                            const retrieval = item.retrievals?.[0];
                            const expId = retrieval?.experiment_id;
                            const expName = getExperimentName(expId);
                            const retrievalId = retrieval?.id;

                            return `
                            <tr class="border-b border-apple-border/50 cursor-pointer hover:bg-apple-bg/50 transition-colors group"
                                onclick="selectTrace('${item.id}')">
                                <td class="py-2.5 px-4">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="message-square" class="w-4 h-4 text-apple-blue flex-shrink-0"></i>
                                        <span class="text-sm text-apple-text truncate">${escapeHtml(queryPreview)}</span>
                                    </div>
                                </td>
                                <td class="py-2.5 px-3 text-xs text-apple-secondary">${formatTime(item.time)}</td>
                                <td class="py-2.5 px-3">
                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-apple-blue/10 text-apple-blue text-xs font-medium">${chunkCount || 0}</span>
                                </td>
                                <td class="py-2.5 px-3">
                                    ${hasLLM ? `
                                        <div class="flex items-center gap-1.5">
                                            ${getProviderLogo(llmModel)}
                                            <span class="text-xs text-apple-secondary font-mono">${llmModel.split('/').pop()}</span>
                                        </div>
                                    ` : '<span class="text-apple-tertiary text-xs">-</span>'}
                                </td>
                                <td class="py-2.5 px-3">
                                    ${latency ? `
                                        <div class="flex flex-col gap-1">
                                            <span class="text-xs font-medium ${getLatencyColor(latency)}">${formatLatency(latency)}</span>
                                            <div class="w-16 h-1 bg-apple-border/50 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r from-apple-green via-apple-orange to-apple-red rounded-full" style="width: ${getLatencyBarWidth(latency)}%"></div>
                                            </div>
                                        </div>
                                    ` : '<span class="text-apple-tertiary text-xs">-</span>'}
                                </td>
                                <td class="py-2.5 px-3">
                                    ${expName ? `<span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-violet-50 text-violet-700 dark:bg-violet-900/30 dark:text-violet-300"><i data-lucide="flask-conical" class="w-3 h-3"></i>${escapeHtml(expName)}</span>` : '<span class="text-apple-tertiary text-xs">-</span>'}
                                </td>
                                <td class="py-2.5 px-3 text-right">
                                    <div class="flex items-center justify-end gap-1">
                                        ${retrievalId ? `<button onclick="event.stopPropagation(); showAssignMenu(event, 'retrieval', '${retrievalId}', ${expId || 'null'})"
                                                class="p-1 rounded hover:bg-apple-border/50 opacity-0 group-hover:opacity-100 transition-opacity"
                                                title="Assign to experiment">
                                            <i data-lucide="tag" class="w-3.5 h-3.5 text-apple-secondary"></i>
                                        </button>` : ''}
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-apple-tertiary"></i>
                                    </div>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                ${renderPagination(items.length, queriesPage, PAGE_SIZE, 'setQueriesPage')}
            `;
            lucide.createIcons();
        }

        function selectTrace(id) {
            selectedTrace = id;
            // Show detail view, hide list view
            document.getElementById('requests-list-view').classList.add('hidden');
            document.getElementById('request-detail-view').classList.remove('hidden');
            showTraceDetail(id);
        }

        function closeRequestDetail() {
            selectedTrace = null;
            // Close source sidebar if open
            closeSourceSidebar();
            // Show list view, hide detail view
            document.getElementById('request-detail-view').classList.add('hidden');
            document.getElementById('requests-list-view').classList.remove('hidden');
        }

        function showTraceDetail(id) {
            const trace = allData.traces?.[id];
            const retrievals = allData.retrievals || [];
            const llmCalls = allData.llm_calls || [];

            // Handle orphan retrievals
            if (id.startsWith('ret-')) {
                const retIndex = parseInt(id.replace('ret-', ''));
                const orphanRets = retrievals.filter(r => !r.trace_id);
                const r = orphanRets[retIndex];
                if (r) {
                    // Find nearby LLM calls for orphan retrievals
                    const retTime = new Date(r.timestamp || 0).getTime();
                    const nearbyLLM = llmCalls.filter(l => {
                        if (l.trace_id) return false;
                        const llmTime = new Date(l.timestamp || 0).getTime();
                        return Math.abs(llmTime - retTime) < 30000;
                    });
                    showRequestDetail(r.query, [r], nearbyLLM, null);
                    return;
                }
            }

            if (!trace) return;

            const traceRetrievals = retrievals.filter(r => r.trace_id === id);
            const traceLLMCalls = llmCalls.filter(l => l.trace_id === id);
            const query = traceRetrievals[0]?.query || trace.name || 'Request';

            showRequestDetail(query, traceRetrievals, traceLLMCalls, trace);
        }

        function showRequestDetail(query, retrievalsList, llmCallsList, trace) {
            const traceName = query || trace?.name || 'Query';

            // Set header
            document.getElementById('request-detail-name').textContent = traceName.length > 80 ? traceName.slice(0, 80) + '...' : traceName;
            document.getElementById('request-detail-title').textContent = formatTime(trace?.start_time || retrievalsList[0]?.timestamp);

            // Get retrieval and LLM data
            const retrieval = retrievalsList[0];
            const llmCall = llmCallsList[0];
            const results = retrieval?.results || [];

            // Build clean HTML
            document.getElementById('request-detail-content').innerHTML = `
                <div class="p-6 space-y-6">
                    <!-- Query -->
                    <div class="bg-apple-card rounded-xl p-4 border border-apple-border shadow-sm card copy-parent">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <i data-lucide="search" class="w-4 h-4 text-violet-600"></i>
                                <p class="text-xs text-apple-secondary font-medium uppercase tracking-wide">Query</p>
                            </div>
                            <button onclick="copyToClipboard(decodeURIComponent('${encodeURIComponent(query || '')}'), this)"
                                    class="copy-btn flex items-center gap-1 text-xs text-apple-secondary hover:text-apple-text px-2 py-1 rounded hover:bg-apple-bg transition-colors">
                                <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                Copy
                            </button>
                        </div>
                        <p class="text-apple-text font-medium">"${escapeHtml(query || '')}"</p>
                    </div>

                    <!-- Retrieved Chunks (with pagination) -->
                    ${results.length ? `
                    <div class="bg-apple-card rounded-xl p-4 border border-apple-border shadow-sm card">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <i data-lucide="layers" class="w-4 h-4 text-amber-600"></i>
                                <p class="text-xs text-apple-secondary font-medium uppercase tracking-wide">Retrieved Chunks</p>
                            </div>
                            <span class="text-xs text-apple-secondary">${results.length} results${retrieval?.duration_ms ? ` Â· ${retrieval.duration_ms.toFixed(0)}ms` : ''}</span>
                        </div>
                        <div class="space-y-2" id="chunks-container">
                            ${results.slice(0, 10).map((res, i) => {
                                const chunk = allData.chunks?.[res.chunk_id];
                                const doc = chunk ? allData.documents?.[chunk.doc_id] : (res.doc_id ? allData.documents?.[res.doc_id] : null);
                                const docName = doc?.filename || res.doc_id || '';
                                const pageNum = chunk?.page_number || res.page_number;
                                return `
                                <div class="chunk-item bg-apple-bg/50 rounded-lg p-3 border border-apple-border/50 hover:border-apple-border transition-colors">
                                    <div class="flex items-center gap-2 mb-2 flex-wrap text-xs">
                                        <span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded font-medium">#${i + 1}</span>
                                        <span class="text-apple-tertiary">score: ${res.score?.toFixed(4)}</span>
                                        ${docName ? `<span class="text-apple-text flex items-center gap-1"><i data-lucide="file-text" class="w-3 h-3"></i>${docName}</span>` : ''}
                                        ${pageNum ? `<span class="text-apple-tertiary">p.${pageNum}</span>` : ''}
                                        ${chunk || res.doc_id ? `
                                        <button onclick="event.stopPropagation(); viewChunkSource('${res.chunk_id}', '${res.doc_id || ''}', ${res.page_number || 'null'}, decodeURIComponent('${encodeURIComponent(res.text || '')}'))"
                                                class="ml-auto text-xs text-apple-blue hover:underline flex items-center gap-1">
                                            <i data-lucide="eye" class="w-3 h-3"></i>
                                            View Source
                                        </button>
                                        ` : ''}
                                    </div>
                                    <p class="text-sm text-apple-secondary line-clamp-3">${escapeHtml(res.text || '')}</p>
                                </div>
                            `}).join('')}
                        </div>
                        ${results.length > 10 ? `
                        <button onclick="showMoreChunks(this, ${JSON.stringify(results).replace(/"/g, '&quot;')})"
                                class="mt-3 w-full py-2 text-xs text-apple-blue hover:text-apple-blue/80 flex items-center justify-center gap-1 border border-apple-border/50 rounded-lg hover:bg-apple-bg/50 transition-colors">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            Show ${results.length - 10} more chunks
                        </button>
                        ` : ''}
                    </div>
                    ` : ''}

                    <!-- Response (from retrieval if no LLM call) -->
                    ${!llmCall && retrieval?.response ? `
                    <div class="bg-apple-card rounded-xl p-4 border border-apple-border shadow-sm card copy-parent">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <i data-lucide="message-square" class="w-4 h-4 text-emerald-600"></i>
                                <p class="text-xs text-apple-secondary font-medium uppercase tracking-wide">Response</p>
                            </div>
                            <button onclick="copyToClipboard(decodeURIComponent('${encodeURIComponent(retrieval.response)}'), this)"
                                    class="copy-btn flex items-center gap-1 text-xs text-apple-secondary hover:text-apple-text px-2 py-1 rounded hover:bg-apple-bg transition-colors">
                                <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                Copy
                            </button>
                        </div>
                        <div class="bg-apple-bg rounded-lg p-4 border border-apple-border/50 code-block">
                            <pre class="text-sm text-apple-text whitespace-pre-wrap font-mono">${escapeHtml(retrieval.response)}</pre>
                        </div>
                    </div>
                    ` : ''}

                    <!-- LLM Call Details -->
                    ${llmCall ? `
                    <div class="bg-apple-card rounded-xl p-4 border border-apple-border shadow-sm card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                ${getProviderLogo(llmCall.model)}
                                <div>
                                    <p class="text-sm font-medium text-apple-text">${llmCall.model || 'Unknown Model'}</p>
                                    <p class="text-xs text-apple-secondary">LLM Call</p>
                                </div>
                            </div>
                            ${getStatusBadge(llmCall.status || 'success')}
                        </div>

                        <!-- LLM Stats Cards -->
                        <div class="grid grid-cols-4 gap-3 mb-4">
                            <div class="bg-apple-bg rounded-lg p-3 text-center">
                                <p class="text-lg font-semibold text-apple-text">${formatLatency(llmCall.duration_ms)}</p>
                                <p class="text-xs text-apple-secondary">Latency</p>
                            </div>
                            <div class="bg-apple-bg rounded-lg p-3 text-center">
                                <p class="text-lg font-semibold text-apple-blue">${llmCall.prompt_tokens || '-'}</p>
                                <p class="text-xs text-apple-secondary">Prompt</p>
                            </div>
                            <div class="bg-apple-bg rounded-lg p-3 text-center">
                                <p class="text-lg font-semibold text-apple-purple">${llmCall.completion_tokens || '-'}</p>
                                <p class="text-xs text-apple-secondary">Completion</p>
                            </div>
                            <div class="bg-apple-bg rounded-lg p-3 text-center">
                                <p class="text-lg font-semibold text-apple-text">${llmCall.total_tokens || '-'}</p>
                                <p class="text-xs text-apple-secondary">Total</p>
                            </div>
                        </div>

                        <!-- LLM Metadata Table -->
                        <div class="bg-apple-bg rounded-lg border border-apple-border/50 mb-4 overflow-hidden">
                            <table class="w-full text-xs">
                                <tbody class="divide-y divide-apple-border/50">
                                    <tr>
                                        <td class="px-3 py-2 text-apple-secondary w-32">Model</td>
                                        <td class="px-3 py-2 text-apple-text font-mono">${llmCall.model || 'unknown'}</td>
                                    </tr>
                                    ${llmCall.temperature !== undefined ? `
                                    <tr>
                                        <td class="px-3 py-2 text-apple-secondary">Temperature</td>
                                        <td class="px-3 py-2 text-apple-text font-mono">${llmCall.temperature}</td>
                                    </tr>
                                    ` : ''}
                                    ${llmCall.max_tokens ? `
                                    <tr>
                                        <td class="px-3 py-2 text-apple-secondary">Max Tokens</td>
                                        <td class="px-3 py-2 text-apple-text font-mono">${llmCall.max_tokens}</td>
                                    </tr>
                                    ` : ''}
                                    ${llmCall.finish_reason ? `
                                    <tr>
                                        <td class="px-3 py-2 text-apple-secondary">Finish Reason</td>
                                        <td class="px-3 py-2 text-apple-text font-mono">${llmCall.finish_reason}</td>
                                    </tr>
                                    ` : ''}
                                    ${llmCall.stop ? `
                                    <tr>
                                        <td class="px-3 py-2 text-apple-secondary">Stop Sequences</td>
                                        <td class="px-3 py-2 text-apple-text font-mono">${JSON.stringify(llmCall.stop)}</td>
                                    </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>

                        <!-- Tool/Function Calls -->
                        ${llmCall.tool_calls?.length ? `
                        <div class="mb-4">
                            <p class="text-xs text-apple-tertiary uppercase tracking-wide mb-2">Tool Calls</p>
                            <div class="space-y-2">
                                ${llmCall.tool_calls.map(tc => `
                                <div class="bg-apple-bg/50 rounded-lg p-3 border border-apple-border/50">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-medium text-apple-text">${tc.function?.name || tc.name || 'tool'}</span>
                                        <span class="text-xs text-apple-tertiary">${tc.type || 'function'}</span>
                                    </div>
                                    <pre class="text-xs text-apple-secondary font-mono overflow-x-auto">${escapeHtml(JSON.stringify(tc.function?.arguments || tc.arguments || {}, null, 2))}</pre>
                                </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${llmCall.function_call ? `
                        <div class="mb-4">
                            <p class="text-xs text-apple-tertiary uppercase tracking-wide mb-2">Function Call</p>
                            <div class="bg-apple-bg/50 rounded-lg p-3 border border-apple-border/50">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-medium text-apple-text">${llmCall.function_call.name}</span>
                                </div>
                                <pre class="text-xs text-apple-secondary font-mono overflow-x-auto">${escapeHtml(llmCall.function_call.arguments || '')}</pre>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Response -->
                        ${llmCall.response ? `
                        <div class="mb-4 copy-parent">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-xs text-apple-tertiary uppercase tracking-wide">Response</p>
                                <button onclick="copyToClipboard(decodeURIComponent('${encodeURIComponent(llmCall.response)}'), this)"
                                        class="copy-btn flex items-center gap-1 text-xs text-apple-secondary hover:text-apple-text px-2 py-1 rounded hover:bg-apple-bg transition-colors">
                                    <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                    Copy
                                </button>
                            </div>
                            <div class="bg-apple-card rounded-lg p-4 border border-apple-border/50 code-block">
                                <pre class="text-sm text-apple-text whitespace-pre-wrap font-mono">${escapeHtml(llmCall.response)}</pre>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Error -->
                        ${llmCall.error ? `
                        <div class="mb-4">
                            <p class="text-xs text-red-500 uppercase tracking-wide mb-2">Error</p>
                            <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                                <pre class="text-sm text-red-700 whitespace-pre-wrap">${escapeHtml(llmCall.error)}</pre>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    <!-- Prompt (collapsible) -->
                    ${llmCall?.messages || llmCall?.prompt ? `
                    <details class="group bg-white rounded-xl border border-apple-border shadow-sm">
                        <summary class="cursor-pointer px-4 py-3 flex items-center gap-2 hover:bg-apple-bg/30 transition-colors rounded-xl">
                            <i data-lucide="chevron-right" class="w-4 h-4 text-apple-secondary group-open:rotate-90 transition-transform"></i>
                            <i data-lucide="terminal" class="w-4 h-4 text-sky-600"></i>
                            <span class="text-xs text-apple-secondary font-medium uppercase tracking-wide">Input (Prompt/Messages)</span>
                        </summary>
                        <div class="px-4 pb-4 pt-2 border-t border-apple-border">
                            ${llmCall.messages ? `
                            <div class="space-y-3">
                                ${llmCall.messages.map(msg => `
                                    <div class="border-l-2 ${msg.role === 'user' ? 'border-sky-500' : msg.role === 'assistant' ? 'border-emerald-500' : msg.role === 'system' ? 'border-amber-500' : 'border-apple-border'} pl-3 py-1">
                                        <span class="text-xs font-medium ${msg.role === 'user' ? 'text-sky-600' : msg.role === 'assistant' ? 'text-emerald-600' : msg.role === 'system' ? 'text-amber-600' : 'text-apple-secondary'}">${msg.role}</span>
                                        <pre class="text-sm text-apple-text whitespace-pre-wrap mt-1">${escapeHtml(typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content, null, 2))}</pre>
                                    </div>
                                `).join('')}
                            </div>
                            ` : `<pre class="text-sm text-apple-text whitespace-pre-wrap">${escapeHtml(llmCall.prompt || '')}</pre>`}
                        </div>
                    </details>
                    ` : ''}

                </div>
            `;
            lucide.createIcons();
        }

        // ========== Recent Activity ==========
        function updateRecentActivity() {
            // Recent docs
            const docsEl = document.getElementById('recent-docs');
            const docs = Object.values(allData.documents || {}).slice(-5).reverse();

            if (!docs.length) {
                docsEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-6 text-apple-tertiary">
                        <i data-lucide="file-plus" class="w-8 h-8 mb-2 opacity-50"></i>
                        <p class="text-sm">No documents yet</p>
                    </div>
                `;
                lucide.createIcons();
            } else {
                docsEl.innerHTML = docs.map(d => `
                    <div class="flex items-center gap-3 p-3 bg-apple-bg rounded-lg cursor-pointer hover:bg-apple-border/30 transition-colors"
                         onclick="showTab('documents'); setTimeout(() => selectDocument('${d.doc_id}'), 100);">
                        <div class="w-8 h-8 bg-emerald-50 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i data-lucide="file-text" class="w-4 h-4 text-emerald-600"></i>
                        </div>
                        <span class="truncate flex-1 text-sm text-apple-text">${d.filename || 'Document'}</span>
                        <span class="text-xs text-apple-secondary">${d.num_pages || '?'} pages</span>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-apple-tertiary flex-shrink-0"></i>
                    </div>
                `).join('');
                lucide.createIcons();
            }

            // Recent queries (from retrievals)
            const retsEl = document.getElementById('recent-retrievals');
            const rets = (allData.retrievals || []).slice(-5).reverse();

            if (!rets.length) {
                retsEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-6 text-apple-tertiary">
                        <i data-lucide="search" class="w-8 h-8 mb-2 opacity-50"></i>
                        <p class="text-sm">No queries yet</p>
                    </div>
                `;
                lucide.createIcons();
            } else {
                retsEl.innerHTML = rets.map((r, i) => {
                    // Find associated trace or use orphan retrieval id
                    const traceId = r.trace_id || `ret-${(allData.retrievals?.length || 0) - 1 - i}`;
                    return `
                    <div class="flex items-center gap-3 p-3 bg-apple-bg rounded-lg cursor-pointer hover:bg-apple-border/30 transition-colors"
                         onclick="showTab('traces'); setTimeout(() => selectTrace('${traceId}'), 100);">
                        <div class="w-8 h-8 bg-violet-50 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i data-lucide="search" class="w-4 h-4 text-violet-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="truncate text-sm text-apple-text">"${r.query || ''}"</p>
                            <p class="text-xs text-apple-secondary mt-0.5">${r.num_results || 0} results Â· ${r.duration_ms?.toFixed(0) || '?'}ms</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-apple-tertiary flex-shrink-0"></i>
                    </div>
                `}).join('');
                lucide.createIcons();
            }
        }

        // ========== Utilities ==========
        function showTab(name) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${name}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const isActive = btn.dataset.tab === name;
                btn.classList.toggle('bg-black/5', isActive);
                btn.classList.toggle('text-apple-text', isActive);
                btn.classList.toggle('font-medium', isActive);
                btn.classList.toggle('text-apple-secondary', !isActive);
            });
        }

        function kindColor(kind) {
            const colors = { document: 'green', chunking: 'yellow', embedding: 'blue', retrieval: 'purple', llm: 'pink', query: 'cyan', indexing: 'blue' };
            return colors[kind] || 'gray';
        }

        function formatTime(t) {
            if (!t) return 'N/A';
            return new Date(t).toLocaleTimeString();
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function escapeForJs(text) {
            if (!text) return '';
            return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/\n/g, ' ').replace(/\r/g, '');
        }
    </script>
</body>
</html>
