"""
StackWeaver Secrets Management Commands

Provides CLI commands for managing environment secrets securely.
"""

import secrets as pysecrets
import string
from pathlib import Path

import click
from rich.panel import Panel
from rich.table import Table

from stackweaver.cli.ui_helpers import (
    EMOJI,
    console,
    show_error,
    show_info,
    show_step,
    show_step_success,
    show_success,
    show_tip,
    show_warning,
)


def generate_secure_secret(length: int = 32) -> str:
    """
    Generate a cryptographically secure random secret.

    Uses secrets module (CSPRNG) for high-quality random generation.

    Args:
        length: Length of the secret (default 32 characters)

    Returns:
        Secure random string
    """
    alphabet = string.ascii_letters + string.digits + "!@#$%^&*()-_=+[]{}|;:,.<>?"
    return "".join(pysecrets.choice(alphabet) for _ in range(length))


def validate_secret_strength(secret: str) -> tuple[bool, str]:
    """
    Validate the strength of a secret.

    Args:
        secret: The secret to validate

    Returns:
        Tuple of (is_valid, message)
    """
    if len(secret) < 16:
        return False, "Secret too short (minimum 16 characters)"

    if len(secret) < 32:
        return False, "Secret weak (recommended 32+ characters)"

    # Check character diversity
    has_lower = any(c.islower() for c in secret)
    has_upper = any(c.isupper() for c in secret)
    has_digit = any(c.isdigit() for c in secret)
    has_special = any(c in "!@#$%^&*()-_=+[]{}|;:,.<>?" for c in secret)

    diversity_count = sum([has_lower, has_upper, has_digit, has_special])

    if diversity_count < 3:
        return False, "Secret lacks character diversity (use mix of letters, numbers, symbols)"

    return True, "Secret strength: Good"


@click.group()
def secrets() -> None:
    """Manage secrets and environment variables securely."""
    pass


@secrets.command()
@click.option(
    "--force",
    is_flag=True,
    help="Overwrite existing env.example file",
)
def init(force: bool) -> None:
    """
    Initialize environment template with secure secret placeholders.

    Creates an env.example file with all required secrets marked with
    secure placeholders. Use 'secrets generate' to fill them in.

    Example:
        stackweaver secrets init
        cp env.example .env
        stackweaver secrets generate
    """
    console.print()
    show_step("Initializing secrets template...")

    env_example_path = Path("env.example")

    # Check if file exists
    if env_example_path.exists() and not force:
        show_warning(f"{env_example_path} already exists")
        show_tip("Use --force to overwrite")
        return

    # Create template
    template_content = """# StackWeaver Environment Variables
#
# SECURITY WARNING: Never commit this file with real values to Git!
# After copying to .env, run: stackweaver secrets generate
#
# Generated by: stackweaver secrets init

# =============================================================================
# DATABASE SECRETS
# =============================================================================

# PostgreSQL
POSTGRES_PASSWORD=<generate-secure-secret-32-chars>
POSTGRES_USER=postgres
POSTGRES_DB=postgres

# MySQL
MYSQL_ROOT_PASSWORD=<generate-secure-secret-32-chars>
MYSQL_PASSWORD=<generate-secure-secret-32-chars>
MYSQL_USER=mysql
MYSQL_DATABASE=mydb

# MongoDB
MONGO_INITDB_ROOT_PASSWORD=<generate-secure-secret-32-chars>
MONGO_INITDB_ROOT_USERNAME=admin
MONGO_INITDB_DATABASE=admin

# Redis (optional - uncomment if needed)
# REDIS_PASSWORD=<generate-secure-secret-32-chars>

# =============================================================================
# APPLICATION SECRETS
# =============================================================================

# JWT/Session Secrets
JWT_SECRET=<generate-secure-secret-32-chars>
SESSION_SECRET=<generate-secure-secret-32-chars>
API_KEY=<generate-secure-secret-32-chars>

# Encryption Keys
ENCRYPTION_KEY=<generate-secure-secret-32-chars>

# =============================================================================
# MESSAGE QUEUE SECRETS
# =============================================================================

# RabbitMQ
RABBITMQ_DEFAULT_PASS=<generate-secure-secret-32-chars>
RABBITMQ_DEFAULT_USER=admin

# =============================================================================
# SEARCH & ANALYTICS
# =============================================================================

# Elasticsearch
ELASTIC_PASSWORD=<generate-secure-secret-32-chars>

# =============================================================================
# STORAGE
# =============================================================================

# MinIO (S3-compatible)
MINIO_ROOT_PASSWORD=<generate-secure-secret-32-chars>
MINIO_ROOT_USER=minioadmin

# =============================================================================
# SECURITY NOTES
# =============================================================================
#
# 1. Copy this file: cp env.example .env
# 2. Generate secrets: stackweaver secrets generate
# 3. NEVER commit .env to Git (it's in .gitignore)
# 4. Use different secrets for each environment (dev, staging, prod)
# 5. Rotate secrets regularly (every 90 days recommended)
# 6. Store production secrets in a secure vault:
#    - AWS Secrets Manager
#    - HashiCorp Vault
#    - Azure Key Vault
#    - Google Secret Manager
#
# 7. For CI/CD, use environment-specific secrets:
#    - GitHub Secrets
#    - GitLab CI/CD Variables
#    - CircleCI Contexts
#
# =============================================================================
# QUICK START
# =============================================================================
#
# 1. cp env.example .env
# 2. stackweaver secrets generate
# 3. Review and customize .env values
# 4. stackweaver deploy
#
"""

    # Write template
    env_example_path.write_text(template_content, encoding="utf-8")

    show_step_success(f"Created {env_example_path}")
    console.print()

    # Show next steps
    panel = Panel(
        "[cyan]1.[/cyan] Copy template: [white]cp env.example .env[/white]\n"
        "[cyan]2.[/cyan] Generate secrets: [white]stackweaver secrets generate[/white]\n"
        "[cyan]3.[/cyan] Review and customize values in .env\n"
        "[cyan]4.[/cyan] Deploy: [white]stackweaver deploy[/white]",
        title=f"{EMOJI['sparkles']} Next Steps",
        border_style="green",
    )
    console.print(panel)
    console.print()

    show_tip("Never commit .env to Git! (it's in .gitignore)")


@secrets.command()
@click.option(
    "--dry-run",
    is_flag=True,
    help="Show what would be generated without writing",
)
@click.option(
    "--length",
    default=32,
    help="Length of generated secrets (default: 32)",
)
def generate(dry_run: bool, length: int) -> None:
    """
    Generate secure random secrets for all placeholders in .env file.

    Scans .env for placeholder values and replaces them with
    cryptographically secure random secrets.

    Example:
        stackweaver secrets generate
        stackweaver secrets generate --length 48
        stackweaver secrets generate --dry-run
    """
    console.print()
    show_step("Generating secure secrets...")

    env_path = Path(".env")

    if not env_path.exists():
        show_error(f"{env_path} not found")
        show_tip("Run: cp env.example .env")
        return

    # Read current .env
    content = env_path.read_text(encoding="utf-8")
    lines = content.split("\n")

    # Track changes
    generated_count = 0
    updated_lines = []

    for line in lines:
        # Skip comments and empty lines
        if line.strip().startswith("#") or not line.strip() or "=" not in line:
            updated_lines.append(line)
            continue

        # Check if line has a placeholder
        if "<generate-secure-secret" in line:
            key = line.split("=")[0].strip()
            secret = generate_secure_secret(length)
            updated_line = f"{key}={secret}"
            updated_lines.append(updated_line)
            generated_count += 1

            if dry_run:
                show_info(f"{key}: [dim]{secret[:8]}...[/dim]")
        else:
            updated_lines.append(line)

    if generated_count == 0:
        show_warning("No placeholders found to replace")
        show_tip("Placeholders should look like: <generate-secure-secret-32-chars>")
        return

    # Write updated content
    if not dry_run:
        env_path.write_text("\n".join(updated_lines), encoding="utf-8")
        show_step_success(f"Generated {generated_count} secure secrets")
    else:
        show_info(f"Would generate {generated_count} secrets (dry-run)")

    console.print()

    # Show security reminder
    panel = Panel(
        "[yellow]IMPORTANT SECURITY REMINDERS:[/yellow]\n\n"
        f"[cyan]{EMOJI['check']}[/cyan] .env file updated with secure secrets\n"
        f"[cyan]{EMOJI['check']}[/cyan] Never commit .env to Git\n"
        f"[cyan]{EMOJI['check']}[/cyan] Use different secrets per environment\n"
        f"[cyan]{EMOJI['check']}[/cyan] Rotate secrets every 90 days\n"
        f"[cyan]{EMOJI['check']}[/cyan] Store production secrets in a secure vault",
        title=f"{EMOJI['security']} Security",
        border_style="yellow",
    )
    console.print(panel)
    console.print()


@secrets.command()
def validate() -> None:
    """
    Validate strength of secrets in .env file.

    Checks all secrets for:
    - Minimum length (16+ chars)
    - Character diversity
    - Common patterns to avoid

    Example:
        stackweaver secrets validate
    """
    console.print()
    show_step("Validating secret strength...")

    env_path = Path(".env")

    if not env_path.exists():
        show_error(f"{env_path} not found")
        return

    # Read .env
    content = env_path.read_text(encoding="utf-8")
    lines = content.split("\n")

    # Track validation results
    results = []
    weak_count = 0
    placeholder_count = 0

    for line in lines:
        # Skip comments and empty lines
        if line.strip().startswith("#") or not line.strip() or "=" not in line:
            continue

        key, value = line.split("=", 1)
        key = key.strip()
        value = value.strip()

        # Check for placeholders
        if "<generate-secure-secret" in value:
            results.append((key, "PLACEHOLDER", "Not generated yet"))
            placeholder_count += 1
            continue

        # Skip non-secret values (usernames, domains, etc.)
        if not any(
            secret_key in key.upper()
            for secret_key in [
                "PASSWORD",
                "SECRET",
                "KEY",
                "TOKEN",
                "PASS",
            ]
        ):
            continue

        # Validate secret
        is_valid, message = validate_secret_strength(value)

        if is_valid:
            results.append((key, "GOOD", message))
        else:
            results.append((key, "WEAK", message))
            weak_count += 1

    # Display results table
    if results:
        table = Table(title=f"{EMOJI['security']} Secret Validation Results", show_header=True)
        table.add_column("Secret", style="cyan")
        table.add_column("Status", style="white")
        table.add_column("Details", style="white")

        for key, status, message in results:
            if status == "GOOD":
                status_display = f"[green]{EMOJI['check']} {status}[/green]"
            elif status == "WEAK":
                status_display = f"[red]{EMOJI['cross']} {status}[/red]"
            else:
                status_display = f"[yellow]{EMOJI['warning']} {status}[/yellow]"

            table.add_row(key, status_display, message)

        console.print(table)
        console.print()

    # Summary
    if placeholder_count > 0:
        show_warning(f"{placeholder_count} secrets not generated yet")
        show_tip("Run: stackweaver secrets generate")

    if weak_count > 0:
        show_error(f"{weak_count} weak secrets found")
        show_tip("Regenerate weak secrets with: stackweaver secrets generate")
    elif results and placeholder_count == 0:
        show_success("All secrets are strong!")


@secrets.command()
def check() -> None:
    """
    Check if required secrets are configured before deployment.

    Validates that all necessary environment variables are set
    and have non-placeholder values.

    Example:
        stackweaver secrets check
    """
    console.print()
    show_step("Checking required secrets...")

    env_path = Path(".env")

    if not env_path.exists():
        show_error(".env file not found")
        show_tip("Create from template: cp env.example .env")
        return

    # List of required secrets (common ones)
    required_secrets = [
        "POSTGRES_PASSWORD",
        "MYSQL_ROOT_PASSWORD",
        "JWT_SECRET",
    ]

    # Read .env
    env_vars = {}
    content = env_path.read_text(encoding="utf-8")

    for line in content.split("\n"):
        if line.strip() and not line.strip().startswith("#") and "=" in line:
            key, value = line.split("=", 1)
            env_vars[key.strip()] = value.strip()

    # Check each required secret
    missing = []
    placeholder = []

    for secret in required_secrets:
        if secret not in env_vars:
            missing.append(secret)
        elif "<generate-secure-secret" in env_vars[secret]:
            placeholder.append(secret)

    # Results
    if missing:
        show_error(f"Missing required secrets: {', '.join(missing)}")

    if placeholder:
        show_warning(f"Secrets not generated: {', '.join(placeholder)}")
        show_tip("Run: stackweaver secrets generate")

    if not missing and not placeholder:
        show_success("All required secrets are configured!")
    else:
        console.print()
        show_tip("Deployment may fail without all required secrets")
