# Generated by StackWeaver - The Autonomous System Integrator
# Project: {{ project_name }}
# Generated: {{ generation_date }}
# Do not edit this file manually - it will be overwritten

version: '3.8'

services:
{% for service in services %}
  {{ service.name }}:
    image: {{ service.docker_image }}
    container_name: {{ project_name }}_{{ service.name }}
    restart: unless-stopped
{% if service.env_vars %}
    environment:
{% for env_var in service.env_vars %}
      {{ env_var.key }}: {{ "${" ~ env_var.key ~ "}" }}
{% endfor %}
{% endif %}
{% if service.ports %}
    ports:
{% for port in service.ports %}
      - "{{ port }}:{{ port }}"
{% endfor %}
{% endif %}
{% if service.volumes %}
    volumes:
{% for volume in service.volumes %}
      - {{ volume.name }}:{{ volume.mount_path }}
{% endfor %}
{% endif %}
    networks:
      - stackweaver-network
{% if service.traefik_enabled %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.{{ service.name }}.rule=Host(`{{ service.name }}.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.{{ service.name }}.entrypoints=websecure"
      - "traefik.http.routers.{{ service.name }}.tls.certresolver=letsencrypt"
{% if service.ports %}
      - "traefik.http.services.{{ service.name }}.loadbalancer.server.port={{ service.ports[0] }}"
{% endif %}
{% endif %}
{% if service.dependencies %}
    depends_on:
{% for dep in service.dependencies %}
      - {{ dep }}
{% endfor %}
{% endif %}
{% if service.healthcheck %}
    healthcheck:
      test: {{ service.healthcheck.test }}
      interval: {{ service.healthcheck.interval | default('30s') }}
      timeout: {{ service.healthcheck.timeout | default('10s') }}
      retries: {{ service.healthcheck.retries | default(3) }}
      start_period: {{ service.healthcheck.start_period | default('40s') }}
{% endif %}
{% endfor %}
{% if volumes %}

volumes:
{% for volume in volumes %}
  {{ volume.name }}:
    driver: local
{% if volume.driver_opts %}
    driver_opts:
{% for key, value in volume.driver_opts.items() %}
      {{ key }}: {{ value }}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}

networks:
  stackweaver-network:
    driver: bridge
    name: {{ project_name }}_network
