"""Output Formatter -  Clean and format generated code"""

import re


class OutputFormatter:
    """Format AI-generated output"""
    
    @staticmethod
    def clean(raw_output: str) -> str:
        """
        Remove markdown code blocks and clean output
        
        Args:
            raw_output: Raw AI output
            
        Returns:
            Cleaned code
        """
        # Remove markdown code blocks
        output = re.sub(r'```\w*\n', '', raw_output)
        output = re.sub(r'```', '', output)
        
        # Remove trailing whitespace
        output = output.strip()
        
        return output
    
    @staticmethod
    def add_header(code: str, title: str, disclaimer: bool = True, tool_name: str = "PoCSmith") -> str:
        """
        Add header to generated code
        
        Args:
            code: Generated code
            title: Title for header (e.g., CVE ID)
            disclaimer: Include ethical use warning
            tool_name: Name of the tool (default: PoCSmith)
            
        Returns:
            Code with header
        """
        from core.config import ETHICAL_WARNING
        
        header = f"""#!/usr/bin/env python3
\"\"\"
{title}
Generated by {tool_name}
\"\"\"
"""
        
        if disclaimer:
            header += f"\n{ETHICAL_WARNING}\n"
        
        return header + "\n" + code
    
    @staticmethod
    def to_file(code: str, filename: str, add_shebang: bool = True):
        """
        Save code to file
        
        Args:
            code: Code to save
            filename: Output filename
            add_shebang: Add executable shebang
        """
        from pathlib import Path
        from core.config import OUTPUT_DIR
        
        # Ensure output directory exists
        OUTPUT_DIR.mkdir(parents=True, exist_ok=True)
        
        # Full path
        filepath = OUTPUT_DIR / filename
        
        # Write file
        with open(filepath, 'w') as f:
            f.write(code)
        
        # Make executable if has shebang
        if add_shebang and code.startswith('#!'):
            filepath.chmod(0o755)
        
        return filepath
