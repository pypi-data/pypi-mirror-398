name: Publish to PyPI

on:
  # Manual trigger with version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.2.1)'
        required: true
        type: string
      test_pypi:
        description: 'Publish to TestPyPI first'
        required: false
        type: boolean
        default: true

env:
  PYTHON_VERSION: "3.13"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        run: uv run pytest

      - name: Run linting
        run: uv run ruff check src/depswiz

      - name: Validate version matches
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          PYPROJECT_VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
          if [ "$PYPROJECT_VERSION" != "$INPUT_VERSION" ]; then
            echo "::error::Version mismatch! pyproject.toml has $PYPROJECT_VERSION but you specified $INPUT_VERSION"
            exit 1
          fi
          echo "Version validated: $PYPROJECT_VERSION"

  build:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Build package
        run: uv build

      - name: Verify package contents
        run: |
          echo "=== Built packages ==="
          ls -la dist/
          echo ""
          echo "=== Wheel contents ==="
          unzip -l dist/*.whl | head -50

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  publish-testpypi:
    if: ${{ inputs.test_pypi }}
    runs-on: ubuntu-latest
    needs: build
    environment: testpypi
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TESTPYPI_API_TOKEN }}

      - name: Test installation from TestPyPI
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          sleep 30  # Wait for TestPyPI to index the package
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ depswiz==$INPUT_VERSION
          depswiz --version

  publish-pypi:
    runs-on: ubuntu-latest
    needs: [build, publish-testpypi]
    # Run even if testpypi was skipped
    if: ${{ always() && needs.build.result == 'success' && (needs.publish-testpypi.result == 'success' || needs.publish-testpypi.result == 'skipped') }}
    environment: release
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

  create-release:
    runs-on: ubuntu-latest
    needs: publish-pypi
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Create and push tag
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$INPUT_VERSION" -m "Release v$INPUT_VERSION"
          git push origin "v$INPUT_VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          files: dist/*
          generate_release_notes: true
          draft: false
