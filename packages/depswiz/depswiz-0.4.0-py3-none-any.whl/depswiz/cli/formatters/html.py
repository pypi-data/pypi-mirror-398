"""HTML output formatter for depswiz."""

from html import escape

from depswiz import __version__
from depswiz.cli.formatters.base import OutputFormatter
from depswiz.core.models import AuditResult, CheckResult, LicenseResult, UpdateType

HTML_TEMPLATE = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <style>
        :root {{
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-color: #c9d1d9;
            --text-muted: #8b949e;
            --border-color: #30363d;
            --green: #3fb950;
            --yellow: #d29922;
            --orange: #db6d28;
            --red: #f85149;
            --blue: #58a6ff;
            --purple: #a371f7;
        }}
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
            margin: 0;
            padding: 20px;
        }}
        .container {{
            max-width: 1200px;
            margin: 0 auto;
        }}
        h1, h2, h3 {{
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
        }}
        h1 {{ color: var(--blue); }}
        .summary {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }}
        .stat-card {{
            background: var(--card-bg);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }}
        .stat-card .value {{
            font-size: 2em;
            font-weight: bold;
        }}
        .stat-card .label {{
            color: var(--text-muted);
            font-size: 0.9em;
        }}
        table {{
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }}
        th, td {{
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }}
        th {{
            background: var(--card-bg);
            font-weight: 600;
        }}
        tr:hover {{
            background: rgba(56, 139, 253, 0.1);
        }}
        .badge {{
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }}
        .badge-ok {{ background: rgba(63, 185, 80, 0.2); color: var(--green); }}
        .badge-patch {{ background: rgba(88, 166, 255, 0.2); color: var(--blue); }}
        .badge-minor {{ background: rgba(210, 153, 34, 0.2); color: var(--yellow); }}
        .badge-major {{ background: rgba(248, 81, 73, 0.2); color: var(--red); }}
        .badge-critical {{ background: rgba(248, 81, 73, 0.3); color: var(--red); }}
        .badge-high {{ background: rgba(219, 109, 40, 0.2); color: var(--orange); }}
        .badge-medium {{ background: rgba(210, 153, 34, 0.2); color: var(--yellow); }}
        .badge-low {{ background: rgba(88, 166, 255, 0.2); color: var(--blue); }}
        .timestamp {{
            color: var(--text-muted);
            font-size: 0.9em;
        }}
        .footer {{
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--text-muted);
            font-size: 0.9em;
        }}
    </style>
</head>
<body>
    <div class="container">
        {content}
        <div class="footer">
            Generated by depswiz v{version}
        </div>
    </div>
</body>
</html>"""


class HtmlFormatter(OutputFormatter):
    """HTML output formatter for reports."""

    def format_check_result(self, result: CheckResult, warn_breaking: bool = True) -> str:
        """Format a check result as HTML."""
        breakdown = result.update_breakdown

        content = f"""
        <h1>Dependency Check Report</h1>
        <p class="timestamp">Generated on {result.timestamp.strftime("%Y-%m-%d %H:%M:%S")}</p>

        <div class="summary">
            <div class="stat-card">
                <div class="value">{result.total_packages}</div>
                <div class="label">Total Packages</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color: var(--green)">{len(result.up_to_date_packages)}</div>
                <div class="label">Up to Date</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color: var(--yellow)">{len(result.outdated_packages)}</div>
                <div class="label">Outdated</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color: var(--red)">{breakdown[UpdateType.MAJOR]}</div>
                <div class="label">Major Updates</div>
            </div>
        </div>

        <h2>Packages</h2>
        <table>
            <thead>
                <tr>
                    <th>Package</th>
                    <th>Language</th>
                    <th>Constraint</th>
                    <th>Current</th>
                    <th>Latest</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
        """

        for pkg in result.packages:
            status_badge = self._get_update_badge(pkg.update_type, pkg.is_outdated)
            content += f"""
                <tr>
                    <td>{escape(pkg.display_name)}</td>
                    <td>{escape(pkg.language or "unknown")}</td>
                    <td>{escape(pkg.constraint or "-")}</td>
                    <td>{escape(pkg.current_version or "?")}</td>
                    <td>{escape(pkg.latest_version or "?")}</td>
                    <td>{status_badge}</td>
                </tr>
            """

        content += """
            </tbody>
        </table>
        """

        return HTML_TEMPLATE.format(
            title="Dependency Check Report - depswiz",
            content=content,
            version=__version__,
        )

    def _get_update_badge(self, update_type: UpdateType | None, is_outdated: bool) -> str:
        """Get HTML badge for update status."""
        if not is_outdated:
            return '<span class="badge badge-ok">OK</span>'

        badge_classes = {
            UpdateType.PATCH: "badge-patch",
            UpdateType.MINOR: "badge-minor",
            UpdateType.MAJOR: "badge-major",
        }

        if update_type:
            cls = badge_classes.get(update_type, "")
            return f'<span class="badge {cls}">{update_type.value}</span>'

        return '<span class="badge badge-minor">update</span>'

    def format_audit_result(self, result: AuditResult, show_fix: bool = False) -> str:
        """Format an audit result as HTML."""
        content = f"""
        <h1>Security Audit Report</h1>
        <p class="timestamp">Generated on {result.timestamp.strftime("%Y-%m-%d %H:%M:%S")}</p>

        <div class="summary">
            <div class="stat-card">
                <div class="value">{len(result.packages)}</div>
                <div class="label">Packages Scanned</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color: var(--red)">{result.total_vulnerabilities}</div>
                <div class="label">Vulnerabilities</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color: var(--red)">{result.critical_count}</div>
                <div class="label">Critical</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color: var(--orange)">{result.high_count}</div>
                <div class="label">High</div>
            </div>
        </div>
        """

        if result.vulnerabilities:
            content += """
            <h2>Vulnerabilities</h2>
            <table>
                <thead>
                    <tr>
                        <th>Package</th>
                        <th>Version</th>
                        <th>Severity</th>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Fixed In</th>
                    </tr>
                </thead>
                <tbody>
            """

            for pkg, vuln in result.vulnerabilities:
                severity_badge = f'<span class="badge badge-{vuln.severity.value}">{vuln.severity.value.upper()}</span>'
                content += f"""
                    <tr>
                        <td>{escape(pkg.name)}</td>
                        <td>{escape(pkg.current_version or "?")}</td>
                        <td>{severity_badge}</td>
                        <td>{escape(vuln.id)}</td>
                        <td>{escape(vuln.title[:60] + "..." if len(vuln.title) > 60 else vuln.title)}</td>
                        <td>{escape(vuln.fixed_version or "-")}</td>
                    </tr>
                """

            content += """
                </tbody>
            </table>
            """
        else:
            content += '<p style="color: var(--green)">No vulnerabilities found.</p>'

        return HTML_TEMPLATE.format(
            title="Security Audit Report - depswiz",
            content=content,
            version=__version__,
        )

    def format_license_result(self, result: LicenseResult, summary_only: bool = False) -> str:
        """Format a license result as HTML."""
        content = f"""
        <h1>License Compliance Report</h1>
        <p class="timestamp">Generated on {result.timestamp.strftime("%Y-%m-%d %H:%M:%S")}</p>

        <div class="summary">
            <div class="stat-card">
                <div class="value">{len(result.packages)}</div>
                <div class="label">Packages</div>
            </div>
            <div class="stat-card">
                <div class="value">{len(result.license_summary)}</div>
                <div class="label">Unique Licenses</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color: var(--red)">{len(result.violations)}</div>
                <div class="label">Violations</div>
            </div>
            <div class="stat-card">
                <div class="value" style="color: var(--yellow)">{len(result.warnings)}</div>
                <div class="label">Warnings</div>
            </div>
        </div>

        <h2>License Summary</h2>
        <table>
            <thead>
                <tr>
                    <th>License</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody>
        """

        for lic_id, count in sorted(result.license_summary.items(), key=lambda x: -x[1]):
            content += f"""
                <tr>
                    <td>{escape(lic_id)}</td>
                    <td>{count}</td>
                </tr>
            """

        content += """
            </tbody>
        </table>
        """

        if result.violations:
            content += """
            <h2 style="color: var(--red)">Violations</h2>
            <ul>
            """
            for pkg, reason in result.violations:
                content += f"<li><strong>{escape(pkg.name)}</strong>: {escape(reason)}</li>"
            content += "</ul>"

        if not summary_only:
            content += """
            <h2>All Packages</h2>
            <table>
                <thead>
                    <tr>
                        <th>Package</th>
                        <th>Version</th>
                        <th>License</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody>
            """

            for pkg in result.packages:
                license_id = (pkg.license_info.spdx_id if pkg.license_info else None) or "UNKNOWN"
                category = pkg.license_info.category.value if pkg.license_info else "unknown"
                content += f"""
                    <tr>
                        <td>{escape(pkg.name)}</td>
                        <td>{escape(pkg.current_version or "?")}</td>
                        <td>{escape(license_id)}</td>
                        <td>{escape(category)}</td>
                    </tr>
                """

            content += """
                </tbody>
            </table>
            """

        return HTML_TEMPLATE.format(
            title="License Compliance Report - depswiz",
            content=content,
            version=__version__,
        )
