"""Markdown output formatter for depswiz."""

from depswiz import __version__
from depswiz.cli.formatters.base import OutputFormatter
from depswiz.core.models import AuditResult, CheckResult, LicenseResult, UpdateType


class MarkdownFormatter(OutputFormatter):
    """Markdown output formatter for documentation and PRs."""

    def format_check_result(self, result: CheckResult, warn_breaking: bool = True) -> str:
        """Format a check result as Markdown."""
        lines = [
            "# Dependency Report",
            "",
            f"Generated by depswiz v{__version__} on {result.timestamp.strftime('%Y-%m-%d')}",
            "",
            "## Summary",
            "",
            "| Metric | Value |",
            "|--------|-------|",
            f"| Total Packages | {result.total_packages} |",
            f"| Outdated | {len(result.outdated_packages)} |",
            f"| Up to Date | {len(result.up_to_date_packages)} |",
            "",
        ]

        # Update breakdown
        breakdown = result.update_breakdown
        if any(breakdown.values()):
            lines.extend(
                [
                    "### Update Types",
                    "",
                    "| Type | Count |",
                    "|------|-------|",
                ]
            )
            for ut in [UpdateType.MAJOR, UpdateType.MINOR, UpdateType.PATCH]:
                if breakdown[ut]:
                    lines.append(f"| {ut.value.title()} | {breakdown[ut]} |")
            lines.append("")

        # Outdated packages
        outdated = result.outdated_packages
        if outdated:
            lines.extend(
                [
                    "## Outdated Packages",
                    "",
                    "| Package | Current | Latest | Type |",
                    "|---------|---------|--------|------|",
                ]
            )
            for pkg in outdated:
                update_type = pkg.update_type.value if pkg.update_type else "unknown"
                lines.append(
                    f"| {pkg.display_name} | {pkg.current_version or '?'} | "
                    f"{pkg.latest_version or '?'} | {update_type} |"
                )
            lines.append("")

        # Up to date packages (collapsed)
        up_to_date = result.up_to_date_packages
        if up_to_date:
            lines.extend(
                [
                    "<details>",
                    "<summary>Up to Date Packages</summary>",
                    "",
                    "| Package | Version |",
                    "|---------|---------|",
                ]
            )
            for pkg in up_to_date:
                lines.append(f"| {pkg.display_name} | {pkg.current_version or '?'} |")
            lines.extend(["", "</details>", ""])

        return "\n".join(lines)

    def format_audit_result(self, result: AuditResult, show_fix: bool = False) -> str:
        """Format an audit result as Markdown."""
        lines = [
            "# Security Audit Report",
            "",
            f"Generated by depswiz v{__version__} on {result.timestamp.strftime('%Y-%m-%d')}",
            "",
            "## Summary",
            "",
        ]

        if not result.vulnerabilities:
            lines.append("**No vulnerabilities found.**")
            return "\n".join(lines)

        lines.extend(
            [
                f"**{result.total_vulnerabilities} vulnerabilities found**",
                "",
                "| Severity | Count |",
                "|----------|-------|",
                f"| Critical | {result.critical_count} |",
                f"| High | {result.high_count} |",
                f"| Medium | {result.medium_count} |",
                f"| Low | {result.low_count} |",
                "",
                "## Vulnerabilities",
                "",
            ]
        )

        for pkg, vuln in result.vulnerabilities:
            severity_badge = self._severity_badge(vuln.severity.value)
            lines.extend(
                [
                    f"### {vuln.id} - {pkg.name}",
                    "",
                    f"**Severity:** {severity_badge}",
                    f"**Package:** {pkg.name} @ {pkg.current_version or '?'}",
                    "",
                    f"> {vuln.title}",
                    "",
                ]
            )

            if vuln.fixed_version:
                lines.append(f"**Fixed in:** {vuln.fixed_version}")
                lines.append("")

            if vuln.references:
                lines.append("**References:**")
                for ref in vuln.references[:3]:  # Limit to 3 references
                    lines.append(f"- {ref}")
                lines.append("")

        # Recommendations
        if show_fix:
            lines.extend(
                [
                    "## Recommendations",
                    "",
                ]
            )
            for pkg, vuln in result.vulnerabilities:
                if vuln.fixed_version:
                    lines.append(f"- **{pkg.name}**: upgrade to `>= {vuln.fixed_version}`")
            lines.append("")

        return "\n".join(lines)

    def _severity_badge(self, severity: str) -> str:
        """Create a text badge for severity."""
        badges = {
            "critical": "![Critical](https://img.shields.io/badge/severity-critical-red)",
            "high": "![High](https://img.shields.io/badge/severity-high-orange)",
            "medium": "![Medium](https://img.shields.io/badge/severity-medium-yellow)",
            "low": "![Low](https://img.shields.io/badge/severity-low-blue)",
        }
        return badges.get(severity.lower(), severity)

    def format_license_result(self, result: LicenseResult, summary_only: bool = False) -> str:
        """Format a license result as Markdown."""
        lines = [
            "# License Compliance Report",
            "",
            f"Generated by depswiz v{__version__} on {result.timestamp.strftime('%Y-%m-%d')}",
            "",
            "## Summary",
            "",
            "| License | Count |",
            "|---------|-------|",
        ]

        for lic_id, count in sorted(result.license_summary.items(), key=lambda x: -x[1]):
            lines.append(f"| {lic_id} | {count} |")

        lines.append("")

        # Violations
        if result.violations:
            lines.extend(
                [
                    "## Violations",
                    "",
                ]
            )
            for pkg, reason in result.violations:
                lines.append(f"- **{pkg.name}**: {reason}")
            lines.append("")

        # Warnings
        if result.warnings:
            lines.extend(
                [
                    "## Warnings",
                    "",
                ]
            )
            for pkg, reason in result.warnings:
                lines.append(f"- **{pkg.name}**: {reason}")
            lines.append("")

        if not summary_only:
            lines.extend(
                [
                    "## All Packages",
                    "",
                    "| Package | Version | License | Category |",
                    "|---------|---------|---------|----------|",
                ]
            )
            for pkg in result.packages:
                license_id = (pkg.license_info.spdx_id if pkg.license_info else None) or "UNKNOWN"
                category = pkg.license_info.category.value if pkg.license_info else "unknown"
                lines.append(
                    f"| {pkg.name} | {pkg.current_version or '?'} | {license_id} | {category} |"
                )
            lines.append("")

        return "\n".join(lines)
