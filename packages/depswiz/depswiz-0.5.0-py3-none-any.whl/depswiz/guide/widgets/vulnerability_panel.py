"""Vulnerability panel widget for the guide dashboard."""

from __future__ import annotations

from typing import TYPE_CHECKING

from rich.panel import Panel
from rich.table import Table
from textual.reactive import reactive
from textual.widget import Widget

if TYPE_CHECKING:
    from depswiz.core.models import AuditResult


class VulnerabilityPanel(Widget):
    """Panel showing vulnerability counts by severity."""

    critical_count: reactive[int] = reactive(0)
    high_count: reactive[int] = reactive(0)
    medium_count: reactive[int] = reactive(0)
    low_count: reactive[int] = reactive(0)
    is_loading: reactive[bool] = reactive(False)

    def render(self) -> Panel:
        """Render the vulnerability panel."""
        if self.is_loading:
            return Panel("[italic]Scanning...[/italic]", title="Vulnerabilities")

        table = Table(box=None, show_header=False, padding=(0, 1))
        table.add_column("Count", style="bold", width=3, justify="right")
        table.add_column("Severity")

        # Add rows with appropriate colors
        if self.critical_count > 0:
            table.add_row(str(self.critical_count), "[red bold]Critical[/red bold]")
        else:
            table.add_row("[dim]0[/dim]", "[dim]Critical[/dim]")

        if self.high_count > 0:
            table.add_row(str(self.high_count), "[orange1]High[/orange1]")
        else:
            table.add_row("[dim]0[/dim]", "[dim]High[/dim]")

        if self.medium_count > 0:
            table.add_row(str(self.medium_count), "[yellow]Medium[/yellow]")
        else:
            table.add_row("[dim]0[/dim]", "[dim]Medium[/dim]")

        if self.low_count > 0:
            table.add_row(str(self.low_count), "[blue]Low[/blue]")
        else:
            table.add_row("[dim]0[/dim]", "[dim]Low[/dim]")

        total = self.critical_count + self.high_count + self.medium_count + self.low_count
        border_style = "red" if self.critical_count > 0 else ("yellow" if total > 0 else "green")

        return Panel(
            table,
            title=f"Vulnerabilities ({total})",
            border_style=border_style,
        )

    def update_from_result(self, result: AuditResult | None) -> None:
        """Update counts from an AuditResult."""
        if result:
            self.critical_count = result.critical_count
            self.high_count = result.high_count
            self.medium_count = result.medium_count
            self.low_count = result.low_count
        else:
            self.critical_count = 0
            self.high_count = 0
            self.medium_count = 0
            self.low_count = 0
