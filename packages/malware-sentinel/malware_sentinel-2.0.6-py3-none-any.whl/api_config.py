import os
import pickle
from getpass import getpass
from colorama import Fore

# Path to store the pickled API key
API_KEY_FILE = "data/api_key.pkl"

def get_api_key():
    if os.path.exists(API_KEY_FILE):
        try:
            with open(API_KEY_FILE, 'rb') as f:
                api_key = pickle.load(f)
            print(Fore.GREEN + "API key loaded from saved file.")
        except (pickle.UnpicklingError, EOFError) as e:
            print(Fore.RED + f"Error loading API key from file: {e}")
            print(Fore.YELLOW + "Please re-enter the API key.")
            api_key = getpass(Fore.CYAN + "Please enter your VirusTotal API key: ").strip()
            save_api_key(api_key)
    else:
        print(Fore.YELLOW + "No saved API key found.")
        api_key = getpass(Fore.CYAN + "Please enter your VirusTotal API key: ").strip()
        save_api_key(api_key)
        
    return api_key


def save_api_key(api_key):
    try:
        os.makedirs(os.path.dirname(API_KEY_FILE), exist_ok=True)
        with open(API_KEY_FILE, 'wb') as f:
            pickle.dump(api_key, f)
        print(Fore.GREEN + "API key saved for future use.")
    except Exception as e:
        print(Fore.RED + f"Error saving API key: {e}")
