import os
import pickle
from colorama import Fore, Style

API_KEY_FILE = os.path.join(os.path.dirname(__file__), 'data', 'api_key.pkl')

def get_api_key():
    api_key = None
    
    # Try to load API key from file
    if os.path.exists(API_KEY_FILE):
        try:
            with open(API_KEY_FILE, 'rb') as f:
                api_key = pickle.load(f)
            print(Fore.GREEN + "API key loaded from saved file.")
        except Exception as e:
            print(Fore.RED + f"Error loading API key: {e}")
            api_key = None

    # If key not loaded or invalid, prompt user
    if not api_key or not isinstance(api_key, str) or len(api_key) != 64:
        print(Fore.YELLOW + "VirusTotal API key is required.")
        api_key = input(Fore.CYAN + "Enter your VirusTotal API key (64 characters): ").strip()
        
        if len(api_key) == 64:
            try:
                os.makedirs(os.path.dirname(API_KEY_FILE), exist_ok=True)
                with open(API_KEY_FILE, 'wb') as f:
                    pickle.dump(api_key, f)
                print(Fore.GREEN + "API key saved for future use.")
            except Exception as e:
                print(Fore.RED + f"Error saving API key: {e}")
        else:
            print(Fore.RED + "Invalid API key length. It must be 64 characters.")
            return None
            
    return api_key