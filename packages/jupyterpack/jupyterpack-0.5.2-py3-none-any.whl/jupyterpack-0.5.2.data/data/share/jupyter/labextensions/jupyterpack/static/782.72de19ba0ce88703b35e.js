"use strict";(self.webpackChunkjupyterpack=self.webpackChunkjupyterpack||[]).push([[782],{782:(e,t,n)=>{n.r(t),n.d(t,{default:()=>G});var s,a,o=n(176),r=n(262),i=n(247),c=n(292);class l extends i.Widget{constructor(){super(),this.addClass("jupyterpack-iframe-panel"),this._iframe=document.createElement("iframe"),this._spinner=document.createElement("div"),this._spinner.classList.add("jupyterpack-spinner"),this.node.appendChild(this._spinner),this.node.appendChild(this._iframe)}toggleSpinner(e){this._spinner.style.display=e?"unset":"none"}}class d extends l{constructor(e){super(),this._isReady=new r.PromiseDelegate,this._model=e.model,this._model.initialize().then(e=>{if(!e.success)return this.toggleSpinner(!1),void(this._iframe.contentDocument.body.innerText=`Failed to start server: ${e.error}`);this._isReady.resolve();const t=this._iframe,n=c.PageConfig.getOption("fullLabextensionsUrl"),s=c.URLExt.join(n,"jupyterpack/static",e.instanceId,e.framework,e.kernelClientId,e.rootUrl);t.src=s,t.addEventListener("load",()=>{this.toggleSpinner(!1)}),this._model.serverReloaded.connect(()=>{var e,t,n;null===(n=null===(t=null===(e=this._iframe)||void 0===e?void 0:e.contentWindow)||void 0===t?void 0:t.location)||void 0===n||n.reload()})})}get autoreload(){return this._model.autoreload}set autoreload(e){this._model.autoreload=e}get isReady(){return this._isReady.promise}get model(){return this._model}async reload(){await this._model.reload()}dispose(){this._model.dispose()}}!function(e){e.REACT="react",e.DASH="dash",e.STREAMLIT="streamlit",e.TORNADO="tornado",e.SHINY="shiny",e.STARLETTE="starlette"}(s||(s={})),function(e){e.INIT="INIT"}(a||(a={}));var h=n(409);const p=!!document.getElementById("jupyter-lite-main"),u=new h.LabIcon({name:"jupyterpack:logo",svgstr:'<?xml version="1.0" encoding="utf-8"?>\r\n<svg width="800px" height="800px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\r\n  <path\r\n    d="M17.5777 4.43152L15.5777 3.38197C13.8221 2.46066 12.9443 2 12 2C11.0557 2 10.1779 2.46066 8.42229 3.38197L6.42229 4.43152C4.64855 5.36234 3.6059 5.9095 2.95969 6.64132L12 11.1615L21.0403 6.64132C20.3941 5.9095 19.3515 5.36234 17.5777 4.43152Z"\r\n    fill="var(--jp-inverse-layout-color3)" />\r\n  <path\r\n    d="M21.7484 7.96435L12.75 12.4635V21.904C13.4679 21.7252 14.2848 21.2965 15.5777 20.618L17.5777 19.5685C19.7294 18.4393 20.8052 17.8748 21.4026 16.8603C22 15.8458 22 14.5833 22 12.0585V11.9415C22 10.0489 22 8.86558 21.7484 7.96435Z"\r\n    fill="var(--jp-inverse-layout-color3)" />\r\n  <path\r\n    d="M11.25 21.904V12.4635L2.25164 7.96434C2 8.86557 2 10.0489 2 11.9415V12.0585C2 14.5833 2 15.8458 2.5974 16.8603C3.19479 17.8748 4.27063 18.4393 6.42229 19.5685L8.42229 20.618C9.71524 21.2965 10.5321 21.7252 11.25 21.904Z"\r\n    fill="var(--jp-inverse-layout-color3)" />\r\n</svg>'}),_=new h.LabIcon({name:"jupyterpack:autoReload",svgstr:'<?xml version="1.0" encoding="utf-8"?>\r\n\r\n<svg height="800px" width="800px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">\r\n\t<g>\r\n\t\t<path d="M403.925,108.102c-27.595-27.595-62.899-47.558-102.459-56.29L304.182,0L201.946,53.867l-27.306,14.454\r\n\t\tl-5.066,2.654l8.076,4.331l38.16,20.542l81.029,43.602l2.277-42.859c28.265,7.546,53.438,22.53,73.623,42.638\r\n\t\tc29.94,29.939,48.358,71.119,48.358,116.776c0,23.407-4.843,45.58-13.575,65.687l40.37,17.532\r\n\t\tc11.076-25.463,17.242-53.637,17.242-83.219C465.212,198.306,441.727,145.904,403.925,108.102z"\r\n\t\t\tfill="var(--jp-inverse-layout-color3)" />\r\n\t\t<path d="M296.256,416.151l-81.101-43.612l-2.272,42.869c-28.26-7.555-53.51-22.53-73.618-42.636\r\n\t\tc-29.945-29.95-48.364-71.12-48.364-116.767c0-23.427,4.844-45.522,13.576-65.697l-40.37-17.531\r\n\t\tc-11.076,25.53-17.242,53.723-17.242,83.228c0,57.679,23.407,110.157,61.21,147.893c27.595,27.594,62.899,47.548,102.453,56.202\r\n\t\tl-2.716,51.9l102.169-53.878l27.455-14.454l4.988-2.643l-7.999-4.332L296.256,416.151z"\r\n\t\t\tfill="var(--jp-inverse-layout-color3)" />\r\n\t</g>\r\n</svg>'}),m=new h.LabIcon({name:"jupyterpack:externalLink",svgstr:'<?xml version="1.0" encoding="utf-8"?>\r\n\r\n\r\n<svg width="800px" height="800px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\r\n  <g>\r\n    <path id="Vector"\r\n      d="M10.0002 5H8.2002C7.08009 5 6.51962 5 6.0918 5.21799C5.71547 5.40973 5.40973 5.71547 5.21799 6.0918C5 6.51962 5 7.08009 5 8.2002V15.8002C5 16.9203 5 17.4801 5.21799 17.9079C5.40973 18.2842 5.71547 18.5905 6.0918 18.7822C6.5192 19 7.07899 19 8.19691 19H15.8031C16.921 19 17.48 19 17.9074 18.7822C18.2837 18.5905 18.5905 18.2839 18.7822 17.9076C19 17.4802 19 16.921 19 15.8031V14M20 9V4M20 4H15M20 4L13 11"\r\n      stroke="var(--jp-inverse-layout-color3)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />\r\n  </g>\r\n</svg>'});function g(e){let t="";const n=new Uint8Array(e);for(let e=0;e<n.length;e+=32768){const s=n.subarray(e,e+32768);t+=String.fromCharCode(...s)}return btoa(t)}function v(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}function w(e){return e?`"${e}"`:"None"}var y=n(291),k=n.n(y);class f{constructor(e){this._isDisposed=!1,this._sessionConnection=e.sessionConnection}get isDisposed(){return this._isDisposed}async executeCode(e,t){var n;const s=null===(n=this._sessionConnection)||void 0===n?void 0:n.kernel;if(!s)throw new Error("Session has no kernel.");return new Promise((n,a)=>{const o=s.requestExecute(e,!1,void 0);let r="";o.onIOPub=s=>{switch(s.header.msg_type){case"execute_result":if(t){const e=s.content.data["text/plain"];r+=e,n(r)}break;case"stream":{const e=s.content;if(0===e.text.length)break;"stderr"===e.name?console.error("Kernel stream:",e.text):console.log("Kernel stream:",e.text);break}case"error":console.error("Kernel operation failed",e.code,s.content.traceback.map(e=>k()(e)).join("\n")),a(s.content)}},t||n(null)})}dispose(){this._isDisposed||(this._isDisposed=!0,this._sessionConnection.dispose())}}class C{constructor(e){this._openedWebsockets=[],this._server_var="__jupyterpack_python_server",this._isDisposed=!1,this._kernelExecutor=new f(e),this._wsPatch="\"use strict\";\n(() => {\n    const urlPath = new URL(window.location.href).pathname;\n    const pathAfterExtensionName = urlPath.split('/jupyterpack/static')[1];\n    const pathList = pathAfterExtensionName === null || pathAfterExtensionName === void 0 ? void 0 : pathAfterExtensionName.split('/').filter(Boolean);\n    const instanceId = pathList === null || pathList === void 0 ? void 0 : pathList[0];\n    const kernelClientId = pathList === null || pathList === void 0 ? void 0 : pathList[2];\n    if (!instanceId || !kernelClientId) {\n        throw new Error('Missing instance Id or kernelClient Id');\n    }\n    const sendTypedMessage = (msg) => {\n        bcWsChannel.postMessage({ ...msg, dest: kernelClientId });\n    };\n    function base64ToBinary(base64, dataType) {\n        const binary = atob(base64); // decode base64\n        const len = binary.length;\n        const bytes = new Uint8Array(len);\n        for (let i = 0; i < len; i++) {\n            bytes[i] = binary.charCodeAt(i);\n        }\n        if (dataType === 'arraybuffer') {\n            return bytes.buffer;\n        }\n        else if (dataType === 'blob') {\n            return new Blob([bytes], { type: 'application/octet-stream' });\n        }\n        else {\n            throw new Error(\"Unsupported type: use 'arraybuffer' or 'blob'\");\n        }\n    }\n    const decodeServerMessage = (payload, binaryType) => {\n        const { data, isBinary } = payload;\n        if (isBinary) {\n            // Decode base64 string to array buffer or blob\n            return base64ToBinary(data, binaryType);\n        }\n        return data;\n    };\n    const bcWsChannel = new BroadcastChannel(`/jupyterpack/ws/${instanceId}/${kernelClientId}`);\n    class BroadcastChannelWebSocket {\n        constructor(url, protocols) {\n            this.onclose = () => {\n                // no-op\n            };\n            this.onerror = () => {\n                // no-op\n            };\n            this.onmessage = () => {\n                // no-op\n            };\n            this.onopen = () => {\n                // no-op\n            };\n            this.CONNECTING = 0;\n            this.OPEN = 1;\n            this.CLOSING = 2;\n            this.CLOSED = 3;\n            this._eventHandlers = { message: [], open: [], close: [], error: [] };\n            this._bcMessageHandler = async (event) => {\n                const rawData = event.data;\n                let data;\n                if (typeof rawData === 'string') {\n                    data = JSON.parse(rawData);\n                }\n                else {\n                    data = rawData;\n                }\n                const { action, dest, wsUrl, payload } = data;\n                if (dest !== kernelClientId || wsUrl !== this.url) {\n                    return;\n                }\n                switch (action) {\n                    case 'connected': {\n                        this.readyState = this.OPEN;\n                        if (this.onopen) {\n                            this.onopen(event);\n                        }\n                        this._eventHandlers.open.forEach(handler => handler({ data: payload }));\n                        break;\n                    }\n                    case 'backend_message': {\n                        const decoded = decodeServerMessage(payload, this.binaryType);\n                        if (this.onmessage) {\n                            this.onmessage({ data: decoded });\n                        }\n                        this._eventHandlers.message.forEach(handler => handler({ data: decoded }));\n                        break;\n                    }\n                    default:\n                        break;\n                }\n            };\n            this._open = () => {\n                sendTypedMessage({\n                    action: 'open',\n                    payload: {\n                        protocol: this.protocol\n                    },\n                    wsUrl: this.url\n                });\n                bcWsChannel.addEventListener('message', this._bcMessageHandler);\n            };\n            const urlObj = new URL(url);\n            this.url = urlObj.pathname + urlObj.search + urlObj.hash;\n            if (protocols) {\n                this.protocol = Array.isArray(protocols)\n                    ? protocols.join(',')\n                    : protocols;\n            }\n            else {\n                this.protocol = '';\n            }\n            this.binaryType = 'blob';\n            this.bufferedAmount = 0;\n            this.extensions = '';\n            this.readyState = this.CONNECTING;\n            this._open();\n        }\n        close(code, reason) {\n            if (this.readyState === this.CLOSED) {\n                return;\n            }\n            if (this.onclose) {\n                this.onclose();\n            }\n            while (this._eventHandlers['close'].length) {\n                const cb = this._eventHandlers['close'].pop();\n                cb();\n            }\n            this._eventHandlers['close'] = [];\n            sendTypedMessage({\n                action: 'close',\n                wsUrl: this.url\n            });\n            bcWsChannel.removeEventListener('message', this._bcMessageHandler);\n            this.readyState = this.CLOSED;\n        }\n        send(data) {\n            sendTypedMessage({\n                action: 'send',\n                payload: data,\n                wsUrl: this.url\n            });\n        }\n        addEventListener(type, listener, options) {\n            this._eventHandlers[type].push(listener);\n        }\n        removeEventListener(type, listener, options) {\n            this._eventHandlers[type] = this._eventHandlers[type].filter(handler => handler !== listener);\n        }\n        dispatchEvent(event) {\n            return true;\n        }\n    }\n    window.WebSocket = BroadcastChannelWebSocket;\n})();\n".replaceAll('"use strict";',"")}get isDisposed(){return this._isDisposed}get kernelExecutor(){return this._kernelExecutor}dispose(){this._isDisposed||(this._isDisposed=!0,this.disposePythonServer().then(()=>{this._kernelExecutor.dispose()}).catch(console.error))}async init(e){if(await this._kernelExecutor.executeCode({code:"\n    from jupyterpack.common import patch_all\n    patch_all()\n    "}),!e.disableDependencies){const{dependencies:t}=e;if(null==t?void 0:t.mamba){const e=`\n      %mamba install ${t.mamba.join(" ")}\n      True\n      `;await this.kernelExecutor.executeCode({code:e},!0)}if(null==t?void 0:t.pip){const e=`\n        %pip install ${t.pip.join(" ")}\n        True\n        `;await this.kernelExecutor.executeCode({code:e},!0)}}}async disposePythonServer(){await this.kernelExecutor.executeCode({code:`${this._server_var}.dispose()`});for(const e of this._openedWebsockets)await this.closeWebsocket(e)}getResponseFunctionFactory(e){const{method:t,urlPath:n,headers:s,params:a,content:o}=e;return`await ${this._server_var}.get_response("${t}", "${n}", headers=${JSON.stringify(s)} , content=${w(o)}, params=${w(a)})`}openWebsocketFunctionFactory(e){const{instanceId:t,kernelId:n,wsUrl:s,protocol:a}=e;return`await ${this._server_var}.open_ws("${t}", "${n}", "${s}", ${w(a)})`}closeWebsocketFunctionFactory(e){const{instanceId:t,kernelId:n,wsUrl:s}=e;return`await ${this._server_var}.close_ws("${t}", "${n}", "${s}")`}sendWebsocketMessageFunctionFactory(e){const{instanceId:t,kernelId:n,wsUrl:s,message:a}=e;return`await ${this._server_var}.receive_ws_message("${t}", "${n}", "${s}", '''${a}''')`}async openWebsocket(e){const t=this.openWebsocketFunctionFactory(e);if(!t)throw new Error("Missing websocket open code");try{await this._kernelExecutor.executeCode({code:t}),this._openedWebsockets.push(e)}catch(e){console.error("Failed to open websocket",e)}}async closeWebsocket(e){const t=this.closeWebsocketFunctionFactory(e);if(!t)throw new Error("Missing websocket close code");await this._kernelExecutor.executeCode({code:t})}async sendWebsocketMessage(e){const t=this.sendWebsocketMessageFunctionFactory(e);if(!t)throw new Error("Missing websocket send code");await this._kernelExecutor.executeCode({code:t})}async getResponse(e){var t;const{method:n,urlPath:s,requestBody:a,params:o,headers:r}=e,i=a?g(a):void 0,c=this.getResponseFunctionFactory({method:n,urlPath:s,headers:r,params:o,content:i}),l=await this._kernelExecutor.executeCode({code:c},!0);if(!l)throw new Error(`Missing response for ${s}`);const d=l.replaceAll("'",""),h=JSON.parse(d),p=JSON.parse(atob(h.headers)),u=null!==(t=null==p?void 0:p["Content-Type"])&&void 0!==t?t:null==p?void 0:p["content-type"];let _;return _=function(e){return!(e&&(e=e.toLowerCase().trim(),["text/","application/json","application/javascript","application/xml","application/xhtml+xml","application/x-www-form-urlencoded","application/sql","application/graphql","application/yaml"].some(t=>e.startsWith(t))||!["image/","audio/","video/","font/","application/octet-stream","application/pdf","application/zip","application/x-protobuf","application/vnd"].some(t=>e.startsWith(t))&&e.includes("charset=")))}(u)?v(h.content):function(e){const t=v(e);return new TextDecoder("utf-8").decode(t)}(h.content),u&&u.toLowerCase().includes("text/html")&&(_=_.replace("<head>",`<head>\n<script>\n${this._wsPatch}\n<\/script>\n`)),{status_code:h.status_code,headers:p,content:_}}buildBaseURL(e){const{instanceId:t,kernelClientId:n,framework:s}=e,a=c.PageConfig.getOption("fullLabextensionsUrl"),o=c.URLExt.join(a,"jupyterpack/static",t,s,n,"/");return this._baseUrl=o,o}mergeDependencies(e,t){var n,s,a,o;if(!e)return t;if(!t)return e;const r={};return r.mamba=[...null!==(n=e.mamba)&&void 0!==n?n:[],...null!==(s=t.mamba)&&void 0!==s?s:[]],r.pip=[...null!==(a=e.pip)&&void 0!==a?a:[],...null!==(o=t.pip)&&void 0!==o?o:[]],r}}const b={mamba:["dash","werkzeug>=2.2,<3.0"],pip:[]},x={mamba:[],pip:["shiny","shinychat"]},S={mamba:["pyarrow","altair","blinker>=1.5.0,<2","cachetools>=4.0,<7","protobuf"],pip:["streamlit==1.50.0"]},E=new Map([[s.DASH,class extends C{async init(e){const t={...e,dependencies:this.mergeDependencies(e.dependencies,b)};await super.init(t);const{initCode:n,instanceId:a,kernelClientId:o}=e,r=this.buildBaseURL({instanceId:a,kernelClientId:o,framework:s.DASH});await this.kernelExecutor.executeCode({code:`\n      import os\n      os.environ["DASH_URL_BASE_PATHNAME"] = "${r}"\n      `}),n&&await this.kernelExecutor.executeCode({code:n});const i=`\n      from jupyterpack.dash import DashServer\n      ${this._server_var} = DashServer(app, "${r}")\n      `;await this.kernelExecutor.executeCode({code:i})}async reloadPythonServer(e){const{initCode:t}=e;t&&await this.kernelExecutor.executeCode({code:t}),await this.kernelExecutor.executeCode({code:`${this._server_var}.reload(app)`},!0)}}],[s.STREAMLIT,class extends C{async init(e){const t={...e,dependencies:this.mergeDependencies(e.dependencies,S)};await super.init(t);const{instanceId:n,kernelClientId:a,entryPath:o}=e;if(!o)throw new Error("Missing streamlit entry path, please check your SPK file");const r=this.buildBaseURL({instanceId:n,kernelClientId:a,framework:s.STREAMLIT}),i=`\n    from jupyterpack.common import set_base_url_env, patch_tornado\n    patch_tornado()\n    set_base_url_env("${r}")\n    `;await this.kernelExecutor.executeCode({code:i}),await this.kernelExecutor.executeCode({code:"\n    from jupyterpack.streamlit import patch_streamlit\n    patch_streamlit()\n    "});const c=`\n      from jupyterpack.streamlit import StreamlitServer, create_streamlit_app\n      __jupyterpack_st_server, __jupyterpack_tor_app = await create_streamlit_app("${o}", "${r}")\n      ${this._server_var} = StreamlitServer(__jupyterpack_tor_app, "${r}", __jupyterpack_st_server)\n      `;await this.kernelExecutor.executeCode({code:c})}async reloadPythonServer(e){const{entryPath:t}=e;if(!t||!this._baseUrl)return;const n=`\n      ${this._server_var}.dispose()\n      __jupyterpack_st_server, __jupyterpack_tor_app = await create_streamlit_app("${t}", "${this._baseUrl}")\n      ${this._server_var}.reload(__jupyterpack_tor_app, __jupyterpack_st_server)\n      `;await this.kernelExecutor.executeCode({code:n},!0)}}],[s.TORNADO,class extends C{async init(e){await super.init(e);const{initCode:t,instanceId:n,kernelClientId:a}=e,o=this.buildBaseURL({instanceId:n,kernelClientId:a,framework:s.TORNADO}),r=`\n    from jupyterpack.common import set_base_url_env, patch_tornado\n    set_base_url_env("${o}")\n    patch_tornado()\n\n    `;if(await this.kernelExecutor.executeCode({code:r}),t){const e=t.replaceAll("{{base_url}}",o);await this.kernelExecutor.executeCode({code:e});const n=`\n      from jupyterpack.tornado import TornadoServer\n      ${this._server_var} = TornadoServer(app, "${o}")\n      `;await this.kernelExecutor.executeCode({code:n})}}async reloadPythonServer(e){var t;const{initCode:n}=e;if(n){await this.kernelExecutor.executeCode({code:n.replaceAll("{{base_url}}",null!==(t=this._baseUrl)&&void 0!==t?t:"")});const e=`\n      ${this._server_var}.dispose()\n      ${this._server_var}.reload(app)\n      `;await this.kernelExecutor.executeCode({code:e},!0)}}}],[s.SHINY,class extends C{async init(e){const t={...e,dependencies:this.mergeDependencies(e.dependencies,x)};await super.init(t);const{instanceId:n,kernelClientId:a,entryPath:o}=e,r=this.buildBaseURL({instanceId:n,kernelClientId:a,framework:s.SHINY}),i=`\n    from jupyterpack.common import set_base_url_env\n    set_base_url_env("${r}")\n    from jupyterpack.shiny import patch_shiny\n    patch_shiny()\n    `;if(await this.kernelExecutor.executeCode({code:i}),o){const e=`\n      from jupyterpack.shiny import ShinyServer, get_shiny_app\n\n\n      ${this._server_var} = ShinyServer(get_shiny_app("${o}"), "${r}")\n      `;await this.kernelExecutor.executeCode({code:e})}}async disposePythonServer(){await this.kernelExecutor.executeCode({code:`${this._server_var}.dispose()`});for(const e of this._openedWebsockets)await this.closeWebsocket(e)}async reloadPythonServer(e){const{entryPath:t}=e;if(t){const e=`\n      from jupyterpack.shiny import  get_shiny_app\n\n      await ${this._server_var}.dispose()\n      ${this._server_var}.reload(get_shiny_app("${t}"))\n      `;await this.kernelExecutor.executeCode({code:e},!0)}}}],[s.STARLETTE,class extends C{async init(e){await super.init(e);const{initCode:t,instanceId:n,kernelClientId:a}=e,o=this.buildBaseURL({instanceId:n,kernelClientId:a,framework:s.STARLETTE}),r=`\n    from jupyterpack.common import set_base_url_env\n    set_base_url_env("${o}")\n    `;if(await this.kernelExecutor.executeCode({code:r}),t){const e=t.replaceAll("{{base_url}}",o);await this.kernelExecutor.executeCode({code:e});const n=`\n      from jupyterpack.asgi import AsgiServer\n      ${this._server_var} = AsgiServer(app, "${o}")\n      `;await this.kernelExecutor.executeCode({code:n})}}async disposePythonServer(){await this.kernelExecutor.executeCode({code:`${this._server_var}.dispose()`});for(const e of this._openedWebsockets)await this.closeWebsocket(e)}async reloadPythonServer(e){var t;const{initCode:n}=e;if(n){await this.kernelExecutor.executeCode({code:n.replaceAll("{{base_url}}",null!==(t=this._baseUrl)&&void 0!==t?t:"")});const e=`\n      await ${this._server_var}.dispose()\n      ${this._server_var}.reload(app)\n      `;await this.kernelExecutor.executeCode({code:e},!0)}}}]]);var M=n(602);class I{constructor(){this._handle_comm_open=async(e,t,n)=>{var s;this._comms.has(n)?null===(s=this._comms.get(n))||void 0===s||s.push(e):this._comms.set(n,[e]);const a=t.metadata.channel_name;if(!a)return;this._broadcastChannels.has(a)||this._broadcastChannels.set(a,new BroadcastChannel(a));const o=this._broadcastChannels.get(a);e.onMsg=e=>{const{data:t}=e.content;o.postMessage(t)}},this._kernels=new Map,this._comms=new Map,this._broadcastChannels=new Map,this._kernels=new Map,this._comms=new Map}registerKernel(e){this._kernels.set(e.id,e),e.registerCommTarget("jupyterpack:broadcast:comm",(t,n)=>this._handle_comm_open(t,n,e.id))}unregisterKernel(e){var t;e&&(this._kernels.delete(e),(null!==(t=this._comms.get(e))&&void 0!==t?t:[]).forEach(e=>e.dispose()),this._comms.delete(e))}dispose(){this._kernels.clear(),this._comms.clear(),this._broadcastChannels.forEach(e=>{e.close()}),this._broadcastChannels.clear()}}class j{constructor(e){var t,n;this._commBroadcastManager=new I,this._isDisposed=!1,this._kernelStarted=!1,this._serverReloaded=new M.Signal(this),this._kernelStatusChanged=new M.Signal(this),this._context=e.context,this._manager=e.manager,this._connectionManager=e.connectionManager,this._contentsManager=e.contentsManager,this._jpackModel=e.jpackModel,this._localPath=c.PathExt.dirname(this._context.localPath),this._autoreload=Boolean(null===(n=null===(t=this._jpackModel)||void 0===t?void 0:t.metadata)||void 0===n?void 0:n.autoreload),this._contentsManager.fileChanged.connect(this._onFileChanged,this)}get autoreload(){return this._autoreload}set autoreload(e){this._autoreload=e}get isDisposed(){return this._isDisposed}get connectionManager(){return this._connectionManager}get serverReloaded(){return this._serverReloaded}get kernelStatusChanged(){return this._kernelStatusChanged}async reload(){var e;if(!this._kernelStarted)return;const{spkContent:t,entryContent:n}=await this._loadData();await(null===(e=this._executor)||void 0===e?void 0:e.reloadPythonServer({entryPath:t.entry,initCode:n.content})),this._serverReloaded.emit()}async initialize(){var e;if(this._kernelStarted)return{success:!1,error:"Server is called twice"};const{filePath:t,spkContent:n,rootUrl:s,entryContent:a}=await this._loadData(),o=this._manager.sessions;await o.ready,await this._manager.kernelspecs.ready;const i=this._manager.kernelspecs.specs;if(!i)return{success:!1,error:"Missing kernel spec"};const{kernelspecs:c}=i;let l=Object.keys(c)[0];c[i.default]&&(l=i.default),this._sessionConnection=await o.startNew({name:t,path:t,kernel:{name:l},type:"notebook"},{kernelConnectionOptions:{handleComms:!0}});const d=this._sessionConnection.kernel;d&&(this._kernelStatusChanged.emit("started"),this._commBroadcastManager.registerKernel(d),d.disposed.connect(()=>{this._kernelStatusChanged.emit("stopped"),this._commBroadcastManager.unregisterKernel(d.id)}));const h=n.framework,p=E.get(h);if(!p)return{success:!1,error:`Framework "${h}" is not supported. Please check your .spk file.`};const u=this._executor=new p({sessionConnection:this._sessionConnection}),_=await this._connectionManager.registerConnection(u);await u.init({initCode:a.content,entryPath:n.entry,dependencies:n.dependencies,disableDependencies:n.disableDependencies,..._});const m=new r.PromiseDelegate,g=(e,t)=>{var n;"idle"===t&&(null===(n=this._sessionConnection.kernel)||void 0===n||n.statusChanged.disconnect(g),m.resolve())};return null===(e=this._sessionConnection.kernel)||void 0===e||e.statusChanged.connect(g),await m.promise,this._kernelStarted=!0,{..._,rootUrl:s,framework:h,success:!0}}async dispose(){var e,t,n;this._isDisposed||(p||null===(t=null===(e=this._sessionConnection)||void 0===e?void 0:e.kernel)||void 0===t||t.shutdown(),null===(n=this._executor)||void 0===n||n.disposePythonServer(),this._contentsManager.fileChanged.disconnect(this._onFileChanged),this._commBroadcastManager.dispose(),this._isDisposed=!0)}async _loadData(){var e;const t=this._context.localPath,n=this._jpackModel,s=c.PathExt.join(c.PathExt.dirname(t),n.entry);return{filePath:t,spkContent:n,rootUrl:null!==(e=n.rootUrl)&&void 0!==e?e:"/",entryContent:await this._contentsManager.get(s,{content:!0,format:"text"})}}async _onFileChanged(e,t){var n;this._autoreload&&"save"===t.type&&(null===(n=t.newValue)||void 0===n?void 0:n.path)&&t.newValue.path.startsWith(this._localPath)&&await this.reload()}}var T=n(621);class ${constructor(e){this._fileChanged=new M.Signal(this),this._isDisposed=!1,this._contentManager=e.contentsManager,this._path=e.path,this._contentManager.fileChanged.connect(this._onFileChanged,this)}async getAllFiles(e=!1){if(!this._allFiles||e){const e=await this._contentManager.get(this._path,{content:!0});this._allFiles=await this.flattenDirectory(e)}return this._allFiles}get isDisposed(){return this._isDisposed}get fileChanged(){return this._fileChanged}dispose(){this._isDisposed||(this._isDisposed=!0,this._contentManager.fileChanged.disconnect(this._onFileChanged))}async flattenDirectory(e){const t={},n=e.content;for(const e of n)if("file"===e.type){const n=this._removeRoot(e.path);let s=e;s.content||(s=await this._getContent(e.path)),"application/json"===s.mimetype&&"string"!=typeof s.content?t[n]={code:JSON.stringify(s.content)}:t[n]={code:s.content}}else if("directory"===e.type){const n=await this._getContent(e.path),s=await this.flattenDirectory(n);Object.assign(t,s)}return t}async _onFileChanged(e,t){var n,s,a,o,r;switch(t.type){case"save":if(null===(n=t.newValue)||void 0===n?void 0:n.path){const e=await this._getContent(t.newValue.path),n=this._removeRoot(t.newValue.path);this._allFiles&&(this._allFiles[n]={code:e.content})}break;case"delete":if(null===(s=t.oldValue)||void 0===s?void 0:s.path){const e=this._removeRoot(t.oldValue.path);this._allFiles&&delete this._allFiles[e]}break;case"rename":if((null===(a=t.oldValue)||void 0===a?void 0:a.path)&&(null===(o=t.newValue)||void 0===o?void 0:o.path)){const e=this._removeRoot(t.oldValue.path),n=this._removeRoot(t.newValue.path);this._allFiles&&(this._allFiles[n]=this._allFiles[e],delete this._allFiles[n])}break;case"new":if(null===(r=t.newValue)||void 0===r?void 0:r.path){const e=await this._getContent(t.newValue.path),n=this._removeRoot(t.newValue.path);this._allFiles&&(this._allFiles[n]={code:e.content})}}this._allFiles&&this._fileChanged.emit({allFiles:this._allFiles})}_removeRoot(e){return function(e,t){return e.startsWith(t)?e.slice(t.length):e}(e,this._path)}_getContent(e){return this._contentManager.get(e,{content:!0})}}class R extends l{constructor(e){super(),this._autoreload=!1,this._isReady=new r.PromiseDelegate,this._contentsManager=e.contentsManager;const{context:t}=e;e.context.ready.then(async()=>{const e=t.model.toJSON();await this.init(t.localPath,e)})}dispose(){var e,t,n;null===(e=this._fileModel)||void 0===e||e.fileChanged.disconnect(this._onFileChanged),null===(t=this._fileModel)||void 0===t||t.dispose(),null===(n=this._spClient)||void 0===n||n.destroy(),super.dispose()}get isReady(){return this._isReady.promise}get autoreload(){return this._autoreload}set autoreload(e){this._autoreload=e}async init(e,t){var n;!0===(null===(n=null==t?void 0:t.metadata)||void 0===n?void 0:n.autoreload)&&(this._autoreload=!0);const s=e.split("/").slice(0,-1).join("/"),a=new $({contentsManager:this._contentsManager,path:s});this._fileModel=a;const o=await a.getAllFiles();this._spClient=await(0,T.loadSandpackClient)(this._iframe,{files:o},{showLoadingScreen:!0,showOpenInCodeSandbox:!1}),await this.connectSignals(a,this._spClient),this._isReady.resolve()}async connectSignals(e,t){e.fileChanged.connect(this._onFileChanged,this),t.listen(e=>{switch(e.type){case"start":this.toggleSpinner(!0);break;case"success":this.toggleSpinner(!1)}})}async reload(){if(this._spClient&&this._fileModel){const e=await this._fileModel.getAllFiles();this._spClient.updateSandbox({files:e})}}_onFileChanged(e,{allFiles:t}){this._autoreload&&this._spClient&&this._spClient.updateSandbox({files:t})}}class D extends o.DocumentWidget{constructor(e){super(e),this.onResize=e=>{window.dispatchEvent(new Event("resize"))}}dispose(){this.content.dispose(),super.dispose()}}const L="jupyterpack:reload",F="jupyterpack:toggleAutoreload",P="jupyterpack:openInSpecta",A=c.PageConfig.getOption("baseUrl");function U(e){var t;const n=null===(t=e.currentWidget)||void 0===t?void 0:t.content;if(!n)return;return n.widgets[0]||void 0}class W extends h.ReactiveToolbar{constructor(e){super(),this.addClass("jupyterpack-toolbar"),this.addItem("Reload",new h.CommandToolbarButton({commands:e.commands,id:L})),this.addItem("Toggle Auto Reload",new h.CommandToolbarButton({id:F,commands:e.commands})),this.addItem("Open Specta",new h.CommandToolbarButton({id:P,commands:e.commands}))}}class B extends o.ABCWidgetFactory{constructor(e){super(e),this.options=e,this._contentsManager=e.manager.contents}createNewWidget(e){const t=new i.Panel;t.addClass("jp-jupyterpack-document-panel"),e.ready.then(()=>{const n=e.model.toJSON();switch(n.framework){case s.REACT:{const n=new R({context:e,contentsManager:this._contentsManager});t.addWidget(n);break}case s.DASH:case s.STREAMLIT:case s.TORNADO:case s.STARLETTE:case s.SHINY:{const s=new j({jpackModel:n,context:e,manager:this.options.manager,contentsManager:this._contentsManager,connectionManager:this.options.connectionManager}),a=new d({model:s,id:r.UUID.uuid4()});t.addWidget(a);break}default:console.error("Unsupported framework")}});const n=new W({tracker:this.options.tracker,commands:this.options.commands});return new D({context:e,content:t,toolbar:n})}}const O=new r.Token("jupyterpack:connection-manager"),N=new r.Token("jupyterpack:dock-tracker");var H=n(827);const V="jupyterpack",K="jupyterpack",J={id:"jupyterpack:spkplugin",requires:[O],autoStart:!0,provides:N,activate:(e,t)=>{const n=new H.WidgetTracker({namespace:V});!function(e,t){e.addCommand(L,{caption:"Reload",isEnabled:()=>null!==t.currentWidget,icon:h.refreshIcon,execute:async()=>{const e=U(t);e&&await e.reload()}});e.addCommand(F,{isEnabled:()=>null!==t.currentWidget,isToggled:()=>{const e=U(t);return Boolean(null==e?void 0:e.autoreload)},icon:_,caption:e=>"Auto-reload disabled",execute:async()=>{const n=U(t);n&&(n.autoreload=!(null==n?void 0:n.autoreload),e.notifyCommandChanged(F))}}),e.addCommand(P,{caption:"Open in Specta",isEnabled:()=>null!==t.currentWidget,icon:m,execute:async()=>{var e;const n=null===(e=t.currentWidget)||void 0===e?void 0:e.context;if(!n)return;const s=new URL(c.URLExt.join(A,"specta"),window.location.origin);s.searchParams.set("path",n.path),window.open(s.toString(),"_blank")}})}(e.commands,n);const s=new B({name:V,modelName:"text",fileTypes:[K],defaultFor:[K],commands:e.commands,manager:e.serviceManager,connectionManager:t,tracker:n});return e.docRegistry.addWidgetFactory(s),e.docRegistry.addFileType({name:K,displayName:"SPK",mimeTypes:["application/json"],extensions:[".spk",".SPK"],fileFormat:"json",contentType:K,icon:u}),s.widgetCreated.connect((e,t)=>{t.title.icon=u,t.context.pathChanged.connect(()=>{n.save(t)}),n.add(t)}),n}};var z=n(88);class q{constructor(e){this.instanceId=e,this._pythonServers=new Map,this._wsBroadcastChannelMap=new Map}async registerConnection(e){const t=r.UUID.uuid4();this._pythonServers.set(t,e);const n=new BroadcastChannel(`/jupyterpack/ws/${this.instanceId}/${t}`);return this._initWsChannel(n),this._wsBroadcastChannelMap.set(`${this.instanceId}/${t}`,n),{instanceId:this.instanceId,kernelClientId:t}}async generateResponse(e){const{urlPath:t,kernelClientId:n,method:s,params:a,requestBody:o,headers:r}=e,i=this._pythonServers.get(n);return i?await i.getResponse({urlPath:t,method:s,params:a,headers:r,requestBody:o}):null}_initWsChannel(e){e.onmessage=e=>{const t=e.data;let n;n="string"==typeof t?JSON.parse(t):t;const{action:s,dest:a,wsUrl:o,payload:r}=n,i=this._pythonServers.get(a);if(i)switch(s){case"open":i.openWebsocket({instanceId:this.instanceId,kernelId:a,wsUrl:o,protocol:r.protocol});break;case"close":i.closeWebsocket({instanceId:this.instanceId,kernelId:a,wsUrl:o});break;case"send":{let e,t;if(r instanceof ArrayBuffer||ArrayBuffer.isView(r))e=g(r),t=!0;else{if("string"!=typeof r)return void console.error("Unknown message type",r);e=function(e){const t=(new TextEncoder).encode(e);let n="";for(let e=0;e<t.length;e++)n+=String.fromCharCode(t[e]);return window.btoa(n)}(r),t=!1}i.sendWebsocketMessage({instanceId:this.instanceId,kernelId:a,wsUrl:o,message:JSON.stringify({isBinary:t,data:e})});break}}else console.error("Missing kernel handle for message",n,a,this._pythonServers)}}}const Y=`${c.PageConfig.getOption("fullLabextensionsUrl")}/jupyterpack/static`,G=[{id:"jupyterpack:service-worker-plugin",description:"jupyterpack service worker plugin",autoStart:!0,provides:O,activate:async e=>{const t=await async function(){if(!("serviceWorker"in navigator))return void console.error("Cannot start extension without service worker");const e=`${Y}/service-worker.js`;try{const t=await navigator.serviceWorker.register(e);if(!t)return void console.error("Missing service worker registration");if(await t.update(),t.installing){const e=t.installing||t.waiting;e.onstatechange=()=>{"installed"===e.state&&window.location.reload()}}return t.active||console.log("Service worker newly registered",await navigator.serviceWorker.getRegistration(e)),t.active}catch(e){return void console.error("Failed to register service worker",e)}}();if(!t)throw new Error("Failed to register the Service Worker, please make sure to use a browser that supports this feature.");const n=r.UUID.uuid4();console.log("Activating jupyterpack service worker with instance id",n);const{port1:s,port2:o}=new MessageChannel,i=new q(n);return(0,z.expose)(i,s),t.postMessage({type:a.INIT,data:{instanceId:n}},[o]),setTimeout(()=>{!function(){const e=document.createElement("iframe");e.style.display="none",e.src=c.URLExt.join(Y,"__jupyterpack__","ping.html"),document.body.appendChild(e)}()},1e4),i}},J]}}]);