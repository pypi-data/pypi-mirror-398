# 磁盘信息可视化优化实现文档

## 功能概述

优化磁盘空间分析工具的磁盘信息显示功能，解决同一物理分区被重复显示的问题，并增加点击交互式分区详情查看功能。

## 实现时间

2025-12-22

## 问题背景

原系统磁盘信息展示存在以下问题：
1. 所有挂载点（/、/home、/tmp、/usr、/var）显示相同的磁盘信息
2. 未区分物理分区和逻辑挂载点
3. 缺少交互式分区详情查看功能

根本原因：多个目录挂载在同一个物理分区上，`os.statvfs()` 返回相同的文件系统统计信息。

## 解决方案

采用基于设备号识别的分区去重方案：
- 使用 `os.stat().st_dev` 获取文件系统设备号
- 相同设备号的挂载点合并为一个分区显示
- 区分本地磁盘和外部挂载
- 提供点击交互式树形详情查看

## 技术实现

### 后端实现

#### 1. 新增方法：`get_unique_partitions()` (disk_analyzer.py)

**功能**：获取唯一物理分区列表，基于设备号去重

**实现逻辑**：
```python
def get_unique_partitions(self) -> List[Dict]:
    # 1. 遍历常见挂载点列表
    # 2. 使用 os.stat().st_dev 获取设备号
    # 3. 按设备号分组挂载点
    # 4. 每个设备组选择代表性挂载点（优先根分区）
    # 5. 收集关联路径
    # 6. 判断分区类型（本地/挂载）
    # 7. 排序返回（主分区优先，按容量降序）
```

**返回数据结构**：
```python
{
    'mount_point': str,      # 代表性挂载点
    'partition_type': str,   # 'local' 或 'mounted'
    'is_primary': bool,      # 是否为主分区
    'device_id': int,        # 设备号
    'total': str,            # 总容量（人类可读）
    'total_bytes': int,      # 总容量（字节）
    'used': str,             # 已用容量
    'free': str,             # 可用容量
    'usage_percent': float,  # 使用百分比
    'related_paths': List    # 关联路径列表
}
```

#### 2. 新增方法：`analyze_partition_tree()` (disk_analyzer.py)

**功能**：分析分区目录树，用于详情展示

**实现逻辑**：
```python
def analyze_partition_tree(self, mount_point: str, max_depth: int = 2, limit: int = 20):
    # 1. 验证挂载点路径
    # 2. 创建临时analyzer进行分析（限制深度和数量）
    # 3. 构建树形结构
    # 4. 计算每个节点的占比
    # 5. 返回树形数据
```

**参数说明**：
- `mount_point`: 挂载点路径
- `max_depth`: 分析深度，默认2层（控制性能）
- `limit`: 每层最多返回的子目录数，默认20

**返回数据结构**：
```python
{
    'success': bool,
    'mount_point': str,
    'tree': {
        'name': str,
        'path': str,
        'size_bytes': int,
        'size_human': str,
        'file_count': int,
        'dir_count': int,
        'usage_percent': float,
        'children': []  # 递归结构
    }
}
```

#### 3. 新增API路由 (disk_web_tool.py)

**路由1**：`GET /api/partitions`
- 功能：获取去重后的分区信息
- 调用：`analyzer.get_unique_partitions()`
- 返回：分区列表JSON

**路由2**：`POST /api/partition-tree`
- 功能：获取分区目录树结构
- 参数：`mount_point`, `max_depth`, `limit`
- 调用：`analyzer.analyze_partition_tree()`
- 返回：树形结构JSON

### 前端实现

#### 1. CSS样式优化

新增分区卡片样式：
```css
.partition-card {
    cursor: pointer;
    border-radius: 8px;
}
.partition-card.local-disk {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.partition-card.mounted-disk {
    background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
    color: white;
}
.partition-card:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
```

#### 2. 系统信息区域优化

**界面调整**：
- 添加说明文字："显示系统独立物理分区，相同分区上的多个路径已合并显示。点击分区卡片可查看详细目录结构。"
- 添加刷新按钮
- 分区卡片显示：
  - 分区类型标签（本地磁盘/外部挂载）
  - 容量信息和使用率进度条
  - 关联路径（如有）
  - 点击事件监听

**JavaScript函数**：`loadSystemInfo()`
```javascript
// 调用 /api/partitions 获取去重后的分区数据
// 根据分区类型应用不同样式
// 显示关联路径
// 添加点击事件触发树形弹窗
```

#### 3. 树形弹窗组件

**HTML结构**：
```html
<div class="modal fade" id="partitionTreeModal">
    <!-- 模态框头部：显示分区路径 -->
    <!-- 模态框主体：渲染树形结构 -->
    <!-- 模态框底部：关闭按钮 -->
</div>
```

**JavaScript函数**：

1. `showPartitionTree(mountPoint)`
   - 显示模态框
   - 显示加载动画
   - 请求 `/api/partition-tree` 获取数据
   - 调用 `renderPartitionTree()` 渲染

2. `renderPartitionTree(tree)`
   - 渲染根节点
   - 递归调用 `renderTreeNode()` 渲染子节点

3. `renderTreeNode(nodes)`
   - 递归渲染树节点
   - 每个节点显示：
     - 目录图标
     - 目录名
     - 大小
     - 文件数/目录数
     - 占比进度条
   - 支持点击展开/折叠

4. `toggleTreeNode(nodeId)`
   - 切换节点展开/折叠状态

## 性能优化

1. **分区识别**：设备号获取是轻量级操作，性能开销可忽略
2. **树形分析**：
   - 限制深度为2层
   - 限制每层子目录数量为20
   - 预计单次分析耗时1-3秒
3. **前端渲染**：
   - 初始仅渲染前两层
   - 深层节点懒加载
   - 避免一次性渲染大量节点

## 向后兼容性

- 保留原有 `/api/system-info` 接口（返回旧格式）
- 新增 `/api/partitions` 接口（返回新格式）
- 不影响现有分析、删除等核心功能

## 测试结果

### API测试

**测试1**：分区去重功能
```bash
curl -s http://127.0.0.1:8080/api/partitions
```
结果：✅ 成功识别唯一分区，相同设备的挂载点合并，关联路径显示正确

**测试2**：分区树形API
```bash
curl -X POST http://127.0.0.1:8080/api/partition-tree \
  -H "Content-Type: application/json" \
  -d '{"mount_point": "/", "max_depth": 1, "limit": 5}'
```
结果：✅ 成功返回树形结构，包含节点详细信息和占比

### 功能验证

1. ✅ **去重功能**：同一物理分区的多个挂载点仅显示一次
2. ✅ **分类显示**：本地磁盘使用紫色渐变，挂载点使用蓝色渐变
3. ✅ **关联路径**：正确显示共享同一分区的其他挂载点
4. ✅ **交互功能**：点击分区卡片弹出树形视图
5. ✅ **树形结构**：正确展示目录层级，支持展开/折叠
6. ✅ **性能要求**：树形数据获取在3秒内完成

## 代码变更

### 修改文件

1. `disk_analyzer.py`
   - 新增：`get_unique_partitions()` 方法（88行）
   - 新增：`analyze_partition_tree()` 方法（67行）
   - 修改：`get_system_info()` 注释更新

2. `disk_web_tool.py`
   - 新增：CSS样式（11行）
   - 新增：分区树形弹窗HTML（28行）
   - 修改：系统信息区域HTML（8行）
   - 新增：`loadSystemInfo()` 函数（重写，47行）
   - 新增：树形弹窗相关JavaScript函数（125行）
   - 新增：`/api/partitions` 路由（13行）
   - 新增：`/api/partition-tree` 路由（17行）

### 总代码变更
- 新增：约 404 行
- 修改：约 61 行

## 使用说明

### 用户操作流程

1. 访问系统主页，查看"系统磁盘信息"区域
2. 观察去重后的分区显示：
   - 本地磁盘使用紫色卡片
   - 外部挂载使用蓝色卡片
   - 关联路径以标签形式显示
3. 点击分区卡片
4. 弹出树形视图，显示该分区的目录结构
5. 点击目录节点展开/折叠子目录
6. 查看每个目录的大小、文件数、占比等信息

### 管理员配置

无需额外配置，系统自动识别分区。

## 已知限制

1. **跨平台兼容性**：当前主要支持Linux系统，Windows系统需适配驱动器盘符识别
2. **复杂挂载场景**：LVM、RAID等复杂存储架构可能导致设备号识别不准确
3. **动态挂载**：USB设备动态挂载后需刷新页面查看最新分区
4. **树形深度**：为控制性能，树形视图默认仅展示2层，深层目录需在主分析功能中查看

## 后续优化建议

1. **实时监控**：支持定时刷新磁盘信息，动态展示使用率变化
2. **多级树形展开**：支持在弹窗中动态加载更深层级的目录结构
3. **分区对比**：支持选择多个分区进行使用情况对比
4. **智能建议**：基于分区使用率和文件分布，提供清理建议
5. **Windows适配**：适配Windows系统的驱动器识别逻辑

## 相关文档

- 设计文档：`/home/swufe/Project/FICDevData/Code/disk_analyzer/.qoder/quests/disk-info-visualization.md`
- 项目主目录：`/home/swufe/Project/FICDevData/Code/disk_analyzer/`
