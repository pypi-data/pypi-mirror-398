<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Number Adder</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
        .header { background: white; padding: 15px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .user-email { color: #666; }
        .badge { background: #ffc107; color: #333; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge.premium { background: #28a745; color: white; }
        .logout { color: #dc3545; cursor: pointer; text-decoration: underline; }
        .container { max-width: 800px; margin: 0 auto; padding: 30px 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
        .card { background: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h2 { margin-bottom: 20px; font-size: 18px; }
        .card.locked { opacity: 0.7; }
        .card.locked h2::after { content: ' (Premium)'; color: #ffc107; }
        label { display: block; margin-bottom: 5px; color: #333; font-weight: 500; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; font-size: 16px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result { margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 4px; font-size: 24px; text-align: center; display: none; }
        .upgrade-banner { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .upgrade-banner h3 { margin-bottom: 5px; }
        .upgrade-banner p { opacity: 0.9; }
        .upgrade-banner button { background: white; color: #667eea; }
        .history { margin-top: 30px; }
        .history h2 { margin-bottom: 15px; }
        .history-item { background: white; padding: 15px; border-radius: 4px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .history-item .op { font-weight: bold; }
        .history-item .time { color: #666; font-size: 12px; }
        .empty { color: #666; text-align: center; padding: 20px; }
        .error { color: #dc3545; margin-bottom: 15px; padding: 10px; background: #f8d7da; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Number Adder</h1>
        <div class="header-right">
            <span class="user-email" id="user-email">Loading...</span>
            <span class="badge" id="user-badge">Free</span>
            <a href="/settings.html" style="color: #007bff; text-decoration: none; margin-left: 15px;">Settings</a>
            <span class="logout" onclick="logout()">Logout</span>
        </div>
    </div>

    <div class="container">
        <div id="upgrade-banner" class="upgrade-banner" style="display: none;">
            <div>
                <h3>Upgrade to Premium</h3>
                <p>Unlock the multiply feature for just $999,999.99!</p>
            </div>
            <button onclick="handleUpgrade()">Upgrade Now</button>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Add Numbers</h2>
                <label>First Number</label>
                <input type="number" id="add-a" step="any">
                <label>Second Number</label>
                <input type="number" id="add-b" step="any">
                <button onclick="doAdd()">Add</button>
                <div class="result" id="add-result"></div>
            </div>

            <div class="card" id="multiply-card">
                <h2>Multiply Numbers</h2>
                <label>First Number</label>
                <input type="number" id="mul-a" step="any">
                <label>Second Number</label>
                <input type="number" id="mul-b" step="any">
                <button onclick="doMultiply()" id="mul-btn">Multiply</button>
                <div class="result" id="mul-result"></div>
            </div>
        </div>

        <div class="history">
            <h2>Calculation History</h2>
            <div id="history-list">
                <div class="empty">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const API = '';
        let isPremium = false;

        // Check for token in URL (from OAuth callback)
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        if (urlToken) {
            localStorage.setItem('token', urlToken);
            // Clean up URL
            window.history.replaceState({}, document.title, '/dashboard.html');
        }

        let token = localStorage.getItem('token');

        if (!token) {
            window.location.href = '/';
        }

        async function fetchWithAuth(url, options = {}) {
            const res = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            if (res.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/';
            }
            return res;
        }

        async function loadUser() {
            try {
                const res = await fetchWithAuth(`${API}/me`);
                const user = await res.json();
                document.getElementById('user-email').textContent = user.email;
                isPremium = user.is_premium;

                const badge = document.getElementById('user-badge');
                if (isPremium) {
                    badge.textContent = 'Premium';
                    badge.classList.add('premium');
                    document.getElementById('upgrade-banner').style.display = 'none';
                    document.getElementById('multiply-card').classList.remove('locked');
                } else {
                    badge.textContent = 'Free';
                    document.getElementById('upgrade-banner').style.display = 'flex';
                    document.getElementById('multiply-card').classList.add('locked');
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function loadHistory() {
            try {
                const res = await fetchWithAuth(`${API}/history`);
                const data = await res.json();
                const list = document.getElementById('history-list');

                if (data.calculations.length === 0) {
                    list.innerHTML = '<div class="empty">No calculations yet</div>';
                    return;
                }

                list.innerHTML = data.calculations.map(c => `
                    <div class="history-item">
                        <span class="op">${c.num_a} ${c.operation === 'add' ? '+' : '×'} ${c.num_b} = ${c.result}</span>
                        <span class="time">${new Date(c.created_at).toLocaleString()}</span>
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        async function doAdd() {
            const a = parseFloat(document.getElementById('add-a').value);
            const b = parseFloat(document.getElementById('add-b').value);
            if (isNaN(a) || isNaN(b)) return alert('Enter valid numbers');

            try {
                const res = await fetchWithAuth(`${API}/add`, {
                    method: 'POST',
                    body: JSON.stringify({ a, b })
                });
                const data = await res.json();
                const resultEl = document.getElementById('add-result');
                resultEl.textContent = `${a} + ${b} = ${data.result}`;
                resultEl.style.display = 'block';
                loadHistory();
            } catch (err) {
                alert(err.message);
            }
        }

        async function doMultiply() {
            if (!isPremium) {
                return handleUpgrade();
            }

            const a = parseFloat(document.getElementById('mul-a').value);
            const b = parseFloat(document.getElementById('mul-b').value);
            if (isNaN(a) || isNaN(b)) return alert('Enter valid numbers');

            try {
                const res = await fetchWithAuth(`${API}/multiply`, {
                    method: 'POST',
                    body: JSON.stringify({ a, b })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail);
                const resultEl = document.getElementById('mul-result');
                resultEl.textContent = `${a} × ${b} = ${data.result}`;
                resultEl.style.display = 'block';
                loadHistory();
            } catch (err) {
                alert(err.message);
            }
        }

        async function handleUpgrade() {
            try {
                const successUrl = `${window.location.origin}/success.html`;
                const cancelUrl = `${window.location.origin}/cancel.html`;
                const res = await fetchWithAuth(`${API}/create-checkout-session?success_url=${encodeURIComponent(successUrl)}&cancel_url=${encodeURIComponent(cancelUrl)}`, {
                    method: 'POST'
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail);
                window.location.href = data.checkout_url;
            } catch (err) {
                alert(err.message);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        // Initialize
        loadUser();
        loadHistory();
    </script>
</body>
</html>
