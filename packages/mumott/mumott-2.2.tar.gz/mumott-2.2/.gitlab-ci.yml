image: $CI_REGISTRY/liebi-group/software/$CI_PROJECT_NAME/cicd

variables:
  INSTDIR_LINUX: "local_installation_linux"

#------------------- build stage -------------------

build:linux:
  stage: build
  before_script:
    - export PYTHONPATH=$PWD/$INSTDIR_LINUX:${PYTHONPATH}
  script:
    # dependency resolution doesn't respect pythonpath
    - pip install --target=$INSTDIR_LINUX --no-dependencies .
  artifacts:
    expire_in: 2 days
    paths:
      - $INSTDIR_LINUX


#------------------- test stage -------------------

basic_tests:linux:
  stage: test
  tags:
    - saas-linux-medium-amd64-gpu-standard
  needs:
    - build:linux
  before_script:
    - export PYTHONPATH=$PWD/$INSTDIR_LINUX:${PYTHONPATH}
  script:
    # helps with debugging
    - nvidia-smi
    # this is done to ensure that coverage/pytest uses the previously installed version
    - rm -fr mumott
    - xdoctest mumott
    - coverage run -m pytest --verbose --junitxml=report.xml tests
    - coverage report -m
    - coverage html
  coverage: "/TOTAL.+ ([0-9]{1,3}%)/"
  artifacts:
    expire_in: 2 days
    paths:
      - htmlcov/
    reports:
      junit: report.xml


.test_notebooks:
  stage: test
  before_script:
    - export PYTHONPATH=$PWD/$INSTDIR_LINUX:${PYTHONPATH}
  tags:
    - saas-linux-medium-amd64-gpu-standard
  needs:
    - build:linux
  script:
    # astoundingly, this is the solution to not making a special VTK build. A framebuffer.
    - Xvfb :99 -screen 0 1280x1024x24 &
    - export DISPLAY=:99
    - cd tutorial
    - curl -O https://zenodo.org/records/7326784/files/saxstt_dataset_M.h5 --retry 5 --verbose
    - curl -O https://zenodo.org/records/10074598/files/trabecular_bone_9.h5 --retry 5 --verbose
    - cd ..
    - pytest --nbmake --nbmake-timeout=3600 tutorial/reconstruct_and_visualize.ipynb
    - pytest --nbmake --nbmake-timeout=3600 tutorial/inspect_data.ipynb
    - pytest --nbmake --nbmake-timeout=3600 tutorial/projection_and_adjoint.ipynb
    - pytest --nbmake --nbmake-timeout=3600 tutorial/phase_matching_alignment.ipynb
    - pytest --nbmake --nbmake-timeout=3600 tutorial/optical_flow_alignment.ipynb
    - pytest --nbmake --nbmake-timeout=3600 tutorial/reconstruction_pipelines.ipynb
    - pytest --nbmake --nbmake-timeout=3600 tutorial/regularization_l_curves.ipynb
    - pytest --nbmake --nbmake-timeout=3600 tutorial/asynchronous_reconstruction.ipynb
    - pytest --nbmake --nbmake-timeout=3600 tutorial/line_segment_integration.ipynb
    - pytest --nbmake --nbmake-timeout=3600 tutorial/simulating_samples.ipynb


test_notebooks:manual:
  extends: .test_notebooks
  when: manual


test_notebooks:schedules:
  extends: .test_notebooks
  only:
   - schedules


style_check:
  stage: test
  script:
  - flake8 doc/ mumott/ tests/


test_documentation:
  before_script:
    - export PYTHONPATH=$PWD/$INSTDIR_LINUX:${PYTHONPATH}
  stage: test
  needs:
    - build:linux
  script:
    - sphinx-build -W doc/ public/
  except:
   - master
  artifacts:
    expire_in: 1 days
    paths:
      - public


#------------------- deploy stage -------------------

pages:
  before_script:
    - export PYTHONPATH=$PWD/$INSTDIR_LINUX:${PYTHONPATH}
  stage: deploy
  needs:
    - build:linux  # for compiled libraries
    - basic_tests:linux  # for coverage
  artifacts:
    expire_in: 30 days
    paths:
      - public
  only:
    - master
    - tags
  script:
    - mkdir -p public/dev
    - mv htmlcov/ public/
    # --------------------------
    # DEVELOPMENT VERSION
    - tag=$(git describe --tags | tail -1)
    - echo "tag= $tag"
    - sed -i "s/version = ''/version = '$tag'/" doc/conf.py
    - grep version doc/conf.py
    - sphinx-build -W doc/ public/dev/
    - find tests/ -print | zip public/dev/tests.zip -@
    - git checkout -- doc/conf.py
    # --------------------------
    # STABLE VERSION
    - tag=$(git tag | tail -1)
    - echo "tag= $tag"
    - git checkout $tag
    - sed -i "s/version = ''/version = '$tag'/" doc/conf.py
    - ORIG_PYTHONPATH=$PYTHONPATH
    - export PYTHONPATH=$PWD:$PYTHONPATH
    - sphinx-build -W doc/ public/
    - find tests/ -print | zip public/tests.zip -@
    - export PYTHONPATH=$ORIG_PYTHONPATH
    # --------------------------
    - ls -l public/
    - chmod go-rwX -R public/


pypi:
  stage: deploy
  only:
    - tags
  when: manual
  environment:
      name: pypi-upload
  script:
    - export PYTHONPATH=$PWD/$INSTDIR_LINUX:${PYTHONPATH}
    # check out the latest tag (redundant if job is limited to tags; still a sensible precaution)
    - tag=$(git tag | tail -1)
    - echo "tag= $tag"
    - git checkout $tag
    # create source distribution and push to PyPI
    - python3 -m build --sdist
    - ls -l dist/
    - python3 -m twine upload dist/*
