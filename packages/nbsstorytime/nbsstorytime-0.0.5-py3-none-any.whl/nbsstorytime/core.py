# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/00_core.ipynb.

# %% auto 0
__all__ = ['N4L_SOLVEIT_ROOT', 'find_current_notebook', 'nbsstorytime_export', 'find_dname']

# %% ../nbs/00_core.ipynb 8
import json
from ipykernel import get_connection_info
from fastcore.basics import Path
from fastcore.basics import patch
import nbformat

# %% ../nbs/00_core.ipynb 9
N4L_SOLVEIT_ROOT = Path('/app/data')

# %% ../nbs/00_core.ipynb 10
def find_current_notebook():
    # Try SolveIt first (via __dialog_name in call stack)
    try:
        from dialoghelper import find_dname
        dname = find_dname() + ".ipynb"
        if dname: return N4L_SOLVEIT_ROOT / dname
    except (ImportError, ValueError): pass
    
    # Fall back to Jupyter
    try:
        conn_info = get_connection_info()
        if conn_info:
            conn_data = json.loads(conn_info)
            jupyter_session = conn_data.get('jupyter_session')
            if jupyter_session:
                return Path(jupyter_session)
    except RuntimeError:
        pass
    
    return None

# %% ../nbs/00_core.ipynb 12
@patch
def export_n4l_content(self:Path):
    """Add n4l export capability to any Path object"""
    # Load the notebook
    notebook = nbformat.read(self.open(), as_version=4)
    
    # Find n4l cells (your existing logic)
    n4l_contents = []
    for cell in notebook.cells:
        if (cell.cell_type == 'raw' and 
            cell.source.strip().startswith('#| n4l')):
            # Remove the marker line
            lines = cell.source.strip().split('\n')
            content = '\n'.join(lines[1:]).strip()
            n4l_contents.append(content)
    
    # Create output file
    output_path = self.with_suffix('.n4l')
    combined_content = '\n\n'.join(n4l_contents)
    output_path.write_text(combined_content)
    
    return output_path

# %% ../nbs/00_core.ipynb 13
def nbsstorytime_export():
    current_path = find_current_notebook()
    if(current_path): 
        current_path.export_n4l_content()
    else:
        print("no current notebook")

# %% ../nbs/00_core.ipynb 16
def find_dname():
    "Get the message id by searching the call stack for __dialog_id."
    return dh_settings.get('dname', find_var('__dialog_name'))
