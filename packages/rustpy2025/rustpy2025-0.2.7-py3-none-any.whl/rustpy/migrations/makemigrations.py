# rustpy/migrations/makemigrations.py

from .schema import load_schema, save_schema
from .inspect import inspect_models
from datetime import datetime
from rustpy.models.registry import ModelRegistry
import importlib
from pathlib import Path
import os


def get_app_for_model(model, installed_apps):
    mod = model.__module__

    for app in installed_apps:
        if mod.startswith(app):
            return app

    raise RuntimeError(f"Model {model} INSTALLED_APPS ga kirmaydi")


def makemigrations(models=None, installed_apps=None):
    if not installed_apps:
        raise RuntimeError("INSTALLED_APPS berilishi shart")

    if models is None:
        models = ModelRegistry.get_models()

    if not models:
        print("No models found.")
        return

    old = load_schema()
    new = inspect_models(models)

    # ðŸ”¹ app â†’ models mapping
    app_models = {}

    for model in models:
        app = get_app_for_model(model, installed_apps)
        app_models.setdefault(app, []).append(model)

    # ðŸ”¹ app â†’ migrations dir
    app_migration_dirs = {}

    for app in app_models:
        module = importlib.import_module(app)
        app_path = Path(module.__file__).parent
        mig_dir = app_path / "migrations"
        mig_dir.mkdir(exist_ok=True)
        app_migration_dirs[app] = mig_dir

    # ===============================
    # ðŸŸ¢ INITIAL MIGRATION
    # ===============================
    if not old:
        for app, models_in_app in app_models.items():
            mig_dir = app_migration_dirs[app]
            path = mig_dir / "0001_initial.py"

            with open(path, "w", encoding="utf-8") as f:
                f.write("# Generated by rustpy makemigrations\n")
                f.write("def forwards(db):\n")

                for model in models_in_app:
                    table = model._meta["table"]
                    cols = new[table]

                    fields_sql = ", ".join(
                        f"{name} {sql}" for name, sql in cols.items()
                    )

                    f.write(
                        f"    db.execute('CREATE TABLE IF NOT EXISTS {table} ({fields_sql});')\n"
                    )

            print(f"Initial migration created: {path}")

        save_schema(new)
        return

    # ===============================
    # ðŸŸ¡ ALTER TABLE MIGRATIONS
    # ===============================
    name = datetime.now().strftime("%Y%m%d%H%M%S")

    for app, models_in_app in app_models.items():
        stmts = []

        for model in models_in_app:
            table = model._meta["table"]
            cols = new[table]
            old_cols = old.get(table, {})

            for col, sql in cols.items():
                if col not in old_cols:
                    if "NOT NULL" in sql and "DEFAULT" not in sql:
                        sql = sql.replace("NOT NULL", "")
                    stmts.append(
                        f"ALTER TABLE {table} ADD COLUMN {col} {sql};"
                    )

        if not stmts:
            continue

        mig_dir = app_migration_dirs[app]
        path = mig_dir / f"{name}_auto.py"

        with open(path, "w", encoding="utf-8") as f:
            f.write("# Generated by rustpy makemigrations\n")
            f.write("def forwards(db):\n")
            for s in stmts:
                f.write(f"    db.execute('{s}')\n")

        print(f"Created migration: {path}")

    save_schema(new)
