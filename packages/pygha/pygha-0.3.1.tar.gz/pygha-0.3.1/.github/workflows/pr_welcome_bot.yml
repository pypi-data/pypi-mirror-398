name: PR Welcome Bot

on:
  pull_request_target:
    types: [opened, synchronize] # Runs when opened AND when new code is pushed

permissions:
  pull-requests: write

jobs:
  welcome:
    runs-on: ubuntu-latest
    steps:
      - name: Post Welcome Message
        uses: actions/github-script@v7
        with:
          script: |
            // --- Configuration ---
            const author = context.payload.pull_request.user.login;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const hiddenMarker = ''; // Invisible tag to identify our comment

            // --- 1. Analyze Changed Files ---
            const { data: files } = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: prNumber,
            });

            const hasTests = files.some(f => f.filename.startsWith('tests/'));
            const hasDocs = files.some(f => f.filename.startsWith('docs/'));
            const hasChangelog = files.some(f => f.filename.toLowerCase().includes('changelog.md'));

            // --- 2. Build Message Content ---
            let reminders = [];
            
            if (!hasTests) {
              reminders.push("- âš ï¸ **Tests:** I noticed you didn't update any files in `tests/`. If this PR modifies code logic, please ensure relevant tests are added or updated.");
            }
            if (!hasDocs) {
              reminders.push("- ðŸ“š **Docs:** I didn't see any changes to the `docs/` folder. If this adds a new feature or changes behavior, please remember to update the documentation.");
            }
            if (!hasChangelog) {
              reminders.push(`- ðŸ“ **Changelog:** The \`changelog.md\` file wasn't touched. If this is a user-facing change, please [add an entry](https://github.com/${owner}/${repo}/blob/main/changelog.md).`);
            }

            let body = `${hiddenMarker}\n`; // Add marker at the top (invisible in rendered markdown)
            body += `Hi @${author}, this is the **PyGHA bot**! ðŸ¤–\n\n`;
            body += `Thanks for your contribution! We will review your changes and get back to you soon.\n\n`;
            
            if (reminders.length > 0) {
              body += `### Just a quick reminder:\n`;
              body += `I noticed a few things that *might* be missing (but ignore this if they aren't required for your specific change):\n`;
              body += reminders.join("\n");
              body += "\n\n";
            } else {
              body += "All standard checks (Tests, Docs, Changelog) look good! âœ…\n\n";
            }

            body += `Please make sure you've read our [Contributing Guidelines](https://github.com/${owner}/${repo}/blob/main/CONTRIBUTING.md).\n\n`;
            body += `_By contributing, you agree that your contributions will be licensed under the MIT License._`;

            // --- 3. Manage Comments (Delete Old -> Create New) ---
            
            // Fetch existing comments
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
            });

            // Find the previous bot comment using the hidden marker
            const botComment = comments.find(c => c.body.includes(hiddenMarker));

            // Delete it if it exists
            if (botComment) {
              await github.rest.issues.deleteComment({
                owner,
                repo,
                comment_id: botComment.id,
              });
            }

            // Create the new comment at the bottom
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: body
            });
