# -*- coding: utf-8 -*-
"""
Security Checker Core
"""

import re
from typing import Optional, Union, Pattern
import logging

logger = logging.getLogger(__name__)

class SecurityChecker:
    """Core security checker class"""
    
    def __init__(self, base_url):
        self.base_url = base_url
    
    def check_response_pattern(
        self, 
        response, 
        pattern: Union[str, Pattern], 
        case_sensitive: bool = False
    ) -> Optional[str]:
        """
        Check if response matches a pattern
        
        Args:
            response: Response object (must have .text attribute) or string
            pattern: Regex pattern (string or compiled Pattern) or plain string to search
            case_sensitive: Whether pattern matching should be case-sensitive
            
        Returns:
            Matched pattern string if found, None otherwise
            
        Examples:
            >>> checker = SecurityChecker("http://example.com")
            >>> response = type('Response', (), {'text': 'SQL error: syntax error'})()
            >>> checker.check_response_pattern(response, r'sql.*error')
            'SQL error: syntax error'
        """
        try:
            # Extract text from response object or use string directly
            if hasattr(response, 'text'):
                response_text = response.text
            elif isinstance(response, str):
                response_text = response
            else:
                logger.warning("Response must be a string or have .text attribute")
                return None
            
            if not response_text:
                return None
            
            # Prepare pattern
            if isinstance(pattern, Pattern):
                # Already compiled regex
                regex_pattern = pattern
            elif isinstance(pattern, str):
                # Check if it's a regex pattern (contains special chars) or plain string
                if any(char in pattern for char in ['*', '+', '?', '(', ')', '[', ']', '{', '}', '|', '^', '$', '.']):
                    # Treat as regex pattern
                    flags = 0 if case_sensitive else re.IGNORECASE
                    regex_pattern = re.compile(pattern, flags)
                else:
                    # Plain string search
                    if case_sensitive:
                        if pattern in response_text:
                            return pattern
                    else:
                        if pattern.lower() in response_text.lower():
                            return pattern
                    return None
            else:
                logger.warning(f"Invalid pattern type: {type(pattern)}")
                return None
            
            # Search for pattern
            match = regex_pattern.search(response_text)
            if match:
                # Return the matched text
                return match.group(0)
            
            return None
            
        except re.error as e:
            logger.warning(f"Invalid regex pattern '{pattern}': {e}")
            return None
        except Exception as e:
            logger.error(f"Error checking response pattern: {e}")
            return None

