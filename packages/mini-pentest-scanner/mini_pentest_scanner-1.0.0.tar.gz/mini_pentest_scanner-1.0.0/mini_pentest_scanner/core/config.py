"""
Scanner Configuration
"""

import os
from typing import Dict, Any, Optional
from pathlib import Path
import logging

logger = logging.getLogger(__name__)

try:
    import yaml
    YAML_AVAILABLE = True
except ImportError:
    YAML_AVAILABLE = False
    logger.warning("PyYAML not installed. Config file loading will be disabled.")

class ScannerConfig:
    """Scanner configuration with validation"""
    
    def __init__(self, config_file: Optional[str] = None):
        """
        Initialize scanner configuration
        
        Args:
            config_file: Path to config file (optional)
        """
        self.config_file = config_file or 'config.yaml'
        self.config = self._load_default_config()
        self._load_config_file()
        self._validate_config()
    
    def _load_default_config(self) -> Dict[str, Any]:
        """Load default configuration"""
        return {
            'scanner': {
                'mode': 'passive',  # passive | active-light
                'timeout': 10,
                'user_agent': 'SecurityScanner/1.0'
            },
            'policy': {
                'allow_active_light': True,
                'require_authorization': True
            },
            'reports': {
                'output_formats': ['json', 'html'],
                'output_dir': 'reports'
            }
        }
    
    def _load_config_file(self):
        """Load configuration from file if exists"""
        config_path = Path(self.config_file)
        
        # Try absolute path first
        if not config_path.is_absolute():
            # Try current directory
            current_dir = Path.cwd() / config_path
            if current_dir.exists():
                config_path = current_dir
            else:
                # Try package directory
                package_dir = Path(__file__).parent.parent.parent / config_path
                if package_dir.exists():
                    config_path = package_dir
        
        if config_path.exists():
            try:
                if YAML_AVAILABLE:
                    with open(config_path, 'r', encoding='utf-8') as f:
                        file_config = yaml.safe_load(f) or {}
                        # Merge with defaults
                        self._merge_config(self.config, file_config)
                        logger.info(f"Loaded config from {config_path}")
                else:
                    logger.warning("PyYAML not available. Using default configuration.")
            except Exception as e:
                logger.warning(f"Could not load config file {config_path}: {e}")
        else:
            logger.debug(f"Config file not found: {config_path}. Using defaults.")
    
    def _merge_config(self, base: Dict, override: Dict):
        """Recursively merge config dictionaries"""
        for key, value in override.items():
            if key in base and isinstance(base[key], dict) and isinstance(value, dict):
                self._merge_config(base[key], value)
            else:
                base[key] = value
    
    def _validate_config(self):
        """Validate configuration values"""
        # Validate scanner mode
        mode = self.get('scanner.mode', 'passive')
        if mode not in ['passive', 'active-light']:
            logger.warning(f"Invalid scanner mode: {mode}. Using 'passive'.")
            self.set('scanner.mode', 'passive')
        
        # Validate timeout
        timeout = self.get('scanner.timeout', 10)
        if not isinstance(timeout, int) or timeout < 1:
            logger.warning(f"Invalid timeout: {timeout}. Using 10.")
            self.set('scanner.timeout', 10)
        
        # Validate output formats
        formats = self.get('reports.output_formats', ['json'])
        valid_formats = ['json', 'html', 'pdf']
        formats = [f for f in formats if f in valid_formats]
        if not formats:
            formats = ['json']
        self.set('reports.output_formats', formats)
    
    def get(self, key: str, default: Any = None) -> Any:
        """
        Get config value by dot-separated key
        
        Args:
            key: Dot-separated key (e.g., 'scanner.mode')
            default: Default value if key not found
            
        Returns:
            Config value or default
        """
        keys = key.split('.')
        value = self.config
        try:
            for k in keys:
                if isinstance(value, dict) and k in value:
                    value = value[k]
                else:
                    return default
            return value
        except (TypeError, AttributeError):
            return default
    
    def set(self, key: str, value: Any):
        """
        Set config value by dot-separated key
        
        Args:
            key: Dot-separated key
            value: Value to set
        """
        keys = key.split('.')
        config = self.config
        for k in keys[:-1]:
            if k not in config:
                config[k] = {}
            elif not isinstance(config[k], dict):
                config[k] = {}
            config = config[k]
        config[keys[-1]] = value
    
    def get_scanner_mode(self) -> str:
        """Get scanner mode"""
        return self.get('scanner.mode', 'passive')
    
    def get_timeout(self) -> int:
        """Get timeout"""
        return self.get('scanner.timeout', 10)
    
    def get_user_agent(self) -> str:
        """Get user agent"""
        return self.get('scanner.user_agent', 'SecurityScanner/1.0')
    
    def allow_active_light(self) -> bool:
        """Check if active-light mode is allowed"""
        return self.get('policy.allow_active_light', True)
    
    def require_authorization(self) -> bool:
        """Check if authorization is required"""
        return self.get('policy.require_authorization', True)
