# -*- coding: utf-8 -*-
"""
Baseline Security Management
จัดการ Baseline Security สำหรับเปรียบเทียบ
"""

from typing import Optional, Dict, Any
import logging

logger = logging.getLogger(__name__)

class BaselineManager:
    """Manage security baselines"""
    
    def __init__(self, history_db):
        """
        Initialize baseline manager
        
        Args:
            history_db: ScanHistoryDB instance
        """
        self.db = history_db
    
    def set_baseline(self, target_url: str, scan_id: str) -> bool:
        """
        Set a scan as baseline for a target
        
        Args:
            target_url: Target URL
            scan_id: Scan ID to use as baseline
            
        Returns:
            True if successful
            
        Raises:
            ValueError: If parameters are invalid or scan not found
        """
        if not target_url:
            raise ValueError("target_url cannot be empty")
        if not scan_id:
            raise ValueError("scan_id cannot be empty")
        
        conn = self.db.db_path
        import sqlite3
        
        conn_db = sqlite3.connect(str(conn))
        cursor = conn_db.cursor()
        
        try:
            # Get scan summary first to validate
            scan = self.db.get_scan_summary(scan_id)
            if not scan:
                raise ValueError(f"Scan {scan_id} not found")
            
            # Deactivate old baselines for this target
            cursor.execute('''
                UPDATE baselines 
                SET is_active = 0 
                WHERE target_url = ? AND is_active = 1
            ''', (target_url,))
            
            # Create new baseline
            from datetime import datetime
            now = datetime.utcnow().isoformat()
            
            cursor.execute('''
                INSERT INTO baselines 
                (target_url, baseline_scan_id, risk_score, total_findings, created_at, is_active)
                VALUES (?, ?, ?, ?, ?, 1)
            ''', (target_url, scan_id, scan.get('risk_score', 0), 
                  scan.get('total_findings', 0), now))
            
            conn_db.commit()
            logger.info(f"Baseline set for {target_url}: {scan_id}")
            return True
            
        except ValueError:
            # Re-raise ValueError (validation errors)
            conn_db.rollback()
            raise
        except Exception as e:
            conn_db.rollback()
            logger.error(f"Error setting baseline: {e}")
            raise RuntimeError(f"Failed to set baseline: {e}") from e
        finally:
            conn_db.close()
    
    def get_baseline(self, target_url: str) -> Optional[str]:
        """
        Get baseline scan ID for a target
        
        Args:
            target_url: Target URL
            
        Returns:
            Baseline scan ID or None
        """
        import sqlite3
        
        conn = sqlite3.connect(str(self.db.db_path))
        cursor = conn.cursor()
        
        try:
            cursor.execute('''
                SELECT baseline_scan_id FROM baselines 
                WHERE target_url = ? AND is_active = 1
                ORDER BY created_at DESC
                LIMIT 1
            ''', (target_url,))
            
            row = cursor.fetchone()
            return row[0] if row else None
            
        except Exception as e:
            logger.error(f"Error getting baseline: {e}")
            return None
        finally:
            conn.close()
    
    def get_baseline_info(self, target_url: str) -> Optional[Dict[str, Any]]:
        """
        Get baseline information
        
        Args:
            target_url: Target URL
            
        Returns:
            Baseline information dictionary
        """
        import sqlite3
        
        conn = sqlite3.connect(str(self.db.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        
        try:
            cursor.execute('''
                SELECT b.*, s.scan_time, s.scanner_mode
                FROM baselines b
                JOIN scans s ON b.baseline_scan_id = s.scan_id
                WHERE b.target_url = ? AND b.is_active = 1
                ORDER BY b.created_at DESC
                LIMIT 1
            ''', (target_url,))
            
            row = cursor.fetchone()
            if row:
                return dict(row)
            return None
            
        except Exception as e:
            logger.error(f"Error getting baseline info: {e}")
            return None
        finally:
            conn.close()
    
    def list_baselines(self) -> list:
        """List all active baselines"""
        import sqlite3
        
        conn = sqlite3.connect(str(self.db.db_path))
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        
        try:
            cursor.execute('''
                SELECT b.*, s.scan_time, s.scanner_mode
                FROM baselines b
                JOIN scans s ON b.baseline_scan_id = s.scan_id
                WHERE b.is_active = 1
                ORDER BY b.created_at DESC
            ''')
            
            rows = cursor.fetchall()
            return [dict(row) for row in rows]
            
        except Exception as e:
            logger.error(f"Error listing baselines: {e}")
            return []
        finally:
            conn.close()

