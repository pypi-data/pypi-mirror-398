# -*- coding: utf-8 -*-
"""
Security Scanner - Non-intrusive Security Assessment Tool
Non-intrusive Security Assessment Tool

Note: For educational purposes only
Not an attack tool, but a security assessment tool
"""

import sys
import argparse
from pathlib import Path
from typing import Optional, List
import logging

from .core.engine import ScannerEngine
from .core.config import ScannerConfig
from .core.result import ScanResult
from .checks import (
    sql_injection, xss, idor, information_disclosure,
    authentication, session_management
)

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class SecurityScanner:
    """Main Security Scanner Class"""
    
    def __init__(self, base_url: str, config: Optional[ScannerConfig] = None):
        """
        Initialize security scanner
        
        Args:
            base_url: Target URL to scan
            config: Scanner configuration (optional)
        """
        if not base_url:
            raise ValueError("base_url cannot be empty")
        
        self.base_url = base_url
        self.config = config or ScannerConfig()
        self.engine = ScannerEngine(base_url, self.config)
        self._register_checks()
        logger.info(f"SecurityScanner initialized for {base_url}")
    
    def _register_checks(self):
        """Register all security checks"""
        try:
            # Register checks with engine
            self.engine.register_check(
                sql_injection.check_new,
                "SQL Injection Indicators",
                "Injection"
            )
            self.engine.register_check(
                xss.check_new,
                "XSS Risk Indicators",
                "Injection"
            )
            self.engine.register_check(
                idor.check_new,
                "Insecure Direct Object Reference (IDOR)",
                "Access Control"
            )
            self.engine.register_check(
                information_disclosure.check_new,
                "Information Disclosure",
                "Security Misconfiguration"
            )
            self.engine.register_check(
                authentication.check_new,
                "Authentication Issues",
                "Authentication"
            )
            self.engine.register_check(
                session_management.check_new,
                "Session Management",
                "Authentication"
            )
            logger.debug("All checks registered successfully")
        except Exception as e:
            logger.error(f"Error registering checks: {e}")
            raise
    
    def scan(self, policy: Optional[str] = None, enabled_checks: Optional[List[str]] = None) -> ScanResult:
        """
        Run security scan
        
        Args:
            policy: Scan policy ('passive' or 'active-light')
            enabled_checks: List of check names to run (None = all)
            
        Returns:
            ScanResult object
        """
        # Set policy if provided
        if policy:
            if policy not in ['passive', 'active-light']:
                raise ValueError(f"Invalid policy: {policy}. Must be 'passive' or 'active-light'")
            self.config.set('scanner.mode', policy)
            self.engine.scan_result.metadata.scanner_mode = policy
        
        # Run scan
        try:
            result = self.engine.run_scan(enabled_checks)
            
            # Generate and save reports
            self._generate_reports(result)
            
            # Save to history database (if available)
            try:
                from .history.database import ScanHistoryDB
                history_db = ScanHistoryDB()
                history_db.save_scan(result.to_dict())
                logger.info("Scan saved to history database")
            except Exception as e:
                logger.debug(f"Could not save to history database: {e}")
            
            return result
        except KeyboardInterrupt:
            logger.info("Scan interrupted by user")
            raise
        except Exception as e:
            logger.error(f"Error during scan: {e}", exc_info=True)
            raise
    
    def _generate_reports(self, result: ScanResult):
        """
        Generate reports in multiple formats
        
        Args:
            result: ScanResult object
        """
        try:
            # Use current working directory for reports
            reports_dir_name = self.config.get('reports.output_dir', 'reports')
            output_dir = Path.cwd() / reports_dir_name
            formats = self.config.get('reports.output_formats', ['json'])
            
            # Validate formats
            valid_formats = ['json', 'html', 'pdf']
            formats = [f for f in formats if f in valid_formats]
            if not formats:
                formats = ['json']
            
            # Create output directories
            for fmt in formats:
                (output_dir / fmt).mkdir(parents=True, exist_ok=True)
            
            # Generate timestamp
            from datetime import datetime
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            
            # Save JSON
            if 'json' in formats:
                try:
                    json_path = output_dir / 'json' / f'scan_{timestamp}.json'
                    result.save_json(str(json_path))
                    print(f"üìÑ JSON Report: {json_path}")
                    logger.info(f"JSON report saved: {json_path}")
                except Exception as e:
                    logger.error(f"Error saving JSON report: {e}")
            
            # Save HTML
            if 'html' in formats:
                try:
                    html_path = output_dir / 'html' / f'scan_{timestamp}.html'
                    self._generate_html_report(result, html_path)
                    print(f"üìÑ HTML Report: {html_path}")
                    logger.info(f"HTML report saved: {html_path}")
                except Exception as e:
                    logger.error(f"Error saving HTML report: {e}")
            
            # Save PDF
            if 'pdf' in formats:
                try:
                    from .reports.pdf_generator import PDFReportGenerator
                    pdf_path = output_dir / 'pdf' / f'scan_{timestamp}.pdf'
                    generator = PDFReportGenerator()
                    if generator.generate(result, pdf_path):
                        print(f"üìÑ PDF Report: {pdf_path}")
                        logger.info(f"PDF report saved: {pdf_path}")
                    else:
                        print(f"‚ö†Ô∏è  Warning: Failed to generate PDF report")
                        logger.warning("PDF report generation failed")
                except ImportError as e:
                    print(f"‚ö†Ô∏è  Warning: PDF generation requires reportlab. Install with: pip install reportlab")
                    logger.warning(f"PDF generation not available: {e}")
                except Exception as e:
                    logger.error(f"Error generating PDF report: {e}")
                    print(f"‚ö†Ô∏è  Warning: Error generating PDF report: {e}")
        except Exception as e:
            logger.error(f"Error generating reports: {e}", exc_info=True)
            print(f"‚ö†Ô∏è  Warning: Error generating reports: {e}")
    
    def _generate_html_report(self, result: ScanResult, filepath: Path):
        """
        Generate HTML report
        
        Args:
            result: ScanResult object
            filepath: Path to save HTML file
        """
        try:
            html_content = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Scan Report - {result.target}</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
        .container {{ max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }}
        h1 {{ color: #1e3c72; }}
        .summary {{ background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }}
        .finding {{ border-left: 4px solid #dc3545; padding: 15px; margin: 15px 0; background: #fff; }}
        .finding.high {{ border-color: #dc3545; }}
        .finding.medium {{ border-color: #ffc107; }}
        .finding.low {{ border-color: #17a2b8; }}
        .severity {{ font-weight: bold; }}
        .severity.critical {{ color: #dc3545; }}
        .severity.high {{ color: #dc3545; }}
        .severity.medium {{ color: #ffc107; }}
        .severity.low {{ color: #17a2b8; }}
    </style>
</head>
<body>
    <div class="container">
        <h1>Security Scan Report</h1>
        <p><strong>Target:</strong> {result.target}</p>
        <p><strong>Scan Time:</strong> {result.scan_time}</p>
        <p><strong>Scan ID:</strong> {result.scan_id}</p>
        
        <div class="summary">
            <h2>Summary</h2>
            <p><strong>Total Checks:</strong> {result.summary.total_checks}</p>
            <p><strong>Total Findings:</strong> {result.summary.total_findings}</p>
            <p><strong>Risk Score:</strong> {result.summary.risk_score}/100</p>
            <p><strong>Severity Breakdown:</strong></p>
            <ul>
                <li>Critical: {result.summary.severity_count.get('critical', 0)}</li>
                <li>High: {result.summary.severity_count.get('high', 0)}</li>
                <li>Medium: {result.summary.severity_count.get('medium', 0)}</li>
                <li>Low: {result.summary.severity_count.get('low', 0)}</li>
            </ul>
        </div>
        
        <h2>Findings</h2>
"""
            
            for finding in result.findings:
                html_content += f"""
        <div class="finding {finding.severity}">
            <h3>{finding.title} <span class="severity {finding.severity}">[{finding.severity.upper()}]</span></h3>
            <p><strong>Category:</strong> {finding.category}</p>
            <p><strong>Confidence:</strong> {finding.confidence}</p>
            <p><strong>Description:</strong> {finding.description}</p>
            <p><strong>Impact:</strong> {finding.impact}</p>
            <p><strong>Location:</strong> {finding.location.path or 'N/A'} ({finding.location.method or 'N/A'})</p>
            <p><strong>Recommendation:</strong> {finding.recommendation}</p>
        </div>
"""
            
            html_content += """
    </div>
</body>
</html>
"""
            
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(html_content)
        except Exception as e:
            logger.error(f"Error generating HTML report: {e}", exc_info=True)
            raise

def main():
    """Main entry point"""
    parser = argparse.ArgumentParser(
        description='Security Scanner - Non-intrusive Security Assessment Tool'
    )
    parser.add_argument('target', help='Target URL to scan')
    parser.add_argument(
        '--policy',
        choices=['passive', 'active-light'],
        default='passive',
        help='Scan policy (default: passive)'
    )
    parser.add_argument(
        '--config',
        help='Path to config file (default: config.yaml)'
    )
    parser.add_argument(
        '--checks',
        nargs='+',
        help='Specific checks to run (default: all)'
    )
    parser.add_argument(
        '--verbose', '-v',
        action='store_true',
        help='Enable verbose logging'
    )
    
    args = parser.parse_args()
    
    # Set logging level
    if args.verbose:
        logging.getLogger().setLevel(logging.DEBUG)
    
    try:
        # Load config
        config = ScannerConfig(args.config) if args.config else ScannerConfig()
        
        # Create scanner
        scanner = SecurityScanner(args.target, config)
        
        # Run scan
        result = scanner.scan(policy=args.policy, enabled_checks=args.checks)
        
        # Print summary
        print("\n" + "=" * 60)
        print("üìä Scan Summary")
        print("=" * 60)
        print(f"Total Checks: {result.summary.total_checks}")
        print(f"Total Findings: {result.summary.total_findings}")
        print(f"Risk Score: {result.summary.risk_score}/100")
        print(f"Severity: Critical={result.summary.severity_count.get('critical', 0)}, "
              f"High={result.summary.severity_count.get('high', 0)}, "
              f"Medium={result.summary.severity_count.get('medium', 0)}, "
              f"Low={result.summary.severity_count.get('low', 0)}")
        print("=" * 60)
        print("üí° Remember: This is for educational purposes only!")
        print("=" * 60)
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  Scan interrupted by user")
        sys.exit(130)
    except Exception as e:
        logger.error(f"Fatal error: {e}", exc_info=True)
        print(f"\n‚ùå Error: {e}")
        sys.exit(1)

if __name__ == '__main__':
    main()
