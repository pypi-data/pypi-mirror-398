"""
Mini Pentest Lab - Vulnerable App
‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà

‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡πÉ‡∏ô production
"""

from flask import Flask, render_template, request, redirect, url_for, session, flash, jsonify
from flask import make_response
import sqlite3
import os
import hashlib
import secrets
from datetime import datetime
from app.auth import init_auth, check_auth, get_user_info
from app.routes import init_routes
from app.i18n import init_i18n, set_locale, get_locale

# Initialize Flask app
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ template folder ‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà templates directory ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
template_dir = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'templates')
app = Flask(__name__, template_folder=template_dir)
app.secret_key = 'dev-secret-key-change-in-production'  # ‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà: secret key ‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠

# Database path
DB_PATH = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'database', 'app.db')

def init_database():
    """Initialize database with sample data"""
    os.makedirs(os.path.dirname(DB_PATH), exist_ok=True)
    
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    
    # Create users table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password TEXT NOT NULL,
            email TEXT,
            role TEXT DEFAULT 'user',
            created_at TEXT
        )
    ''')
    
    # Create posts table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS posts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            title TEXT,
            content TEXT,
            created_at TEXT,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    # Create sessions table (simple session management)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS sessions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            session_token TEXT,
            created_at TEXT,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    # Insert sample data if not exists
    cursor.execute('SELECT COUNT(*) FROM users')
    if cursor.fetchone()[0] == 0:
        # Default admin user (weak password for demo)
        cursor.execute('''
            INSERT INTO users (username, password, email, role, created_at)
            VALUES (?, ?, ?, ?, ?)
        ''', ('admin', 'admin123', 'admin@lab.local', 'admin', datetime.now().isoformat()))
        
        # Default regular user
        cursor.execute('''
            INSERT INTO users (username, password, email, role, created_at)
            VALUES (?, ?, ?, ?, ?)
        ''', ('user1', 'password123', 'user1@lab.local', 'user', datetime.now().isoformat()))
        
        # Sample post
        cursor.execute('''
            INSERT INTO posts (user_id, title, content, created_at)
            VALUES (?, ?, ?, ?)
        ''', (1, 'Welcome Post', 'This is a sample post for testing.', datetime.now().isoformat()))
    
    conn.commit()
    conn.close()

# Initialize components
init_database()
init_i18n(app)  # Initialize i18n
init_auth(app, DB_PATH)
init_routes(app, DB_PATH)

# Language switching route
@app.route('/lang/<lang>')
def change_language(lang):
    """Change language"""
    set_locale(lang)
    return redirect(request.referrer or url_for('index'))

@app.route('/')
def index():
    """Home page"""
    return render_template('index.html')

@app.errorhandler(404)
def not_found(error):
    """Custom 404 handler - ‚ö†Ô∏è ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"""
    return render_template('error.html', 
                         error_code=404, 
                         error_message=f"Page not found: {request.path}"), 404

@app.errorhandler(500)
def internal_error(error):
    """Custom 500 handler - ‚ö†Ô∏è ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"""
    return render_template('error.html', 
                         error_code=500, 
                         error_message=str(error)), 500

if __name__ == '__main__':
    print("=" * 60)
    print("üß™ Mini Pentest Lab - Vulnerable App")
    print("‚ö†Ô∏è  ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!")
    print("=" * 60)
    print(f"üìÅ Database: {DB_PATH}")
    print("üåê Server starting on http://127.0.0.1:5000")
    print("=" * 60)
    
    app.run(debug=True, host='127.0.0.1', port=5000)

