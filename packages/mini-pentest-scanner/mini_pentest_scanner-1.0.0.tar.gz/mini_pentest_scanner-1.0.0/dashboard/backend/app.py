"""
Dashboard Backend API
API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà (‡πÉ‡∏ä‡πâ Result Schema ‡πÉ‡∏´‡∏°‡πà)
"""

from flask import Flask, jsonify, request, send_from_directory
from flask_cors import CORS
import json
import os
from datetime import datetime
from pathlib import Path
import sys
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Add scanner to path
scanner_path = os.path.join(os.path.dirname(__file__), '../../mini_pentest_scanner')
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../..'))

try:
    from mini_pentest_scanner.scanner import SecurityScanner
    from mini_pentest_scanner.core.config import ScannerConfig
    from mini_pentest_scanner.core.result import ScanResult
    from mini_pentest_scanner.history.database import ScanHistoryDB
    from mini_pentest_scanner.history.comparison import ScanComparison
    from mini_pentest_scanner.history.trends import TrendAnalyzer
    from mini_pentest_scanner.history.baseline import BaselineManager
    from mini_pentest_scanner.history.compliance import ComplianceMapper
    
    # Initialize history database
    history_db = ScanHistoryDB(db_path=os.path.join(os.path.dirname(__file__), '../../scan_history.db'))
    HAS_HISTORY = True
except ImportError as e:
    print(f"Warning: History features not available: {e}")
    HAS_HISTORY = False
    history_db = None

app = Flask(__name__, static_folder='../frontend', static_url_path='')
CORS(app)  # Enable CORS for frontend

# Store scan results in memory (fallback if history not available)
scan_history = []
current_scan = None

@app.route('/')
def index():
    """Serve frontend"""
    return send_from_directory('../frontend', 'index.html')

@app.route('/api/scan', methods=['POST'])
def start_scan():
    """Start a new scan using new SecurityScanner"""
    global current_scan
    
    data = request.json
    target_url = data.get('url', '')
    policy = data.get('policy', 'passive')  # passive or active-light
    
    if not target_url:
        return jsonify({'error': 'URL is required'}), 400
    
    try:
        # Load config
        config_path = os.path.join(os.path.dirname(__file__), '../../config.yaml')
        config = ScannerConfig(config_path if os.path.exists(config_path) else None)
        
        # Create scanner
        scanner = SecurityScanner(target_url, config)
        
        # Store scan info
        scan_info = {
            'id': len(scan_history) + 1,
            'url': target_url,
            'policy': policy,
            'status': 'running',
            'started_at': datetime.now().isoformat(),
            'results': None
        }
        scan_history.append(scan_info)
        current_scan = scan_info
        
        # Run scan
        result = scanner.scan(policy=policy)
        
        # Convert ScanResult to dict
        scan_info['status'] = 'completed'
        scan_info['completed_at'] = datetime.now().isoformat()
        scan_info['results'] = result.to_dict()
        
        # Save to history database if available
        if HAS_HISTORY and history_db:
            try:
                history_db.save_scan(result.to_dict())
            except Exception as e:
                logger.error(f"Error saving to history: {e}")
        
        return jsonify({
            'scan_id': scan_info['id'],
            'status': 'completed',
            'results': result.to_dict()
        })
    
    except Exception as e:
        if current_scan:
            current_scan['status'] = 'error'
            current_scan['error'] = str(e)
        return jsonify({'error': str(e)}), 500

@app.route('/api/scan/<int:scan_id>', methods=['GET'])
def get_scan(scan_id):
    """Get scan results by ID"""
    scan = next((s for s in scan_history if s['id'] == scan_id), None)
    
    if not scan:
        return jsonify({'error': 'Scan not found'}), 404
    
    return jsonify(scan)

@app.route('/api/scans', methods=['GET'])
def get_scans():
    """Get all scan history"""
    return jsonify({
        'scans': scan_history,
        'total': len(scan_history)
    })

@app.route('/api/scan/current', methods=['GET'])
def get_current_scan():
    """Get current scan status"""
    if current_scan:
        return jsonify(current_scan)
    return jsonify({'status': 'idle'})

@app.route('/api/reports/<int:scan_id>', methods=['GET'])
def get_report(scan_id):
    """Get report file for a scan"""
    scan = next((s for s in scan_history if s['id'] == scan_id), None)
    
    if not scan:
        return jsonify({'error': 'Scan not found'}), 404
    
    if not scan.get('results'):
        return jsonify({'error': 'No results available'}), 404
    
    # Try to find report file
    reports_dir = Path(os.path.join(os.path.dirname(__file__), '../../reports/json'))
    if reports_dir.exists():
        # Find latest report (simplified - in production use scan_id mapping)
        reports = sorted(reports_dir.glob('scan_*.json'), key=os.path.getmtime, reverse=True)
        if reports:
            with open(reports[0], 'r', encoding='utf-8') as f:
                return jsonify(json.load(f))
    
    # Return in-memory result
    return jsonify(scan['results'])

@app.route('/api/stats', methods=['GET'])
def get_stats():
    """Get statistics from scan history"""
    if HAS_HISTORY and history_db:
        # Use database for stats
        scans = history_db.get_all_scans(limit=1000)
        total_scans = len(scans)
        completed_scans = total_scans
        
        total_findings = sum(s.get('total_findings', 0) for s in scans)
        total_risk_score = sum(s.get('risk_score', 0) for s in scans)
        avg_risk_score = total_risk_score / completed_scans if completed_scans > 0 else 0
        
        # Calculate severity counts
        severity_count = {'critical': 0, 'high': 0, 'medium': 0, 'low': 0}
        for scan in scans:
            scan_result = history_db.get_scan(scan.get('scan_id'))
            if scan_result:
                summary = scan_result.get('summary', {})
                for severity, count in summary.get('severity_count', {}).items():
                    severity_count[severity] = severity_count.get(severity, 0) + count
    else:
        # Fallback to in-memory
        total_scans = len(scan_history)
        completed_scans = len([s for s in scan_history if s['status'] == 'completed'])
        
        total_findings = 0
        severity_count = {'critical': 0, 'high': 0, 'medium': 0, 'low': 0}
        total_risk_score = 0
        
        for scan in scan_history:
            if scan.get('results') and 'summary' in scan['results']:
                summary = scan['results']['summary']
                total_findings += summary.get('total_findings', 0)
                for severity, count in summary.get('severity_count', {}).items():
                    severity_count[severity] = severity_count.get(severity, 0) + count
                total_risk_score += summary.get('risk_score', 0)
        
        avg_risk_score = total_risk_score / completed_scans if completed_scans > 0 else 0
    
    return jsonify({
        'total_scans': total_scans,
        'completed_scans': completed_scans,
        'total_findings': total_findings,
        'severity_count': severity_count,
        'average_risk_score': round(avg_risk_score, 2)
    })

@app.route('/api/history', methods=['GET'])
def get_history():
    """Get scan history"""
    if not HAS_HISTORY or not history_db:
        return jsonify({'error': 'History features not available'}), 503
    
    target_url = request.args.get('target')
    limit_str = request.args.get('limit', '100')
    
    try:
        limit = int(limit_str)
        if limit <= 0:
            limit = 100
        if limit > 10000:
            limit = 10000
    except (ValueError, TypeError):
        limit = 100
    
    try:
        if target_url:
            scans = history_db.get_scans_by_target(target_url, limit=limit)
        else:
            scans = history_db.get_all_scans(limit=limit)
        
        return jsonify({
            'scans': scans,
            'total': len(scans)
        })
    except Exception as e:
        logger.error(f"Error getting history: {e}", exc_info=True)
        return jsonify({'error': 'Internal server error'}), 500

@app.route('/api/history/<scan_id>', methods=['GET'])
def get_history_scan(scan_id):
    """Get specific scan from history"""
    if not HAS_HISTORY or not history_db:
        return jsonify({'error': 'History features not available'}), 503
    
    scan = history_db.get_scan(scan_id)
    if not scan:
        return jsonify({'error': 'Scan not found'}), 404
    
    return jsonify(scan)

@app.route('/api/compare/<scan_id1>/<scan_id2>', methods=['GET'])
def compare_scans(scan_id1, scan_id2):
    """Compare two scans"""
    if not HAS_HISTORY or not history_db:
        return jsonify({'error': 'History features not available'}), 503
    
    try:
        comparison = ScanComparison(history_db)
        result = comparison.compare_scans(scan_id1, scan_id2)
        return jsonify(result)
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error comparing scans: {e}", exc_info=True)
        return jsonify({'error': 'Internal server error'}), 500

@app.route('/api/trends', methods=['GET'])
def get_trends():
    """Get trend analysis for a target"""
    if not HAS_HISTORY or not history_db:
        return jsonify({'error': 'History features not available'}), 503
    
    target_url = request.args.get('target')
    days_str = request.args.get('days', '30')
    
    if not target_url:
        return jsonify({'error': 'target parameter required'}), 400
    
    try:
        days = int(days_str)
        if days <= 0:
            return jsonify({'error': 'days must be greater than 0'}), 400
    except ValueError:
        return jsonify({'error': 'days must be a valid integer'}), 400
    
    try:
        analyzer = TrendAnalyzer(history_db)
        trends = analyzer.analyze_trends(target_url, days=days)
        return jsonify(trends)
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error analyzing trends: {e}", exc_info=True)
        return jsonify({'error': 'Internal server error'}), 500

@app.route('/api/baseline', methods=['POST'])
def set_baseline():
    """Set baseline for a target"""
    if not HAS_HISTORY or not history_db:
        return jsonify({'error': 'History features not available'}), 503
    
    if not request.json:
        return jsonify({'error': 'JSON body required'}), 400
    
    data = request.json
    target_url = data.get('target')
    scan_id = data.get('scan_id')
    
    if not target_url or not scan_id:
        return jsonify({'error': 'target and scan_id required'}), 400
    
    try:
        baseline_mgr = BaselineManager(history_db)
        success = baseline_mgr.set_baseline(target_url, scan_id)
        if success:
            return jsonify({'status': 'success', 'message': 'Baseline set'})
        else:
            return jsonify({'error': 'Failed to set baseline'}), 500
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error setting baseline: {e}", exc_info=True)
        return jsonify({'error': 'Internal server error'}), 500

@app.route('/api/baseline/<target_url>', methods=['GET'])
def get_baseline(target_url):
    """Get baseline for a target"""
    if not HAS_HISTORY or not history_db:
        return jsonify({'error': 'History features not available'}), 503
    
    try:
        baseline_mgr = BaselineManager(history_db)
        baseline_info = baseline_mgr.get_baseline_info(target_url)
        if baseline_info:
            return jsonify(baseline_info)
        else:
            return jsonify({'has_baseline': False})
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/compliance/<scan_id>', methods=['GET'])
def get_compliance(scan_id):
    """Get compliance mapping for a scan"""
    if not HAS_HISTORY or not history_db:
        return jsonify({'error': 'History features not available'}), 503
    
    if not scan_id:
        return jsonify({'error': 'scan_id required'}), 400
    
    standards_str = request.args.get('standards', '')
    standards = [s.strip() for s in standards_str.split(',') if s.strip()] if standards_str else []
    
    try:
        mapper = ComplianceMapper(history_db)
        result = mapper.map_scan_to_compliance(scan_id, standards if standards else None)
        return jsonify(result)
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error mapping compliance: {e}", exc_info=True)
        return jsonify({'error': 'Internal server error'}), 500

if __name__ == '__main__':
    print("=" * 60)
    print("üìä Mini Pentest Lab - Dashboard Backend")
    print("=" * 60)
    print("üåê Server starting on http://127.0.0.1:5001")
    print("=" * 60)
    
    app.run(debug=True, host='127.0.0.1', port=5001)
