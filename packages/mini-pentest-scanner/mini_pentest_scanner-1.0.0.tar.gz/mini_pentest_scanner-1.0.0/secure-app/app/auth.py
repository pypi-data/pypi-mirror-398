"""
Authentication Module - Secure Version
แก้ไขช่องโหว่ทั้งหมดแล้ว
"""

import sqlite3
import bcrypt
import secrets
from functools import wraps
from flask import session, redirect, url_for, request, flash, render_template
from app.security import validate_username, validate_password, validate_email, validate_input

def init_auth(app, db_path):
    """Initialize authentication system"""
    
    @app.route('/login', methods=['GET', 'POST'])
    def login():
        """Login page - ✅ Fixed: Parameterized queries, strong hashing"""
        if request.method == 'POST':
            username = request.form.get('username', '')
            password = request.form.get('password', '')
            
            # ✅ Input validation
            is_valid, error = validate_username(username)
            if not is_valid:
                flash(error, 'error')
                return render_template('login.html')
            
            if not password:
                flash('Password is required', 'error')
                return render_template('login.html')
            
            # ✅ Parameterized query (no SQL Injection)
            conn = sqlite3.connect(db_path)
            cursor = conn.cursor()
            
            try:
                cursor.execute(
                    "SELECT id, username, email, role, password FROM users WHERE username=?",
                    (username,)
                )
                user = cursor.fetchone()
                
                if user:
                    # ✅ Strong password verification (bcrypt)
                    stored_hash = user[4]
                    if bcrypt.checkpw(password.encode(), stored_hash.encode()):
                        # ✅ Regenerate session ID (prevent session fixation)
                        session.clear()
                        session.permanent = True
                        
                        session['user_id'] = user[0]
                        session['username'] = user[1]
                        session['email'] = user[2]
                        session['role'] = user[3]
                        session['logged_in'] = True
                        session['last_activity'] = datetime.now().isoformat()
                        
                        flash(f'Welcome back, {user[1]}!', 'success')
                        return redirect(url_for('dashboard'))
                
                # ✅ Generic error message (prevent account enumeration)
                flash('Invalid username or password', 'error')
                
            except Exception as e:
                # ✅ Log error but show generic message
                app.logger.error(f"Login error: {e}")
                flash('An error occurred. Please try again later.', 'error')
            finally:
                conn.close()
        
        return render_template('login.html')
    
    @app.route('/logout')
    def logout():
        """Logout - ✅ Properly clear session"""
        session.clear()
        flash('You have been logged out', 'info')
        return redirect(url_for('index'))
    
    @app.route('/register', methods=['GET', 'POST'])
    def register():
        """Registration page - ✅ Fixed: Input validation, strong hashing"""
        if request.method == 'POST':
            username = request.form.get('username', '')
            password = request.form.get('password', '')
            email = request.form.get('email', '')
            
            # ✅ Input validation
            is_valid, error = validate_username(username)
            if not is_valid:
                flash(error, 'error')
                return render_template('register.html')
            
            is_valid, error = validate_password(password)
            if not is_valid:
                flash(error, 'error')
                return render_template('register.html')
            
            is_valid, error = validate_email(email)
            if not is_valid:
                flash(error, 'error')
                return render_template('register.html')
            
            # ✅ Strong password hashing (bcrypt)
            password_hash = bcrypt.hashpw(password.encode(), bcrypt.gensalt()).decode()
            
            conn = sqlite3.connect(db_path)
            cursor = conn.cursor()
            
            try:
                # ✅ Parameterized query
                cursor.execute(
                    "INSERT INTO users (username, password, email, role, created_at) VALUES (?, ?, ?, ?, ?)",
                    (username, password_hash, email, 'user', datetime.now().isoformat())
                )
                conn.commit()
                flash('Registration successful! Please login.', 'success')
                return redirect(url_for('login'))
            except sqlite3.IntegrityError:
                flash('Username already exists', 'error')
            except Exception as e:
                app.logger.error(f"Registration error: {e}")
                flash('Registration failed. Please try again.', 'error')
            finally:
                conn.close()
        
        return render_template('register.html')

def check_auth():
    """Check if user is authenticated"""
    return session.get('logged_in', False)

def get_user_info():
    """Get current user information"""
    if check_auth():
        return {
            'id': session.get('user_id'),
            'username': session.get('username'),
            'email': session.get('email'),
            'role': session.get('role')
        }
    return None

def require_auth(f):
    """Decorator to require authentication"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not check_auth():
            flash('Please login to access this page', 'error')
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

def require_admin(f):
    """Decorator to require admin role - ✅ Fixed: Verify from database"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not check_auth():
            flash('Please login to access this page', 'error')
            return redirect(url_for('login'))
        
        # ✅ Verify role from database (not just session)
        user = get_user_info()
        if not user or user['role'] != 'admin':
            flash('Access denied. Admin privileges required.', 'error')
            return redirect(url_for('dashboard'))
        
        return f(*args, **kwargs)
    return decorated_function

from datetime import datetime

