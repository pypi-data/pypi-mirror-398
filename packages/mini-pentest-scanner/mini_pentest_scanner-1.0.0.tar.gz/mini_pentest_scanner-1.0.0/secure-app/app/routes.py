"""
Routes Module - Secure Version
แก้ไขช่องโหว่ทั้งหมดแล้ว
"""

import sqlite3
import os
from flask import render_template, request, redirect, url_for, session, flash, jsonify, send_file, abort
from app.auth import require_auth, require_admin, get_user_info
from app.security import validate_input, sanitize_output, is_safe_path
from werkzeug.utils import secure_filename

def init_routes(app, db_path):
    """Initialize all routes"""
    
    @app.route('/dashboard')
    @require_auth
    def dashboard():
        """User dashboard"""
        user = get_user_info()
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # ✅ Parameterized query
        cursor.execute('SELECT id, title, content, created_at FROM posts WHERE user_id = ?', (user['id'],))
        posts = cursor.fetchall()
        conn.close()
        
        return render_template('dashboard.html', user=user, posts=posts)
    
    @app.route('/profile')
    @require_auth
    def profile():
        """User profile page"""
        user = get_user_info()
        
        # ✅ Only show necessary information
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        cursor.execute('SELECT id, username, email, role, created_at FROM users WHERE id = ?', (user['id'],))
        user_data = cursor.fetchone()
        conn.close()
        
        return render_template('profile.html', user=user, user_data=user_data)
    
    @app.route('/profile/<int:user_id>')
    @require_auth
    def view_profile(user_id):
        """View other user's profile - ✅ Fixed: Authorization check"""
        current_user = get_user_info()
        
        # ✅ Authorization check (prevent IDOR)
        if current_user['id'] != user_id and current_user['role'] != 'admin':
            abort(403)  # Forbidden
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        cursor.execute('SELECT id, username, email, role, created_at FROM users WHERE id = ?', (user_id,))
        profile_user = cursor.fetchone()
        conn.close()
        
        if not profile_user:
            flash('User not found', 'error')
            return redirect(url_for('dashboard'))
        
        return render_template('view_profile.html', profile_user=profile_user)
    
    @app.route('/admin')
    @require_admin
    def admin_panel():
        """Admin panel - ✅ Fixed: Authorization verified"""
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        cursor.execute('SELECT id, username, email, role, created_at FROM users')
        users = cursor.fetchall()
        
        cursor.execute('SELECT p.id, p.title, p.content, u.username, p.created_at FROM posts p JOIN users u ON p.user_id = u.id')
        posts = cursor.fetchall()
        
        conn.close()
        
        return render_template('admin.html', users=users, posts=posts)
    
    @app.route('/search')
    def search():
        """Search functionality - ✅ Fixed: Parameterized query, output encoding"""
        query = request.args.get('q', '')
        
        if not query:
            return render_template('search.html', results=[])
        
        # ✅ Input validation
        is_valid, error = validate_input(query, max_length=100)
        if not is_valid:
            flash(error, 'error')
            return render_template('search.html', results=[])
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # ✅ Parameterized query (no SQL Injection)
        # ✅ Output encoding (Flask auto-escapes in templates)
        search_pattern = f'%{query}%'
        cursor.execute(
            "SELECT id, title, content FROM posts WHERE title LIKE ? OR content LIKE ?",
            (search_pattern, search_pattern)
        )
        results = cursor.fetchall()
        conn.close()
        
        # ✅ Sanitize query for display
        query = sanitize_output(query)
        
        return render_template('search.html', query=query, results=results)
    
    @app.route('/post/create', methods=['GET', 'POST'])
    @require_auth
    def create_post():
        """Create new post - ✅ Fixed: CSRF protection, input validation, output encoding"""
        if request.method == 'POST':
            title = request.form.get('title', '')
            content = request.form.get('content', '')
            user = get_user_info()
            
            # ✅ Input validation
            is_valid, error = validate_input(title, max_length=200)
            if not is_valid:
                flash(error, 'error')
                return render_template('create_post.html')
            
            is_valid, error = validate_input(content, max_length=5000)
            if not is_valid:
                flash(error, 'error')
                return render_template('create_post.html')
            
            # ✅ CSRF token is checked automatically by Flask-WTF
            
            conn = sqlite3.connect(db_path)
            cursor = conn.cursor()
            cursor.execute(
                'INSERT INTO posts (user_id, title, content, created_at) VALUES (?, ?, ?, datetime("now"))',
                (user['id'], title, content)
            )
            conn.commit()
            conn.close()
            
            flash('Post created successfully!', 'success')
            return redirect(url_for('dashboard'))
        
        return render_template('create_post.html')
    
    @app.route('/post/<int:post_id>')
    def view_post(post_id):
        """View post - ✅ Fixed: Output encoding"""
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        cursor.execute('SELECT p.id, p.title, p.content, u.username, p.created_at FROM posts p JOIN users u ON p.user_id = u.id WHERE p.id = ?', (post_id,))
        post = cursor.fetchone()
        conn.close()
        
        if not post:
            flash('Post not found', 'error')
            return redirect(url_for('index'))
        
        # ✅ Output encoding handled by Flask templates (auto-escaping)
        return render_template('view_post.html', post=post)
    
    @app.route('/api/user/<int:user_id>')
    @require_auth
    def api_user(user_id):
        """API endpoint - ✅ Fixed: Authorization check"""
        current_user = get_user_info()
        
        # ✅ Authorization check (prevent IDOR)
        if current_user['id'] != user_id and current_user['role'] != 'admin':
            abort(403)  # Forbidden
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        cursor.execute('SELECT id, username, email, role, created_at FROM users WHERE id = ?', (user_id,))
        user = cursor.fetchone()
        conn.close()
        
        if not user:
            return jsonify({'error': 'User not found'}), 404
        
        # ✅ Only return necessary information
        return jsonify({
            'id': user[0],
            'username': user[1],
            'email': user[2],
            'role': user[3],
            'created_at': user[4]
        })
    
    @app.route('/file')
    def file_view():
        """File viewer - ✅ Fixed: Path validation"""
        filename = request.args.get('file', '')
        
        if not filename:
            return 'Filename parameter required', 400
        
        # ✅ Sanitize filename
        filename = secure_filename(filename)
        
        if not filename:
            abort(400)  # Invalid filename
        
        # ✅ Validate path (prevent path traversal)
        base_dir = os.path.abspath(os.path.join('secure-app', 'files'))
        file_path = os.path.join(base_dir, filename)
        
        if not is_safe_path(base_dir, file_path):
            abort(403)  # Path traversal attempt
        
        if os.path.exists(file_path) and os.path.isfile(file_path):
            return send_file(file_path)
        else:
            abort(404)  # File not found
    
    # ✅ Debug endpoint removed in secure version

