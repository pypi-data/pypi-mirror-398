"""
Mini Pentest Lab - Secure App
à¹€à¸§à¹‡à¸šà¸—à¸µà¹ˆà¹à¸à¹‰à¹„à¸‚à¸Šà¹ˆà¸­à¸‡à¹‚à¸«à¸§à¹ˆà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹à¸¥à¹‰à¸§ (Secure Version)

âœ… Security Features:
- Parameterized queries
- Input validation
- Output encoding
- CSRF protection
- Strong password hashing
- Secure session management
- Security headers
"""

from flask import Flask, render_template, request, redirect, url_for, session, flash, jsonify
from flask import make_response
from flask_wtf.csrf import CSRFProtect
import sqlite3
import os
import bcrypt
import secrets
from datetime import datetime, timedelta
from app.auth import init_auth, check_auth, get_user_info
from app.routes import init_routes
from app.security import set_security_headers, validate_input, sanitize_output

# Initialize Flask app
# à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² template folder à¹ƒà¸«à¹‰à¸Šà¸µà¹‰à¹„à¸›à¸—à¸µà¹ˆ templates directory à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
template_dir = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'templates')
app = Flask(__name__, template_folder=template_dir)
app.secret_key = os.environ.get('SECRET_KEY', secrets.token_hex(32))  # âœ… Strong secret key

# Security configuration
app.config['SESSION_COOKIE_SECURE'] = False  # Set True in production with HTTPS
app.config['SESSION_COOKIE_HTTPONLY'] = True  # âœ… Prevent JavaScript access
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'  # âœ… CSRF protection
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(hours=1)  # âœ… Session timeout

# CSRF Protection
csrf = CSRFProtect(app)

# Database path
DB_PATH = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'database', 'secure_app.db')

def init_database():
    """Initialize database with sample data"""
    os.makedirs(os.path.dirname(DB_PATH), exist_ok=True)
    
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    
    # Create users table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password TEXT NOT NULL,
            email TEXT,
            role TEXT DEFAULT 'user',
            created_at TEXT
        )
    ''')
    
    # Create posts table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS posts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            title TEXT,
            content TEXT,
            created_at TEXT,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    # Create sessions table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS sessions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            session_token TEXT,
            created_at TEXT,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    # Insert sample data if not exists
    cursor.execute('SELECT COUNT(*) FROM users')
    if cursor.fetchone()[0] == 0:
        # âœ… Strong password hashing (bcrypt)
        admin_password = bcrypt.hashpw('admin123'.encode(), bcrypt.gensalt()).decode()
        user_password = bcrypt.hashpw('password123'.encode(), bcrypt.gensalt()).decode()
        
        cursor.execute('''
            INSERT INTO users (username, password, email, role, created_at)
            VALUES (?, ?, ?, ?, ?)
        ''', ('admin', admin_password, 'admin@lab.local', 'admin', datetime.now().isoformat()))
        
        cursor.execute('''
            INSERT INTO users (username, password, email, role, created_at)
            VALUES (?, ?, ?, ?, ?)
        ''', ('user1', user_password, 'user1@lab.local', 'user', datetime.now().isoformat()))
        
        cursor.execute('''
            INSERT INTO posts (user_id, title, content, created_at)
            VALUES (?, ?, ?, ?)
        ''', (1, 'Welcome Post', 'This is a sample post for testing.', datetime.now().isoformat()))
    
    conn.commit()
    conn.close()

# Initialize components
init_database()
init_auth(app, DB_PATH)
init_routes(app, DB_PATH)

@app.route('/')
def index():
    """Home page"""
    return render_template('index.html')

@app.before_request
def check_session_timeout():
    """Check session timeout"""
    if 'last_activity' in session:
        if datetime.now() - datetime.fromisoformat(session['last_activity']) > timedelta(hours=1):
            session.clear()
            flash('Session expired. Please login again.', 'info')
            return redirect(url_for('login'))
    session['last_activity'] = datetime.now().isoformat()

@app.after_request
def apply_security_headers(response):
    """Apply security headers"""
    return set_security_headers(response)

@app.errorhandler(404)
def not_found(error):
    """Custom 404 handler - âœ… Generic error message"""
    return render_template('error.html', 
                         error_code=404, 
                         error_message="Page not found"), 404

@app.errorhandler(500)
def internal_error(error):
    """Custom 500 handler - âœ… Generic error message"""
    # Log error for admin
    app.logger.error(f"Internal error: {error}")
    return render_template('error.html', 
                         error_code=500, 
                         error_message="An internal error occurred. Please try again later."), 500

if __name__ == '__main__':
    print("=" * 60)
    print("ğŸ”’ Mini Pentest Lab - Secure App")
    print("âœ… All vulnerabilities fixed!")
    print("=" * 60)
    print(f"ğŸ“ Database: {DB_PATH}")
    print("ğŸŒ Server starting on http://127.0.0.1:5002")
    print("=" * 60)
    
    app.run(debug=False, host='127.0.0.1', port=5002)  # âœ… Debug mode off

