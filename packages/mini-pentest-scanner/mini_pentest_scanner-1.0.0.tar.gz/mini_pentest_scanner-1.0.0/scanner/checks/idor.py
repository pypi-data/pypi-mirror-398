"""
IDOR Check
ตรวจสอบช่องโหว่ Insecure Direct Object Reference (Non-intrusive)
"""

from typing import List
from scanner.core.engine import ScannerEngine
from scanner.core.result import Finding, Location, Evidence

def check_new(engine: ScannerEngine) -> List[Finding]:
    """Check for IDOR vulnerabilities (New format using Result Schema)"""
    findings = []
    
    # Only run in active-light mode
    if engine.scan_result.metadata.scanner_mode == 'passive':
        return findings
    
    # Try to login as regular user
    try:
        login_response = engine.http_client.post('/login', data={
            'username': 'user1',
            'password': 'password123'
        })
        
        if not login_response:
            return findings
        
        # Verify login by checking dashboard
        dashboard_response = engine.http_client.get('/dashboard')
        if not dashboard_response or dashboard_response.status_code != 200:
            return findings
    except Exception as e:
        return findings
    
    # Test IDOR in profile endpoint
    test_user_ids = [1, 2, 999]
    
    for user_id in test_user_ids:
        try:
            response = engine.http_client.get(f'/profile/{user_id}')
            
            if not response or response.status_code != 200:
                continue
            
            # Observe response (Non-intrusive)
            response_text = response.text.lower()
            
            # Check if response contains user information
            if 'profile' in response_text or 'username' in response_text or 'email' in response_text:
                # If we can access different user IDs, it's likely IDOR
                if user_id != 2:  # Assuming user1 has id=2
                    finding = Finding(
                        id=f"IDOR-PROFILE-{user_id}",
                        title="Insecure Direct Object Reference (IDOR)",
                        category="Access Control",
                        severity="high",
                        confidence="medium",
                        description=f"Successfully accessed profile of user ID {user_id} without proper authorization check",
                        impact="An attacker may be able to access or modify resources belonging to other users by manipulating object references.",
                        location=Location(
                            type="endpoint",
                            path=f"/profile/{user_id}",
                            method="GET",
                            parameter="user_id"
                        ),
                        evidence=Evidence(
                            request_observed=True,
                            response_pattern="User profile data returned without authorization verification",
                            notes=f"Profile endpoint allows access to user ID {user_id} without checking if requester owns the resource"
                        ),
                        recommendation="Implement proper authorization checks that verify the requesting user has permission to access the requested resource. Use indirect object references or access control lists.",
                        references=[
                            "OWASP Top 10 - A01:2021 Broken Access Control",
                            "CWE-639: Authorization Bypass Through User-Controlled Key"
                        ]
                    )
                    findings.append(finding)
                    break
        
        except Exception as e:
            continue
    
    # Test IDOR in API endpoint
    for user_id in test_user_ids:
        try:
            response = engine.http_client.get(f'/api/user/{user_id}')
            
            if not response or response.status_code != 200:
                continue
            
            try:
                data = response.json()
                if 'username' in data or 'email' in data:
                    if user_id != 2:
                        finding = Finding(
                            id=f"IDOR-API-{user_id}",
                            title="Insecure Direct Object Reference (IDOR) in API",
                            category="Access Control",
                            severity="high",
                            confidence="medium",
                            description=f"API endpoint allows access to user data for user ID {user_id} without authorization check",
                            impact="An attacker may be able to retrieve sensitive user information through API endpoints by manipulating user IDs.",
                            location=Location(
                                type="endpoint",
                                path=f"/api/user/{user_id}",
                                method="GET",
                                parameter="user_id"
                            ),
                            evidence=Evidence(
                                request_observed=True,
                                response_pattern="User data returned via API without authorization verification",
                                notes=f"API endpoint returns user data for ID {user_id} without access control"
                            ),
                            recommendation="Implement proper authorization checks in API endpoints. Verify that the requesting user has permission to access the requested resource.",
                            references=[
                                "OWASP Top 10 - A01:2021 Broken Access Control",
                                "CWE-639: Authorization Bypass Through User-Controlled Key"
                            ]
                        )
                        findings.append(finding)
                        break
            except:
                pass
        except Exception as e:
            continue
    
    return findings

# Legacy function
def check(base_url, session):
    """Legacy check function"""
    return {
        'status': 'info',
        'message': 'Please use check_new() with ScannerEngine'
    }
