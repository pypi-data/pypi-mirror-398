# -*- coding: utf-8 -*-
"""
Tests for History Modules
ทดสอบ history, comparison, trends, baseline, compliance modules
"""

import unittest
import sys
import os
import tempfile
import shutil
from pathlib import Path

# Add project root to path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from mini_pentest_scanner.history.database import ScanHistoryDB
from mini_pentest_scanner.history.comparison import ScanComparison
from mini_pentest_scanner.history.trends import TrendAnalyzer
from mini_pentest_scanner.history.baseline import BaselineManager
from mini_pentest_scanner.history.compliance import ComplianceMapper
from mini_pentest_scanner.core.result import ScanResult, Finding, Location, Evidence


class TestScanHistoryDB(unittest.TestCase):
    """Test ScanHistoryDB"""
    
    def setUp(self):
        """Set up test database"""
        self.temp_dir = tempfile.mkdtemp()
        self.db_path = os.path.join(self.temp_dir, 'test_history.db')
        self.db = ScanHistoryDB(db_path=self.db_path)
    
    def tearDown(self):
        """Clean up test database"""
        shutil.rmtree(self.temp_dir, ignore_errors=True)
    
    def test_database_initialization(self):
        """Test database initialization"""
        self.assertIsNotNone(self.db)
        self.assertTrue(os.path.exists(self.db_path))
    
    def test_save_scan(self):
        """Test saving scan result"""
        result = ScanResult(
            target="http://example.com",
            scanner_mode="passive"
        )
        
        scan_dict = result.to_dict()
        scan_id = self.db.save_scan(scan_dict)
        
        self.assertEqual(scan_id, result.scan_id)
        
        # Verify scan was saved
        saved_scan = self.db.get_scan(scan_id)
        self.assertIsNotNone(saved_scan)
        self.assertEqual(saved_scan['target'], "http://example.com")
    
    def test_save_scan_invalid(self):
        """Test saving invalid scan result"""
        with self.assertRaises(ValueError):
            self.db.save_scan(None)
        
        with self.assertRaises(ValueError):
            self.db.save_scan({})
        
        with self.assertRaises(ValueError):
            self.db.save_scan({'scan_id': 'test'})  # Missing target
    
    def test_get_scans_by_target(self):
        """Test getting scans by target"""
        # Save multiple scans
        for i in range(3):
            result = ScanResult(
                target="http://example.com",
                scanner_mode="passive"
            )
            self.db.save_scan(result.to_dict())
        
        scans = self.db.get_scans_by_target("http://example.com")
        self.assertEqual(len(scans), 3)
    
    def test_get_all_scans(self):
        """Test getting all scans"""
        # Save scans for different targets
        for i in range(3):
            result = ScanResult(
                target=f"http://example{i}.com",
                scanner_mode="passive"
            )
            self.db.save_scan(result.to_dict())
        
        scans = self.db.get_all_scans()
        self.assertEqual(len(scans), 3)


class TestScanComparison(unittest.TestCase):
    """Test ScanComparison"""
    
    def setUp(self):
        """Set up test database and scans"""
        self.temp_dir = tempfile.mkdtemp()
        self.db_path = os.path.join(self.temp_dir, 'test_history.db')
        self.db = ScanHistoryDB(db_path=self.db_path)
        
        # Create two scans
        result1 = ScanResult(target="http://example.com", scanner_mode="passive")
        finding1 = Finding(
            id="TEST-001",
            title="Test Finding 1",
            category="Test",
            severity="high",
            confidence="medium",
            description="Test",
            impact="Test",
            location=Location(type="endpoint", path="/test"),
            evidence=Evidence(),
            recommendation="Test"
        )
        result1.add_finding(finding1)
        self.scan_id1 = self.db.save_scan(result1.to_dict())
        
        result2 = ScanResult(target="http://example.com", scanner_mode="passive")
        finding2 = Finding(
            id="TEST-002",
            title="Test Finding 2",
            category="Test",
            severity="medium",
            confidence="high",
            description="Test",
            impact="Test",
            location=Location(type="endpoint", path="/test2"),
            evidence=Evidence(),
            recommendation="Test"
        )
        result2.add_finding(finding2)
        self.scan_id2 = self.db.save_scan(result2.to_dict())
    
    def tearDown(self):
        """Clean up"""
        shutil.rmtree(self.temp_dir, ignore_errors=True)
    
    def test_compare_scans(self):
        """Test comparing two scans"""
        comparison = ScanComparison(self.db)
        result = comparison.compare_scans(self.scan_id1, self.scan_id2)
        
        self.assertIn('risk_comparison', result)
        self.assertIn('findings_comparison', result)
        self.assertIn('severity_changes', result)
    
    def test_compare_scans_invalid(self):
        """Test comparing with invalid parameters"""
        comparison = ScanComparison(self.db)
        
        with self.assertRaises(ValueError):
            comparison.compare_scans("", self.scan_id2)
        
        with self.assertRaises(ValueError):
            comparison.compare_scans(self.scan_id1, "")
        
        with self.assertRaises(ValueError):
            comparison.compare_scans(self.scan_id1, self.scan_id1)
        
        with self.assertRaises(ValueError):
            comparison.compare_scans("nonexistent", self.scan_id2)


class TestTrendAnalyzer(unittest.TestCase):
    """Test TrendAnalyzer"""
    
    def setUp(self):
        """Set up test database"""
        self.temp_dir = tempfile.mkdtemp()
        self.db_path = os.path.join(self.temp_dir, 'test_history.db')
        self.db = ScanHistoryDB(db_path=self.db_path)
    
    def tearDown(self):
        """Clean up"""
        shutil.rmtree(self.temp_dir, ignore_errors=True)
    
    def test_analyze_trends_insufficient_data(self):
        """Test trend analysis with insufficient data"""
        analyzer = TrendAnalyzer(self.db)
        result = analyzer.analyze_trends("http://example.com", days=30)
        
        self.assertFalse(result.get('has_enough_data', True))
    
    def test_analyze_trends_invalid(self):
        """Test trend analysis with invalid parameters"""
        analyzer = TrendAnalyzer(self.db)
        
        with self.assertRaises(ValueError):
            analyzer.analyze_trends("", days=30)
        
        with self.assertRaises(ValueError):
            analyzer.analyze_trends("http://example.com", days=0)
        
        with self.assertRaises(ValueError):
            analyzer.analyze_trends("http://example.com", days=-1)


class TestBaselineManager(unittest.TestCase):
    """Test BaselineManager"""
    
    def setUp(self):
        """Set up test database"""
        self.temp_dir = tempfile.mkdtemp()
        self.db_path = os.path.join(self.temp_dir, 'test_history.db')
        self.db = ScanHistoryDB(db_path=self.db_path)
        
        # Create a scan
        result = ScanResult(target="http://example.com", scanner_mode="passive")
        self.scan_id = self.db.save_scan(result.to_dict())
    
    def tearDown(self):
        """Clean up"""
        shutil.rmtree(self.temp_dir, ignore_errors=True)
    
    def test_set_baseline(self):
        """Test setting baseline"""
        baseline_mgr = BaselineManager(self.db)
        success = baseline_mgr.set_baseline("http://example.com", self.scan_id)
        
        self.assertTrue(success)
        
        baseline_id = baseline_mgr.get_baseline("http://example.com")
        self.assertEqual(baseline_id, self.scan_id)
    
    def test_set_baseline_invalid(self):
        """Test setting baseline with invalid parameters"""
        baseline_mgr = BaselineManager(self.db)
        
        with self.assertRaises(ValueError):
            baseline_mgr.set_baseline("", self.scan_id)
        
        with self.assertRaises(ValueError):
            baseline_mgr.set_baseline("http://example.com", "")
        
        with self.assertRaises((ValueError, RuntimeError)):
            baseline_mgr.set_baseline("http://example.com", "nonexistent")


class TestComplianceMapper(unittest.TestCase):
    """Test ComplianceMapper"""
    
    def setUp(self):
        """Set up test database"""
        self.temp_dir = tempfile.mkdtemp()
        self.db_path = os.path.join(self.temp_dir, 'test_history.db')
        self.db = ScanHistoryDB(db_path=self.db_path)
        
        # Create a scan with findings
        result = ScanResult(target="http://example.com", scanner_mode="passive")
        finding = Finding(
            id="TEST-001",
            title="SQL Injection",
            category="Injection",
            severity="high",
            confidence="medium",
            description="Test",
            impact="Test",
            location=Location(type="endpoint", path="/login"),
            evidence=Evidence(),
            recommendation="Test"
        )
        result.add_finding(finding)
        self.scan_id = self.db.save_scan(result.to_dict())
    
    def tearDown(self):
        """Clean up"""
        shutil.rmtree(self.temp_dir, ignore_errors=True)
    
    def test_map_scan_to_compliance(self):
        """Test compliance mapping"""
        mapper = ComplianceMapper(self.db)
        result = mapper.map_scan_to_compliance(self.scan_id, ['ISO27001'])
        
        self.assertIn('compliance', result)
        self.assertIn('ISO27001', result['compliance'])
    
    def test_map_scan_to_compliance_invalid(self):
        """Test compliance mapping with invalid parameters"""
        mapper = ComplianceMapper(self.db)
        
        with self.assertRaises(ValueError):
            mapper.map_scan_to_compliance("", ['ISO27001'])
        
        with self.assertRaises(ValueError):
            mapper.map_scan_to_compliance(self.scan_id, "not_a_list")
        
        with self.assertRaises(ValueError):
            mapper.map_scan_to_compliance(self.scan_id, ['INVALID_STANDARD'])
        
        with self.assertRaises(ValueError):
            mapper.map_scan_to_compliance("nonexistent", ['ISO27001'])


if __name__ == '__main__':
    unittest.main(verbosity=2)

