# üõ°Ô∏è Security Best Practices

‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ Best Practices ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÉ‡∏ô Vulnerable App

## üìã ‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç

1. [SQL Injection Prevention](#sql-injection-prevention)
2. [XSS Prevention](#xss-prevention)
3. [IDOR Prevention](#idor-prevention)
4. [Authentication Security](#authentication-security)
5. [Session Management](#session-management)
6. [Information Disclosure Prevention](#information-disclosure-prevention)
7. [CSRF Protection](#csrf-protection)
8. [Path Traversal Prevention](#path-traversal-prevention)

---

## 1. SQL Injection Prevention

### ‚ùå ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î (Vulnerable)

```python
# ‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà: String concatenation
username = request.form.get('username')
query = f"SELECT * FROM users WHERE username='{username}'"
cursor.execute(query)
```

### ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Secure)

```python
# ‚úÖ ‡πÉ‡∏ä‡πâ Parameterized Queries
username = request.form.get('username')
query = "SELECT * FROM users WHERE username=?"
cursor.execute(query, (username,))
```

### üìö Best Practices

1. **‡πÉ‡∏ä‡πâ Parameterized Queries ‡πÄ‡∏™‡∏°‡∏≠**
   - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ string formatting ‡∏´‡∏£‡∏∑‡∏≠ concatenation
   - ‡πÉ‡∏ä‡πâ placeholders (`?` ‡∏´‡∏£‡∏∑‡∏≠ `%s`)

2. **Input Validation**
   ```python
   import re
   
   def validate_username(username):
       if not username or len(username) < 3:
           return False
       if not re.match(r'^[a-zA-Z0-9_]+$', username):
           return False
       return True
   ```

3. **Least Privilege Database Access**
   - ‡πÉ‡∏ä‡πâ database user ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏≥‡∏Å‡∏±‡∏î
   - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ root/admin account

4. **ORM (Object-Relational Mapping)**
   ```python
   # ‡πÉ‡∏ä‡πâ SQLAlchemy ‡∏´‡∏£‡∏∑‡∏≠ ORM ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
   from sqlalchemy import create_engine
   user = session.query(User).filter(User.username == username).first()
   ```

---

## 2. XSS Prevention

### ‚ùå ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î (Vulnerable)

```python
# ‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà: ‡πÑ‡∏°‡πà sanitize input
query = request.args.get('q')
return render_template('search.html', query=query)
```

```html
<!-- ‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà: ‡πÑ‡∏°‡πà encode output -->
<p>{{ query|safe }}</p>
```

### ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Secure)

```python
# ‚úÖ Sanitize input
from markupsafe import escape

query = request.args.get('q', '')
query = escape(query)  # ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ template auto-escaping
return render_template('search.html', query=query)
```

```html
<!-- ‚úÖ Auto-escaping (default ‡πÉ‡∏ô Flask) -->
<p>{{ query }}</p>
```

### üìö Best Practices

1. **Output Encoding**
   - ‡πÉ‡∏ä‡πâ auto-escaping ‡πÉ‡∏ô template (Flask ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
   - ‡πÉ‡∏ä‡πâ `escape()` function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dynamic content

2. **Content Security Policy (CSP)**
   ```python
   from flask import Flask
   
   @app.after_request
   def set_csp(response):
       response.headers['Content-Security-Policy'] = (
           "default-src 'self'; "
           "script-src 'self'; "
           "style-src 'self' 'unsafe-inline';"
       )
       return response
   ```

3. **Input Validation**
   ```python
   import bleach
   
   # Sanitize HTML input
   clean_html = bleach.clean(user_input, tags=['p', 'b', 'i'])
   ```

4. **Avoid `|safe` Filter**
   - ‡πÉ‡∏ä‡πâ `|safe` ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ
   - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ content ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

---

## 3. IDOR Prevention

### ‚ùå ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î (Vulnerable)

```python
# ‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà: ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ authorization
@app.route('/profile/<int:user_id>')
@require_auth
def view_profile(user_id):
    user = get_user_by_id(user_id)  # ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    return render_template('profile.html', user=user)
```

### ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Secure)

```python
# ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ authorization
@app.route('/profile/<int:user_id>')
@require_auth
def view_profile(user_id):
    current_user = get_current_user()
    
    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô profile ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ admin
    if current_user['id'] != user_id and current_user['role'] != 'admin':
        abort(403)  # Forbidden
    
    user = get_user_by_id(user_id)
    return render_template('profile.html', user=user)
```

### üìö Best Practices

1. **Authorization Checks**
   - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
   - ‡πÉ‡∏ä‡πâ decorator ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö authorization

2. **Resource Ownership Verification**
   ```python
   def can_access_resource(user_id, resource_user_id, user_role):
       return user_id == resource_user_id or user_role == 'admin'
   ```

3. **Use Indirect References**
   - ‡πÉ‡∏ä‡πâ UUID ‡πÅ‡∏ó‡∏ô sequential ID
   - ‡πÉ‡∏ä‡πâ access tokens ‡πÅ‡∏ó‡∏ô direct ID

4. **Access Control Lists (ACL)**
   ```python
   def check_permission(user, resource, action):
       if user.role == 'admin':
           return True
       if resource.owner_id == user.id:
           return True
       return False
   ```

---

## 4. Authentication Security

### ‚ùå ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î (Vulnerable)

```python
# ‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà: Weak password hashing (MD5)
import hashlib
password_hash = hashlib.md5(password.encode()).hexdigest()
```

### ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Secure)

```python
# ‚úÖ Strong password hashing (bcrypt)
import bcrypt

def hash_password(password):
    salt = bcrypt.gensalt()
    return bcrypt.hashpw(password.encode(), salt)

def verify_password(password, hashed):
    return bcrypt.checkpw(password.encode(), hashed)
```

### üìö Best Practices

1. **Strong Password Hashing**
   - ‡πÉ‡∏ä‡πâ bcrypt, argon2, ‡∏´‡∏£‡∏∑‡∏≠ scrypt
   - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ MD5, SHA1, ‡∏´‡∏£‡∏∑‡∏≠ SHA256 (‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)

2. **Rate Limiting**
   ```python
   from flask_limiter import Limiter
   from flask_limiter.util import get_remote_address
   
   limiter = Limiter(
       app=app,
       key_func=get_remote_address,
       default_limits=["200 per day", "50 per hour"]
   )
   
   @app.route('/login', methods=['POST'])
   @limiter.limit("5 per minute")
   def login():
       # Login logic
   ```

3. **Password Policy**
   ```python
   def validate_password(password):
       if len(password) < 8:
           return False, "Password must be at least 8 characters"
       if not re.search(r'[A-Z]', password):
           return False, "Password must contain uppercase letter"
       if not re.search(r'[a-z]', password):
           return False, "Password must contain lowercase letter"
       if not re.search(r'[0-9]', password):
           return False, "Password must contain number"
       return True, "Password is valid"
   ```

4. **Account Lockout**
   ```python
   failed_attempts = get_failed_attempts(username)
   if failed_attempts >= 5:
       lock_account(username)
       return "Account locked. Please try again later."
   ```

5. **Generic Error Messages**
   ```python
   # ‚ùå ‡∏ú‡∏¥‡∏î
   flash('Invalid username', 'error')
   
   # ‚úÖ ‡∏ñ‡∏π‡∏Å
   flash('Invalid username or password', 'error')
   ```

---

## 5. Session Management

### ‚ùå ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î (Vulnerable)

```python
# ‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà: ‡πÑ‡∏°‡πà regenerate session ID
session['user_id'] = user_id
session['logged_in'] = True
```

### ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Secure)

```python
# ‚úÖ Regenerate session ID after login
from flask import session
import secrets

def login(user_id):
    # Clear old session
    session.clear()
    
    # Regenerate session ID
    session.permanent = True
    session['user_id'] = user_id
    session['logged_in'] = True
```

### üìö Best Practices

1. **Secure Session Configuration**
   ```python
   app.config['SESSION_COOKIE_SECURE'] = True  # HTTPS only
   app.config['SESSION_COOKIE_HTTPONLY'] = True  # No JavaScript access
   app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'  # CSRF protection
   app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(hours=1)
   ```

2. **Session Regeneration**
   - Regenerate session ID ‡∏´‡∏•‡∏±‡∏á login
   - Regenerate session ID ‡∏´‡∏•‡∏±‡∏á privilege escalation

3. **Session Timeout**
   ```python
   @app.before_request
   def check_session_timeout():
       if 'last_activity' in session:
           if datetime.now() - session['last_activity'] > timedelta(hours=1):
               session.clear()
               return redirect(url_for('login'))
       session['last_activity'] = datetime.now()
   ```

4. **Logout Properly**
   ```python
   @app.route('/logout')
   def logout():
       session.clear()
       return redirect(url_for('index'))
   ```

---

## 6. Information Disclosure Prevention

### ‚ùå ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î (Vulnerable)

```python
# ‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà: Error message ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
try:
    result = database.query(query)
except Exception as e:
    return f"Database error: {str(e)}"  # ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢ stack trace
```

### ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Secure)

```python
# ‚úÖ Generic error message
try:
    result = database.query(query)
except Exception as e:
    logger.error(f"Database error: {str(e)}")  # Log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin
    return "An error occurred. Please try again later."  # Generic message
```

### üìö Best Practices

1. **Generic Error Messages**
   ```python
   @app.errorhandler(500)
   def internal_error(error):
       logger.error(f"Internal error: {error}")
       return render_template('error.html', 
                            message="An internal error occurred"), 500
   ```

2. **Disable Debug Mode in Production**
   ```python
   # ‚ùå ‡∏ú‡∏¥‡∏î
   app.run(debug=True)
   
   # ‚úÖ ‡∏ñ‡∏π‡∏Å
   app.run(debug=False)
   ```

3. **Remove Debug Endpoints**
   - ‡∏•‡∏ö `/debug` endpoint ‡πÉ‡∏ô production
   - ‡πÉ‡∏ä‡πâ environment variable ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°

4. **Security Headers**
   ```python
   @app.after_request
   def set_security_headers(response):
       response.headers['X-Content-Type-Options'] = 'nosniff'
       response.headers['X-Frame-Options'] = 'DENY'
       response.headers['X-XSS-Protection'] = '1; mode=block'
       response.headers['Server'] = ''  # Hide server info
       return response
   ```

5. **Logging**
   ```python
   import logging
   
   # Log errors ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ user
   logger = logging.getLogger(__name__)
   logger.error(f"Error details: {error}", exc_info=True)
   ```

---

## 7. CSRF Protection

### ‚ùå ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î (Vulnerable)

```python
# ‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà: ‡πÑ‡∏°‡πà‡∏°‡∏µ CSRF token
@app.route('/post/create', methods=['POST'])
def create_post():
    # No CSRF protection
    pass
```

### ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Secure)

```python
# ‚úÖ ‡πÉ‡∏ä‡πâ Flask-WTF CSRF protection
from flask_wtf.csrf import CSRFProtect

csrf = CSRFProtect(app)

@app.route('/post/create', methods=['POST'])
@csrf.exempt  # ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ @csrf.include
def create_post():
    # CSRF token checked automatically
    pass
```

```html
<!-- ‚úÖ Include CSRF token in form -->
<form method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <!-- form fields -->
</form>
```

### üìö Best Practices

1. **CSRF Tokens**
   - ‡πÉ‡∏ä‡πâ Flask-WTF ‡∏´‡∏£‡∏∑‡∏≠ library ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
   - Include token ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å form

2. **SameSite Cookies**
   ```python
   app.config['SESSION_COOKIE_SAMESITE'] = 'Strict'
   ```

3. **Double Submit Cookie**
   - ‡πÉ‡∏ä‡πâ cookie + token verification

4. **Referer Validation**
   ```python
   @app.before_request
   def check_referer():
       if request.method == 'POST':
           referer = request.headers.get('Referer')
           if not referer or not referer.startswith(request.host_url):
               abort(403)
   ```

---

## 8. Path Traversal Prevention

### ‚ùå ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î (Vulnerable)

```python
# ‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà: ‡πÑ‡∏°‡πà validate path
filename = request.args.get('file')
file_path = os.path.join('files', filename)
return send_file(file_path)
```

### ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Secure)

```python
# ‚úÖ Validate ‡πÅ‡∏•‡∏∞ sanitize path
import os
from werkzeug.utils import secure_filename

filename = request.args.get('file')
if not filename:
    abort(400)

# Sanitize filename
filename = secure_filename(filename)

# Validate path
base_dir = os.path.abspath('files')
file_path = os.path.join(base_dir, filename)

# Check if path is within base directory
if not file_path.startswith(base_dir):
    abort(403)  # Path traversal attempt

if not os.path.exists(file_path):
    abort(404)

return send_file(file_path)
```

### üìö Best Practices

1. **Path Validation**
   ```python
   def is_safe_path(basedir, path):
       basedir = os.path.abspath(basedir)
       path = os.path.abspath(path)
       return path.startswith(basedir)
   ```

2. **Whitelist Allowed Files**
   ```python
   ALLOWED_EXTENSIONS = {'txt', 'pdf', 'png', 'jpg'}
   
   def allowed_file(filename):
       return '.' in filename and \
              filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS
   ```

3. **Use Secure Filename**
   ```python
   from werkzeug.utils import secure_filename
   filename = secure_filename(user_filename)
   ```

4. **Sandbox File Access**
   - ‡πÉ‡∏ä‡πâ dedicated directory ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö user uploads
   - ‡∏à‡∏≥‡∏Å‡∏±‡∏î permissions

---

## üìö Resources

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [OWASP Cheat Sheet Series](https://cheatsheetseries.owasp.org/)
- [Flask Security Best Practices](https://flask.palletsprojects.com/en/2.3.x/security/)
- [Python Security](https://python.readthedocs.io/en/latest/library/security.html)

---

**‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡πÄ‡∏™‡∏°‡∏≠**: Security ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ó‡∏≥‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à! üîí

