"""
XSS Check
ตรวจสอบช่องโหว่ Cross-Site Scripting (Non-intrusive)
"""

from typing import List
from ..core.engine import ScannerEngine
from ..core.result import Finding, Location, Evidence

def check_new(engine: ScannerEngine) -> List[Finding]:
    """Check for XSS vulnerabilities (New format using Result Schema)"""
    findings = []
    
    # Only run in active-light mode
    if engine.scan_result.metadata.scanner_mode == 'passive':
        return findings
    
    # XSS test payloads (safe - alert only)
    test_payloads = [
        "<script>alert('XSS')</script>",
        "<img src=x onerror=alert('XSS')>",
    ]
    
    # Test endpoints
    endpoints = [
        {
            'path': '/search',
            'method': 'GET',
            'param': 'q',
            'name': 'Search endpoint'
        },
        {
            'path': '/post/create',
            'method': 'POST',
            'param': 'title',
            'name': 'Post creation',
            'requires_auth': True
        }
    ]
    
    # Try to login first (for endpoints that require auth)
    try:
        engine.http_client.post('/login', data={
            'username': 'user1',
            'password': 'password123'
        })
    except:
        pass
    
    for endpoint in endpoints:
        if endpoint.get('requires_auth') and not engine.http_client.session.cookies:
            continue
        
        for payload in test_payloads:
            try:
                if endpoint['method'] == 'GET':
                    response = engine.http_client.get(
                        endpoint['path'],
                        params={endpoint['param']: payload}
                    )
                else:  # POST
                    data = {endpoint['param']: payload}
                    if endpoint['param'] == 'title':
                        data['content'] = 'Test content'
                    
                    response = engine.http_client.post(
                        endpoint['path'],
                        data=data
                    )
                    
                    # Follow redirect if needed
                    if response and response.status_code == 302:
                        redirect_path = response.headers.get('Location', '')
                        if redirect_path:
                            response = engine.http_client.get(redirect_path)
                
                if not response:
                    continue
                
                # Observe response (Non-intrusive)
                response_text = response.text
                
                # Check if payload appears unsanitized
                if payload in response_text:
                    # Check for dangerous context
                    if '<script>' in payload.lower() and '<script>' in response_text.lower():
                        finding = Finding(
                            id=f"XSS-{endpoint['path'].replace('/', '')}-001",
                            title="XSS Risk Indicators Detected",
                            category="Injection",
                            severity="high",
                            confidence="medium",
                            description=f"XSS payload reflected unsanitized in {endpoint['name']}",
                            impact="An attacker may be able to execute malicious scripts in users' browsers, potentially leading to session hijacking or data theft.",
                            location=Location(
                                type="endpoint",
                                path=endpoint['path'],
                                method=endpoint['method'],
                                parameter=endpoint['param']
                            ),
                            evidence=Evidence(
                                request_observed=True,
                                response_pattern="XSS payload reflected unsanitized in response",
                                notes="Script tag found in response without proper encoding"
                            ),
                            recommendation="Implement proper output encoding (HTML entity encoding) and Content Security Policy (CSP) headers.",
                            references=[
                                "OWASP Top 10 - A03:2021 Injection",
                                "CWE-79: Cross-site Scripting"
                            ]
                        )
                        findings.append(finding)
                        break
                        
            except Exception as e:
                continue
    
    return findings

# Legacy function
def check(base_url, session):
    """Legacy check function"""
    return {
        'status': 'info',
        'message': 'Please use check_new() with ScannerEngine'
    }
