"""
PDF Report Generator
สร้าง PDF report จาก ScanResult
"""

from pathlib import Path
from typing import Optional
from datetime import datetime
import logging

try:
    from reportlab.lib.pagesizes import letter, A4
    from reportlab.lib import colors
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.units import inch
    from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, PageBreak
    from reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_JUSTIFY
    REPORTLAB_AVAILABLE = True
except ImportError:
    REPORTLAB_AVAILABLE = False
    logging.warning("reportlab not installed. PDF generation will not work.")

from ..core.result import ScanResult

logger = logging.getLogger(__name__)

class PDFReportGenerator:
    """Generate PDF reports from ScanResult"""
    
    def __init__(self):
        """Initialize PDF generator"""
        if not REPORTLAB_AVAILABLE:
            raise ImportError("reportlab is required for PDF generation. Install with: pip install reportlab")
    
    def generate(self, result: ScanResult, output_path: Path) -> bool:
        """
        Generate PDF report
        
        Args:
            result: ScanResult object
            output_path: Path to save PDF file
            
        Returns:
            True if successful, False otherwise
        """
        try:
            # Create PDF document
            doc = SimpleDocTemplate(
                str(output_path),
                pagesize=A4,
                rightMargin=72,
                leftMargin=72,
                topMargin=72,
                bottomMargin=18
            )
            
            # Container for PDF elements
            story = []
            
            # Get styles
            styles = getSampleStyleSheet()
            
            # Title style
            title_style = ParagraphStyle(
                'CustomTitle',
                parent=styles['Heading1'],
                fontSize=24,
                textColor=colors.HexColor('#1e3c72'),
                spaceAfter=30,
                alignment=TA_CENTER
            )
            
            # Heading style
            heading_style = ParagraphStyle(
                'CustomHeading',
                parent=styles['Heading2'],
                fontSize=16,
                textColor=colors.HexColor('#1e3c72'),
                spaceAfter=12,
                spaceBefore=12
            )
            
            # Subheading style
            subheading_style = ParagraphStyle(
                'CustomSubheading',
                parent=styles['Heading3'],
                fontSize=14,
                textColor=colors.HexColor('#2c3e50'),
                spaceAfter=8,
                spaceBefore=8
            )
            
            # Normal style
            normal_style = styles['Normal']
            
            # Add title
            story.append(Paragraph("Security Scan Report", title_style))
            story.append(Spacer(1, 0.2*inch))
            
            # Add scan metadata
            story.append(Paragraph(f"<b>Target:</b> {result.target}", normal_style))
            story.append(Paragraph(f"<b>Scan ID:</b> {result.scan_id}", normal_style))
            story.append(Paragraph(f"<b>Scan Time:</b> {result.scan_time}", normal_style))
            story.append(Paragraph(f"<b>Scanner Version:</b> {result.metadata.scanner_version}", normal_style))
            story.append(Paragraph(f"<b>Scan Mode:</b> {result.metadata.scanner_mode.upper()}", normal_style))
            story.append(Spacer(1, 0.3*inch))
            
            # Add summary
            story.append(Paragraph("Executive Summary", heading_style))
            
            summary_data = [
                ['Metric', 'Value'],
                ['Total Checks', str(result.summary.total_checks)],
                ['Total Findings', str(result.summary.total_findings)],
                ['Risk Score', f"{result.summary.risk_score}/100"],
            ]
            
            # Add severity breakdown
            severity_data = [
                ['Severity', 'Count'],
                ['Critical', str(result.summary.severity_count.get('critical', 0))],
                ['High', str(result.summary.severity_count.get('high', 0))],
                ['Medium', str(result.summary.severity_count.get('medium', 0))],
                ['Low', str(result.summary.severity_count.get('low', 0))],
            ]
            
            # Create summary table
            summary_table = Table(summary_data, colWidths=[2*inch, 2*inch])
            summary_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#1e3c72')),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 12),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
                ('GRID', (0, 0), (-1, -1), 1, colors.black),
                ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.lightgrey])
            ]))
            
            story.append(summary_table)
            story.append(Spacer(1, 0.2*inch))
            
            # Create severity table
            severity_table = Table(severity_data, colWidths=[2*inch, 2*inch])
            severity_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#1e3c72')),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 12),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
                ('GRID', (0, 0), (-1, -1), 1, colors.black),
                ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.lightgrey])
            ]))
            
            story.append(severity_table)
            story.append(Spacer(1, 0.3*inch))
            
            # Add findings
            if result.findings:
                story.append(PageBreak())
                story.append(Paragraph("Detailed Findings", heading_style))
                
                for idx, finding in enumerate(result.findings, 1):
                    # Finding header
                    severity_color = {
                        'critical': colors.HexColor('#dc3545'),
                        'high': colors.HexColor('#dc3545'),
                        'medium': colors.HexColor('#ffc107'),
                        'low': colors.HexColor('#17a2b8')
                    }.get(finding.severity.lower(), colors.black)
                    
                    finding_title = f"Finding {idx}: {finding.title} [{finding.severity.upper()}]"
                    story.append(Paragraph(finding_title, subheading_style))
                    
                    # Finding details
                    details = [
                        f"<b>ID:</b> {finding.id}",
                        f"<b>Category:</b> {finding.category}",
                        f"<b>Confidence:</b> {finding.confidence}",
                        f"<b>Location:</b> {finding.location.path or 'N/A'} ({finding.location.method or 'N/A'})",
                    ]
                    
                    for detail in details:
                        story.append(Paragraph(detail, normal_style))
                    
                    story.append(Spacer(1, 0.1*inch))
                    
                    # Description
                    story.append(Paragraph("<b>Description:</b>", normal_style))
                    story.append(Paragraph(finding.description, normal_style))
                    story.append(Spacer(1, 0.1*inch))
                    
                    # Impact
                    story.append(Paragraph("<b>Impact:</b>", normal_style))
                    story.append(Paragraph(finding.impact, normal_style))
                    story.append(Spacer(1, 0.1*inch))
                    
                    # Evidence
                    if finding.evidence:
                        story.append(Paragraph("<b>Evidence:</b>", normal_style))
                        evidence_text = []
                        if finding.evidence.response_pattern:
                            evidence_text.append(f"Response Pattern: {finding.evidence.response_pattern}")
                        if finding.evidence.notes:
                            evidence_text.append(f"Notes: {finding.evidence.notes}")
                        if evidence_text:
                            story.append(Paragraph("<br/>".join(evidence_text), normal_style))
                        story.append(Spacer(1, 0.1*inch))
                    
                    # Recommendation
                    story.append(Paragraph("<b>Recommendation:</b>", normal_style))
                    story.append(Paragraph(finding.recommendation, normal_style))
                    story.append(Spacer(1, 0.1*inch))
                    
                    # References
                    if finding.references:
                        story.append(Paragraph("<b>References:</b>", normal_style))
                        for ref in finding.references:
                            story.append(Paragraph(f"• {ref}", normal_style))
                    
                    story.append(Spacer(1, 0.2*inch))
                    
                    # Add page break between findings (except last one)
                    if idx < len(result.findings):
                        story.append(PageBreak())
            else:
                story.append(Paragraph("No findings detected.", normal_style))
            
            # Add footer/disclaimer
            story.append(Spacer(1, 0.3*inch))
            story.append(Paragraph(
                "<i>This report is for educational purposes only. "
                "Always ensure you have proper authorization before scanning any system.</i>",
                normal_style
            ))
            
            # Build PDF
            doc.build(story)
            
            logger.info(f"PDF report generated: {output_path}")
            return True
            
        except Exception as e:
            logger.error(f"Error generating PDF report: {e}", exc_info=True)
            return False

