"""
Security Utilities
ฟังก์ชันช่วยด้านความปลอดภัย
"""

from flask import Response
import re
from markupsafe import escape

def set_security_headers(response):
    """Set security headers"""
    response.headers['X-Content-Type-Options'] = 'nosniff'
    response.headers['X-Frame-Options'] = 'DENY'
    response.headers['X-XSS-Protection'] = '1; mode=block'
    response.headers['Content-Security-Policy'] = (
        "default-src 'self'; "
        "script-src 'self'; "
        "style-src 'self' 'unsafe-inline';"
    )
    # Hide server information
    if 'Server' in response.headers:
        del response.headers['Server']
    return response

def validate_username(username):
    """Validate username"""
    if not username or len(username) < 3 or len(username) > 20:
        return False, "Username must be between 3 and 20 characters"
    if not re.match(r'^[a-zA-Z0-9_]+$', username):
        return False, "Username can only contain letters, numbers, and underscores"
    return True, None

def validate_password(password):
    """Validate password strength"""
    if not password or len(password) < 8:
        return False, "Password must be at least 8 characters"
    if not re.search(r'[A-Z]', password):
        return False, "Password must contain at least one uppercase letter"
    if not re.search(r'[a-z]', password):
        return False, "Password must contain at least one lowercase letter"
    if not re.search(r'[0-9]', password):
        return False, "Password must contain at least one number"
    return True, None

def validate_email(email):
    """Validate email format"""
    if not email:
        return True, None  # Email is optional
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    if not re.match(pattern, email):
        return False, "Invalid email format"
    return True, None

def validate_input(data, input_type='text', max_length=1000):
    """General input validation"""
    if not data:
        return False, "Input is required"
    
    if len(data) > max_length:
        return False, f"Input must be less than {max_length} characters"
    
    # Check for dangerous patterns
    dangerous_patterns = [
        r'<script',
        r'javascript:',
        r'on\w+\s*=',
        r'<iframe',
    ]
    
    for pattern in dangerous_patterns:
        if re.search(pattern, data, re.IGNORECASE):
            return False, "Input contains potentially dangerous content"
    
    return True, None

def sanitize_output(text):
    """Sanitize output (Flask auto-escapes, but this is extra safety)"""
    return escape(str(text))

def is_safe_path(base_dir, file_path):
    """Check if file path is safe (no path traversal)"""
    import os
    base_dir = os.path.abspath(base_dir)
    file_path = os.path.abspath(file_path)
    return file_path.startswith(base_dir)

