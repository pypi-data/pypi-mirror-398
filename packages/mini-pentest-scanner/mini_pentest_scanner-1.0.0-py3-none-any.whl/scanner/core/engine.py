"""
Scanner Engine - Orchestrator for security checks
"""

from typing import List, Callable, Dict, Any, Optional
from scanner.core.result import ScanResult, Finding, Location, Evidence
from scanner.core.http_client import HTTPClient
from scanner.core.config import ScannerConfig

class ScannerEngine:
    """Main scanner engine (orchestrator)"""
    
    def __init__(self, base_url: str, config: Optional[ScannerConfig] = None):
        self.base_url = base_url
        self.config = config or ScannerConfig()
        self.http_client = HTTPClient(
            base_url,
            timeout=self.config.get_timeout(),
            user_agent=self.config.get_user_agent()
        )
        self.scan_result = ScanResult(
            base_url,
            scanner_mode=self.config.get_scanner_mode()
        )
        self.checks: List[Dict[str, Any]] = []
    
    def register_check(self, check_func: Callable, name: str, category: str):
        """Register a check function"""
        self.checks.append({
            'name': name,
            'category': category,
            'func': check_func
        })
    
    def run_scan(self, enabled_checks: Optional[List[str]] = None) -> ScanResult:
        """Run all registered checks"""
        print("=" * 60)
        print("ðŸ” Security Scanner - Non-intrusive Assessment")
        print("=" * 60)
        print(f"Target: {self.base_url}")
        print(f"Mode: {self.scan_result.metadata.scanner_mode}")
        print(f"Policy: {self.scan_result.metadata.scan_policy}")
        print("=" * 60)
        print()
        
        # Verify authorization if required
        if self.config.require_authorization():
            if not self._verify_authorization():
                print("âŒ Authorization check failed. Scan cancelled.")
                return self.scan_result
        
        # Run checks
        for check in self.checks:
            check_name = check['name']
            
            # Skip if not in enabled_checks
            if enabled_checks and check_name not in enabled_checks:
                continue
            
            print(f"ðŸ”Ž Checking: {check_name}...")
            try:
                findings = check['func'](self)
                if findings:
                    for finding in findings:
                        if isinstance(finding, Finding):
                            self.scan_result.add_finding(finding)
                    print(f"   âš ï¸  Found {len(findings)} issue(s)")
                else:
                    print(f"   âœ… No issues found")
            except Exception as e:
                print(f"   âŒ Error: {str(e)}")
            print()
        
        # Update summary
        self.scan_result.summary.total_checks = len(self.checks)
        
        return self.scan_result
    
    def _verify_authorization(self) -> bool:
        """Verify authorization to scan (placeholder)"""
        # In real implementation, check:
        # - Internal network flag
        # - Authorization file
        # - User confirmation
        
        # For active-light mode, require explicit confirmation
        if self.scan_result.metadata.scanner_mode == 'active-light':
            if not self.config.allow_active_light():
                return False
        
        return True  # Placeholder - in production, implement proper checks
    
    def get_result(self) -> ScanResult:
        """Get scan result"""
        return self.scan_result

