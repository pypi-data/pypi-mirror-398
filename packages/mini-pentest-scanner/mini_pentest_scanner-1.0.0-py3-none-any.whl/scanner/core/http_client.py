"""
HTTP Client - Wrapper for making requests
Non-intrusive request handling
"""

import requests
from typing import Optional, Dict, Any
from urllib.parse import urljoin

class HTTPClient:
    """HTTP client for scanner (Non-intrusive)"""
    
    def __init__(self, base_url: str, timeout: int = 10, user_agent: str = "SecurityScanner/1.0"):
        self.base_url = base_url.rstrip('/')
        self.timeout = timeout
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': user_agent
        })
    
    def get(self, path: str, params: Optional[Dict] = None, **kwargs) -> Optional[requests.Response]:
        """Make GET request"""
        try:
            url = urljoin(self.base_url, path)
            response = self.session.get(url, params=params, timeout=self.timeout, **kwargs)
            return response
        except requests.RequestException as e:
            return None
    
    def post(self, path: str, data: Optional[Dict] = None, json: Optional[Dict] = None, **kwargs) -> Optional[requests.Response]:
        """Make POST request"""
        try:
            url = urljoin(self.base_url, path)
            response = self.session.post(url, data=data, json=json, timeout=self.timeout, **kwargs)
            return response
        except requests.RequestException as e:
            return None
    
    def observe_response(self, response: requests.Response) -> Dict[str, Any]:
        """Observe response characteristics (Non-intrusive)"""
        if not response:
            return {}
        
        return {
            'status_code': response.status_code,
            'headers': dict(response.headers),
            'content_length': len(response.content),
            'content_type': response.headers.get('Content-Type', ''),
            'has_cookies': len(response.cookies) > 0,
            'cookies': {name: cookie.value for name, cookie in response.cookies.items()}
        }
    
    def check_security_headers(self, response: requests.Response) -> Dict[str, bool]:
        """Check presence of security headers (Non-intrusive)"""
        if not response:
            return {}
        
        security_headers = [
            'X-Content-Type-Options',
            'X-Frame-Options',
            'X-XSS-Protection',
            'Strict-Transport-Security',
            'Content-Security-Policy',
            'Referrer-Policy'
        ]
        
        result = {}
        for header in security_headers:
            result[header] = header in response.headers
        
        return result

