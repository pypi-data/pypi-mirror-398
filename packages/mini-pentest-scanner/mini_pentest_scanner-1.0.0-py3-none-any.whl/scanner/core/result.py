"""
Result Schema - มาตรฐานสำหรับผลการสแกน
Non-intrusive Security Scanner Result Format
"""

from dataclasses import dataclass, field, asdict
from typing import List, Dict, Optional, Any
from datetime import datetime
import uuid
import json

@dataclass
class Location:
    """Location of a finding"""
    type: str  # endpoint, header, cookie, config, logic
    path: Optional[str] = None
    method: Optional[str] = None
    parameter: Optional[str] = None
    
    def to_dict(self):
        return {
            'type': self.type,
            'path': self.path,
            'method': self.method,
            'parameter': self.parameter
        }

@dataclass
class Evidence:
    """Evidence of a finding (Non-intrusive observation)"""
    request_observed: bool = False
    response_pattern: Optional[str] = None
    notes: Optional[str] = None
    
    def to_dict(self):
        return {
            'request_observed': self.request_observed,
            'response_pattern': self.response_pattern,
            'notes': self.notes
        }

@dataclass
class Finding:
    """Single security finding"""
    id: str
    title: str
    category: str
    severity: str  # critical, high, medium, low
    confidence: str  # high, medium, low
    description: str
    impact: str
    location: Location
    evidence: Evidence
    recommendation: str
    references: List[str] = field(default_factory=list)
    
    def to_dict(self):
        return {
            'id': self.id,
            'title': self.title,
            'category': self.category,
            'severity': self.severity,
            'confidence': self.confidence,
            'description': self.description,
            'impact': self.impact,
            'location': self.location.to_dict(),
            'evidence': self.evidence.to_dict(),
            'recommendation': self.recommendation,
            'references': self.references
        }

@dataclass
class Summary:
    """Scan summary statistics"""
    total_checks: int = 0
    total_findings: int = 0
    severity_count: Dict[str, int] = field(default_factory=lambda: {
        'critical': 0,
        'high': 0,
        'medium': 0,
        'low': 0
    })
    risk_score: int = 0  # 0-100
    
    def to_dict(self):
        return {
            'total_checks': self.total_checks,
            'total_findings': self.total_findings,
            'severity_count': self.severity_count,
            'risk_score': self.risk_score
        }
    
    def calculate_risk_score(self):
        """Calculate risk score based on findings"""
        weights = {
            'critical': 25,
            'high': 15,
            'medium': 8,
            'low': 3
        }
        score = 0
        for severity, count in self.severity_count.items():
            score += weights.get(severity, 0) * count
        self.risk_score = min(100, score)
        return self.risk_score

@dataclass
class ScanMetadata:
    """Scan metadata"""
    scanner_mode: str = "passive"  # passive, active-light
    scan_policy: str = "internal-assessment"
    legal_scope: str = "authorized-only"
    scanner_version: str = "1.0.0"
    
    def to_dict(self):
        return {
            'scanner_mode': self.scanner_mode,
            'scan_policy': self.scan_policy,
            'legal_scope': self.legal_scope,
            'scanner_version': self.scanner_version
        }

@dataclass
class ScanResult:
    """Complete scan result following standard schema"""
    scan_id: str
    target: str
    scan_time: str
    summary: Summary
    findings: List[Finding]
    metadata: ScanMetadata
    
    def __init__(self, target: str, scanner_mode: str = "passive"):
        self.scan_id = str(uuid.uuid4())[:8]
        self.target = target
        self.scan_time = datetime.utcnow().isoformat() + 'Z'
        self.summary = Summary()
        self.findings = []
        self.metadata = ScanMetadata(scanner_mode=scanner_mode)
    
    def add_finding(self, finding: Finding):
        """Add a finding and update summary"""
        self.findings.append(finding)
        self.summary.total_findings += 1
        self.summary.severity_count[finding.severity] = \
            self.summary.severity_count.get(finding.severity, 0) + 1
        self.summary.calculate_risk_score()
    
    def to_dict(self):
        """Convert to dictionary"""
        return {
            'scan_id': self.scan_id,
            'target': self.target,
            'scan_time': self.scan_time,
            'scanner_version': self.metadata.scanner_version,
            'summary': self.summary.to_dict(),
            'findings': [f.to_dict() for f in self.findings],
            'metadata': self.metadata.to_dict()
        }
    
    def to_json(self, indent=2):
        """Convert to JSON string"""
        return json.dumps(self.to_dict(), indent=indent, ensure_ascii=False)
    
    def save_json(self, filepath: str):
        """Save to JSON file"""
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(self.to_json())

