"""
Session Management Check
ตรวจสอบปัญหาการจัดการ session (Non-intrusive)
"""

from typing import List
from scanner.core.engine import ScannerEngine
from scanner.core.result import Finding, Location, Evidence

def check_new(engine: ScannerEngine) -> List[Finding]:
    """Check for session management issues (New format using Result Schema)"""
    findings = []
    
    # Only run in active-light mode
    if engine.scan_result.metadata.scanner_mode == 'passive':
        return findings
    
    try:
        # Login first
        login_response = engine.http_client.post('/login', data={
            'username': 'user1',
            'password': 'password123'
        })
        
        if not login_response:
            return findings
        
        # Observe session cookies (Non-intrusive)
        cookies = engine.http_client.session.cookies
        
        for cookie in cookies:
            cookie_dict = cookie.__dict__
            
            # Check for HttpOnly flag
            cookie_str = str(cookie).lower()
            if 'httponly' not in cookie_str:
                finding = Finding(
                    id="SESSION-HTTPONLY-001",
                    title="Missing HttpOnly Flag on Session Cookie",
                    category="Authentication",
                    severity="medium",
                    confidence="high",
                    description=f"Session cookie '{cookie.name}' missing HttpOnly flag",
                    impact="Cookies without HttpOnly flag are accessible via JavaScript, making them vulnerable to XSS attacks.",
                    location=Location(
                        type="cookie",
                        path="/login",
                        method="POST"
                    ),
                    evidence=Evidence(
                        request_observed=True,
                        response_pattern=f"Cookie '{cookie.name}' does not have HttpOnly flag",
                        notes="Session cookie can be accessed via JavaScript"
                    ),
                    recommendation="Set HttpOnly flag on all session cookies to prevent JavaScript access.",
                    references=[
                        "OWASP Top 10 - A07:2021 Identification and Authentication Failures",
                        "CWE-1004: Sensitive Cookie Without 'HttpOnly' Flag"
                    ]
                )
                findings.append(finding)
            
            # Check for SameSite attribute
            if 'samesite' not in cookie_str:
                finding = Finding(
                    id="SESSION-SAMESITE-001",
                    title="Missing SameSite Attribute on Session Cookie",
                    category="Authentication",
                    severity="low",
                    confidence="high",
                    description=f"Session cookie '{cookie.name}' missing SameSite attribute",
                    impact="Cookies without SameSite attribute are vulnerable to CSRF attacks.",
                    location=Location(
                        type="cookie",
                        path="/login",
                        method="POST"
                    ),
                    evidence=Evidence(
                        request_observed=True,
                        response_pattern=f"Cookie '{cookie.name}' does not have SameSite attribute",
                        notes="Session cookie missing CSRF protection"
                    ),
                    recommendation="Set SameSite=Strict or SameSite=Lax attribute on session cookies to prevent CSRF attacks.",
                    references=[
                        "OWASP Top 10 - A07:2021 Identification and Authentication Failures"
                    ]
                )
                findings.append(finding)
        
        # Test session fixation (Observe behavior)
        old_session_id = engine.http_client.session.cookies.get('session', '')
        
        # Login again
        login_response2 = engine.http_client.post('/login', data={
            'username': 'user1',
            'password': 'password123'
        })
        
        if login_response2:
            new_session_id = engine.http_client.session.cookies.get('session', '')
            
            # Observe if session ID changed (Non-intrusive)
            if old_session_id and new_session_id and old_session_id == new_session_id:
                finding = Finding(
                    id="SESSION-FIXATION-001",
                    title="Session Fixation Vulnerability",
                    category="Authentication",
                    severity="medium",
                    confidence="high",
                    description="Session ID not regenerated after login",
                    impact="Attackers can fix a session ID and trick users into using it, allowing the attacker to hijack the session after the user logs in.",
                    location=Location(
                        type="endpoint",
                        path="/login",
                        method="POST"
                    ),
                    evidence=Evidence(
                        request_observed=True,
                        response_pattern="Session ID remains unchanged after authentication",
                        notes="Application does not regenerate session ID upon successful login"
                    ),
                    recommendation="Regenerate session ID after successful authentication. Invalidate old session and create a new one.",
                    references=[
                        "OWASP Top 10 - A07:2021 Identification and Authentication Failures",
                        "CWE-384: Session Fixation"
                    ]
                )
                findings.append(finding)
        
        # Check if session persists after logout (Observe behavior)
        logout_response = engine.http_client.get('/logout')
        
        if logout_response:
            # Try to access protected page after logout
            dashboard_response = engine.http_client.get('/dashboard')
            
            if dashboard_response and dashboard_response.status_code == 200:
                finding = Finding(
                    id="SESSION-LOGOUT-001",
                    title="Session Not Properly Cleared on Logout",
                    category="Authentication",
                    severity="high",
                    confidence="high",
                    description="Can still access protected pages after logout",
                    impact="Sessions remain valid after logout, allowing unauthorized access if session tokens are compromised.",
                    location=Location(
                        type="endpoint",
                        path="/logout",
                        method="GET"
                    ),
                    evidence=Evidence(
                        request_observed=True,
                        response_pattern="Protected resources accessible after logout",
                        notes="Logout endpoint does not properly invalidate session"
                    ),
                    recommendation="Properly invalidate session on logout. Clear session data and expire session cookies.",
                    references=[
                        "OWASP Top 10 - A07:2021 Identification and Authentication Failures"
                    ]
                )
                findings.append(finding)
    
    except Exception as e:
        pass
    
    return findings

# Legacy function
def check(base_url, session):
    """Legacy check function"""
    return {
        'status': 'info',
        'message': 'Please use check_new() with ScannerEngine'
    }
