"""
Authentication Issues Check
ตรวจสอบปัญหาการ authentication (Non-intrusive)
"""

import time
from typing import List
from scanner.core.engine import ScannerEngine
from scanner.core.result import Finding, Location, Evidence

def check_new(engine: ScannerEngine) -> List[Finding]:
    """Check for authentication issues (New format using Result Schema)"""
    findings = []
    
    # Only run in active-light mode
    if engine.scan_result.metadata.scanner_mode == 'passive':
        return findings
    
    # Test for weak password policy
    weak_passwords = ['123', 'password']
    
    try:
        for weak_pwd in weak_passwords:
            test_data = {
                'username': f'test_user_{int(time.time())}',
                'password': weak_pwd,
                'email': f'test{int(time.time())}@test.com'
            }
            
            response = engine.http_client.post('/register', data=test_data)
            
            if not response:
                continue
            
            # Observe response (Non-intrusive)
            if response.status_code == 302 or 'success' in response.text.lower():
                finding = Finding(
                    id="AUTH-WEAK-PWD-001",
                    title="Weak Password Policy",
                    category="Authentication",
                    severity="medium",
                    confidence="high",
                    description="Weak password was accepted during registration",
                    impact="Weak passwords are easily guessable and vulnerable to brute force attacks.",
                    location=Location(
                        type="endpoint",
                        path="/register",
                        method="POST",
                        parameter="password"
                    ),
                    evidence=Evidence(
                        request_observed=True,
                        response_pattern=f"Weak password '{weak_pwd}' was accepted",
                        notes="Registration endpoint does not enforce strong password requirements"
                    ),
                    recommendation="Implement password complexity requirements (minimum length, character variety). Consider using password strength meters and enforcing password policies.",
                    references=[
                        "OWASP Top 10 - A07:2021 Identification and Authentication Failures",
                        "CWE-521: Weak Password Requirements"
                    ]
                )
                findings.append(finding)
                break
    except:
        pass
    
    # Test for rate limiting (brute force protection) - Passive observation
    try:
        failed_attempts = 0
        for i in range(5):  # Limited attempts for active-light
            response = engine.http_client.post('/login', data={
                'username': 'nonexistent_user',
                'password': 'wrong_password'
            })
            
            if not response:
                break
            
            if response.status_code == 200:
                failed_attempts += 1
            else:
                break
        
        if failed_attempts >= 5:
            finding = Finding(
                id="AUTH-RATE-LIMIT-001",
                title="Missing Rate Limiting on Login",
                category="Authentication",
                severity="high",
                confidence="medium",
                description="No rate limiting detected on login endpoint",
                impact="Lack of rate limiting allows brute force attacks against user accounts.",
                location=Location(
                    type="endpoint",
                    path="/login",
                    method="POST"
                ),
                evidence=Evidence(
                    request_observed=True,
                    response_pattern=f"Multiple failed login attempts ({failed_attempts}) allowed without restriction",
                    notes="Login endpoint does not implement rate limiting"
                ),
                recommendation="Implement rate limiting (e.g., max 5 attempts per 15 minutes per IP). Consider account lockout after repeated failures.",
                references=[
                    "OWASP Top 10 - A07:2021 Identification and Authentication Failures",
                    "CWE-307: Improper Restriction of Excessive Authentication Attempts"
                ]
            )
            findings.append(finding)
    except:
        pass
    
    # Test for account enumeration (Passive observation)
    try:
        # Test with existing username
        response1 = engine.http_client.post('/login', data={
            'username': 'admin',
            'password': 'wrong_password'
        })
        
        # Test with non-existing username
        response2 = engine.http_client.post('/login', data={
            'username': 'nonexistent_user_12345',
            'password': 'wrong_password'
        })
        
        if response1 and response2:
            # Observe response differences (Non-intrusive)
            if response1.text != response2.text:
                if 'username' in response1.text.lower() or 'user' in response1.text.lower():
                    finding = Finding(
                        id="AUTH-ENUM-001",
                        title="Account Enumeration Vulnerability",
                        category="Authentication",
                        severity="low",
                        confidence="medium",
                        description="Different error messages for existing vs non-existing users",
                        impact="Attackers can enumerate valid usernames, which is the first step in targeted attacks.",
                        location=Location(
                            type="endpoint",
                            path="/login",
                            method="POST",
                            parameter="username"
                        ),
                        evidence=Evidence(
                            request_observed=True,
                            response_pattern="Different error messages reveal whether username exists",
                            notes="Login endpoint provides different responses for valid vs invalid usernames"
                        ),
                        recommendation="Use generic error messages for both invalid username and invalid password. Do not reveal whether a username exists in the system.",
                        references=[
                            "OWASP Top 10 - A07:2021 Identification and Authentication Failures",
                            "CWE-204: Observable Response Discrepancy"
                        ]
                    )
                    findings.append(finding)
    except:
        pass
    
    return findings

# Legacy function
def check(base_url, session):
    """Legacy check function"""
    return {
        'status': 'info',
        'message': 'Please use check_new() with ScannerEngine'
    }
