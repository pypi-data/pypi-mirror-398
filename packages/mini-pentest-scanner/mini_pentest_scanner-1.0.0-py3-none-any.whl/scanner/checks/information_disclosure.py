"""
Information Disclosure Check
ตรวจสอบการเปิดเผยข้อมูลมากเกินไป (Non-intrusive)
"""

import re
from typing import List
from scanner.core.engine import ScannerEngine
from scanner.core.result import Finding, Location, Evidence

def check_new(engine: ScannerEngine) -> List[Finding]:
    """Check for information disclosure (New format using Result Schema)"""
    findings = []
    
    # Test endpoints (Passive - just observe)
    test_endpoints = [
        {
            'path': '/debug',
            'name': 'Debug endpoint',
            'risk': 'high'
        },
        {
            'path': '/nonexistent-page-12345',
            'name': '404 error page',
            'risk': 'medium'
        }
    ]
    
    for endpoint in test_endpoints:
        try:
            response = engine.http_client.get(endpoint['path'])
            
            if not response:
                continue
            
            response_text = response.text
            
            # Check for sensitive information patterns (Non-intrusive observation)
            sensitive_patterns = [
                (r'python version|python_version', 'Python version'),
                (r'sqlite3|sqlite version', 'Database type'),
                (r'flask|werkzeug', 'Framework information'),
                (r'file.*path|file_path|filepath', 'File paths'),
                (r'stack trace|traceback', 'Stack trace'),
                (r'database.*error|db.*error', 'Database errors'),
                (r'operationalerror|integrityerror', 'SQL error details'),
                (r'request.*headers|request_headers', 'Request headers'),
                (r'environment|env\[', 'Environment variables'),
                (r'session.*data|session_data', 'Session data'),
            ]
            
            detected_info = []
            for pattern, description in sensitive_patterns:
                if re.search(pattern, response_text, re.IGNORECASE):
                    detected_info.append(description)
            
            if detected_info:
                finding = Finding(
                    id=f"INFO-{endpoint['path'].replace('/', '').replace('-', '')}-001",
                    title="Information Disclosure",
                    category="Security Misconfiguration",
                    severity=endpoint['risk'],
                    confidence="high",
                    description=f"Sensitive information disclosed in {endpoint['name']}",
                    impact="Disclosed information may help attackers understand the system architecture and identify potential attack vectors.",
                    location=Location(
                        type="endpoint",
                        path=endpoint['path'],
                        method="GET"
                    ),
                    evidence=Evidence(
                        request_observed=True,
                        response_pattern=f"Disclosed information: {', '.join(detected_info)}",
                        notes="Response contains sensitive system information"
                    ),
                    recommendation="Use generic error messages in production. Remove debug endpoints. Implement proper error handling that does not expose system details.",
                    references=[
                        "OWASP Top 10 - A05:2021 Security Misconfiguration",
                        "CWE-209: Information Exposure Through an Error Message"
                    ]
                )
                findings.append(finding)
            
            # Check for detailed error messages
            if endpoint['name'] == '404 error page' and len(response_text) > 500:
                if 'traceback' in response_text.lower() or 'file' in response_text.lower():
                    finding = Finding(
                        id="INFO-404-001",
                        title="Detailed Error Message Disclosure",
                        category="Security Misconfiguration",
                        severity="medium",
                        confidence="high",
                        description="Error page contains detailed stack trace or file paths",
                        impact="Stack traces and file paths can reveal system structure and potential attack surfaces.",
                        location=Location(
                            type="endpoint",
                            path=endpoint['path'],
                            method="GET"
                        ),
                        evidence=Evidence(
                            request_observed=True,
                            response_pattern="Detailed error message with stack trace or file paths",
                            notes="Error response is too verbose"
                        ),
                        recommendation="Implement generic error pages that do not expose technical details.",
                        references=[
                            "OWASP Top 10 - A05:2021 Security Misconfiguration"
                        ]
                    )
                    findings.append(finding)
        
        except Exception as e:
            continue
    
    # Check response headers (Passive)
    try:
        response = engine.http_client.get('/')
        if response:
            headers = response.headers
            
            # Check for server information
            if 'Server' in headers:
                server_info = headers['Server']
                if 'python' in server_info.lower() or 'flask' in server_info.lower():
                    finding = Finding(
                        id="INFO-HEADER-001",
                        title="Server Information Disclosure in Headers",
                        category="Security Misconfiguration",
                        severity="low",
                        confidence="high",
                        description="Server header discloses framework/technology information",
                        impact="Disclosed server information may help attackers identify known vulnerabilities.",
                        location=Location(
                            type="header",
                            path="/",
                            method="GET"
                        ),
                        evidence=Evidence(
                            request_observed=True,
                            response_pattern=f"Server header: {server_info}",
                            notes="Server header contains framework information"
                        ),
                        recommendation="Remove or minimize Server header information. Use generic server identifiers.",
                        references=[
                            "OWASP Top 10 - A05:2021 Security Misconfiguration"
                        ]
                    )
                    findings.append(finding)
            
            # Check for X-Powered-By header
            if 'X-Powered-By' in headers:
                finding = Finding(
                    id="INFO-HEADER-002",
                    title="X-Powered-By Header Disclosure",
                    category="Security Misconfiguration",
                    severity="low",
                    confidence="high",
                    description="X-Powered-By header discloses technology stack",
                    impact="Technology stack information may help attackers identify known vulnerabilities.",
                    location=Location(
                        type="header",
                        path="/",
                        method="GET"
                    ),
                    evidence=Evidence(
                        request_observed=True,
                        response_pattern=f"X-Powered-By: {headers['X-Powered-By']}",
                        notes="X-Powered-By header present"
                    ),
                    recommendation="Remove X-Powered-By header in production.",
                    references=[
                        "OWASP Top 10 - A05:2021 Security Misconfiguration"
                    ]
                )
                findings.append(finding)
    except:
        pass
    
    return findings

# Legacy function
def check(base_url, session):
    """Legacy check function"""
    return {
        'status': 'info',
        'message': 'Please use check_new() with ScannerEngine'
    }
