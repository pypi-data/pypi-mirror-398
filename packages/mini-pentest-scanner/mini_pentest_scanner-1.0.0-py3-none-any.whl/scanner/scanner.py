"""
Security Scanner - Non-intrusive Security Assessment Tool
à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸Šà¹ˆà¸­à¸‡à¹‚à¸«à¸§à¹ˆà¹€à¸Šà¸´à¸‡à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ (Non-intrusive)

âš ï¸ à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸: à¹ƒà¸Šà¹‰à¹€à¸žà¸·à¹ˆà¸­à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¹‚à¸ˆà¸¡à¸•à¸µ à¹à¸•à¹ˆà¹€à¸›à¹‡à¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢
"""

import sys
import argparse
from pathlib import Path
from scanner.core.engine import ScannerEngine
from scanner.core.config import ScannerConfig
from scanner.core.result import ScanResult
from scanner.checks import (
    sql_injection, xss, idor, information_disclosure,
    authentication, session_management
)

class SecurityScanner:
    """Main Security Scanner Class"""
    
    def __init__(self, base_url: str, config: ScannerConfig = None):
        self.base_url = base_url
        self.config = config or ScannerConfig()
        self.engine = ScannerEngine(base_url, self.config)
        self._register_checks()
    
    def _register_checks(self):
        """Register all security checks"""
        # Register checks with engine
        self.engine.register_check(
            sql_injection.check_new,
            "SQL Injection",
            "Injection"
        )
        self.engine.register_check(
            xss.check_new,
            "Cross-Site Scripting (XSS)",
            "Injection"
        )
        self.engine.register_check(
            idor.check_new,
            "Insecure Direct Object Reference (IDOR)",
            "Access Control"
        )
        self.engine.register_check(
            information_disclosure.check_new,
            "Information Disclosure",
            "Security Misconfiguration"
        )
        self.engine.register_check(
            authentication.check_new,
            "Authentication Issues",
            "Authentication"
        )
        self.engine.register_check(
            session_management.check_new,
            "Session Management",
            "Authentication"
        )
    
    def scan(self, policy: str = None, enabled_checks: list = None) -> ScanResult:
        """Run security scan"""
        # Set policy if provided
        if policy:
            self.config.set('scanner.mode', policy)
            self.engine.scan_result.metadata.scanner_mode = policy
        
        # Run scan
        result = self.engine.run_scan(enabled_checks)
        
        # Generate and save reports
        self._generate_reports(result)
        
        return result
    
    def _generate_reports(self, result: ScanResult):
        """Generate reports in multiple formats"""
        output_dir = Path(self.config.get('reports.output_dir', 'reports'))
        formats = self.config.get('reports.output_formats', ['json'])
        
        # Create output directories
        for fmt in formats:
            (output_dir / fmt).mkdir(parents=True, exist_ok=True)
        
        # Generate timestamp
        from datetime import datetime
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        
        # Save JSON
        if 'json' in formats:
            json_path = output_dir / 'json' / f'scan_{timestamp}.json'
            result.save_json(str(json_path))
            print(f"ðŸ“„ JSON Report: {json_path}")
        
        # Save HTML (placeholder - will implement)
        if 'html' in formats:
            html_path = output_dir / 'html' / f'scan_{timestamp}.html'
            self._generate_html_report(result, html_path)
            print(f"ðŸ“„ HTML Report: {html_path}")
        
        # Save PDF (placeholder - will implement)
        if 'pdf' in formats:
            pdf_path = output_dir / 'pdf' / f'scan_{timestamp}.pdf'
            print(f"ðŸ“„ PDF Report: {pdf_path} (Not yet implemented)")
    
    def _generate_html_report(self, result: ScanResult, filepath: Path):
        """Generate HTML report"""
        html_content = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Scan Report - {result.target}</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
        .container {{ max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }}
        h1 {{ color: #1e3c72; }}
        .summary {{ background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }}
        .finding {{ border-left: 4px solid #dc3545; padding: 15px; margin: 15px 0; background: #fff; }}
        .finding.high {{ border-color: #dc3545; }}
        .finding.medium {{ border-color: #ffc107; }}
        .finding.low {{ border-color: #17a2b8; }}
        .severity {{ font-weight: bold; }}
        .severity.critical {{ color: #dc3545; }}
        .severity.high {{ color: #dc3545; }}
        .severity.medium {{ color: #ffc107; }}
        .severity.low {{ color: #17a2b8; }}
    </style>
</head>
<body>
    <div class="container">
        <h1>Security Scan Report</h1>
        <p><strong>Target:</strong> {result.target}</p>
        <p><strong>Scan Time:</strong> {result.scan_time}</p>
        <p><strong>Scan ID:</strong> {result.scan_id}</p>
        
        <div class="summary">
            <h2>Summary</h2>
            <p><strong>Total Checks:</strong> {result.summary.total_checks}</p>
            <p><strong>Total Findings:</strong> {result.summary.total_findings}</p>
            <p><strong>Risk Score:</strong> {result.summary.risk_score}/100</p>
            <p><strong>Severity Breakdown:</strong></p>
            <ul>
                <li>Critical: {result.summary.severity_count.get('critical', 0)}</li>
                <li>High: {result.summary.severity_count.get('high', 0)}</li>
                <li>Medium: {result.summary.severity_count.get('medium', 0)}</li>
                <li>Low: {result.summary.severity_count.get('low', 0)}</li>
            </ul>
        </div>
        
        <h2>Findings</h2>
"""
        
        for finding in result.findings:
            html_content += f"""
        <div class="finding {finding.severity}">
            <h3>{finding.title} <span class="severity {finding.severity}">[{finding.severity.upper()}]</span></h3>
            <p><strong>Category:</strong> {finding.category}</p>
            <p><strong>Confidence:</strong> {finding.confidence}</p>
            <p><strong>Description:</strong> {finding.description}</p>
            <p><strong>Impact:</strong> {finding.impact}</p>
            <p><strong>Location:</strong> {finding.location.path} ({finding.location.method})</p>
            <p><strong>Recommendation:</strong> {finding.recommendation}</p>
        </div>
"""
        
        html_content += """
    </div>
</body>
</html>
"""
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(html_content)

def main():
    """Main entry point"""
    parser = argparse.ArgumentParser(
        description='Security Scanner - Non-intrusive Security Assessment Tool'
    )
    parser.add_argument('target', help='Target URL to scan')
    parser.add_argument(
        '--policy',
        choices=['passive', 'active-light'],
        default='passive',
        help='Scan policy (default: passive)'
    )
    parser.add_argument(
        '--config',
        help='Path to config file (default: config.yaml)'
    )
    parser.add_argument(
        '--checks',
        nargs='+',
        help='Specific checks to run (default: all)'
    )
    
    args = parser.parse_args()
    
    # Load config
    config = ScannerConfig(args.config) if args.config else ScannerConfig()
    
    # Create scanner
    scanner = SecurityScanner(args.target, config)
    
    # Run scan
    result = scanner.scan(policy=args.policy, enabled_checks=args.checks)
    
    # Print summary
    print("\n" + "=" * 60)
    print("ðŸ“Š Scan Summary")
    print("=" * 60)
    print(f"Total Checks: {result.summary.total_checks}")
    print(f"Total Findings: {result.summary.total_findings}")
    print(f"Risk Score: {result.summary.risk_score}/100")
    print(f"Severity: Critical={result.summary.severity_count.get('critical', 0)}, "
          f"High={result.summary.severity_count.get('high', 0)}, "
          f"Medium={result.summary.severity_count.get('medium', 0)}, "
          f"Low={result.summary.severity_count.get('low', 0)}")
    print("=" * 60)
    print("ðŸ’¡ Remember: This is for educational purposes only!")
    print("=" * 60)

if __name__ == '__main__':
    main()
