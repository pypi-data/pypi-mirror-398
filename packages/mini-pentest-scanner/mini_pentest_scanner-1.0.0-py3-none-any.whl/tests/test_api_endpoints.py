# -*- coding: utf-8 -*-
"""
API Endpoints Tests
ทดสอบ API endpoints ทั้งหมด
"""

import unittest
import sys
import os
import tempfile
import shutil
from pathlib import Path

# Add project root to path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

# Mock Flask app for testing
import json
from mini_pentest_scanner.history.database import ScanHistoryDB
from mini_pentest_scanner.history.comparison import ScanComparison
from mini_pentest_scanner.history.trends import TrendAnalyzer
from mini_pentest_scanner.history.baseline import BaselineManager
from mini_pentest_scanner.history.compliance import ComplianceMapper
from mini_pentest_scanner.core.result import ScanResult, Finding, Location, Evidence


class TestAPIEndpoints(unittest.TestCase):
    """Test API endpoint logic"""
    
    def setUp(self):
        """Set up test database"""
        self.temp_dir = tempfile.mkdtemp()
        self.db_path = os.path.join(self.temp_dir, 'test_api.db')
        self.db = ScanHistoryDB(db_path=self.db_path)
        self.target_url = "http://example.com"
        
        # Create test scans
        result1 = ScanResult(target=self.target_url, scanner_mode="passive")
        self.scan_id1 = self.db.save_scan(result1.to_dict())
        
        result2 = ScanResult(target=self.target_url, scanner_mode="passive")
        finding = Finding(
            id="API-001", title="API Test", category="Test",
            severity="high", confidence="medium", description="Test",
            impact="Impact", location=Location(type="endpoint"),
            evidence=Evidence(), recommendation="Fix"
        )
        result2.add_finding(finding)
        self.scan_id2 = self.db.save_scan(result2.to_dict())
    
    def tearDown(self):
        """Clean up"""
        shutil.rmtree(self.temp_dir, ignore_errors=True)
    
    def test_api_history_get_all(self):
        """Test: GET /api/history"""
        scans = self.db.get_all_scans(limit=100)
        self.assertIsInstance(scans, list)
        self.assertGreaterEqual(len(scans), 2)
    
    def test_api_history_get_by_target(self):
        """Test: GET /api/history?target=..."""
        scans = self.db.get_scans_by_target(self.target_url, limit=100)
        self.assertIsInstance(scans, list)
        self.assertGreaterEqual(len(scans), 2)
    
    def test_api_history_get_scan(self):
        """Test: GET /api/history/<scan_id>"""
        scan = self.db.get_scan(self.scan_id1)
        self.assertIsNotNone(scan)
        self.assertEqual(scan['target'], self.target_url)
    
    def test_api_history_get_scan_not_found(self):
        """Test: GET /api/history/<scan_id> - not found"""
        scan = self.db.get_scan("nonexistent")
        self.assertIsNone(scan)
    
    def test_api_compare(self):
        """Test: GET /api/compare/<id1>/<id2>"""
        comparison = ScanComparison(self.db)
        result = comparison.compare_scans(self.scan_id1, self.scan_id2)
        
        self.assertIn('risk_comparison', result)
        self.assertIn('findings_comparison', result)
        self.assertIn('scan1', result)
        self.assertIn('scan2', result)
    
    def test_api_compare_invalid(self):
        """Test: GET /api/compare/<id1>/<id2> - invalid"""
        comparison = ScanComparison(self.db)
        
        with self.assertRaises(ValueError):
            comparison.compare_scans("", self.scan_id2)
        
        with self.assertRaises(ValueError):
            comparison.compare_scans(self.scan_id1, "")
    
    def test_api_trends(self):
        """Test: GET /api/trends?target=...&days=..."""
        analyzer = TrendAnalyzer(self.db)
        trends = analyzer.analyze_trends(self.target_url, days=30)
        
        self.assertIn('target_url', trends)
        self.assertIn('risk_trend', trends)
        self.assertIn('findings_trend', trends)
    
    def test_api_trends_invalid(self):
        """Test: GET /api/trends - invalid parameters"""
        analyzer = TrendAnalyzer(self.db)
        
        with self.assertRaises(ValueError):
            analyzer.analyze_trends("", days=30)
        
        with self.assertRaises(ValueError):
            analyzer.analyze_trends(self.target_url, days=0)
    
    def test_api_baseline_set(self):
        """Test: POST /api/baseline"""
        baseline_mgr = BaselineManager(self.db)
        success = baseline_mgr.set_baseline(self.target_url, self.scan_id1)
        self.assertTrue(success)
        
        baseline_id = baseline_mgr.get_baseline(self.target_url)
        self.assertEqual(baseline_id, self.scan_id1)
    
    def test_api_baseline_get(self):
        """Test: GET /api/baseline/<target_url>"""
        baseline_mgr = BaselineManager(self.db)
        baseline_mgr.set_baseline(self.target_url, self.scan_id1)
        
        baseline_info = baseline_mgr.get_baseline_info(self.target_url)
        self.assertIsNotNone(baseline_info)
        self.assertEqual(baseline_info['baseline_scan_id'], self.scan_id1)
    
    def test_api_baseline_not_set(self):
        """Test: GET /api/baseline/<target_url> - not set"""
        baseline_mgr = BaselineManager(self.db)
        baseline_id = baseline_mgr.get_baseline("http://nonexistent.com")
        self.assertIsNone(baseline_id)
    
    def test_api_compliance(self):
        """Test: GET /api/compliance/<scan_id>"""
        mapper = ComplianceMapper(self.db)
        compliance = mapper.map_scan_to_compliance(self.scan_id2, ['ISO27001'])
        
        self.assertIn('compliance', compliance)
        self.assertIn('ISO27001', compliance['compliance'])
        self.assertIn('summary', compliance)
    
    def test_api_compliance_multiple_standards(self):
        """Test: GET /api/compliance/<scan_id>?standards=ISO27001,SOC2"""
        mapper = ComplianceMapper(self.db)
        compliance = mapper.map_scan_to_compliance(
            self.scan_id2, 
            ['ISO27001', 'SOC2', 'OWASP_ASVS']
        )
        
        self.assertIn('compliance', compliance)
        self.assertIn('ISO27001', compliance['compliance'])
        self.assertIn('SOC2', compliance['compliance'])
        self.assertIn('OWASP_ASVS', compliance['compliance'])
    
    def test_api_compliance_invalid(self):
        """Test: GET /api/compliance/<scan_id> - invalid"""
        mapper = ComplianceMapper(self.db)
        
        with self.assertRaises(ValueError):
            mapper.map_scan_to_compliance("", ['ISO27001'])
        
        with self.assertRaises(ValueError):
            mapper.map_scan_to_compliance(self.scan_id2, ['INVALID'])


class TestAPIErrorHandling(unittest.TestCase):
    """Test API error handling"""
    
    def setUp(self):
        """Set up test database"""
        self.temp_dir = tempfile.mkdtemp()
        self.db_path = os.path.join(self.temp_dir, 'test_api_errors.db')
        self.db = ScanHistoryDB(db_path=self.db_path)
    
    def tearDown(self):
        """Clean up"""
        shutil.rmtree(self.temp_dir, ignore_errors=True)
    
    def test_api_error_handling_empty_database(self):
        """Test: API handles empty database gracefully"""
        # All operations should work with empty database
        scans = self.db.get_all_scans()
        self.assertEqual(len(scans), 0)
        
        scan = self.db.get_scan("nonexistent")
        self.assertIsNone(scan)
        
        analyzer = TrendAnalyzer(self.db)
        trends = analyzer.analyze_trends("http://test.com", days=30)
        self.assertFalse(trends.get('has_enough_data', True))
    
    def test_api_error_handling_invalid_parameters(self):
        """Test: API handles invalid parameters"""
        # Invalid limit
        scans = self.db.get_all_scans(limit=-1)
        self.assertIsInstance(scans, list)  # Should default to 100
        
        scans = self.db.get_all_scans(limit=99999)
        self.assertIsInstance(scans, list)  # Should cap at 10000
        
        # Empty target
        scans = self.db.get_scans_by_target("", limit=100)
        self.assertEqual(len(scans), 0)


if __name__ == '__main__':
    unittest.main(verbosity=2)

