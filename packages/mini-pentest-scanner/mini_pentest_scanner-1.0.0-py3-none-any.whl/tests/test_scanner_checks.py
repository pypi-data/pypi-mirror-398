"""
Unit Tests for Scanner Checks
ทดสอบ security checks
"""

import unittest
import sys
from pathlib import Path
from unittest.mock import Mock, MagicMock

# Add project root to path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from mini_pentest_scanner.core.engine import ScannerEngine
from mini_pentest_scanner.core.config import ScannerConfig
from mini_pentest_scanner.core.result import ScanResult


class TestScannerChecks(unittest.TestCase):
    """Test security checks"""
    
    def setUp(self):
        """Setup test fixtures"""
        self.config = ScannerConfig()
        self.config.set('scanner.mode', 'active-light')
        self.engine = ScannerEngine("http://127.0.0.1:5000", self.config)
        # Mock HTTP client to avoid actual network requests
        self.engine.http_client = Mock()
        self.engine.http_client.get = Mock(return_value=Mock(status_code=200, text="", headers={}))
        self.engine.http_client.post = Mock(return_value=Mock(status_code=200, text="", headers={}))
        self.engine.http_client.session = Mock()
        self.engine.http_client.session.cookies = {}
    
    def test_sql_injection_check_import(self):
        """Test SQL Injection check can be imported"""
        try:
            from mini_pentest_scanner.checks import sql_injection
            self.assertIsNotNone(sql_injection.check_new)
        except ImportError as e:
            self.fail(f"Failed to import sql_injection: {e}")
    
    def test_xss_check_import(self):
        """Test XSS check can be imported"""
        try:
            from mini_pentest_scanner.checks import xss
            self.assertIsNotNone(xss.check_new)
        except ImportError as e:
            self.fail(f"Failed to import xss: {e}")
    
    def test_idor_check_import(self):
        """Test IDOR check can be imported"""
        try:
            from mini_pentest_scanner.checks import idor
            self.assertIsNotNone(idor.check_new)
        except ImportError as e:
            self.fail(f"Failed to import idor: {e}")
    
    def test_information_disclosure_check_import(self):
        """Test Information Disclosure check can be imported"""
        try:
            from mini_pentest_scanner.checks import information_disclosure
            self.assertIsNotNone(information_disclosure.check_new)
        except ImportError as e:
            self.fail(f"Failed to import information_disclosure: {e}")
    
    def test_authentication_check_import(self):
        """Test Authentication check can be imported"""
        try:
            from mini_pentest_scanner.checks import authentication
            self.assertIsNotNone(authentication.check_new)
        except ImportError as e:
            self.fail(f"Failed to import authentication: {e}")
    
    def test_session_management_check_import(self):
        """Test Session Management check can be imported"""
        try:
            from mini_pentest_scanner.checks import session_management
            self.assertIsNotNone(session_management.check_new)
        except ImportError as e:
            self.fail(f"Failed to import session_management: {e}")
    
    def test_sql_injection_check_passive_mode(self):
        """Test SQL Injection check skips in passive mode"""
        from mini_pentest_scanner.checks import sql_injection
        self.engine.scan_result.metadata.scanner_mode = 'passive'
        findings = sql_injection.check_new(self.engine)
        self.assertEqual(len(findings), 0, "SQL Injection check should skip in passive mode")
    
    def test_xss_check_passive_mode(self):
        """Test XSS check skips in passive mode"""
        from mini_pentest_scanner.checks import xss
        self.engine.scan_result.metadata.scanner_mode = 'passive'
        findings = xss.check_new(self.engine)
        self.assertEqual(len(findings), 0, "XSS check should skip in passive mode")


if __name__ == '__main__':
    unittest.main(verbosity=2)

