"""
Routes Module - หน้าเว็บต่างๆ พร้อมช่องโหว่เพื่อการศึกษา

⚠️ ช่องโหว่ที่จงใจสร้าง:
1. XSS (Cross-Site Scripting)
2. IDOR (Insecure Direct Object Reference)
3. CSRF (Cross-Site Request Forgery)
4. Path Traversal
5. Information Disclosure
"""

import sqlite3
import os
from flask import render_template, request, redirect, url_for, session, flash, jsonify, send_file
from app.auth import require_auth, require_admin, get_user_info
from app.i18n import t

def init_routes(app, db_path):
    """Initialize all routes"""
    
    @app.route('/dashboard')
    @require_auth
    def dashboard():
        """User dashboard"""
        user = get_user_info()
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # Get user's posts
        cursor.execute('SELECT id, title, content, created_at FROM posts WHERE user_id = ?', (user['id'],))
        posts = cursor.fetchall()
        conn.close()
        
        return render_template('dashboard.html', user=user, posts=posts)
    
    @app.route('/profile')
    @require_auth
    def profile():
        """User profile page"""
        user = get_user_info()
        
        # ⚠️ Information disclosure - แสดงข้อมูลมากเกินไป
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM users WHERE id = ?', (user['id'],))
        user_data = cursor.fetchone()
        conn.close()
        
        return render_template('profile.html', user=user, user_data=user_data)
    
    @app.route('/profile/<int:user_id>')
    @require_auth
    def view_profile(user_id):
        """View other user's profile - ⚠️ IDOR vulnerability"""
        # ⚠️ ไม่เช็คว่า user มีสิทธิ์ดู profile นี้หรือไม่
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        cursor.execute('SELECT id, username, email, role, created_at FROM users WHERE id = ?', (user_id,))
        profile_user = cursor.fetchone()
        conn.close()
        
        if not profile_user:
            flash('User not found', 'error')  # Keep simple for now
            return redirect(url_for('dashboard'))
        
        return render_template('view_profile.html', profile_user=profile_user)
    
    @app.route('/admin')
    @require_admin
    def admin_panel():
        """Admin panel - ⚠️ อาจมีช่องโหว่ authorization"""
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # Get all users
        cursor.execute('SELECT id, username, email, role, created_at FROM users')
        users = cursor.fetchall()
        
        # Get all posts
        cursor.execute('SELECT p.id, p.title, p.content, u.username, p.created_at FROM posts p JOIN users u ON p.user_id = u.id')
        posts = cursor.fetchall()
        
        conn.close()
        
        return render_template('admin.html', users=users, posts=posts)
    
    @app.route('/search')
    def search():
        """Search functionality - ⚠️ XSS vulnerability"""
        query = request.args.get('q', '')
        
        if not query:
            return render_template('search.html', results=[])
        
        # ⚠️ XSS: ไม่ sanitize input ก่อนแสดงผล
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # ⚠️ SQL Injection vulnerability
        search_query = f"SELECT id, title, content FROM posts WHERE title LIKE '%{query}%' OR content LIKE '%{query}%'"
        cursor.execute(search_query)
        results = cursor.fetchall()
        conn.close()
        
        return render_template('search.html', query=query, results=results)
    
    @app.route('/post/create', methods=['GET', 'POST'])
    @require_auth
    def create_post():
        """Create new post - ⚠️ XSS และ CSRF vulnerability"""
        if request.method == 'POST':
            title = request.form.get('title', '')
            content = request.form.get('content', '')
            user = get_user_info()
            
            if not title or not content:
                flash('Title and content are required', 'error')
                return render_template('create_post.html')
            
            # ⚠️ XSS: ไม่ sanitize input
            # ⚠️ CSRF: ไม่มี CSRF token
            
            conn = sqlite3.connect(db_path)
            cursor = conn.cursor()
            cursor.execute(
                'INSERT INTO posts (user_id, title, content, created_at) VALUES (?, ?, ?, datetime("now"))',
                (user['id'], title, content)
            )
            conn.commit()
            conn.close()
            
            flash(t('flash_post_created'), 'success')
            return redirect(url_for('dashboard'))
        
        return render_template('create_post.html')
    
    @app.route('/post/<int:post_id>')
    def view_post(post_id):
        """View post - ⚠️ XSS vulnerability"""
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        cursor.execute('SELECT p.id, p.title, p.content, u.username, p.created_at FROM posts p JOIN users u ON p.user_id = u.id WHERE p.id = ?', (post_id,))
        post = cursor.fetchone()
        conn.close()
        
        if not post:
            flash('Post not found', 'error')  # Keep simple for now
            return redirect(url_for('index'))
        
        return render_template('view_post.html', post=post)
    
    @app.route('/api/user/<int:user_id>')
    def api_user(user_id):
        """API endpoint - ⚠️ Information disclosure"""
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        cursor.execute('SELECT id, username, email, role, created_at FROM users WHERE id = ?', (user_id,))
        user = cursor.fetchone()
        conn.close()
        
        if not user:
            return jsonify({'error': 'User not found'}), 404
        
        # ⚠️ เปิดเผยข้อมูลมากเกินไป
        return jsonify({
            'id': user[0],
            'username': user[1],
            'email': user[2],
            'role': user[3],
            'created_at': user[4]
        })
    
    @app.route('/file')
    def file_view():
        """File viewer - ⚠️ Path Traversal vulnerability"""
        filename = request.args.get('file', '')
        
        if not filename:
            return 'Filename parameter required', 400
        
        # ⚠️ Path Traversal: ไม่ validate path
        file_path = os.path.join('vulnerable-app', 'files', filename)
        
        if os.path.exists(file_path):
            return send_file(file_path)
        else:
            return 'File not found', 404
    
    @app.route('/debug')
    def debug():
        """Debug endpoint - ⚠️ Information disclosure (ไม่ควรมีใน production)"""
        # ⚠️ เปิดเผยข้อมูลระบบมากเกินไป
        import sys
        return jsonify({
            'python_version': sys.version,
            'session': dict(session),
            'request_headers': dict(request.headers),
            'environment': dict(os.environ)
        })

