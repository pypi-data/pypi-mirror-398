"""
Authentication Module - มีช่องโหว่เพื่อการศึกษา

⚠️ ช่องโหว่ที่จงใจสร้าง:
1. Weak password hashing (MD5)
2. SQL Injection vulnerability
3. Session fixation
4. Insufficient authorization checks
"""

import sqlite3
import hashlib
import secrets
from functools import wraps
from flask import session, redirect, url_for, request, flash, render_template
from app.i18n import t

def init_auth(app, db_path):
    """Initialize authentication system"""
    
    @app.route('/login', methods=['GET', 'POST'])
    def login():
        """Login page - ⚠️ มีช่องโหว่ SQL Injection"""
        if request.method == 'POST':
            username = request.form.get('username', '')
            password = request.form.get('password', '')
            
            if not username or not password:
                flash(t('flash_username_required'), 'error')
                return render_template('login.html')
            
            # ⚠️ ช่องโหว่: SQL Injection - ไม่ใช้ parameterized query
            conn = sqlite3.connect(db_path)
            cursor = conn.cursor()
            
            # ⚠️ Weak password hashing (MD5)
            password_hash = hashlib.md5(password.encode()).hexdigest()
            
            # ⚠️ SQL Injection vulnerability
            query = f"SELECT id, username, email, role FROM users WHERE username='{username}' AND password='{password_hash}'"
            
            try:
                cursor.execute(query)
                user = cursor.fetchone()
                
                if user:
                    # ⚠️ Session fixation - ไม่ regenerate session ID
                    session['user_id'] = user[0]
                    session['username'] = user[1]
                    session['email'] = user[2]
                    session['role'] = user[3]
                    session['logged_in'] = True
                    
                    flash(t('flash_welcome', username=user[1]), 'success')
                    return redirect(url_for('dashboard'))
                else:
                    # ⚠️ Information disclosure - บอกว่า username ถูกหรือผิด
                    flash(t('flash_invalid_credentials'), 'error')
            except Exception as e:
                # ⚠️ Error message เปิดเผยข้อมูลมากเกินไป
                flash(f'Database error: {str(e)}', 'error')
            finally:
                conn.close()
        
        return render_template('login.html')
    
    @app.route('/logout')
    def logout():
        """Logout - ⚠️ ไม่ clear session อย่างถูกต้อง"""
        session.clear()
        flash(t('flash_logged_out'), 'info')
        return redirect(url_for('index'))
    
    @app.route('/register', methods=['GET', 'POST'])
    def register():
        """Registration page - ⚠️ มีช่องโหว่หลายจุด"""
        if request.method == 'POST':
            username = request.form.get('username', '')
            password = request.form.get('password', '')
            email = request.form.get('email', '')
            
            if not username or not password:
                flash(t('flash_username_required'), 'error')
                return render_template('register.html')
            
            # ⚠️ ไม่มี input validation
            # ⚠️ ไม่มี rate limiting
            # ⚠️ Weak password hashing
            password_hash = hashlib.md5(password.encode()).hexdigest()
            
            conn = sqlite3.connect(db_path)
            cursor = conn.cursor()
            
            try:
                # ⚠️ SQL Injection vulnerability
                query = f"INSERT INTO users (username, password, email, role, created_at) VALUES ('{username}', '{password_hash}', '{email}', 'user', datetime('now'))"
                cursor.execute(query)
                conn.commit()
                flash(t('flash_registration_success'), 'success')
                return redirect(url_for('login'))
            except sqlite3.IntegrityError:
                flash(t('flash_username_exists'), 'error')
            except Exception as e:
                # ⚠️ Error message เปิดเผยข้อมูล
                flash(f'Registration failed: {str(e)}', 'error')
            finally:
                conn.close()
        
        return render_template('register.html')

def check_auth():
    """Check if user is authenticated"""
    return session.get('logged_in', False)

def get_user_info():
    """Get current user information"""
    if check_auth():
        return {
            'id': session.get('user_id'),
            'username': session.get('username'),
            'email': session.get('email'),
            'role': session.get('role')
        }
    return None

def require_auth(f):
    """Decorator to require authentication"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not check_auth():
            flash(t('flash_login_required'), 'error')
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

def require_admin(f):
    """Decorator to require admin role - ⚠️ อาจมีช่องโหว่ authorization bypass"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not check_auth():
            flash(t('flash_login_required'), 'error')
            return redirect(url_for('login'))
        
        # ⚠️ เช็ค role จาก session โดยตรง - อาจถูกแก้ไขได้
        if session.get('role') != 'admin':
            flash('Access denied. Admin privileges required.', 'error')  # Keep simple
            return redirect(url_for('dashboard'))
        
        return f(*args, **kwargs)
    return decorated_function

