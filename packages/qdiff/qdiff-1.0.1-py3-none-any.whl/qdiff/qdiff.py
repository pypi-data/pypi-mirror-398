# This utility computes the 'qdiff' between two output folders generated by designite tools.
import datetime
import os
import argparse

from qdiff.diff_arch import DiffArchDJ, DiffArchDpy, DiffArchDc
from qdiff.diff_design import DiffDesignDJ, DiffDesignDpy, DiffDesignDc
from qdiff.diff_impl import DiffImplDJ, DiffImplDpy, DiffImplDc
from qdiff.diff_test import DiffTestDJ, DiffTestDpy, DiffTestDc
from qdiff.diff_testability import DiffTestabilityDJ, DiffTestabilityDpy, DiffTestabilityDc


def _verify(folder_path):
    path = os.path.abspath(folder_path)
    print(f"verifying {path} ...")
    if os.path.exists(path):
        return path
    raise ValueError("The provided path does not exist: " + str(path))


def time_it(msg):
    print(str(datetime.datetime.now()) + ' - ' + msg)


def get_comparators(source_tool):
    comparators = list()
    if source_tool == 'dj':
        comparators.append(DiffArchDJ())
        comparators.append(DiffDesignDJ())
        comparators.append(DiffImplDJ())
        comparators.append(DiffTestDJ())
        comparators.append(DiffTestabilityDJ())
    if source_tool == 'dpy':
        comparators.append(DiffArchDpy())
        comparators.append(DiffDesignDpy())
        comparators.append(DiffImplDpy())
        comparators.append(DiffTestDpy())
        comparators.append(DiffTestabilityDpy())
    if source_tool == 'dc':
        comparators.append(DiffArchDc())
        comparators.append(DiffDesignDc())
        comparators.append(DiffImplDc())
        comparators.append(DiffTestDc())
        comparators.append(DiffTestabilityDc())
    return comparators


def _verify_create(folder_path):
    path = os.path.abspath(folder_path)
    print(f"verifying {path} ...")
    if not os.path.exists(path):
        os.makedirs(path, exist_ok=True)
    return path


def process(path1, path2, path3, source_tool):
    path1 = _verify(path1)
    path2 = _verify(path2)
    output_path = _verify_create(path3)
    for comparator in get_comparators(source_tool):
        comparator.diff(path1, path2, output_path)


def main() -> None:
    parser = argparse.ArgumentParser(
        prog="qdiff",
        description="Compute qdiff between two code quality reports",
    )

    parser.add_argument(
        "path1",
        help="Code quality report-1 folder path",
    )
    parser.add_argument(
        "path2",
        help="Code quality report-2 folder path",
    )
    parser.add_argument(
        "path3",
        help="Diff (output) report folder path",
    )
    parser.add_argument(
        "tool",
        choices=["dpy", "dc", "dj"],
        help='Tool that generated the reports: "dpy", "dc", or "dj"',
    )

    args = parser.parse_args()

    process(
        args.path1,
        args.path2,
        args.path3,
        source_tool=args.tool,
    )


if __name__ == '__main__':
    main()
