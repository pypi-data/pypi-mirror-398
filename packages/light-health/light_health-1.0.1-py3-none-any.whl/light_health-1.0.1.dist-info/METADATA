Metadata-Version: 2.4
Name: light-health
Version: 1.0.1
Summary: Lightweight ASGI health checks inspired by Spring Actuator
Author-email: Tiago Ventura <tiago.barbano@gmail.com>
License-Expression: MIT
Project-URL: Homepage, https://github.com/tiagoBarbano/light-health
Project-URL: Repository, https://github.com/tiagoBarbano/light-health
Classifier: Programming Language :: Python :: 3
Classifier: Framework :: FastAPI
Classifier: Framework :: AsyncIO
Requires-Python: >=3.13
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: msgspec>=0.18
Dynamic: license-file


# ü©∫ light-health

**light-health** √© uma biblioteca Python **leve, ass√≠ncrona e framework-agnostic** para expor endpoints de *health check* e *management* no estilo **Spring Boot Actuator**, usando **ASGI nativo** e **msgspec** para m√°xima performance e baixo overhead.

> üéØ Ideal para microsservi√ßos, plataformas internas, sidecars e runtimes customizados.

---

## ‚ú® Principais Caracter√≠sticas

- ‚úÖ **ASGI puro** (sem depend√™ncia de FastAPI, Starlette ou Django)
- ‚ö° **Ass√≠ncrono**
- üß± **Extens√≠vel via registry**
- üöÄ **Alta performance com msgspec**
- üîå **Plug√°vel em qualquer framework ASGI**
- ü©∫ Health, Readiness e Liveness
- ‚öôÔ∏è Management endpoints (loggers, env)
- üìò Compat√≠vel com Swagger/OpenAPI via adapter

---

## üì¶ Instala√ß√£o

```bash
pip install light-health
```

---

## üß† Conceito

Inspirado no Spring Actuator, a lib separa claramente:

- **Runtime (execu√ß√£o):** ASGI puro, sem depend√™ncia de framework, ideal para produ√ß√£o
- **Contrato (documenta√ß√£o):** Pode ser exposto via FastAPI, usado apenas para Swagger/OpenAPI

---

## üìÅ Estrutura da Lib

```text
light_health/
‚îú‚îÄ‚îÄ asgi/
‚îÇ   ‚îú‚îÄ‚îÄ health.py        # Health / readiness / liveness
‚îÇ   ‚îú‚îÄ‚îÄ management.py    # Loggers / Env
‚îÇ   ‚îú‚îÄ‚îÄ management_models.py
‚îú‚îÄ‚îÄ checks/
‚îÇ   ‚îú‚îÄ‚îÄ mongo.py
‚îÇ   ‚îú‚îÄ‚îÄ redis.py
‚îÇ   ‚îî‚îÄ‚îÄ http.py
‚îú‚îÄ‚îÄ registry.py         # Registro de checks
‚îú‚îÄ‚îÄ status.py           # Status + agrega√ß√£o
‚îî‚îÄ‚îÄ __init__.py
```

---

## üöÄ Exemplo de Uso

```python
from fastapi import FastAPI
import uvicorn
from pymongo import AsyncMongoClient
import redis.asyncio as redis

from light_health.asgi.base import HealthStatus,HealthCheck
from light_health.asgi.management import ManagementASGIApp
from light_health.asgi.health import HealthASGIApp
from light_health.registry import AsyncHealthRegistry
from light_health.status import HealthCheckResult, HealthState
from light_health.checks.mongo import mongo_health_check
from light_health.checks.redis import redis_health_check
from light_health.checks.http import http_health_check

mongo = AsyncMongoClient("mongodb://localhost:27017")
redis_client = redis.Redis(host="localhost", password="redis1234", port=6379)

registry = AsyncHealthRegistry()

async def process_alive():
    return HealthCheckResult(status=HealthState.UP)

registry.register_liveness("process", process_alive)
registry.register_readiness("mongo", mongo_health_check(mongo))
registry.register_readiness("redis", redis_health_check(redis_client))
registry.register_readiness(
    "external-api",
    http_health_check("https://httpbin.org/status/200"),
)

class MyCheck(HealthCheck):
    async def check(self) -> HealthStatus:
        return HealthStatus.up(details={"test_custom": "ok"})
    
registry_test = AsyncHealthRegistry()
registry_test.register_readiness("custom", MyCheck().check)

app = FastAPI()
app.mount("/actuator", HealthASGIApp(registry))
app.mount("/test", HealthASGIApp(registry_test))
app.mount("/management", ManagementASGIApp())

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)

```

**Endpoints dispon√≠veis:**

## ü©∫ Health Checks

| Tipo      | Endpoint               |
|-----------|------------------------|
| Liveness  | /{root_path}/liveness  |
| Readiness | /{root_path}/readiness |
| Health    | /{root_path}/health    |
| UP        | /{root_path}/up        |

## ü©∫ Management

| Tipo           | Endpoint                    |
|----------------|-----------------------------|
| loggers        | /{root_path}/loggers        |
| loggers update | /{root_path}/loggers/update |
| env            | /{root_path}/env            |
| env update     | /{root_path}/env/update     |


## üìò Swagger / OpenAPI

Como os endpoints s√£o ASGI puros, eles n√£o aparecem automaticamente no Swagger.

**Solu√ß√£o recomendada:** criar rotas ‚Äúespelho‚Äù apenas para documenta√ß√£o:

```python
from light_health.management_models import LoggerUpdate, EnvUpdate

@app.post("/management/loggers/update", include_in_schema=True)
def update_logger_doc(payload: LoggerUpdate):
    """Atualiza o n√≠vel de um logger"""
    pass
```

> O FastAPI usa isso apenas para gerar o OpenAPI. A execu√ß√£o real continua no ASGI.

---

## ‚öôÔ∏è Management Endpoints

### üîπ Loggers

- **Listar loggers:**
  - `GET /management/loggers`
  - Resposta:
    ```json
    {
      "root": "INFO",
      "uvicorn.error": "WARNING"
    }
    ```
- **Atualizar n√≠vel:**
  - `POST /management/loggers/update`
  - Payload:
    ```json
    {
      "level": "DEBUG",
      "logger_name": "uvicorn.error"
    }
    ```

### üîπ Environment variables

- **Listar env:**
  - `GET /management/env`
- **Atualizar env:**
  - `POST /management/env/update`
  - Payload:
    ```json
    {
      "key": "FEATURE_X",
      "value": "true"
    }
    ```

---

## üö® Seguran√ßa (IMPORTANTE)

‚ö†Ô∏è Nunca exponha `/management` publicamente!

**Boas pr√°ticas:**
- Expor apenas em rede interna
- Proteger via:
  - mTLS
  - Auth ASGI
  - NetworkPolicy (K8s)
- Desabilitar `/env` em produ√ß√£o
- Mesma recomenda√ß√£o do Spring Actuator

---

## üß© Extensibilidade

**Criar um check customizado:**
```python
from light_health.checks.base import HealthCheck, HealthStatus

class MyCheck(HealthCheck):
    async def check(self) -> HealthStatus:
        return HealthStatus.up(details={"custom": "ok"})
```

---

## ‚ö° Performance

- msgspec para serializa√ß√£o
- Async IO
- Execu√ß√£o paralela dos checks
- Overhead m√≠nimo

Ideal para:
- APIs de alta escala
- Runtimes com pouco CPU/mem√≥ria
- Sidecars

---

## üó∫Ô∏è Roadmap

- Auth ASGI
- Metrics (Prometheus)
- Feature flags
- Info endpoint
- Profiles (dev / prod)

---

## üß† Filosofia

Health e management s√£o infra, n√£o aplica√ß√£o.

Essa lib foi pensada para:
- N√£o acoplar frameworks
- Ser reutiliz√°vel
- Escalar com governan√ßa

---

## üìÑ Licen√ßa

MIT
