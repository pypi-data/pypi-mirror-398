name: CI

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.14

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run type checker
        run: uv run ty check src/
        continue-on-error: true # pkcs11 library lacks type stubs

  test-softhsm:
    name: Test with SoftHSM2
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Set up Python
        run: uv python install 3.14

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y softhsm2 opensc

      - name: Install Python dependencies
        run: uv sync --extra dev

      - name: Setup SoftHSM2 and run tests
        run: |
          export SOFTHSM2_CONF="$HOME/.config/softhsm/softhsm2.conf"
          just ensure-softhsm-config
          just import-keys
          uv run pytest tests/ -v

  test-kryoptic:
    name: Test with Kryoptic
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Set up Python
        run: uv python install 3.14

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y opensc libsqlite3-dev pkg-config libssl-dev

      - name: Setup rust
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9
        with:
          components: rustfmt, clippy
          toolchain: stable

      - name: Cache Kryoptic build
        uses: actions/cache@v4
        with:
          path: ~/kryoptic
          key: kryoptic-${{ runner.os }}-v1
          restore-keys: |
            kryoptic-${{ runner.os }}-

      - name: Build Kryoptic
        run: |
          # Skip build if binary already exists from cache
          if [ -f "$HOME/kryoptic/target/release/libkryoptic_pkcs11.so" ]; then
            echo "Kryoptic binary found in cache, skipping build"
            exit 0
          fi
          cd ~
          if [ ! -d "kryoptic" ]; then
            git clone https://github.com/latchset/kryoptic.git
          fi
          cd kryoptic
          # Build without EdDSA (requires OpenSSL 3.2+, Ubuntu has 3.0.x)
          cargo build --release --no-default-features --features "sqlitedb,aes,ecdsa,ecdh,ffdh,hash,hmac,hkdf,pbkdf2,rsa,sp800_108,dynamic"

      - name: Install Python dependencies
        run: uv sync --extra dev

      - name: Setup Kryoptic and run tests
        run: |
          export KRYOPTIC_MODULE="$HOME/kryoptic/target/release/libkryoptic_pkcs11.so"
          just ensure-kryoptic-config
          just import-keys-kryoptic
          # Skip EdDSA tests (kryoptic requires OpenSSL 3.2+ for EdDSA support)
          HSM_MODULE="$KRYOPTIC_MODULE" EDDSA_AVAILABLE=false uv run pytest tests/ -v --ignore=tests/test_ed25519.py --ignore=tests/test_ed448.py

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [test-softhsm, test-kryoptic]
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Build package
        run: uv build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1
