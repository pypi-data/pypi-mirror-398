# Dependency Review
# Blocks PRs that introduce dependencies with known vulnerabilities.
# Uses GitHub's dependency graph and advisory database.

name: Dependency Review

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    name: Review Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          # Fail on high and critical severity vulnerabilities
          fail-on-severity: high

          # Block dependencies with known vulnerabilities
          deny-licenses: ''

          # Allow these license types (common open-source licenses)
          allow-licenses: >-
            MIT,
            Apache-2.0,
            BSD-2-Clause,
            BSD-3-Clause,
            ISC,
            Python-2.0,
            PSF-2.0,
            0BSD,
            Unlicense,
            WTFPL,
            CC0-1.0

          # Allow packages with SPDX expressions that scanners misparse
          # cryptography: Apache-2.0 OR BSD-3-Clause (scanner shows "Null")
          allow-packages: 'pkg:pypi/cryptography'

          # Fail if dependencies with GHSA advisories are added
          fail-on-scopes: runtime, development

          # Comment on PR with vulnerability details
          comment-summary-in-pr: always

          # Warn on moderate severity (but do not fail)
          warn-only: false

          # Show all vulnerabilities, not just newly introduced
          show-openssf-scorecard: false

          # Retry on transient failures
          retry-on-snapshot-warnings: true
          retry-on-snapshot-warnings-timeout: 120
