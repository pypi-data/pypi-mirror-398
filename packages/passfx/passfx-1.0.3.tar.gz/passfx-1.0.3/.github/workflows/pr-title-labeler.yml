# PR Title Labeler
# Applies labels based on PR title prefixes (conventional commits).
# Examples: feat: -> feature, fix: -> bug, docs: -> docs

name: PR Title Labeler

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  label-by-title:
    name: Label by Title
    runs-on: ubuntu-latest

    steps:
      - name: Apply labels based on PR title
        uses: actions/github-script@v8
        with:
          script: |
            const title = context.payload.pull_request.title.toLowerCase();
            const labelsToAdd = [];
            const labelsToRemove = [];

            // Define title prefix to label mappings
            const titleMappings = [
              { prefixes: ['feat:', 'feature:', 'feat(', 'feature('], label: 'feature' },
              { prefixes: ['fix:', 'bugfix:', 'fix(', 'hotfix:'], label: 'bug' },
              { prefixes: ['docs:', 'doc:', 'docs(', 'doc('], label: 'docs' },
              { prefixes: ['ci:', 'ci(', 'build:', 'build(', 'infra:', 'infra('], label: 'infra' },
              { prefixes: ['security:', 'security(', 'sec:', 'sec('], label: 'security' },
              { prefixes: ['test:', 'test(', 'tests:', 'tests('], label: 'tests' },
              { prefixes: ['refactor:', 'refactor(', 'cleanup:'], label: 'refactor' },
              { prefixes: ['perf:', 'perf(', 'performance:'], label: 'performance' },
              { prefixes: ['chore:', 'chore('], label: 'chore' },
              { prefixes: ['deps:', 'deps(', 'dep:', 'dep('], label: 'dependencies' }
            ];

            // Check which labels should be applied
            for (const mapping of titleMappings) {
              const matches = mapping.prefixes.some(prefix => title.startsWith(prefix));
              if (matches) {
                labelsToAdd.push(mapping.label);
              }
            }

            // Get current labels on the PR
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const currentLabelNames = currentLabels.map(l => l.name);

            // Add new labels
            const newLabels = labelsToAdd.filter(l => !currentLabelNames.includes(l));
            if (newLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: newLabels
              });
              console.log(`Added labels: ${newLabels.join(', ')}`);
            }

            if (labelsToAdd.length === 0) {
              console.log('No matching title prefixes found. No labels added.');
            }
