# Dockerfile for pip/pipx installation testing
# Validates PassFX installs correctly from PyPI in clean Python environments.
#
# Build: docker build -f Dockerfile.pip -t passfx-test-pip .
# Run:   docker run --rm passfx-test-pip

ARG PYTHON_VERSION=3.11
FROM python:${PYTHON_VERSION}-slim

# Metadata
LABEL org.opencontainers.image.title="PassFX pip Install Test"
LABEL org.opencontainers.image.description="Validates PassFX installation via pip/pipx"
LABEL org.opencontainers.image.source="https://github.com/dinesh-git17/passfx"

# Prevent Python from buffering stdout/stderr
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Create non-root user for security
RUN groupadd --gid 1000 testuser && \
    useradd --uid 1000 --gid 1000 --create-home testuser

# Install system dependencies required by cryptography and setproctitle
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libffi-dev \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Switch to non-root user
USER testuser
WORKDIR /home/testuser

# Upgrade pip
RUN python -m pip install --user --upgrade pip

# Install PassFX from PyPI
ARG PASSFX_VERSION=""
RUN if [ -n "$PASSFX_VERSION" ]; then \
        python -m pip install --user "passfx==${PASSFX_VERSION}"; \
    else \
        python -m pip install --user passfx; \
    fi

# Add user bin to PATH
ENV PATH="/home/testuser/.local/bin:${PATH}"

# Copy validation script
COPY --chown=testuser:testuser validate_install.sh /home/testuser/validate_install.sh
RUN chmod +x /home/testuser/validate_install.sh

# Run validation
CMD ["/home/testuser/validate_install.sh", "pip"]
