name: Auto Release on Push to Main

on:
    push:
        branches:
            - main

jobs:
    release:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Check out code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get latest tag and create new version
              id: tag
              run: |
                  # Get the latest tag
                  LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
                  echo "Latest tag: $LATEST_TAG"

                  # Extract version numbers (remove 'v' prefix)
                  VERSION=${LATEST_TAG#v}

                  # Split into major.minor.patch
                  IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

                  # Increment patch version
                  PATCH=$((PATCH + 1))

                  # Create new tag
                  NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
                  echo "New tag: $NEW_TAG"
                  echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

            - name: Create and push tag
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag ${{ steps.tag.outputs.new_tag }}
                  git push origin ${{ steps.tag.outputs.new_tag }}

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install build tools
              run: pip install build twine hatch hatch-vcs

            - name: Build PyPI package
              run: hatch build

            - name: Publish to PyPI
              env:
                  TWINE_USERNAME: __token__
                  TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
              run: twine upload dist/*
