---
name: Docker Build and Push

on:
  push:
    branches:
      - develop
  # Commented out for now: release-please creates tags from Actions directly,
  # which are ignored by this workflow. Uncomment if tags are created manually
  # push:
  #   tags:
  #     - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag to use (e.g., v0.1.0)"
        required: true
        type: string
      push:
        description: "Push images to registry"
        required: false
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write  # For GitHub attestations (OIDC token)
      attestations: write  # For build provenance and SBOM attestations
    strategy:
      fail-fast: false
      matrix:
        include:
          - dockerfile: Dockerfile
            suffix: ""
            platforms: linux/amd64,linux/arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          persist-credentials: false

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130  # v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3.12.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version
        id: version
        env:
          INPUT_VERSION: ${{ inputs.version }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          # Calculate short SHA for all branches
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

          if [[ -n "$INPUT_VERSION" ]]; then
            # Workflow dispatch with version input (triggered by release workflow)
            VERSION="$INPUT_VERSION"
          elif [[ "$REF_NAME" == "develop" ]]; then
            # Develop branch: use 'develop' as primary tag
            VERSION="develop"
          else
            # Fallback to short SHA for feature branches
            VERSION="$SHORT_SHA"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"
          echo "Short SHA: $SHORT_SHA"

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051  # v5.10.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          flavor: |
            suffix=${{ matrix.suffix }},onlatest=true
          tags: |
            # Use the exact version tag (e.g., v0.1.0, develop, or short SHA)
            type=raw,value=${{ steps.version.outputs.version }}
            # For develop branch, also add develop-{short-sha} tag
            type=raw,value=develop-${{ steps.version.outputs.short_sha }},enable=${{ github.ref_name == 'develop' }}
            # Also tag as 'latest' for stable releases (not rc/beta/alpha)
            type=raw,value=latest,enable=${{ !contains(steps.version.outputs.version, '-') && github.ref_name == 'main' }}
            # For release candidates, also tag as 'rc'
            type=raw,value=rc,enable=${{ contains(steps.version.outputs.version, '-rc') }}
          labels: |
            org.opencontainers.image.title=CVE Report Aggregator
            org.opencontainers.image.description=Scans SBOM files contained in Zarf packages using Grype and/or Trivy, deduplicates findings, and saves results.
            org.opencontainers.image.vendor=Defense Unicorns

      - name: Build and push Docker image
        id: build
        timeout-minutes: 10
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83  # v6.18.0
        with:
          context: .
          file: docker/${{ matrix.dockerfile }}
          platforms: ${{ matrix.platforms }}
          push: ${{ github.event_name == 'push' || inputs.push }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            REVISION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.revision'] }}
          # Enable buildx provenance (creates OCI attestation layer)
          provenance: true
          # SBOM disabled: using GitHub's attest-sbom action instead for better
          # integration with GitHub's artifact attestation system
          sbom: false

      - name: Attest build provenance
        if: ${{ github.event_name == 'push' || inputs.push }}
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8  # v3.1.0
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}${{ matrix.suffix }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

      - name: Generate SBOM
        if: ${{ github.event_name == 'push' || inputs.push }}
        uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a  # v0.21.0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}${{ matrix.suffix }}:${{ steps.version.outputs.version }}
          artifact-name: sbom-cyclonedx.json
          output-file: sbom-cyclonedx.json
          format: cyclonedx-json

      - name: Attest SBOM
        if: ${{ github.event_name == 'push' || inputs.push }}
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34  # v3.0.0
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}${{ matrix.suffix }}
          subject-digest: ${{ steps.build.outputs.digest }}
          sbom-path: sbom-cyclonedx.json
          push-to-registry: true

      - name: Export image for scanning
        if: success()
        env:
          VERSION: ${{ steps.version.outputs.version }}
          IMAGE_NAME: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        run: |
          # Export the built image to a tarball for security scanning
          # This allows the scan workflow to run without pulling from the registry
          docker pull "${IMAGE_NAME}:${VERSION}"
          docker save "${IMAGE_NAME}:${VERSION}" -o image.tar
          echo "Exported ${IMAGE_NAME}:${VERSION} to image.tar"
          ls -lh image.tar

      - name: Upload image artifact for scanning
        if: success()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: docker-image-${{ steps.version.outputs.version }}
          path: image.tar
          retention-days: 1  # Only needed for immediate scanning

      - name: Generate image summary
        if: success()
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
          VERSION: ${{ steps.version.outputs.version }}
          SUFFIX: ${{ matrix.suffix }}
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          PLATFORMS: ${{ matrix.platforms }}
          REPOSITORY: ${{ github.repository }}
        run: |
          IMAGE_FULL="${REGISTRY}/${IMAGE_NAME}${SUFFIX}"

          echo "## Docker Image Built & Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`$REGISTRY\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: \`${IMAGE_NAME}${SUFFIX}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms**: \`$PLATFORMS\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: \`${DIGEST}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${IMAGE_FULL}:$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          # Add provenance and security information
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security & Provenance" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Provenance**: GitHub Artifact Attestation (SLSA)" >> $GITHUB_STEP_SUMMARY
          echo "- **SBOM**: CycloneDX attestation" >> $GITHUB_STEP_SUMMARY
          echo "- **Attestations**: Viewable in GitHub Actions UI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Verify Attestations" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Verify build provenance" >> $GITHUB_STEP_SUMMARY
          echo "gh attestation verify oci://${IMAGE_FULL}:$VERSION --owner ${REPOSITORY%/*}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Download and view SBOM attestation" >> $GITHUB_STEP_SUMMARY
          echo "gh attestation verify oci://${IMAGE_FULL}:$VERSION --owner ${REPOSITORY%/*} --format json | jq ." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          # Add note about release type
          if [[ "$VERSION" == *"-rc"* ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note**: This is a release candidate image." >> $GITHUB_STEP_SUMMARY
            echo "Also available as: \`docker pull ${IMAGE_FULL}:rc\`" >> $GITHUB_STEP_SUMMARY
          elif [[ "$VERSION" != *"-"* ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note**: This is a stable release image." >> $GITHUB_STEP_SUMMARY
            echo "Also available as: \`docker pull ${IMAGE_FULL}:latest\`" >> $GITHUB_STEP_SUMMARY
          fi
