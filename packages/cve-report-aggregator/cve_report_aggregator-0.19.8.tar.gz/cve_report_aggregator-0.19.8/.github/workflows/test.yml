---
name: Test
permissions:
  contents: read
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]
env:
  UV_CACHE_DIR: /tmp/.uv-cache
jobs:
  linting:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          persist-credentials: false
      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version: "3.12"
      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867  # v7.1.6
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      - name: Restore uv cache
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb  # v5.0.1
        with:
          path: /tmp/.uv-cache
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
            uv-${{ runner.os }}
      - name: Install dependencies
        run: uv sync --all-extras --dev
      - name: Run linting
        run: |
          uv run ruff check src tests
          uv run ruff format --check src tests
      - name: Minimize uv cache
        run: uv cache prune --ci
  unit-tests:
    runs-on: ubuntu-latest
    needs: [linting]
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          persist-credentials: false
      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version: "3.14"
      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867  # v7.1.6
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      - name: Restore uv cache
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb  # v5.0.1
        with:
          path: /tmp/.uv-cache
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
            uv-${{ runner.os }}
      - name: Install dependencies
        run: uv sync --all-extras --dev
      - name: Run unit tests
        run: |
          echo "Running unit tests..."
          uv run pytest tests/unit -v --cov=src/cve_report_aggregator --cov-report=xml --cov-report=term-missing
      - name: Upload unit test coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de  # v5.5.2
        with:
          files: ./coverage.xml
          flags: unittests
          name: unit-test-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: mkm29/cve-report-aggregator
      - name: Upload unit test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@0fa95f0e1eeaafde2c782583b36b28ad0d8c77d3  # v1.2.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Cleanup test artifacts
        if: always()
        run: |
          rm -f coverage.xml
      - name: Minimize uv cache
        run: uv cache prune --ci

  all-tests-pass:
    runs-on: ubuntu-latest
    needs: [linting, unit-tests]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Check test results
        env:
          LINTING_RESULT: ${{ needs.linting.result }}
          UNIT_TESTS_RESULT: ${{ needs.unit-tests.result }}
        run: |
          if [[ "$LINTING_RESULT" != "success" || "$UNIT_TESTS_RESULT" != "success" ]]; then
            echo "One or more test jobs failed"
            echo "  - Linting: $LINTING_RESULT"
            echo "  - Unit Tests: $UNIT_TESTS_RESULT"
            exit 1
          else
            echo "All test jobs passed successfully"
          fi
