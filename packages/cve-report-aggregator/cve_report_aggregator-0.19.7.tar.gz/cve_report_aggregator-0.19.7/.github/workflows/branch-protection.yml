---
name: Branch Protection

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

jobs:
  validate-branch-flow:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          persist-credentials: false

      - name: Validate Git Flow conventions
        id: validate
        env:
          SOURCE_BRANCH: ${{ github.head_ref }}
          TARGET_BRANCH: ${{ github.base_ref }}
        run: |
          echo "Validating Git Flow..."
          echo "Source branch: $SOURCE_BRANCH"
          echo "Target branch: $TARGET_BRANCH"

          # Define valid branch patterns
          VALID=true
          MESSAGE=""

          case "$TARGET_BRANCH" in
            main)
              # Only develop, hotfix/*, fix/*, or release/* branches can merge to main
              if [[ "$SOURCE_BRANCH" == "develop" ]] || \
                 [[ "$SOURCE_BRANCH" == hotfix/* ]] || \
                 [[ "$SOURCE_BRANCH" == fix/* ]] || \
                 [[ "$SOURCE_BRANCH" == alert-autofix* ]] || \
                 [[ "$SOURCE_BRANCH" == dependabot* ]] || \
                 [[ "$SOURCE_BRANCH" == release-please* ]]; then
                MESSAGE="Valid: $SOURCE_BRANCH -> main"
              else
                VALID=false
                MESSAGE="Invalid: Only 'develop', 'hotfix/*', 'fix/*', 'alert-autofix*' or 'release-please*' branches can merge to main"
              fi
              ;;

            develop)
              # Feature branches, bugfix branches, hotfix backports, and Release Please branches can merge to develop
              if [[ "$SOURCE_BRANCH" == feature/* ]] || \
                 [[ "$SOURCE_BRANCH" == feat/* ]] || \
                 [[ "$SOURCE_BRANCH" == bugfix/* ]] || \
                 [[ "$SOURCE_BRANCH" == fix/* ]] || \
                 [[ "$SOURCE_BRANCH" == backport/* ]] || \
                 [[ "$SOURCE_BRANCH" == chore/* ]] || \
                 [[ "$SOURCE_BRANCH" == docs/* ]] || \
                 [[ "$SOURCE_BRANCH" == test/* ]] || \
                 [[ "$SOURCE_BRANCH" == refactor/* ]] || \
                 [[ "$SOURCE_BRANCH" == alert-autofix* ]] || \
                 [[ "$SOURCE_BRANCH" == release-please--* ]]; then
                MESSAGE="Valid: $SOURCE_BRANCH -> develop"
              else
                VALID=false
                MESSAGE="Invalid: Feature/feat/bugfix/chore branches should follow naming convention (feature/*, feat/*, bugfix/*, fix/*, chore/*, docs/*, test/*, refactor/*)"
              fi
              ;;

            *)
              # PRs should only target main or develop
              VALID=false
              MESSAGE="Invalid: PRs should target either 'main' or 'develop' branch"
              ;;
          esac

          echo "$MESSAGE"
          echo "valid=$VALID" >> $GITHUB_OUTPUT
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: steps.validate.outputs.valid == 'false'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        env:
          VALIDATION_MESSAGE: ${{ steps.validate.outputs.message }}
        with:
          script: |
            const message = `## Git Flow Validation Failed

            ${process.env.VALIDATION_MESSAGE}

            ### Git Flow Rules:
            - **Feature branches** (\`feature/*\` _OR_ \'feat/*\') -> \`develop\`
            - **Bugfix branches** (\`bugfix/*\`) -> \`develop\`
            - **Fix branches** (\`fix/*\`) -> \`main\` or \`develop\`
            - **Hotfix branches** (\`hotfix/*\`) -> \`main\` (then backported to \`develop\`)
            - **Release branches** (\`release/*\`) -> \`main\` and \`develop\`
            - **Develop branch** -> \`main\` (for releases)
            - **alert-autofix branches** (\`alert-autofix*\`) -> \`main\` or \`develop\`

            Please rename your branch or change the target branch to comply with Git Flow.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: Fail if invalid
        if: steps.validate.outputs.valid == 'false'
        run: exit 1

  add-labels:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Add branch type labels
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        env:
          HEAD_REF: ${{ github.head_ref }}
        with:
          script: |
            const branch = process.env.HEAD_REF;
            const labels = [];

            if (branch.startsWith('feature/') || branch.startsWith('feat/')) {
              labels.push('feature');
            } else if (branch.startsWith('bugfix/') || branch.startsWith('fix/')) {
              labels.push('bugfix');
            } else if (branch.startsWith('hotfix/')) {
              labels.push('hotfix', 'urgent');
            } else if (branch.startsWith('release/')) {
              labels.push('release');
            } else if (branch.startsWith('release-please--')) {
              labels.push('release', 'automated');
            } else if (branch.startsWith('chore/')) {
              labels.push('chore');
            } else if (branch.startsWith('docs/')) {
              labels.push('documentation');
            } else if (branch.startsWith('test/')) {
              labels.push('test');
            } else if (branch.startsWith('refactor/')) {
              labels.push('refactor');
            } else if (branch.startsWith('alert-autofix')) {
              labels.push('security', 'automated');
            } else if (branch === 'develop') {
              labels.push('development');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              });
            }
