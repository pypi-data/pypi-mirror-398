---
name: Hotfix Workflow

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".gitignore"

jobs:
  validate-hotfix:
    # Only run if PR is from a hotfix branch
    if: startsWith(github.head_ref, 'hotfix/')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Validate hotfix branch
        run: |
          echo "Validating hotfix PR..."

          # Check that hotfix branch is based on main
          git fetch origin main
          MERGE_BASE=$(git merge-base HEAD origin/main)
          MAIN_HEAD=$(git rev-parse origin/main)

          if [[ "$MERGE_BASE" != "$MAIN_HEAD" ]]; then
            echo "Error: Hotfix branch must be based on 'main' branch"
            echo "Current base: $(git rev-parse --abbrev-ref HEAD)"
            echo "Expected base: main"
            exit 1
          fi

          echo "Hotfix branch is correctly based on main"

      - name: Add hotfix label
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            // Add hotfix label to PR
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['hotfix', 'urgent']
            });

  backport-to-develop:
    # After hotfix is merged to main, automatically backport to develop
    if: github.event.pull_request.merged == true && startsWith(github.head_ref, 'hotfix/')
    runs-on: ubuntu-latest
    needs: validate-hotfix
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true  # Required for git push

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create backport PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_COMMIT_SHA: ${{ github.event.pull_request.merge_commit_sha }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Fetch all branches
          git fetch --all

          # Create backport branch
          BACKPORT_BRANCH="backport/hotfix-to-develop-$(date +%s)"
          git checkout -b "$BACKPORT_BRANCH" origin/develop

          # Cherry-pick the merge commit
          git cherry-pick -m 1 "$MERGE_COMMIT_SHA" || {
            echo "Conflicts detected. Manual backport required."
            exit 0
          }

          # Push backport branch
          git push origin "$BACKPORT_BRANCH"

          # Create PR from backport branch to develop
          gh pr create \
            --base develop \
            --head "$BACKPORT_BRANCH" \
            --title "Backport: $PR_TITLE" \
            --body "## Automated Backport

            This PR backports the following hotfix to the develop branch:
            - Original PR: #$PR_NUMBER
            - Title: $PR_TITLE
            - Author: @$PR_AUTHOR

            ### Original Description
            $PR_BODY

            ---
            *This is an automated backport. Please review and merge to keep develop in sync with main.*" \
            --label "backport,automated"
