from pathlib import Path

from .._core import Geometry


def generate_code(
    input_filename: str,
    output_filename: str,
    relabel: dict[str, str | list[str]] | None,
    overlay_ids: list[str] | None,
    metadata: dict[str, str] | None,
) -> str:
    """Generate Python code for the conversion."""
    lines = [
        "# Generated by shinymap converter",
        "from shinymap.geometry import convert",
        "",
        "# One-shot conversion with all transformations",
        "convert(",
        f'    "{input_filename}",',
        f'    "{output_filename}",',
    ]

    if relabel:
        lines.append("    relabel={")
        for new_id, old_id_or_ids in relabel.items():
            lines.append(f'        "{new_id}": {repr(old_id_or_ids)},')
        lines.append("    },")

    if overlay_ids:
        lines.append(f"    overlay_ids={overlay_ids},")

    if metadata:
        lines.append("    metadata={")
        for key, value in metadata.items():
            lines.append(f'        "{key}": "{value}",')
        lines.append("    },")

    lines.append(")")

    return "\n".join(lines)


def load_file(file_path: str, filename: str):
    """Load SVG or JSON file and return Geometry object with metadata."""

    # Determine file type by extension
    path = Path(file_path)
    is_json = path.suffix.lower() == ".json"

    # Load geometry based on file type
    if is_json:
        geo = Geometry.from_json(file_path)
        # Try to get original source from metadata
        original_source = geo.metadata.get("original_source", filename)
    else:
        # SVG file
        geo = Geometry.from_svg(file_path, extract_viewbox=True)
        original_source = filename

    # Extract path IDs for display
    path_ids = list(geo.regions.keys())

    # Return data bundle with geometry and metadata for the app
    return {
        "filename": filename,
        "original_source": original_source,
        "file_path": file_path,
        "geometry": geo,
        "path_ids": path_ids,
    }
