"""
Tests for variant normalization using vt test suite.

Test cases sourced from:
    vt (https://github.com/atks/vt)
    Copyright (c) 2013 Adrian Tan <atks@umich.edu>
    MIT License

Test data location: vt/test/normalize/
Reference: vt/test/ref/20.fa.gz

The vt normalization algorithm is described in:
    Tan A, Abecasis GR, Kang HM. Unified representation of genetic variants.
    Bioinformatics. 2015;31(13):2202-2204. doi:10.1093/bioinformatics/btv112
"""

import pytest

from vcf_pg_loader.normalizer import normalize_variant

REF_CONTEXT = {
    421803: 'T',
    421804: 'T',
    421805: 'C',
    421806: 'C',
    421807: 'A',
    421808: 'A',
    2171400: 'C',
    2171401: 'T',
    2171402: 'A',
    2171403: 'A',
    2171404: 'C',
    3373435: 'T',
    3373436: 'G',
    3373437: 'C',
    3373438: 'T',
    3373439: 'T',
    3373440: 'T',
    3373441: 'C',
    3373442: 'T',
    3373443: 'T',
    3373444: 'T',
    3373445: 'A',
    3635156: 'C',
    3635157: 'A',
    3635158: 'T',
    3635159: 'A',
    4422113: 'T',
    4422114: 'G',
    4422115: 'G',
    4422116: 'G',
    4422117: 'A',
    4422118: 'G',
    4422119: 'C',
    4422120: 'T',
    4422121: 'C',
    4422122: 'C',
    4422123: 'C',
    4422124: 'A',
    4422125: 'G',
    4422126: 'G',
    4422127: 'C',
    4422128: 'T',
    4422129: 'A',
    4422130: 'C',
    4422131: 'A',
    4422132: 'G',
    4422133: 'A',
    4422134: 'A',
    4422135: 'A',
    4422136: 'G',
    4422137: 'A',
    4422138: 'T',
    4422139: 'G',
    4422140: 'A',
    4422141: 'T',
    4422142: 'G',
    4422143: 'G',
    4422144: 'A',
    4422145: 'G',
    4422146: 'G',
    5900667: 'T',
    5900668: 'G',
    5900669: 'C',
    5900670: 'A',
    8080270: 'C',
    8080271: 'C',
    8080272: 'T',
    8080273: 'T',
    8080274: 'T',
    8080275: 'G',
    8080276: 'T',
    8080277: 'T',
    8080278: 'T',
    8080279: 'G',
    8080280: 'T',
    8080281: 'T',
    8080282: 'T',
    8080283: 'G',
    8080284: 'G',
    8781389: 'G',
    8781390: 'C',
    8781391: 'A',
    8781392: 'A',
    8781393: 'A',
    8781394: 'A',
    8781395: 'T',
    8833753: 'G',
    8833754: 'C',
    8833755: 'T',
    8833756: 'T',
    8833757: 'A',
    9035324: 'G',
    9035325: 'A',
    9035326: 'T',
    9035327: 'T',
    9035328: 'T',
    9035329: 'T',
    9035330: 'C',
    12611886: 'G',
    12611887: 'T',
    12611888: 'A',
    12611889: 'A',
    12611890: 'G',
    12611891: 'T',
    12611892: 'C',
    12611893: 'A',
    12611894: 'A',
    12611895: 'G',
    12611896: 'T',
    12611897: 'T',
    13527235: 'T',
    13527236: 'C',
    13527237: 'T',
    13527238: 'T',
    13527239: 'G',
    13527240: 'T',
    13527241: 'G',
    14923408: 'T',
    14923409: 'G',
    14923410: 'A',
    14923411: 'G',
    14923412: 'C',
    14923413: 'C',
    14923414: 'T',
    14923415: 'A',
    14923416: 'A',
    14923417: 'A',
    14923418: 'A',
    14923419: 'G',
    14923420: 'C',
    14923421: 'C',
    14923422: 'T',
    15082250: 'T',
    15082251: 'T',
    15082252: 'G',
    15082253: 'G',
    15082254: 'T',
    15082255: 'G',
    15082256: 'G',
    15082257: 'T',
    15701885: 'T',
    15701886: 'A',
    15701887: 'T',
    15701888: 'C',
    15701889: 'T',
    15701890: 'G',
    15701891: 'A',
    15701892: 'A',
    15701893: 'G',
    15701894: 'T',
    15701895: 'C',
    15701896: 'T',
    15701897: 'T',
    17660504: 'C',
    17660505: 'T',
    17660506: 'C',
    17660507: 'T',
    17660508: 'A',
    17660509: 'A',
    17660510: 'A',
    17660511: 'C',
    17660512: 'C',
    17660513: 'C',
    17660514: 'T',
    17660515: 'C',
    17660516: 'T',
    17660517: 'C',
    17660518: 'C',
    17660519: 'T',
    17660520: 'A',
    17660521: 'A',
    17660522: 'A',
    17660523: 'C',
    17660524: 'C',
    17660525: 'C',
    17660526: 'C',
    18487144: 'A',
    18487145: 'G',
    18487146: 'A',
    18487147: 'A',
    18487148: 'T',
    18487149: 'A',
    18487150: 'A',
    18487151: 'T',
    18624880: 'G',
    18624881: 'A',
    18624882: 'T',
    18624883: 'C',
    18624884: 'T',
    18624885: 'G',
    19076741: 'C',
    19076742: 'A',
    19076743: 'C',
    19076744: 'C',
    19076745: 'C',
    19076746: 'T',
    19076747: 'C',
    19076748: 'C',
    19076749: 'C',
    19076750: 'C',
    19076751: 'A',
    20015190: 'A',
    20015191: 'T',
    20015192: 'A',
    20015193: 'A',
    20015194: 'A',
    20015195: 'C',
    20015196: 'A',
    20015197: 'G',
    20015645: 'A',
    20015646: 'A',
    20015647: 'C',
    20015648: 'T',
    20015649: 'C',
    20015650: 'T',
    20015651: 'C',
    20015652: 'A',
    20033561: 'A',
    20033562: 'A',
    20033563: 'T',
    20033564: 'A',
    20033565: 'A',
    20033566: 'T',
    20033567: 'T',
    20033568: 'C',
    20158173: 'T',
    20158174: 'C',
    20158175: 'T',
    20158176: 'T',
    20158177: 'G',
    20978412: 'G',
    20978413: 'A',
    20978414: 'T',
    20978415: 'C',
    20978416: 'T',
    20978417: 'A',
    21383364: 'A',
    21383365: 'T',
    21383366: 'C',
    21383367: 'T',
    21383368: 'A',
    21383369: 'C',
    21383370: 'T',
    21383371: 'T',
    21855319: 'A',
    21855320: 'C',
    21855321: 'T',
    21855322: 'G',
    21864929: 'T',
    21864930: 'C',
    21864931: 'T',
    21864932: 'G',
    21864933: 'T',
    21864934: 'A',
    21864935: 'A',
    21864936: 'T',
    21864937: 'G',
    21864938: 'C',
    22088980: 'A',
    22088981: 'T',
    22088982: 'G',
    22088983: 'G',
    22088984: 'A',
    22449565: 'G',
    22449566: 'T',
    22449567: 'C',
    22449568: 'T',
    22449569: 'C',
    22449570: 'A',
    22703258: 'G',
    22703259: 'A',
    22703260: 'G',
    22703261: 'A',
    22703262: 'A',
    22703263: 'G',
    22703264: 'G',
    22703265: 'T',
    22984186: 'A',
    22984187: 'C',
    22984188: 'A',
    22984189: 'A',
    22984190: 'C',
    24375696: 'A',
    24375697: 'C',
    24375698: 'C',
    24375699: 'A',
    24375700: 'G',
    24375701: 'G',
    24375702: 'A',
    24375703: 'T',
    24375704: 'G',
    24375705: 'C',
    24375706: 'A',
    24375707: 'G',
    24375708: 'G',
    24375709: 'A',
    24375710: 'T',
    24375711: 'G',
    24375712: 'C',
    24375713: 'A',
    29900008: 'T',
    29900009: 'T',
    29900010: 'A',
    29900011: 'G',
    29900012: 'A',
    29900013: 'G',
    29900014: 'T',
    30110425: 'A',
    30110426: 'C',
    30110427: 'T',
    30110428: 'G',
    30110429: 'T',
    30110430: 'G',
    30110431: 'C',
    30747540: 'T',
    30747541: 'C',
    30747542: 'A',
    30747543: 'T',
    30747544: 'T',
    30747545: 'A',
    30747546: 'T',
    30747547: 'T',
    30747548: 'T',
    32871419: 'A',
    32871420: 'A',
    32871421: 'G',
    32871422: 'G',
    32871423: 'C',
    33626397: 'A',
    33626398: 'C',
    33626399: 'A',
    33626400: 'G',
    33626401: 'G',
    35525285: 'C',
    35525286: 'T',
    35525287: 'G',
    35525288: 'A',
    36010623: 'G',
    36010624: 'A',
    36010625: 'G',
    36010626: 'G',
    36010627: 'T',
    36010628: 'G',
    36010629: 'A',
    36686808: 'T',
    36686809: 'C',
    36686810: 'T',
    36686811: 'T',
    36686812: 'T',
    36686813: 'G',
    37048673: 'C',
    37048674: 'A',
    37048675: 'A',
    37048676: 'T',
    37048677: 'A',
    37048678: 'A',
    37388007: 'A',
    37388008: 'A',
    37388009: 'A',
    37388010: 'C',
    37388011: 'T',
    37388012: 'C',
    37388013: 'T',
    37388014: 'A',
    37388015: 'G',
    37388016: 'C',
    37388017: 'G',
    37388018: 'A',
    37388019: 'G',
    37388020: 'A',
    37388021: 'G',
    37394793: 'G',
    37394794: 'A',
    37394795: 'T',
    37394796: 'T',
    37394797: 'A',
    38022698: 'G',
    38022699: 'C',
    38022700: 'A',
    38022701: 'A',
    38022702: 'G',
    38022703: 'A',
    38022704: 'A',
    38022705: 'G',
    38022706: 'T',
    38416229: 'G',
    38416230: 'C',
    38416231: 'T',
    38416232: 'G',
    38416233: 'A',
    38416234: 'T',
    38416235: 'T',
    38416236: 'G',
    38416237: 'A',
    38416238: 'T',
    38416239: 'T',
    38416240: 'G',
    38416241: 'A',
    38416242: 'T',
    38416243: 'A',
    38441274: 'A',
    38441275: 'T',
    38441276: 'A',
    38441277: 'A',
    38441278: 'A',
    38441279: 'A',
    38441280: 'A',
    38441281: 'T',
    39074858: 'A',
    39074859: 'T',
    39074860: 'T',
    39074861: 'C',
    39074862: 'T',
    39074863: 'G',
    39918075: 'A',
    39918076: 'C',
    39918077: 'A',
    39918078: 'G',
    39918079: 'A',
    39918080: 'G',
    39918081: 'A',
    39918082: 'A',
    41086656: 'T',
    41086657: 'C',
    41086658: 'A',
    41086659: 'A',
    41086660: 'A',
    41086661: 'G',
    41284372: 'G',
    41284373: 'G',
    41284374: 'T',
    41284375: 'T',
    41284376: 'T',
    41284377: 'C',
    42551665: 'G',
    42551666: 'C',
    42551667: 'A',
    42551668: 'G',
    42551669: 'T',
    42595597: 'C',
    42595598: 'C',
    42595599: 'C',
    42595600: 'A',
    42595601: 'C',
    42595602: 'C',
    42595603: 'A',
    42595604: 'A',
    42595605: 'C',
    42595606: 'A',
    42595607: 'C',
    42595608: 'C',
    42595609: 'A',
    42595610: 'A',
    42595611: 'C',
    42595612: 'A',
    42595613: 'T',
    43521311: 'T',
    43521312: 'T',
    43521313: 'T',
    43521314: 'A',
    43521315: 'C',
    43521316: 'T',
    43521317: 'C',
    43521318: 'T',
    43521319: 'A',
    43521320: 'A',
    45850733: 'T',
    45850734: 'T',
    45850735: 'A',
    45850736: 'G',
    45850737: 'A',
    45850738: 'G',
    45850739: 'T',
    45924825: 'C',
    45924826: 'C',
    45924827: 'T',
    45924828: 'T',
    45924829: 'G',
    46657101: 'T',
    46657102: 'A',
    46657103: 'C',
    46657104: 'A',
    46687120: 'C',
    46687121: 'T',
    46687122: 'T',
    46687123: 'C',
    46981901: 'T',
    46981902: 'G',
    46981903: 'A',
    46981904: 'T',
    46981905: 'G',
    46981906: 'A',
    46981907: 'G',
    46981908: 'C',
    46981909: 'T',
    46981910: 'C',
    46981911: 'T',
    46981912: 'A',
    46981913: 'A',
    46981914: 'A',
    46981915: 'G',
    48696633: 'C',
    48696634: 'A',
    48696635: 'G',
    48696636: 'A',
    49350125: 'G',
    49350126: 'C',
    49350127: 'T',
    49350128: 'A',
    49350129: 'T',
    49350130: 'A',
    49350131: 'G',
    50018384: 'C',
    50018385: 'A',
    50018386: 'A',
    50018387: 'G',
    50018388: 'G',
    50018389: 'T',
    50018390: 'G',
    50018391: 'T',
    50018392: 'C',
    50018393: 'A',
    50018394: 'A',
    50018395: 'C',
    50018396: 'A',
    50018397: 'A',
    50018398: 'A',
    50018399: 'T',
    50018400: 'A',
    50018401: 'G',
    50018402: 'C',
    50114683: 'C',
    50114684: 'C',
    50114685: 'T',
    50114686: 'T',
    50114687: 'T',
    50114688: 'C',
    50712017: 'A',
    50712018: 'G',
    50712019: 'T',
    50712020: 'C',
    50712021: 'C',
    51512770: 'G',
    51512771: 'G',
    51512772: 'C',
    51512773: 'T',
    51512774: 'C',
    51512775: 'T',
    51512776: 'C',
    51512777: 'T',
    51512778: 'G',
    51731200: 'T',
    51731201: 'T',
    51731202: 'C',
    51731203: 'C',
    51731204: 'C',
    51731205: 'C',
    51731206: 'A',
    52772450: 'T',
    52772451: 'T',
    52772452: 'A',
    52772453: 'T',
    54158728: 'A',
    54158729: 'G',
    54158730: 'T',
    54158731: 'C',
    54158732: 'T',
    54158733: 'G',
    54664035: 'A',
    54664036: 'T',
    54664037: 'A',
    54664038: 'G',
    55292355: 'C',
    55292356: 'G',
    55292357: 'T',
    55292358: 'T',
    55292359: 'T',
    55292360: 'C',
    55444411: 'C',
    55444412: 'A',
    55444413: 'G',
    55444414: 'A',
    55444415: 'G',
    55444416: 'G',
    55444417: 'A',
    55444418: 'G',
    55444419: 'A',
    55557709: 'C',
    55557710: 'A',
    55557711: 'G',
    55557712: 'A',
    55557713: 'G',
    55557714: 'C',
    55557715: 'T',
    55557716: 'C',
    55557717: 'T',
    55557718: 'G',
    55557719: 'A',
    55557720: 'C',
    56311459: 'T',
    56311460: 'A',
    56311461: 'T',
    56311462: 'T',
    56311463: 'G',
    56788027: 'G',
    56788028: 'T',
    56788029: 'T',
    56788030: 'A',
    56788031: 'T',
    56788032: 'G',
    57863959: 'A',
    57863960: 'G',
    57863961: 'A',
    57863962: 'A',
    57863963: 'A',
    57863964: 'C',
    57863965: 'C',
    57863966: 'A',
    57863967: 'G',
    57967770: 'A',
    57967771: 'A',
    57967772: 'T',
    57967773: 'T',
    57967774: 'A',
    58742715: 'C',
    58742716: 'C',
    58742717: 'T',
    58742718: 'A',
    58742719: 'C',
    58742720: 'T',
    58742721: 'G',
    58742722: 'A',
    58742723: 'T',
    58742724: 'G',
    59705550: 'A',
    59705551: 'C',
    59705552: 'T',
    59705553: 'T',
    59705554: 'T',
    59705555: 'G',
    59705556: 'T',
    59705557: 'T',
    59705558: 'T',
    59705559: 'G',
    59705560: 'T',
    59705561: 'C',
    59917969: 'A',
    59917970: 'C',
    59917971: 'A',
    59917972: 'T',
    59917973: 'T',
    59917974: 'A',
    59917975: 'G',
    59961557: 'T',
    59961558: 'C',
    59961559: 'T',
    59961560: 'T',
    59961561: 'T',
    59961562: 'C',
    60744895: 'C',
    60744896: 'T',
    60744897: 'G',
    60744898: 'T',
    60744899: 'C',
    60744900: 'C',
    60744901: 'A',
    60744902: 'C',
    60744903: 'A',
    60744904: 'C',
    60744905: 'C',
    60744906: 'G',
    60744907: 'T',
    60744908: 'C',
    60744909: 'C',
    60744910: 'A',
    60744911: 'C',
    60744912: 'A',
    60744913: 'C',
}


class Chr20ReferenceGenome:
    """
    Reference genome for chr20 based on vt test reference (20.fa.gz).

    Extracted from vt/test/ref/20.fa.gz for positions needed by test cases.
    """

    def fetch(self, chrom: str, start: int, end: int) -> str:
        """Fetch reference sequence for a region (0-based coordinates)."""
        if start in REF_CONTEXT:
            return REF_CONTEXT[start]
        return "N"


VT_TEST_CASES = [
    {
        "input": {"chrom": "20", "pos": 421808, "ref": "A", "alt": "ACCA"},
        "expected": {"pos": 421805, "ref": "T", "alt": "TCCA"},
        "note": "Left-align insertion by 3bp",
    },
    {
        "input": {"chrom": "20", "pos": 1292033, "ref": "C", "alt": "CTTGT"},
        "expected": {"pos": 1292033, "ref": "C", "alt": "CTTGT"},
        "note": "Already normalized - no change",
    },
    {
        "input": {"chrom": "20", "pos": 1340527, "ref": "T", "alt": "TGTC"},
        "expected": {"pos": 1340527, "ref": "T", "alt": "TGTC"},
        "note": "Already normalized - no change",
    },
    {
        "input": {"chrom": "20", "pos": 1600125, "ref": "GAA", "alt": "G"},
        "expected": {"pos": 1600125, "ref": "GAA", "alt": "G"},
        "note": "Already normalized deletion",
    },
    {
        "input": {"chrom": "20", "pos": 2171404, "ref": "A", "alt": "AA"},
        "expected": {"pos": 2171402, "ref": "T", "alt": "TA"},
        "note": "Left-align A insertion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 3373441, "ref": "TCTTT", "alt": "T"},
        "expected": {"pos": 3373437, "ref": "GCTTT", "alt": "G"},
        "note": "Left-align CTTT deletion by 4bp",
    },
    {
        "input": {"chrom": "20", "pos": 3635159, "ref": "T", "alt": "TT"},
        "expected": {"pos": 3635158, "ref": "A", "alt": "AT"},
        "note": "Left-align T insertion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 4422119, "ref": "GCTCCCAGGCTACAGAAAGATGATGGAG", "alt": "G"},
        "expected": {"pos": 4422115, "ref": "GGGAGCTCCCAGGCTACAGAAAGATGAT", "alt": "G"},
        "note": "Left-align large deletion - rotates sequence",
    },
    {
        "input": {"chrom": "20", "pos": 5900670, "ref": "C", "alt": "CC"},
        "expected": {"pos": 5900669, "ref": "G", "alt": "GC"},
        "note": "Left-align C insertion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 8080280, "ref": "GTTTG", "alt": "G"},
        "expected": {"pos": 8080272, "ref": "CTTTG", "alt": "C"},
        "note": "Left-align TTTG deletion by 8bp",
    },
    {
        "input": {"chrom": "20", "pos": 8781394, "ref": "AA", "alt": "A"},
        "expected": {"pos": 8781391, "ref": "CA", "alt": "C"},
        "note": "Left-align A deletion by 3bp",
    },
    {
        "input": {"chrom": "20", "pos": 8833756, "ref": "TT", "alt": "T"},
        "expected": {"pos": 8833755, "ref": "CT", "alt": "C"},
        "note": "Left-align T deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 9035330, "ref": "T", "alt": "TT"},
        "expected": {"pos": 9035326, "ref": "A", "alt": "AT"},
        "note": "Left-align T insertion by 4bp",
    },
    {
        "input": {"chrom": "20", "pos": 12611892, "ref": "TCAAGT", "alt": "T"},
        "expected": {"pos": 12611888, "ref": "TAAGTC", "alt": "T"},
        "note": "Left-align CAAGT deletion - rotates sequence",
    },
    {
        "input": {"chrom": "20", "pos": 13527241, "ref": "T", "alt": "TTGT"},
        "expected": {"pos": 13527237, "ref": "C", "alt": "CTTG"},
        "note": "Left-align TGT insertion by 4bp - becomes TTG",
    },
    {
        "input": {"chrom": "20", "pos": 14923414, "ref": "CTAAAAGCC", "alt": "C"},
        "expected": {"pos": 14923410, "ref": "GAGCCTAAA", "alt": "G"},
        "note": "Left-align deletion - rotates sequence",
    },
    {
        "input": {"chrom": "20", "pos": 15082253, "ref": "GGTGG", "alt": "G"},
        "expected": {"pos": 15082252, "ref": "TGGTG", "alt": "T"},
        "note": "Left-align GTGG deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 15701890, "ref": "TGAAGTCT", "alt": "T"},
        "expected": {"pos": 15701887, "ref": "ATCTGAAG", "alt": "A"},
        "note": "Left-align deletion - normalizes to same as 15701887",
    },
    {
        "input": {"chrom": "20", "pos": 17660514, "ref": "CTCTCCTAAACCC", "alt": "C"},
        "expected": {"pos": 17660506, "ref": "TCTAAACCCTCTC", "alt": "T"},
        "note": "Left-align deletion by 8bp - rotates sequence",
    },
    {
        "input": {"chrom": "20", "pos": 18487147, "ref": "AATAA", "alt": "A"},
        "expected": {"pos": 18487146, "ref": "GAATA", "alt": "G"},
        "note": "Left-align ATAA deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 18624883, "ref": "TCT", "alt": "T"},
        "expected": {"pos": 18624882, "ref": "ATC", "alt": "A"},
        "note": "Left-align CT deletion by 1bp - becomes TC",
    },
    {
        "input": {"chrom": "20", "pos": 19076746, "ref": "CTCCCC", "alt": "C"},
        "expected": {"pos": 19076743, "ref": "ACCCTC", "alt": "A"},
        "note": "Left-align TCCCC deletion by 3bp",
    },
    {
        "input": {"chrom": "20", "pos": 20015197, "ref": "A", "alt": "AAACA"},
        "expected": {"pos": 20015192, "ref": "T", "alt": "TAAAC"},
        "note": "Left-align AACA insertion by 5bp",
    },
    {
        "input": {"chrom": "20", "pos": 20015650, "ref": "CTC", "alt": "C"},
        "expected": {"pos": 20015647, "ref": "ACT", "alt": "A"},
        "note": "Left-align TC deletion by 3bp",
    },
    {
        "input": {"chrom": "20", "pos": 20033568, "ref": "T", "alt": "TAATT"},
        "expected": {"pos": 20033563, "ref": "A", "alt": "ATAAT"},
        "note": "Left-align AATT insertion by 5bp",
    },
    {
        "input": {"chrom": "20", "pos": 20158176, "ref": "TT", "alt": "T"},
        "expected": {"pos": 20158175, "ref": "CT", "alt": "C"},
        "note": "Left-align T deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 20978417, "ref": "T", "alt": "TCT"},
        "expected": {"pos": 20978414, "ref": "A", "alt": "ATC"},
        "note": "Left-align CT insertion by 3bp - becomes TC",
    },
    {
        "input": {"chrom": "20", "pos": 21383368, "ref": "TACT", "alt": "T"},
        "expected": {"pos": 21383366, "ref": "TCTA", "alt": "T"},
        "note": "Left-align ACT deletion by 2bp - becomes CTA",
    },
    {
        "input": {"chrom": "20", "pos": 21855322, "ref": "T", "alt": "TT"},
        "expected": {"pos": 21855321, "ref": "C", "alt": "CT"},
        "note": "Left-align T insertion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 21864933, "ref": "GTAATG", "alt": "G"},
        "expected": {"pos": 21864931, "ref": "CTGTAA", "alt": "C"},
        "note": "Left-align TAATG deletion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 22088984, "ref": "G", "alt": "GG"},
        "expected": {"pos": 22088982, "ref": "T", "alt": "TG"},
        "note": "Left-align G insertion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 22449570, "ref": "C", "alt": "CCTC"},
        "expected": {"pos": 22449567, "ref": "T", "alt": "TCTC"},
        "note": "Left-align CTC insertion by 3bp",
    },
    {
        "input": {"chrom": "20", "pos": 22703265, "ref": "G", "alt": "GAAGG"},
        "expected": {"pos": 22703260, "ref": "A", "alt": "AGAAG"},
        "note": "Left-align AAGG insertion by 5bp - becomes GAAG",
    },
    {
        "input": {"chrom": "20", "pos": 22984189, "ref": "AA", "alt": "A"},
        "expected": {"pos": 22984188, "ref": "CA", "alt": "C"},
        "note": "Left-align A deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 24375706, "ref": "CAGGATGC", "alt": "C"},
        "expected": {"pos": 24375698, "ref": "CCAGGATG", "alt": "C"},
        "note": "Left-align AGGATGC deletion by 8bp",
    },
    {
        "input": {"chrom": "20", "pos": 29900012, "ref": "GAG", "alt": "G"},
        "expected": {"pos": 29900010, "ref": "TAG", "alt": "T"},
        "note": "Left-align AG deletion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 30110429, "ref": "GTG", "alt": "G"},
        "expected": {"pos": 30110427, "ref": "CTG", "alt": "C"},
        "note": "Left-align TG deletion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 30747545, "ref": "TATT", "alt": "T"},
        "expected": {"pos": 30747542, "ref": "CATT", "alt": "C"},
        "note": "Left-align ATT deletion by 3bp",
    },
    {
        "input": {"chrom": "20", "pos": 32871422, "ref": "GG", "alt": "G"},
        "expected": {"pos": 32871421, "ref": "AG", "alt": "A"},
        "note": "Left-align G deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 33626401, "ref": "G", "alt": "GAAG"},
        "expected": {"pos": 33626399, "ref": "C", "alt": "CAGA"},
        "note": "Left-align AAG insertion by 2bp - becomes AGA",
    },
    {
        "input": {"chrom": "20", "pos": 35525288, "ref": "G", "alt": "GGACAG"},
        "expected": {"pos": 35525287, "ref": "T", "alt": "TGGACA"},
        "note": "Left-align GACAG insertion by 1bp - becomes GGACA",
    },
    {
        "input": {"chrom": "20", "pos": 36010629, "ref": "G", "alt": "GCAGGGTG"},
        "expected": {"pos": 36010625, "ref": "A", "alt": "AGGTGCAG"},
        "note": "Left-align CAGGGTG insertion by 4bp",
    },
    {
        "input": {"chrom": "20", "pos": 36686811, "ref": "TTT", "alt": "T"},
        "expected": {"pos": 36686810, "ref": "CTT", "alt": "C"},
        "note": "Left-align TT deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 37048678, "ref": "A", "alt": "ATA"},
        "expected": {"pos": 37048675, "ref": "A", "alt": "AAT"},
        "note": "Left-align TA insertion by 3bp - becomes AT",
    },
    {
        "input": {"chrom": "20", "pos": 37388010, "ref": "ACTCTAGCGAGA", "alt": "A"},
        "expected": {"pos": 37388009, "ref": "AACTCTAGCGAG", "alt": "A"},
        "note": "Left-align CTCTAGCGAGA deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 37394796, "ref": "TT", "alt": "T"},
        "expected": {"pos": 37394795, "ref": "AT", "alt": "A"},
        "note": "Left-align T deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 38022703, "ref": "GAAG", "alt": "G"},
        "expected": {"pos": 38022700, "ref": "CAAG", "alt": "C"},
        "note": "Left-align AAG deletion by 3bp",
    },
    {
        "input": {"chrom": "20", "pos": 38416239, "ref": "TTGAT", "alt": "T"},
        "expected": {"pos": 38416231, "ref": "CTGAT", "alt": "C"},
        "note": "Left-align TGAT deletion by 8bp",
    },
    {
        "input": {"chrom": "20", "pos": 38441280, "ref": "AA", "alt": "A"},
        "expected": {"pos": 38441276, "ref": "TA", "alt": "T"},
        "note": "Left-align A deletion by 4bp",
    },
    {
        "input": {"chrom": "20", "pos": 39074861, "ref": "TCT", "alt": "T"},
        "expected": {"pos": 39074860, "ref": "TTC", "alt": "T"},
        "note": "Left-align CT deletion by 1bp - becomes TC",
    },
    {
        "input": {"chrom": "20", "pos": 39918080, "ref": "AGA", "alt": "A"},
        "expected": {"pos": 39918077, "ref": "CAG", "alt": "C"},
        "note": "Left-align GA deletion by 3bp - becomes AG",
    },
    {
        "input": {"chrom": "20", "pos": 41086660, "ref": "AA", "alt": "A"},
        "expected": {"pos": 41086658, "ref": "CA", "alt": "C"},
        "note": "Left-align A deletion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 41284377, "ref": "T", "alt": "TTT"},
        "expected": {"pos": 41284374, "ref": "G", "alt": "GTT"},
        "note": "Left-align TT insertion by 3bp",
    },
    {
        "input": {"chrom": "20", "pos": 42551669, "ref": "G", "alt": "GAG"},
        "expected": {"pos": 42551667, "ref": "C", "alt": "CAG"},
        "note": "Left-align AG insertion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 42595607, "ref": "ACCAACA", "alt": "A"},
        "expected": {"pos": 42595599, "ref": "CCACCAA", "alt": "C"},
        "note": "Left-align CCAACA deletion by 8bp",
    },
    {
        "input": {"chrom": "20", "pos": 43521315, "ref": "ACTCTA", "alt": "A"},
        "expected": {"pos": 43521313, "ref": "TTACTC", "alt": "T"},
        "note": "Left-align CTCTA deletion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 45850737, "ref": "GAG", "alt": "G"},
        "expected": {"pos": 45850735, "ref": "TAG", "alt": "T"},
        "note": "Left-align AG deletion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 45924828, "ref": "TT", "alt": "T"},
        "expected": {"pos": 45924827, "ref": "CT", "alt": "C"},
        "note": "Left-align T deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 46657104, "ref": "C", "alt": "CTCC"},
        "expected": {"pos": 46657103, "ref": "A", "alt": "ACTC"},
        "note": "Left-align TCC insertion by 1bp - becomes CTC",
    },
    {
        "input": {"chrom": "20", "pos": 46687123, "ref": "T", "alt": "TAT"},
        "expected": {"pos": 46687122, "ref": "T", "alt": "TTA"},
        "note": "Left-align AT insertion by 1bp - becomes TA",
    },
    {
        "input": {"chrom": "20", "pos": 46981904, "ref": "ATGAGCTCTAAA", "alt": "A"},
        "expected": {"pos": 46981903, "ref": "GATGAGCTCTAA", "alt": "G"},
        "note": "Left-align TGAGCTCTAAA deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 48696636, "ref": "G", "alt": "GG"},
        "expected": {"pos": 48696635, "ref": "A", "alt": "AG"},
        "note": "Left-align G insertion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 49350131, "ref": "A", "alt": "ATA"},
        "expected": {"pos": 49350127, "ref": "C", "alt": "CTA"},
        "note": "Left-align TA insertion by 4bp",
    },
    {
        "input": {"chrom": "20", "pos": 50018388, "ref": "GGTGTCAACAAATAG", "alt": "G"},
        "expected": {"pos": 50018386, "ref": "AAGGTGTCAACAAAT", "alt": "A"},
        "note": "Left-align large deletion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 50114687, "ref": "TT", "alt": "T"},
        "expected": {"pos": 50114685, "ref": "CT", "alt": "C"},
        "note": "Left-align T deletion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 50712021, "ref": "C", "alt": "CTC"},
        "expected": {"pos": 50712019, "ref": "G", "alt": "GTC"},
        "note": "Left-align TC insertion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 51512776, "ref": "TCT", "alt": "T"},
        "expected": {"pos": 51512772, "ref": "GCT", "alt": "G"},
        "note": "Left-align CT deletion by 4bp",
    },
    {
        "input": {"chrom": "20", "pos": 51731206, "ref": "C", "alt": "CC"},
        "expected": {"pos": 51731202, "ref": "T", "alt": "TC"},
        "note": "Left-align C insertion by 4bp",
    },
    {
        "input": {"chrom": "20", "pos": 52772453, "ref": "A", "alt": "AA"},
        "expected": {"pos": 52772452, "ref": "T", "alt": "TA"},
        "note": "Left-align A insertion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 54158733, "ref": "T", "alt": "TCTCT"},
        "expected": {"pos": 54158730, "ref": "G", "alt": "GTCTC"},
        "note": "Left-align CTCT insertion by 3bp",
    },
    {
        "input": {"chrom": "20", "pos": 54664038, "ref": "A", "alt": "AAA"},
        "expected": {"pos": 54664037, "ref": "T", "alt": "TAA"},
        "note": "Left-align AA insertion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 55292358, "ref": "TTT", "alt": "T"},
        "expected": {"pos": 55292357, "ref": "GTT", "alt": "G"},
        "note": "Left-align TT deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 55444416, "ref": "GGAG", "alt": "G"},
        "expected": {"pos": 55444413, "ref": "AGAG", "alt": "A"},
        "note": "Left-align GAG deletion by 3bp",
    },
    {
        "input": {"chrom": "20", "pos": 55557713, "ref": "AGCTCTGA", "alt": "A"},
        "expected": {"pos": 55557711, "ref": "AGAGCTCT", "alt": "A"},
        "note": "Left-align GCTCTGA deletion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 56311463, "ref": "T", "alt": "TT"},
        "expected": {"pos": 56311461, "ref": "A", "alt": "AT"},
        "note": "Left-align T insertion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 56788032, "ref": "T", "alt": "TAT"},
        "expected": {"pos": 56788029, "ref": "T", "alt": "TTA"},
        "note": "Left-align AT insertion by 3bp - becomes TA",
    },
    {
        "input": {"chrom": "20", "pos": 57863967, "ref": "A", "alt": "AAACCA"},
        "expected": {"pos": 57863961, "ref": "G", "alt": "GAAACC"},
        "note": "Left-align AACCA insertion by 6bp",
    },
    {
        "input": {"chrom": "20", "pos": 57967774, "ref": "T", "alt": "TT"},
        "expected": {"pos": 57967772, "ref": "A", "alt": "AT"},
        "note": "Left-align T insertion by 2bp",
    },
    {
        "input": {"chrom": "20", "pos": 58742718, "ref": "TACTGAT", "alt": "T"},
        "expected": {"pos": 58742717, "ref": "CTACTGA", "alt": "C"},
        "note": "Left-align ACTGAT deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 59705557, "ref": "TTTGT", "alt": "T"},
        "expected": {"pos": 59705552, "ref": "CTTTG", "alt": "C"},
        "note": "Left-align TTGT deletion by 5bp",
    },
    {
        "input": {"chrom": "20", "pos": 59917975, "ref": "A", "alt": "ATTA"},
        "expected": {"pos": 59917971, "ref": "C", "alt": "CATT"},
        "note": "Left-align TTA insertion by 4bp - becomes ATT",
    },
    {
        "input": {"chrom": "20", "pos": 59961560, "ref": "TTT", "alt": "T"},
        "expected": {"pos": 59961559, "ref": "CTT", "alt": "C"},
        "note": "Left-align TT deletion by 1bp",
    },
    {
        "input": {"chrom": "20", "pos": 60744904, "ref": "ACCGTCCACA", "alt": "A"},
        "expected": {"pos": 60744897, "ref": "TGTCCACACC", "alt": "T"},
        "note": "Left-align large deletion by 7bp - sequence rotates",
    },
]


class TestVtNormalization:
    """
    Test normalization using cases from vt test suite.

    Source: vt/test/normalize/01_IN.vcf -> 01_OUT.vcf
    Reference: vt/test/ref/20.fa.gz

    These test cases validate that our normalization implementation
    produces the same results as the vt tool.
    """

    @pytest.fixture
    def ref_genome(self):
        return Chr20ReferenceGenome()

    @pytest.mark.parametrize("test_case", VT_TEST_CASES, ids=lambda tc: f"{tc['input']['pos']}_{tc['note'][:30]}")
    def test_vt_normalization_case(self, ref_genome, test_case):
        """Test normalization against vt expected output."""
        inp = test_case["input"]
        exp = test_case["expected"]

        result_pos, result_ref, result_alts = normalize_variant(
            inp["chrom"],
            inp["pos"],
            inp["ref"],
            [inp["alt"]],
            ref_genome
        )

        assert result_pos == exp["pos"], f"Position mismatch for {test_case['note']}: expected {exp['pos']}, got {result_pos}"
        assert result_ref == exp["ref"], f"REF mismatch for {test_case['note']}: expected {exp['ref']}, got {result_ref}"
        assert result_alts[0] == exp["alt"], f"ALT mismatch for {test_case['note']}: expected {exp['alt']}, got {result_alts[0]}"


class TestVtNormalizationNoChange:
    """Test cases where vt does not change the variant (already normalized)."""

    NO_CHANGE_CASES = [
        {"chrom": "20", "pos": 1292033, "ref": "C", "alt": "CTTGT"},
        {"chrom": "20", "pos": 1340527, "ref": "T", "alt": "TGTC"},
        {"chrom": "20", "pos": 1600125, "ref": "GAA", "alt": "G"},
        {"chrom": "20", "pos": 1728298, "ref": "G", "alt": "GT"},
        {"chrom": "20", "pos": 2171402, "ref": "T", "alt": "TA"},
        {"chrom": "20", "pos": 5280839, "ref": "T", "alt": "TATA"},
        {"chrom": "20", "pos": 5291223, "ref": "TCAG", "alt": "T"},
        {"chrom": "20", "pos": 6351757, "ref": "C", "alt": "CTT"},
        {"chrom": "20", "pos": 9311904, "ref": "TGTATCTGTCCA", "alt": "T"},
    ]

    @pytest.mark.parametrize("case", NO_CHANGE_CASES, ids=lambda c: str(c["pos"]))
    def test_already_normalized(self, case):
        """Test that already-normalized variants are unchanged."""
        result_pos, result_ref, result_alts = normalize_variant(
            case["chrom"],
            case["pos"],
            case["ref"],
            [case["alt"]],
            None
        )

        assert result_pos == case["pos"]
        assert result_ref == case["ref"]
        assert result_alts[0] == case["alt"]
