name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.5.4)'
        required: true
        type: string
      skip_bioconda:
        description: 'Skip Bioconda update notification'
        required: false
        type: boolean
        default: false
      skip_nfcore:
        description: 'Skip nf-core module update'
        required: false
        type: boolean
        default: false
      create_nfcore_pr:
        description: 'Create PR to nf-core/modules (requires NF_CORE_PAT)'
        required: false
        type: boolean
        default: false
      nfcore_update_branch:
        description: 'Update existing nf-core PR branch instead of creating new PR'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run (build but do not publish)'
        required: false
        type: boolean
        default: false

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate-version:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Validate semver format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format '$VERSION'. Expected X.Y.Z (e.g., 0.5.4)"
            exit 1
          fi
          echo "Version $VERSION is valid"

  # =============================================================================
  # VERSION BUMP AND TAGGING
  # =============================================================================
  bump-and-tag:
    needs: validate-version
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install bump-my-version
        run: uv tool install bump-my-version

      - name: Bump version
        run: |
          bump-my-version bump --new-version ${{ inputs.version }}
          echo "Bumped to version ${{ inputs.version }}"

      - name: Push changes
        if: ${{ !inputs.dry_run }}
        run: |
          git push origin HEAD
          git push origin v${{ inputs.version }}

      - name: Dry run notice
        if: ${{ inputs.dry_run }}
        run: |
          echo "::notice::Dry run - skipping push"
          git log -1 --oneline
          git tag -l "v${{ inputs.version }}"

  # =============================================================================
  # NF-CORE MODULE VERSION VERIFICATION
  # Sanity check that bump-my-version correctly updated nf-core module files.
  # Versions in main.nf (container tag) and environment.yml (bioconda package)
  # are updated by bump-my-version, NOT by this job.
  # =============================================================================
  verify-nfcore-module-versions:
    needs: [bump-and-tag, build-and-push-docker]
    if: ${{ !inputs.skip_nfcore }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ inputs.version }}
        if: ${{ !inputs.dry_run }}

      - uses: actions/checkout@v4
        if: ${{ inputs.dry_run }}

      - name: Verify nf-core module versions match release
        run: |
          VERSION="${{ inputs.version }}"
          echo "Verifying nf-core module files contain version $VERSION"

          # Check container tag in main.nf
          MAIN_NF="nf-core/modules/vcfpgloader/load/main.nf"
          if grep -q "ghcr.io/zacharyr41/vcf-pg-loader:${VERSION}" "$MAIN_NF"; then
            echo "‚úì main.nf container tag matches v${VERSION}"
          else
            echo "::error::main.nf container tag does not match version ${VERSION}"
            echo "Expected: ghcr.io/zacharyr41/vcf-pg-loader:${VERSION}"
            echo "Found:"
            grep -o 'ghcr.io/zacharyr41/vcf-pg-loader:[0-9.]*' "$MAIN_NF" || echo "  (no match found)"
            exit 1
          fi

          # Check bioconda package in environment.yml
          ENV_YML="nf-core/modules/vcfpgloader/load/environment.yml"
          if grep -q "bioconda::vcf-pg-loader=${VERSION}" "$ENV_YML"; then
            echo "‚úì environment.yml bioconda package matches v${VERSION}"
          else
            echo "::error::environment.yml bioconda package does not match version ${VERSION}"
            echo "Expected: bioconda::vcf-pg-loader=${VERSION}"
            echo "Found:"
            grep -o 'bioconda::vcf-pg-loader=[0-9.]*' "$ENV_YML" || echo "  (no match found)"
            exit 1
          fi

          echo ""
          echo "All nf-core module version checks passed!"

  # =============================================================================
  # DOCKER IMAGE BUILD AND PUBLISH
  # Must complete before nf-core module updates since the module references the container.
  # =============================================================================
  build-and-push-docker:
    needs: bump-and-tag
    if: ${{ !inputs.dry_run }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
    outputs:
      docker_tags: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ inputs.version }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/zacharyr41/vcf-pg-loader
          tags: |
            type=raw,value=${{ inputs.version }}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # =============================================================================
  # BUILD AND PUBLISH
  # =============================================================================
  build:
    needs: bump-and-tag
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ inputs.version }}
        if: ${{ !inputs.dry_run }}

      - uses: actions/checkout@v4
        if: ${{ inputs.dry_run }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build tools
        run: pip install build

      - name: Build package
        run: python -m build

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 5

  publish-pypi:
    needs: build
    if: ${{ !inputs.dry_run }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: pypi
    permissions:
      id-token: write
    outputs:
      pypi_url: ${{ steps.set-url.outputs.pypi_url }}
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Display artifacts
        run: ls -la dist/

      - name: Print SHA256 hashes
        run: |
          echo "## Package Hashes" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          sha256sum dist/* >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Set PyPI URL output
        id: set-url
        run: echo "pypi_url=https://pypi.org/project/vcf-pg-loader/${{ inputs.version }}/" >> "$GITHUB_OUTPUT"

  create-github-release:
    needs: publish-pypi
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          generate_release_notes: true
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  wait-for-pypi:
    needs: publish-pypi
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      sha256: ${{ steps.poll.outputs.sha256 }}
    steps:
      - name: Wait for PyPI availability
        id: poll
        run: |
          VERSION="${{ inputs.version }}"
          URL="https://pypi.org/pypi/vcf-pg-loader/${VERSION}/json"

          for i in $(seq 1 30); do
            echo "Attempt $i/30: Checking $URL"
            if response=$(curl -sf "$URL"); then
              echo "Package found on PyPI!"
              sha256=$(echo "$response" | jq -r '.urls[] | select(.packagetype == "sdist") | .digests.sha256')
              echo "SHA256: $sha256"
              echo "sha256=$sha256" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "Not available yet, waiting 10s..."
            sleep 10
          done

          echo "::error::Package not available on PyPI after 5 minutes"
          exit 1

  bioconda-pr:
    needs: wait-for-pypi
    if: ${{ !inputs.skip_bioconda }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    outputs:
      pr_url: ${{ steps.create-pr.outputs.pull-request-url }}
      outcome: ${{ steps.create-pr.outcome }}
    steps:
      - name: Checkout bioconda-recipes fork
        uses: actions/checkout@v4
        with:
          repository: Zacharyr41/bioconda-recipes
          token: ${{ secrets.BIOCONDA_PAT }}
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/bioconda/bioconda-recipes.git
          git fetch upstream master
          git checkout -B update-vcf-pg-loader-${{ inputs.version }} upstream/master

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install grayskull
        run: pip install grayskull

      - name: Generate recipe
        run: |
          grayskull pypi vcf-pg-loader==${{ inputs.version }} -o recipes/

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.BIOCONDA_PAT }}
          push-to-fork: Zacharyr41/bioconda-recipes
          branch: update-vcf-pg-loader-${{ inputs.version }}
          base: master
          title: "Update vcf-pg-loader to ${{ inputs.version }}"
          body: |
            ## Automated BioConda Recipe Update

            Updates `vcf-pg-loader` to version `${{ inputs.version }}`.

            - **PyPI**: https://pypi.org/project/vcf-pg-loader/${{ inputs.version }}/
            - **Changelog**: https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }}
            - **SHA256**: `${{ needs.wait-for-pypi.outputs.sha256 }}`

            ---
            ü§ñ This PR was automatically generated by the vcf-pg-loader release workflow.

  notify-bioconda-status:
    needs: bioconda-pr
    if: always() && !inputs.skip_bioconda
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
      issues: write
    steps:
      - name: Comment on release with PR link
        if: needs.bioconda-pr.outputs.pr_url != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: '${{ github.sha }}',
              body: `üß¨ BioConda PR created: ${{ needs.bioconda-pr.outputs.pr_url }}`
            });

            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 5
            });

            const release = releases.data.find(r => r.tag_name === 'v${{ inputs.version }}');
            if (release) {
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                body: release.body + '\n\n---\nüß¨ **BioConda PR**: ${{ needs.bioconda-pr.outputs.pr_url }}'
              });
            }

      - name: Create issue for manual BioConda PR
        if: needs.bioconda-pr.outputs.pr_url == '' && needs.bioconda-pr.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Manual BioConda PR needed for v${{ inputs.version }}',
              body: `The automated BioConda PR creation failed for v${{ inputs.version }}.

            ## Manual Steps

            1. Fork [bioconda-recipes](https://github.com/bioconda/bioconda-recipes) if not already done
            2. Install grayskull: \`pip install grayskull\`
            3. Generate recipe: \`grayskull pypi vcf-pg-loader==${{ inputs.version }} -o recipes/\`
            4. Submit PR to bioconda-recipes

            ## References

            - [PyPI Release](https://pypi.org/project/vcf-pg-loader/${{ inputs.version }}/)
            - [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }})
            - [BioConda Contributing Guide](https://bioconda.github.io/contributor/index.html)

            ---
            ü§ñ This issue was automatically created by the release workflow.`,
              labels: ['bioconda', 'release']
            });

  # =============================================================================
  # NF-CORE MODULES PR (OPTIONAL)
  # Creates a PR to nf-core/modules with the updated vcfpgloader module.
  #
  # IMPORTANT: This job runs AFTER bioconda-pr because:
  # 1. BioConda must be published first - nf-core modules use BioContainers
  # 2. BioContainers automatically builds from BioConda packages (~30 min after merge)
  # 3. The nf-core PR is optional and may require manual adjustments per nf-core guidelines
  #
  # NOTE: Version updates to main.nf and environment.yml are handled by
  # bump-my-version in the bump-and-tag job, NOT by this job.
  # =============================================================================
  nfcore-modules-pr:
    needs: [bioconda-pr, build-and-push-docker]
    if: ${{ !inputs.skip_nfcore && (inputs.create_nfcore_pr || inputs.nfcore_update_branch != '') && !inputs.dry_run }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true
    outputs:
      pr_url: ${{ steps.create-pr.outputs.pull-request-url }}
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          ref: v${{ inputs.version }}

      - name: Checkout nf-core/modules fork
        uses: actions/checkout@v4
        with:
          repository: Zacharyr41/nf-core-modules
          token: ${{ secrets.NF_CORE_PAT }}
          path: nf-core-modules-fork
          fetch-depth: 0

      - name: Configure git
        run: |
          cd nf-core-modules-fork
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Checkout existing branch (update mode)
        if: ${{ inputs.nfcore_update_branch != '' }}
        run: |
          cd nf-core-modules-fork
          git fetch origin ${{ inputs.nfcore_update_branch }}
          git checkout ${{ inputs.nfcore_update_branch }}

      - name: Create new branch from upstream (new PR mode)
        if: ${{ inputs.nfcore_update_branch == '' }}
        run: |
          cd nf-core-modules-fork
          git remote add upstream https://github.com/nf-core/modules.git || true
          git fetch upstream master
          git checkout -B update-vcfpgloader-${{ inputs.version }} upstream/master

      - name: Copy updated module files
        run: |
          mkdir -p nf-core-modules-fork/modules/nf-core/vcfpgloader/load
          cp -r nf-core/modules/vcfpgloader/load/* nf-core-modules-fork/modules/nf-core/vcfpgloader/load/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install nf-core tools and lint
        continue-on-error: true
        run: |
          pip install nf-core
          cd nf-core-modules-fork
          nf-core modules lint vcfpgloader/load || echo "::warning::nf-core lint reported issues - review may be needed"

      - name: Push to existing branch (update mode)
        if: ${{ inputs.nfcore_update_branch != '' }}
        run: |
          cd nf-core-modules-fork
          git add modules/nf-core/vcfpgloader/
          git commit -m "Update vcfpgloader module to ${{ inputs.version }}" || echo "No changes to commit"
          git push origin ${{ inputs.nfcore_update_branch }}
          echo "## nf-core Module Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pushed to branch: ${{ inputs.nfcore_update_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "PR: https://github.com/nf-core/modules/pull/9579" >> $GITHUB_STEP_SUMMARY

      - name: Create Pull Request (new PR mode)
        id: create-pr
        if: ${{ inputs.nfcore_update_branch == '' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.NF_CORE_PAT }}
          path: nf-core-modules-fork
          push-to-fork: Zacharyr41/nf-core-modules
          branch: update-vcfpgloader-${{ inputs.version }}
          base: master
          title: "Update vcfpgloader module to ${{ inputs.version }}"
          body: |
            ## Summary

            Updates the `vcfpgloader/load` module to version `${{ inputs.version }}`.

            ### Changes
            - Updated container tag to `ghcr.io/zacharyr41/vcf-pg-loader:${{ inputs.version }}`
            - Updated bioconda package to `vcf-pg-loader=${{ inputs.version }}`

            ### References
            - **PyPI**: https://pypi.org/project/vcf-pg-loader/${{ inputs.version }}/
            - **GitHub Release**: https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }}
            - **BioConda Recipe**: https://github.com/bioconda/bioconda-recipes/tree/master/recipes/vcf-pg-loader

            ---
            ü§ñ This PR was automatically generated by the vcf-pg-loader release workflow.

      - name: Report PR URL
        if: ${{ inputs.nfcore_update_branch == '' && steps.create-pr.outputs.pull-request-url != '' }}
        run: |
          echo "## nf-core Modules PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR: ${{ steps.create-pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # RELEASE SUMMARY
  # Updates the GitHub release with status of all jobs and links to artifacts.
  # =============================================================================
  release-summary:
    needs: [validate-version, bump-and-tag, verify-nfcore-module-versions, build-and-push-docker, build, publish-pypi, create-github-release, wait-for-pypi, bioconda-pr, notify-bioconda-status, nfcore-modules-pr]
    if: always() && !inputs.dry_run
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      - name: Update release with summary
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ inputs.version }}';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            const jobStatus = (result) => result === 'success' ? '‚úÖ' : (result === 'skipped' ? '‚è≠Ô∏è' : '‚ùå');

            const summary = `## Release Summary

            | Step | Status |
            |------|--------|
            | Version Validation | ${jobStatus('${{ needs.validate-version.result }}')} |
            | Version Bump & Tag | ${jobStatus('${{ needs.bump-and-tag.result }}')} |
            | nf-core Module Verification | ${jobStatus('${{ needs.verify-nfcore-module-versions.result }}')} |
            | Docker Build & Push | ${jobStatus('${{ needs.build-and-push-docker.result }}')} |
            | Python Package Build | ${jobStatus('${{ needs.build.result }}')} |
            | PyPI Publish | ${jobStatus('${{ needs.publish-pypi.result }}')} |
            | GitHub Release | ${jobStatus('${{ needs.create-github-release.result }}')} |
            | BioConda PR | ${jobStatus('${{ needs.bioconda-pr.result }}')} |
            | nf-core Modules PR | ${jobStatus('${{ needs.nfcore-modules-pr.result }}')} |

            ### Artifacts
            - **PyPI**: https://pypi.org/project/vcf-pg-loader/${version}/
            - **Docker**: \`ghcr.io/zacharyr41/vcf-pg-loader:${version}\`
            - **BioConda PR**: ${{ needs.bioconda-pr.outputs.pr_url || 'N/A' }}
            - **nf-core PR**: ${{ needs.nfcore-modules-pr.outputs.pr_url || 'N/A' }}

            ---
            üìã [Workflow Run](${runUrl})`;

            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 5
            });

            const release = releases.data.find(r => r.tag_name === `v${version}`);
            if (release) {
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                body: release.body + '\n\n' + summary
              });
              console.log('Updated release notes with summary');
            } else {
              console.log('Release not found, skipping summary update');
            }

  # =============================================================================
  # FAILURE NOTIFICATION
  # Creates a GitHub issue if any critical job failed.
  # =============================================================================
  notify-failures:
    needs: [validate-version, bump-and-tag, build-and-push-docker, build, publish-pypi, create-github-release, wait-for-pypi, bioconda-pr, nfcore-modules-pr]
    if: failure() && !inputs.dry_run
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      issues: write
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ inputs.version }}';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            const jobs = [
              { name: 'Version Validation', result: '${{ needs.validate-version.result }}' },
              { name: 'Version Bump & Tag', result: '${{ needs.bump-and-tag.result }}' },
              { name: 'Docker Build & Push', result: '${{ needs.build-and-push-docker.result }}' },
              { name: 'Python Package Build', result: '${{ needs.build.result }}' },
              { name: 'PyPI Publish', result: '${{ needs.publish-pypi.result }}' },
              { name: 'GitHub Release', result: '${{ needs.create-github-release.result }}' },
              { name: 'Wait for PyPI', result: '${{ needs.wait-for-pypi.result }}' },
              { name: 'BioConda PR', result: '${{ needs.bioconda-pr.result }}' },
              { name: 'nf-core Modules PR', result: '${{ needs.nfcore-modules-pr.result }}' }
            ];

            const failed = jobs.filter(j => j.result === 'failure');
            const skipped = jobs.filter(j => j.result === 'skipped');

            let body = `## Release v${version} Partially Failed

            The release workflow encountered failures. Manual intervention may be required.

            ### Failed Jobs
            ${failed.map(j => `- ‚ùå ${j.name}`).join('\n')}

            ### Skipped Jobs
            ${skipped.length > 0 ? skipped.map(j => `- ‚è≠Ô∏è ${j.name}`).join('\n') : 'None'}

            ### Manual Steps

            Depending on which jobs failed, you may need to:

            1. **Version Bump Failed**: Manually run \`bump-my-version bump --new-version ${version}\` and push
            2. **Docker Push Failed**: Manually build and push the Docker image
            3. **PyPI Publish Failed**: Manually publish with \`python -m build && twine upload dist/*\`
            4. **GitHub Release Failed**: Manually create the release from the tag
            5. **BioConda PR Failed**: See [BioConda contributing guide](https://bioconda.github.io/contributor/index.html)
            6. **nf-core PR Failed**: Manually create PR to nf-core/modules

            ### Debug Information

            - **Workflow Run**: ${runUrl}
            - **Tag**: v${version}
            - **Triggered by**: @${{ github.actor }}

            ---
            ü§ñ This issue was automatically created by the release workflow.`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Release v${version} partially failed`,
              body: body,
              labels: ['release', 'bug']
            });
