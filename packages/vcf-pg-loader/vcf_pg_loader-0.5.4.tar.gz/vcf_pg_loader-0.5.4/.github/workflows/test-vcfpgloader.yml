name: Test vcfpgloader module

on:
  push:
    paths:
      - 'nf-core/modules/vcfpgloader/**'
      - 'Dockerfile'
      - 'src/**'
  pull_request:
    paths:
      - 'nf-core/modules/vcfpgloader/**'
      - 'Dockerfile'
      - 'src/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=test-${{ github.run_id }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  stub-test:
    name: Stub Tests (no database)
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - uses: actions/checkout@v4

      - name: Setup Nextflow
        uses: nf-core/setup-nextflow@v2

      - name: Install nf-test
        run: |
          curl -fsSL https://get.nf-test.com | bash
          sudo mv nf-test /usr/local/bin/

      - name: Update container tag in main.nf
        run: |
          sed -i "s|ghcr.io/zacharyr41/vcf-pg-loader:0.4.0|ghcr.io/zacharyr41/vcf-pg-loader:test-${{ github.run_id }}|g" \
            nf-core/modules/vcfpgloader/load/main.nf

      - name: Set Nextflow secrets
        run: |
          nextflow secrets set PGPASSWORD "${{ secrets.PGPASSWORD }}"

      - name: Run stub tests
        run: |
          cd nf-core/modules/vcfpgloader/load
          nf-test test tests/main.nf.test --profile docker --tag stub

  # Integration tests require PostgreSQL - uncomment when ready
  # integration-test:
  #   name: Integration Tests (with PostgreSQL)
  #   runs-on: ubuntu-latest
  #   needs: build-image
  #   services:
  #     postgres:
  #       image: postgres:16-alpine
  #       env:
  #         POSTGRES_USER: postgres
  #         POSTGRES_PASSWORD: postgres
  #         POSTGRES_DB: vcf_test
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #       ports:
  #         - 5432:5432
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Setup Nextflow
  #       uses: nf-core/setup-nextflow@v2
  #     - name: Install nf-test
  #       run: |
  #         curl -fsSL https://get.nf-test.com | bash
  #         sudo mv nf-test /usr/local/bin/
  #     - name: Update container tag in main.nf
  #       run: |
  #         sed -i "s|ghcr.io/zacharyr41/vcf-pg-loader:0.4.0|ghcr.io/zacharyr41/vcf-pg-loader:test-${{ github.run_id }}|g" \
  #           nf-core/modules/vcfpgloader/load/main.nf
  #     - name: Initialize test database
  #       env:
  #         PGPASSWORD: postgres
  #       run: |
  #         psql -h localhost -U postgres -d vcf_test -f tests/sql/schema.sql
  #     - name: Set Nextflow secrets
  #       run: |
  #         nextflow secrets set PGPASSWORD postgres
  #     - name: Run integration tests
  #       env:
  #         PGHOST: localhost
  #         PGPORT: 5432
  #         PGDATABASE: vcf_test
  #         PGUSER: postgres
  #       run: |
  #         cd nf-core/modules/vcfpgloader/load
  #         nf-test test tests/main.nf.test --profile docker --tag integration
