<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Win Folder Manager</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .folder-row { transition: all 0.2s; }
        .folder-row:hover { background-color: #e9ecef; }
        .icon-preview { width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 8px; }
        .badge-soft { background-color: #e7f1ff; color: #0d6efd; border: 1px solid #cff4fc;}
        /* å¢åŠ  loading é®ç½©å±‚æ ·å¼ */
        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" class="container py-4" v-cloak>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0"><i class="fa-solid fa-folder-tree text-primary"></i> æ–‡ä»¶å¤¹ç®¡ç†å™¨</h2>
                <p class="text-muted small mb-0">å½“å‰è·¯å¾„: <strong>[[ config.root_path ]]</strong></p>
            </div>
            <div>
                <button class="btn btn-outline-secondary me-2" @click="showConfigModal">
                    <i class="fa-solid fa-gear"></i> è®¾ç½®
                </button>
                <button class="btn btn-success" @click="refreshFolders">
                    <i class="fa-solid fa-rotate-right"></i> åˆ·æ–°åˆ—è¡¨
                </button>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body py-2">
                <div class="d-flex gap-2">
                    <button class="btn btn-warning btn-sm" @click="batchRelativeToAll">
                        <i class="fa-solid fa-link"></i> å…¨éƒ¨è½¬ä¸ºç›¸å¯¹è·¯å¾„
                    </button>
                    <span class="text-muted small align-self-center ms-auto">
                        <i class="fa-solid fa-info-circle"></i> æç¤ºï¼šä¿®æ”¹é…ç½®åï¼Œèµ„æºç®¡ç†å™¨å¯èƒ½éœ€è¦å‡ ç§’é’Ÿåˆ·æ–°ç¼“å­˜ã€‚
                    </span>
                </div>
            </div>
        </div>

        <div class="card shadow">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 20%">ç‰©ç†åç§°</th>
                            <th style="width: 20%">æ˜¾ç¤ºåˆ«å</th>
                            <th style="width: 15%">å›¾æ ‡çŠ¶æ€</th>
                            <th style="width: 25%">å¤‡æ³¨ (InfoTip)</th>
                            <th class="text-end">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="folder in folders" :key="folder.path" class="folder-row">
                            <td class="font-monospace">[[ folder.name ]]</td>
                            <td>
                                <span v-if="folder.alias" class="fw-bold text-primary">[[ folder.alias ]]</span>
                                <span v-else class="text-muted fst-italic">- æ— åˆ«å -</span>
                            </td>
                            <td>
                                <span v-if="getIconAlias(folder.icon_path)" class="badge badge-soft">
                                    [[ getIconAlias(folder.icon_path) ]]
                                </span>
                                <span v-else-if="folder.icon_path" class="badge bg-secondary">è‡ªå®šä¹‰å›¾æ ‡</span>
                                <span v-else class="badge bg-light text-dark border">é»˜è®¤</span>
                            </td>
                            <td class="small text-muted text-truncate" style="max-width: 200px;">
                                [[ folder.infotip ]]
                            </td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-primary" @click="editFolder(folder)">
                                        <i class="fa-solid fa-pen"></i> ç¼–è¾‘
                                    </button>
                                    <button class="btn btn-outline-secondary" @click="openPath(folder.path, 'explorer')" title="æ‰“å¼€æ–‡ä»¶å¤¹">
                                        <i class="fa-regular fa-folder-open"></i>
                                    </button>
                                    <button class="btn btn-outline-dark" @click="openPath(folder.path, 'cmd')" title="æ‰“å¼€ CMD">
                                        <i class="fa-solid fa-terminal"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="modal fade" id="editModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ç¼–è¾‘å±æ€§: [[ currentFolder.name ]]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">æ–‡ä»¶å¤¹åˆ«å (ä¸­æ–‡å)</label>
                            <input type="text" class="form-control" v-model="editForm.alias" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„æ–‡æ¡£">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é¡¹ç›®å¤‡æ³¨ (InfoTip)</label>
                            <textarea class="form-control" v-model="editForm.infotip" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é€‰æ‹©å›¾æ ‡</label>
                            <select class="form-select" v-model="editForm.icon_path">
                                <option value="">ä½¿ç”¨é»˜è®¤æ–‡ä»¶å¤¹å›¾æ ‡</option>
                                <option v-for="icon in config.icons" :value="icon.path">
                                    [[ icon.name ]] ([[ icon.path ]])
                                </option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" v-model="editForm.use_relative" id="relPathCheck">
                            <label class="form-check-label" for="relPathCheck">
                                å°è¯•ä½¿ç”¨ç›¸å¯¹è·¯å¾„ä¿å­˜ (ä¾¿äºç§»åŠ¨)
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" @click="saveFolder">ä¿å­˜æ›´æ”¹</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="configModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <span v-if="!config.root_path">ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ï¼è¯·å…ˆé…ç½®</span>
                            <span v-else>å…¨å±€è®¾ç½®</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" v-if="config.root_path"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info" v-if="!config.root_path">
                            <i class="fa-solid fa-circle-info"></i> åˆæ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½®éœ€è¦ç®¡ç†çš„<b>æ ¹ç›®å½•è·¯å¾„</b>ã€‚
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold">æ ¹ç›®å½•è·¯å¾„</label>
                            <div class="input-group">
                                <input type="text" class="form-control" v-model="config.root_path" placeholder="ä¾‹å¦‚: D:\MyData">
                                <button class="btn btn-outline-secondary" type="button" @click="selectFolder">
                                    <i class="fa-regular fa-folder-open"></i> é€‰æ‹©
                                </button>
                            </div>
                        </div>
                        
                        <label class="form-label fw-bold">å›¾æ ‡åº“ç®¡ç†</label>
                        <table class="table table-bordered table-sm">
                            <thead>
                                <tr>
                                    <th>å›¾æ ‡åˆ«å</th>
                                    <th>ICO è·¯å¾„</th>
                                    <th width="50">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(icon, idx) in config.icons">
                                    <td><input type="text" class="form-control form-control-sm" v-model="icon.name"></td>
                                    <td><input type="text" class="form-control form-control-sm" v-model="icon.path"></td>
                                    <td><button class="btn btn-danger btn-sm" @click="removeIcon(idx)">Ã—</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button class="btn btn-outline-primary btn-sm" @click="addIcon">+ æ·»åŠ æ–°å›¾æ ‡</button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" @click="saveConfig">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center text-muted mt-5 mb-3 small">
            Win Folder Manager v{{ version }} &copy; 2025
        </footer>

    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            // å…³é”®ä¿®æ”¹ï¼šæ›´æ”¹ Vue çš„å®šç•Œç¬¦ï¼Œé¿å…ä¸ Flask Jinja2 å†²çª
            compilerOptions: {
                delimiters: ['[[', ']]']
            },
            data() {
                return {
                    config: { root_path: '', icons: [] },
                    folders: [],
                    currentFolder: {},
                    editForm: {
                        path: '',
                        alias: '',
                        infotip: '',
                        icon_path: '',
                        use_relative: true
                    },
                    modals: {
                        edit: null,
                        config: null
                    }
                }
            },
            mounted() {
                // Initialize Bootstrap Modals
                this.modals.edit = new bootstrap.Modal(document.getElementById('editModal'));
                this.modals.config = new bootstrap.Modal(document.getElementById('configModal'));
                
                this.loadConfig().then(() => {
                    if (!this.config.root_path) {
                        // First run: Show config modal
                        this.modals.config.show();
                    } else {
                        this.refreshFolders();
                    }
                });
            },
            methods: {
                async loadConfig() {
                    const res = await axios.get('/api/config');
                    this.config = res.data;
                },
                async saveConfig() {
                    await axios.post('/api/config', this.config);
                    this.modals.config.hide();
                    this.refreshFolders();
                },
                async refreshFolders() {
                    const res = await axios.get('/api/folders');
                    this.folders = res.data;
                },
                async openPath(path, mode) {
                    await axios.post('/api/open', { path, mode });
                },
                editFolder(folder) {
                    this.currentFolder = folder;
                    
                    // === æ™ºèƒ½åˆ«åç”Ÿæˆé€»è¾‘ ===
                    let initialAlias = folder.alias || '';
                    
                    // ä»…å½“å½“å‰æ²¡æœ‰åˆ«åæ—¶ï¼Œæ‰å°è¯•è‡ªåŠ¨ç”Ÿæˆ
                    if (!initialAlias) {
                        // æ­£åˆ™è§£é‡Šï¼š
                        // ^        : ä»å¤´å¼€å§‹åŒ¹é…
                        // (\d{6})  : æ•è·6ä½æ•°å­— (å¯¹åº” YYMMDD)
                        // _        : ç´§æ¥ç€ä¸€ä¸ªä¸‹åˆ’çº¿
                        const dateMatch = folder.name.match(/^(\d{6})_/);
                        
                        if (dateMatch) {
                            // dateMatch[1] æ‹¿åˆ°çš„å°±æ˜¯ '230214'
                            // æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œæ‹¼æ¥æˆ '230214_'
                            initialAlias = dateMatch[1] + '_';
                            
                            // ğŸ’¡ å¦‚æœä½ å¸Œæœ›å˜æˆ "[230214] " è¿™ç§æ ¼å¼ï¼Œå¯ä»¥æ”¹æˆ:
                            // initialAlias = `[${dateMatch[1]}] `;
                        }
                    }

                    // Copy data to form
                    this.editForm = {
                        path: folder.path,
                        alias: initialAlias, // ä½¿ç”¨è®¡ç®—åçš„åˆå§‹å€¼
                        infotip: folder.infotip || '',
                        icon_path: folder.icon_path || '',
                        use_relative: true
                    };
                    this.modals.edit.show();
                },
                async saveFolder() {
                    await axios.post('/api/update', this.editForm);
                    this.modals.edit.hide();
                    this.refreshFolders();
                },
                async batchRelativeToAll() {
                    if(!confirm('ç¡®å®šè¦å°†æ‰€æœ‰æ–‡ä»¶å¤¹é…ç½®è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„å—ï¼Ÿ')) return;
                    const res = await axios.post('/api/batch_relative');
                    alert(`å·²å¤„ç† ${res.data.count} ä¸ªæ–‡ä»¶å¤¹`);
                    this.refreshFolders();
                },
                
                // Config Icon Management
                addIcon() {
                    this.config.icons.push({ name: 'æ–°å›¾æ ‡', path: '', index: 0 });
                },
                removeIcon(index) {
                    this.config.icons.splice(index, 1);
                },
                async selectFolder() {
                    try {
                        const res = await axios.post('/api/select_folder');
                        if (res.data.status === 'success' && res.data.path) {
                            this.config.root_path = res.data.path;
                        } else if (res.data.status === 'error') {
                            alert('æ— æ³•æ‰“å¼€æ–‡ä»¶å¤¹é€‰æ‹©å™¨: ' + res.data.msg);
                        }
                    } catch (e) {
                        console.error(e);
                    }
                },
                showConfigModal() {
                    this.modals.config.show();
                },
                
                // Helpers
                getIconAlias(path) {
                    if (!path) return '';
                    
                    // === å¼ºåŠ›æ ‡å‡†åŒ–å‡½æ•° ===
                    // 1. å°†æ‰€æœ‰åæ–œæ  \ æ›¿æ¢ä¸º æ­£æ–œæ  /
                    // 2. å°†è¿ç»­çš„æ–œæ  // æ›¿æ¢ä¸º å•ä¸ª / (å®¹é”™)
                    // 3. è½¬ä¸ºå…¨å°å†™ (Windows ä¸åŒºåˆ†å¤§å°å†™)
                    // 4. å»é™¤é¦–å°¾ç©ºæ ¼
                    const standardize = (p) => {
                        if (!p) return '';
                        return p.toString()
                                .replace(/\\/g, '/')   // æ›¿æ¢ \ ä¸º /
                                .replace(/\/+/g, '/')  // æ›¿æ¢ // ä¸º /
                                .toLowerCase()         // è½¬å°å†™
                                .trim();               // å»ç©ºæ ¼
                    };

                    // 1. è·å–å½“å‰æ–‡ä»¶å¤¹çš„æ ‡å‡†åŒ–å›¾æ ‡è·¯å¾„
                    const currentPath = standardize(path);

                    // 2. éå†é…ç½®åˆ—è¡¨ï¼Œé€ä¸ªå¯¹æ¯”
                    const found = this.config.icons.find(i => {
                        const configPath = standardize(i.path);
                        return currentPath === configPath;
                    });
                    
                    return found ? found.name : '';
                }
            }
        }).mount('#app');
    </script>
</body>
</html>