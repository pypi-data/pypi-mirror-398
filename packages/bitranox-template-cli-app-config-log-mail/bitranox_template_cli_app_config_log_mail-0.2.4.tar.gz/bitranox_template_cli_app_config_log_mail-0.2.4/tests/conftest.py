"""Shared pytest fixtures for CLI and module-entry tests.

Centralizes test infrastructure following clean architecture principles:
- All shared fixtures live here
- Tests import fixtures implicitly via pytest's conftest discovery
- Fixtures use descriptive names that read as plain English
"""

from __future__ import annotations

import re
from collections.abc import Callable, Iterator
from dataclasses import fields
from pathlib import Path
from typing import Any

import pytest
from click.testing import CliRunner
from lib_layered_config import Config

import lib_cli_exit_tools


def _load_dotenv() -> None:
    """Load .env file when it exists for integration test configuration."""
    try:
        from dotenv import load_dotenv

        env_file = Path(__file__).parent.parent / ".env"
        if env_file.exists():
            load_dotenv(env_file)
    except ImportError:
        pass


_load_dotenv()

ANSI_ESCAPE_PATTERN = re.compile(r"\x1B\[[0-?]*[ -/]*[@-~]")
CONFIG_FIELDS: tuple[str, ...] = tuple(field.name for field in fields(type(lib_cli_exit_tools.config)))


def _remove_ansi_codes(text: str) -> str:
    """Return text stripped of ANSI escape sequences.

    Tests compare human-readable CLI output; stripping colour codes keeps
    assertions stable across environments.

    Args:
        text: Raw string captured from CLI output.

    Returns:
        The string without ANSI escape sequences.
    """
    return ANSI_ESCAPE_PATTERN.sub("", text)


def _snapshot_cli_config() -> dict[str, object]:
    """Capture every attribute from lib_cli_exit_tools.config.

    Tests toggle traceback behaviour; keeping a snapshot lets fixtures
    restore the configuration after each run.

    Returns:
        Mapping of attribute names to their original values.
    """
    return {name: getattr(lib_cli_exit_tools.config, name) for name in CONFIG_FIELDS}


def _restore_cli_config(snapshot: dict[str, object]) -> None:
    """Reapply the previously captured CLI configuration.

    Ensures global state looks untouched to subsequent tests.

    Args:
        snapshot: Mapping generated by _snapshot_cli_config.
    """
    for name, value in snapshot.items():
        setattr(lib_cli_exit_tools.config, name, value)


@pytest.fixture
def cli_runner() -> CliRunner:
    """Provide a fresh CliRunner per test.

    Click 8.x provides separate result.stdout and result.stderr attributes.
    Use result.stdout for clean output (e.g., JSON parsing) to avoid
    async log messages from stderr contaminating the output.
    """
    return CliRunner()


@pytest.fixture
def strip_ansi() -> Callable[[str], str]:
    """Return a helper that strips ANSI escape sequences from a string."""

    def _strip(value: str) -> str:
        return _remove_ansi_codes(value)

    return _strip


@pytest.fixture
def preserve_traceback_state() -> Iterator[None]:
    """Snapshot and restore the entire lib_cli_exit_tools configuration."""
    snapshot = _snapshot_cli_config()
    try:
        yield
    finally:
        _restore_cli_config(snapshot)


@pytest.fixture
def isolated_traceback_config(monkeypatch: pytest.MonkeyPatch) -> None:
    """Reset traceback flags to a known baseline before each test."""
    lib_cli_exit_tools.reset_config()
    monkeypatch.setattr(lib_cli_exit_tools.config, "traceback", False, raising=False)
    monkeypatch.setattr(lib_cli_exit_tools.config, "traceback_force_color", False, raising=False)


class MockConfig(Config):
    """Reusable mock configuration for testing CLI commands.

    Provides a minimal Config implementation that returns data from a dict
    without touching the filesystem.
    """

    def __init__(self, data: dict[str, Any]) -> None:
        object.__setattr__(self, "_mock_data", data)

    def as_dict(self) -> dict[str, Any]:
        return dict(object.__getattribute__(self, "_mock_data"))

    def to_json(self, *, indent: int | None = None) -> str:
        import json

        return json.dumps(object.__getattribute__(self, "_mock_data"), indent=indent)

    def get(self, key: str, default: Any = None) -> Any:
        return object.__getattribute__(self, "_mock_data").get(key, default)


@pytest.fixture
def mock_config_factory() -> Callable[[dict[str, Any]], MockConfig]:
    """Provide a factory that creates MockConfig instances with given data."""

    def _factory(data: dict[str, Any]) -> MockConfig:
        return MockConfig(data)

    return _factory


@pytest.fixture
def email_test_config() -> dict[str, Any]:
    """Provide standard email configuration for tests."""
    return {
        "email": {
            "smtp_hosts": ["smtp.test.com:587"],
            "from_address": "sender@test.com",
        }
    }


@pytest.fixture
def clear_config_cache() -> Iterator[None]:
    """Clear the get_config lru_cache before each test.

    Note: Only clears before, not after, to avoid errors when the function
    has been monkeypatched during the test (losing cache_clear method).
    """
    from bitranox_template_cli_app_config_log_mail import config as config_mod

    config_mod.get_config.cache_clear()
    yield
