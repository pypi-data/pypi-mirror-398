"""Common adapters for integrating popular FastHTML libraries with the worker system."""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../../nbs/extensions/adapters.ipynb.

# %% auto 0
__all__ = ['UnifiedPluginRegistryAdapter', 'ResourceManagerAdapter', 'SSEBroadcasterAdapter', 'create_standard_adapters']

# %% ../../nbs/extensions/adapters.ipynb 3
from typing import Dict, Any, Optional
from cjm_fasthtml_workers.extensions.protocols import (
    PluginRegistryProtocol,
    ResourceManagerProtocol,
    EventBroadcasterProtocol
)

# %% ../../nbs/extensions/adapters.ipynb 6
class UnifiedPluginRegistryAdapter:
    """Adapter for cjm-fasthtml-plugins UnifiedPluginRegistry."""

    def __init__(
        self,
        registry  # UnifiedPluginRegistry from cjm-fasthtml-plugins
    ):
        """Initialize adapter with UnifiedPluginRegistry instance."""
        self._registry = registry

    def get_plugins_by_category(self, category) -> list:
        """Get all plugins in a specific category."""
        return self._registry.get_plugins_by_category(category)

    def get_plugin(self, plugin_id: str):
        """Get a specific plugin by ID."""
        return self._registry.get_plugin(plugin_id)

    def load_plugin_config(self, plugin_id: str) -> Dict[str, Any]:
        """Load configuration for a plugin."""
        return self._registry.load_plugin_config(plugin_id)

# %% ../../nbs/extensions/adapters.ipynb 8
class ResourceManagerAdapter:
    """Adapter for cjm-fasthtml-resources ResourceManager."""

    def __init__(
        self,
        resource_manager  # ResourceManager from cjm-fasthtml-resources
    ):
        """Initialize adapter with ResourceManager instance."""
        self._resource_manager = resource_manager

    def register_worker(self, pid: int, worker_type: str) -> None:
        """Register a new worker process."""
        self._resource_manager.register_worker(pid, worker_type)

    def unregister_worker(self, pid: int) -> None:
        """Unregister a worker process."""
        self._resource_manager.unregister_worker(pid)

    def update_worker_state(
        self,
        pid: int,
        status: Optional[str] = None,
        job_id: Optional[str] = None,
        plugin_name: Optional[str] = None,
        plugin_id: Optional[str] = None,
        loaded_plugin_resource: Optional[str] = None,
        config: Optional[Dict[str, Any]] = None,
    ) -> None:
        """Update worker state information."""
        # Build update dict with only provided values
        updates = {}
        if status is not None:
            updates['status'] = status
        if job_id is not None:
            updates['job_id'] = job_id
        if plugin_name is not None:
            updates['plugin_name'] = plugin_name
        if plugin_id is not None:
            updates['plugin_id'] = plugin_id
        if loaded_plugin_resource is not None:
            updates['loaded_plugin_resource'] = loaded_plugin_resource
        if config is not None:
            updates['config'] = config

        # Call the underlying resource manager
        self._resource_manager.update_worker_state(pid, **updates)

    def check_gpu_availability(self):
        """Check GPU availability and identify conflicts."""
        return self._resource_manager.check_gpu_availability()

    def get_worker_by_pid(self, pid: int):
        """Get worker state by PID."""
        return self._resource_manager.get_worker_by_pid(pid)

# %% ../../nbs/extensions/adapters.ipynb 10
class SSEBroadcasterAdapter:
    """Adapter for cjm-fasthtml-sse SSEBroadcastManager."""

    def __init__(
        self,
        sse_manager  # SSEBroadcastManager from cjm-fasthtml-sse
    ):
        """Initialize adapter with SSE broadcast manager."""
        self._sse_manager = sse_manager

    async def broadcast(
        self,
        event_type: str,  # Event type identifier (e.g., 'transcription:started')
        data: Dict[str, Any]  # Event data payload
    ) -> None:
        """Broadcast an event to all connected SSE clients."""
        # Broadcast using the SSE manager
        # Note: SSEBroadcastManager.broadcast expects event_type and data
        await self._sse_manager.broadcast(event_type, data)

# %% ../../nbs/extensions/adapters.ipynb 12
def create_standard_adapters(
    plugin_registry=None,  # UnifiedPluginRegistry instance (optional)
    resource_manager=None,  # ResourceManager instance (optional)
    sse_manager=None  # SSEBroadcastManager instance (optional)
) -> tuple:  # (plugin_adapter, resource_adapter, sse_adapter)
    """Create standard adapters for common FastHTML libraries."""
    plugin_adapter = UnifiedPluginRegistryAdapter(plugin_registry) if plugin_registry else None
    resource_adapter = ResourceManagerAdapter(resource_manager) if resource_manager else None
    sse_adapter = SSEBroadcasterAdapter(sse_manager) if sse_manager else None
    
    return (plugin_adapter, resource_adapter, sse_adapter)
