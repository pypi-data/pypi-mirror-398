name: Daily Tests

on:
  schedule:
    # Run daily at 9:00 PM UTC
    - cron: '40 10 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  daily-test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        os: [ ubuntu-latest, windows-latest ]
        python-version: [ '3.10', '3.11', '3.12', '3.13' ]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Create virtual environment (Unix)
        if: runner.os != 'Windows'
        run: python -m venv venv

      - name: Install dependencies (Unix)
        if: runner.os != 'Windows'
        run: |
          venv/bin/pip install --upgrade pip
          venv/bin/pip install -e ".[dev]"

      - name: Run linter (Unix)
        if: runner.os != 'Windows'
        run: |
          venv/bin/python -m flake8 src/

      - name: Run tests (Unix)
        if: runner.os != 'Windows'
        run: |
          PDFDANCER_BASE_URL=https://api-staging.pdfdancer.com \
          PDFDANCER_TOKEN=42 \
          venv/bin/python -m pytest tests/ -v --maxfail=3

      - name: Build & Validate (Unix)
        if: runner.os != 'Windows'
        run: |
          venv/bin/python -m build
          venv/bin/python -m twine check dist/*

      - name: Create virtual environment (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: python -m venv venv

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          venv\Scripts\pip install --upgrade pip
          venv\Scripts\pip install -e ".[dev]"

      - name: Run linter (Windows)
        if: runner.os == 'Windows'
        run: |
          venv\Scripts\python -m flake8 src/

      - name: Run tests (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          set PDFDANCER_BASE_URL=https://api-staging.pdfdancer.com
          set PDFDANCER_TOKEN=42
          venv\Scripts\python -m pytest tests/ -v --maxfail=3

      - name: Build & Validate (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          venv\Scripts\python -m build
          venv\Scripts\python -m twine check dist/*

  notify-on-failure:
    needs: daily-test
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Daily Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `The daily test run has failed. Please check the workflow run for details.\n\n[Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})`;

            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'daily-test-failure'
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['daily-test-failure', 'automated']
              });
            }
