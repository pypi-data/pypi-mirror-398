# Development Log: 2025-12-11

## Summary

Today marks a massive milestone for Typedown. We have successfully evolved the project from a basic parser into a fully functional **Compiler Framework** capable of complex data validation, dependency resolution, global constraint checking, and artifact generation. We completed all major MVP pillars: **P0 (References)**, **P1 (Schema Validation)**, **P2 (Global Constraints)**, and **P3 (Build Artifacts)**.

## Key Decisions & Discussions

1.  **Multi-Language Documentation**: Decided to maintain mirrored `README.md`/`README_ZH.md` and `docs`/`docs_zh`.
2.  **Reinforced Evolution Semantics**: Explicitly defined `former` (linear) vs `derived_from` (branching) rules. Documented in `dev-docs/adr/0004-evolution-semantics.md`.
3.  **Refined Reference Mechanism**: Clarified `[[...]]` query behavior and ambiguity handling.
4.  **CLI/Daemon Architecture**: Adopted an **Embedded Workspace Library Model** (Git/Cargo-like).
5.  **AST Structure**: Defined core data structures. Documented in `dev-docs/adr/0003-ast-structure-and-caching.md`.
6.  **CLI Command Structure**: Formalized `lint` / `validate` / `build`. Documented in `dev-docs/adr/0005-cli-command-structure.md`.
7.  **Build Artifacts Strategy**: Decided on a **Self-Contained Bundle** (`dist/`) output. No in-place source modification. Documented in `dev-docs/adr/0006-build-artifacts-and-expansion.md`.
8.  **P2 Global Constraints Architecture**: Designed a **Spec/Rule System** where constraints are defined in `spec:` blocks (Markdown) and implemented in Python (`specs/`). Adopted **Selector Pattern** (`target: "entity:Monster"`) and **Contextual Severity** (`severity: { default: warning, release: error }`). Documented in `dev-docs/adr/0007-global-constraints-and-specs.md`.

## Implemented Features

### Core Compiler
*   **AST**: Added `SpecBlock` to support constraint definitions.
*   **Parser**: Implemented parsing for `spec:` code blocks.
*   **Resolver**: Implemented advanced Dependency Graph (Implicit + Explicit) and Topological Sorting.
*   **Evaluator (P0)**: Implemented Reference Resolution traversal.
*   **Validator (P1)**: Implemented Pydantic Data Validation.
*   **SpecRunner (P2)**: Implemented a Python-based constraint runner.
    *   Dynamic loading of check functions from `specs/`.
    *   Entity selection engine (`targets`).
    *   Contextual Severity handling via Tags.
    *   Standardized LSP-friendly error reporting.
*   **Workspace**: Orchestrated the complete pipeline: `Parse -> Resolve Dependencies -> Topo Sort -> (Merge -> Evaluate -> Validate) -> Global Specs`.

### CLI
*   **`td validate <path> [--tag T]`**: Runs the full analysis pipeline, including global specs filtered by tag.
*   **`td build <path> -o <dist> [-f]`**: Generates distribution artifacts (P3).
    *   Includes rigorous **Safety Checks** to prevent output path conflicts and system path deletion.
    *   Produces `data.json` (The "Giant Blob") and copies `content` and `assets`.
*   **`td debug parse`**: Observability tool.

## Testing & Validation

*   **P0/P1**: Verified Reference Resolution and Pydantic Validation on `rpg_campaign`.
*   **P3 (Build)**: Successfully generated `dist/` with correct JSON data and file structure. Verified safety checks block dangerous operations.
*   **P2 (Constraints)**: Created end-to-end test case in `use_cases/rpg_campaign/specs/`:
    *   `rule_monster_hp_positive` (Pass): Verified successful execution.
    *   `rule_item_lightweight` (Fail): Verified correct detection of `item_sword_iron` (Weight 2.0 > 1.5).
    *   **Output**: Verified standard diagnostic format: `Warning: [Rule] ... --> File:Line:Col`.

## Next Steps

*   **P4 (Lint)**: Implement the fast, static `lint` command for syntax-only checks.
*   **IDE Extension**: Prototype VS Code extension utilizing `td` CLI for diagnostics.
*   **Documentation Site**: Setup a documentation project using Typedown itself (dogfooding).
