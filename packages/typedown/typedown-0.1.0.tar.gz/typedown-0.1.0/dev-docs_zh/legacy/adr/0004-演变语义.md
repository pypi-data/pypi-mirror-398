# 0004. 演变语义

日期: 2025-12-11

## 状态

已接受

## 背景

Typedown 允许定义随时间演变 (`former`) 或派生自其他实体 (`derived_from`) 的实体。我们需要严格定义语义以避免歧义和“坏味道”。

## 决策

### 1. 不可变性与新 ID

**规则**: 任何状态变化 _必须_ 产生一个拥有新唯一 ID 的新实体。

- `former` 指向先前状态的 ID。
- 这确保了对历史状态的引用（例如 `[[Hero_v1]]`）保持有效且不可变。

### 2. 线性 vs. 分支

- **`former` (时间)**: 必须是严格 **线性** 的。分支（一个 ID 有多个 `former` 后继）被视为 **坏味道**。
  - 一度分叉: Info (提示)
  - 二度分叉: Warning (警告)
  - 三度及以上: Error (错误)
- **`derived_from` (类型)**: 自然是 **分支** 的（树状结构）。基类有多个变体是正常的。

### 3. 引用解析

- **隐式**: `[[ID]]`（无版本后缀）在编译时解析为 `former` 链条中的 **最新** 版本。
- **显式**: 如果需要，用户可以链接到特定版本。
- **查询**: 引用被视为查询 (`[[query]]`)，支持模糊匹配和验证。

## 后果

- 编译器必须实现对 `former` 分支深度的检查。
- 编译器需要一个“解析为最新”的 pass 来重写隐式引用。
- 用户需被迫采用有纪律的命名约定（例如 `_v1`, `_v2`），这提高了项目的可维护性。
