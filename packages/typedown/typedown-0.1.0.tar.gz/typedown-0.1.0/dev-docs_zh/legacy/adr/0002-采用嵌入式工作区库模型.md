# 0002. 采用嵌入式工作区库模型

日期: 2025-12-11

## 状态

已接受

## 背景

我们需要确定 Typedown 工具链 (`td`) 的运行时模型。主要选项包括：

1.  **客户端-守护进程模型 (类似 Docker)**: 一个持久化的后台进程 (`td-daemon`) 保持状态，配合一个轻量级的 CLI 客户端。
2.  **嵌入式工作区模型 (类似 Git/Cargo)**: CLI 将核心逻辑作为库导入。状态对于 CLI 运行是临时的，但对于 LSP 进程（同样导入该库）是持久的。

主要考量因素包括启动延迟、实现复杂度（IPC、进程管理）以及 LSP 中的“未保存缓冲区”同步问题。

## 决策

我们将采用 **嵌入式工作区模型** (基于库)。

- 我们将实现一个 `typedown.core.Workspace` 类来封装状态（AST、符号表、依赖图）。
- CLI (`td`) 将按需实例化 `Workspace` 来执行一次性任务。
- LSP 服务器 (`td lsp`) 将实例化一个长驻的 `Workspace` 来响应编辑器请求。
- 我们在 MVP 阶段明确拒绝守护进程模型，以避免系统级复杂度和磁盘与编辑器内存之间的同步问题。

## 后果

- **正面**: 实现更简单（无需 Socket IPC 代码）。LSP 集成符合标准（状态存在于 LSP 进程中）。
- **负面**: CLI 命令会有“冷启动”惩罚，因为需要重新解析项目。
- **缓解**: 我们将设计 `Workspace` 以使其性能足以应对中型项目，并保留在未来如果性能需求增加时将其包装在守护进程中的选项（因为逻辑已在库中解耦）。
