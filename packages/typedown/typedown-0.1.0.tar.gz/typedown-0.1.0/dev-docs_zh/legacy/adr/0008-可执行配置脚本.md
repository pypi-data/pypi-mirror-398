# 0008. 可执行配置脚本

日期: 2025-12-11

## 状态

已提议

## 背景

目前将 Pydantic 模型加载到 Typedown 上下文的机制依赖于 `config.td` Front Matter 中的 `imports` 字段。这种方法存在几个挑战：

1. **阻抗不匹配**: YAML 并非为表达复杂的模块导入逻辑而设计，导致语法笨拙或歧义（如 `from X import Y` 的字符串解析问题）。
2. **灵活性有限**: 难以在 YAML 中直接处理动态 `sys.path` 修改、条件导入、别名或其他高级 Python 导入场景。
3. **Monorepo 挑战**: 在多项目或 monorepo 设置中（例如 `use_cases/` 示例），多个子目录可能定义自己的 `models/` 包，如果包共享相同的基本名称（例如多个 `models` 包），由于命名空间冲突，全局 `sys.path` 注入会变得有问题。
4. **认知负担**: 熟悉 Python 导入系统的用户被迫学习一种专门的基于 YAML 的导入语法。

目标是提供一种更灵活、强大且符合 Python 习惯的方式来为给定的 Typedown 文档或目录定义“类上下文”，从而减少摩擦并支持复杂的项目结构。

## 决策

我们将在 `config.td` 文件（以及可能的其他 Markdown 文档）中引入“可执行配置脚本”的概念。这将是标准的 Python 代码块，Typedown CLI 将在解析和构建上下文阶段执行这些代码块。

### 机制

1. **Python 代码块**: `config.td` 文件可以包含带有 `config:python` 信息字符串的标准 Markdown 围栏代码块。这些块的内容将被视为可执行的 Python 代码。

   ````markdown
   # config.td

   ---

   ---

   ```config:python
   # Python 设置脚本示例
   import sys
   from pathlib import Path

   # 为此上下文动态添加特定路径到 PYTHONPATH
   sys.path.insert(0, str(Path(__file__).parent.parent / "my_local_lib"))

   # 直接导入 Pydantic 模型。这些将变为 Typedown 上下文中可用。
   from my_app.models import User, Order
   from another_app.shared_models import Product as InventoryProduct

   # Typedown 将（隐式或显式地）收集这些定义的类。
   ```
   ````

2. **级联上下文执行**:

   - 在处理文档 `docs/A/B/file.md` 时，Typedown CLI 将识别其祖先路径中的所有相关 `config.td` 文件（例如，`docs/`，`docs/A/`，`docs/A/B/` 中的 `config.td`）。
   - 这些 Python 代码块将按顺序执行，从最外层的 `config.td` 开始向内推进。
   - 每一步执行都会增强/修改 Python 执行环境（`globals()` 和 `locals()`），有效地形成级联上下文。
   - 父 `config.td` 的环境将被子 `config.td` 脚本继承。

3. **类上下文构建**: 在为给定文档范围对所有相关 Python 脚本执行完毕后，Typedown 系统将检查最终的执行环境。凡是直接在此环境中发现的 `pydantic.BaseModel` 子类（例如上例中的 `User`, `Order`, `InventoryProduct`），都将自动注册到该文档及其子文档的“类上下文”中。这消除了对显式 `typedown.api.register` 函数来注册 Pydantic 模型的需求。

### 影响

- **`Parser`**: 必须增强以从 `config.td` 文件中识别并提取 Python 围栏代码块。
- **`Workspace`/`Loader`**:
  - `Loader` 的 `load_imports` 方法（处理 YAML `imports`）将被弃用并最终移除。
  - 将引入一个新的“上下文管理器”或“作用域构建器”组件。该组件将负责：
    - 识别文档祖先路径中的 `config.td` 文件。
    - 以受控、级联的方式执行其 Python 代码块。
    - 检查执行环境以发现并注册 Pydantic `BaseModel` 子类。
    - 每个 `Document`（或更广泛地，每个目录作用域）将关联其自己派生的类上下文。
- **`Validator`**: 将查询与正在验证的文档关联的类上下文，而不是全局 `ClassRegistry`。
- **`main.py` & CLI**: `validate` 命令的管道将集成新的上下文构建阶段。
- **用户体验**: 对 Python 开发者来说大大简化，因为他们使用熟悉的 Python 语法进行导入和设置。

## 后果

- **增加灵活性**: 用户可以利用 Python 的全部能力来设置他们的 Typedown 环境。
- **改进 Monorepo 支持**: 每个子项目可以定义自己的 `sys.path` 调整和导入，而没有全局冲突。
- **安全考虑**: 执行任意用户提供的 Python 代码需要信任边界。这将作为构建工具行为进行记录（类似于 `setup.py`），假设开发者信任代码库。
- **弃用**: `config.td` 中的 YAML `imports` 字段将被弃用。
- **重构工作**: 此更改需要对 `Loader` 和 `Workspace` 组件进行重大重构。
