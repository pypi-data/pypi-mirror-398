# 0003. AST 结构与缓存策略

日期: 2025-12-11

## 状态

已接受

## 背景

我们需要一个健壮的数据结构来表示解析后的 Typedown 项目，既要支持 Markdown 内容，也要支持特定的图数据（关系、查询）。我们还需要决定缓存策略以处理项目通过增长带来的性能问题。

## 决策

### 1. 混合 AST

我们在 `typedown.core.ast` 中定义了一个自定义 AST，结合了：

- **文档结构**: `Document` 节点，包含 `config` 和原始内容。
- **数据节点**: `EntityBlock`，表示从代码块中提取的结构化数据。
- **图节点**: `Reference` 节点，表示 `[[query]]` 和关系（`former`，`derived_from`）。

### 2. 无持久化缓存 (MVP)

对于 MVP，我们将 **不** 实现持久化缓存 (SQLite/Pickle)。

- 编译器每次运行都会执行全量解析。
- LSP 将在内存中维护状态。

### 3. 为增量化做准备

为了支持未来的增量解析，我们在 `Document` 节点中添加了 `content_hash` 字段。`Parser` 接口将被设计为接受此哈希值，允许我们在未来的迭代中插入缓存层（例如，“如果哈希匹配数据库，则跳过解析”）而无需更改核心 AST。

## 后果

- **正面**: 初始开发更快且不易出错（无缓存失效 bug）。
- **负面**: 在只有在非常大的项目上性能可能在一开始不是最优的。
- **未来工作**: 当 AST 稳定后，实现基于 SQLite 的缓存层。
