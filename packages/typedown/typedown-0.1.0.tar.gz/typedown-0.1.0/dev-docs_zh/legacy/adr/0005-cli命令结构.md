# 0005. CLI 命令结构

日期: 2025-12-11

## 状态

已接受

## 背景

随着 Typedown 从一个简单的解析器演变为一个正式的编译器/构建工具，我们需要一个清晰直观的命令行界面 (CLI) 结构。
最初，我们引入了 `td check` 来运行分析流程。然而，随着我们需要区分不同的处理阶段（语法 vs 语义 vs 产物生成），单个 `check` 命令变得模棱两可。

我们需要定义一组标准的动词，符合用户在“配置即代码”和“文档即代码”领域的预期（类似于 Terraform, Cargo, npm）。

## 决策

我们将采用三层命令结构：**Lint (清理)**, **Validate (验证)**, 和 **Build (构建)**。

### 1. `lint` (静态分析)

- **范围**: 单个文件或独立文件的扫描。
- **操作**:
  - 检查 Front Matter 和 `entity:` 块中的 YAML 语法是否有效。
  - 检查适合 Typedown 的 Markdown 语法是否有效。
  - **不** 加载 Python 模块或解析跨文件引用。
- **速度**: 快 (毫秒级)。适合在 IDE 中持续运行或作为 pre-commit 钩子。
- **输出**: 语法错误，格式警告。

### 2. `validate` (语义分析)

- **范围**: 项目级。
- **操作**:
  - 加载所有配置和 Python 模型 (`models/`)。
  - 构建依赖图。
  - 解析引用 (`[[...]]`)。
  - 根据 Pydantic Schema 验证数据 (**类型检查**)。
  - 检查业务约束 (逻辑检查)。
- **速度**: 中等 (秒级)。适合 CI/CD 管道或“保存并检查”循环。
- **输出**: 语义错误（断链引用，类型不匹配），逻辑违规。
- **注意**: 这取代了之前的 `check` 命令。

### 3. `build` (产物生成)

- **范围**: 项目级。
- **定义**: `build` = `validate` + `serialize` (序列化)。
- **操作**:
  - **步骤 1**: 运行 `validate`。**如果失败，中止。不生成产物。**
  - **步骤 2**: 物化 (Materialize) 最终的“解析数据”。
  - **步骤 3**: 将数据序列化为输出格式（JSON, 递归 JSON, HTML 文档等）。
- **速度**: 慢。适合部署或发布。
- **输出**: `dist/` 或等效目录下的文件。
- **错误处理**: 必须使用标准的“诊断风格”报告（源文件 + 行号 + 上下文），而不是原始堆栈跟踪。

## 后果

1.  **重命名**: `td check` 将被重命名为 `td validate`。
2.  **实现**: 我们需要重构 `typedown/commands/check.py` 为 `validate.py`。
3.  **未来工作**: `lint` 和 `build` 命令目前是占位符/概念，需要单独实现。`validate` 是当前的优先级。
