# 0006. 构建产物与展开

日期: 2025-12-11

## 状态

已接受

## 背景

我们在 ADR-0005 中定义了 `build` 命令，但我们需要明确它到底生成 _什么_。出现了两个关键问题：

1. `build` 是否应该直接生成 HTML？
2. `build` 应该输出“单个 JSON Blob”还是“自包含的 Bundle”？
3. 我们是否应该支持“原地展开” (In-place Expansion)（将解析后的值写回源 Markdown）以便于审查？

## 决策

### 1. 不生成 HTML

Typedown 将 **不** 作为静态站点生成器 (SSG) 运行。

- **原因**: 有更好的工具用于渲染 (VitePress, Hugo, Obsidian)。Typedown 专注于 **数据编译**。
- **替代方案**: 用户应该在其首选的前端或游戏引擎中消费 Typedown 的数据产物。

### 2. 产物格式：自包含 Bundle

`build` 命令将在 `dist/` 目录（或用户指定的输出）中生成一个 **分发包 (Distribution Package)**。此包设计为下游消费者（游戏引擎、AI Agent、静态站点）自给自足。

**结构:**

```text
dist/
├── data.json           # 完整的已解析 AST (机器可读)
├── assets/             # 收集的图片/媒体资源
├── content/            # 处理后的 Markdown 文件 (机器/人类可读)
└── models/             # (可选) Schema 定义
```

### 3. 展开策略 (脱糖)

我们将 **不** 修改 `src/` 目录中的源 Markdown 文件。

- **源完整性**: 源文件必须保持“干净”并使用引用 (`[[...]]`) 以维护单一事实来源 (Single Source of Truth)。
- **审查体验**:
  - **人工审查**: 应由 **IDE 扩展 (LSP)** 处理，使用 Hover (悬停)、Inlay Hints (镶嵌提示) 或 Code Lens 动态显示解析后的值。
  - **AI/机器消费**: `dist/content/` 目录可能包含“已展开的 Markdown”，其中引用被替换为其解析值，使 RAG 系统或简单阅读器无需解析逻辑即可消费。

## 后果

1.  我们需要实现 `build` 命令来创建上述描述的目录结构。
2.  我们需要确保 `data.json` 包含所有实体的 `resolved_data`。
3.  我们将明确将“编辑器内预览”功能限定在 VS Code 扩展路线图中，保持 CLI 专注于批处理。
