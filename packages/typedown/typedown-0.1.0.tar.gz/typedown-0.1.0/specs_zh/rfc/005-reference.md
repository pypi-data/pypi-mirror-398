# 实体引用与链接

Typedown 通过 `[[]]` 语法支持强大的实体引用功能。引用在编译器流水线的 **校验阶段 (Stage 3)** 进行解析，通过拓扑排序确保所有依赖项都已完成物化。

## 1. 引用模式

根据查询结构的组合，引用会解析为不同类型的数据：

### 1.1 符号链接 (`[[ID]]`)

- **行为**：返回目标符号的 **ID 字符串**。
- **用途**：用于建立关联/指针，而不重复数据。
- **示例**：`owner: [[Alice]]` 解析为 `owner: "Alice"`。

### 1.2 数值查找 (`[[ID.path]]`)

- **行为**：导航到目标的内部数据并返回 **具体数值**。
- **索引**：支持通过 `[n]` 进行列表索引。
- **示例**：
  - `[[Project.version]]` -> `"1.0.0"`
  - `[[Farm.apples[0].weight]]` -> `0.5`

### 1.3 数据内联 (`[[ID.path.*]]`)

- **行为**：将目标对象（或子对象）序列化为 **完整字典/对象**。
- **示例**：`config: [[GlobalConfig.*]]` 会深度拷贝整个配置对象。

## 2. 引用解析机制

### 2.1 基于 ID 的精确匹配

引用必须匹配全局符号表中唯一的 `id`。ID 可以定义在：

- Entity 块的 Header 或 YAML 主体中。
- Model 块的 Header (`model id=X`)。
- Spec 块的 Header (`spec id=Y`)。

### 2.2 编译流水线

1. **扫描 (Stage 1)**：收集所有符号并构建初始符号表。
2. **链接 (Stage 2)**：解析类型并执行模型。
3. **校验 (Stage 3)**：
   - 构建所有 `[[ ]]` 引用的 **依赖图**。
   - 执行 **拓扑排序**。
   - 检测并报告 **循环依赖**。
   - 按顺序物化数据。

## 3. 工具链支持

LSP (Language Server Protocol) 实现提供：

- **转到定义**：从 `[[ID]]` 跳转到源头代码块。
- **查找所有引用**：查看符号在何处被使用。
- **自动补全**：在键入 `[[` 时从符号表建议 ID。
