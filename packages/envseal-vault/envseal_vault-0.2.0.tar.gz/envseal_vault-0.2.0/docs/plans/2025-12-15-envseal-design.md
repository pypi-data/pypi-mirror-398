# EnvSeal Design Document

> NOTE: This is a historical design document. It may not reflect the current CLI behavior, package name, or implemented commands.

**Date:** 2025-12-15
**Status:** Approved
**Target User:** Individual developers managing multiple projects

---

## Overview

EnvSeal is a CLI tool that scans `.env*` files across multiple repositories, normalizes them, and syncs them into a centralized Git-backed vault as SOPS-encrypted dotenv files, providing safe key-only diffs and versioned rollback.

---

## 1. Architecture

### Dual Repository Architecture

```
envseal/                    # Open-source tool repository
â”œâ”€â”€ pyproject.toml         # Python project configuration
â”œâ”€â”€ envseal/               # Core code
â”‚   â”œâ”€â”€ cli.py            # Typer CLI entry point
â”‚   â”œâ”€â”€ scanner.py        # Scan repos and .env*
â”‚   â”œâ”€â”€ vault.py          # Vault path mapping
â”‚   â””â”€â”€ sops.py           # SOPS encryption/decryption
â””â”€â”€ tests/

secrets-vault/              # Private encrypted repository
â”œâ”€â”€ .sops.yaml             # SOPS encryption rules
â”œâ”€â”€ secrets/               # Encrypted .env files
â”‚   â”œâ”€â”€ repo1/
â”‚   â”‚   â”œâ”€â”€ dev.env       # SOPS encrypted
â”‚   â”‚   â””â”€â”€ prod.env
â”‚   â””â”€â”€ repo2/
â”‚       â””â”€â”€ local.env
â””â”€â”€ templates/             # .env.example templates (optional)
```

### Key Design Principles

- **Stateless CLI**: envseal stores no secrets itself
- **Git-backed versioning**: secrets-vault provides version control and rollback
- **SOPS encryption**: ensures content is safe even if vault is leaked
- **Local operations**: all operations run locally, remote push controlled by user

---

## 2. CLI Commands

### Core Commands

```bash
# Initialize (first-time use)
envseal init
  â†’ Auto-generate age key (if not exists)
  â†’ Scan current directory for Git repos
  â†’ Interactive selection of repos to manage
  â†’ Generate ~/.config/envseal/config.yaml
  â†’ Create .sops.yaml in secrets-vault
  â†’ Auto-execute first push

# Push to vault
envseal push                    # Push all configured repos
envseal push repo1 repo2        # Push specific repos only
envseal push --env prod         # Push only prod environment

# View status
envseal status                  # Show change status for all repos
envseal diff repo1 --env prod   # Key-only diff (no values shown)

# Pull from vault
envseal pull repo1 --env prod           # Decrypt to temp dir, show path
envseal pull repo1 --env prod --replace # Overwrite local .env.prod file
envseal pull repo1 --env prod --stdout  # Output directly to stdout

# Management commands
envseal list                    # List all managed repos
envseal add /path/to/repo       # Add new repo
envseal remove repo1            # Remove repo from management
```

### MVP Command Priority

1. `init` - Must have
2. `push` - Must have
3. `status` - Must have
4. `pull` - Important
5. `diff` / `list` / `add` / `remove` - Can be added later

---

## 3. Configuration Design

### Global Configuration: `~/.config/envseal/config.yaml`

```yaml
# Vault repository path
vault_path: /Users/haorangong/Github/secrets-vault

# Managed repos (auto-generated during init)
repos:
  - name: project1
    path: /Users/haorangong/Github/project1
  - name: my-api
    path: /Users/haorangong/work/my-api
  - name: client-app
    path: /Users/haorangong/clients/acme/app

# .env file mapping rules
env_mapping:
  ".env": "local"
  ".env.dev": "dev"
  ".env.development": "dev"
  ".env.staging": "staging"
  ".env.prod": "prod"
  ".env.production": "prod"

# Scan rules
scan:
  include_patterns:
    - ".env"
    - ".env.*"
  exclude_patterns:
    - ".env.example"
    - ".env.sample"
  ignore_dirs:
    - ".git"
    - "node_modules"
    - "venv"
    - ".venv"
```

### Vault Configuration: `secrets-vault/.sops.yaml`

```yaml
creation_rules:
  - path_regex: ^secrets/.*\.env$
    input_type: dotenv
    age: age1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### Configuration Key Points

- Global config auto-generated by `init`, can be manually edited
- `env_mapping` supports customization (e.g., `.env.test` â†’ `test`)
- Repo `name` used for vault path (`secrets/<name>/<env>.env`)
- SOPS config lives in vault repo, versioned with vault

---

## 4. Core Data Flow

### `envseal push` Flow

```
1. Scan Phase
   â”œâ”€ Read config.yaml to get repos list
   â”œâ”€ Iterate each repo, find .env* files
   â”œâ”€ Apply env_mapping to determine environment type
   â””â”€ Generate metadata: {repo, env, path, mtime, hash}

2. Normalization Phase
   â”œâ”€ Parse using python-dotenv into key-value dict
   â”œâ”€ Sort keys alphabetically
   â”œâ”€ Remove empty lines and comments (keep clean)
   â””â”€ Normalize quote format (only quote if spaces/special chars)

3. Vault Write Phase
   â”œâ”€ Map path: secrets/<repo>/<env>.env
   â”œâ”€ Write to temp file first (plaintext)
   â””â”€ Detect changes (compare with existing decrypted content)

4. Encryption Phase
   â”œâ”€ Call: sops -e --input-type dotenv temp.env
   â”œâ”€ Write to: secrets/<repo>/<env>.env (encrypted)
   â””â”€ Delete temp file

5. Git Prompt Phase
   â””â”€ Prompt user to cd to vault and git commit/push
```

### `envseal pull` Flow

```
1. Locate file: secrets/<repo>/<env>.env
2. Decrypt: sops -d secrets/<repo>/<env>.env
3. Based on parameters:
   â”œâ”€ Default: Write to /tmp/envseal-XXXXX/<env>.env (show path)
   â”œâ”€ --replace: Write to original repo's .env.<env> file
   â””â”€ --stdout: Output directly to console
4. Temp files auto-cleanup on process exit
```

---

## 5. Security & Safety Measures

### Key Security

```
1. Age Key Storage
   â”œâ”€ Location: ~/Library/Application Support/sops/age/keys.txt
   â”œâ”€ Permissions: Auto-set to 600 (owner read/write only)
   â””â”€ Backup reminder: init prompts user to backup key (for multi-device sync)

2. Plaintext Temp Files
   â”œâ”€ Only briefly exist in memory or /tmp
   â”œâ”€ Use tempfile.mkdtemp() for random directory
   â””â”€ Auto-cleanup via atexit on process exit

3. Environment Variable Injection (optional feature)
   â””â”€ envseal run repo1 --env prod -- command
       Decrypt to memory â†’ Set env vars â†’ Execute command â†’ Cleanup
```

### Anti-Footgun Measures

```
1. Prevent Plaintext Push
   â”œâ”€ Vault repo .gitignore includes *.env.tmp
   â”œâ”€ push command checks: ensure only SOPS-encrypted files written
   â””â”€ Recommend enabling GitHub Secret Scanning on vault repo

2. Prevent Local File Overwrite
   â”œâ”€ pull --replace backs up original file to .env.backup first
   â””â”€ Display clear warning message

3. Vault Integrity Checks
   â”œâ”€ Check .sops.yaml exists before push
   â”œâ”€ Verify age key configured correctly
   â””â”€ Test encrypt/decrypt on sample file to validate config
```

### Error Handling

```
1. Friendly Error Messages
   â”œâ”€ Age key missing â†’ Prompt to run envseal init
   â”œâ”€ sops not installed â†’ Show install command
   â””â”€ Vault path doesn't exist â†’ Prompt to configure or create

2. Partial Failure Handling
   â”œâ”€ When pushing multiple repos, one failure doesn't affect others
   â””â”€ Show summary of success/failure list at end

3. Rollback Mechanism
   â””â”€ Rely on Git: vault is Git repo, any issue can git revert
```

---

## 6. Technology Stack

### Core Dependencies

```toml
[project]
name = "envseal"
version = "0.1.0"
dependencies = [
    "typer[all]>=0.9.0",      # CLI framework (includes rich for beautiful output)
    "python-dotenv>=1.0.0",    # .env parsing
    "pyyaml>=6.0",             # YAML config
    "click>=8.0",              # Typer's underlying dependency
]

[project.scripts]
envseal = "envseal.cli:app"    # Global command entry point

[build-system]
requires = ["hatchling"]        # Modern Python packaging tool
build-backend = "hatchling.build"
```

### Project Structure

```
envseal/
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ README.md
â”œâ”€â”€ LICENSE                    # Apache-2.0
â”œâ”€â”€ SECURITY.md               # Security policy
â”œâ”€â”€ envseal/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ cli.py                # Typer command entry
â”‚   â”œâ”€â”€ config.py             # Config read/write/validation
â”‚   â”œâ”€â”€ scanner.py            # Scan repos and .env*
â”‚   â”œâ”€â”€ dotenvio.py          # Parse/normalize/write .env
â”‚   â”œâ”€â”€ vault.py             # Vault path mapping and management
â”‚   â”œâ”€â”€ sops.py              # SOPS CLI wrapper
â”‚   â”œâ”€â”€ crypto.py            # Age key generation and management
â”‚   â”œâ”€â”€ diffing.py           # Key-only diff/status
â”‚   â””â”€â”€ utils.py             # Common utilities
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py          # pytest fixtures
â”‚   â”œâ”€â”€ test_scanner.py
â”‚   â”œâ”€â”€ test_dotenvio.py
â”‚   â””â”€â”€ test_integration.py
â””â”€â”€ docs/
    â””â”€â”€ plans/               # Design documents
```

### Why Not Use SOPS Python Library

- SOPS official team primarily maintains Go CLI, Python bindings incomplete
- Calling `sops` CLI directly is more stable and feature-complete
- Users typically already have sops installed (Homebrew/apt)

---

## 7. User Experience

### `envseal init` Interactive Flow

```bash
$ envseal init

ğŸ” Scanning for Git repositories...
Found 5 repositories:
  [1] project1 (/Users/you/Github/project1)
  [2] my-api (/Users/you/work/my-api)
  [3] client-app (/Users/you/clients/acme/app)
  [4] test-repo (/Users/you/test/test-repo)
  [5] old-project (/Users/you/archive/old-project)

Select repositories to manage (comma-separated, e.g., 1,2,3): 1,2,3

ğŸ” Checking age encryption key...
No age key found. Generating new key...
âœ… Age key created: ~/Library/Application Support/sops/age/keys.txt

âš ï¸  IMPORTANT: Back up this key! You'll need it on other devices.
Public key: age1abc123...

ğŸ“ Where is your secrets-vault repository?
Path [/Users/you/Github/secrets-vault]:

âœ… Configuration saved to ~/.config/envseal/config.yaml
âœ… Created .sops.yaml in secrets-vault

ğŸ”„ Pushing initial secrets to vault...
  âœ“ project1: dev.env, prod.env
  âœ“ my-api: local.env, prod.env
  âœ“ client-app: dev.env, staging.env, prod.env

ğŸ“¦ Next steps:
  1. cd /Users/you/Github/secrets-vault
  2. git add .
  3. git commit -m "Initial secrets import"
  4. git push
```

### `envseal status` Output

```bash
$ envseal status

ğŸ“Š Secrets Status:

project1
  âœ“ dev.env       - up to date
  âš  prod.env      - 3 keys changed

my-api
  + local.env     - new file (not in vault)
  âœ“ prod.env      - up to date

Use 'envseal diff <repo>' to see details.
```

### `envseal diff` Output (Key-Only)

```bash
$ envseal diff project1 --env prod

ğŸ“ Changes in project1/prod.env:

+ ADDED:
  - NEW_API_KEY
  - FEATURE_FLAG_X
  - REDIS_HOST

~ MODIFIED:
  - DATABASE_URL
  - LOG_LEVEL

- REMOVED:
  - OLD_SERVICE_URL

Use 'envseal push project1 --env prod' to sync.
```

---

## 8. Testing Strategy

### Test Layers

```
1. Unit Tests (pytest)
   â”œâ”€ test_scanner.py
   â”‚   â”œâ”€ Test Git repo identification
   â”‚   â”œâ”€ Test .env* file discovery
   â”‚   â””â”€ Test ignore_dirs filtering
   â”‚
   â”œâ”€ test_dotenvio.py
   â”‚   â”œâ”€ Test .env parsing (various formats)
   â”‚   â”œâ”€ Test normalization output
   â”‚   â””â”€ Test quote handling edge cases
   â”‚
   â””â”€ test_diffing.py
       â”œâ”€ Test key-only diff logic
       â””â”€ Test status generation

2. Integration Tests
   â”œâ”€ test_integration.py
   â”‚   â”œâ”€ Full init â†’ push â†’ diff â†’ pull flow
   â”‚   â”œâ”€ Use real SOPS encrypt/decrypt
   â”‚   â””â”€ Use temporary Git repos and vault
   â”‚
   â””â”€ Fixtures (conftest.py)
       â”œâ”€ Create temp repos (with .env files)
       â”œâ”€ Create temp vault
       â””â”€ Generate test age keys

3. CLI Tests
   â””â”€ Use Typer's CliRunner to test command-line interactions
```

### Test Data Safety

```python
# Never use real secrets in tests
SAFE_TEST_ENV = """
DATABASE_URL=postgres://testuser:testpass@localhost/testdb
API_KEY=test_key_12345
DEBUG=true
"""

# Each test uses independent temporary keys
@pytest.fixture
def temp_age_key():
    key = generate_test_age_key()
    yield key
    cleanup(key)
```

### MVP Test Priority

1. **Critical path**: init â†’ scan â†’ push â†’ status (must have integration tests)
2. **SOPS integration**: encryption/decryption correctness (must test)
3. **Edge cases**: empty .env, special characters, multiline values (important)
4. **Error handling**: missing dependencies, permission issues (can add later)

---

## 9. Installation & Distribution

### Installation Method

**Global installation via pipx (recommended):**

```bash
# Install
pipx install envseal

# Upgrade
pipx upgrade envseal

# Uninstall
pipx uninstall envseal
```

### Prerequisites

- Python 3.9+
- SOPS CLI (`brew install sops` on macOS)
- Git

### First-Time Setup

```bash
# 1. Install envseal
pipx install envseal

# 2. Initialize
cd ~/your-projects-parent-dir
envseal init

# 3. Push to vault and commit
cd ~/Github/secrets-vault
git add .
git commit -m "Initial secrets import"
git push
```

---

## 10. Future Enhancements (Post-MVP)

### Potential Features

1. **Multi-device key sync helper**: Guide users through syncing age keys
2. **Template generation**: `envseal template <repo>` generates `.env.example`
3. **Env var injection**: `envseal run <repo> --env prod -- command`
4. **Multiple encryption backends**: Support PGP, KMS alongside age
5. **Team collaboration**: Support multiple age keys in `.sops.yaml`
6. **CI/CD integration examples**: GitHub Actions, GitLab CI templates
7. **Git hooks**: Auto-remind to push after local .env changes
8. **Web UI**: Optional web interface for viewing/comparing secrets

### Non-Goals (Out of Scope)

- **Direct secret injection to cloud platforms**: Use platform-specific tools
- **Secret rotation automation**: Complex, security-sensitive, better as separate tool
- **Access control/permissions**: Use Git branch protection instead
- **Secret scanning in code**: Use dedicated tools like TruffleHog

---

## 11. Success Criteria

### MVP Success Metrics

- [ ] User can run `envseal init` and have it "just work"
- [ ] Secrets are correctly encrypted with SOPS
- [ ] `push` and `pull` operations work reliably
- [ ] Key-only diffs prevent accidental value exposure
- [ ] Clear error messages guide users when things go wrong

### Long-Term Goals

- Become the go-to tool for personal .env management
- Clean, well-documented codebase that welcomes contributors
- Strong security reputation in the community
- Minimal maintenance burden (stable, well-tested)

---

## Appendix: Design Decisions

### Why Git-Backed Vault?

- **Version control**: Track changes over time, see who changed what
- **Rollback**: Easy to revert mistakes with `git revert`
- **Multi-device sync**: Git remote handles synchronization
- **Familiar workflow**: Developers already know Git

### Why SOPS?

- **Industry standard**: Used by major organizations
- **Flexible backends**: Supports age, PGP, KMS, etc.
- **Partial encryption**: Can encrypt only values, not keys
- **Git-friendly**: Encrypted files diff cleanly

### Why Not Use a Secrets Manager Service?

- **Privacy**: Some users don't want secrets in cloud services
- **Cost**: Free for personal use
- **Portability**: Git repo can move anywhere
- **Offline**: Works without internet connection

### Why Python + Typer?

- **Rich ecosystem**: Excellent libraries for CLI, YAML, dotenv
- **Beautiful output**: Typer + Rich for great UX
- **Easy distribution**: pipx makes installation trivial
- **Maintainability**: Readable, well-supported language
