"""
Report Generator Module - Multi-format reporting
Supports JSON, HTML, Markdown, and terminal output
"""

import json
from datetime import datetime
from pathlib import Path
from typing import Dict, Any, Optional
from jinja2 import Template

from shinigami.utils.logger import get_logger
from shinigami.utils.ascii_art import Colors

logger = get_logger("Reporter")


class ReportGenerator:
    """Generate reports in multiple formats"""
    
    HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHINIGAMI-EYE Report - {{ target }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            color: #00d9ff;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(0,217,255,0.5);
        }
        .subtitle {
            text-align: center;
            color: #ff006e;
            margin-bottom: 30px;
            font-size: 1.2em;
        }
        .meta {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #00d9ff;
        }
        .section {
            margin: 30px 0;
            background: rgba(255,255,255,0.03);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(0,217,255,0.2);
        }
        h2 {
            color: #ff006e;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255,0,110,0.3);
        }
        h3 {
            color: #00d9ff;
            margin: 15px 0 10px 0;
        }
        .record {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid #8b5cf6;
        }
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            margin: 3px;
        }
        .badge-success { background: #10b981; color: white; }
        .badge-warning { background: #f59e0b; color: white; }
        .badge-danger { background: #ef4444; color: white; }
        .badge-info { background: #3b82f6; color: white; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th {
            background: rgba(0,217,255,0.2);
            color: #00d9ff;
        }
        tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: #888;
        }
        code {
            background: rgba(0,0,0,0.5);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #00d9ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Á•ûÊ≠ªÁúº SHINIGAMI-EYE</h1>
        <div class="subtitle">Security Reconnaissance Report</div>
        
        <div class="meta">
            <strong>Target:</strong> <code>{{ target }}</code><br>
            <strong>Scan Date:</strong> {{ timestamp }}<br>
            <strong>Report Type:</strong> {{ report_type }}
        </div>
        
        {{ content }}
        
        <div class="footer">
            Generated by SHINIGAMI-EYE v1.0.0 | Educational Use Only
        </div>
    </div>
</body>
</html>
"""
    
    def __init__(self, output_dir: str = "reports"):
        """
        Initialize report generator
        
        Args:
            output_dir: Directory to save reports
        """
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(parents=True, exist_ok=True)
    
    def generate_json(self, data: Dict, filename: str) -> str:
        """
        Generate JSON report
        
        Args:
            data: Report data
            filename: Output filename
            
        Returns:
            Path to generated report
        """
        filepath = self.output_dir / filename
        
        with open(filepath, 'w') as f:
            json.dump(data, f, indent=2, default=str)
        
        logger.success(f"JSON report saved to {filepath}")
        return str(filepath)
    
    def generate_markdown(self, data: Dict, filename: str) -> str:
        """
        Generate Markdown report
        
        Args:
            data: Report data
            filename: Output filename
            
        Returns:
            Path to generated report
        """
        filepath = self.output_dir / filename
        
        md_content = f"""# SHINIGAMI-EYE Security Report

## Target Information
- **Target**: {data.get('target', 'N/A')}
- **Timestamp**: {data.get('timestamp', datetime.now().isoformat())}
- **Report Type**: {data.get('report_type', 'General')}

---

"""
        
        # Add scan results
        if 'port_scan' in data:
            md_content += self._format_port_scan_md(data['port_scan'])
        
        if 'web_recon' in data:
            md_content += self._format_web_recon_md(data['web_recon'])
        
        if 'dns_enum' in data:
            md_content += self._format_dns_enum_md(data['dns_enum'])
        
        if 'ssl_analysis' in data:
            md_content += self._format_ssl_analysis_md(data['ssl_analysis'])
        
        md_content += "\n---\n*Generated by SHINIGAMI-EYE v1.0.0*\n"
        
        with open(filepath, 'w') as f:
            f.write(md_content)
        
        logger.success(f"Markdown report saved to {filepath}")
        return str(filepath)
    
    def generate_html(self, data: Dict, filename: str) -> str:
        """
        Generate HTML report
        
        Args:
            data: Report data
            filename: Output filename
            
        Returns:
            Path to generated report
        """
        filepath = self.output_dir / filename
        
        # Build content
        content = ""
        
        if 'port_scan' in data:
            content += self._format_port_scan_html(data['port_scan'])
        
        if 'web_recon' in data:
            content += self._format_web_recon_html(data['web_recon'])
        
        if 'dns_enum' in data:
            content += self._format_dns_enum_html(data['dns_enum'])
        
        if 'ssl_analysis' in data:
            content += self._format_ssl_analysis_html(data['ssl_analysis'])
        
        # Render template
        template = Template(self.HTML_TEMPLATE)
        html = template.render(
            target=data.get('target', 'N/A'),
            timestamp=data.get('timestamp', datetime.now().isoformat()),
            report_type=data.get('report_type', 'General'),
            content=content
        )
        
        with open(filepath, 'w') as f:
            f.write(html)
        
        logger.success(f"HTML report saved to {filepath}")
        return str(filepath)
    
    def _format_port_scan_md(self, scan: Dict) -> str:
        """Format port scan for Markdown"""
        md = "## Port Scan Results\n\n"
        md += f"- **Open Ports**: {scan.get('open_count', 0)}\n"
        md += f"- **Duration**: {scan.get('duration', 0):.2f}s\n\n"
        
        if scan.get('open_ports'):
            md += "### Open Ports\n\n"
            md += "| Port | Service | Banner |\n"
            md += "|------|---------|--------|\n"
            for port_info in scan['open_ports']:
                md += f"| {port_info['port']} | {port_info.get('service', 'unknown')} | {port_info.get('banner', 'N/A')[:50]} |\n"
            md += "\n"
        
        return md
    
    def _format_port_scan_html(self, scan: Dict) -> str:
        """Format port scan for HTML"""
        html = '<div class="section"><h2>‚ö° Port Scan Results</h2>'
        html += f'<p><span class="badge badge-info">Open Ports: {scan.get("open_count", 0)}</span>'
        html += f'<span class="badge badge-success">Duration: {scan.get("duration", 0):.2f}s</span></p>'
        
        if scan.get('open_ports'):
            html += '<table><thead><tr><th>Port</th><th>Service</th><th>Banner</th></tr></thead><tbody>'
            for port_info in scan['open_ports']:
                html += f"<tr><td>{port_info['port']}</td><td>{port_info.get('service', 'unknown')}</td>"
                html += f"<td><code>{port_info.get('banner', 'N/A')[:50]}</code></td></tr>"
            html += '</tbody></table>'
        
        html += '</div>'
        return html
    
    def _format_web_recon_md(self, recon: Dict) -> str:
        """Format web recon for Markdown"""
        md = "## Web Reconnaissance\n\n"
        
        if recon.get('subdomains'):
            md += f"### Subdomains ({len(recon['subdomains'])})\n\n"
            for sub in recon['subdomains'][:10]:
                md += f"- **{sub['subdomain']}** - {sub.get('ips', [])}\n"
            md += "\n"
        
        if recon.get('technologies'):
            md += "### Tech Stack\n\n"
            tech = recon['technologies']
            md += f"- **Server**: {tech.get('server', 'Unknown')}\n"
            md += f"- **CMS**: {tech.get('cms', 'Unknown')}\n"
            if tech.get('frameworks'):
                md += f"- **Frameworks**: {', '.join(tech['frameworks'])}\n"
            md += "\n"
        
        return md
    
    def _format_web_recon_html(self, recon: Dict) -> str:
        """Format web recon for HTML"""
        html = '<div class="section"><h2>üåê Web Reconnaissance</h2>'
        
        if recon.get('subdomains'):
            html += f'<h3>Subdomains ({len(recon["subdomains"])})</h3>'
            for sub in recon['subdomains'][:10]:
                html += f'<div class="record"><strong>{sub["subdomain"]}</strong><br>'
                html += f'IPs: {", ".join(sub.get("ips", []))}</div>'
        
        if recon.get('technologies'):
            tech = recon['technologies']
            html += '<h3>Technology Stack</h3><div class="record">'
            html += f'<strong>Server:</strong> {tech.get("server", "Unknown")}<br>'
            html += f'<strong>CMS:</strong> {tech.get("cms", "Unknown")}<br>'
            if tech.get('frameworks'):
                html += f'<strong>Frameworks:</strong> {", ".join(tech["frameworks"])}'
            html += '</div>'
        
        html += '</div>'
        return html
    
    def _format_dns_enum_md(self, dns: Dict) -> str:
        """Format DNS enumeration for Markdown"""
        md = "## DNS Enumeration\n\n"
        
        if dns.get('records'):
            for record_type, values in dns['records'].items():
                if values:
                    md += f"### {record_type} Records\n\n"
                    for value in values:
                        md += f"- {value}\n"
                    md += "\n"
        
        return md
    
    def _format_dns_enum_html(self, dns: Dict) -> str:
        """Format DNS enumeration for HTML"""
        html = '<div class="section"><h2>üìä DNS Enumeration</h2>'
        
        if dns.get('records'):
            for record_type, values in dns['records'].items():
                if values:
                    html += f'<h3>{record_type} Records</h3><div class="record">'
                    html += '<br>'.join(values)
                    html += '</div>'
        
        html += '</div>'
        return html
    
    def _format_ssl_analysis_md(self, ssl: Dict) -> str:
        """Format SSL analysis for Markdown"""
        md = "## SSL/TLS Analysis\n\n"
        
        if ssl.get('certificate'):
            cert = ssl['certificate']
            md += "### Certificate\n\n"
            md += f"- **Subject**: {cert.get('subject', {}).get('CN', 'N/A')}\n"
            md += f"- **Issuer**: {cert.get('issuer', {}).get('CN', 'N/A')}\n"
            md += f"- **Expires**: {cert.get('not_after', 'N/A')}\n"
            md += f"- **Days Remaining**: {cert.get('days_remaining', 0)}\n\n"
        
        if ssl.get('vulnerabilities'):
            md += "### Vulnerabilities\n\n"
            vulns = ssl['vulnerabilities'].get('vulnerabilities', {})
            for vuln, status in vulns.items():
                md += f"- **{vuln}**: {'‚ùå Vulnerable' if status else '‚úÖ Not Vulnerable'}\n"
            md += "\n"
        
        return md
    
    def _format_ssl_analysis_html(self, ssl: Dict) -> str:
        """Format SSL analysis for HTML"""
        html = '<div class="section"><h2>üîê SSL/TLS Analysis</h2>'
        
        if ssl.get('certificate'):
            cert = ssl['certificate']
            html += '<h3>Certificate</h3><div class="record">'
            html += f'<strong>Subject:</strong> {cert.get("subject", {}).get("CN", "N/A")}<br>'
            html += f'<strong>Issuer:</strong> {cert.get("issuer", {}).get("CN", "N/A")}<br>'
            html += f'<strong>Expires:</strong> {cert.get("not_after", "N/A")}<br>'
            html += f'<strong>Days Remaining:</strong> {cert.get("days_remaining", 0)}'
            html += '</div>'
        
        if ssl.get('vulnerabilities'):
            html += '<h3>Vulnerabilities</h3><div class="record">'
            vulns = ssl['vulnerabilities'].get('vulnerabilities', {})
            for vuln, status in vulns.items():
                badge_class = 'badge-danger' if status else 'badge-success'
                status_text = 'Vulnerable' if status else 'Secure'
                html += f'<span class="badge {badge_class}">{vuln}: {status_text}</span>'
            html += '</div>'
        
        html += '</div>'
        return html


def generate_report(data: Dict, format: str = 'json', filename: Optional[str] = None) -> str:
    """
    Generate report in specified format
    
    Args:
        data: Report data
        format: Output format (json, html, markdown)
        filename: Output filename (auto-generated if None)
        
    Returns:
        Path to generated report
    """
    generator = ReportGenerator()
    
    if filename is None:
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        target = data.get('target', 'scan').replace('.', '_')
        filename = f"shinigami_{target}_{timestamp}.{format}"
    
    if format == 'json':
        return generator.generate_json(data, filename)
    elif format == 'html':
        return generator.generate_html(data, filename)
    elif format in ['md', 'markdown']:
        return generator.generate_markdown(data, filename)
    else:
        raise ValueError(f"Unsupported format: {format}")
