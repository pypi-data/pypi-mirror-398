name: Daily RayCluster Cleanup

on:
  schedule:
    - cron: "0 9 * * *"  # daily at 09:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  NAMESPACE: geneva

jobs:
  gke-cleanup:
    runs-on: warp-ubuntu-latest-x64-8x
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: google-github-actions/setup-gcloud@v2
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_KEY }}
      - uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: geneva-integ
          location: us-central1
      - name: Install kubectl & jq
        run: |
          sudo apt-get update
          sudo apt-get install -y kubectl jq
      - name: Delete rayclusters named {name}-{date}-{slug} older than 1d (GKE)
        run: |
          CUTOFF=$(date -u -d "24 hours ago" '+%Y-%m-%dT%H:%M:%SZ')
          echo "Looking for rayclusters in ${NAMESPACE} matching {name}-YYYY-MM-DD-HH-mm-{5digit} and created before $CUTOFF"
          MATCHES=$(kubectl get raycluster -n "${NAMESPACE}" -o json | jq -r --arg cutoff "$CUTOFF" '.items[] | select(.metadata.name | test("^[a-z0-9-]+-[0-9]{4}-[0-9]{2}-[0-9]{2}-[0-9]{2}-[0-9]{2}-[0-9]{5}$")) | select(.metadata.creationTimestamp < $cutoff) | .metadata.name')
          if [ -z "$MATCHES" ]; then
            echo "No matching rayclusters found"
          else
            echo "Deleting:" && echo "$MATCHES"
            echo "$MATCHES" | xargs -r -n1 kubectl delete raycluster -n "${NAMESPACE}" --timeout=300s --wait
          fi

  aws-cleanup:
    runs-on: warp-ubuntu-latest-x64-8x
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::054483968661:role/github_actions_role
      - name: Install kubectl & jq
        run: |
          sudo apt-get update
          sudo apt-get install -y kubectl jq
      - name: Set kubeconfig
        run: |
          aws eks update-kubeconfig --region us-east-1 --name lancedb
      - name: Delete rayclusters named {name}-{date}-{slug} older than 1d (AWS)
        run: |
          CUTOFF=$(date -u -d "24 hours ago" '+%Y-%m-%dT%H:%M:%SZ')
          echo "Looking for rayclusters in ${NAMESPACE} matching {name}-YYYY-MM-DD-HH-mm-{5digit} and created before $CUTOFF"
          MATCHES=$(kubectl get raycluster -n "${NAMESPACE}" -o json | jq -r --arg cutoff "$CUTOFF" '.items[] | select(.metadata.name | test("^[a-z0-9-]+-[0-9]{4}-[0-9]{2}-[0-9]{2}-[0-9]{2}-[0-9]{2}-[0-9]{5}$")) | select(.metadata.creationTimestamp < $cutoff) | .metadata.name')
          if [ -z "$MATCHES" ]; then
            echo "No matching rayclusters found"
          else
            echo "Deleting:" && echo "$MATCHES"
            echo "$MATCHES" | xargs -r -n1 kubectl delete raycluster -n "${NAMESPACE}" --timeout=300s --wait
          fi
