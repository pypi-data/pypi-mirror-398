var at=Object.defineProperty;var u=(n,e)=>at(n,"name",{value:e,configurable:!0});import{w as h,cH as N,cI as Ie,cJ as C,am as k,ap as F,cK as rt,ae as J,aK as le,cL as lt,cM as dt,bk as Je,a8 as ct,x as ut,h as S,a2 as pt,t as x,G as te,cN as ht,cO as gt,cP as R,cQ as L,aX as ft,cR as Ce,cS as mt,cT as yt,cU as wt,cV as Re,cW as B,cX as $,aD as ce,cY as Ze,cZ as oe,c_ as bt,c$ as vt,d0 as Ct,d1 as G,F as _t,d2 as kt,C as Nt,a as O,d3 as Qe,ax as It,d4 as xt,aE as Dt,f as ee,d5 as V,ay as Tt,u as et,cE as Et,cF as ue,cG as ae,d6 as xe,d7 as De,d8 as St,d9 as Mt,da as Ot,V as We,db as At,c5 as Pt,dc as Lt,dd as Rt,de as Wt,df as Gt}from"./index-azSeANjR.js";import{br as Ft,cs as Ge,cV as X,n as Te,ew as Bt}from"./vendor-other-Dl5_1vG6.js";import{l as Ut}from"./mathUtil-CL7lMSDB.js";import{_ as Ee}from"./Load3D.vue_vue_type_script_setup_true_lang-CdToXgY3.js";import{g as pe,s as tt}from"./audioUtils-BAV2XXz9.js";import{u as Q}from"./audioService-jIQ1T4VZ.js";import"./vendor-primevue-B1C3YRTk.js";import"./vendor-vue-CuB5mYeL.js";import"./vendor-xterm-DV1MVhAx.js";import"./vendor-three-zdhtZbSm.js";import"./vendor-tiptap-BgsBtbxI.js";class M extends Ie{static{u(this,"ClipspaceDialog")}static items=[];static instance=null;static registerButton(e,t,i){const o=C("button",{type:"button",textContent:e,contextPredicate:t,onclick:i});M.items.push(o)}static invalidatePreview(){if(N.clipspace&&N.clipspace.imgs&&N.clipspace.imgs.length>0){const e=document.getElementById("clipspace_preview");e&&(e.src=N.clipspace.imgs[N.clipspace.selectedIndex].src,e.style.maxHeight="100%",e.style.maxWidth="100%")}}static invalidate(){if(M.instance){const e=M.instance,t=C("div.comfy-modal-content",[e.createImgSettings(),...e.createButtons()]);e.element?(e.element.firstChild&&e.element.removeChild(e.element.firstChild),e.element.appendChild(t)):e.element=C("div.comfy-modal",{parent:document.body},[t]),e.element.children[0].children.length<=1&&e.element.children[0].appendChild(C("p",{},["Unable to find the features to edit content of a format stored in the current Clipspace."])),M.invalidatePreview()}}constructor(){super()}createButtons(){const e=[];for(let t in M.items){const i=M.items[t];(!i.contextPredicate||i.contextPredicate())&&e.push(M.items[t])}return e.push(C("button",{type:"button",textContent:"Close",onclick:u(()=>{this.close()},"onclick")})),e}createImgSettings(){if(N.clipspace?.imgs){const e=[],t=N.clipspace.imgs;for(let d=0;d<t.length;d++)e.push(C("option",{value:d},[`${d}`]));const i=C("select",{id:"clipspace_img_selector",onchange:u(d=>{d.target&&N.clipspace&&(N.clipspace.selectedIndex=d.target.selectedIndex,M.invalidatePreview())},"onchange")},e),o=C("tr",{},[C("td",{},[C("font",{color:"white"},["Select Image"])]),C("td",{},[i])]),s=C("select",{id:"clipspace_img_paste_mode",onchange:u(d=>{d.target&&N.clipspace&&(N.clipspace.img_paste_mode=d.target.value)},"onchange")},[C("option",{value:"selected"},"selected"),C("option",{value:"all"},"all")]);s.value=N.clipspace.img_paste_mode;const a=C("tr",{},[C("td",{},[C("font",{color:"white"},["Paste Mode"])]),C("td",{},[s])]),r=C("td",{align:"center",width:"100px",height:"100px",colSpan:"2"},[C("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")},[])]),l=C("tr",{},[r]);return C("table",{},[o,a,l])}else return[]}createImgPreview(){return N.clipspace?.imgs?C("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")}):[]}show(){M.invalidate(),this.element.style.display="block"}}h.registerExtension({name:"Comfy.Clipspace",init(n){n.openClipspace=function(){M.instance||(M.instance=new M,N.clipspace_invalidate_handler=M.invalidate),N.clipspace?M.instance.show():n.ui.dialog.show("Clipspace is Empty!")}}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.clipspace=window.comfyAPI.clipspace||{};window.comfyAPI.clipspace.ClipspaceDialog=M;const zt={name:"Comfy.ContextMenuFilter",init(){const n=k.ContextMenu;k.ContextMenu=function(e,t){const i=new n(e,t);if(t?.className==="dark"&&e?.length>4){const o=document.createElement("input");o.classList.add("comfy-context-menu-filter"),o.placeholder="Filter list",i.root.prepend(o);const s=Array.from(i.root.querySelectorAll(".litemenu-entry"));let a=[...s],r=a.length;requestAnimationFrame(()=>{const d=F.active_canvas.current_node?.widgets?.filter(f=>rt(f)&&f.options.values?.length===e.length).find(f=>f.options.values?.every((m,y)=>m===e[y]))?.value;let c=d?e.findIndex(f=>f===d):0;c<0&&(c=0);let g=a[c];w();function w(){g?.style.setProperty("background-color",""),g?.style.setProperty("color",""),g=a[c],g?.style.setProperty("background-color","#ccc","important"),g?.style.setProperty("color","#000","important")}u(w,"updateSelected");const p=u(()=>{if(i.root.getBoundingClientRect().top<0){const m=1-i.root.getBoundingClientRect().height/i.root.clientHeight,y=i.root.clientHeight*m/2;i.root.style.top=-y+"px"}},"positionList");o.addEventListener("keydown",f=>{switch(f.key){case"ArrowUp":f.preventDefault(),c===0?c=r-1:c--,w();break;case"ArrowRight":f.preventDefault(),c=r-1,w();break;case"ArrowDown":f.preventDefault(),c===r-1?c=0:c++,w();break;case"ArrowLeft":f.preventDefault(),c=0,w();break;case"Enter":g?.click();break;case"Escape":i.close();break}}),o.addEventListener("input",()=>{const f=o.value.toLocaleLowerCase();if(a=s.filter(m=>{const y=!f||m.textContent?.toLocaleLowerCase().includes(f);return m.style.display=y?"block":"none",y}),c=0,a.includes(g)&&(c=a.findIndex(m=>m===g)),r=a.length,w(),t.event){let m=t.event.clientY-10;const y=document.body.getBoundingClientRect(),b=i.root.getBoundingClientRect();y.height&&m>y.height-b.height-10&&(m=Math.max(0,y.height-b.height-10)),i.root.style.top=m+"px",p()}}),requestAnimationFrame(()=>{o.focus(),p()})})}return i},k.ContextMenu.prototype=n.prototype}};h.registerExtension(zt);function Vt(n=[]){if(!this.outputs[0].links?.length||!this.graph)return;const e=[...this.outputs[0].links.map(i=>this.graph.links[i]),...n];let t=this.widgets?.[0].value;for(const i of e){const o=this.graph?.getNodeById(i.target_id),s=o?.inputs[i.target_slot];if(!s){console.warn("Unable to resolve node or input for link",i);continue}const a=s.widget?.name;if(!a){console.warn("Invalid widget or widget name",s.widget);continue}const r=o.widgets?.find(l=>l.name===a);if(!r){console.warn(`Unable to find widget "${a}" on node [${o.id}]`);continue}r.value=t,r.callback?.(r.value,h.canvas,o,h.canvas.graph_mouse,{})}}u(Vt,"applyToGraph");function $t(){this.applyToGraph=J(this.applyToGraph,Vt);const n=this.widgets[0],e=Ft([]);n.options.values=e;const t=u(()=>{e.splice(0,e.length,...this.widgets.filter(o=>o.name.startsWith("option")&&o.value).map(o=>`${o.value}`)),!h.configuringGraph&&(e.includes(`${n.value}`)||(n.value=e[0]??"",n.callback?.(n.value)))},"updateCombo");n.callback=J(n.callback,()=>this.applyToGraph());function i(o){if(!o.widgets)return;const s=o.widgets.length-1;o.addWidget("string",`option${s}`,"",()=>{});const a=o.widgets.at(-1);if(!a)return;let r="";Object.defineProperty(a,"value",{get(){return r},set(l){if(r=l,t(),!o.widgets)return;const d=o.widgets.at(-1);if(d===this){l&&i(o);return}l||o.widgets.at(-2)!==this||d?.value||(o.widgets.pop(),o.computeSize(o.size),this.callback(l))}})}u(i,"addOption"),i(this)}u($t,"onNodeCreated");h.registerExtension({name:"Comfy.CustomCombo",beforeRegisterNodeDef(n,e){e?.name==="CustomCombo"&&(n.prototype.onNodeCreated=J(n.prototype.onNodeCreated,$t))}});le().registerExtension({name:"Comfy.DynamicPrompts",nodeCreated(n){if(n.widgets){const e=n.widgets.filter(t=>t.dynamicPrompts);for(const t of e)t.serializeValue=(i,o)=>{if(typeof t.value!="string")return t.value;const s=lt(t.value);return i?.widgets_values&&(i.widgets_values[o]=s),s}}}});h.registerExtension({name:"Comfy.EditAttention",init(){const n=h.ui.settings.addSetting({id:"Comfy.EditAttention.Delta",category:["Comfy","EditTokenWeight","Delta"],name:"Ctrl+up/down precision",type:"slider",attrs:{min:.01,max:.5,step:.01},defaultValue:.05});function e(s,a){const r=parseFloat(s);if(isNaN(r))return s;const l=r+a;return String(Number(l.toFixed(10)))}u(e,"incrementWeight");function t(s,a){let r=a,l=a,d=0,c=0;for(;r>=0&&(r--,!(s[r]==="("&&d===c));)s[r]==="("&&d++,s[r]===")"&&c++;if(r<0)return null;for(d=0,c=0;l<s.length&&!(s[l]===")"&&d===c);)s[l]==="("&&d++,s[l]===")"&&c++,l++;return l===s.length?null:{start:r+1,end:l}}u(t,"findNearestEnclosure");function i(s){const a=/^\((.*)\)$/,r=s.match(a),l=/:([+-]?(\d*\.)?\d+([eE][+-]?\d+)?)/,d=s.match(l);return r&&!d?`(${r[1]}:1.0)`:s}u(i,"addWeightToParentheses");function o(s){const a=s.composedPath()[0],r=parseFloat(n.value);if(a.tagName!=="TEXTAREA"||!(s.key==="ArrowUp"||s.key==="ArrowDown")||!s.ctrlKey&&!s.metaKey)return;s.preventDefault();let l=a.selectionStart,d=a.selectionEnd,c=a.value.substring(l,d);if(!c){const p=t(a.value,l);if(p)l=p.start,d=p.end,c=a.value.substring(l,d);else{const f=" .,\\/!?%^*;:{}=-_`~()\r\n	";for(;!f.includes(a.value[l-1])&&l>0;)l--;for(;!f.includes(a.value[d])&&d<a.value.length;)d++;if(c=a.value.substring(l,d),!c)return}}c[c.length-1]===" "&&(c=c.substring(0,c.length-1),d-=1),a.value[l-1]==="("&&a.value[d]===")"&&(l-=1,d+=1,c=a.value.substring(l,d)),(c[0]!=="("||c[c.length-1]!==")")&&(c=`(${c})`),c=i(c);const g=s.key==="ArrowUp"?r:-r,w=c.replace(/\((.*):([+-]?\d+(?:\.\d+)?)\)/,(p,f,m)=>(m=e(m,g),m==1?f:`(${f}:${m})`));a.setSelectionRange(l,d),document.execCommand("insertText",!1,w),a.setSelectionRange(l,l+w.length)}u(o,"editAttention"),window.addEventListener("keydown",o)}});const jt={settingId:"Comfy-Desktop.UV.PythonInstallMirror",mirror:"https://github.com/astral-sh/python-build-standalone/releases/download",fallbackMirror:"https://python-standalone.org/mirror/astral-sh/python-build-standalone",validationPathSuffix:"/20250115/cpython-3.10.16+20250115-aarch64-apple-darwin-debug-full.tar.zst.sha256"},ye=u(async n=>dt(n)&&await Je().NetWork.canAccessUrl(n),"checkMirrorReachable");(async()=>{if(!ct())return;const n=Je(),e=await n.getElectronVersion(),t=ut(),i=S(),{staticUrls:o,buildDocsUrl:s}=pt(),a=u((r,l)=>{l!==void 0&&r!==l&&n.restartApp("Restart ComfyUI to apply changes.",1500)},"onChangeRestartApp");h.registerExtension({name:"Comfy.ElectronAdapter",settings:[{id:"Comfy-Desktop.AutoUpdate",category:["Comfy-Desktop","General","AutoUpdate"],name:"Automatically check for updates",type:"boolean",defaultValue:!0,onChange:a},{id:"Comfy-Desktop.SendStatistics",category:["Comfy-Desktop","General","Send Statistics"],name:"Send anonymous usage metrics",type:"boolean",defaultValue:!0,onChange:a},{id:"Comfy-Desktop.WindowStyle",category:["Comfy-Desktop","General","Window Style"],name:"Window Style",tooltip:"Custom: Replace the system title bar with ComfyUI's Top menu",type:"combo",experimental:!0,defaultValue:"default",options:["default","custom"],onChange:u((r,l)=>{l&&n.Config.setWindowStyle(r)},"onChange")},{id:"Comfy-Desktop.UV.PythonInstallMirror",name:"Python Install Mirror",tooltip:"Managed Python installations are downloaded from the Astral python-build-standalone project. This variable can be set to a mirror URL to use a different source for Python installations. The provided URL will replace https://github.com/astral-sh/python-build-standalone/releases/download in, e.g., https://github.com/astral-sh/python-build-standalone/releases/download/20240713/cpython-3.12.4%2B20240713-aarch64-apple-darwin-install_only.tar.gz. Distributions can be read from a local directory by using the file:// URL scheme.",type:"url",defaultValue:"",attrs:{validateUrlFn(r){return ye(r+jt.validationPathSuffix)}}},{id:"Comfy-Desktop.UV.PypiInstallMirror",name:"Pypi Install Mirror",tooltip:"Default pip install mirror",type:"url",defaultValue:"",attrs:{validateUrlFn:ye}},{id:"Comfy-Desktop.UV.TorchInstallMirror",name:"Torch Install Mirror",tooltip:"Pip install mirror for pytorch",type:"url",defaultValue:"",attrs:{validateUrlFn:ye}}],commands:[{id:"Comfy-Desktop.Folders.OpenLogsFolder",label:"Open Logs Folder",icon:"pi pi-folder-open",function(){n.openLogsFolder()}},{id:"Comfy-Desktop.Folders.OpenModelsFolder",label:"Open Models Folder",icon:"pi pi-folder-open",function(){n.openModelsFolder()}},{id:"Comfy-Desktop.Folders.OpenOutputsFolder",label:"Open Outputs Folder",icon:"pi pi-folder-open",function(){n.openOutputsFolder()}},{id:"Comfy-Desktop.Folders.OpenInputsFolder",label:"Open Inputs Folder",icon:"pi pi-folder-open",function(){n.openInputsFolder()}},{id:"Comfy-Desktop.Folders.OpenCustomNodesFolder",label:"Open Custom Nodes Folder",icon:"pi pi-folder-open",function(){n.openCustomNodesFolder()}},{id:"Comfy-Desktop.Folders.OpenModelConfig",label:"Open extra_model_paths.yaml",icon:"pi pi-file",function(){n.openModelConfig()}},{id:"Comfy-Desktop.OpenDevTools",label:"Open DevTools",icon:"pi pi-code",function(){n.openDevTools()}},{id:"Comfy-Desktop.OpenUserGuide",label:"Desktop User Guide",icon:"pi pi-book",function(){window.open(s("/installation/desktop",{includeLocale:!0,platform:!0}),"_blank")}},{id:"Comfy-Desktop.CheckForUpdates",label:"Check for Updates",icon:"pi pi-sync",async function(){try{const r=await n.checkForUpdates({disableUpdateReadyAction:!0});if(!r.isUpdateAvailable){i.add({severity:"info",summary:x("desktopUpdate.noUpdateFound"),life:5e3});return}if(await te().confirm({title:x("desktopUpdate.updateFoundTitle",{version:r.version}),message:x("desktopUpdate.updateAvailableMessage"),type:"default"}))try{n.restartAndInstall()}catch(d){Ge.error("Error installing update:",d),i.add({severity:"error",summary:x("g.error"),detail:x("desktopUpdate.errorInstallingUpdate"),life:1e4})}}catch(r){Ge.error("Error checking for updates:",r),i.add({severity:"error",summary:x("g.error"),detail:x("desktopUpdate.errorCheckingUpdate"),life:1e4})}}},{id:"Comfy-Desktop.Reinstall",label:"Reinstall",icon:"pi pi-refresh",async function(){await te().confirm({message:x("desktopMenu.confirmReinstall"),title:x("desktopMenu.reinstall"),type:"reinstall"})&&n.reinstall()}},{id:"Comfy-Desktop.Restart",label:"Restart",icon:"pi pi-refresh",function(){n.restartApp()}},{id:"Comfy-Desktop.Quit",label:"Quit",icon:"pi pi-sign-out",async function(){t.modifiedWorkflows.length>0&&!await te().confirm({message:x("desktopMenu.confirmQuit"),title:x("desktopMenu.quit"),type:"default"})||n.quit()}}],menuCommands:[{path:["Help"],commands:["Comfy-Desktop.OpenUserGuide"]},{path:["Help"],commands:["Comfy-Desktop.OpenDevTools"]},{path:["Help","Open Folder"],commands:["Comfy-Desktop.Folders.OpenLogsFolder","Comfy-Desktop.Folders.OpenModelsFolder","Comfy-Desktop.Folders.OpenOutputsFolder","Comfy-Desktop.Folders.OpenInputsFolder","Comfy-Desktop.Folders.OpenCustomNodesFolder","Comfy-Desktop.Folders.OpenModelConfig"]},{path:["Help"],commands:["Comfy-Desktop.CheckForUpdates","Comfy-Desktop.Reinstall"]}],keybindings:[{commandId:"Workspace.CloseWorkflow",combo:{key:"w",ctrl:!0}}],aboutPageBadges:[{label:"ComfyUI_desktop v"+e,url:o.githubElectron,icon:"pi pi-github"}]})})();class Yt extends ht{static{u(this,"ExecutableGroupNodeChildDTO")}groupNodeHandler;constructor(e,t,i,o,s){super(e,t,i,o),this.groupNodeHandler=s}resolveInput(e){if(this.id.split(":").length>2)throw new Error("Group nodes inside subgraphs are not supported. Please convert the group node to a subgraph instead.");const t=this.node.getInputNode(e);if(!t)return;const i=this.node.getInputLink(e);if(!i)throw new Error("Failed to get input link");const o=String(t.id);let s=this.nodesByExecutionId?.get(o);if(!s){const a=o.split(":").at(-1);a!==void 0&&(s=this.nodesByExecutionId?.get(a))}if(!s)throw new Error(`Failed to get input node ${o} for group node child ${this.id} with slot ${e}`);return{node:s,origin_id:o,origin_slot:i.origin_slot}}}const we=Symbol();function ot(n,e){if(typeof n=="object"&&typeof e=="object")for(const t in e){const i=e[t];if(typeof i=="object"){let o=n[t];o||(o=n[t]={}),ot(o,e[t])}else n[t]=i}return n}u(ot,"merge");class it extends gt{static{u(this,"ManageGroupDialog")}tabs;selectedNodeIndex;selectedTab="Inputs";selectedGroup;modifications={};nodeItems;app;groupNodeType;groupNodeDef;groupData;innerNodesList;widgetsPage;inputsPage;outputsPage;draggable;get selectedNodeInnerIndex(){return+this.nodeItems[this.selectedNodeIndex].dataset.nodeindex}constructor(e){super(),this.app=e,this.element=C("dialog.comfy-group-manage",{parent:document.body})}changeTab(e){this.tabs[this.selectedTab].tab.classList.remove("active"),this.tabs[this.selectedTab].page.classList.remove("active"),this.tabs[e].tab.classList.add("active"),this.tabs[e].page.classList.add("active"),this.selectedTab=e}changeNode(e,t){!t&&this.selectedNodeIndex===e||(this.selectedNodeIndex!=null&&this.nodeItems[this.selectedNodeIndex].classList.remove("selected"),this.nodeItems[e].classList.add("selected"),this.selectedNodeIndex=e,!this.buildInputsPage()&&this.selectedTab==="Inputs"&&this.changeTab("Widgets"),!this.buildWidgetsPage()&&this.selectedTab==="Widgets"&&this.changeTab("Outputs"),!this.buildOutputsPage()&&this.selectedTab==="Outputs"&&this.changeTab("Inputs"),this.changeTab(this.selectedTab))}getGroupData(){this.groupNodeType=k.registered_node_types[`${R}${L}`+this.selectedGroup],this.groupNodeDef=this.groupNodeType.nodeData,this.groupData=U.getGroupData(this.groupNodeType)}changeGroup(e,t=!0){this.selectedGroup=e,this.getGroupData();const i=this.groupData.nodeData.nodes;if(this.nodeItems=i.map((s,a)=>C("li.draggable-item",{dataset:{nodeindex:s.index+""},onclick:u(()=>{this.changeNode(a)},"onclick")},[C("span.drag-handle"),C("div",{textContent:s.title??s.type},s.title?C("span",{textContent:s.type}):[])])),this.innerNodesList.replaceChildren(...this.nodeItems),t)this.selectedNodeIndex=null,this.changeNode(0);else{let a=this.draggable.getAllItems().findIndex(r=>r.classList.contains("selected"));a===-1&&(a=this.selectedNodeIndex),this.changeNode(a,!0)}const o=[...i];this.draggable?.dispose(),this.draggable=new ft(this.innerNodesList,"li"),this.draggable.addEventListener("dragend",({detail:{oldPosition:s,newPosition:a}})=>{if(s!==a){o.splice(a,0,o.splice(s,1)[0]);for(let r=0;r<o.length;r++)this.storeModification({nodeIndex:o[r].index,section:we,prop:"order",value:r})}})}storeModification(e){const{nodeIndex:t,section:i,prop:o,value:s}=e,a=this.modifications[this.selectedGroup]??={},r=a.nodes??={},l=r[t??this.selectedNodeInnerIndex]??={},d=l[i]??={};if(typeof s=="object"){const c=d[o]??={};Object.assign(c,s)}else d[o]=s}getEditElement(e,t,i,o,s,a=!0){i===o&&(i="");const r=this.modifications[this.selectedGroup]?.nodes?.[this.selectedNodeInnerIndex]?.[e]?.[t];return r&&(r.name!=null&&(i=r.name),r.visible!=null&&(s=r.visible)),C("div",[C("input",{value:i,placeholder:o,type:"text",onchange:u(l=>{this.storeModification({section:e,prop:t,value:{name:l.target.value}})},"onchange")}),C("label",{textContent:"Visible"},[C("input",{type:"checkbox",checked:s,disabled:!a,onchange:u(l=>{this.storeModification({section:e,prop:t,value:{visible:!!l.target.checked}})},"onchange")})])])}buildWidgetsPage(){const e=this.groupData.oldToNewWidgetMap[this.selectedNodeInnerIndex],t=Object.keys(e??{}),o=h.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.widgetsPage.replaceChildren(...t.map(s=>this.getEditElement("input",s,e[s],s,o?.[s]?.visible!==!1))),!!t.length}buildInputsPage(){const e=this.groupData.nodeInputs[this.selectedNodeInnerIndex],t=Object.keys(e??{}),o=h.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.inputsPage.replaceChildren(...t.map(s=>{let a=e[s];if(a)return this.getEditElement("input",s,a,s,o?.[s]?.visible!==!1)}).filter(Boolean)),!!t.length}buildOutputsPage(){const e=this.groupData.nodeData.nodes,t=this.groupData.getNodeDef(e[this.selectedNodeInnerIndex]),i=t?.output??[],o=this.groupData.oldToNewOutputMap[this.selectedNodeInnerIndex],a=h.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.output,l=this.groupData.nodeData.nodes[this.selectedNodeInnerIndex].type!=="PrimitiveNode";return this.outputsPage.replaceChildren(...i.map((d,c)=>{const g=o?.[c],w=t.output_name?.[c]??d;let p=a?.[c]?.name;const f=a?.[c]?.visible||g!=null;return(!p||p===w)&&(p=""),this.getEditElement("output",c,p,w,f,l)}).filter(Boolean)),!!i.length}show(e){const t=Object.keys(h.rootGraph.extra?.groupNodes??{}).sort((s,a)=>s.localeCompare(a));this.innerNodesList=C("ul.comfy-group-manage-list-items"),this.widgetsPage=C("section.comfy-group-manage-node-page"),this.inputsPage=C("section.comfy-group-manage-node-page"),this.outputsPage=C("section.comfy-group-manage-node-page");const i=C("div",[this.widgetsPage,this.inputsPage,this.outputsPage]);this.tabs=[["Inputs",this.inputsPage],["Widgets",this.widgetsPage],["Outputs",this.outputsPage]].reduce((s,[a,r])=>(s[a]={tab:C("a",{onclick:u(()=>{this.changeTab(a)},"onclick"),textContent:a}),page:r},s),{});const o=C("div.comfy-group-manage-outer",[C("header",[C("h2","Group Nodes"),C("select",{onchange:u(s=>{this.changeGroup(s.target.value)},"onchange")},t.map(s=>C("option",{textContent:s,selected:`${R}${L}${s}`===e,value:s})))]),C("main",[C("section.comfy-group-manage-list",this.innerNodesList),C("section.comfy-group-manage-node",[C("header",Object.values(this.tabs).map(s=>s.tab)),i])]),C("footer",[C("button.comfy-btn",{onclick:u(()=>{if(h.rootGraph.nodes.find(a=>a.type===`${R}${L}`+this.selectedGroup)){S().addAlert("This group node is in use in the current workflow, please first remove these.");return}confirm(`Are you sure you want to remove the node: "${this.selectedGroup}"`)&&(delete h.rootGraph.extra.groupNodes[this.selectedGroup],k.unregisterNodeType(`${R}${L}`+this.selectedGroup)),this.show()},"onclick")},"Delete Group Node"),C("button.comfy-btn",{onclick:u(async()=>{let s,a=[];const r={};for(const l in this.modifications){const d=h.rootGraph.extra.groupNodes[l];let c=d.config??={},g=this.modifications[l]?.nodes;if(g){const p=Object.keys(g);if(g[p[0]][we]){const f=[],m={},y={};for(const b of p){const v=g[b][we].order;f[v]=d.nodes[+b],m[v]=g[b],f[v].index=v}for(const b of d.links)b[0]!=null&&(b[0]=d.nodes[b[0]].index),b[2]!=null&&(b[2]=d.nodes[b[2]].index);if(d.external)for(const b of d.external)b[0]=d.nodes[b[0]];for(const b of p)c[b]&&(y[d.nodes[b].index]=c[b]),delete c[b];d.nodes=f,g=m,d.config=c=y}ot(c,g)}r[l]=d,s||(s=h.rootGraph.nodes.reduce((p,f)=>(p[f.type]??=[],p[f.type].push(f),p),{}));const w=s[`${R}${L}`+l];w&&a.push(...w)}await H.registerFromWorkflow(r,{});for(const l of a)l.recreate();this.modifications={},this.app.canvas.setDirty(!0,!0),this.changeGroup(this.selectedGroup,!1)},"onclick")},"Save"),C("button.comfy-btn",{onclick:u(()=>this.element.close(),"onclick")},"Close")])]);this.element.replaceChildren(o),this.changeGroup(e?t.find(s=>`${R}${L}${s}`===e)??t[0]:t[0]),this.element.showModal(),this.element.addEventListener("close",()=>{this.draggable?.dispose(),this.element.remove()})}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNodeManage=window.comfyAPI.groupNodeManage||{};window.comfyAPI.groupNodeManage.ManageGroupDialog=it;const Xt=new Set(["default","forceInput","defaultInput","control_after_generate","multiline","tooltip","dynamicPrompts"]),Fe=u(n=>{const e=n.min??-1/0,t=n.max??1/0;return{min:e,max:t}},"getRange"),qt=u((n,e)=>{const t=n[0],i=n[1]??{},o=e[1]??{},s=Fe(i),a=Fe(o);if(s.min>a.max||s.max<a.min)return null;const r=i.step??1,l=o.step??1,d={min:Math.max(s.min,a.min),max:Math.min(s.max,a.max),step:Ut(r,l)};return Se([t,{...i,...d}],[t,{...o,...d}])},"mergeNumericInputSpec"),Ht=u((n,e)=>{const t=n[1]??{},i=e[1]??{},o=Re(n),s=Re(e),a=X.intersection(o,s);return a.length===0?null:Se(["COMBO",{...t,options:a}],["COMBO",{...i,options:a}])},"mergeComboInputSpec"),Se=u((n,e)=>{const t=Ce(n),i=n[1]??{},o=e[1]??{};return X.union(X.keys(i),X.keys(o)).filter(r=>!Xt.has(r)).every(r=>{const l=i[r],d=o[r];return l===d||X.isNil(l)&&X.isNil(d)})?[t,{...i,...o}]:null},"mergeCommonInputSpec"),Kt=u((n,e)=>{const t=Ce(n),i=Ce(e);return t!==i?null:mt(n)||yt(n)?qt(n,e):wt(n)?Ht(n,e):Se(n,e)},"mergeInputSpec"),Jt=u(n=>n.type==="PrimitiveNode","isPrimitiveNode"),be="Run widget replace on values";class _e extends ce{static{u(this,"PrimitiveNode")}controlValues;lastType;static category;constructor(e){super(e),this.addOutput("connect to widget input","*"),this.serialize_widgets=!0,this.isVirtualNode=!0,(!this.properties||!(be in this.properties))&&this.addProperty(be,!1,"boolean")}applyToGraph(e=[]){if(!this.outputs[0].links?.length||!this.graph)return;const t=[...this.outputs[0].links.map(o=>this.graph.links[o]),...e];let i=this.widgets?.[0].value;i&&this.properties[be]&&(i=Ze(this.graph,i));for(const o of t){const s=this.graph?.getNodeById(o.target_id),a=s?.inputs[o.target_slot];if(!a){console.warn("Unable to resolve node or input for link",o);continue}const r=a.widget?.name;if(!r){console.warn("Invalid widget or widget name",a.widget);continue}const l=s.widgets?.find(d=>d.name===r);if(!l){console.warn(`Unable to find widget "${r}" on node [${s.id}]`);continue}l.value=i,l.callback?.(l.value,h.canvas,s,h.canvas.graph_mouse,{})}}refreshComboInNode(){const e=this.widgets?.[0];e?.type==="combo"&&(e.options.values=this.outputs[0].widget[B]()[0],e.options.values.includes(e.value)||(e.value=e.options.values[0],e.callback(e.value)))}onAfterGraphConfigured(){if(this.outputs[0].links?.length&&!this.widgets?.length){if(this.#e(),this.widgets&&this.widgets_values)for(let e=0;e<this.widgets_values.length;e++){const t=this.widgets[e];t&&(t.value=this.widgets_values[e])}this.#t()}}onConnectionsChange(e,t,i){if(h.configuringGraph)return;const o=this.outputs[0].links;i?o?.length&&!this.widgets?.length&&this.#e():(this.#t(),o?.length||this.onLastDisconnect())}onConnectOutput(e,t,i,o,s){if(!i.widget&&!(i.type in $))return!1;if(this.outputs[e].links?.length){const a=this.#o(i);return a&&this.applyToGraph([{target_id:o.id,target_slot:s}]),a}return!0}#e(e){if(!this.outputs[0].links||!this.graph){this.onLastDisconnect();return}const t=this.outputs[0].links[0],i=this.graph.links[t];if(!i)return;const o=this.graph.getNodeById(i.target_id);if(!o||!o.inputs)return;const s=o.inputs[i.target_slot];if(!s)return;let a;if(s.widget)a=s.widget;else{if(!(s.type in $))return;a={name:s.name,[B]:()=>[s.type,{}]}}const r=a[B]?.();if(!r)return;const{type:l}=Qt(r);this.outputs[0].type=l,this.outputs[0].name=l,this.outputs[0].widget=a,this.#s(a[oe]??r,o,a.name,e)}#s(e,t,i,o){let s=e[0];s instanceof Array&&(s="COMBO");const[a,r]=this.size;let l;if(bt(s)?l=($[s](this,"value",e,h)||{}).widget:l=this.addWidget(s,"value",null,()=>{},{}),t?.widgets&&l){const c=t.widgets.find(g=>g.name===i);c&&(l.value=c.value)}if(!e?.[1]?.control_after_generate&&(l.type==="number"||l.type==="combo")){let c=this.widgets_values?.[1];c||(c="fixed"),vt(this,l,c,void 0,e),this.widgets?.[1]&&(l.linkedWidgets=[this.widgets[1]]);let g=this.widgets_values?.[2];g&&this.widgets&&this.widgets.length===3&&(this.widgets[2].value=g)}const d=this.controlValues;if(this.widgets&&this.lastType===this.widgets[0]?.type&&d?.length===this.widgets.length-1)for(let c=0;c<d.length;c++)this.widgets[c+1].value=d[c];if(l.callback=J(l.callback,()=>{this.applyToGraph()}),this.setSize([Math.max(this.size[0],a),Math.max(this.size[1],r)]),!o){const c=this.computeSize();this.size[0]<c[0]&&(this.size[0]=c[0]),this.size[1]<c[1]&&(this.size[1]=c[1]),requestAnimationFrame(()=>{this.onResize?.(this.size)})}}recreateWidget(){const e=this.widgets?.map(t=>t.value);if(this.#i(),this.#e(!0),e?.length&&this.widgets)for(let t=0;t<this.widgets.length;t++)this.widgets[t].value=e[t];return this.widgets?.[0]}#t(){const e=this.outputs[0],t=e.links??[],i=!!e.widget?.[oe];if(i&&delete e.widget?.[oe],t?.length<2&&i){t.length&&this.recreateWidget();return}const o=e.widget?.[B]?.();if(!(!o||!(o[0]==="INT"||o[0]==="FLOAT")||!this.graph))for(const a of t){const r=this.graph.links[a];if(!r)continue;const l=this.graph.getNodeById(r.target_id);if(!l)continue;const d=l.inputs[r.target_slot];this.#o(d,i)}}#o(e,t){const i=this.outputs?.[0],o=e.widget?.[B]?.();return o?!!re.call(this,i,o,t,this.recreateWidget):!1}#i(){if(this.widgets){for(const e of this.widgets)e.onRemove&&e.onRemove();this.controlValues=[],this.lastType=this.widgets[0]?.type;for(let e=1;e<this.widgets.length;e++)this.controlValues.push(this.widgets[e].value);setTimeout(()=>{delete this.lastType,delete this.controlValues},15),this.widgets.length=0}}onLastDisconnect(){this.outputs[0].type="*",this.outputs[0].name="connect to widget input",delete this.outputs[0].widget,this.#i()}}function Me(n){return n.widget?.[oe]??n.widget?.[B]?.()??["*",{}]}u(Me,"getWidgetConfig");function Be(n){const{nodeData:e}=this.constructor;return e?.input?.required?.[n]??e?.input?.optional?.[n]}u(Be,"getConfig");function Zt(n,e){return console.warn("Please remove call to convertToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),n.inputs.find(t=>t.widget?.name===e.name)}u(Zt,"convertToInput");function Qt(n){let e=n[0];return e instanceof Array&&(e="COMBO"),{type:e}}u(Qt,"getWidgetType");function ke(n,e){if(!n.widget||(e?n.widget[B]=()=>e:delete n.widget,!(n instanceof Ct)))return;const t=n.node.graph;if(!t)return;const i=t.links[n.link??-1];if(!i)return;const o=t.getNodeById(i.origin_id);!o||!Jt(o)||(e?o.recreateWidget():h.configuringGraph||(o.disconnectOutput(0),o.onLastDisconnect()))}u(ke,"setWidgetConfig");function re(n,e,t,i,o){o||(o=Me(n));const s=Kt(o,e);if(s||t){s&&(n.widget[oe]=s);const a=i?.call(this);if(a){const r=a.options.min,l=a.options.max;r!=null&&a.value<r&&(a.value=r),l!=null&&a.value>l&&(a.value=l),a.callback(a.value)}}return{customConfig:s?.[1]??{}}}u(re,"mergeIfValid");h.registerExtension({name:"Comfy.WidgetInputs",async beforeRegisterNodeDef(n,e,t){n.prototype.convertWidgetToInput=function(){return console.warn("Please remove call to convertWidgetToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),!1},n.prototype.onGraphConfigured=J(n.prototype.onGraphConfigured,function(){if(this.inputs){this.widgets??=[];for(const o of this.inputs)if(o.widget){const s=o.widget.name;o.widget[B]||(o.widget[B]=()=>Be.call(this,s)),this.widgets?.find(r=>r.name===s)||this.removeInput(this.inputs.findIndex(r=>r===o))}}}),n.prototype.onConfigure=J(n.prototype.onConfigure,function(){if(!t.configuringGraph&&this.inputs){for(const o of this.inputs)if(o.widget&&!o.widget[B]){const s=o.widget.name;o.widget[B]=()=>Be.call(this,s)}}});const i=n.prototype.onInputDblClick;n.prototype.onInputDblClick=function(...[o,...s]){const a=i?.apply(this,[o,...s]),r=this.inputs[o];if(!r.widget&&!(r.type in $)&&!(r.widget?.[B]?.()?.[0]instanceof Array))return a;const l=k.createNode("PrimitiveNode"),d=t.canvas.graph;if(!l||!d)return a;d?.add(l);const c=[this.pos[0]-l.size[0]-30,this.pos[1]];for(;d.getNodeOnPos(c[0],c[1],d.nodes);)c[1]+=k.NODE_TITLE_HEIGHT;return l.pos=c,l.connect(0,this,o),l.title=r.name,a}},registerCustomNodes(){k.registerNodeType("PrimitiveNode",Object.assign(_e,{title:"Primitive"})),_e.category="utils"}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.widgetInputs=window.comfyAPI.widgetInputs||{};window.comfyAPI.widgetInputs.PrimitiveNode=_e;window.comfyAPI.widgetInputs.getWidgetConfig=Me;window.comfyAPI.widgetInputs.convertToInput=Zt;window.comfyAPI.widgetInputs.setWidgetConfig=ke;window.comfyAPI.widgetInputs.mergeIfValid=re;const q={InUse:{Free:0,Registered:1,InWorkflow:2},isInUseGroupNode(n){const e=`${R}${L}${n}`;return h.rootGraph.extra?.groupNodes?.[n]?h.rootGraph.nodes.find(t=>t.type===e)?q.InUse.InWorkflow:q.InUse.Registered:q.InUse.Free},storeGroupNode(n,e){let t=h.rootGraph.extra;t||(h.rootGraph.extra=t={});let i=t.groupNodes;i||(t.groupNodes=i={}),i[n]=e}};class Ue{static{u(this,"GroupNodeBuilder")}nodes;nodeData;constructor(e){this.nodes=e}async build(){const e=await this.getName();if(e)return this.sortNodes(),this.nodeData=this.getNodeData(),q.storeGroupNode(e,this.nodeData),{name:e,nodeData:this.nodeData}}async getName(){const e=await te().prompt({title:x("groupNode.create"),message:x("groupNode.enterName"),defaultValue:""});if(!e)return;switch(q.isInUseGroupNode(e)){case q.InUse.InWorkflow:S().addAlert("An in use group node with this name already exists embedded in this workflow, please remove any instances or use a new name.");return;case q.InUse.Registered:if(!confirm("A group node with this name already exists embedded in this workflow, are you sure you want to overwrite it?"))return;break}return e}sortNodes(){const e=h.rootGraph.computeExecutionOrder(!1);this.nodes=this.nodes.map(t=>({index:e.indexOf(t),node:t})).sort((t,i)=>t.index-i.index||t.node.id-i.node.id).map(({node:t})=>t)}getNodeData(){const e=u(i=>{for(const o of i.links){const a=h.rootGraph.getNodeById(o[4]).outputs[o[1]].type;o.push(a)}},"storeLinkTypes"),t=u(i=>{i.external=[];for(let o=0;o<this.nodes.length;o++){const s=this.nodes[o];if(s.outputs?.length)for(let a=0;a<s.outputs.length;a++){let r=!1;const l=s.outputs[a];let d=l.type;if(l.links?.length){for(const c of l.links){const g=h.rootGraph.links[c];if(g&&(d==="*"&&(d=g.type),!h.canvas.selected_nodes[g.target_id])){r=!0;break}}r&&i.external.push([o,a,d])}}}},"storeExternalLinks");try{const i=xt(this.nodes,h.canvas?.graph),o=JSON.parse(i);return e(o),t(o),o}finally{}}}class H{static{u(this,"GroupNodeConfig")}name;nodeData;inputCount;oldToNewOutputMap;newToOldOutputMap;oldToNewInputMap;oldToNewWidgetMap;newToOldWidgetMap;primitiveDefs;widgetToPrimitive;primitiveToWidget;nodeInputs;outputVisibility;nodeDef;inputs;linksFrom;linksTo;externalFrom;constructor(e,t){this.name=e,this.nodeData=t,this.getLinks(),this.inputCount=0,this.oldToNewOutputMap={},this.newToOldOutputMap={},this.oldToNewInputMap={},this.oldToNewWidgetMap={},this.newToOldWidgetMap={},this.primitiveDefs={},this.widgetToPrimitive={},this.primitiveToWidget={},this.nodeInputs={},this.outputVisibility=[]}async registerType(e=R){this.nodeDef={output:[],output_name:[],output_is_list:[],output_is_hidden:[],name:e+L+this.name,display_name:this.name,category:"group nodes"+(L+e),input:{required:{}},description:`Group node combining ${this.nodeData.nodes.map(o=>o.type).join(", ")}`,python_module:"custom_nodes."+this.name,[G]:this},this.inputs=[];const t={},i={};for(let o=0;o<this.nodeData.nodes.length;o++){const s=this.nodeData.nodes[o];s.index=o,this.processNode(s,t,i)}for(const o of this.#e)o();this.#e=null,await h.registerNodeDef(`${R}${L}`+this.name,this.nodeDef),_t().addNodeDef(this.nodeDef)}getLinks(){this.linksFrom={},this.linksTo={},this.externalFrom={};for(const e of this.nodeData.links){const[t,i,o,s]=e;t!=null&&(this.linksFrom[t]||(this.linksFrom[t]={}),this.linksFrom[t][i]||(this.linksFrom[t][i]=[]),this.linksFrom[t][i].push(e),this.linksTo[o]||(this.linksTo[o]={}),this.linksTo[o][s]=e)}if(this.nodeData.external)for(const e of this.nodeData.external)this.externalFrom[e[0]]?this.externalFrom[e[0]][e[1]]=e[2]:this.externalFrom[e[0]]={[e[1]]:e[2]}}processNode(e,t,i){const o=this.getNodeDef(e);if(!o)return;const s={...o.input?.required,...o.input?.optional};this.inputs.push(this.processNodeInputs(e,t,s)),o.output?.length&&this.processNodeOutputs(e,i,o)}getNodeDef(e){const t=ie[e.type];if(t)return t;const i=this.linksFrom[e.index];if(e.type==="PrimitiveNode"){if(!i)return;let o=i[0][0][5];if(o==="COMBO"){const a=e.outputs[0].widget.name,r=this.nodeData.nodes[i[0][0][2]].type,l=ie[r];o=(l.input.required[a]??l.input.optional[a])[0]}return this.primitiveDefs[e.index]={input:{required:{value:[o,{}]}},output:[o],output_name:[],output_is_list:[]}}else if(e.type==="Reroute"){const o=this.linksTo[e.index];if(o&&i&&!this.externalFrom[e.index]?.[0])return null;let s={},a="*";if(i)for(const[,,r,l]of i[0]){const d=this.nodeData.nodes[r],c=d.inputs[l];if(a==="*"&&(a=c.type),c.widget){const g=ie[d.type],w=g.input.required[c.widget.name]??g.input.optional[c.widget.name],p=[w[0],s];s=re({widget:p},w,!1,null,p)?.customConfig??s}}else if(o){const[r,l]=o[0];a=this.nodeData.nodes[r].outputs[l].type}else{for(const r of this.nodeData.links)if(r[2]===e.index){a=r[5];break}if(a==="*"){const r=this.externalFrom[e.index]?.[0];r&&(a=r)}}return s.forceInput=!0,{input:{required:{[a]:[a,s]}},output:[a],output_name:[],output_is_list:[]}}console.warn("Skipping virtual node "+e.type+" when building group node "+this.name)}getInputConfig(e,t,i,o,s){const a=this.nodeData.config?.[e.index]?.input?.[t];let r=a?.name??e.inputs?.find(c=>c.name===t)?.label??t,l=r,d="";return(e.type==="PrimitiveNode"&&e.title||r in i)&&(d=`${e.title??e.type} `,l=r=`${d}${t}`,r in i&&(r=`${d}${i[r]} ${t}`)),i[l]=(i[l]??1)+1,(t==="seed"||t==="noise_seed")&&(s||(s={}),s.control_after_generate=`${d}control_after_generate`),o[0]==="IMAGEUPLOAD"&&(s||(s={}),s.widget=this.oldToNewWidgetMap[e.index]?.[o[1]?.widget??"image"]??"image"),s&&(o=[o[0],{...o[1],...s}]),{name:r,config:o,customConfig:a}}processWidgetInputs(e,t,i,o){const s=[],a=new Map,r=this.oldToNewWidgetMap[t.index]={};for(const l of i)if(kt().inputIsWidget(e[l])){const d=t.inputs?.findIndex(c=>c.name===l&&c.widget?.name===l);if(d>-1)a.set(d,l),r[l]=null;else{const{name:c,config:g}=this.getInputConfig(t,l,o,e[l]);this.nodeDef.input.required[c]=g,r[l]=c,this.newToOldWidgetMap[c]={node:t,inputName:l}}}else s.push(l);return{converted:a,slots:s}}checkPrimitiveConnection(e,t,i){if(this.nodeData.nodes[e[0]].type==="PrimitiveNode"){const[s,a,r,l]=e,d=this.primitiveDefs[s],c=i[t],g=d.input.required.value,p=re({widget:g},c,!1,null,g);g[1]=p?.customConfig??i[t][1]?{...i[t][1]}:{};let f=this.oldToNewWidgetMap[s].value;f=f.substr(0,f.length-6),g[1].control_after_generate=!0,g[1].control_prefix=f;let m=this.widgetToPrimitive[r];m||(m=this.widgetToPrimitive[r]={}),m[t]&&m[t].push(s),m[t]=s;let y=this.primitiveToWidget[s];y||(y=this.primitiveToWidget[s]=[]),y.push({nodeId:r,inputName:t})}}processInputSlots(e,t,i,o,s,a){this.nodeInputs[t.index]={};for(let r=0;r<i.length;r++){const l=i[r];if(o[r]){this.checkPrimitiveConnection(o[r],l,e);continue}const{name:d,config:c,customConfig:g}=this.getInputConfig(t,l,a,e[l]);this.nodeInputs[t.index][l]=d,g?.visible!==!1&&(this.nodeDef.input.required[d]=c,s[r]=this.inputCount++)}}processConvertedWidgets(e,t,i,o,s,a,r){const l=[...o.keys()].sort().map(d=>o.get(d));for(let d=0;d<l.length;d++){const c=l[d];if(s[i.length+d]){this.checkPrimitiveConnection(s[i.length+d],c,e);continue}const{name:g,config:w}=this.getInputConfig(t,c,r,e[c],{defaultInput:!0});this.nodeDef.input.required[g]=w,this.newToOldWidgetMap[g]={node:t,inputName:c},this.oldToNewWidgetMap[t.index]||(this.oldToNewWidgetMap[t.index]={}),this.oldToNewWidgetMap[t.index][c]=g,a[i.length+d]=this.inputCount++}}#e=[];processNodeInputs(e,t,i){const o=[],s=Object.keys(i);if(!s.length)return;const{converted:a,slots:r}=this.processWidgetInputs(i,e,s,t),l=this.linksTo[e.index]??{},d=this.oldToNewInputMap[e.index]={};return this.processInputSlots(i,e,r,l,d,t),this.#e.push(()=>this.processConvertedWidgets(i,e,r,a,l,d,t)),o}processNodeOutputs(e,t,i){const o=this.oldToNewOutputMap[e.index]={};for(let s=0;s<i.output.length;s++){const r=this.linksFrom[e.index]?.[s]&&!this.externalFrom[e.index]?.[s],l=this.nodeData.config?.[e.index]?.output?.[s],d=l?.visible??!r;if(this.outputVisibility.push(d),!d)continue;o[s]=this.nodeDef.output.length,this.newToOldOutputMap[this.nodeDef.output.length]={node:e,slot:s},this.nodeDef.output.push(i.output[s]),this.nodeDef.output_is_list.push(i.output_is_list[s]);let c=l?.name;if(!c){c=i.output_name?.[s]??i.output[s];const w=e.outputs.find(p=>p.name===c);w?.label&&(c=w.label)}let g=c;if(g in t){const w=`${e.title??e.type} `;g=`${w}${c}`,g in t&&(g=`${w}${e.index} ${c}`)}t[g]=1,this.nodeDef.output_name.push(g)}}static async registerFromWorkflow(e,t){for(const i in e){const o=e[i];let s=!1;for(const r of o.nodes)r.type in k.registered_node_types||(t.push({type:r.type,hint:` (In group node '${R}${L}${i}')`}),t.push({type:`${R}${L}`+i,action:{text:"Remove from workflow",callback:u(l=>{delete e[i],l.target.textContent="Removed",l.target.style.pointerEvents="none",l.target.style.opacity=.7},"callback")}}),s=!0);if(s)continue;await new H(i,o).registerType()}}}class U{static{u(this,"GroupNodeHandler")}node;groupData;innerNodes;constructor(e){this.node=e,this.groupData=e.constructor?.nodeData?.[G],this.node.setInnerNodes=p=>{this.innerNodes=p;for(let f=0;f<this.innerNodes.length;f++){const m=this.innerNodes[f];m.graph??=this.node.graph;for(const y of m.widgets??[])y.type==="converted-widget"&&(y.serializeValue=y.origSerializeValue);m.index=f,m.getInputNode=y=>{const b=this.groupData.oldToNewInputMap[m.index]?.[y];if(b!=null)return this.node.getInputNode(b);const v=this.groupData.linksTo[m.index]?.[y];if(!v)return null;const _=p[v[0]];return _.type==="PrimitiveNode"?null:_},m.getInputLink=y=>{const b=this.groupData.oldToNewInputMap[m.index]?.[y];if(b!=null){const _=this.node.inputs[b].link;let I=h.rootGraph.links[_];return I={...I,target_id:m.id,target_slot:+y},I}let v=this.groupData.linksTo[m.index]?.[y];return v?(v={origin_id:p[v[0]].id,origin_slot:v[1],target_id:m.id,target_slot:+y},v):null}}},this.node.updateLink=p=>{p={...p};const f=this.groupData.newToOldOutputMap[p.origin_slot];let m=this.innerNodes[f.node.index],y;for(;m?.type==="Reroute";)y=m.getInputLink(0),m=m.getInputNode(0);return m?y&&U.isGroupNode(m)?m.updateLink(y):(p.origin_id=m.id,p.origin_slot=y?.origin_slot??f.slot,p):null},this.node.getInnerNodes=(p,f=[],m=[],y=new Set)=>{if(y.has(this.node))throw new Error("RecursionError: while flattening subgraph");y.add(this.node),this.innerNodes||this.node.setInnerNodes(this.groupData.nodeData.nodes.map((_,I)=>{const D=k.createNode(_.type);return D.configure(_),D.id=`${this.node.id}:${I}`,D.graph=this.node.graph,D})),this.updateInnerWidgets();const b=[...f,this.node.id],v=this.node.graph?.getNodeById(f.at(-1))??void 0;for(const _ of this.innerNodes){_.graph??=this.node.graph;const I=String(_.id);_.id=I.split(":").at(-1);const D=new Yt(_,b,p,v);_.id=I,D.groupNodeHandler=this,m.push(D)}return m},this.node.recreate=async()=>{const p=this.node.id,f=this.node.size,m=this.node.convertToNodes(),y=k.createNode(this.node.type);y.id=p,y.setInnerNodes(m),y[G].populateWidgets(),h.rootGraph.add(y),y.setSize([Math.max(y.size[0],f[0]),Math.max(y.size[1],f[1])]);const v=new Ue(m).getNodeData();return y[G].groupData.nodeData.links=v.links,y[G].replaceNodes(m),y},this.node.convertToNodes=()=>{const p=u(()=>{const y={...this.groupData.nodeData};y.nodes=[...y.nodes];const b=this.node.getInnerNodes();let v=[];for(let P=0;P<y.nodes.length;P++){let K=b?.[P]?.id;K==null||isNaN(K)?K=void 0:v.push(K),y.nodes[P]={...y.nodes[P],id:K}}Qe(JSON.stringify(y),h.canvas);const[_,I]=this.node.pos;let D,E;const A=v.length?v:Object.keys(h.canvas.selected_nodes),Y=[];for(let P=0;P<A.length;P++){const K=A[P],j=h.rootGraph.getNodeById(K),Ae=b[P];if(Y.push(j),(E==null||j.pos[0]<E)&&(E=j.pos[0]),(D==null||j.pos[1]<D)&&(D=j.pos[1]),!j.widgets)continue;const ge=this.groupData.oldToNewWidgetMap[Ae.index];if(ge){const nt=Object.keys(ge);for(const Pe of nt){const Le=ge[Pe];if(!Le)continue;const fe=this.node.widgets.findIndex(z=>z.name===Le);if(fe!==-1)if(Ae.type==="PrimitiveNode")for(let z=0;z<j.widgets.length;z++)j.widgets[z].value=this.node.widgets[fe+z].value;else{const z=this.node.widgets[fe],me=j.widgets.find(Z=>Z.name===Pe);if(!me)continue;me.value=z.value;for(let Z=0;Z<z.linkedWidgets?.length;Z++)me.linkedWidgets[Z].value=z.linkedWidgets[Z].value}}}}for(const P of Y)P.pos[0]-=E-_,P.pos[1]-=D-I;return{newNodes:Y,selectedIds:A}},"addInnerNodes"),f=u(y=>{for(const b in this.groupData.oldToNewInputMap){const v=y[b],_=h.rootGraph.getNodeById(v),I=this.groupData.oldToNewInputMap[b];for(const D in I){const E=I[D];if(E==null)continue;const A=e.inputs[E];if(A.link==null)continue;const Y=h.rootGraph.links[A.link];if(!Y)continue;h.rootGraph.getNodeById(Y.origin_id).connect(Y.origin_slot,_,+D)}}},"reconnectInputs"),m=u(y=>{for(let b=0;b<e.outputs?.length;b++){const v=e.outputs[b];if(!v.links)continue;const _=[...v.links];for(const I of _){const D=this.groupData.newToOldOutputMap[b],E=h.rootGraph.links[I],A=h.rootGraph.getNodeById(E.target_id);h.rootGraph.getNodeById(y[D.node.index]).connect(D.slot,A,E.target_slot)}}},"reconnectOutputs");h.canvas.emitBeforeChange();try{const{newNodes:y,selectedIds:b}=p();return f(b),m(b),h.rootGraph.remove(this.node),y}finally{h.canvas.emitAfterChange()}};const t=this.node.getExtraMenuOptions;this.node.getExtraMenuOptions=function(p,f){t?.apply(this,arguments);let m=f.findIndex(y=>y?.content==="Outputs");m===-1?m=f.length:m++,f.splice(m,0,null,{content:"Convert to nodes",callback:u(()=>this.convertToNodes(),"callback")},{content:"Manage Group Node",callback:u(()=>Ne(this.type),"callback")})};const i=this.node.onDrawTitleBox;this.node.onDrawTitleBox=function(p,f){i?.apply(this,arguments);const m=p.fillStyle;p.beginPath(),p.rect(11,-f+11,2,2),p.rect(14,-f+11,2,2),p.rect(17,-f+11,2,2),p.rect(11,-f+14,2,2),p.rect(14,-f+14,2,2),p.rect(17,-f+14,2,2),p.rect(11,-f+17,2,2),p.rect(14,-f+17,2,2),p.rect(17,-f+17,2,2),p.fillStyle=this.boxcolor||k.NODE_DEFAULT_BOXCOLOR,p.fill(),p.fillStyle=m};const o=e.onDrawForeground,s=this.groupData.nodeData;e.onDrawForeground=function(p){o?.apply?.(this,arguments);const f=Nt().nodeProgressStates[this.id];if(f&&f.state==="running"&&this.runningInternalNodeId!==null){const m=s.nodes[this.runningInternalNodeId];if(!m)return;const y=`Running ${m.title||m.type} (${this.runningInternalNodeId}/${s.nodes.length})`;p.save(),p.font="12px sans-serif";const b=p.measureText(y);p.fillStyle=e.boxcolor||k.NODE_DEFAULT_BOXCOLOR,p.beginPath(),p.roundRect(0,-k.NODE_TITLE_HEIGHT-20,b.width+12,20,5),p.fill(),p.fillStyle="#fff",p.fillText(y,6,-k.NODE_TITLE_HEIGHT-6),p.restore()}};const a=this.node.onExecutionStart;this.node.onExecutionStart=function(){return this.resetExecution=!0,a?.apply(this,arguments)};const r=this,l=this.node.onNodeCreated;this.node.onNodeCreated=function(){if(!this.widgets)return;const p=r.groupData.nodeData.config;if(p)for(const f in p){const m=p[f]?.input;for(const y in m){if(m[y].visible!==!1)continue;const b=r.groupData.oldToNewWidgetMap[f][y],v=this.widgets.find(_=>_.name===b);v&&(v.type="hidden",v.computeSize=()=>[0,-4])}}return l?.apply(this,arguments)};function d(p,f,m){const y=u(({detail:b})=>{const v=f(b);if(!v||h.rootGraph.getNodeById(v))return;const I=this.innerNodes?.findIndex(D=>D.id==v);I>-1&&(this.node.runningInternalNodeId=I,O.dispatchCustomEvent(p,m(b,`${this.node.id}`,this.node)))},"handler");return O.addEventListener(p,y),y}u(d,"handleEvent");const c=d.call(this,"executing",p=>p,(p,f)=>f),g=d.call(this,"executed",p=>p?.display_node||p?.node,(p,f,m)=>({...p,node:f,display_node:f,merge:!m.resetExecution})),w=e.onRemoved;this.node.onRemoved=function(){w?.apply(this,arguments),O.removeEventListener("executing",c),O.removeEventListener("executed",g)},this.node.refreshComboInNode=p=>{for(const f in this.groupData.newToOldWidgetMap){const m=this.node.widgets.find(y=>y.name===f);if(m?.type==="combo"){const y=this.groupData.newToOldWidgetMap[f],b=p[y.node.type],v=b?.input?.required?.[y.inputName]??b?.input?.optional?.[y.inputName];if(!v)continue;m.options.values=v[0],y.inputName!=="image"&&!m.options.values.includes(m.value)&&(m.value=m.options.values[0],m.callback(m.value))}}}}updateInnerWidgets(){for(const e in this.groupData.newToOldWidgetMap){const t=this.node.widgets.find(r=>r.name===e);if(!t)continue;const i=t.value,o=this.groupData.newToOldWidgetMap[e];let s=this.innerNodes[o.node.index];if(s.type==="PrimitiveNode"){s.primitiveValue=i;const r=this.groupData.primitiveToWidget[o.node.index];for(const l of r??[]){const c=this.innerNodes[l.nodeId].widgets.find(g=>g.name===l.inputName);c&&(c.value=i)}continue}else if(s.type==="Reroute"){const r=this.groupData.linksFrom[o.node.index];if(r)for(const[l,,d,c]of r[0]){const g=this.innerNodes[d],w=g.inputs[c];if(w.widget){const p=g.widgets?.find(f=>f.name===w.widget.name);p&&(p.value=i)}}}const a=s.widgets?.find(r=>r.name===o.inputName);a&&(a.value=i)}}populatePrimitive(e,t,i){const o=this.groupData.widgetToPrimitive[t]?.[i];if(o==null)return;const s=this.groupData.oldToNewWidgetMap[o].value,a=this.node.widgets.findIndex(r=>r.name===s);if(a>-1){const r=this.innerNodes[o];let l=r.widgets.length;l-1!==this.node.widgets[a].linkedWidgets?.length&&(l=1);for(let d=0;d<l;d++)this.node.widgets[a+d].value=r.widgets[d].value}return!0}populateReroute(e,t,i){if(e.type!=="Reroute")return;const o=this.groupData.linksFrom[t]?.[0]?.[0];if(!o)return;const[,,s,a]=o,r=this.groupData.nodeData.nodes[s],l=r.inputs;if(!l?.[a]?.widget)return;const c=l.length-(r.widgets_values?.length??0),g=r.widgets_values?.[a-c];if(g==null)return;const w=Object.values(i)[0],p=this.node.widgets.find(f=>f.name===w);p&&(p.value=g)}populateWidgets(){if(this.node.widgets)for(let e=0;e<this.groupData.nodeData.nodes.length;e++){const t=this.groupData.nodeData.nodes[e],i=this.groupData.oldToNewWidgetMap[e]??{},o=Object.keys(i);if(!t.widgets_values?.length){this.populateReroute(t,e,i);continue}let s=0;for(let a=0;a<o.length;a++){const r=o[a],l=i[r],d=this.node.widgets.findIndex(g=>g.name===l),c=this.node.widgets[d];if(this.populatePrimitive(t,e,r)||d===-1){const g=this.innerNodes[e].widgets?.find(w=>w.name===r);s+=g?.linkedWidgets?.length??0}if(d!==-1){c.value=t.widgets_values[a+s];for(let g=0;g<c.linkedWidgets?.length;g++)this.node.widgets[d+g+1].value=t.widgets_values[a+ ++s]}}}}replaceNodes(e){let t,i;for(let o=0;o<e.length;o++){const s=e[o];(i==null||s.pos[0]<i)&&(i=s.pos[0]),(t==null||s.pos[1]<t)&&(t=s.pos[1]),this.linkOutputs(s,o),h.rootGraph.remove(s),s.id=`${this.node.id}:${o}`}this.linkInputs(),this.node.pos=[i,t]}linkOutputs(e,t){if(e.outputs)for(const i of e.outputs){if(!i.links)continue;const o=[...i.links];for(const s of o){const a=h.rootGraph.links[s];if(!a)continue;const r=h.rootGraph.getNodeById(a.target_id),l=this.groupData.oldToNewOutputMap[t]?.[a.origin_slot];l!=null&&this.node.connect(l,r,a.target_slot)}}}linkInputs(){for(const e of this.groupData.nodeData.links??[]){const[,t,i,o,s]=e,a=h.rootGraph.getNodeById(s);a&&a.connect(t,this.node.id,this.groupData.oldToNewInputMap[i][o])}}static getGroupData(e){return(e.nodeData??e.constructor?.nodeData)?.[G]}static isGroupNode(e){return!!e.constructor?.nodeData?.[G]}static async fromNodes(e){const t=new Ue(e),i=await t.build();if(!i)return;const{name:o,nodeData:s}=i;await new H(o,s).registerType();const r=k.createNode(`${R}${L}${o}`);return r.setInnerNodes(t.nodes),r[G].populateWidgets(),h.rootGraph.add(r),r[G].replaceNodes(t.nodes),r}}const eo=u(n=>{for(const e of n)typeof e.type=="string"&&e.type.startsWith("workflow/")&&(e.type=e.type.replace(/^workflow\//,`${R}${L}`))},"replaceLegacySeparators");async function ve(){const n=Object.values(h.canvas.selected_nodes??{});if(n.length===0)throw new Error("No nodes selected");if(n.length===1)throw new Error("Please select multiple nodes to convert to group node");for(const e of n){if(e instanceof It)throw new Error("Selected nodes contain a subgraph node");if(U.isGroupNode(e))throw new Error("Selected nodes contain a group node")}return await U.fromNodes(n)}u(ve,"convertSelectedNodesToGroupNode");const ze=u(n=>n.length<2||!!n.find(e=>U.isGroupNode(e)),"convertDisabled");function to(){const n=Object.values(h.canvas.selected_nodes??{});for(const e of n)U.isGroupNode(e)&&e.convertToNodes?.()}u(to,"ungroupSelectedGroupNodes");function Ne(n){new it(h).show(n)}u(Ne,"manageGroupNodes");const oo="Comfy.GroupNode";let ie;const io={name:oo,commands:[{id:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",label:"Convert selected nodes to group node",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>ve(),"function")},{id:"Comfy.GroupNode.UngroupSelectedGroupNodes",label:"Ungroup selected group nodes",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>to(),"function")},{id:"Comfy.GroupNode.ManageGroupNodes",label:"Manage group nodes",icon:"pi pi-cog",versionAdded:"1.3.17",function:u((...n)=>Ne(n[0]),"function")}],keybindings:[{commandId:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",combo:{alt:!0,key:"g"}},{commandId:"Comfy.GroupNode.UngroupSelectedGroupNodes",combo:{alt:!0,shift:!0,key:"G"}}],getCanvasMenuItems(n){const e=[],t=Object.values(n.selected_nodes??{}),i=!ze(t);e.push({content:"Convert to Group Node (Deprecated)",disabled:!i,callback:u(()=>ve(),"callback")});const o=n.graph?.extra?.groupNodes,s=!o||!Object.keys(o).length;return e.push({content:"Manage Group Nodes",disabled:s,callback:u(()=>Ne(),"callback")}),e},getNodeMenuItems(n){if(U.isGroupNode(n))return[];const e=Object.values(h.canvas.selected_nodes??{});return[{content:"Convert to Group Node (Deprecated)",disabled:!!ze(e),callback:u(()=>ve(),"callback")}]},async beforeConfigureGraph(n,e){const t=n?.extra?.groupNodes;t&&(eo(n.nodes),await H.registerFromWorkflow(t,e))},addCustomNodeDefs(n){ie=n},nodeCreated(n){U.isGroupNode(n)&&(n[G]=new U(n),n.title&&n[G]?.groupData?.nodeData&&q.storeGroupNode(n.title,n[G].groupData.nodeData))},async refreshComboInNodes(n){Object.assign(ie,n);const e=h.rootGraph.extra?.groupNodes;e&&await H.registerFromWorkflow(e,{})}};h.registerExtension(io);window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNode=window.comfyAPI.groupNode||{};window.comfyAPI.groupNode.GroupNodeConfig=H;window.comfyAPI.groupNode.GroupNodeHandler=U;function W(n,e){n.mode=e,n.graph?.change()}u(W,"setNodeMode");function Ve(n,e){const t=ee().get("Comfy.GroupSelectedNodes.Padding");n.resizeTo([...n.children,...e],t)}u(Ve,"addNodesToGroup");const so={name:"Comfy.GroupOptions",getCanvasMenuItems(n){const e=[],t=n.graph.getGroupOnPos(n.graph_mouse[0],n.graph_mouse[1]);if(!t)return n.selectedItems.size>0&&e.push({content:"Add Group For Selected Nodes",callback:u(()=>{const s=new Dt;Ve(s,n.selectedItems),n.graph.add(s),n.graph.change(),s.recomputeInsideNodes()},"callback")}),e;t.recomputeInsideNodes();const i=t.nodes;if(e.push({content:"Add Selected Nodes To Group",disabled:!n.selectedItems?.size,callback:u(()=>{Ve(t,n.selectedItems),n.graph.change()},"callback")}),i.length===0)return e;e.push(null);let o=!0;for(let s=1;s<i.length;s++)if(i[s].mode!==i[0].mode){o=!1;break}if(e.push({content:"Fit Group To Nodes",callback:u(()=>{t.recomputeInsideNodes();const s=ee().get("Comfy.GroupSelectedNodes.Padding");t.resizeTo(t.children,s),n.graph.change()},"callback")}),e.push({content:"Select Nodes",callback:u(()=>{n.selectNodes(i),n.graph.change(),n.canvas.focus()},"callback")}),o)switch(i[0].mode){case 0:e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of i)W(a,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of i)W(a,4)},"callback")});break;case 2:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of i)W(a,0)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of i)W(a,4)},"callback")});break;case 4:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of i)W(a,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of i)W(a,2)},"callback")});break;default:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of i)W(a,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of i)W(a,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of i)W(a,4)},"callback")});break}else e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const s of i)W(s,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const s of i)W(s,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const s of i)W(s,4)},"callback")});return e}};h.registerExtension(so);const no=[{label:"GLB",value:"glb"},{label:"OBJ",value:"obj"},{label:"STL",value:"stl"}];function he(n){return[null,{content:"Save",has_submenu:!0,callback:u((e,t,i,o)=>{const s=no.map(a=>({content:a.label,callback:u(()=>{(async()=>{try{await n.exportModel(a.value),S().add({severity:"success",summary:x("toastMessages.exportSuccess",{format:a.label})})}catch(r){console.error("Export failed:",r),S().addAlert(x("toastMessages.failedToExportModel",{format:a.label}))}})()},"callback")}));new k.ContextMenu(s,{event:i,parentMenu:o})},"callback")}]}u(he,"createExportMenuItems");window.comfyAPI=window.comfyAPI||{};window.comfyAPI.exportMenuHelper=window.comfyAPI.exportMenuHelper||{};window.comfyAPI.exportMenuHelper.createExportMenuItems=he;class Oe{static{u(this,"Load3DConfiguration")}constructor(e,t){this.load3d=e,this.properties=t}configureForSaveMesh(e,t){this.setupModelHandlingForSaveMesh(t,e),this.setupDefaultProperties()}configure(e){this.setupModelHandling(e.modelWidget,e.loadFolder,e.cameraState),this.setupTargetSize(e.width,e.height),this.setupDefaultProperties(e.bgImagePath)}setupTargetSize(e,t){e&&t&&(this.load3d.setTargetSize(e.value,t.value),e.callback=i=>{this.load3d.setTargetSize(i,t.value)},t.callback=i=>{this.load3d.setTargetSize(e.value,i)})}setupModelHandlingForSaveMesh(e,t){const i=this.createModelUpdateHandler(t);e&&i(e)}setupModelHandling(e,t,i){const o=this.createModelUpdateHandler(t,i);e.value&&o(e.value);const s=e.callback;let a=e.value;Object.defineProperty(e,"value",{get(){return a},set(r){a=r,e.callback&&r!==void 0&&r!==""&&e.callback(r)},enumerable:!0,configurable:!0}),e.callback=r=>{o(r),s&&s(r)}}setupDefaultProperties(e){const t=this.loadSceneConfig();this.applySceneConfig(t,e);const i=this.loadCameraConfig();this.applyCameraConfig(i);const o=this.loadLightConfig();this.applyLightConfig(o)}loadSceneConfig(){return this.properties&&"Scene Config"in this.properties?this.properties["Scene Config"]:{showGrid:ee().get("Comfy.Load3D.ShowGrid"),backgroundColor:"#"+ee().get("Comfy.Load3D.BackgroundColor"),backgroundImage:""}}loadCameraConfig(){return this.properties&&"Camera Config"in this.properties?this.properties["Camera Config"]:{cameraType:ee().get("Comfy.Load3D.CameraType"),fov:35}}loadLightConfig(){return this.properties&&"Light Config"in this.properties?this.properties["Light Config"]:{intensity:ee().get("Comfy.Load3D.LightIntensity")}}loadModelConfig(){return this.properties&&"Model Config"in this.properties?this.properties["Model Config"]:{upDirection:"original",materialMode:"original"}}applySceneConfig(e,t){if(this.load3d.toggleGrid(e.showGrid),this.load3d.setBackgroundColor(e.backgroundColor),e.backgroundImage){if(t&&t!=e.backgroundImage)return;this.load3d.setBackgroundImage(e.backgroundImage),e.backgroundRenderMode&&this.load3d.setBackgroundRenderMode(e.backgroundRenderMode)}}applyCameraConfig(e){this.load3d.toggleCamera(e.cameraType),this.load3d.setFOV(e.fov),e.state&&this.load3d.setCameraState(e.state)}applyLightConfig(e){this.load3d.setLightIntensity(e.intensity)}applyModelConfig(e){this.load3d.setUpDirection(e.upDirection),this.load3d.setMaterialMode(e.materialMode)}createModelUpdateHandler(e,t){let i=!0;return async o=>{if(!o)return;const s=o;this.setResourceFolder(s);const a=O.apiURL(V.getResourceURL(...V.splitFilePath(s),e));await this.load3d.loadModel(a,s);const r=this.loadModelConfig();if(this.applyModelConfig(r),i&&t){try{this.load3d.setCameraState(t)}catch(l){console.warn("Failed to restore camera state:",l)}i=!1}}}setResourceFolder(e){const t=e.split("/").filter(s=>s.trim());if(t.length<=2)return;const o=t.slice(1,-1).join("/");o&&this.properties&&(this.properties["Resource Folder"]=o)}}const ao={name:"image",type:"Load3D",isPreview:!1},$e={name:"image",type:"Preview3D",isPreview:!0};async function ro(n,e){if(!n?.length)return;const t=e.widgets?.find(i=>i.name==="model_file");try{const i=e.properties["Resource Folder"]||"",o=i.trim()?`3d/${i.trim()}`:"3d",s=await V.uploadFile(n[0],o);if(!s){S().addAlert(x("toastMessages.fileUploadFailed"));return}const a=O.apiURL(V.getResourceURL(...V.splitFilePath(s),"input"));ae(e).waitForLoad3d(r=>{try{r.loadModel(a)}catch{S().addAlert(x("toastMessages.failedToLoadModel"))}}),s&&t&&(t.options?.values?.includes(s)||t.options?.values?.push(s),t.value=s)}catch(i){console.error("Model upload failed:",i),S().addAlert(x("toastMessages.fileUploadFailed"))}}u(ro,"handleModelUpload");async function lo(n,e){if(n?.length)try{const t=e.properties["Resource Folder"]||"",i=t.trim()?`3d/${t.trim()}`:"3d";await V.uploadMultipleFiles(n,i)}catch(t){console.error("Extra resources upload failed:",t),S().addAlert(x("toastMessages.extraResourcesUploadFailed"))}}u(lo,"handleResourcesUpload");function je(n,e=!1){const t=document.createElement("input");return t.type="file",t.accept=n,t.multiple=e,t.style.display="none",t}u(je,"createFileInput");le().registerExtension({name:"Comfy.Load3D",settings:[{id:"Comfy.Load3D.ShowGrid",category:["3D","Scene","Initial Grid Visibility"],name:"Initial Grid Visibility",tooltip:"Controls whether the grid is visible by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"boolean",defaultValue:!0,experimental:!0},{id:"Comfy.Load3D.BackgroundColor",category:["3D","Scene","Initial Background Color"],name:"Initial Background Color",tooltip:"Controls the default background color of the 3D scene. This setting determines the background appearance when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"color",defaultValue:"282828",experimental:!0},{id:"Comfy.Load3D.CameraType",category:["3D","Camera","Initial Camera Type"],name:"Initial Camera Type",tooltip:"Controls whether the camera is perspective or orthographic by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"combo",options:["perspective","orthographic"],defaultValue:"perspective",experimental:!0},{id:"Comfy.Load3D.LightIntensity",category:["3D","Light","Initial Light Intensity"],name:"Initial Light Intensity",tooltip:"Sets the default brightness level of lighting in the 3D scene. This value determines how intensely lights illuminate objects when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"number",defaultValue:3,experimental:!0},{id:"Comfy.Load3D.LightIntensityMaximum",category:["3D","Light","Light Intensity Maximum"],name:"Light Intensity Maximum",tooltip:"Sets the maximum allowable light intensity value for 3D scenes. This defines the upper brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:10,experimental:!0},{id:"Comfy.Load3D.LightIntensityMinimum",category:["3D","Light","Light Intensity Minimum"],name:"Light Intensity Minimum",tooltip:"Sets the minimum allowable light intensity value for 3D scenes. This defines the lower brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:1,experimental:!0},{id:"Comfy.Load3D.LightAdjustmentIncrement",category:["3D","Light","Light Adjustment Increment"],name:"Light Adjustment Increment",tooltip:"Controls the increment size when adjusting light intensity in 3D scenes. A smaller step value allows for finer control over lighting adjustments, while a larger value results in more noticeable changes per adjustment.",type:"slider",attrs:{min:.1,max:1,step:.1},defaultValue:.5,experimental:!0},{id:"Comfy.Load3D.3DViewerEnable",category:["3D","3DViewer","Enable"],name:"Enable 3D Viewer (Beta)",tooltip:"Enables the 3D Viewer (Beta) for selected nodes. This feature allows you to visualize and interact with 3D models directly within the full size 3d viewer.",type:"boolean",defaultValue:!1,experimental:!0}],commands:[{id:"Comfy.3DViewer.Open3DViewer",icon:"pi pi-pencil",label:"Open 3D Viewer (Beta) for Selected Node",function:u(()=>{const n=h.canvas.selected_nodes;if(!n||Object.keys(n).length!==1)return;const e=n[Object.keys(n)[0]];if(!Tt(e))return;N.copyToClipspace(e),N.clipspace_return_node=e;const t={node:e};et().showDialog({key:"global-load3d-viewer",title:x("load3d.viewer.title"),component:Et,props:t,dialogComponentProps:{style:"width: 80vw; height: 80vh;",maximizable:!0,onClose:u(async()=>{await ue().handleViewerClose(t.node)},"onClose")}})},"function")}],getCustomWidgets(){return{LOAD_3D(n){const e=je(".gltf,.glb,.obj,.fbx,.stl",!1);n.properties["Resource Folder"]="",e.onchange=async()=>{await ro(e.files,n)},n.addWidget("button","upload 3d model","upload3dmodel",()=>{e.click()});const t=je("*",!0);t.onchange=async()=>{await lo(t.files,n),t.value=""},n.addWidget("button","upload extra resources","uploadExtraResources",()=>{t.click()}),n.addWidget("button","clear","clear",()=>{ae(n).waitForLoad3d(s=>{s.clearModel()});const o=n.widgets?.find(s=>s.name==="model_file");o&&(o.value="")});const i=new xe({node:n,name:"image",component:Ee,inputSpec:ao,options:{}});return i.type="load3D",De(n,i),{widget:i}}}},getNodeMenuItems(n){if(n.constructor.comfyClass!=="Load3D")return[];const e=ue().getLoad3d(n);return e?he(e):[]},async nodeCreated(n){if(n.constructor.comfyClass!=="Load3D")return;const[e,t]=n.size;n.setSize([Math.max(e,300),Math.max(t,600)]),await Te(),ae(n).waitForLoad3d(i=>{const s=n.properties["Camera Config"]?.state,a=new Oe(i,n.properties),r=n.widgets?.find(g=>g.name==="model_file"),l=n.widgets?.find(g=>g.name==="width"),d=n.widgets?.find(g=>g.name==="height"),c=n.widgets?.find(g=>g.name==="image");if(r&&l&&d&&c){const g={loadFolder:"input",modelWidget:r,cameraState:s,width:l,height:d};a.configure(g),c.serializeValue=async()=>{const w=St.get(n);if(!w)return console.error("No load3d instance found for node"),null;const p=n.properties["Camera Config"]||{cameraType:w.getCurrentCameraType(),fov:w.cameraManager.perspectiveCamera.fov};p.state=w.getCameraState(),n.properties["Camera Config"]=p,w.stopRecording();const{scene:f,mask:m,normal:y}=await w.captureScene(l.value,d.value),[b,v,_]=await Promise.all([V.uploadTempImage(f,"scene"),V.uploadTempImage(m,"scene_mask"),V.uploadTempImage(y,"scene_normal")]);w.handleResize();const I={image:`threed/${b.name} [temp]`,mask:`threed/${v.name} [temp]`,normal:`threed/${_.name} [temp]`,camera_info:n.properties["Camera Config"]?.state||null,recording:""},D=w.getRecordingData();if(D){const[E]=await Promise.all([V.uploadTempImage(D,"recording","mp4")]);I.recording=`threed/${E.name} [temp]`}return I}}})}});le().registerExtension({name:"Comfy.Preview3D",async beforeRegisterNodeDef(n,e){e.name==="Preview3D"&&(e.input.required.image=["PREVIEW_3D"])},getNodeMenuItems(n){if(n.constructor.comfyClass!=="Preview3D")return[];const e=ue().getLoad3d(n);return e?he(e):[]},getCustomWidgets(){return{PREVIEW_3D(n){const e=new xe({node:n,name:$e.name,component:Ee,inputSpec:$e,options:{}});return e.type="load3D",De(n,e),{widget:e}}}},async nodeCreated(n){if(n.constructor.comfyClass!=="Preview3D")return;const[e,t]=n.size;n.setSize([Math.max(e,400),Math.max(t,550)]),await Te();const i=n.onExecuted;ae(n).waitForLoad3d(o=>{const s=new Oe(o,n.properties),a=n.widgets?.find(r=>r.name==="model_file");if(a){const r=n.properties["Last Time Model File"];if(r){a.value=r;const d=n.properties["Camera Config"]?.state,c={loadFolder:"output",modelWidget:a,cameraState:d};s.configure(c)}n.onExecuted=function(l){i?.apply(this,arguments);let d=l.result[0];if(!d){const p=x("toastMessages.unableToGetModelFilePath");console.error(p),S().addAlert(p)}let c=l.result[1],g=l.result[2];a.value=d.replaceAll("\\","/"),n.properties["Last Time Model File"]=a.value;const w={loadFolder:"output",modelWidget:a,cameraState:c,bgImagePath:g};s.configure(w),g&&o.setBackgroundImage(g)}}})}});function co(n){const e=n.split(";base64,"),t=e[0].split(":")[1],i=atob(e[1]),o=new ArrayBuffer(i.length),s=new Uint8Array(o);for(let a=0;a<i.length;a++)s[a]=i.charCodeAt(a);return new Blob([o],{type:t})}u(co,"dataURLToBlob");function uo(n){return new Promise(e=>{const t=new Image;t.onload=function(){e(t)},t.src=n})}u(uo,"loadImage");async function po(n,e){await O.fetchApi("/upload/mask",{method:"POST",body:e}).catch(t=>{console.error("Error:",t)}),N.clipspace.imgs[N.clipspace.selectedIndex]=new Image,N.clipspace.imgs[N.clipspace.selectedIndex].src=O.apiURL("/view?"+new URLSearchParams(n).toString()+h.getPreviewFormatParam()+h.getRandParam()),N.clipspace.images&&(N.clipspace.images[N.clipspace.selectedIndex]=n),M.invalidatePreview()}u(po,"uploadMask");function ho(n,e,t,i){t.drawImage(n,0,0,e.width,e.height);const o=t.getImageData(0,0,e.width,e.height);for(let s=0;s<o.data.length;s+=4)o.data[s+3]==255?o.data[s+3]=0:o.data[s+3]=255,o.data[s]=i.r,o.data[s+1]=i.g,o.data[s+2]=i.b;t.globalCompositeOperation="source-over",t.putImageData(o,0,0)}u(ho,"prepare_mask");class T extends Ie{static{u(this,"MaskEditorDialogOld")}static instance=null;static mousedown_x=null;static mousedown_y=null;brush;maskCtx;maskCanvas;brush_size_slider;brush_opacity_slider;colorButton;saveButton;zoom_ratio;pan_x;pan_y;imgCanvas;last_display_style;is_visible;image;handler_registered;brush_slider_input;cursorX;cursorY;mousedown_pan_x;mousedown_pan_y;last_pressure;pointer_type;brush_pointer_type_select;static getInstance(){return T.instance||(T.instance=new T),T.instance}is_layout_created=!1;constructor(){super(),this.element=C("div.comfy-modal",{parent:document.body},[C("div.comfy-modal-content",[...this.createButtons()])])}createButtons(){return[]}createButton(e,t){var i=document.createElement("button");return i.style.pointerEvents="auto",i.innerText=e,i.addEventListener("click",t),i}createLeftButton(e,t){var i=this.createButton(e,t);return i.style.cssFloat="left",i.style.marginRight="4px",i}createRightButton(e,t){var i=this.createButton(e,t);return i.style.cssFloat="right",i.style.marginLeft="4px",i}createLeftSlider(e,t,i){const o=document.createElement("div");o.id="maskeditor-slider",o.style.cssFloat="left",o.style.fontFamily="sans-serif",o.style.marginRight="4px",o.style.color="var(--input-text)",o.style.backgroundColor="var(--comfy-input-bg)",o.style.borderRadius="8px",o.style.borderColor="var(--border-color)",o.style.borderStyle="solid",o.style.fontSize="15px",o.style.height="25px",o.style.padding="1px 6px",o.style.display="flex",o.style.position="relative",o.style.top="2px",o.style.pointerEvents="auto",e.brush_slider_input=document.createElement("input"),e.brush_slider_input.setAttribute("type","range"),e.brush_slider_input.setAttribute("min","1"),e.brush_slider_input.setAttribute("max","100"),e.brush_slider_input.setAttribute("value","10");const s=document.createElement("label");return s.textContent=t,o.appendChild(s),o.appendChild(e.brush_slider_input),e.brush_slider_input.addEventListener("change",i),o}createOpacitySlider(e,t,i){const o=document.createElement("div");o.id="maskeditor-opacity-slider",o.style.cssFloat="left",o.style.fontFamily="sans-serif",o.style.marginRight="4px",o.style.color="var(--input-text)",o.style.backgroundColor="var(--comfy-input-bg)",o.style.borderRadius="8px",o.style.borderColor="var(--border-color)",o.style.borderStyle="solid",o.style.fontSize="15px",o.style.height="25px",o.style.padding="1px 6px",o.style.display="flex",o.style.position="relative",o.style.top="2px",o.style.pointerEvents="auto",e.opacity_slider_input=document.createElement("input"),e.opacity_slider_input.setAttribute("type","range"),e.opacity_slider_input.setAttribute("min","0.1"),e.opacity_slider_input.setAttribute("max","1.0"),e.opacity_slider_input.setAttribute("step","0.01"),e.opacity_slider_input.setAttribute("value","0.7");const s=document.createElement("label");return s.textContent=t,o.appendChild(s),o.appendChild(e.opacity_slider_input),e.opacity_slider_input.addEventListener("input",i),o}createPointerTypeSelect(e){const t=document.createElement("div");t.id="maskeditor-pointer-type",t.style.cssFloat="left",t.style.fontFamily="sans-serif",t.style.marginRight="4px",t.style.color="var(--input-text)",t.style.backgroundColor="var(--comfy-input-bg)",t.style.borderRadius="8px",t.style.borderColor="var(--border-color)",t.style.borderStyle="solid",t.style.fontSize="15px",t.style.height="25px",t.style.padding="1px 6px",t.style.display="flex",t.style.position="relative",t.style.top="2px",t.style.pointerEvents="auto";const i=document.createElement("label");i.textContent="Pointer Type:";const o=document.createElement("select");o.style.borderRadius="0",o.style.borderColor="transparent",o.style.borderStyle="unset",o.style.fontSize="0.9em";const s=document.createElement("option");s.value="arc",s.text="Circle",s.selected=!0;const a=document.createElement("option");return a.value="rect",a.text="Square",o.appendChild(s),o.appendChild(a),o.addEventListener("change",r=>{const l=r.target;e.pointer_type=l.value,this.setBrushBorderRadius(e)}),t.appendChild(i),t.appendChild(o),t}setBrushBorderRadius(e){e.pointer_type==="rect"?(this.brush.style.borderRadius="0%",this.brush.style.MozBorderRadius="0%",this.brush.style.WebkitBorderRadius="0%"):(this.brush.style.borderRadius="50%",this.brush.style.MozBorderRadius="50%",this.brush.style.WebkitBorderRadius="50%")}setlayout(e,t){const i=this;i.pointer_type="arc";var o=document.createElement("div");o.style.position="absolute",o.style.bottom="0px",o.style.left="20px",o.style.right="20px",o.style.height="50px",o.style.pointerEvents="none";var s=document.createElement("div");s.id="brush",s.style.backgroundColor="transparent",s.style.outline="1px dashed black",s.style.boxShadow="0 0 0 1px white",s.style.position="absolute",s.style.zIndex="8889",s.style.pointerEvents="none",this.brush=s,this.setBrushBorderRadius(i),this.element.appendChild(e),this.element.appendChild(t),this.element.appendChild(o),document.body.appendChild(s);var a=this.createLeftButton("Clear",()=>{i.maskCtx.clearRect(0,0,i.maskCanvas.width,i.maskCanvas.height)});this.brush_size_slider=this.createLeftSlider(i,"Thickness",d=>{i.brush_size=d.target.value,i.updateBrushPreview(i)}),this.brush_opacity_slider=this.createOpacitySlider(i,"Opacity",d=>{i.brush_opacity=d.target.value,i.brush_color_mode!=="negative"&&(i.maskCanvas.style.opacity=i.brush_opacity.toString())}),this.brush_pointer_type_select=this.createPointerTypeSelect(i),this.colorButton=this.createLeftButton(this.getColorButtonText(),()=>{i.brush_color_mode==="black"?i.brush_color_mode="white":i.brush_color_mode==="white"?i.brush_color_mode="negative":i.brush_color_mode="black",i.updateWhenBrushColorModeChanged()});var r=this.createRightButton("Cancel",()=>{document.removeEventListener("keydown",T.handleKeyDown),i.close()});this.saveButton=this.createRightButton("Save",()=>{document.removeEventListener("keydown",T.handleKeyDown),i.save()}),this.element.appendChild(e),this.element.appendChild(t),this.element.appendChild(o),o.appendChild(a),o.appendChild(this.saveButton),o.appendChild(r),o.appendChild(this.brush_size_slider),o.appendChild(this.brush_opacity_slider),o.appendChild(this.brush_pointer_type_select),o.appendChild(this.colorButton),e.style.position="absolute",t.style.position="absolute",e.style.top="200",e.style.left="0",t.style.top=e.style.top,t.style.left=e.style.left;const l=this.getMaskCanvasStyle();t.style.mixBlendMode=l.mixBlendMode,t.style.opacity=l.opacity.toString()}async show(){if(this.zoom_ratio=1,this.pan_x=0,this.pan_y=0,!this.is_layout_created){const e=document.createElement("canvas"),t=document.createElement("canvas");e.id="imageCanvas",t.id="maskCanvas",this.setlayout(e,t),this.imgCanvas=e,this.maskCanvas=t,this.maskCtx=t.getContext("2d",{willReadFrequently:!0}),this.setEventHandler(t),this.is_layout_created=!0;const i=this,o=new MutationObserver(function(a){a.forEach(function(r){r.type==="attributes"&&r.attributeName==="style"&&(i.last_display_style&&i.last_display_style!="none"&&i.element.style.display=="none"&&(i.brush.style.display="none",N.onClipspaceEditorClosed()),i.last_display_style=i.element.style.display)})}),s={attributes:!0};o.observe(this.element,s)}document.addEventListener("keydown",T.handleKeyDown),N.clipspace_return_node?this.saveButton.innerText="Save to node":this.saveButton.innerText="Save",this.saveButton.disabled=!1,this.element.style.display="block",this.element.style.width="85%",this.element.style.margin="0 7.5%",this.element.style.height="100vh",this.element.style.top="50%",this.element.style.left="42%",this.element.style.zIndex="8888",await this.setImages(this.imgCanvas),this.is_visible=!0}isOpened(){return this.element.style.display=="block"}invalidateCanvas(e,t){this.imgCanvas.width=e.width,this.imgCanvas.height=e.height,this.maskCanvas.width=e.width,this.maskCanvas.height=e.height;let i=this.imgCanvas.getContext("2d",{willReadFrequently:!0}),o=this.maskCanvas.getContext("2d",{willReadFrequently:!0});i.drawImage(e,0,0,e.width,e.height),ho(t,this.maskCanvas,o,this.getMaskColor())}async setImages(e){let t=this;const i=e.getContext("2d",{willReadFrequently:!0}),o=this.maskCtx,s=this.maskCanvas;i.clearRect(0,0,this.imgCanvas.width,this.imgCanvas.height),o.clearRect(0,0,this.maskCanvas.width,this.maskCanvas.height);const a=new URL(N.clipspace.imgs[N.clipspace.selectedIndex].src);a.searchParams.delete("channel"),a.searchParams.delete("preview"),a.searchParams.set("channel","a");let r=await uo(a);const l=new URL(N.clipspace.imgs[N.clipspace.selectedIndex].src);l.searchParams.delete("channel"),l.searchParams.set("channel","rgb"),this.image=new Image,this.image.onload=function(){s.width=t.image.width,s.height=t.image.height,t.invalidateCanvas(t.image,r),t.initializeCanvasPanZoom()},this.image.src=l.toString()}initializeCanvasPanZoom(){let e=this.image.width,t=this.image.height,i=this.element.clientWidth,o=this.element.clientHeight;this.image.width>i&&(e=i,t=e/this.image.width*this.image.height),t>o&&(t=o,e=t/this.image.height*this.image.width),this.zoom_ratio=e/this.image.width;const s=(i-e)/2,a=(o-t)/2;this.pan_x=s,this.pan_y=a,this.invalidatePanZoom()}invalidatePanZoom(){let e=this.image.width*this.zoom_ratio,t=this.image.height*this.zoom_ratio;this.pan_x+e<10&&(this.pan_x=10-e),this.pan_y+t<10&&(this.pan_y=10-t);let i=`${e}px`,o=`${t}px`,s=`${this.pan_x}px`,a=`${this.pan_y}px`;this.maskCanvas.style.width=i,this.maskCanvas.style.height=o,this.maskCanvas.style.left=s,this.maskCanvas.style.top=a,this.imgCanvas.style.width=i,this.imgCanvas.style.height=o,this.imgCanvas.style.left=s,this.imgCanvas.style.top=a}setEventHandler(e){const t=this;this.handler_registered||(e.addEventListener("contextmenu",i=>{i.preventDefault()}),this.element.addEventListener("wheel",i=>this.handleWheelEvent(t,i)),this.element.addEventListener("pointermove",i=>this.pointMoveEvent(t,i)),this.element.addEventListener("touchmove",i=>this.pointMoveEvent(t,i)),this.element.addEventListener("dragstart",i=>{i.ctrlKey&&i.preventDefault()}),e.addEventListener("pointerdown",i=>this.handlePointerDown(t,i)),e.addEventListener("pointermove",i=>this.draw_move(t,i)),e.addEventListener("touchmove",i=>this.draw_move(t,i)),e.addEventListener("pointerover",()=>{this.brush.style.display="block"}),e.addEventListener("pointerleave",()=>{this.brush.style.display="none"}),document.addEventListener("pointerup",T.handlePointerUp),this.handler_registered=!0)}getMaskCanvasStyle(){return this.brush_color_mode==="negative"?{mixBlendMode:"difference",opacity:"1"}:{mixBlendMode:"initial",opacity:this.brush_opacity}}getMaskColor(){return this.brush_color_mode==="black"?{r:0,g:0,b:0}:this.brush_color_mode==="white"?{r:255,g:255,b:255}:this.brush_color_mode==="negative"?{r:255,g:255,b:255}:{r:0,g:0,b:0}}getMaskFillStyle(){const e=this.getMaskColor();return"rgb("+e.r+","+e.g+","+e.b+")"}getColorButtonText(){let e="unknown";return this.brush_color_mode==="black"?e="black":this.brush_color_mode==="white"?e="white":this.brush_color_mode==="negative"&&(e="negative"),"Color: "+e}updateWhenBrushColorModeChanged(){this.colorButton.innerText=this.getColorButtonText();const e=this.getMaskCanvasStyle();this.maskCanvas.style.mixBlendMode=e.mixBlendMode,this.maskCanvas.style.opacity=e.opacity.toString();const t=this.getMaskColor(),i=this.maskCtx.getImageData(0,0,this.maskCanvas.width,this.maskCanvas.height);for(let o=0;o<i.data.length;o+=4)i.data[o]=t.r,i.data[o+1]=t.g,i.data[o+2]=t.b;this.maskCtx.putImageData(i,0,0)}brush_opacity=.7;brush_size=10;brush_color_mode="black";drawing_mode=!1;lastx=-1;lasty=-1;lasttime=0;static handleKeyDown(e){const t=T.instance;e.key==="]"?(t.brush_size=Math.min(t.brush_size+2,100),t.brush_slider_input.value=t.brush_size):e.key==="["?(t.brush_size=Math.max(t.brush_size-2,1),t.brush_slider_input.value=t.brush_size):e.key==="Enter"&&t.save(),t.updateBrushPreview(t)}static handlePointerUp(e){e.preventDefault(),this.mousedown_x=null,this.mousedown_y=null,T.instance.drawing_mode=!1}updateBrushPreview(e){const t=e.brush;var i=e.cursorX,o=e.cursorY;t.style.width=e.brush_size*2*this.zoom_ratio+"px",t.style.height=e.brush_size*2*this.zoom_ratio+"px",t.style.left=i-e.brush_size*this.zoom_ratio+"px",t.style.top=o-e.brush_size*this.zoom_ratio+"px"}handleWheelEvent(e,t){t.preventDefault(),t.ctrlKey?(t.deltaY<0?this.zoom_ratio=Math.min(10,this.zoom_ratio+.2):this.zoom_ratio=Math.max(.2,this.zoom_ratio-.2),this.invalidatePanZoom()):(t.deltaY<0?this.brush_size=Math.min(this.brush_size+2,100):this.brush_size=Math.max(this.brush_size-2,1),this.brush_slider_input.value=this.brush_size.toString(),this.updateBrushPreview(this))}pointMoveEvent(e,t){this.cursorX=t.pageX,this.cursorY=t.pageY,e.updateBrushPreview(e),t.ctrlKey&&(t.preventDefault(),e.pan_move(e,t));let i=window.TouchEvent&&t instanceof TouchEvent||t.buttons==1;if(t.shiftKey&&i){e.drawing_mode=!1;const o=t.clientY;let s=(e.zoom_lasty-o)*.005;e.zoom_ratio=Math.max(Math.min(10,e.last_zoom_ratio-s),.2),this.invalidatePanZoom();return}}pan_move(e,t){if(t.buttons==1&&T.mousedown_x){let i=T.mousedown_x-t.clientX,o=T.mousedown_y-t.clientY;e.pan_x=this.mousedown_pan_x-i,e.pan_y=this.mousedown_pan_y-o,e.invalidatePanZoom()}}draw_move(e,t){if(t.ctrlKey||t.shiftKey)return;t.preventDefault(),this.cursorX=t.pageX,this.cursorY=t.pageY,e.updateBrushPreview(e);let i=window.TouchEvent&&t instanceof TouchEvent||t.buttons==1,o=[2,5,32].includes(t.buttons);if(!t.altKey&&i){var s=performance.now()-e.lasttime;const d=e.maskCanvas.getBoundingClientRect();var a=t.offsetX,r=t.offsetY;t.offsetX==null&&(a=t.targetTouches[0].clientX-d.left),t.offsetY==null&&(r=t.targetTouches[0].clientY-d.top),a/=e.zoom_ratio,r/=e.zoom_ratio;var l=this.brush_size;t instanceof PointerEvent&&t.pointerType=="pen"?(l*=t.pressure,this.last_pressure=t.pressure):window.TouchEvent&&t instanceof TouchEvent&&s<20?l*=this.last_pressure:l=this.brush_size,s>20&&!this.drawing_mode?requestAnimationFrame(()=>{e.init_shape(e,"source-over"),e.draw_shape(e,a,r,l),e.lastx=a,e.lasty=r}):requestAnimationFrame(()=>{e.init_shape(e,"source-over");for(var c=a-e.lastx,g=r-e.lasty,w=Math.sqrt(c*c+g*g),p=c/w,f=g/w,m=0;m<w;m+=5){var y=e.lastx+p*m,b=e.lasty+f*m;e.draw_shape(e,y,b,l)}e.lastx=a,e.lasty=r}),e.lasttime=performance.now()}else if(t.altKey&&i||o){const d=e.maskCanvas.getBoundingClientRect(),c=(t.offsetX||t.targetTouches[0].clientX-d.left)/e.zoom_ratio,g=(t.offsetY||t.targetTouches[0].clientY-d.top)/e.zoom_ratio;var l=this.brush_size;t instanceof PointerEvent&&t.pointerType=="pen"?(l*=t.pressure,this.last_pressure=t.pressure):window.TouchEvent&&t instanceof TouchEvent&&s<20?l*=this.last_pressure:l=this.brush_size,s>20&&!this.drawing_mode?requestAnimationFrame(()=>{e.init_shape(e,"destination-out"),e.draw_shape(e,c,g,l),e.lastx=c,e.lasty=g}):requestAnimationFrame(()=>{e.init_shape(e,"destination-out");for(var p=c-e.lastx,f=g-e.lasty,m=Math.sqrt(p*p+f*f),y=p/m,b=f/m,v=0;v<m;v+=5){var _=e.lastx+y*v,I=e.lasty+b*v;e.draw_shape(e,_,I,l)}e.lastx=c,e.lasty=g}),e.lasttime=performance.now()}}handlePointerDown(e,t){if(t.ctrlKey){t.buttons==1&&(T.mousedown_x=t.clientX,T.mousedown_y=t.clientY,this.mousedown_pan_x=this.pan_x,this.mousedown_pan_y=this.pan_y);return}var i=this.brush_size;if(t instanceof PointerEvent&&t.pointerType=="pen"&&(i*=t.pressure,this.last_pressure=t.pressure),[0,2,5].includes(t.button)){if(e.drawing_mode=!0,t.preventDefault(),t.shiftKey){e.zoom_lasty=t.clientY,e.last_zoom_ratio=e.zoom_ratio;return}const o=e.maskCanvas.getBoundingClientRect(),s=(t.offsetX||t.targetTouches[0].clientX-o.left)/e.zoom_ratio,a=(t.offsetY||t.targetTouches[0].clientY-o.top)/e.zoom_ratio;!t.altKey&&t.button==0?e.init_shape(e,"source-over"):e.init_shape(e,"destination-out"),e.draw_shape(e,s,a,i),e.lastx=s,e.lasty=a,e.lasttime=performance.now()}}init_shape(e,t){e.maskCtx.beginPath(),t=="source-over"?(e.maskCtx.fillStyle=this.getMaskFillStyle(),e.maskCtx.globalCompositeOperation="source-over"):t=="destination-out"&&(e.maskCtx.globalCompositeOperation="destination-out")}draw_shape(e,t,i,o){e.pointer_type==="rect"?e.maskCtx.rect(t-o,i-o,o*2,o*2):e.maskCtx.arc(t,i,o,0,Math.PI*2,!1),e.maskCtx.fill()}async save(){const e=document.createElement("canvas"),t=e.getContext("2d",{willReadFrequently:!0});e.width=this.image.width,e.height=this.image.height,t.clearRect(0,0,e.width,e.height),t.drawImage(this.maskCanvas,0,0,this.maskCanvas.width,this.maskCanvas.height,0,0,e.width,e.height);const i=t.getImageData(0,0,e.width,e.height);for(let p=0;p<i.data.length;p+=4)i.data[p+3]==255?i.data[p+3]=0:i.data[p+3]=255,i.data[p]=0,i.data[p+1]=0,i.data[p+2]=0;t.globalCompositeOperation="source-over",t.putImageData(i,0,0);const o=new FormData,s="clipspace-mask-"+performance.now()+".png",a={filename:s,subfolder:"clipspace",type:"input"};if(N.clipspace.images&&(N.clipspace.images[0]=a),N.clipspace.widgets){const p=N.clipspace.widgets.findIndex(f=>f.name==="image");p>=0&&(N.clipspace.widgets[p].value=a)}const r=e.toDataURL(),l=co(r);let d=new URL(this.image.src);const c={filename:d.searchParams.get("filename")};let g=d.searchParams.get("subfolder");g&&(c.subfolder=g);let w=d.searchParams.get("type");w&&(c.type=w),o.append("image",l,s),o.append("original_ref",JSON.stringify(c)),o.append("type","input"),o.append("subfolder","clipspace"),this.saveButton.innerText="Saving...",this.saveButton.disabled=!0,await po(a,o),N.onClipspaceEditorSave(),this.close()}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.maskEditorOld=window.comfyAPI.maskEditorOld||{};window.comfyAPI.maskEditorOld.MaskEditorDialogOld=T;const st=u(()=>{const n=x("toastMessages.legacyMaskEditorDeprecated");console.warn(`[Comfy.MaskEditor] ${n}`),S().add({severity:"warn",summary:"Alert",detail:n,life:4096})},"warnLegacyMaskEditorDeprecation");function go(n){if(!n){console.error("[MaskEditor] No node provided");return}if(!n.imgs?.length&&n.previewMediaType!=="image"){console.error("[MaskEditor] Node has no images");return}if(h.extensionManager.setting.get("Comfy.MaskEditor.UseNewEditor"))Ot().openMaskEditor(n);else{st(),N.copyToClipspace(n),N.clipspace_return_node=n;const t=T.getInstance();t?.isOpened&&!t.isOpened()&&t.show()}}u(go,"openMaskEditor");function fo(){return h.extensionManager.setting.get("Comfy.MaskEditor.UseNewEditor")?et().isDialogOpen("global-mask-editor"):T.instance?.isOpened?.()??!1}u(fo,"isOpened");h.registerExtension({name:"Comfy.MaskEditor",settings:[{id:"Comfy.MaskEditor.UseNewEditor",category:["Mask Editor","NewEditor"],name:"Use new mask editor",tooltip:"Switch to the new mask editor interface",type:"boolean",defaultValue:!0,experimental:!0},{id:"Comfy.MaskEditor.BrushAdjustmentSpeed",category:["Mask Editor","BrushAdjustment","Sensitivity"],name:"Brush adjustment speed multiplier",tooltip:"Controls how quickly the brush size and hardness change when adjusting. Higher values mean faster changes.",experimental:!0,type:"slider",attrs:{min:.1,max:2,step:.1},defaultValue:1,versionAdded:"1.0.0"},{id:"Comfy.MaskEditor.UseDominantAxis",category:["Mask Editor","BrushAdjustment","UseDominantAxis"],name:"Lock brush adjustment to dominant axis",tooltip:"When enabled, brush adjustments will only affect size OR hardness based on which direction you move more",type:"boolean",defaultValue:!0,experimental:!0}],commands:[{id:"Comfy.MaskEditor.OpenMaskEditor",icon:"pi pi-pencil",label:"Open Mask Editor for Selected Node",function:u(()=>{const n=h.canvas.selected_nodes;if(!n||Object.keys(n).length!==1)return;const e=n[Object.keys(n)[0]];go(e)},"function")},{id:"Comfy.MaskEditor.BrushSize.Increase",icon:"pi pi-plus-circle",label:"Increase Brush Size in MaskEditor",function:u(()=>Ye(n=>X.clamp(n+4,1,100)),"function")},{id:"Comfy.MaskEditor.BrushSize.Decrease",icon:"pi pi-minus-circle",label:"Decrease Brush Size in MaskEditor",function:u(()=>Ye(n=>X.clamp(n-4,1,100)),"function")}],init(){const n=u(()=>{if(!h.extensionManager.setting.get("Comfy.MaskEditor.UseNewEditor")){st();const i=T.getInstance();i?.isOpened&&!i.isOpened()&&i.show()}},"openMaskEditorFromClipspace"),e=u(()=>!!(N.clipspace&&N.clipspace.imgs&&N.clipspace.imgs.length>0),"context_predicate");M.registerButton("MaskEditor",e,n)}});const Ye=u(async n=>{if(!fo())return;const e=Mt(),t=e.brushSettings.size,i=n(t);e.setBrushSize(i)},"changeBrushSize"),mo="Comfy.NodeTemplates",Xe="comfy.templates.json";class yo extends Ie{static{u(this,"ManageTemplates")}templates;draggedEl;saveVisualCue;emptyImg;importInput;constructor(){super(),this.load().then(e=>{this.templates=e}),this.element.classList.add("comfy-manage-templates"),this.draggedEl=null,this.saveVisualCue=null,this.emptyImg=new Image,this.emptyImg.src="data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=",this.importInput=C("input",{type:"file",accept:".json",multiple:!0,style:{display:"none"},parent:document.body,onchange:u(()=>this.importAll(),"onchange")})}createButtons(){const e=super.createButtons();return e[0].textContent="Close",e[0].onclick=()=>{clearTimeout(this.saveVisualCue),this.close()},e.unshift(C("button",{type:"button",textContent:"Export",onclick:u(()=>this.exportAll(),"onclick")})),e.unshift(C("button",{type:"button",textContent:"Import",onclick:u(()=>{this.importInput.click()},"onclick")})),e}async load(){let e=[];const t=await O.getUserData(Xe);if(t.status===200)try{e=await t.json()}catch{}else t.status!==404&&console.error(t.status+" "+t.statusText);return e??[]}async store(){const e=JSON.stringify(this.templates,void 0,4);try{await O.storeUserData(Xe,e,{stringify:!1})}catch(t){console.error(t),S().addAlert(t.message)}}async importAll(){for(const e of this.importInput.files)if(e.type==="application/json"||e.name.endsWith(".json")){const t=new FileReader;t.onload=async()=>{const i=JSON.parse(t.result);if(i?.templates){for(const o of i.templates)o?.name&&o?.data&&this.templates.push(o);await this.store()}},await t.readAsText(e)}this.importInput.value=null,this.close()}exportAll(){if(this.templates.length==0){S().addAlert(x("toastMessages.noTemplatesToExport"));return}const e=JSON.stringify({templates:this.templates},null,2),t=new Blob([e],{type:"application/json"});We("node_templates.json",t)}show(){super.show(C("div",{},this.templates.flatMap((e,t)=>{let i;return[C("div",{dataset:{id:t.toString()},className:"templateManagerRow",style:{display:"grid",gridTemplateColumns:"1fr auto",border:"1px dashed transparent",gap:"5px",backgroundColor:"var(--comfy-menu-bg)"},ondragstart:u(o=>{this.draggedEl=o.currentTarget,o.currentTarget.style.opacity="0.6",o.currentTarget.style.border="1px dashed yellow",o.dataTransfer.effectAllowed="move",o.dataTransfer.setDragImage(this.emptyImg,0,0)},"ondragstart"),ondragend:u(o=>{o.target.style.opacity="1",o.currentTarget.style.border="1px dashed transparent",o.currentTarget.removeAttribute("draggable"),this.element.querySelectorAll(".templateManagerRow").forEach((s,a)=>{var r=Number.parseInt(s.dataset.id);s==this.draggedEl&&r!=a&&this.templates.splice(a,0,this.templates.splice(r,1)[0]),s.dataset.id=a.toString()}),this.store()},"ondragend"),ondragover:u(o=>{if(o.preventDefault(),o.currentTarget==this.draggedEl)return;let s=o.currentTarget.getBoundingClientRect();o.clientY>s.top+s.height/2?o.currentTarget.parentNode.insertBefore(this.draggedEl,o.currentTarget.nextSibling):o.currentTarget.parentNode.insertBefore(this.draggedEl,o.currentTarget)},"ondragover")},[C("label",{textContent:"Name: ",style:{cursor:"grab"},onmousedown:u(o=>{o.target.localName=="label"&&(o.currentTarget.parentNode.draggable="true")},"onmousedown")},[C("input",{value:e.name,dataset:{name:e.name},style:{transitionProperty:"background-color",transitionDuration:"0s"},onchange:u(o=>{clearTimeout(this.saveVisualCue);var s=o.target,a=s.parentNode.parentNode;this.templates[a.dataset.id].name=s.value.trim()||"untitled",this.store(),s.style.backgroundColor="rgb(40, 95, 40)",s.style.transitionDuration="0s",this.saveVisualCue=setTimeout(function(){s.style.transitionDuration=".7s",s.style.backgroundColor="var(--comfy-input-bg)"},15)},"onchange"),onkeypress:u(o=>{var s=o.target;clearTimeout(this.saveVisualCue),s.style.transitionDuration="0s",s.style.backgroundColor="var(--comfy-input-bg)"},"onkeypress"),$:u(o=>i=o,"$")})]),C("div",{},[C("button",{textContent:"Export",style:{fontSize:"12px",fontWeight:"normal"},onclick:u(()=>{const o=JSON.stringify({templates:[e]},null,2),s=new Blob([o],{type:"application/json"}),a=(i.value||e.name)+".json";We(a,s)},"onclick")}),C("button",{textContent:"Delete",style:{fontSize:"12px",color:"red",fontWeight:"normal"},onclick:u(o=>{const s=o.target.parentNode.parentNode;s.parentNode.removeChild(s),this.templates.splice(s.dataset.id*1,1),this.store();var a=this;setTimeout(function(){a.element.querySelectorAll(".templateManagerRow").forEach((r,l)=>{r.dataset.id=l.toString()})},0)},"onclick")})])])]})))}}const de=new yo,qe=u(async n=>{const e=localStorage.getItem("litegrapheditor_clipboard");await n(),localStorage.setItem("litegrapheditor_clipboard",e)},"clipboardAction"),wo={name:mo,getCanvasMenuItems(n){const e=[];e.push(null),e.push({content:"Save Selected as Template",disabled:!Object.keys(h.canvas.selected_nodes||{}).length,callback:u(async()=>{const i=await te().prompt({title:x("nodeTemplates.saveAsTemplate"),message:x("nodeTemplates.enterName"),defaultValue:""});i?.trim()&&qe(()=>{h.canvas.copyToClipboard();let o=localStorage.getItem("litegrapheditor_clipboard");o=JSON.parse(o||"{}");const s=Object.keys(h.canvas.selected_nodes);for(let a=0;a<s.length;a++){const r=h.canvas.graph?.getNodeById(s[a]),l=r?.constructor.nodeData;let d=U.getGroupData(r);if(d){if(d=d.nodeData,o.groupNodes||(o.groupNodes={}),l==null)throw new TypeError("nodeData is not set");o.groupNodes[l.name]=d,o.nodes[a].type=l.name}}de.templates.push({name:i,data:JSON.stringify(o)}),de.store()})},"callback")});const t=de.templates.map(i=>({content:i.name,callback:u(()=>{qe(async()=>{const o=JSON.parse(i.data);await H.registerFromWorkflow(o.groupNodes,{}),o.reroutes?(localStorage.setItem("litegrapheditor_clipboard",i.data),h.canvas.pasteFromClipboard()):Qe(i.data,h.canvas)})},"callback")}));return t.push(null,{content:"Manage",callback:u(()=>de.show(),"callback")}),e.push({content:"Node Templates",submenu:{options:t}}),e}};h.registerExtension(wo);h.registerExtension({name:"Comfy.NoteNode",registerCustomNodes(){class n extends ce{static{u(this,"NoteNode")}static category;static collapsable;static title_mode;groupcolor=F.node_colors.yellow.groupcolor;isVirtualNode;constructor(i){super(i),this.color=F.node_colors.yellow.color,this.bgcolor=F.node_colors.yellow.bgcolor,this.properties||(this.properties={text:""}),$.STRING(this,"text",["STRING",{default:this.properties.text,multiline:!0}],h),this.serialize_widgets=!0,this.isVirtualNode=!0}}k.registerNodeType("Note",Object.assign(n,{title_mode:k.NORMAL_TITLE,title:"Note",collapsable:!0})),n.category="utils";class e extends ce{static{u(this,"MarkdownNoteNode")}static title="Markdown Note";groupcolor=F.node_colors.yellow.groupcolor;constructor(i){super(i),this.color=F.node_colors.yellow.color,this.bgcolor=F.node_colors.yellow.bgcolor,this.properties||(this.properties={text:""}),$.MARKDOWN(this,"text",["STRING",{default:this.properties.text}],h),this.serialize_widgets=!0,this.isVirtualNode=!0}}k.registerNodeType("MarkdownNote",e),e.category="utils"}});le().registerExtension({name:"Comfy.PreviewAny",async beforeRegisterNodeDef(n,e){if(e.name==="PreviewAny"){const t=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){t&&t.apply(this,[]);const o=$.MARKDOWN(this,"preview",["MARKDOWN",{}],h).widget,s=$.STRING(this,"preview",["STRING",{multiline:!0}],h).widget,a=$.BOOLEAN(this,"previewMode",["BOOLEAN",{label_on:"Markdown",label_off:"Plaintext",default:!1}],h);a.widget.callback=r=>{o.hidden=!r,o.options.hidden=!r,s.hidden=r,s.options.hidden=r},o.hidden=!0,o.options.hidden=!0,o.options.read_only=!0,o.element.readOnly=!0,o.element.disabled=!0,o.serialize=!1,s.hidden=!1,s.options.hidden=!1,s.options.read_only=!0,s.element.readOnly=!0,s.element.disabled=!0,s.serialize=!1};const i=n.prototype.onExecuted;n.prototype.onExecuted=function(o){i?.apply(this,[o]);const s=this.widgets?.filter(a=>a.name==="preview")??[];for(const a of s){const r=o.text??"";a.value=Array.isArray(r)?r[0]??"":r}}}}});h.registerExtension({name:"Comfy.RerouteNode",registerCustomNodes(n){class e extends ce{static{u(this,"RerouteNode")}static category;static defaultVisibility=!1;constructor(i){super(i??""),this.properties||(this.properties={}),this.properties.showOutputText=e.defaultVisibility,this.properties.horizontal=!1,this.addInput("","*"),this.addOutput(this.properties.showOutputText?"*":"","*"),this.isVirtualNode=!0}onAfterGraphConfigured(){requestAnimationFrame(()=>{this.onConnectionsChange(k.INPUT,void 0,!0)})}clone(){const i=super.clone();return i&&(i.removeOutput(0),i.addOutput(this.properties.showOutputText?"*":"","*"),i.setSize(i.computeSize()),i)}onConnectionsChange(i,o,s){const{graph:a}=this;if(!a||n.configuringGraph)return;if(s&&i===k.OUTPUT&&new Set(this.outputs[0].links?.map(v=>a.links[v]?.type)?.filter(v=>v&&v!=="*")??[]).size>1){const v=[];for(const _ of this.outputs[0].links??[]){const I=a.links[_];v.push(I)}v.pop();for(const _ of v)a.getNodeById(_.target_id)?.disconnectInput(_.target_slot)}let r=this,l=[],d=null,c=null;for(;r;){l.unshift(r);const b=r.inputs[0].link;if(b!==null){const v=a.links[b];if(!v)return;const _=a.getNodeById(v.origin_id);if(!_)return;if(_ instanceof e)_===this?(r.disconnectInput(v.target_slot),r=null):r=_;else{c=r,d=_.outputs[v.origin_slot]?.type??null;break}}else{r=null;break}}const g=[this];let w=null;for(;g.length;){r=g.pop();const b=r.outputs?.[0]?.links??[];for(const v of b){const _=a.links[v];if(!_)continue;const I=a.getNodeById(_.target_id);if(I)if(I instanceof e)g.push(I),l.push(I);else{const D=I.inputs[_.target_slot],E=D.type,A=!d||!E||k.isValidConnection(d,E);if(!A){I.disconnectInput(_.target_slot);continue}I.onConnectionsChange?.(k.INPUT,_.target_slot,A,_,D),w=I.inputs[_.target_slot].type}}}const p=d||w||"*",f=F.link_type_colors[p];let m,y;for(const b of l){b.outputs[0].type=d||"*",b.__outputType=p,b.outputs[0].name=b.properties.showOutputText?`${p}`:"",b.setSize(b.computeSize());for(const v of b.outputs[0].links||[]){const _=a.links[v];if(!_||(_.color=f,n.configuringGraph))continue;const I=a.getNodeById(_.target_id);if(!I)continue;const D=I.inputs?.[_.target_slot];if(D?.widget){const E=Me(D);m||(m=E[1]??{},y=E[0]);const A=re(D,[E[0],m]);A.customConfig&&(m=A.customConfig)}}}for(const b of l)m&&w?(b.inputs[0].widget={name:"value"},ke(b.inputs[0],[y??`${p}`,m])):ke(b.inputs[0],void 0);if(c?.inputs?.[0]?.link){const b=a.links[c.inputs[0].link];b&&(b.color=f)}}getExtraMenuOptions(i,o){return o.unshift({content:(this.properties.showOutputText?"Hide":"Show")+" Type",callback:u(()=>{this.properties.showOutputText=!this.properties.showOutputText,this.properties.showOutputText?this.outputs[0].name=`${this.__outputType||this.outputs[0].type}`:this.outputs[0].name="",this.setSize(this.computeSize()),n.canvas.setDirty(!0,!0)},"callback")},{content:(e.defaultVisibility?"Hide":"Show")+" Type By Default",callback:u(()=>{e.setDefaultTextVisibility(!e.defaultVisibility)},"callback")}),[]}computeSize(){return[this.properties.showOutputText&&this.outputs&&this.outputs.length?Math.max(75,k.NODE_TEXT_SIZE*this.outputs[0].name.length*.6+40):75,26]}static setDefaultTextVisibility(i){e.defaultVisibility=i,i?localStorage["Comfy.RerouteNode.DefaultVisibility"]="true":delete localStorage["Comfy.RerouteNode.DefaultVisibility"]}}e.setDefaultTextVisibility(!!localStorage["Comfy.RerouteNode.DefaultVisibility"]),k.registerNodeType("Reroute",Object.assign(e,{title_mode:k.NO_TITLE,title:"Reroute",collapsable:!1})),e.category="utils"}});const bo=new Set(["SaveImage","SaveVideo","SaveAnimatedWEBP","SaveWEBM","SaveAudio","SaveGLB","SaveAnimatedPNG","CLIPSave","VAESave","ModelSave","LoraSave","SaveLatent"]);h.registerExtension({name:"Comfy.SaveImageExtraOutput",async beforeRegisterNodeDef(n,e,t){if(bo.has(e.name)){const i=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){const o=i?i.apply(this,arguments):void 0,s=this.widgets.find(a=>a.name==="filename_prefix");return s.serializeValue=()=>Ze(t.graph,s.value),o}}else{const i=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){const o=i?i.apply(this,arguments):void 0;return(!this.properties||!("Node name for S&R"in this.properties))&&this.addProperty("Node name for S&R",this.constructor.type,"string"),o}}}});const He={name:"image",type:"Preview3D",isPreview:!0};le().registerExtension({name:"Comfy.SaveGLB",async beforeRegisterNodeDef(n,e){e.name==="SaveGLB"&&(e.input.required.image=["PREVIEW_3D"])},getCustomWidgets(){return{PREVIEW_3D(n){const e=new xe({node:n,name:He.name,component:Ee,inputSpec:He,options:{}});return e.type="load3D",De(n,e),{widget:e}}}},getNodeMenuItems(n){if(n.constructor.comfyClass!=="SaveGLB")return[];const e=ue().getLoad3d(n);return e?he(e):[]},async nodeCreated(n){if(n.constructor.comfyClass!=="SaveGLB")return;const[e,t]=n.size;n.setSize([Math.max(e,400),Math.max(t,550)]),await Te();const i=n.onExecuted;n.onExecuted=function(o){i?.apply(this,arguments);const s=o["3d"][0];ae(n).waitForLoad3d(a=>{const r=n.widgets?.find(l=>l.name==="image");if(a&&r){const l=s.subfolder+"/"+s.filename;r.value=l,new Oe(a,n.properties).configureForSaveMesh(s.type,l)}})}}});function vo(n,e){const t=e.selectedItems;if(t.size<=1)return;const i=At(t,10);if(!i)return;const[o,s,a,r]=i;n.save();const l=2/e.ds.scale;n.lineWidth=l,n.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--border-color").trim()||"#ffffff66";const d=5/e.ds.scale;n.setLineDash([d,d]),n.beginPath(),n.roundRect(o,s,a,r,8/e.ds.scale),n.stroke(),n.restore()}u(vo,"drawSelectionBorder");const Co={name:"Comfy.SelectionBorder",async init(){const n=h.canvas.onDrawForeground;h.canvas.onDrawForeground=function(e,t){n?.call(this,e,t),vo(e,h.canvas)}}};h.registerExtension(Co);let se=!1,ne=0;h.registerExtension({name:"Comfy.SimpleTouchSupport",setup(){let n=null,e=null,t=null,i=null;function o(r){return Math.hypot(r.touches[0].clientX-r.touches[1].clientX,r.touches[0].clientY-r.touches[1].clientY)}u(o,"getMultiTouchPos");function s(r){return{clientX:(r.touches[0].clientX+r.touches[1].clientX)/2,clientY:(r.touches[0].clientY+r.touches[1].clientY)/2}}u(s,"getMultiTouchCenter"),h.canvasEl.parentElement?.addEventListener("touchstart",r=>{ne+=r.changedTouches.length,t=null,i=null,r.touches?.length===1?(e=new Date,t=r.touches[0]):(e=null,r.touches?.length===2&&(i=h.canvas.ds.scale,t=s(r),n=o(r),h.canvas.pointer.isDown=!1))},!0),h.canvasEl.parentElement?.addEventListener("touchend",r=>{if(ne-=r.changedTouches.length,r.touches?.length!==1&&(se=!1),e&&!r.touches?.length){if(new Date().getTime()-e.getTime()>600&&r.target===h.canvasEl){const l={button:2,clientX:r.changedTouches[0].clientX,clientY:r.changedTouches[0].clientY,pointerId:1,isPrimary:!0};h.canvasEl.dispatchEvent(new PointerEvent("pointerdown",l)),setTimeout(()=>{h.canvasEl.dispatchEvent(new PointerEvent("pointerup",l))}),r.preventDefault()}e=null}});const a=u(()=>{ne=0,se=!1,e=null,t=null,i=null,n=null},"resetTouchState");document.addEventListener("visibilitychange",()=>{document.hidden&&a()}),h.canvasEl.parentElement?.addEventListener("touchcancel",a),h.canvasEl.parentElement?.addEventListener("touchmove",r=>{if(e&&t&&r.touches?.length===1){const c=r.touches[0],g=c.clientX-t.clientX,w=c.clientY-t.clientY;g*g+w*w>30&&(e=null)}if(r.touches?.length===2&&t&&!r.ctrlKey&&!r.shiftKey){r.preventDefault(),h.canvas.pointer.isDown=!1,se=!0,k.closeAllContextMenus(window),h.canvas.search_box?.close();const c=o(r),g=s(r);if(i===null||n===null)return;let w=i*c/n;const p=(g.clientX-t.clientX)/w,f=(g.clientY-t.clientY)/w;w<h.canvas.ds.min_scale?w=h.canvas.ds.min_scale:w>h.canvas.ds.max_scale&&(w=h.canvas.ds.max_scale);const m=h.canvas.ds.scale;h.canvas.ds.scale=w,Math.abs(h.canvas.ds.scale-1)<.01&&(h.canvas.ds.scale=1);const y=h.canvas.ds.scale,b=u(v=>[g.clientX/v-h.canvas.ds.offset[0],g.clientY/v-h.canvas.ds.offset[1]],"convertScaleToOffset");var l=b(m),d=b(y);h.canvas.ds.offset[0]+=p+d[0]-l[0],h.canvas.ds.offset[1]+=f+d[1]-l[1],t.clientX=g.clientX,t.clientY=g.clientY,h.canvas.setDirty(!0,!0)}},!0)}});const _o=F.prototype.processMouseDown;F.prototype.processMouseDown=function(n){if(!(se||ne))return h.canvas.pointer.isDown=!1,_o.apply(this,[n])};const ko=F.prototype.processMouseMove;F.prototype.processMouseMove=function(n){if(!(se||ne>1))return ko.apply(this,[n])};h.registerExtension({name:"Comfy.SlotDefaults",suggestionsNumber:null,init(){k.search_filter_enabled=!0,k.middle_click_slot_add_default_node=!0,this.suggestionsNumber=h.ui.settings.addSetting({id:"Comfy.NodeSuggestions.number",category:["Comfy","Node Search Box","NodeSuggestions"],name:"Number of nodes suggestions",tooltip:"Only for litegraph searchbox/context menu",type:"slider",attrs:{min:1,max:100,step:1},defaultValue:5,onChange:u(n=>{this.setDefaults(n)},"onChange")})},slot_types_default_out:{},slot_types_default_in:{},async beforeRegisterNodeDef(n,e){var t=e.name;const i=e.input?.required;for(const d in i){var o=i[d];if(typeof o[0]!="string")continue;var s=o[0];if(s in $){var a=o[1];if(!a?.forceInput)continue}if(s in this.slot_types_default_out||(this.slot_types_default_out[s]=["Reroute"]),this.slot_types_default_out[s].includes(t))continue;this.slot_types_default_out[s].push(t);const c=s.toLocaleLowerCase();c in k.registered_slot_in_types||(k.registered_slot_in_types[c]={nodes:[]}),k.registered_slot_in_types[c].nodes.push(n.comfyClass)}var r=e.output??[];for(const d of r){const c=d;c in this.slot_types_default_in||(this.slot_types_default_in[c]=["Reroute"]),!this.slot_types_default_in[c].includes(t)&&(this.slot_types_default_in[c].push(t),c in k.registered_slot_out_types||(k.registered_slot_out_types[c]={nodes:[]}),k.registered_slot_out_types[c].nodes.push(n.comfyClass),k.slot_types_out.includes(c)||k.slot_types_out.push(c))}var l=this.suggestionsNumber.value;this.setDefaults(l)},setDefaults(n){k.slot_types_default_out={},k.slot_types_default_in={};for(const e in this.slot_types_default_out)k.slot_types_default_out[e]=this.slot_types_default_out[e].slice(0,n);for(const e in this.slot_types_default_in)k.slot_types_default_in[e]=this.slot_types_default_in[e].slice(0,n)}});async function No(n,e,t,i,o=!1){try{const s=new FormData;s.append("image",t),o&&s.append("subfolder","pasted");const a=await O.fetchApi("/upload/image",{method:"POST",body:s});if(a.status===200){const r=await a.json();let l=r.name;r.subfolder&&(l=r.subfolder+"/"+l),n.options.values.includes(l)||n.options.values.push(l),i&&(e.element.src=O.apiURL(pe(...tt(l))),n.value=l,n.callback?.(l))}else S().addAlert(a.status+" - "+a.statusText)}catch(s){S().addAlert(s)}}u(No,"uploadFile");h.registerExtension({name:"Comfy.AudioWidget",async beforeRegisterNodeDef(n,e){["LoadAudio","SaveAudio","PreviewAudio","SaveAudioMP3","SaveAudioOpus"].includes(n.prototype.comfyClass)&&(e.input.required.audioUI=["AUDIO_UI",{}])},getCustomWidgets(){return{AUDIO_UI(n,e){const t=document.createElement("audio");t.controls=!0,t.classList.add("comfy-audio"),t.setAttribute("name","media");const i=n.addDOMWidget(e,"audioUI",t);i.serialize=!1;const{nodeData:o}=n.constructor;if(o==null)throw new TypeError("nodeData is null");if(o.output_node){i.element.classList.add("empty-audio-widget");const a=n.onExecuted;n.onExecuted=function(r){a?.apply(this,arguments);const l=r.audio;if(!l)return;const d=l[0];i.element.src=O.apiURL(pe(d.subfolder,d.filename,d.type)),i.element.classList.remove("empty-audio-widget")}}return i.onRemove=J(i.onRemove,()=>{i.element&&(i.element.pause(),i.element.src="",i.element.remove())}),{widget:i}}}},onNodeOutputsUpdated(n){for(const[e,t]of Object.entries(n))if("audio"in t){const i=Pt(h.rootGraph,e);if(!i)continue;const o=i.widgets.find(a=>a.name==="audioUI"),s=t.audio[0];o.element.src=O.apiURL(pe(s.subfolder,s.filename,s.type)),o.element.classList.remove("empty-audio-widget")}}});h.registerExtension({name:"Comfy.UploadAudio",async beforeRegisterNodeDef(n,e){e?.input?.required?.audio?.[1]?.audio_upload===!0&&(e.input.required.upload=["AUDIOUPLOAD",{}])},getCustomWidgets(){return{AUDIOUPLOAD(n,e){const t=n.widgets.find(c=>c.name==="audio"),i=n.widgets.find(c=>c.name==="audioUI");i.options.canvasOnly=!0;const o=u(()=>{typeof t.value=="string"&&(i.element.src=O.apiURL(pe(...tt(t.value))))},"onAudioWidgetUpdate");t.value&&o(),t.callback=o;const s=n.onGraphConfigured;n.onGraphConfigured=function(){s?.apply(this,arguments),t.value&&o()};const a=u(async c=>(c?.length&&No(t,i,c[0],!0),c),"handleUpload"),r=u(c=>c.type.startsWith("audio/"),"isAudioFile"),{openFileSelection:l}=Lt(n,{accept:"audio/*",onSelect:a}),d=n.addWidget("button",e,"",l,{serialize:!1,canvasOnly:!0});return d.label=x("g.choose_file_to_upload"),Rt(n,{fileFilter:r,onDrop:a}),Wt(n,{fileFilter:r,onPaste:a}),n.previewMediaType="audio",{widget:d}}}}});h.registerExtension({name:"Comfy.RecordAudio",getCustomWidgets(){return{AUDIO_RECORD(n,e){const t=document.createElement("audio");t.controls=!0,t.classList.add("comfy-audio"),t.setAttribute("name","media");const i=n.addDOMWidget(e,"audioUI",t);i.options.canvasOnly=!1;let o=null,s=!1,a=[],r=null,l=null,d=null,c=null;i.serializeValue=async()=>{s&&o&&(d=new Promise(f=>{c=f}),o.stop(),await d);const w=i.element.src;if(!w)return S().addAlert(x("g.noAudioRecorded")),"";const p=await fetch(w).then(f=>f.blob());return await Q().convertBlobToFileAndSubmit(p)},l=n.addWidget("button",e,"",async()=>{if(s)o&&s&&o.stop();else try{r=await navigator.mediaDevices.getUserMedia({audio:!0}),o=new Bt(r,{mimeType:"audio/wav"}),a=[],o.ondataavailable=w=>{a.push(w.data)},o.onstop=async()=>{const w=new Blob(a,{type:"audio/wav"});Q().stopAllTracks(r),i.element.src&&i.element.src.startsWith("blob:")&&URL.revokeObjectURL(i.element.src),i.element.src=URL.createObjectURL(w),s=!1,l&&(l.label=x("g.startRecording")),c&&(c(),c=null,d=null)},o.onerror=w=>{console.error("MediaRecorder error:",w),Q().stopAllTracks(r),s=!1,l&&(l.label=x("g.startRecording")),c&&(c(),c=null,d=null)},o.start(),s=!0,l&&(l.label=x("g.stopRecording"))}catch(w){if(console.error("Error accessing microphone:",w),S().addAlert(x("g.micPermissionDenied")),o)try{o.stop()}catch{}Q().stopAllTracks(r),r=null,s=!1,l&&(l.label=x("g.startRecording"))}},{serialize:!1,canvasOnly:!1}),l.label=x("g.startRecording"),l.type="audiorecord";const g=n.onRemoved;return n.onRemoved=function(){s&&o&&o.stop(),Q().stopAllTracks(r),i.element.src?.startsWith("blob:")&&URL.revokeObjectURL(i.element.src),g?.call(this)},{widget:l}}}},async nodeCreated(n){n.constructor.comfyClass==="RecordAudio"&&await Q().registerWavEncoder()}});const Io=u(n=>{const[e,t]=n;return t?(t.image_upload===!0||t.video_upload===!0||t.animated_image_upload===!0)&&(Gt(n)||e==="COMBO"):!1},"isMediaUploadComboInput"),xo=u((n,e)=>["IMAGEUPLOAD",{...e[1],imageInputName:n}],"createUploadInput");h.registerExtension({name:"Comfy.UploadImage",beforeRegisterNodeDef(n,e){const{input:t}=e??{},{required:i}=t??{};if(!i)return;const o=Object.entries(i).find(([s,a])=>Io(a));if(o){const[s,a]=o;i.upload=xo(s,a)}}});const Ke=Symbol();h.registerExtension({name:"Comfy.WebcamCapture",getCustomWidgets(){return{WEBCAM(n,e){let t;n[Ke]=new Promise(a=>t=a);const i=document.createElement("div");i.style.background="rgba(0,0,0,0.25)",i.style.textAlign="center";const o=document.createElement("video");return o.style.height=o.style.width="100%",u(async()=>{try{const a=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});i.replaceChildren(o),setTimeout(()=>t(o),500),o.addEventListener("loadedmetadata",()=>t(o),!1),o.srcObject=a,o.play()}catch(a){const r=document.createElement("div");r.style.color="red",r.style.overflow="auto",r.style.maxHeight="100%",r.style.whiteSpace="pre-wrap",window.isSecureContext?r.textContent=`Unable to load webcam, please ensure access is granted:
`+a.message:r.textContent=`Unable to load webcam. A secure context is required, if you are not accessing ComfyUI on localhost (127.0.0.1) you will have to enable TLS (https)

`+a.message,i.replaceChildren(r)}},"loadVideo")(),{widget:n.addDOMWidget(e,"WEBCAM",i)}}}},nodeCreated(n){if(n.type,n.constructor.comfyClass!=="WebcamCapture")return;let e;const t=n.widgets.find(d=>d.name==="image"),i=n.widgets.find(d=>d.name==="width"),o=n.widgets.find(d=>d.name==="height"),s=n.widgets.find(d=>d.name==="capture_on_queue"),a=document.createElement("canvas"),r=u(()=>{a.width=i.value,a.height=o.value,a.getContext("2d").drawImage(e,0,0,i.value,o.value);const c=a.toDataURL("image/png"),g=new Image;g.onload=()=>{n.imgs=[g],h.canvas.setDirty(!0)},g.src=c},"capture"),l=n.addWidget("button","waiting for camera...","capture",r,{canvasOnly:!0});l.disabled=!0,l.serializeValue=()=>{},t.serializeValue=async()=>{if(s.value)r();else if(!n.imgs?.length){const f="No webcam image captured";throw S().addAlert(f),new Error(f)}const d=await new Promise(f=>a.toBlob(f)),c=`${+new Date}.png`,g=new File([d],c),w=new FormData;w.append("image",g),w.append("subfolder","webcam"),w.append("type","temp");const p=await O.fetchApi("/upload/image",{method:"POST",body:w});if(p.status!==200){const f=`Error uploading camera image: ${p.status} - ${p.statusText}`;throw S().addAlert(f),new Error(f)}return`webcam/${c} [temp]`},n[Ke].then(d=>{e=d,i.value||(i.value=e.videoWidth||640,o.value=e.videoHeight||480),l.disabled=!1,l.label=x("g.capture")})}});
//# sourceMappingURL=index-BeqrWBQh.js.map
