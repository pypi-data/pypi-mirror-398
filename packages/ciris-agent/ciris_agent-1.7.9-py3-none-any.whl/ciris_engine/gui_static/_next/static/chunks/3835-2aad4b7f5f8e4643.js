"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3835],{3120:(e,t,n)=>{n.d(t,{_:()=>l});var a=n(704);function o(){let e=window.location.hostname,t=window.location.pathname,n=t.startsWith("/agent/");if("agents.ciris.ai"!==e&&!n)return{mode:"standalone",agentId:"default",apiBase:"/v1"};{let e="default";e=n?t.split("/")[2]||"default":localStorage.getItem("selectedAgentId")||"default";let a="/api/".concat(e,"/v1");return{mode:"managed",agentId:e,apiBase:a}}}var i=n(5950);class r{configure(e,t){let n,{mode:a}=o();if("managed"===a)n="".concat(window.location.origin,"/api/").concat(e);else{let t=localStorage.getItem("agent_".concat(e,"_api_url"));n=t||window.location.origin}t||(t=i.a.getAccessToken()||void 0);let r={baseURL:n,authToken:t,agentId:e,mode:a};return this.hasConfigChanged(r)&&this.applyConfiguration(r),r}configureForOAuthCallback(e,t){let n,{mode:a}=o(),i={baseURL:"managed"===a?"".concat(window.location.origin,"/api/").concat(e):window.location.origin,authToken:t,agentId:e,mode:a};return this.applyConfiguration(i),this.storeConfiguration(i),i}getCurrentConfig(){return this.currentConfig}isConfiguredFor(e){return!!this.currentConfig&&this.currentConfig.agentId===e&&!!this.currentConfig.authToken}clear(){this.currentConfig=null,localStorage.removeItem("sdk_config"),this.log("SDK configuration cleared")}applyConfiguration(e){this.log("Applying SDK configuration:",e),a.AQ.setConfig({baseURL:e.baseURL,authToken:e.authToken}),this.currentConfig=e,this.log("SDK configured successfully")}hasConfigChanged(e){return!this.currentConfig||this.currentConfig.baseURL!==e.baseURL||this.currentConfig.authToken!==e.authToken||this.currentConfig.agentId!==e.agentId||this.currentConfig.mode!==e.mode}storeConfiguration(e){let t={baseURL:e.baseURL,agentId:e.agentId,mode:e.mode};localStorage.setItem("sdk_config",JSON.stringify(t)),"standalone"===e.mode&&e.baseURL!==window.location.origin&&localStorage.setItem("agent_".concat(e.agentId,"_api_url"),e.baseURL)}restoreConfiguration(){let e=localStorage.getItem("sdk_config");if(!e)return null;try{let t=JSON.parse(e),n=i.a.getAccessToken()||void 0;return{...t,authToken:n}}catch(e){return null}}log(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugMode&&console.log("[SDKConfigManager]",...t)}constructor(){this.currentConfig=null,this.debugMode=!1}}let l=new r},3835:(e,t,n)=>{n.d(t,{F:()=>f,f:()=>h});var a=n(4568),o=n(7620),i=n(9484),r=n(704),l=n(2942),s=n(3120),c=n(5950),g=n(4338);let u=(0,o.createContext)(null),d={agent_id:"datum",agent_name:"Datum (Local Dev)",status:"running",health:"healthy",api_url:g.env.NEXT_PUBLIC_CIRIS_API_URL||"http://localhost",api_port:8080,api_endpoint:g.env.NEXT_PUBLIC_CIRIS_API_URL||"http://localhost:8080",container_name:"ciris-agent-datum",created_at:new Date().toISOString(),started_at:new Date().toISOString(),update_available:!1};function f(e){let{children:t}=e,[n,g]=(0,o.useState)([]),[f,h]=(0,o.useState)(null),[_,C]=(0,o.useState)(new Map),[m,A]=(0,o.useState)(!1),[S,I]=(0,o.useState)(!1),[p,w]=(0,o.useState)(null),[y,k]=(0,o.useState)(!1),{user:v}=(0,i.A)(),b=(0,l.usePathname)(),R=async()=>{A(!0),w(null);try{let e=await r.AQ.manager.listAgents();if(g(e),k(!0),!f&&e.length>0){let t=e.find(e=>"running"===e.status)||e[0];await T(t.agent_id)}}catch(e){console.log("CIRIS Manager not available, using local dev agent"),g([d]),k(!1),f||await T(d.agent_id),e instanceof Error&&!e.message.includes("fetch")&&!e.message.includes("Failed to fetch")&&w(e)}finally{A(!1)}},L=async()=>{if(v&&f){I(!0);try{let e=await r.AQ.auth.getCurrentUser();if(e){let t={agentId:f.agent_id,apiRole:e.api_role,waRole:e.wa_role,isAuthority:"authority"===e.wa_role||"SYSTEM_ADMIN"===e.api_role,lastChecked:new Date};C(e=>{let n=new Map(e);return n.set(f.agent_id,t),n})}}catch(e){console.error("Failed to fetch role for agent ".concat(f.agent_id,":"),e)}I(!1)}},T=async e=>{let t=n.find(t=>t.agent_id===e);if(!t)return;console.log("[AgentContext] Selecting agent:",e),h(t);let a=c.a.getAccessToken()||void 0;s._.configure(e,a),localStorage.setItem("selectedAgentId",e),localStorage.setItem("selectedAgentName",t.agent_name),y||localStorage.setItem("agent_".concat(e,"_api_url"),"".concat(t.api_url,":").concat(t.api_port))},E=f&&_.get(f.agent_id)||null;return(0,o.useEffect)(()=>{let e=c.a.getAccessToken(),t=localStorage.getItem("selectedAgentId");e&&t&&(console.log("[AgentContext] Restoring SDK config for agent:",t),s._.configure(t,e)),R()},[]),(0,o.useEffect)(()=>{f&&v&&L()},[f,v]),(0,o.useEffect)(()=>{if(0===n.length||f)return;let e=b.match(/^\/agent\/([^\/]+)/);if(e&&e[1]){let t=e[1];if(n.find(e=>e.agent_id===t))return void T(t)}let t=localStorage.getItem("selectedAgentId");t&&T(t)},[n,b]),(0,a.jsx)(u.Provider,{value:{agents:n,currentAgent:f,currentAgentRole:E,agentRoles:_,selectAgent:T,refreshAgents:R,refreshAgentRoles:L,isLoadingAgents:m,isLoadingRoles:S,error:p,isManagerAvailable:y},children:t})}function h(){let e=(0,o.useContext)(u);if(!e)throw Error("useAgent must be used within an AgentProvider");return e}},9484:(e,t,n)=>{n.d(t,{A:()=>u,O:()=>g});var a=n(4568),o=n(7620),i=n(2942),r=n(3237),l=n(704),s=n(3120);let c=(0,o.createContext)(void 0);function g(e){let{children:t}=e,[n,g]=(0,o.useState)(null),[u,d]=(0,o.useState)(!0),[f,h]=(0,o.useState)(null),_=(0,i.useRouter)();(0,o.useEffect)(()=>{let e=window.location.pathname;"/login"===e||e.startsWith("/manager")?d(!1):C();let t=localStorage.getItem("manager_token");t&&h(t)},[]);let C=async()=>{try{if(l.AQ.isAuthenticated()){let e=await l.AQ.auth.getMe();g(e)}}catch(e){console.error("Auth check failed:",e)}finally{d(!1)}},m=(0,o.useCallback)(async(e,t)=>{try{let n=localStorage.getItem("selectedAgentId");if(!n)throw Error("No agent selected");s._.configure(n);let a=await l.AQ.login(e,t),o=l.AQ.auth.getAccessToken();o&&s._.configure(n,o),g(a),r.Ay.success("Welcome, ".concat(a.username||a.user_id,"!")),_.push("/")}catch(e){throw r.Ay.error(e.message||"Login failed"),e}},[_]),A=(0,o.useCallback)(async()=>{try{await l.AQ.logout(),g(null),r.Ay.success("Logged out successfully"),_.push("/login")}catch(e){console.error("Logout failed:",e),r.Ay.error("Logout failed")}},[_]),S=(0,o.useCallback)(e=>!!n&&(n.permissions.includes(e)||"SYSTEM_ADMIN"===n.role),[n]),I=(0,o.useCallback)(e=>{if(!n)return!1;let t=["OBSERVER","ADMIN","AUTHORITY","SYSTEM_ADMIN"];return t.indexOf(n.role)>=t.indexOf(e)},[n]),p=(0,o.useCallback)(e=>{l.AQ.setConfig({authToken:e})},[]),w=(0,o.useCallback)(()=>!!f,[f]);return(0,a.jsx)(c.Provider,{value:{user:n,loading:u,login:m,logout:A,hasPermission:S,hasRole:I,setUser:g,setToken:p,managerToken:f,setManagerToken:h,isManagerAuthenticated:w},children:t})}function u(){let e=(0,o.useContext)(c);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}}]);