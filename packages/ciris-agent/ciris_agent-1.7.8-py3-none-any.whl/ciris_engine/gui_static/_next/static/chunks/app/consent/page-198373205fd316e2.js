(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[643],{2942:(e,t,s)=>{"use strict";var a=s(2418);s.o(a,"usePathname")&&s.d(t,{usePathname:function(){return a.usePathname}}),s.o(a,"useRouter")&&s.d(t,{useRouter:function(){return a.useRouter}}),s.o(a,"useSearchParams")&&s.d(t,{useSearchParams:function(){return a.useSearchParams}})},4826:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>g});var a=s(4568),r=s(7620),n=s(9484),l=s(704),i=s(6264),c=s(5003),o=s(3457),d=s(1338),u=s(7192);function m(){let{user:e}=(0,n.A)(),[t,s]=(0,r.useState)(null),[d,m]=(0,r.useState)({}),[g,y]=(0,r.useState)(!0),[j,f]=(0,r.useState)(null),[v,N]=(0,r.useState)(!1),[b,w]=(0,r.useState)(!1),[S,_]=(0,r.useState)("none"),[C,P]=(0,r.useState)(!0),[A,E]=(0,r.useState)([]);(0,r.useEffect)(()=>{(async()=>{try{try{let e=await l.AQ.consent.getStatus();P(!0),s(e)}catch(r){var e,t,a;if(console.log("[Consent] Error fetching status:",r),(null==r?void 0:r.status)===404||(null==r||null==(e=r.response)?void 0:e.status)===404||(null==r||null==(t=r.message)?void 0:t.toLowerCase().includes("not found"))||(null==r||null==(a=r.message)?void 0:a.toLowerCase().includes("404")))console.log("[Consent] No consent record found (404), this is normal for new users"),P(!1),s(null);else throw r}let r=await l.AQ.consent.getStreams();m(r.streams);let n=await l.AQ.consent.getPartnershipStatus();_(n.partnership_status),N("pending"===n.partnership_status),"deferred"===n.partnership_status&&E([{from:"agent",timestamp:new Date().toISOString(),message:n.message||"The agent would like to establish a partnership with you."}])}catch(t){console.error("❌ Failed to fetch consent data:",t);let e=(0,u.PE)(t);throw alert("Failed to load consent data: ".concat(e)),t}finally{y(!1)}})()},[]),(0,r.useEffect)(()=>{if(!v)return;let e=setInterval(async()=>{try{let e=await l.AQ.consent.getPartnershipStatus();if(_(e.partnership_status),"pending"!==e.partnership_status)if(N(!1),"accepted"===e.partnership_status){let e=await l.AQ.consent.getStatus();s(e),alert("Partnership approved! You now have PARTNERED consent.")}else"rejected"===e.partnership_status&&alert("Partnership request was declined by the agent.")}catch(s){console.error("❌ Failed to poll partnership status:",s);let t=(0,u.PE)(s);alert("Failed to check partnership status: ".concat(t)),N(!1),clearInterval(e)}},5e3);return()=>clearInterval(e)},[v]);let I=(0,r.useCallback)(async e=>{if(e!==(null==t?void 0:t.stream))if("partnered"===e)w(!0);else try{let t="anonymous"===e?"Switching to ANONYMOUS will create a proactive opt-out and anonymize your data. Continue?":"Switching to TEMPORARY will create a proactive opt-out with 14-day auto-forget. Continue?";if(!confirm(t))return;let a=await l.AQ.consent.grantConsent({stream:e,categories:[],reason:"User proactively opted for ".concat(e," consent (opt-out)")});s(a),alert("Successfully switched to ".concat(e.toUpperCase()," consent mode. This creates a proactive opt-out."))}catch(t){console.error("❌ Failed to change consent stream:",t);let e=(0,u.PE)(t);alert("Failed to change consent stream: ".concat(e)),console.error("Full error object:",{status:null==t?void 0:t.status,detail:null==t?void 0:t.detail,message:null==t?void 0:t.message,type:null==t?void 0:t.type,stack:null==t?void 0:t.stack})}},[t]),R=(0,r.useCallback)(()=>{N(!0),w(!1),alert("Partnership request submitted! The agent will review your request.")},[]);return g?(0,a.jsx)(i.O,{children:(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"}),(0,a.jsx)("p",{className:"mt-4 text-gray-600",children:"Loading consent settings..."})]})})}):(0,a.jsxs)(i.O,{children:[(0,a.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,a.jsx)("div",{className:"bg-white shadow-sm border-b",children:(0,a.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Consent Management"}),(0,a.jsx)("p",{className:"mt-1 text-sm text-gray-600",children:"Control how CIRIS handles your data and interactions"})]}),t&&(0,a.jsx)("div",{className:"px-4 py-2 rounded-lg border ".concat((e=>{switch(e){case"temporary":return"bg-yellow-100 text-yellow-800 border-yellow-300";case"partnered":return"bg-green-100 text-green-800 border-green-300";case"anonymous":return"bg-blue-100 text-blue-800 border-blue-300";default:return"bg-gray-100 text-gray-800 border-gray-300"}})(t.stream)),children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("span",{className:"text-2xl",children:(e=>{switch(e){case"temporary":return"\uD83D\uDEE1️";case"partnered":return"\uD83E\uDD1D";case"anonymous":return"\uD83D\uDC64";default:return"\uD83D\uDCCB"}})(t.stream)}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"font-semibold capitalize",children:[t.stream," Mode"]}),"temporary"===t.stream&&(0,a.jsxs)("div",{className:"text-xs",children:["Expires in: ",(()=>{if(!t||"temporary"!==t.stream||!t.expires_at)return null;let e=new Date(t.expires_at),s=new Date,a=e.getTime()-s.getTime();if(a<=0)return"Expired";let r=Math.floor(a/864e5),n=Math.floor(a%864e5/36e5);return"".concat(r," days, ").concat(n," hours")})()]}),v&&(0,a.jsx)("div",{className:"text-xs animate-pulse",children:"Partnership request pending..."})]})]})})]})})}),(0,a.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[!C&&(0,a.jsxs)("div",{className:"mb-8 bg-yellow-50 border border-yellow-200 rounded-lg p-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-yellow-900 mb-2",children:"Consent Record Not Yet Created"}),(0,a.jsx)("p",{className:"text-yellow-700",children:"Your consent record will be automatically created 6-12 hours after your first Discord interaction with CIRIS. This ensures meaningful engagement before establishing a consent relationship."})]}),(0,a.jsx)(o.u,{partnershipRequests:A}),(0,a.jsx)("div",{className:"mb-8",children:(0,a.jsx)(o.k,{})}),(0,a.jsxs)("div",{className:"mb-8",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Choose Your Consent Stream"}),(0,a.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:Object.entries(d).map(e=>{let[s,r]=e;return(0,a.jsx)(x,{streamKey:s,stream:r,isActive:(null==t?void 0:t.stream)===s,onSelect:()=>I(s)},s)})})]}),t&&["partnered","anonymous"].includes(t.stream)&&(0,a.jsx)(h,{consentStatus:t}),(0,a.jsx)(p,{}),(0,a.jsx)("div",{className:"mt-8 text-center text-xs text-gray-500",children:(0,a.jsxs)("p",{children:["You can only view and manage your own consent settings.",(null==e?void 0:e.role)==="ADMIN"&&" As an admin, you can view (but not modify) consent records for compliance purposes."]})})]})]}),(0,a.jsx)(c.A,{isOpen:b,onClose:()=>w(!1),onSuccess:R})]})}function x(e){let{streamKey:t,stream:s,isActive:r,onSelect:n}=e;return(0,a.jsxs)("div",{className:"border rounded-lg p-6 ".concat(r?"border-indigo-500 bg-indigo-50":"border-gray-200 bg-white"),children:[(0,a.jsxs)("div",{className:"text-center mb-4",children:[(0,a.jsx)("span",{className:"text-4xl",children:(()=>{switch(t){case"temporary":return"\uD83D\uDEE1️";case"partnered":return"\uD83E\uDD1D";case"anonymous":return"\uD83D\uDC64";default:return"\uD83D\uDCCB"}})()}),(0,a.jsx)("h3",{className:"mt-2 text-lg font-semibold capitalize",children:s.name})]}),(0,a.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:s.description}),(0,a.jsx)("ul",{className:"space-y-1 mb-4",children:(()=>{switch(t){case"temporary":return["✓ No tracking","✓ Auto-forget in 14 days","✗ No learning"];case"partnered":return["✓ Mutual growth","✓ Personalized experience","✓ Full features"];case"anonymous":return["✓ Help others","✓ No identity stored","✓ Statistical contribution"];default:return[]}})().map((e,t)=>(0,a.jsx)("li",{className:"text-sm",children:e},t))}),s.duration_days&&(0,a.jsxs)("p",{className:"text-xs text-gray-500 mb-4",children:["Duration: ",s.duration_days," days"]}),s.requires_categories&&(0,a.jsx)("p",{className:"text-xs text-orange-600 mb-4",children:"⚠️ Requires agent approval"}),(0,a.jsx)("button",{onClick:n,disabled:r,className:"w-full py-2 px-4 rounded-md text-sm font-medium ".concat(r?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700"),children:r?"Current Stream":"partnered"===t?"Request Partnership":"Switch Stream"})]})}function h(e){let{consentStatus:t}=e,[s,n]=(0,r.useState)(null),[i,c]=(0,r.useState)(!0);return((0,r.useEffect)(()=>{(async()=>{try{let e=await l.AQ.consent.getImpactReport();n(e)}catch(e){console.error("❌ Failed to fetch impact data:",e),console.error("Impact error details:",{status:null==e?void 0:e.status,detail:null==e?void 0:e.detail,message:null==e?void 0:e.message})}finally{c(!1)}})()},[]),i)?(0,a.jsx)("div",{className:"animate-pulse h-32 bg-gray-200 rounded-lg"}):s?(0,a.jsxs)("div",{className:"mb-8 bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Your Impact"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-3xl font-bold text-indigo-600",children:s.total_interactions}),(0,a.jsx)("div",{className:"text-sm text-gray-600",children:"Total Interactions"})]}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-3xl font-bold text-green-600",children:s.patterns_contributed}),(0,a.jsx)("div",{className:"text-sm text-gray-600",children:"Patterns Contributed"})]}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-3xl font-bold text-blue-600",children:s.users_helped}),(0,a.jsx)("div",{className:"text-sm text-gray-600",children:"Users Helped"})]}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-3xl font-bold text-purple-600",children:s.impact_score.toFixed(1)}),(0,a.jsx)("div",{className:"text-sm text-gray-600",children:"Impact Score"})]})]})]}):null}function p(){let[e,t]=(0,r.useState)([]),[s,n]=(0,r.useState)(!0);return(0,r.useEffect)(()=>{(async()=>{try{let e=await l.AQ.consent.getAuditTrail(10);t(e)}catch(e){console.error("❌ Failed to fetch audit trail:",e),console.error("Audit error details:",{status:null==e?void 0:e.status,detail:null==e?void 0:e.detail,message:null==e?void 0:e.message})}finally{n(!1)}})()},[]),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Consent History"}),s?(0,a.jsx)("div",{className:"animate-pulse space-y-2",children:[1,2,3].map(e=>(0,a.jsx)("div",{className:"h-12 bg-gray-200 rounded"},e))}):0===e.length?(0,a.jsx)("p",{className:"text-gray-500",children:"No consent changes recorded"}):(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"}),(0,a.jsx)("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Previous"}),(0,a.jsx)("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"New"}),(0,a.jsx)("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Initiated By"}),(0,a.jsx)("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Reason"})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-gray-200",children:e.map(e=>(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{className:"px-4 py-2 text-sm text-gray-900",children:new Date(e.timestamp).toLocaleDateString()}),(0,a.jsx)("td",{className:"px-4 py-2 text-sm capitalize",children:e.previous_stream}),(0,a.jsx)("td",{className:"px-4 py-2 text-sm capitalize",children:e.new_stream}),(0,a.jsx)("td",{className:"px-4 py-2 text-sm",children:e.initiated_by}),(0,a.jsx)("td",{className:"px-4 py-2 text-sm text-gray-600",children:e.reason||"-"})]},e.entry_id))})]})})]})}function g(){return(0,a.jsx)(d.L,{children:(0,a.jsx)(m,{})})}},8194:(e,t,s)=>{Promise.resolve().then(s.bind(s,4826))}},e=>{var t=t=>e(e.s=t);e.O(0,[4534,704,4499,587,8315,7358],()=>t(8194)),_N_E=e.O()}]);