"""
Markdown Report Generator for MCP Readiness Scanner.

Produces human-readable Markdown output suitable for PR comments,
documentation, and manual review.
"""

from mcpreadiness.core.models import Finding, ScanResult, Severity
from mcpreadiness.core.taxonomy import CATEGORY_DESCRIPTIONS

# Severity emoji mapping
SEVERITY_EMOJI = {
    Severity.CRITICAL: "ðŸ”´",
    Severity.HIGH: "ðŸŸ ",
    Severity.MEDIUM: "ðŸŸ¡",
    Severity.LOW: "ðŸ”µ",
    Severity.INFO: "âšª",
}

# Severity badge colors for GitHub
SEVERITY_BADGES = {
    Severity.CRITICAL: "critical",
    Severity.HIGH: "important",
    Severity.MEDIUM: "warning",
    Severity.LOW: "informational",
    Severity.INFO: "inactive",
}


def render_markdown(
    result: ScanResult,
    verbose: bool = False,
    include_remediation: bool = True,
) -> str:
    """
    Render a scan result as Markdown.

    Args:
        result: The scan result to render
        verbose: Include additional details
        include_remediation: Include remediation suggestions

    Returns:
        Markdown string representation
    """
    lines: list[str] = []

    # Header
    lines.append("# MCP Readiness Scan Report")
    lines.append("")

    # Summary section
    lines.append("## Summary")
    lines.append("")
    lines.append(f"**Target:** `{result.target}`")
    lines.append(f"**Readiness Score:** {_score_badge(result.readiness_score)}")
    lines.append(f"**Production Ready:** {'Yes âœ…' if result.is_production_ready else 'No âŒ'}")
    lines.append(f"**Scan Time:** {result.timestamp.isoformat()}")

    if result.scan_duration_ms:
        lines.append(f"**Duration:** {result.scan_duration_ms}ms")

    lines.append(f"**Providers Used:** {', '.join(result.providers_used)}")
    lines.append("")

    # Findings summary table
    lines.append("### Findings Overview")
    lines.append("")
    lines.append("| Severity | Count |")
    lines.append("|----------|-------|")

    for severity in Severity:
        count = result.finding_counts_by_severity.get(severity.value, 0)
        emoji = SEVERITY_EMOJI.get(severity, "")
        lines.append(f"| {emoji} {severity.value.capitalize()} | {count} |")

    lines.append("")
    lines.append(f"**Total Findings:** {len(result.findings)}")
    lines.append("")

    # Detailed findings
    if result.findings:
        lines.append("## Findings")
        lines.append("")

        # Group by severity
        findings_by_severity: dict[Severity, list[Finding]] = {}
        for finding in result.findings:
            if finding.severity not in findings_by_severity:
                findings_by_severity[finding.severity] = []
            findings_by_severity[finding.severity].append(finding)

        # Output in severity order
        for severity in Severity:
            findings = findings_by_severity.get(severity, [])
            if not findings:
                continue

            emoji = SEVERITY_EMOJI.get(severity, "")
            lines.append(f"### {emoji} {severity.value.capitalize()} ({len(findings)})")
            lines.append("")

            for i, finding in enumerate(findings, 1):
                lines.extend(_render_finding(finding, i, verbose, include_remediation))
                lines.append("")

    else:
        lines.append("## Findings")
        lines.append("")
        lines.append("*No issues found! Your tool appears to be production-ready.*")
        lines.append("")

    # Footer
    lines.append("---")
    lines.append("")
    lines.append("*Generated by [MCP Readiness Scanner](https://github.com/mcp-readiness/scanner)*")

    return "\n".join(lines)


def _score_badge(score: int) -> str:
    """Generate a score badge."""
    if score >= 90:
        label = "Excellent"
    elif score >= 80:
        label = "Good"
    elif score >= 70:
        label = "Fair"
    elif score >= 50:
        label = "Poor"
    else:
        label = "Critical"

    return f"**{score}/100** ({label})"


def _render_finding(
    finding: Finding,
    index: int,
    verbose: bool,
    include_remediation: bool,
) -> list[str]:
    """Render a single finding as Markdown."""
    lines: list[str] = []

    # Title with category
    category_desc = CATEGORY_DESCRIPTIONS.get(finding.category, {})
    category_name = category_desc.get("name", finding.category.value)

    lines.append(f"#### {index}. {finding.title}")
    lines.append("")

    # Metadata table
    lines.append(f"- **Category:** {category_name}")
    lines.append(f"- **Provider:** {finding.provider}")

    if finding.location:
        lines.append(f"- **Location:** `{finding.location}`")

    if finding.rule_id:
        lines.append(f"- **Rule ID:** `{finding.rule_id}`")

    lines.append("")

    # Description
    lines.append(finding.description)
    lines.append("")

    # Evidence (if verbose)
    if verbose and finding.evidence:
        lines.append("<details>")
        lines.append("<summary>Evidence</summary>")
        lines.append("")
        lines.append("```json")
        import json

        lines.append(json.dumps(finding.evidence, indent=2))
        lines.append("```")
        lines.append("")
        lines.append("</details>")
        lines.append("")

    # Remediation
    if include_remediation and finding.remediation:
        lines.append(f"**Remediation:** {finding.remediation}")
        lines.append("")

    return lines


def render_pr_comment(result: ScanResult) -> str:
    """
    Render a compact PR comment summary.

    Suitable for automated PR comments with key findings only.
    """
    lines: list[str] = []

    # Header with score
    if result.is_production_ready:
        lines.append("## âœ… MCP Readiness Check Passed")
    else:
        lines.append("## âŒ MCP Readiness Check Failed")

    lines.append("")
    lines.append(f"**Score:** {result.readiness_score}/100")

    # Quick stats
    counts = result.finding_counts_by_severity
    critical = counts.get("critical", 0)
    high = counts.get("high", 0)

    if critical > 0 or high > 0:
        lines.append("")
        lines.append("### Issues Requiring Attention")
        lines.append("")

        if critical > 0:
            lines.append(f"- ðŸ”´ **{critical}** critical issue(s)")
        if high > 0:
            lines.append(f"- ðŸŸ  **{high}** high severity issue(s)")

        lines.append("")

        # Show first few critical/high findings
        important_findings = [
            f
            for f in result.findings
            if f.severity in (Severity.CRITICAL, Severity.HIGH)
        ][:5]

        for finding in important_findings:
            lines.append(f"- **{finding.title}**: {finding.description[:100]}...")

        if len(important_findings) < critical + high:
            remaining = critical + high - len(important_findings)
            lines.append(f"- ...and {remaining} more")

    else:
        lines.append("")
        lines.append("No critical or high severity issues found.")

    return "\n".join(lines)
