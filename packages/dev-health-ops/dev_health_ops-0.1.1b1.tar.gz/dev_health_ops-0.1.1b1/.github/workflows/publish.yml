name: Publish to PyPI

on:
  release:
    types: [ published ]
  workflow_dispatch:


jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      python_changed: ${{ steps.check.outputs.python_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for changes
        id: check
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          echo "Current tag: $CURRENT_TAG"

          # Try to find the previous tag reachable from the current tag's parent
          PREV_TAG=$(git describe --abbrev=0 --tags ${CURRENT_TAG}^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found. Triggering release."
            echo "python_changed=true" >> $GITHUB_OUTPUT
          else
            echo "Comparing changes between $PREV_TAG and $CURRENT_TAG"
            # Check for changes in files NOT in the grafana/ directory AND NOT the Grafana release workflow
            CHANGED_FILES=$(git diff --name-only $PREV_TAG $CURRENT_TAG | grep -vE "^grafana/|^.github/workflows/release-grafana-plugin.yml" || true)
            
            if [ -n "$CHANGED_FILES" ]; then
              echo "Python changes detected:"
              echo "$CHANGED_FILES" | head -n 5
              echo "python_changed=true" >> $GITHUB_OUTPUT
            else
              echo "No Python changes detected."
              echo "python_changed=false" >> $GITHUB_OUTPUT
            fi
          fi

  build-and-publish:
    name: Build and publish to PyPI
    needs: check-changes
    if: needs.check-changes.outputs.python_changed == 'true'
    runs-on: ubuntu-latest
    environment:
      name: publishing
      url: https://pypi.org/p/dev-health-ops
    permissions:
      contents: read
      id-token: write # Mandatory for trusted publishing

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build package
        run: python -m build

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
