name: ğŸ Publication PyPI

on:
  push:
    branches: main

jobs:
  pypi:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ·ï¸ Extraire version du tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ“¦ Version PyPI: $VERSION"
      
      - name: ğŸ” VÃ©rifier la version dans gsql/__init__.py
        run: |
          echo "ğŸ” VÃ©rification de la cohÃ©rence des versions..."
          
          # Lire la version depuis gsql/__init__.py
          if [ -f "gsql/__init__.py" ]; then
            CODE_VERSION=$(grep -E "__version__\s*=\s*[\"'][0-9]+\.[0-9]+\.[0-9]+[\"']" "gsql/__init__.py" | head -1 | sed -E "s/.*[\"']([0-9]+\.[0-9]+\.[0-9]+)[\"'].*/\1/")
            
            if [ -n "$CODE_VERSION" ]; then
              echo "âœ… Version dans le code: $CODE_VERSION"
              echo "âœ… Version du tag: $VERSION"
              
              if [ "$CODE_VERSION" != "$VERSION" ]; then
                echo "âš ï¸ ATTENTION: Les versions ne correspondent pas!"
                echo "   Code: $CODE_VERSION"
                echo "   Tag: $VERSION"
                echo "   Le build continuera avec la version du tag."
              fi
            else
              echo "âš ï¸ Version non trouvÃ©e dans gsql/__init__.py"
            fi
          else
            echo "âŒ Fichier gsql/__init__.py introuvable!"
            exit 1
          fi
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ Installer les outils de build
        run: |
          pip install --upgrade pip
          pip install build twine
      
      - name: ğŸ—ï¸ Construire les packages Python
        run: |
          echo "ğŸ—ï¸ Construction des distributions..."
          python -m build
          
          echo "ğŸ“¦ Packages gÃ©nÃ©rÃ©s:"
          ls -la dist/
      
      - name: ğŸ” VÃ©rifier les packages avec twine
        run: |
          echo "ğŸ” VÃ©rification des packages..."
          twine check dist/*
      
      - name: ğŸ“¤ Upload vers PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}
      
      - name: âœ… Confirmation
        run: |
          echo "ğŸ‰ PUBLICATION PYPI RÃ‰USSIE !"
          echo "============================="
          echo "ğŸ“¦ Package: gsql"
          echo "ğŸ·ï¸ Version: $VERSION"
          echo ""
          echo "ğŸ”§ Installation:"
          echo "  pip install gsql==$VERSION"
          echo ""
          echo "ğŸŒ Liens:"
          echo "  - https://pypi.org/project/gsql/"
          echo "  - https://pypi.org/project/gsql/$VERSION/"
