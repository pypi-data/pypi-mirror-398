name: ğŸš€ CI/CD et Publication Multi-Plateformes

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '**.md'
  pull_request:
    branches: [ main ]
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOCKER_USERNAME: ceoseshell

jobs:
  # Job 1 : Tests rapides sur chaque push
  test:
    runs-on: ubuntu-latest
    if: github.event_name != 'release'
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
    
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ”§ Installation et test basique
      run: |
        pip install -e .
        gsql --version
        python -c "import gsql; print('âœ… Import GSQL rÃ©ussi')"

  # Job 2 : Publication sur Docker Hub (seulement sur Release)
  publish-docker:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
    
    - name: ğŸ³ Configuration Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ” Connexion Ã  Docker Hub
      uses: docker/login-action@v3
      with:
        username: ceoseshell
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: ğŸ—ï¸ Construction et envoi de l'image Docker
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ceoseshell/gsql:latest
          ceoseshell/gsql:${{ github.ref_name }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Job 3 : Publication sur PyPI (seulement sur Release)
  publish-pypi:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
    
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Construction du package
      run: |
        pip install build twine
        python -m build
    
    - name: ğŸ“¤ Publication sur PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_TOKEN }}

  # Job 4 : Publication sur Anaconda Cloud (seulement sur Release)
  publish-conda:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
    
    - name: ğŸ Configuration Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniconda-version: "latest"
        auto-update-conda: true
        python-version: "3.9"
    
    - name: ğŸ”§ Installation des outils Conda
      run: |
        conda install -c conda-forge conda-build anaconda-client -y
    
    - name: ğŸ“ CrÃ©ation de la recette Conda
      run: |
        # CrÃ©e automatiquement une recette depuis PyPI
        conda skeleton pypi gsql --output-dir ./conda-recipe
        
        # Optimise la recette pour Ã©viter les conflits
        sed -i "s/  host:/  host:\n    - pip\n    - python/g" ./conda-recipe/gsql/meta.yaml
        sed -i "s/  run:/  run:\n    - python/g" ./conda-recipe/gsql/meta.yaml
    
    - name: ğŸ—ï¸ Construction du package Conda
      run: |
        conda build ./conda-recipe/gsql --output-folder ./conda-bld
    
    - name: ğŸ“¤ Publication sur Anaconda Cloud
      run: |
        anaconda upload --user ceoseshell ./conda-bld/noarch/gsql-*.tar.bz2
      env:
        ANACONDA_TOKEN: ${{ secrets.CONDA_FORGE_TOKEN }}

  # Job 5 : Notification et bilan (toujours exÃ©cutÃ©)
  notify:
    needs: [publish-docker, publish-pypi, publish-conda]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'release'
    
    steps:
    - name: ğŸ“Š Affichage du bilan
      run: |
        echo "ğŸ‰ Publication de GSQL ${{ github.ref_name }} TERMINÃ‰E !"
        echo ""
        echo "ğŸ“¦ Liens de tÃ©lÃ©chargement :"
        echo "  â€¢ PyPI       : https://pypi.org/project/gsql/${{ github.ref_name }}/"
        echo "  â€¢ Docker Hub : https://hub.docker.com/r/ceoseshell/gsql"
        echo "  â€¢ Anaconda   : https://anaconda.org/ceoseshell/gsql"
        echo ""
        echo "ğŸ”— GitHub Release : ${{ github.event.release.html_url }}"
