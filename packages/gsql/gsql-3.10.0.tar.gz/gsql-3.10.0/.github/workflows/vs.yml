name: üê≥ Publication Docker

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*' # D√©clenche aussi sur les tags comme v1.2.3

jobs:
  docker:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout (avec historique complet)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # N√©cessaire pour analyser l'historique des commits

      - name: üî¢ D√©terminer le type d'incr√©ment de version
        id: semver-bump
        run: |
          BUMP_LEVEL="patch" # Valeur par d√©faut
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          
          echo "üìù Message du dernier commit: $LAST_COMMIT_MSG"
          
          if echo "$LAST_COMMIT_MSG" | grep -qi 'bump:\s*major\|#major'; then
            BUMP_LEVEL="major"
            echo "üéØ Incr√©ment MAJEUR d√©tect√©"
          elif echo "$LAST_COMMIT_MSG" | grep -qi 'bump:\s*minor\|#minor'; then
            BUMP_LEVEL="minor"
            echo "üéØ Incr√©ment MINEUR d√©tect√©"
          elif echo "$LAST_COMMIT_MSG" | grep -qi 'bump:\s*patch\|#patch'; then
            BUMP_LEVEL="patch"
            echo "üéØ Incr√©ment PATCH d√©tect√©"
          fi
          
          echo "bump-level=$BUMP_LEVEL" >> $GITHUB_OUTPUT
          echo "üìä Niveau d'incr√©ment final: $BUMP_LEVEL"

      - name: üîß Extraire la version actuelle du code
        id: extract-version
        run: |
          if [ -f "gsql/__init__.py" ]; then
            VERSION=$(grep -E "__version__\s*=\s*['\"][0-9]+\.[0-9]+\.[0-9]+['\"]" "gsql/__init__.py" | head -1 | sed -E "s/.*['\"]([0-9]+\.[0-9]+\.[0-9]+)['\"].*/\1/")
            if [ -n "$VERSION" ]; then
              echo "üìå Version actuelle dans le code: $VERSION"
              echo "current-version=$VERSION" >> $GITHUB_OUTPUT
            else
              echo "‚ùå ERREUR: Format de version non trouv√© dans gsql/__init__.py"
              echo "Le fichier doit contenir: __version__ = 'X.Y.Z'"
              exit 1
            fi
          else
            echo "‚ùå ERREUR: Fichier gsql/__init__.py non trouv√©"
            exit 1
          fi

      - name: üßÆ Calculer et appliquer la nouvelle version
        id: calculate-version
        run: |
          CURRENT_VERSION="${{ steps.extract-version.outputs.current-version }}"
          BUMP_LEVEL="${{ steps.semver-bump.outputs.bump-level }}"
          
          echo "üîÑ Calcul de la nouvelle version depuis: $CURRENT_VERSION"
          echo "Niveau d'incr√©ment: $BUMP_LEVEL"
          
          # S√©paration des parties de version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          # Application de l'incr√©ment
          case "$BUMP_LEVEL" in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          
          # Mise √† jour du fichier __init__.py avec la nouvelle version
          sed -i.bak -E "s/__version__\s*=\s*['\"][0-9]+\.[0-9]+\.[0-9]+['\"]/__version__ = '$NEW_VERSION'/" "gsql/__init__.py"
          
          # V√©rification
          UPDATED_VERSION=$(grep -E "__version__\s*=\s*['\"][0-9]+\.[0-9]+\.[0-9]+['\"]" "gsql/__init__.py" | head -1 | sed -E "s/.*['\"]([0-9]+\.[0-9]+\.[0-9]+)['\"].*/\1/")
          
          if [ "$UPDATED_VERSION" = "$NEW_VERSION" ]; then
            echo "‚úÖ Fichier __init__.py mis √† jour: $CURRENT_VERSION ‚Üí $NEW_VERSION"
            echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "version-updated=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå ERREUR: √âchec de la mise √† jour de la version"
            exit 1
          fi
          
          # Cr√©ation d'un tag Git (optionnel)
          if [[ "${{ github.ref }}" != refs/tags/* ]]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add gsql/__init__.py
            git commit -m "chore: version $NEW_VERSION [skip ci]" || echo "‚ö†Ô∏è Pas de changement √† committer"
            git tag -a "v$NEW_VERSION" -m "Version $NEW_VERSION"
            echo "git-tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: üè∑Ô∏è D√©terminer les tags Docker
        id: docker-tag
        run: |
          NEW_VERSION="${{ steps.calculate-version.outputs.new-version }}"
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/v}"
            echo "üîñ Tag Git d√©tect√©: $TAG_NAME"
            echo "DOCKER_TAGS=ceoseshell/gsql:latest,ceoseshell/gsql:$TAG_NAME" >> $GITHUB_OUTPUT
          else
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            CLEAN_BRANCH_NAME="${BRANCH_NAME//\//-}"
            
            if [[ "$BRANCH_NAME" == "main" ]]; then
              echo "üåø Branche main d√©tect√©e"
              echo "DOCKER_TAGS=ceoseshell/gsql:latest,ceoseshell/gsql:$NEW_VERSION" >> $GITHUB_OUTPUT
            else
              echo "üåø Branche d√©tect√©e: $BRANCH_NAME"
              echo "DOCKER_TAGS=ceoseshell/gsql:$NEW_VERSION,ceoseshell/gsql:$CLEAN_BRANCH_NAME" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo "üì¶ Tags Docker: ${{ steps.docker-tag.outputs.DOCKER_TAGS }}"

      - name: üìÑ Lire et formater le contenu du README
        id: readme-content
        run: |
          if [ -f "README.md" ]; then
            # Lire et formater pour JSON (√©chappement des sauts de ligne et guillemets)
            CONTENT=$(cat README.md | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g' | sed "s/'/\\\'/g")
            
            # Tronquer si trop long (limite Docker ~65535 caract√®res)
            if [ ${#CONTENT} -gt 60000 ]; then
              echo "‚ö†Ô∏è README tronqu√© (trop long pour les labels Docker)"
              CONTENT="${CONTENT:0:60000} [TEXT TRUNCATED]"
            fi
            
            echo "content=$CONTENT" >> $GITHUB_OUTPUT
            echo "üìñ README lu (${#CONTENT} caract√®res)"
          else
            echo "‚ö†Ô∏è Fichier README.md non trouv√©"
            echo "content=" >> $GITHUB_OUTPUT
          fi

      - name: üê≥ Login √† Docker Hub
        uses: docker/login-action@v3
        with:
          username: ceoseshell
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üîß Configurer Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest

      - name: üê≥ Build & Push l'image Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.docker-tag.outputs.DOCKER_TAGS }}
          labels: |
            version=${{ steps.calculate-version.outputs.new-version }}
            build.date=${{ github.event.head_commit.timestamp }}
            vcs.ref=${{ github.sha }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.description=${{ steps.readme-content.outputs.content }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            VERSION=${{ steps.calculate-version.outputs.new-version }}

      - name: üîñ Pousser le tag Git (optionnel)
        if: steps.calculate-version.outputs.git-tag && github.ref != 'refs/tags/*'
        run: |
          echo "üè∑Ô∏è Pousser le tag Git v${{ steps.calculate-version.outputs.new-version }}"
          git push origin "v${{ steps.calculate-version.outputs.new-version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚úÖ Confirmation de publication
        run: |
          echo ""
          echo "üéâ PUBLICATION DOCKER R√âUSSIE !"
          echo "================================"
          echo "Image: ceoseshell/gsql"
          echo "Version: ${{ steps.calculate-version.outputs.new-version }}"
          echo ""
          echo "üì¶ Tags publi√©s:"
          IFS=',' read -ra TAGS <<< "${{ steps.docker-tag.outputs.DOCKER_TAGS }}"
          for tag in "${TAGS[@]}"; do
            echo "  - $tag"
          done
          echo ""
          echo "üìä M√©tadonn√©es:"
          echo "  - Version: ${{ steps.calculate-version.outputs.new-version }}"
          echo "  - SHA: ${{ github.sha }}"
          echo "  - Date: ${{ github.event.head_commit.timestamp }}"
          echo "  - README int√©gr√©: ${{ steps.readme-content.outputs.content != '' && 'Oui' || 'Non' }}"
          echo ""
          echo "üåê Liens:"
          echo "  - Docker Hub: https://hub.docker.com/r/ceoseshell/gsql"
          echo "  - GitHub: https://github.com/${{ github.repository }}"
          echo ""
