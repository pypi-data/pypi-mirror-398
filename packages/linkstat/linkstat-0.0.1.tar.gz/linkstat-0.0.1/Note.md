一旦最初のスコープとしてはmdを対象とする。

- リポジトリ内のmdをリストアップ
- ユーザーのフィルタを適用
- キャッシュを開けて、PRの差分が発生していないものに関しては除外する。この時点でチェック対象はキャッシュに入っておらず、かつPRで変更されたリンクのみとなる。
- チェックリストをキャッシュとして格納する。
- ドキュメントを精査してリンクを見つけてリクエストを飛ばす。
- 200だったらOK。それ以外だったらfailedList的なものにいれる。
- 最後にリストを表示する。

出力は
- ファイル名
- ファイルに含まれているリンクの数
- リンクチェック結果（OとかXで表現。キャッシュの場合はCとかでいいかも）

トータルリンク数とXだったリンク

verboseオプションとquietオプションも考えたい。ベースとしてはpytestが理想。

httpとhttpsは同じと判定するべきか？
→別と判定すべき。サーバーが別である可能性があるため。

## サービス負荷対策について
達成したいこと：同一アクションにおいてコミットのたびに同じリンクにアクセスする事を避けたい。
理由：相手側のサービスに負担をかける事を防ぐため。

キャッシュはファイル単位ではなくリンク単位が良さそう。
というのも同じリンクが別ファイルにも存在している可能性も考えられるため。
同じリンクを同一アクションで複数回チェックする必要はない。

## 重複チェックについて
「単体のドキュメントに同じリンク」と、「別のドキュメントに同じリンク」の2パターンが存在する。
Aのドキュメントの中に重複リンクがあった場合→1つだけチェックして重複フラグをつけておく。
Aのドキュメント内には重複リンクは無いが、Bのドキュメントの中にAのドキュメントの中と同じリンクがあった場合→これも同じく1つだけチェックする。

ドキュメントごとの重複と、検査したドキュメント全体での重複チェックが必要。どうしたもんか。
一旦全部ドキュメントからリンクを抽出して、それをまとめて重複チェックしたほうがいいんじゃないか？
ドキュメント内重複チェックと、検査全体のチェックは結局やってる事は同じ。

## レポート
オプションなし（デフォルト）
```shell
tests/sample_doc/doc1.md .
tests/sample_doc/doc2.md X


NG tests/sample_doc/doc2.md:7: https://example.jp - gaierror(11001, 'getaddrinfo failed')

1 NG, 9 OK
```
--vオプション（詳細モード）

```shell
{"file"}:{"line"}: {"link"} {"result"} [ xx%]
tests/sample_doc/doc1.md:4: https://example.com OK [ 50%]
tests/sample_doc/doc2.md:7: https://example.jp NG [ 75%]

NG tests/sample_doc/doc2.md:7: https://example.jp - gaierror(11001, 'getaddrinfo failed')
```

# リスク
Actionを実行するたびにリンクチェックをすると相手に迷惑がかかる。下手したら攻撃扱いされる。
少なくとも毎回チェックはしないような仕組みが必要。キャッシュなりアーティファクトなりで。
- 通常はPRで発生した差分のみ。
- チェック結果をキャッシュする。
- PRで発生した差分に関してはキャッシュに関係なくチェックする（アーティファクトであればPRスコープだから初回は全チェックされる想定）

アーティファクトの設定を利用者側に強いる事になるがこれは考えとしては正しいのかは考えないといけない。

前回のコミット差分にあるリンクだけをチェックするようにすればどうだ？
→初回はPRに含まれている全体がチェック対象となり、２回目以降はそのコミットに含まれている新規に追加されたリンクだけをチェックするようにすれば無駄なチェックが発生しないという想定。

となると、コミットの差分だけを持ってくるみたいな処理が追加で必要になる。
重要なのは、相手に負荷をかけないこと。これが絶対。

# リスト
リンク切れリストに含める情報
- ファイル名
- ファイルパス（相対パス）
- 切れていたリンク

# やりたいこと
- 数が多いので並列処理ができるように工夫する
- どのファイルをチェックするか、またはチェックしないかのフィルタリングができるようにする
    - .gitとかnode_moduleとかはデフォルトで対象外にする。あとはテスト用のドキュメントなど、チェックしなくてもよいものはユーザー側でチェック対象から外せるようにする。

# 対応どうするか迷ってる事
- 社内Backlogとかのリンクについて
アクセス権限が無いとチェックできない（404になる）けど、権限があれば閲覧できるものについて
これを見れるようにするためにはAction内に認証情報を埋め込む必要がある。ここまでやってリンクを確認したいかと言われたら、社内のナレッジに向けたものもきちんとリンクが生きているかは確認すべき。
であれば、仕組みとしては入れたいが、どうすればよいか？
一つあるとすればユーザー名とパスワード、またはトークンのようなものが入れられる状態にする。
ただBacklogだと確かBasic認証の画面が出てくる感じだった。これをAction内で処理するのは難しそう。ヘッドレスのブラウザとかを使わないといけないし、何よりサービス毎に対応方法が違うのでめちゃくちゃ依存してしまう。
→なので一旦は考えない事にする。最悪誰かがフォークしてくれるだろう精神

単体ファイル指定の対応を忘れていたので追加。
やっぱりテスト駆動は最高である。単体ファイル対応前にいくつかテストを追加して、単体ファイルの場合のパターンを追加
最初はエラーになったけど直したらちゃんと通った。過去のテストが通っているという事は壊れていないということが保証できている。やっぱこの安心感よ。今までの機能を壊すことなく、新たに機能を追加できた喜び。

テストを書いている＝品質の良いコード
これは必ずしも当てはまらない。少なくともテストが書けている時点で設計としては良いが、品質が良いとは限らない。
あくまでテストが書けるコードとは「悪い品質ではない」事を保証するだけで「良い品質」である事を保証するものではない。
mainメソッドに対してテストが実行できるだけでは、良いコードであるとは言えない。
品質のよいテストを書いて初めて品質の良いコードになる。例えば保守がしやすいとか拡張しやすいとか。
