"use strict";(self.webpackChunkdeepagent_lab=self.webpackChunkdeepagent_lab||[]).push([[777],{777:(e,t,n)=>{n.r(t),n.d(t,{default:()=>y});var a=n(324),s=n(882),o=n(555),r=n(345),l=n.n(r),i=n(766),c=n(603),d=n(596);async function m(e="",t={}){const n=d.ServerConnection.makeSettings(),a=c.URLExt.join(n.baseUrl,"deepagent-lab",e);let s;try{s=await d.ServerConnection.makeRequest(a,t,n)}catch(e){throw new d.ServerConnection.NetworkError(e)}let o=await s.text();if(o.length>0)try{o=JSON.parse(o)}catch(e){console.log("Not a JSON response body.",s)}if(!s.ok)throw new d.ServerConnection.ResponseError(s,o.message||o);return o}var g=n(249),p=n.n(g),u=n(230);const h=({shell:e,browserFactory:t})=>{const[n,a]=(0,r.useState)([]),[s,o]=(0,r.useState)(""),[c,d]=(0,r.useState)(!1),[g,h]=(0,r.useState)("unknown"),[v,f]=(0,r.useState)(()=>crypto.randomUUID()),[E,y]=(0,r.useState)(!1),b=(0,r.useRef)(null),w=(0,r.useRef)(null);(0,r.useEffect)(()=>{var e;null===(e=b.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[n]),(0,r.useEffect)(()=>{const e=setTimeout(()=>{S()},2e3);return()=>clearTimeout(e)},[]);const S=async()=>{try{(await m("health",{method:"GET"})).agent_loaded?(h("healthy"),N("Agent is ready and connected")):(h("error"),N("Agent not loaded. Please ensure agent.py is configured correctly."))}catch(e){console.error("Error checking agent health:",e),h("error"),N("Failed to connect to agent service")}},N=e=>{const t={id:Date.now().toString(),role:"system",content:e,timestamp:new Date};a(e=>[...e,t])},k=()=>{const e=document.cookie.match("\\b_xsrf=([^;]*)\\b");return e?e[1]:""},C=async()=>{var n,r,l,m;if(!s.trim()||c)return;const g={id:Date.now().toString(),role:"user",content:s,timestamp:new Date};a(e=>[...e,g]);const p=s;o(""),d(!0);let u="",h="";if(t){const e=t.tracker.currentWidget;e&&(u=e.model.path)}if(e&&e.currentWidget){const t=e.currentWidget,a=t.title.label;(null===(n=t.context)||void 0===n?void 0:n.path)?h=t.context.path:"Launcher"===a?h="JupyterLab Launcher":a.startsWith("Terminal")?h=`Terminal: ${a}`:a&&(h=a)}let f="",E="";if(e&&e.currentWidget){const t=e.currentWidget;if(t instanceof i.NotebookPanel){const e=t.content,n=e.activeCell;if(n&&n.editor){const t=n.editor,a=t.getSelection();if(a.start.line!==a.end.line||a.start.column!==a.end.column){f=t.model.sharedModel.getSource().substring(t.getOffsetAt(a.start),t.getOffsetAt(a.end));const s=null===(r=e.model)||void 0===r?void 0:r.cells;let o=-1;if(s)for(let e=0;e<s.length;e++)if(s.get(e)===n.model){o=e;break}o>=0&&(E=`cell_${o}`)}}}else if(null===(l=t.content)||void 0===l?void 0:l.editor){const e=t.content.editor,n=e.getSelection();if(n.start.line!==n.end.line||n.start.column!==n.end.column){f=e.model.sharedModel.getSource().substring(e.getOffsetAt(n.start),e.getOffsetAt(n.end));const t=n.start.line+1,a=n.end.line+1;E=t===a?`line_${t}`:`lines_${t}-${a}`}}}console.log("Sending message with thread_id:",v),console.log("Current directory:",u),console.log("Focused widget:",h),console.log("Selected text:",f?`${f.length} characters at ${E}`:"none");const b=(Date.now()+1).toString();let S=[],C="",_=[],D=[];try{const e=k(),t=await fetch("/deepagent-lab/chat",{method:"POST",headers:{"Content-Type":"application/json","X-XSRFToken":e},body:JSON.stringify({message:p,stream:!0,thread_id:v,current_directory:u,focused_widget:h,selected_text:f,selection_metadata:E})});if(!t.body)throw new Error("No response body");const n=t.body.getReader(),s=new TextDecoder;for(;;){const{done:e,value:t}=await n.read();if(e)break;const o=s.decode(t).split("\n");for(const e of o)if(e.startsWith("data: "))try{const t=JSON.parse(e.slice(6));console.log("Received SSE data:",t),"streaming"===t.status?(t.tool_calls&&t.tool_calls.forEach(e=>{_.push({...e})}),t.todo_list&&(D=t.todo_list),t.chunk&&(S.push(t.chunk),C=t.chunk,console.log("Updated content:",C,"Intermediates:",S.length)),a(e=>e.find(e=>e.id===b)?e.map(e=>e.id===b?{...e,content:C,intermediates:[...S],toolCalls:_.length>0?[..._]:void 0,todoList:D.length>0?[...D]:void 0}:e):[...e,{id:b,role:"assistant",content:C,timestamp:new Date,intermediates:[...S],toolCalls:_.length>0?[..._]:void 0,todoList:D.length>0?[...D]:void 0}])):"interrupt"===t.status?(y(!0),a(e=>e.find(e=>e.id===b)?e.map(e=>e.id===b?{...e,interrupt:t.interrupt}:e):[...e,{id:b,role:"assistant",content:"",timestamp:new Date,interrupt:t.interrupt}])):"complete"===t.status?(console.log("Stream complete. Final content:",C),a(e=>!e.find(e=>e.id===b)&&(C||_.length>0||D.length>0)?[...e,{id:b,role:"assistant",content:C,timestamp:new Date,intermediates:S.length>0?[...S]:void 0,toolCalls:_.length>0?[..._]:void 0,todoList:D.length>0?[...D]:void 0}]:e)):"cancelled"===t.status?(console.log("Execution cancelled"),N(t.message||"Execution cancelled by user")):"error"===t.status&&(console.error("Stream error:",t.error),a(e=>[...e,{id:b,role:"assistant",content:t.error||"An error occurred",timestamp:new Date,error:!0}]))}catch(e){console.error("Error parsing SSE data:",e)}}}catch(e){console.error("Error sending message:",e);const t={id:b,role:"assistant",content:`Error: ${e instanceof Error?e.message:"Failed to send message"}`,timestamp:new Date,error:!0};a(e=>e.find(e=>e.id===b)?e.map(e=>e.id===b?t:e):[...e,t])}finally{d(!1),null===(m=w.current)||void 0===m||m.focus()}},_=async e=>{var t;y(!1),d(!0);try{const t=k(),n=await fetch("/deepagent-lab/resume",{method:"POST",headers:{"Content-Type":"application/json","X-XSRFToken":t},body:JSON.stringify({decisions:e,thread_id:v})});if(!n.body)throw new Error("No response body");const s=n.body.getReader(),o=new TextDecoder,r=(Date.now()+1).toString();let l=[],i="",c=[],d=[];for(;;){const{done:e,value:t}=await s.read();if(e)break;const n=o.decode(t).split("\n");for(const e of n)if(e.startsWith("data: "))try{const t=JSON.parse(e.slice(6));console.log("Resume SSE data:",t),"streaming"===t.status?(t.tool_calls&&t.tool_calls.forEach(e=>{c.push({...e})}),t.todo_list&&(d=t.todo_list),t.chunk&&(l.push(t.chunk),i=t.chunk),a(e=>e.find(e=>e.id===r)?e.map(e=>e.id===r?{...e,content:i,intermediates:[...l],toolCalls:c.length>0?[...c]:void 0,todoList:d.length>0?[...d]:void 0}:e):[...e,{id:r,role:"assistant",content:i,timestamp:new Date,intermediates:[...l],toolCalls:c.length>0?[...c]:void 0,todoList:d.length>0?[...d]:void 0}])):"interrupt"===t.status?(y(!0),a(e=>e.find(e=>e.id===r)?e.map(e=>e.id===r?{...e,interrupt:t.interrupt}:e):[...e,{id:r,role:"assistant",content:"",timestamp:new Date,interrupt:t.interrupt}])):"complete"===t.status?console.log("Resume complete"):"cancelled"===t.status?(console.log("Resume cancelled"),N(t.message||"Execution cancelled by user")):"error"===t.status&&(console.error("Resume error:",t.error),a(e=>[...e,{id:r,role:"assistant",content:t.error||"An error occurred",timestamp:new Date,error:!0}]))}catch(e){console.error("Error parsing resume SSE data:",e)}}}catch(e){console.error("Error resuming from interrupt:",e),N(`Error: ${e instanceof Error?e.message:"Failed to resume"}`)}finally{d(!1),null===(t=w.current)||void 0===t||t.focus()}};return l().createElement("div",{className:"deepagents-chat-container"},l().createElement("div",{className:"deepagents-chat-header"},l().createElement("h2",{className:"deepagents-chat-title"},"Deep Agents"),l().createElement("div",{className:"deepagents-chat-controls"},l().createElement("span",{className:`deepagents-status-indicator deepagents-status-${g}`,title:"healthy"===g?"Agent connected":"Agent not available"}),l().createElement("button",{className:"deepagents-icon-button",onClick:async()=>{d(!0);try{await m("reload",{method:"POST"}),N("Agent reloaded successfully"),await S()}catch(e){console.error("Error reloading agent:",e),N("Failed to reload agent")}finally{d(!1)}},disabled:c,title:"Reload agent"},l().createElement(u.RotateCw,{size:14})),l().createElement("button",{className:"deepagents-icon-button",onClick:()=>{a([]),f(crypto.randomUUID())},title:"Clear chat"},l().createElement(u.Trash2,{size:14})))),l().createElement("div",{className:"deepagents-chat-messages"},0===n.length?l().createElement("div",{className:"deepagents-chat-empty"},l().createElement("p",null,"Start a conversation with your agent")):n.map(e=>{var t,n,a,s,o,r,i;return l().createElement("div",{key:e.id,className:`deepagents-message deepagents-message-${e.role} ${e.error?"deepagents-message-error":""}`},l().createElement("div",{className:"deepagents-message-header"},l().createElement("span",{className:"deepagents-message-role"},"user"===e.role?"You":"assistant"===e.role?"Agent":"System"),l().createElement("span",{className:"deepagents-message-time"},e.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))),l().createElement("div",{className:"deepagents-message-content"},e.intermediates&&e.intermediates.length>1&&l().createElement("div",{className:"deepagents-message-intermediates"},e.intermediates.slice(0,-1).map((e,t)=>l().createElement("div",{key:t,className:"deepagents-intermediate-message"},e))),e.toolCalls&&e.toolCalls.length>0&&l().createElement("div",{className:"deepagents-tool-calls"},e.toolCalls.map((e,t)=>l().createElement("details",{key:t,className:"deepagents-tool-call"},l().createElement("summary",{className:"deepagents-tool-call-summary"},e.name),l().createElement("div",{className:"deepagents-tool-call-args"},((e,t=150)=>{const n={};for(const[a,s]of Object.entries(e)){const e=JSON.stringify(s);e.length>t?n[a]=e.substring(0,t)+"...":n[a]=s}return JSON.stringify(n)})(e.args))))),e.todoList&&e.todoList.length>0&&l().createElement("div",{className:"deepagents-todo-list"},e.todoList.map((e,t)=>l().createElement("div",{key:t,className:`deepagents-todo-item deepagents-todo-${e.status}`},l().createElement("span",{className:"deepagents-todo-marker"},"completed"===e.status?l().createElement(u.CheckCircle2,{size:16}):"in_progress"===e.status?l().createElement(u.ArrowRight,{size:16}):l().createElement(u.Circle,{size:16})),l().createElement("span",{className:"deepagents-todo-content"},e.content)))),e.interrupt&&l().createElement("div",{className:"deepagents-interrupt"},l().createElement("div",{className:"deepagents-interrupt-header"},"Approval required"),l().createElement("div",{className:"deepagents-interrupt-description"},"Tool: ",l().createElement("strong",null,null===(t=e.interrupt.action_requests[0])||void 0===t?void 0:t.tool)),l().createElement("div",{className:"deepagents-action-decisions"},(null===(a=null===(n=e.interrupt)||void 0===n?void 0:n.review_configs[0])||void 0===a?void 0:a.allowed_decisions.includes("approve"))&&l().createElement("button",{className:"deepagents-decision-btn deepagents-approve-btn",onClick:()=>{_([{type:"approve"}])},disabled:!E||c},"Approve"),(null===(o=null===(s=e.interrupt)||void 0===s?void 0:s.review_configs[0])||void 0===o?void 0:o.allowed_decisions.includes("reject"))&&l().createElement("button",{className:"deepagents-decision-btn deepagents-reject-btn",onClick:()=>{_([{type:"reject"}])},disabled:!E||c},"Reject"),(null===(i=null===(r=e.interrupt)||void 0===r?void 0:r.review_configs[0])||void 0===i?void 0:i.allowed_decisions.includes("edit"))&&l().createElement("button",{className:"deepagents-decision-btn deepagents-edit-btn",onClick:()=>{const t=prompt("Edit arguments (JSON):",JSON.stringify(e.interrupt.action_requests[0].args,null,2));if(t)try{const e=JSON.parse(t);_([{type:"edit",args:e}])}catch(e){alert("Invalid JSON")}},disabled:!E||c},"Edit"))),"assistant"===e.role?l().createElement(p(),null,e.content):e.content))}),c&&l().createElement("div",{className:"deepagents-message deepagents-message-assistant"},l().createElement("div",{className:"deepagents-message-header"},l().createElement("span",{className:"deepagents-message-role"},"Agent")),l().createElement("div",{className:"deepagents-message-content deepagents-typing-indicator"},l().createElement("span",null),l().createElement("span",null),l().createElement("span",null))),l().createElement("div",{ref:b})),l().createElement("div",{className:"deepagents-chat-input-container"},l().createElement("textarea",{ref:w,className:"deepagents-chat-input",placeholder:"Type your message... (Shift+Enter for new line)",value:s,onChange:e=>o(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),C())},disabled:c,rows:1}),c?l().createElement("button",{className:"deepagents-stop-button",onClick:async()=>{try{await m("cancel",{method:"POST",body:JSON.stringify({thread_id:v})}),console.log("Cancellation requested for thread:",v)}catch(e){console.error("Error cancelling execution:",e)}},title:"Stop execution","aria-label":"Stop execution"},l().createElement(u.Square,{size:16,fill:"currentColor"})):l().createElement("button",{className:"deepagents-send-button",onClick:C,disabled:!s.trim(),title:"Send message","aria-label":"Send message"},l().createElement(u.Send,{size:18}))))};class v extends a.ReactWidget{constructor(e=null,t=null){super(),this.addClass("deepagents-chat-widget"),this.shell=e,this.browserFactory=t}render(){return l().createElement(h,{shell:this.shell,browserFactory:this.browserFactory})}}const f=new s.LabIcon({name:"deepagents:chat",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>'});var E;!function(e){e.openChat="deepagents:open-chat"}(E||(E={}));const y={id:"deepagent-lab:plugin",description:"A JupyterLab extension for DeepAgents chat interface",autoStart:!0,optional:[a.ICommandPalette,o.IFileBrowserFactory],activate:(e,t,n)=>{console.log("JupyterLab extension deepagent-lab is activated!");const a=new v(e.shell,n);a.id="deepagents-chat",a.title.label="Deep Agents",a.title.icon=f,a.title.closable=!0,e.shell.add(a,"right",{rank:500}),e.commands.addCommand(E.openChat,{label:"Deep Agents",caption:"Open DeepAgents chat interface",icon:f,execute:()=>{a.isAttached||e.shell.add(a,"right",{rank:500}),e.shell.activateById(a.id)}}),t&&t.addItem({command:E.openChat,category:"Deep Agents"}),console.log("DeepAgents chat interface ready")}}}}]);