"use strict";(self.webpackChunkdeepagent_lab=self.webpackChunkdeepagent_lab||[]).push([[344],{344(e,t,n){n.r(t),n.d(t,{default:()=>y});var a=n(827),s=n(409),o=n(780),r=n(345),l=n.n(r),i=n(389),c=n(292),d=n(907);async function m(e="",t={}){const n=d.ServerConnection.makeSettings(),a=c.URLExt.join(n.baseUrl,"deepagent-lab",e);let s;try{s=await d.ServerConnection.makeRequest(a,t,n)}catch(e){throw new d.ServerConnection.NetworkError(e)}let o=await s.text();if(o.length>0)try{o=JSON.parse(o)}catch(e){console.log("Not a JSON response body.",s)}if(!s.ok)throw new d.ServerConnection.ResponseError(s,o.message||o);return o}var g=n(249),p=n.n(g),u=n(230);const h=({shell:e,browserFactory:t,onAgentNameChange:n})=>{const[a,s]=(0,r.useState)([]),[o,c]=(0,r.useState)(""),[d,g]=(0,r.useState)(!1),[h,f]=(0,r.useState)("unknown"),[v,E]=(0,r.useState)("Deep Agents"),[y,b]=(0,r.useState)(()=>crypto.randomUUID()),[w,S]=(0,r.useState)(!1),N=(0,r.useRef)(null),C=(0,r.useRef)(null);(0,r.useEffect)(()=>{var e;null===(e=N.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[a]),(0,r.useEffect)(()=>{const e=setTimeout(()=>{k()},2e3);return()=>clearTimeout(e)},[]);const k=async()=>{try{const e=await m("health",{method:"GET"});if(e.agent_loaded){f("healthy");const t=e.agent_name||"Deep Agents";E(t),n&&n(t),_("Agent is ready and connected")}else f("error"),_("Agent not loaded. Please ensure agent.py is configured correctly.")}catch(e){console.error("Error checking agent health:",e),f("error"),_("Failed to connect to agent service")}},_=e=>{const t={id:Date.now().toString(),role:"system",content:e,timestamp:new Date};s(e=>[...e,t])},A=()=>{const e=document.cookie.match("\\b_xsrf=([^;]*)\\b");return e?e[1]:""},D=async()=>{var n,a,r,l;if(!o.trim()||d)return;const m={id:Date.now().toString(),role:"user",content:o,timestamp:new Date};s(e=>[...e,m]);const p=o;c(""),g(!0);let u="",h="";if(t){const e=t.tracker.currentWidget;e&&(u=e.model.path)}if(e&&e.currentWidget){const t=e.currentWidget,a=t.title.label;(null===(n=t.context)||void 0===n?void 0:n.path)?h=t.context.path:"Launcher"===a?h="JupyterLab Launcher":a.startsWith("Terminal")?h=`Terminal: ${a}`:a&&(h=a)}let f="",v="";if(e&&e.currentWidget){const t=e.currentWidget;if(t instanceof i.NotebookPanel){const e=t.content,n=e.activeCell;if(n&&n.editor){const t=n.editor,s=t.getSelection();if(s.start.line!==s.end.line||s.start.column!==s.end.column){f=t.model.sharedModel.getSource().substring(t.getOffsetAt(s.start),t.getOffsetAt(s.end));const o=null===(a=e.model)||void 0===a?void 0:a.cells;let r=-1;if(o)for(let e=0;e<o.length;e++)if(o.get(e)===n.model){r=e;break}r>=0&&(v=`cell_${r}`)}}}else if(null===(r=t.content)||void 0===r?void 0:r.editor){const e=t.content.editor,n=e.getSelection();if(n.start.line!==n.end.line||n.start.column!==n.end.column){f=e.model.sharedModel.getSource().substring(e.getOffsetAt(n.start),e.getOffsetAt(n.end));const t=n.start.line+1,a=n.end.line+1;v=t===a?`line_${t}`:`lines_${t}-${a}`}}}console.log("Sending message with thread_id:",y),console.log("Current directory:",u),console.log("Focused widget:",h),console.log("Selected text:",f?`${f.length} characters at ${v}`:"none");const E=(Date.now()+1).toString();let b=[],w="",N=[],k=[];try{const e=A(),t=await fetch("/deepagent-lab/chat",{method:"POST",headers:{"Content-Type":"application/json","X-XSRFToken":e},body:JSON.stringify({message:p,stream:!0,thread_id:y,current_directory:u,focused_widget:h,selected_text:f,selection_metadata:v})});if(!t.body)throw new Error("No response body");const n=t.body.getReader(),a=new TextDecoder;for(;;){const{done:e,value:t}=await n.read();if(e)break;const o=a.decode(t).split("\n");for(const e of o)if(e.startsWith("data: "))try{const t=JSON.parse(e.slice(6));console.log("Received SSE data:",t),"streaming"===t.status?(t.tool_calls&&t.tool_calls.forEach(e=>{N.push({...e})}),t.todo_list&&(k=t.todo_list),t.chunk&&(b.push(t.chunk),w=t.chunk,console.log("Updated content:",w,"Intermediates:",b.length)),s(e=>e.find(e=>e.id===E)?e.map(e=>e.id===E?{...e,content:w,intermediates:[...b],toolCalls:N.length>0?[...N]:void 0,todoList:k.length>0?[...k]:void 0}:e):[...e,{id:E,role:"assistant",content:w,timestamp:new Date,intermediates:[...b],toolCalls:N.length>0?[...N]:void 0,todoList:k.length>0?[...k]:void 0}])):"interrupt"===t.status?(S(!0),s(e=>e.find(e=>e.id===E)?e.map(e=>e.id===E?{...e,interrupt:t.interrupt}:e):[...e,{id:E,role:"assistant",content:"",timestamp:new Date,interrupt:t.interrupt}])):"complete"===t.status?(console.log("Stream complete. Final content:",w),s(e=>!e.find(e=>e.id===E)&&(w||N.length>0||k.length>0)?[...e,{id:E,role:"assistant",content:w,timestamp:new Date,intermediates:b.length>0?[...b]:void 0,toolCalls:N.length>0?[...N]:void 0,todoList:k.length>0?[...k]:void 0}]:e)):"cancelled"===t.status?(console.log("Execution cancelled"),_(t.message||"Execution cancelled by user")):"error"===t.status&&(console.error("Stream error:",t.error),s(e=>[...e,{id:E,role:"assistant",content:t.error||"An error occurred",timestamp:new Date,error:!0}]))}catch(e){console.error("Error parsing SSE data:",e)}}}catch(e){console.error("Error sending message:",e);const t={id:E,role:"assistant",content:`Error: ${e instanceof Error?e.message:"Failed to send message"}`,timestamp:new Date,error:!0};s(e=>e.find(e=>e.id===E)?e.map(e=>e.id===E?t:e):[...e,t])}finally{g(!1),null===(l=C.current)||void 0===l||l.focus()}},F=async e=>{var t;S(!1),g(!0);try{const t=A(),n=await fetch("/deepagent-lab/resume",{method:"POST",headers:{"Content-Type":"application/json","X-XSRFToken":t},body:JSON.stringify({decisions:e,thread_id:y})});if(!n.body)throw new Error("No response body");const a=n.body.getReader(),o=new TextDecoder,r=(Date.now()+1).toString();let l=[],i="",c=[],d=[];for(;;){const{done:e,value:t}=await a.read();if(e)break;const n=o.decode(t).split("\n");for(const e of n)if(e.startsWith("data: "))try{const t=JSON.parse(e.slice(6));console.log("Resume SSE data:",t),"streaming"===t.status?(t.tool_calls&&t.tool_calls.forEach(e=>{c.push({...e})}),t.todo_list&&(d=t.todo_list),t.chunk&&(l.push(t.chunk),i=t.chunk),s(e=>e.find(e=>e.id===r)?e.map(e=>e.id===r?{...e,content:i,intermediates:[...l],toolCalls:c.length>0?[...c]:void 0,todoList:d.length>0?[...d]:void 0}:e):[...e,{id:r,role:"assistant",content:i,timestamp:new Date,intermediates:[...l],toolCalls:c.length>0?[...c]:void 0,todoList:d.length>0?[...d]:void 0}])):"interrupt"===t.status?(S(!0),s(e=>e.find(e=>e.id===r)?e.map(e=>e.id===r?{...e,interrupt:t.interrupt}:e):[...e,{id:r,role:"assistant",content:"",timestamp:new Date,interrupt:t.interrupt}])):"complete"===t.status?console.log("Resume complete"):"cancelled"===t.status?(console.log("Resume cancelled"),_(t.message||"Execution cancelled by user")):"error"===t.status&&(console.error("Resume error:",t.error),s(e=>[...e,{id:r,role:"assistant",content:t.error||"An error occurred",timestamp:new Date,error:!0}]))}catch(e){console.error("Error parsing resume SSE data:",e)}}}catch(e){console.error("Error resuming from interrupt:",e),_(`Error: ${e instanceof Error?e.message:"Failed to resume"}`)}finally{g(!1),null===(t=C.current)||void 0===t||t.focus()}};return l().createElement("div",{className:"deepagents-chat-container"},l().createElement("div",{className:"deepagents-chat-header"},l().createElement("h2",{className:"deepagents-chat-title"},v),l().createElement("div",{className:"deepagents-chat-controls"},l().createElement("span",{className:`deepagents-status-indicator deepagents-status-${h}`,title:"healthy"===h?"Agent connected":"Agent not available"}),l().createElement("button",{className:"deepagents-icon-button",onClick:async()=>{g(!0);try{await m("reload",{method:"POST"}),_("Agent reloaded successfully"),await k()}catch(e){console.error("Error reloading agent:",e),_("Failed to reload agent")}finally{g(!1)}},disabled:d,title:"Reload agent"},l().createElement(u.RotateCw,{size:14})),l().createElement("button",{className:"deepagents-icon-button",onClick:()=>{s([]),b(crypto.randomUUID())},title:"Clear chat"},l().createElement(u.Trash2,{size:14})))),l().createElement("div",{className:"deepagents-chat-messages"},0===a.length?l().createElement("div",{className:"deepagents-chat-empty"},l().createElement("p",null,"Start a conversation with your agent")):a.map(e=>{var t,n,a,s,o,r,i;return l().createElement("div",{key:e.id,className:`deepagents-message deepagents-message-${e.role} ${e.error?"deepagents-message-error":""}`},l().createElement("div",{className:"deepagents-message-header"},l().createElement("span",{className:"deepagents-message-role"},"user"===e.role?"You":"assistant"===e.role?"Agent":"System"),l().createElement("span",{className:"deepagents-message-time"},e.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))),l().createElement("div",{className:"deepagents-message-content"},e.intermediates&&e.intermediates.length>1&&l().createElement("div",{className:"deepagents-message-intermediates"},e.intermediates.slice(0,-1).map((e,t)=>l().createElement("div",{key:t,className:"deepagents-intermediate-message"},e))),e.toolCalls&&e.toolCalls.length>0&&l().createElement("div",{className:"deepagents-tool-calls"},e.toolCalls.map((e,t)=>l().createElement("details",{key:t,className:"deepagents-tool-call"},l().createElement("summary",{className:"deepagents-tool-call-summary"},e.name),l().createElement("div",{className:"deepagents-tool-call-args"},((e,t=150)=>{const n={};for(const[a,s]of Object.entries(e)){const e=JSON.stringify(s);e.length>t?n[a]=e.substring(0,t)+"...":n[a]=s}return JSON.stringify(n)})(e.args))))),e.todoList&&e.todoList.length>0&&l().createElement("div",{className:"deepagents-todo-list"},e.todoList.map((e,t)=>l().createElement("div",{key:t,className:`deepagents-todo-item deepagents-todo-${e.status}`},l().createElement("span",{className:"deepagents-todo-marker"},"completed"===e.status?l().createElement(u.CheckCircle2,{size:16}):"in_progress"===e.status?l().createElement(u.ArrowRight,{size:16}):l().createElement(u.Circle,{size:16})),l().createElement("span",{className:"deepagents-todo-content"},e.content)))),e.interrupt&&l().createElement("div",{className:"deepagents-interrupt"},l().createElement("div",{className:"deepagents-interrupt-header"},"Approval required"),l().createElement("div",{className:"deepagents-interrupt-description"},"Tool: ",l().createElement("strong",null,null===(t=e.interrupt.action_requests[0])||void 0===t?void 0:t.tool)),l().createElement("div",{className:"deepagents-action-decisions"},(null===(a=null===(n=e.interrupt)||void 0===n?void 0:n.review_configs[0])||void 0===a?void 0:a.allowed_decisions.includes("approve"))&&l().createElement("button",{className:"deepagents-decision-btn deepagents-approve-btn",onClick:()=>{F([{type:"approve"}])},disabled:!w||d},"Approve"),(null===(o=null===(s=e.interrupt)||void 0===s?void 0:s.review_configs[0])||void 0===o?void 0:o.allowed_decisions.includes("reject"))&&l().createElement("button",{className:"deepagents-decision-btn deepagents-reject-btn",onClick:()=>{F([{type:"reject"}])},disabled:!w||d},"Reject"),(null===(i=null===(r=e.interrupt)||void 0===r?void 0:r.review_configs[0])||void 0===i?void 0:i.allowed_decisions.includes("edit"))&&l().createElement("button",{className:"deepagents-decision-btn deepagents-edit-btn",onClick:()=>{const t=prompt("Edit arguments (JSON):",JSON.stringify(e.interrupt.action_requests[0].args,null,2));if(t)try{const e=JSON.parse(t);F([{type:"edit",args:e}])}catch(e){alert("Invalid JSON")}},disabled:!w||d},"Edit"))),"assistant"===e.role?l().createElement(p(),null,e.content):e.content))}),d&&l().createElement("div",{className:"deepagents-message deepagents-message-assistant"},l().createElement("div",{className:"deepagents-message-header"},l().createElement("span",{className:"deepagents-message-role"},"Agent")),l().createElement("div",{className:"deepagents-message-content deepagents-typing-indicator"},l().createElement("span",null),l().createElement("span",null),l().createElement("span",null))),l().createElement("div",{ref:N})),l().createElement("div",{className:"deepagents-chat-input-container"},l().createElement("textarea",{ref:C,className:"deepagents-chat-input",placeholder:"Type your message... (Shift+Enter for new line)",value:o,onChange:e=>c(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),D())},disabled:d,rows:1}),d?l().createElement("button",{className:"deepagents-stop-button",onClick:async()=>{try{await m("cancel",{method:"POST",body:JSON.stringify({thread_id:y})}),console.log("Cancellation requested for thread:",y)}catch(e){console.error("Error cancelling execution:",e)}},title:"Stop execution","aria-label":"Stop execution"},l().createElement(u.Square,{size:16,fill:"currentColor"})):l().createElement("button",{className:"deepagents-send-button",onClick:D,disabled:!o.trim(),title:"Send message","aria-label":"Send message"},l().createElement(u.Send,{size:18}))))};class f extends a.ReactWidget{constructor(e=null,t=null){super(),this.addClass("deepagents-chat-widget"),this.shell=e,this.browserFactory=t}updateAgentName(e){}render(){return l().createElement(h,{shell:this.shell,browserFactory:this.browserFactory,onAgentNameChange:e=>this.updateAgentName(e)})}}const v=new s.LabIcon({name:"deepagents:chat",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1255 1255" class="jp-icon3">\n  <path d="M0 627.5C0 280.941 280.94 0 627.5 0 974.06 0 1255 280.941 1255 627.5 1255 974.06 974.06 1255 627.5 1255 280.94 1255 0 974.06 0 627.5Z" fill="currentColor" fill-rule="evenodd"/>\n  <path d="M566.5 300 566.5 300C615.43 474.37 736.21 619.01 898 697L898 697C736.21 774.99 615.43 919.62 566.5 1094L566.5 1094C517.54 919.64 396.78 775.01 235 697L235 697C396.78 618.99 517.54 474.36 566.5 300Z" fill="#FFFFFF" fill-rule="evenodd"/>\n  <path d="M872 180 872 180C893.85 261.038 947.77 328.257 1020 364.5L1020 364.5C947.77 400.743 893.85 467.96 872 549L872 549C850.14 467.97 796.23 400.752 724 364.5L724 364.5C796.23 328.248 850.14 261.032 872 180Z" fill="#FFFFFF" fill-rule="evenodd"/>\n</svg>'});var E;!function(e){e.openChat="deepagents:open-chat"}(E||(E={}));const y={id:"deepagent-lab:plugin",description:"A JupyterLab extension for DeepAgents chat interface",autoStart:!0,optional:[a.ICommandPalette,o.IFileBrowserFactory],activate:(e,t,n)=>{console.log("JupyterLab extension deepagent-lab is activated!");const a=new f(e.shell,n);a.id="deepagents-chat",a.title.label="",a.title.icon=v,a.title.closable=!0,a.title.caption="Deep Agents",e.shell.add(a,"right",{rank:1e3}),e.commands.addCommand(E.openChat,{label:"Deep Agents",caption:"Open DeepAgents chat interface",icon:v,execute:()=>{a.isAttached||e.shell.add(a,"right",{rank:1e3}),e.shell.activateById(a.id)}}),t&&t.addItem({command:E.openChat,category:"Deep Agents"}),console.log("DeepAgents chat interface ready")}}}}]);