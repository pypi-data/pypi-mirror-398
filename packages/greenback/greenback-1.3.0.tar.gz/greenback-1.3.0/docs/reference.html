

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>API reference &mdash; greenback 1.2.1+dev documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/documentation_options.js?v=307da5fd"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Release history" href="history.html" />
    <link rel="prev" title="Principle of operation" href="principle.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="principle.html">Principle of operation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">API reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#module-greenback">Creating a portal</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#greenback.ensure_portal"><code class="docutils literal notranslate"><span class="pre">ensure_portal()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#greenback.bestow_portal"><code class="docutils literal notranslate"><span class="pre">bestow_portal()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#greenback.with_portal_run"><code class="docutils literal notranslate"><span class="pre">with_portal_run()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#greenback.with_portal_run_sync"><code class="docutils literal notranslate"><span class="pre">with_portal_run_sync()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#greenback.has_portal"><code class="docutils literal notranslate"><span class="pre">has_portal()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#propagating-portals-to-a-task-s-children">Propagating portals to a task’s children</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#greenback.with_portal_run_tree"><code class="docutils literal notranslate"><span class="pre">with_portal_run_tree()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#greenback.portals_for_tree"><code class="docutils literal notranslate"><span class="pre">portals_for_tree()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#greenback.portals_for_children"><code class="docutils literal notranslate"><span class="pre">portals_for_children()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#greenback.AutoPortalInstrument"><code class="docutils literal notranslate"><span class="pre">AutoPortalInstrument</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-the-portal">Using the portal</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#greenback.await_"><code class="docutils literal notranslate"><span class="pre">await_()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#additional-utilities">Additional utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#greenback.autoawait"><code class="docutils literal notranslate"><span class="pre">autoawait()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#greenback.decorate_as_sync"><code class="docutils literal notranslate"><span class="pre">decorate_as_sync()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#greenback.async_context"><code class="docutils literal notranslate"><span class="pre">async_context()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#greenback.async_iter"><code class="docutils literal notranslate"><span class="pre">async_iter()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="history.html">Release history</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">greenback</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">API reference</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/reference.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="api-reference">
<h1>API reference<a class="headerlink" href="#api-reference" title="Link to this heading">¶</a></h1>
<section id="module-greenback">
<span id="creating-a-portal"></span><h2>Creating a portal<a class="headerlink" href="#module-greenback" title="Link to this heading">¶</a></h2>
<p>In order to use <a class="reference internal" href="#module-greenback" title="greenback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">greenback</span></code></a> in a particular async task, you must first create
a greenback <em>portal</em> for that task to use. You may choose between:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#greenback.ensure_portal" title="greenback.ensure_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">ensure_portal()</span></code></a>: Create a portal to be used by the current task,
which lasts for the lifetime of that task. Use case: minimally invasive
code change to allow <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a> in a particular task.</p></li>
<li><p><a class="reference internal" href="#greenback.bestow_portal" title="greenback.bestow_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">bestow_portal()</span></code></a>: Create a portal to be used by some other specified task,
which lasts for the lifetime of that task. Use case: enabling greenback in a task
without that task’s cooperation, which may be useful in some debugging and
instrumentation situations. (<a class="reference internal" href="#greenback.with_portal_run_tree" title="greenback.with_portal_run_tree"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run_tree()</span></code></a> is implemented
using a Trio instrument that calls <a class="reference internal" href="#greenback.bestow_portal" title="greenback.bestow_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">bestow_portal()</span></code></a> on certain newly
spawned tasks.)</p></li>
<li><p><a class="reference internal" href="#greenback.with_portal_run" title="greenback.with_portal_run"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run()</span></code></a>: Run an async function (in the current task)
that might eventually make calls to <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">await_()</span></code></a>, with a portal
available for at least the duration of that call. Use case: less “magical”
than <a class="reference internal" href="#greenback.ensure_portal" title="greenback.ensure_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">ensure_portal()</span></code></a>; keeps the portal (and its perforamnce impact)
scoped to just the portion of a task that needs it.</p></li>
<li><p><a class="reference internal" href="#greenback.with_portal_run_sync" title="greenback.with_portal_run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run_sync()</span></code></a>: Run a synchronous function (in the
current task) that might eventually make calls to <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">await_()</span></code></a>,
with a portal available for at least the duration of that call.
Use case: same as <a class="reference internal" href="#greenback.with_portal_run" title="greenback.with_portal_run"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run()</span></code></a>, but the implementation is
simpler and will be a bit faster (probably only noticeable if the
function you’re running is very short).</p></li>
<li><p>On Trio, the functions in the <a class="reference internal" href="#tree-portals"><span class="std std-ref">next section</span></a> allow
you to automatically propagate the greenback portal to child tasks of
a certain function or scope. (These don’t work on asyncio, since asyncio
lacks a clear task tree and also lacks the instrumentation features
required to implement them.) Use case: minimally invasive
code change to allow <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a> in an entire subsystem
of your Trio program.</p></li>
</ul>
<p>You can use <a class="reference internal" href="#greenback.has_portal" title="greenback.has_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">has_portal()</span></code></a> to determine whether a portal has already
been set up.</p>
<dl class="py function">
<dt class="sig sig-object py" id="greenback.ensure_portal">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">ensure_portal</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#greenback.ensure_portal" title="Link to this definition">¶</a></dt>
<dd><p>Ensure that the current async task is able to use <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a>.</p>
<p>If the current task has called <a class="reference internal" href="#greenback.ensure_portal" title="greenback.ensure_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">ensure_portal()</span></code></a> previously, calling
it again is a no-op. Otherwise, <a class="reference internal" href="#greenback.ensure_portal" title="greenback.ensure_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">ensure_portal()</span></code></a> interposes a
“coroutine shim” provided by <a class="reference internal" href="#module-greenback" title="greenback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">greenback</span></code></a> in between the event
loop and the coroutine being used to run the task. For example,
when running under Trio, <a class="reference external" href="https://trio.readthedocs.io/en/stable/reference-lowlevel.html#trio.lowlevel.Task.coro" title="(in Trio v0.32.0)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">trio.lowlevel.Task.coro</span></code></a> is replaced with
a wrapper around the coroutine it previously referred to. (The
same thing happens under asyncio, but asyncio doesn’t expose the
coroutine field publicly, so some additional trickery is required
in that case.)</p>
<p>After installation of the coroutine shim, each task step passes
through <a class="reference internal" href="#module-greenback" title="greenback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">greenback</span></code></a> on its way into and out of your code. At
some performance cost, this effectively provides a <strong>portal</strong> that
allows later calls to <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a> in the same task to
access an async environment, even if the function that calls
<a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">await_()</span></code></a> is a synchronous function.</p>
<p>This function is a cancellation point and a schedule point (a checkpoint,
in Trio terms) even if the calling task already had a portal set up.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="greenback.bestow_portal">
<span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">bestow_portal</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">task</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#greenback.bestow_portal" title="Link to this definition">¶</a></dt>
<dd><p>Ensure that the given async <em>task</em> is able to use <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a>.</p>
<p>This works like calling <a class="reference internal" href="#greenback.ensure_portal" title="greenback.ensure_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">ensure_portal()</span></code></a> from within <em>task</em>,
with one exception: if you pass the currently running task, then
the portal will not become usable until after the task yields
control to the event loop.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="greenback.with_portal_run">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">with_portal_run</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">async_fn</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwds</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#greenback.with_portal_run" title="Link to this definition">¶</a></dt>
<dd><p>Execute <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">async_fn(*args,</span> <span class="pre">**kwds)</span></code> in a context that is able
to use <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a>.</p>
<p>If the current task already has a greenback portal set up via a
call to one of the other <code class="docutils literal notranslate"><span class="pre">greenback.*_portal()</span></code> functions, then
<a class="reference internal" href="#greenback.with_portal_run" title="greenback.with_portal_run"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run()</span></code></a> simply calls <em>async_fn</em>.  If <em>async_fn</em>
uses <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a>, the existing portal will take care
of it.</p>
<p>Otherwise (if there is no portal already available to the current task),
<a class="reference internal" href="#greenback.with_portal_run" title="greenback.with_portal_run"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run()</span></code></a> creates a new portal which lasts only for the
duration of the call to <em>async_fn</em>. If <em>async_fn</em> then calls
<a class="reference internal" href="#greenback.ensure_portal" title="greenback.ensure_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">ensure_portal()</span></code></a>, an additional portal will <strong>not</strong> be created:
the task will still have just the portal installed by
<a class="reference internal" href="#greenback.with_portal_run" title="greenback.with_portal_run"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run()</span></code></a>, which will be removed when <em>async_fn</em> returns.</p>
<p>This function does <em>not</em> add any cancellation point or schedule point
beyond those that already exist inside <em>async_fn</em>.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="greenback.with_portal_run_sync">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">with_portal_run_sync</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">sync_fn</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwds</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#greenback.with_portal_run_sync" title="Link to this definition">¶</a></dt>
<dd><p>Execute <code class="docutils literal notranslate"><span class="pre">sync_fn(*args,</span> <span class="pre">**kwds)</span></code> in a context that is able
to use <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a>.</p>
<p>If the current task already has a greenback portal set up via a
call to one of the other <code class="docutils literal notranslate"><span class="pre">greenback.*_portal()</span></code> functions, then
<a class="reference internal" href="#greenback.with_portal_run" title="greenback.with_portal_run"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run()</span></code></a> simply calls <em>sync_fn</em>.  If <em>sync_fn</em>
uses <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a>, the existing portal will take care
of it.</p>
<p>Otherwise (if there is no portal already available to the current task),
<a class="reference internal" href="#greenback.with_portal_run_sync" title="greenback.with_portal_run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run_sync()</span></code></a> creates a new portal which lasts only for the
duration of the call to <em>sync_fn</em>.</p>
<p>This function does <em>not</em> add any cancellation point or schedule point
beyond those that already exist due to any <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">await_()</span></code></a>s inside <em>sync_fn</em>.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="greenback.has_portal">
<span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">has_portal</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">task</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#greenback.has_portal" title="Link to this definition">¶</a></dt>
<dd><p>Return true if the given <em>task</em> is currently able to use
<a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a>, false otherwise. If no <em>task</em> is
specified, query the currently executing task.</p>
</dd></dl>

</section>
<section id="propagating-portals-to-a-task-s-children">
<span id="tree-portals"></span><h2>Propagating portals to a task’s children<a class="headerlink" href="#propagating-portals-to-a-task-s-children" title="Link to this heading">¶</a></h2>
<p>The functions in this section create <em>inheritable</em> greenback portals, impacting
both a task and its children. (“Children” refers to child tasks of nurseries
are contained entirely within the portal’s scope, since it is only those tasks
that are guaranteed not to outlive the portal.)</p>
<p>The automatic “portalization” of child tasks is implemented using a
Trio <a class="reference external" href="https://trio.readthedocs.io/en/stable/reference-lowlevel.html#trio.abc.Instrument" title="(in Trio v0.32.0)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">instrument</span></code></a> (the
<a class="reference internal" href="#greenback.AutoPortalInstrument" title="greenback.AutoPortalInstrument"><code class="xref py py-class docutils literal notranslate"><span class="pre">AutoPortalInstrument</span></code></a>), which has a small performance impact
on task spawning for the entire Trio run. To minimize this impact, a
single instrument is used even if you have multiple inheriting-portal
contexts active simultaneously, and the instrument will be removed as
soon as all of them have completed.</p>
<dl class="py function">
<dt class="sig sig-object py" id="greenback.with_portal_run_tree">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">with_portal_run_tree</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">async_fn</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwds</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#greenback.with_portal_run_tree" title="Link to this definition">¶</a></dt>
<dd><p>Execute <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">async_fn(*args,</span> <span class="pre">**kwds)</span></code> in a context that allows use
of <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a> both in <em>async_fn</em> itself and in any tasks
that are spawned into child nurseries of <em>async_fn</em>, recursively.</p>
<p>You can use this to create an entire Trio run (except system
tasks) that runs with <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a> available: say
<code class="docutils literal notranslate"><span class="pre">trio.run(with_portal_run_tree,</span> <span class="pre">main)</span></code>. (If you want to wrap the
system tasks too, pass an <a class="reference internal" href="#greenback.AutoPortalInstrument" title="greenback.AutoPortalInstrument"><code class="xref py py-class docutils literal notranslate"><span class="pre">AutoPortalInstrument</span></code></a> to <a class="reference external" href="https://trio.readthedocs.io/en/stable/reference-core.html#trio.run" title="(in Trio v0.32.0)"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.run()</span></code></a>
instead.)</p>
<p>This function does <em>not</em> add any cancellation point or schedule point
beyond those that already exist inside <em>async_fn</em>.</p>
<p>Availability: Trio only.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="greenback.portals_for_tree">
<em class="property"><span class="pre">async</span> <span class="pre">with</span> </em><span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">portals_for_tree</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#greenback.portals_for_tree" title="Link to this definition">¶</a></dt>
<dd><p>Return an asynchronous context manager that enables
<a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a> within its scope, for both the task in which
the context manager was entered and any child tasks of nurseries
created while the context manager is active.</p>
<p>Both the entry and the exit of the context manager are schedule points
(other tasks can run), but neither is a cancellation point (this task
cannot be cancelled at them). If you don’t even want a schedule point,
then use <a class="reference internal" href="#greenback.with_portal_run_tree" title="greenback.with_portal_run_tree"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run_tree()</span></code></a> instead.</p>
<p>Availability: Trio only.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="greenback.portals_for_children">
<em class="property"><span class="pre">with</span> </em><span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">portals_for_children</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#greenback.portals_for_children" title="Link to this definition">¶</a></dt>
<dd><p>Return a synchronous context manager that enables
<a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a> for all child tasks of nurseries created
within its scope. The task in which you enter the context manager
does <em>not</em> receive a portal, which is what allows the context manager
to be synchronous.</p>
<p>This is a building block for <a class="reference internal" href="#greenback.portals_for_children" title="greenback.portals_for_children"><code class="xref py py-func docutils literal notranslate"><span class="pre">portals_for_children()</span></code></a> and
<a class="reference internal" href="#greenback.with_portal_run_tree" title="greenback.with_portal_run_tree"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run_tree()</span></code></a>. You probably want to use one of those instead.</p>
<p>Availability: Trio only.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="greenback.AutoPortalInstrument">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">AutoPortalInstrument</span></span><a class="headerlink" href="#greenback.AutoPortalInstrument" title="Link to this definition">¶</a></dt>
<dd><p>A Trio <a class="reference external" href="https://trio.readthedocs.io/en/stable/reference-lowlevel.html#trio.abc.Instrument" title="(in Trio v0.32.0)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Instrument</span></code></a> that automatically gives newly
spawned tasks a greenback portal where appropriate. This is used
in the implementations of <a class="reference internal" href="#greenback.with_portal_run_tree" title="greenback.with_portal_run_tree"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run_tree()</span></code></a> and
<a class="reference internal" href="#greenback.portals_for_tree" title="greenback.portals_for_tree"><code class="xref py py-func docutils literal notranslate"><span class="pre">portals_for_tree()</span></code></a>. You can also pass an instance of this class
directly as an instrument to <a class="reference external" href="https://trio.readthedocs.io/en/stable/reference-core.html#trio.run" title="(in Trio v0.32.0)"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.run()</span></code></a> if you want to give every
task in the run (including system tasks) a portal.</p>
</dd></dl>

</section>
<section id="using-the-portal">
<h2>Using the portal<a class="headerlink" href="#using-the-portal" title="Link to this heading">¶</a></h2>
<p>Once you’ve set up a portal using any of the above functions, you can use it
to run async functions by making calls to <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a>:</p>
<dl class="py function">
<dt class="sig sig-object py" id="greenback.await_">
<span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">await_</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">awaitable</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#greenback.await_" title="Link to this definition">¶</a></dt>
<dd><p>Run an async function or await an awaitable from a synchronous function,
using the portal set up for the current async task by <a class="reference internal" href="#greenback.ensure_portal" title="greenback.ensure_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">ensure_portal()</span></code></a>,
<a class="reference internal" href="#greenback.bestow_portal" title="greenback.bestow_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">bestow_portal()</span></code></a>, <a class="reference internal" href="#greenback.with_portal_run" title="greenback.with_portal_run"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run()</span></code></a>, or <a class="reference internal" href="#greenback.with_portal_run_sync" title="greenback.with_portal_run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_portal_run_sync()</span></code></a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">greenback.await_(foo())</span></code> is equivalent to <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">foo()</span></code>, except that
the <a class="reference internal" href="#module-greenback" title="greenback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">greenback</span></code></a> version can be written in a synchronous function while
the native version cannot.</p>
</dd></dl>

</section>
<section id="additional-utilities">
<h2>Additional utilities<a class="headerlink" href="#additional-utilities" title="Link to this heading">¶</a></h2>
<p><a class="reference internal" href="#module-greenback" title="greenback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">greenback</span></code></a> comes with a few tools (built atop <a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">await_()</span></code></a>) which may
be helpful when adapting async code to work with synchronous interfaces.</p>
<dl class="py function">
<dt class="sig sig-object py" id="greenback.autoawait">
<span class="sig-prename descclassname"><span class="pre">&#64;</span></span><span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">autoawait</span></span><a class="headerlink" href="#greenback.autoawait" title="Link to this definition">¶</a></dt>
<dd><p>Decorator for an async function which allows (and requires) it to be called
from synchronous contexts without <code class="docutils literal notranslate"><span class="pre">await</span></code>.</p>
<p>For example, this can be used for magic methods, property setters, and so on.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="greenback.decorate_as_sync">
<span class="sig-prename descclassname"><span class="pre">&#64;</span></span><span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">decorate_as_sync</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">decorator</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Callable" title="(in Python v3.14)"><span class="pre">Callable</span></a><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="pre">F</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">F</span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Callable" title="(in Python v3.14)"><span class="pre">Callable</span></a><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="pre">AF</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">AF</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#greenback.decorate_as_sync" title="Link to this definition">¶</a></dt>
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">&#64;</span></span><span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">decorate_as_sync</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">decorator</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Callable" title="(in Python v3.14)"><span class="pre">Callable</span></a><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">...</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.14)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Callable" title="(in Python v3.14)"><span class="pre">Callable</span></a><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Callable" title="(in Python v3.14)"><span class="pre">Callable</span></a><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">...</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Awaitable" title="(in Python v3.14)"><span class="pre">Awaitable</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.14)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Callable" title="(in Python v3.14)"><span class="pre">Callable</span></a><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">...</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Awaitable" title="(in Python v3.14)"><span class="pre">Awaitable</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.14)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span></dt>
<dd><p>Wrap the synchronous function decorator <em>decorator</em> so that it can
be used to decorate an async function.</p>
<p>This can be used, for example, to apply an async-naive decorator such as
<a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.lru_cache" title="(in Python v3.14)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">&#64;functools.lru_cache()</span></code></a> to an async function:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@greenback</span><span class="o">.</span><span class="n">decorate_as_sync</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">some_fn</span><span class="p">(</span><span class="o">...</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<p>Without the wrapping in <a class="reference internal" href="#greenback.decorate_as_sync" title="greenback.decorate_as_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">decorate_as_sync()</span></code></a>, the LRU cache
would treat the inner function as a synchronous function, and
would therefore unhelpfully cache the coroutine object that is
returned when an async function is called without <code class="docutils literal notranslate"><span class="pre">await</span></code>.</p>
<p>Internally, the “inner” async function is wrapped in a synchronous
function that invokes that async function using
<a class="reference internal" href="#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a>. This synchronous function is then
decorated with the <em>decorator</em>. <a class="reference internal" href="#greenback.decorate_as_sync" title="greenback.decorate_as_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">decorate_as_sync()</span></code></a> returns
an “outer” async function which invokes the internal decorated
synchronous function using <a class="reference internal" href="#greenback.with_portal_run_sync" title="greenback.with_portal_run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.with_portal_run_sync()</span></code></a>.</p>
<p>In other words, the following two calls behave identically:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">greenback</span><span class="o">.</span><span class="n">decorate_as_sync</span><span class="p">(</span><span class="n">decorator</span><span class="p">)(</span><span class="n">async_fn</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">greenback</span><span class="o">.</span><span class="n">with_portal_run_sync</span><span class="p">(</span>
    <span class="n">decorator</span><span class="p">(</span><span class="n">greenback</span><span class="o">.</span><span class="n">autoawait</span><span class="p">(</span><span class="n">async_fn</span><span class="p">)),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="greenback.async_context">
<em class="property"><span class="pre">with</span> </em><span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">async_context</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">async_cm</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#greenback.async_context" title="Link to this definition">¶</a></dt>
<dd><p>Wraps an async context manager so it is usable in a synchronous <code class="docutils literal notranslate"><span class="pre">with</span></code>
statement. That is, <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">async_context(foo)</span> <span class="pre">as</span> <span class="pre">bar:</span></code> behaves equivantly
to <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span> <span class="pre">foo</span> <span class="pre">as</span> <span class="pre">bar:</span></code> as long as a portal has been created
somewhere up the callstack.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="greenback.async_iter">
<em class="property"><span class="pre">for</span> <span class="pre">...</span> <span class="pre">in</span> </em><span class="sig-prename descclassname"><span class="pre">greenback.</span></span><span class="sig-name descname"><span class="pre">async_iter</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">async_iterable</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#greenback.async_iter" title="Link to this definition">¶</a></dt>
<dd><p>Wraps an async iterable so it is usable in a synchronous <code class="docutils literal notranslate"><span class="pre">for</span></code> loop, <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code>
statement, or similar synchronous iteration context. That is, <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">elem</span> <span class="pre">in</span>
<span class="pre">async_iter(foo):</span></code> behaves equivantly
to <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">for</span> <span class="pre">elem</span> <span class="pre">in</span> <span class="pre">foo:</span></code> as long as a portal has been created
somewhere up the callstack.</p>
<p>If the obtained async iterator implements the full async generator protocol
(<code class="docutils literal notranslate"><span class="pre">asend()</span></code>, <code class="docutils literal notranslate"><span class="pre">athrow()</span></code>, and <code class="docutils literal notranslate"><span class="pre">aclose()</span></code> methods), then the returned
synchronous iterator implements the corresponding methods <code class="docutils literal notranslate"><span class="pre">send()</span></code>,
<code class="docutils literal notranslate"><span class="pre">throw()</span></code>, and <code class="docutils literal notranslate"><span class="pre">close()</span></code>. This allows for better interoperation with
<code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code>, for example.</p>
</dd></dl>

</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="principle.html" class="btn btn-neutral float-left" title="Principle of operation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="history.html" class="btn btn-neutral float-right" title="Release history" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Joshua Oreman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>