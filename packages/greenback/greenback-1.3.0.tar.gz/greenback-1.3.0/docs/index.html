

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>greenback: reenter an asyncio or Trio event loop from synchronous code &mdash; greenback 1.2.1+dev documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/documentation_options.js?v=307da5fd"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Principle of operation" href="principle.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="#">
            
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="principle.html">Principle of operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">Release history</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">greenback</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">greenback: reenter an asyncio or Trio event loop from synchronous code</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="greenback-reenter-an-asyncio-or-trio-event-loop-from-synchronous-code">
<h1>greenback: reenter an asyncio or Trio event loop from synchronous code<a class="headerlink" href="#greenback-reenter-an-asyncio-or-trio-event-loop-from-synchronous-code" title="Link to this heading">¶</a></h1>
<p>Python 3.5 introduced <code class="docutils literal notranslate"><span class="pre">async</span></code>/<code class="docutils literal notranslate"><span class="pre">await</span></code> syntax for defining
functions that can run concurrently in a cooperative multitasking
framework such as <code class="docutils literal notranslate"><span class="pre">asyncio</span></code> or <a class="reference external" href="https://trio.readthedocs.io/">Trio</a>. Such frameworks have a number of advantages
over previous approaches to concurrency: they scale better than threads and are
<a class="reference external" href="https://glyph.twistedmatrix.com/2014/02/unyielding.html">clearer about control flow</a>
than the implicit cooperative multitasking provided by <code class="docutils literal notranslate"><span class="pre">gevent</span></code>. They’re also being
actively developed to explore some <a class="reference external" href="https://vorpus.org/blog/notes-on-structured-concurrency-or-go-statement-considered-harmful/">exciting new ideas about concurrent programming</a>.</p>
<p>Porting an existing codebase to <code class="docutils literal notranslate"><span class="pre">async</span></code>/<code class="docutils literal notranslate"><span class="pre">await</span></code> syntax can be
challenging, though, since it’s somewhat “viral”: only an async
function can call another async function. That means you don’t just have
to modify the functions that actually perform I/O; you also need to
(trivially) modify every function that directly or indirectly calls a
function that performs I/O. While the results are generally an improvement
(“explicit is better than implicit”), getting there in one big step is not
always feasible, especially if some of these layers are in libraries that
you don’t control.</p>
<p><code class="docutils literal notranslate"><span class="pre">greenback</span></code> is a small library that attempts to bridge this gap. It
allows you to <strong>call back into async code from a syntactically
synchronous function</strong>, as long as the synchronous function was
originally called from an async task (running in an asyncio or Trio
event loop) that set up a <code class="docutils literal notranslate"><span class="pre">greenback</span></code> “portal” as explained
below. This is potentially useful in a number of different situations:</p>
<ul class="simple">
<li><p>You can interoperate with some existing libraries that are not
<code class="docutils literal notranslate"><span class="pre">async</span></code>/<code class="docutils literal notranslate"><span class="pre">await</span></code> aware, without pushing their work off into
another thread.</p></li>
<li><p>You can migrate an existing program to <code class="docutils literal notranslate"><span class="pre">async</span></code>/<code class="docutils literal notranslate"><span class="pre">await</span></code>
syntax one layer at a time, instead of all at once.</p></li>
<li><p>You can (cautiously) design async APIs that block in places where
you can’t write <code class="docutils literal notranslate"><span class="pre">await</span></code>, such as on attribute accesses.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">greenback</span></code> requires Python 3.8 or later and an implementation that
supports the <code class="docutils literal notranslate"><span class="pre">greenlet</span></code> library. Either CPython or PyPy should work.
There are no known OS dependencies.</p>
<section id="quickstart">
<h2>Quickstart<a class="headerlink" href="#quickstart" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>Call <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">greenback.ensure_portal()</span></code> at least once in each async
task that will be using <code class="docutils literal notranslate"><span class="pre">greenback</span></code>. (Additional calls in the same
task do nothing.) You can think of this as creating a portal that
will be used by future calls to <a class="reference internal" href="reference.html#greenback.await_" title="greenback.await_"><code class="xref py py-func docutils literal notranslate"><span class="pre">greenback.await_()</span></code></a> in the same
task.</p></li>
<li><p>Later, use <code class="docutils literal notranslate"><span class="pre">greenback.await_(foo())</span></code> as a replacement for
<code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">foo()</span></code> in places where you can’t write <code class="docutils literal notranslate"><span class="pre">await</span></code>.</p></li>
<li><p>If all of the places where you want to use
<code class="docutils literal notranslate"><span class="pre">greenback.await_()</span></code> are indirectly within a single function, you can
eschew the <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">greenback.ensure_portal()</span></code> and instead write a wrapper
around calls to that function: <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">greenback.with_portal_run(...)</span></code>
for an async function, or <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">greenback.with_portal_run_sync(...)</span></code>
for a synchronous function. These have the advantage of cleaning up the
portal (and its associated minor <a class="reference internal" href="principle.html#performance"><span class="std std-ref">performance impact</span></a>)
as soon as the function returns, rather than leaving it open until the task
terminates.</p></li>
<li><p>For more details and additional helpers, read the rest of this documentation!</p></li>
</ul>
</section>
<section id="detailed-documentation">
<h2>Detailed documentation<a class="headerlink" href="#detailed-documentation" title="Link to this heading">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="principle.html">Principle of operation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="principle.html#async-await-basics-and-limitations">Async/await basics and limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="principle.html#greenlets-a-different-approach">Greenlets: a different approach</a></li>
<li class="toctree-l2"><a class="reference internal" href="principle.html#using-greenlets-to-bridge-the-async-sync-divide">Using greenlets to bridge the async/sync divide</a></li>
<li class="toctree-l2"><a class="reference internal" href="principle.html#what-can-i-do-with-this-anyway">What can I do with this, anyway?</a></li>
<li class="toctree-l2"><a class="reference internal" href="principle.html#what-s-the-performance-impact">What’s the performance impact?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">API reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="reference.html#module-greenback">Creating a portal</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference.html#propagating-portals-to-a-task-s-children">Propagating portals to a task’s children</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference.html#using-the-portal">Using the portal</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference.html#additional-utilities">Additional utilities</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="history.html">Release history</a><ul>
<li class="toctree-l2"><a class="reference internal" href="history.html#greenback-1-3-0-2025-12-22">greenback 1.3.0 (2025-12-22)</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#greenback-1-2-1-2024-02-20">greenback 1.2.1 (2024-02-20)</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#greenback-1-2-0-2024-02-07">greenback 1.2.0 (2024-02-07)</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#greenback-1-1-2-2023-12-28">greenback 1.1.2 (2023-12-28)</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#greenback-1-1-1-2023-03-01">greenback 1.1.1 (2023-03-01)</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#greenback-1-1-0-2022-01-05">greenback 1.1.0 (2022-01-05)</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#greenback-1-0-0-2021-11-23">greenback 1.0.0 (2021-11-23)</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#greenback-0-3-0-2020-10-13">greenback 0.3.0 (2020-10-13)</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#greenback-0-2-0-2020-06-29">greenback 0.2.0 (2020-06-29)</a></li>
<li class="toctree-l2"><a class="reference internal" href="history.html#greenback-0-1-0-2020-05-02">greenback 0.1.0 (2020-05-02)</a></li>
</ul>
</li>
</ul>
</div>
</section>
</section>
<section id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Link to this heading">¶</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
<li><p><a class="reference external" href="https://trio.readthedocs.io/en/stable/glossary.html#glossary" title="(in Trio v0.32.0)"><span>Glossary</span></a></p></li>
</ul>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="principle.html" class="btn btn-neutral float-right" title="Principle of operation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Joshua Oreman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>