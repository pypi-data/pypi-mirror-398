---
- name: deploy sing-box tproxy
  hosts: "{{ playbook_hosts | default('pve-sing-box-tproxy') }}"
  become: true

  vars:
    # # roles/sing_box_defaults
    # sing-box 安装模式: [mixed, local, gateway]
    #   mixed: 仅安装并启用 mixed port, 不配置透明代理, 需要额外配置 system proxy
    #   local: 本地透明代理, 不代理内网中其它主机的流量
    #   gateway: 用作透明代理网关, 这也是目前的默认行为
    sing_box_mode: gateway

    # 覆盖 sing-box-config-updater 的 systemd timer 与 systemd service 状态
    # 用于应对当前大多数"服务商"开始订阅链接强制"阅后即焚"
    # choices: [reloaded, restarted, started, stopped]
    # sing_box_config_updater_timer_enabled: true
    # sing_box_config_updater_timer_interval: 1d
    # sing_box_config_updater_timer_state: started
    # sing_box_config_updater_service_state: started

    # # roles/sing_box_install
    # [sing-box, sing-box-beta]
    # apt_repo_packages:
    #   - sing-box

    # # roles/sing_box_config
    # github proxy for ruleset.url
    # sing_box_github_proxy: "https://gh.ak1ra.xyz/"

    # 用于从外部传入不同的 template 覆盖 templates/base.json.j2
    # sing_box_config_base_template: "{{ playbook_dir }}/config/base.json.j2"

    # 对应 /etc/sing-box/config.json 中 experimental 配置项
    # sing_box_clash_api_secret: "secret"
    # sing_box_clash_api_external_controller: "0.0.0.0:9090"

  pre_tasks:
    - name: run pre-flight validation checks
      ansible.builtin.import_tasks: tasks/pre_flight_checks.yml

  tasks:
    - name: install sing-box package
      ansible.builtin.import_role:
        name: sing_box_install

    - name: setup sing-box-config timer
      ansible.builtin.import_role:
        name: sing_box_config

    - name: setup sing-box-tproxy
      when: sing_box_mode in ['local', 'gateway']
      ansible.builtin.import_role:
        name: sing_box_tproxy
