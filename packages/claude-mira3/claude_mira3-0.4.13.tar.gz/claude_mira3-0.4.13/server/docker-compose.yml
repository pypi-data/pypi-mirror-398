services:
  # ===========================================
  # Core Storage Services
  # ===========================================

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    ports:
      - "${SERVER_IP:-127.0.0.1}:6333:6333"
      - "${SERVER_IP:-127.0.0.1}:6334:6334"
    volumes:
      - ${DATA_DIR:-/opt/mira}/qdrant/storage:/qdrant/storage
      - ${DATA_DIR:-/opt/mira}/qdrant/snapshots:/qdrant/snapshots
    environment:
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY}
      - QDRANT__LOG_LEVEL=${QDRANT_LOG_LEVEL:-INFO}

  postgres:
    image: postgres:17
    container_name: postgres
    restart: unless-stopped
    ports:
      - "${SERVER_IP:-127.0.0.1}:5432:5432"
    volumes:
      - ${DATA_DIR:-/opt/mira}/postgres/data:/var/lib/postgresql/data
      - ${DATA_DIR:-/opt/mira}/postgres/backups:/backups
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-mira}
      - POSTGRES_PASSWORD
      - POSTGRES_DB=${POSTGRES_DB:-mira}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mira} -d ${POSTGRES_DB:-mira}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ===========================================
  # Embedding Service
  # ===========================================

  embedding-service:
    image: drxelanull/mira-server:latest
    container_name: embedding-service
    restart: unless-stopped
    ports:
      - "${SERVER_IP:-127.0.0.1}:8200:8200"
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_API_KEY
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-mira_sessions}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-mira}
      - POSTGRES_USER=${POSTGRES_USER:-mira}
      - POSTGRES_PASSWORD
      - MODEL_NAME=${MODEL_NAME:-all-MiniLM-L6-v2}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8200/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Model loading takes time
