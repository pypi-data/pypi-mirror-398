name: Version Bump

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      bump:
        description: "Select version bump type"
        required: true
        default: patch
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  bump-version:
    name: bump-version
    permissions:
      contents: write
      pull-requests: write # Add this permission for creating PRs

    # Run if PR merged or manually triggered
    if: (github.event_name == 'pull_request' && github.event.pull_request.merged == true) || (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }} # Ensure we have push permissions

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install bump2version and packaging
        run: pip install bump2version packaging

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.PR_WRITE }}" | gh auth login --with-token

      - name: Set up git config
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git config --global user.name "${GITHUB_ACTOR}"
          git config -l

      - name: Determine bump type
        id: bump
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger: use input
            echo "bump=${{ github.event.inputs.bump }}" >> $GITHUB_OUTPUT
          else
            # PR merge: determine bump from labels
            # Use environment variable to safely handle JSON with special characters
            echo "Labels: $LABELS_JSON"
            if echo "$LABELS_JSON" | grep -q '"name": *"update-major"'; then
              echo "bump=major" >> $GITHUB_OUTPUT
            elif echo "$LABELS_JSON" | grep -q '"name": *"update-minor"'; then
              echo "bump=minor" >> $GITHUB_OUTPUT
            elif echo "$LABELS_JSON" | grep -q '"name": *"update-patch"'; then
              echo "bump=patch" >> $GITHUB_OUTPUT
            elif echo "$LABELS_JSON" | grep -q '"name": *"update-release"'; then
              echo "bump=release" >> $GITHUB_OUTPUT
            elif echo "$LABELS_JSON" | grep -q '"name": *"update-build"'; then
              echo "bump=build" >> $GITHUB_OUTPUT
            else
              echo "bump=none" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          LABELS_JSON: ${{ toJson(github.event.pull_request.labels) }}

      - name: Preview version bump
        if: steps.bump.outputs.bump != 'none'
        run: |
          BUMP_TYPE="${{ steps.bump.outputs.bump }}"
          echo "Previewing version bump: $BUMP_TYPE"
          bump2version --config-file .bumpversion.ini --dry-run --list $BUMP_TYPE

      - name: Bump version
        id: b2v
        if: steps.bump.outputs.bump != 'none'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BUMP_TYPE="${{ steps.bump.outputs.bump }}"

          # Create a new branch for manual bump
          BRANCH="bump/${BUMP_TYPE}-$(date +%Y%m%d%H%M%S)"
          git checkout -b $BRANCH

          # Perform the version bump
          bump2version --config-file .bumpversion.ini $BUMP_TYPE

          # Push the branch with tags
          git push origin $BRANCH --tags

          # Output branch name for PR step
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          echo "Branch created: $BRANCH"

          NEW_VERSION=$(grep -oP '(?<=^current_version = ).*' .bumpversion.ini)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create Pull Request (manual dispatch only)
        if: steps.bump.outputs.bump != 'none'
        run: |
          # Create PR using GitHub CLI
          gh pr create \
            --base main \
            --head "${{ steps.b2v.outputs.branch_name }}" \
            --title "Version bump (${{ steps.bump.outputs.bump }}) â†’ ${{ steps.b2v.outputs.new_version }}" \
            --body "## Automated Version Bump

            This PR bumps the version using the **${{ steps.bump.outputs.bump }}** strategy.

            ### Changes
            - Version bumped via \`bump2version\`
            - New version: ${{ steps.b2v.outputs.new_version }}
            - Configuration file: \`.bumpversion.ini\`

            ### Type
            - Bump type: \`${{ steps.bump.outputs.bump }}\`
            "

          # Set Labels
          pr_url=$(gh pr view "${{ steps.b2v.outputs.branch_name }}" --json url -q .url)
          gh pr edit "$pr_url" --add-label "automated" --add-label "bump-version"
