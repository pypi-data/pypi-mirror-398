[build-system]
requires = ["uv_build>=0.9.17,<0.10.0"]
build-backend = "uv_build"

[project]
name = "mh_structlog"
authors = [
    { name = "Mathieu Hinderyckx", email = "mathieu.hinderyckx@gmail.com" },
]
description = "Some Structlog configuration and wrappers to easily use structlog."
version = "0.0.45"
readme = "README.md"
requires-python = ">=3.10"
classifiers = [
    "Programming Language :: Python :: 3",
    "License :: OSI Approved :: MIT License",
    "Operating System :: OS Independent",
]
dependencies = [
    "orjson>=3.11.5",
    "rich>=14.2.0",
    "structlog>=25.5.0",
]
[project.optional-dependencies]
django = [
    "django>=5.0",
]
aws = [
    "aws-lambda-powertools>=3.23.0",
]
sentry = [
    "structlog-sentry>=2.2.1",
]

[tool.setuptools_scm]
version_file = "src/mh_structlog/_version.py"

[dependency-groups]
dev = [
    "ipdb>=0.13.13",
    "ipython>=8.18.1",
    "ruff>=0.14.9",
]
tests = [
    "coverage>=7.13.0",
    "django>=5",
    "freezegun>=1.5.5",
    "pytest>=9.0.2",
    "pytest-cov>=7.0.0",
    "pytest-django>=4.11.1",
    "pytest-env>=1.2.0",
    "pytest-randomly>=4.0.1",
    "pytest-sugar>=1.1.1",
]

[tool.uv]
required-version = ">=0.9.17"
package = true
environments = [
    "sys_platform == 'darwin'",
    "sys_platform == 'linux'",
    "sys_platform == 'win32'",
]

# ==== ruff ====
[tool.ruff]
line-length = 120
indent-width = 4
preview = false
required-version = ">=0.12"
target-version = "py310"
unsafe-fixes = true

# Overwritten in CI/CD
output-format = "full"
fix = true

[tool.ruff.lint]
preview = true
select = [
    # https://docs.astral.sh/ruff/rules/#rules
    "A",
    "AIR",
    "ANN",
    "ARG",
    "ASYNC",
    "B",
    "BLE",
    "C4",
    "C90",
    "COM",
    # "D",
    "DJ",
    "DOC",
    "DTZ",
    "E",
    "EM",
    "EXE",
    "F",
    "FA",
    "FBT",
    "FLY",
    "FURB",
    "G",
    "I",
    "ICN",
    "INP",
    "INT",
    "ISC",
    "LOG",
    "N",
    "NPY",
    "PD",
    "PERF",
    "PGH",
    "PIE",
    "PL",
    "PT",
    "PTH",
    "PYI",
    "Q",
    "R",
    "RET",
    "RSE",
    "RUF",
    "S",
    "SIM",
    "SLF",
    "SLOT",
    "T10",
    "T20",
    "TC",
    "TID",
    "TRY",
    "UP",
    "YTT",
    # "ERA",   # commented out code; not always best to have it removed forcefully, sometimes want to keep
]

ignore = [
    "ANN002",  # Missing type annotations for *args
    "ANN003",  # Missing type annotations for **kwargs
    "ANN204",  # Missing return type annotation for special method `__init__`
    "ANN401",  # Disallow Any type hints
    "COM812",  # Trailing comma missing. The ruff format always removes this on e.g. a list of function arguments.
    "D100",    # Missing docstring in public module
    "D105",    # Missing docstring in magic method
    "D106",    # Missing docstring in public nested class
    "D202",    # No blank line after function docstring
    "E501",    # Line too long
    "EM101",   # Exception must not use a string literal, assign to variable first
    "EM102",   # Exception must not use an f-string literal, assign to variable first
    "ISC001",  # Conflicting with formatter
    "PD011",   # pandas-use-of-dot-values. Ignored because it gives a lot of false positives every time .values is used on something.
    "Q000",    # Single quotes found but double quotes preferred
    "RUF012",  # mutable-class-default. Class attributes would required type annotations everywhere if enabled.
    "TRY002",  # Create your own exception
    "TRY003",  # Avoid specifying long messages outside the exception class
    "PGH003",  # Require specific codes when silencing linting.
    "FBT001",  # Boolean arguments in function calls
    "FBT002",  # Boolean arguments in function calls
    "RUF100",  # Report unused noqa directives. This clashes with the leniency from the ignore above this one.
    "DOC501",  # Raised exception {id} missing from docstring
    "PLR6301", # Not using self in a method
    "DOC201",  # Not mentioning 'return' explicitly in a docstring
    "A005",    # Module name is shadowing a python builtin module
]

# Allow fix for all enabled rules (when `--fix`) is provided.
fixable = ["ALL"]
unfixable = ["T201"]

# Allow unused variables when underscore-prefixed.
dummy-variable-rgx = "^(_+|(_+[a-zA-Z0-9_]*[a-zA-Z0-9]+?))$"

[tool.ruff.format]
preview = false
line-ending = "auto"
indent-style = "space"
quote-style = "preserve"
docstring-code-format = true
docstring-code-line-length = "dynamic"
exclude = ["*.pyi", "__pypackages__/", ".venv/", "env/", "venv/", ".git/", ".hg/", ".mypy_cache/", ".tox/", ".nox/", ".pytest_cache/", ".ruff_cache/"]


# Like Black, respect magic trailing commas.
skip-magic-trailing-comma = true

# 4. Ignore `E402` (import violations) in all `__init__.py` files, and in select subdirectories.
[tool.ruff.lint.per-file-ignores]
"__init__.py" = ["E402", "D104", "F403"]
"**/{tests,docs,tools}/*" = [
    "ANN201",
    "ARG001",
    "ARG002",
    "D101",
    "D102",
    "D103",
    "DOC402",
    "DJ008",
    "E402",
    "PLC2701",
    "PLR0914",
    "PLR0915",
    "PLR2004",
    "S101",
    "S105",
    "S311",
    "SLF001",
]
"test*.py" = [
    "ANN201",
    "ARG001",
    "ARG002",
    "D101",
    "D102",
    "D103",
    "DOC402",
    "DJ008",
    "E402",
    "PLC2701",
    "PLR0914",
    "PLR0915",
    "PLR2004",
    "S101",
    "S105",
    "S311",
    "SLF001",
]

[tool.ruff.lint.pylint]
max-args = 20
max-positional-args = 20

[tool.ruff.lint.pydocstyle]
convention = "google"

[tool.ruff.lint.flake8-quotes]
docstring-quotes = "double"
avoid-escape = true

[tool.ruff.lint.flake8-annotations]
allow-star-arg-any = true
ignore-fully-untyped = true     # allows for gradual typing
suppress-none-returning = false

[tool.ruff.lint.flake8-unused-arguments]
ignore-variadic-names = true

[tool.ruff.lint.isort]
force-single-line = false
combine-as-imports = true
force-wrap-aliases = false
detect-same-package = true
split-on-trailing-comma = false
known-local-folder = ["src"]
lines-after-imports = 2

# ==== pytest ====
[tool.pytest_env]
ENVIRONMENT = "test"
COLOR = 1

[tool.pytest]
addopts = ["-s", "--durations=5", "-v", "--import-mode=importlib", "--cov", "--cov-report=term", "--cov-report=html", "--cov-report=xml", "--junit-xml=junit.xml"]

junit_family = 'xunit2'
junit_suite_name = "test_suite"
junit_logging = 'all'
junit_log_passing_tests = true
junit_duration_report = "call"

python_files = ["*/tests.py", "*/test_*.py", "*/tests_*.py", "*/*.py"]
testpaths = ["tests", "src"]

filterwarnings = [
    "ignore::DeprecationWarning",
    "ignore::PendingDeprecationWarning",
]

# ==== Coverage ====
[tool.coverage.run]
omit = [
    "*/migrations/*",
    "*/media/*",
    ".venv/*",
    "terraform/*",
    "htmlcov/*",
    "staticfiles/*",
    "requirements/*",
    "manage.py",
    "asgi.py",
    "wsgi.py",
    "*/.vscode/*",
]
plugins = []
branch = true

[tool.coverage.report]
format = "text"
skip_empty = false
precision = 2

[tool.coverage.term]

[tool.coverage.html]
directory = "htmlcov"

[tool.coverage.xml]
output = "coverage.xml"
