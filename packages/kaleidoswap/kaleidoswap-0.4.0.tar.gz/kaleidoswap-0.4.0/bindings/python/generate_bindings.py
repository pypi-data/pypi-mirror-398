#!/usr/bin/env python3
"""
Generate UniFFI Python bindings from the UDL file.

This script uses the uniffi Python package to generate Python bindings
from the kaleidoswap.udl interface definition.
"""

import subprocess
import sys
from pathlib import Path

# Paths
REPO_ROOT = Path(__file__).parent.parent.parent
UDL_FILE = REPO_ROOT / "crates" / "kaleidoswap-uniffi" / "src" / "kaleidoswap.udl"
OUT_DIR = REPO_ROOT / "bindings" / "python" / "python" / "kaleidoswap"
LIB_FILE = OUT_DIR / "kaleidoswap.abi3.so"  # macOS, Linux would be .so


def main():
    """Generate Python bindings using uniffi-bindgen"""

    print(f"Generating Python bindings from {UDL_FILE}")
    print(f"Output directory: {OUT_DIR}")

    # Check if UDL file exists
    if not UDL_FILE.exists():
        print(f"Error: UDL file not found at {UDL_FILE}", file=sys.stderr)
        return 1

    # Try using uniffi_bindgen Python package if available
    try:
        cmd = [
            "uniffi-bindgen",
            "generate",
            str(UDL_FILE),
            "--language",
            "python",
            "--out-dir",
            str(OUT_DIR),
        ]

        if LIB_FILE.exists():
            cmd.extend(["--lib-file", str(LIB_FILE)])

        print(f"Running: {' '.join(cmd)}")
        result = subprocess.run(cmd, capture_output=True, text=True)

        if result.returncode != 0:
            print("uniffi-bindgen not found, trying Python-based generation...")
            # Fall back to Python-based generation
            generate_python_bindings()
        else:
            print("✅ Successfully generated Python bindings!")
            print(result.stdout)
            return 0

    except FileNotFoundError:
        print("uniffi-bindgen not found, using Python-based generation...")
        return generate_python_bindings()

    return 0


def generate_python_bindings():
    """Generate bindings using Python if uniffi-bindgen binary isn't available"""
    python_code = f"""
import sys
from pathlib import Path

# Read the UDL file
udl_file = Path(r"{UDL_FILE}")
out_dir = Path(r"{OUT_DIR}")

if not udl_file.exists():
    print(f"UDL file not found: {{udl_file}}", file=sys.stderr)
    sys.exit(1)

udl_content = udl_file.read_text()

# For now, create a placeholder that shows what needs to be done
placeholder = '''
# This file should be auto-generated by uniffi-bindgen
# For now, we need to manually generate it or install uniffi-bindgen

# To generate this file, run:
# uniffi-bindgen generate {UDL_FILE} --language python --out-dir {OUT_DIR}

# Or install uniffi Python package and use its API
'''

print("⚠️  uniffi-bindgen is not available.")
print("The Python bindings need to be generated using the crate-provided binding generator.")
print("")
print("Recommended approach:")
print("1. Use the maturin + uniffi integration by ensuring the correct build setup")
print("2. Or manually run: uniffi-bindgen generate ... --language python")
"""

    try:
        subprocess.run([sys.executable, "-c", python_code], check=True)
        return 0
    except subprocess.CalledProcessError as e:
        print(f"Error generating Python bindings: {e}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    sys.exit(main())
