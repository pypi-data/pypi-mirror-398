name: Performance Monitoring

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

# Optimize concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Install uv
        uses: astral-sh/setup-uv@374b9305c53f17cee51e793c1234cdb1897489d5  # v7
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: |
          uv sync --all-extras
          uv pip install pytest-benchmark memory-profiler

      - name: Run benchmarks
        id: run-benchmarks
        run: |
          # Run benchmarks and capture exit code
          uv run pytest tests/ -v -p no:xdist -o "addopts=" --benchmark-only --benchmark-autosave --benchmark-json=benchmark.json || true
          # Check if benchmark.json has actual benchmark data
          if [ -f benchmark.json ] && [ -s benchmark.json ]; then
            # Verify it's valid JSON with benchmarks
            if python -c "import json; data=json.load(open('benchmark.json')); exit(0 if data.get('benchmarks') else 1)" 2>/dev/null; then
              echo "has_benchmarks=true" >> $GITHUB_OUTPUT
            else
              echo "has_benchmarks=false" >> $GITHUB_OUTPUT
              echo "No benchmark tests found in test suite"
            fi
          else
            echo "has_benchmarks=false" >> $GITHUB_OUTPUT
            echo "No benchmark tests found in test suite"
          fi

      - name: Download previous benchmark data
        if: steps.run-benchmarks.outputs.has_benchmarks == 'true'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4
        with:
          path: ./cache
          key: ${{ runner.os }}-benchmark

      - name: Store benchmark result
        if: steps.run-benchmarks.outputs.has_benchmarks == 'true'
        uses: benchmark-action/github-action-benchmark@4bdcce38c94cec68da58d012ac24b7b1155efe8b  # v1.20.7
        with:
          name: Python Benchmark
          tool: 'pytest'
          output-file-path: benchmark.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: '200%'
          comment-on-alert: true
          fail-on-alert: true
          alert-comment-cc-users: '@Dashtid'

  memory-profiling:
    name: Memory Profiling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Install uv
        uses: astral-sh/setup-uv@374b9305c53f17cee51e793c1234cdb1897489d5  # v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: |
          uv sync --all-extras
          uv pip install memory-profiler matplotlib

      - name: Profile memory usage
        run: |
          # Create memory profiling script
          cat > profile_memory.py << 'EOF'
          import tempfile
          from pathlib import Path
          from memory_profiler import profile
          from pydicom.dataset import Dataset, FileMetaDataset, FileDataset
          from pydicom.uid import generate_uid
          from dicom_fuzzer.core.parser import DicomParser
          from dicom_fuzzer.core.mutator import DicomMutator

          def create_test_dicom_file():
              """Create a minimal DICOM file for testing."""
              # Create temp file
              temp_dir = tempfile.mkdtemp()
              temp_path = Path(temp_dir) / "test.dcm"

              # Create file meta
              file_meta = FileMetaDataset()
              file_meta.MediaStorageSOPClassUID = "1.2.840.10008.5.1.4.1.1.2"
              file_meta.MediaStorageSOPInstanceUID = generate_uid()
              file_meta.TransferSyntaxUID = "1.2.840.10008.1.2"
              file_meta.ImplementationClassUID = generate_uid()

              # Create dataset
              ds = FileDataset(str(temp_path), {}, file_meta=file_meta, preamble=b"\x00" * 128)
              ds.SOPClassUID = file_meta.MediaStorageSOPClassUID
              ds.SOPInstanceUID = file_meta.MediaStorageSOPInstanceUID
              ds.PatientName = "TEST^PATIENT"
              ds.PatientID = "12345"
              ds.Modality = "CT"
              ds.Rows = 64
              ds.Columns = 64
              ds.BitsAllocated = 16
              ds.BitsStored = 16
              ds.HighBit = 15
              ds.PixelRepresentation = 0
              ds.SamplesPerPixel = 1
              ds.PhotometricInterpretation = "MONOCHROME2"
              ds.PixelData = b"\x00" * (64 * 64 * 2)

              # Save to file
              ds.save_as(str(temp_path), write_like_original=False)
              return temp_path, ds

          @profile
          def test_parser_memory():
              """Profile DICOM parser memory usage."""
              temp_path, _ = create_test_dicom_file()
              parser = DicomParser(str(temp_path))
              metadata = parser.extract_metadata()
              return metadata

          @profile
          def test_mutator_memory():
              """Profile DICOM mutator memory usage."""
              _, dataset = create_test_dicom_file()
              mutator = DicomMutator()
              mutator.start_session(dataset)
              for _ in range(100):
                  mutated = mutator.apply_mutations(dataset, num_mutations=5)
              return mutated

          if __name__ == '__main__':
              print("Memory profiling DICOM parser...")
              test_parser_memory()
              print("\nMemory profiling DICOM mutator...")
              test_mutator_memory()
          EOF

          uv run python -m memory_profiler profile_memory.py > memory-profile.txt

      - name: Upload memory profile
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5
        with:
          name: memory-profile
          path: memory-profile.txt

  load-testing:
    name: Load Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Install uv
        uses: astral-sh/setup-uv@374b9305c53f17cee51e793c1234cdb1897489d5  # v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: |
          uv sync --all-extras
          uv pip install locust

      - name: Create load test script
        run: |
          cat > locustfile.py << 'EOF'
          from locust import User, task, between
          from pydicom.dataset import Dataset, FileMetaDataset
          from pydicom.uid import generate_uid
          from dicom_fuzzer.core.mutator import DicomMutator
          from dicom_fuzzer.core.validator import DicomValidator

          def create_test_dataset():
              """Create a minimal DICOM dataset for testing."""
              ds = Dataset()
              ds.file_meta = FileMetaDataset()
              ds.file_meta.MediaStorageSOPClassUID = "1.2.840.10008.5.1.4.1.1.2"
              ds.file_meta.MediaStorageSOPInstanceUID = generate_uid()
              ds.file_meta.TransferSyntaxUID = "1.2.840.10008.1.2"
              ds.SOPClassUID = ds.file_meta.MediaStorageSOPClassUID
              ds.SOPInstanceUID = ds.file_meta.MediaStorageSOPInstanceUID
              ds.PatientName = "TEST^PATIENT"
              ds.PatientID = "12345"
              ds.Modality = "CT"
              ds.Rows = 64
              ds.Columns = 64
              ds.BitsAllocated = 16
              ds.BitsStored = 16
              ds.HighBit = 15
              ds.PixelRepresentation = 0
              ds.SamplesPerPixel = 1
              ds.PhotometricInterpretation = "MONOCHROME2"
              ds.PixelData = b"\x00" * (64 * 64 * 2)
              return ds

          class DicomFuzzerUser(User):
              wait_time = between(0.1, 0.5)

              def on_start(self):
                  """Initialize fuzzer components."""
                  self.mutator = DicomMutator()
                  self.validator = DicomValidator()

              @task(3)
              def generate_dicom(self):
                  """Generate DICOM dataset."""
                  dataset = create_test_dataset()

              @task(5)
              def mutate_dicom(self):
                  """Mutate DICOM dataset."""
                  dataset = create_test_dataset()
                  self.mutator.start_session(dataset)
                  mutated = self.mutator.apply_mutations(dataset, num_mutations=5)

              @task(2)
              def validate_dicom(self):
                  """Validate DICOM dataset."""
                  dataset = create_test_dataset()
                  result = self.validator.validate(dataset)
          EOF

      - name: Run load test
        run: |
          uv run locust -f locustfile.py --headless --users 10 --spawn-rate 2 --run-time 60s --html load-test-report.html

      - name: Upload load test report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5
        with:
          name: load-test-report
          path: load-test-report.html

  cpu-profiling:
    name: CPU Profiling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Install uv
        uses: astral-sh/setup-uv@374b9305c53f17cee51e793c1234cdb1897489d5  # v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: |
          uv sync --all-extras
          uv pip install py-spy

      - name: CPU profiling with py-spy
        run: |
          # Create profiling script
          cat > cpu_profile.py << 'EOF'
          from pydicom.dataset import Dataset, FileMetaDataset
          from pydicom.uid import generate_uid
          from dicom_fuzzer.core.mutator import DicomMutator

          def create_test_dataset():
              """Create a minimal DICOM dataset for testing."""
              ds = Dataset()
              ds.file_meta = FileMetaDataset()
              ds.file_meta.MediaStorageSOPClassUID = "1.2.840.10008.5.1.4.1.1.2"
              ds.file_meta.MediaStorageSOPInstanceUID = generate_uid()
              ds.file_meta.TransferSyntaxUID = "1.2.840.10008.1.2"
              ds.SOPClassUID = ds.file_meta.MediaStorageSOPClassUID
              ds.SOPInstanceUID = ds.file_meta.MediaStorageSOPInstanceUID
              ds.PatientName = "TEST^PATIENT"
              ds.PatientID = "12345"
              ds.Modality = "CT"
              ds.Rows = 64
              ds.Columns = 64
              ds.BitsAllocated = 16
              ds.BitsStored = 16
              ds.HighBit = 15
              ds.PixelRepresentation = 0
              ds.SamplesPerPixel = 1
              ds.PhotometricInterpretation = "MONOCHROME2"
              ds.PixelData = b"\x00" * (64 * 64 * 2)
              return ds

          def main():
              mutator = DicomMutator()

              for _ in range(1000):
                  dataset = create_test_dataset()
                  mutator.start_session(dataset)
                  mutated = mutator.apply_mutations(dataset, num_mutations=10)

          if __name__ == '__main__':
              main()
          EOF

          # py-spy may exit with non-zero when the profiled process exits
          # Use || true to handle this gracefully
          uv run py-spy record -o cpu-profile.svg --format speedscope -- python cpu_profile.py || true
          # Verify profile was created
          if [ -f cpu-profile.svg ]; then
            echo "CPU profile created successfully"
          else
            echo "Warning: CPU profile not created, creating empty placeholder"
            echo '<svg></svg>' > cpu-profile.svg
          fi

      - name: Upload CPU profile
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5
        with:
          name: cpu-profile
          path: cpu-profile.svg

  performance-summary:
    name: Performance Summary
    runs-on: ubuntu-latest
    needs: [benchmark, memory-profiling, load-testing, cpu-profiling]
    if: always()
    steps:
      - name: Check performance status
        run: |
          echo "Performance Monitoring Summary"
          echo "=============================="
          echo "Benchmarks: ${{ needs.benchmark.result }}"
          echo "Memory Profiling: ${{ needs.memory-profiling.result }}"
          echo "Load Testing: ${{ needs.load-testing.result }}"
          echo "CPU Profiling: ${{ needs.cpu-profiling.result }}"

          if [ "${{ needs.benchmark.result }}" != "success" ]; then
            echo "Warning: Performance benchmarks did not complete successfully"
          fi

          echo "Performance monitoring completed!"
