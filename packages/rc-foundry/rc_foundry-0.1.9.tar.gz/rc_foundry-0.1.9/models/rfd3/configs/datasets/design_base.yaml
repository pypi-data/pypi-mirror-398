# base training dataset for training AF3 design models (atom14 variants):
# protein subsampling only.

defaults:
  # Grab datasets
  - train/pdb/rfd3_train_interface@train.pdb.sub_datasets.interface
  - train/pdb/rfd3_train_pn_unit@train.pdb.sub_datasets.pn_unit
  #- train/rfd3_monomer_distillation@train
  
  # Customized validation datasets
  - val/unconditional@val.unconditional
  - val/unconditional_deep@val.unconditional_deep
  - val/indexed@val.indexed

  # Customized train masks
  - conditions/unconditional@global_transform_args.train_conditions.unconditional
  - conditions/island@global_transform_args.train_conditions.island
  - conditions/tipatom@global_transform_args.train_conditions.tipatom
  - conditions/sequence_design@global_transform_args.train_conditions.sequence_design
  - conditions/ppi@global_transform_args.train_conditions.ppi

  - _self_

# Create a dictionary used for transform arguments
pipeline_target: rfd3.transforms.pipelines.build_atom14_base_pipeline

# Base config overrides:
diffusion_batch_size_train: 32
diffusion_batch_size_inference: 8
crop_size: 384
n_recycles_train: 2
n_recycles_validation: 1
max_atoms_in_crop: 3840  # ~10x crop size.

# Global transform arguments are necessary for arguments shared between training and inference
global_transform_args:
  n_atoms_per_token: 14
  central_atom: CB
  sigma_perturb: 2.0
  sigma_perturb_com: 1.0
  association_scheme: dense
  center_option: diffuse  # options are ["all", "motif", "diffuse"]

  # Reference conformer policy
  generate_conformers: True
  generate_conformers_for_non_protein_only: True
  provide_reference_conformer_when_unmasked: True
  ground_truth_conformer_policy: IGNORE  # Other options: REPLACE, ADD, FALLBACK. See atomworks.enums for details
  provide_elements_for_unindexed_components: True
  use_element_for_atom_names_of_atomized_tokens: True  # TODO: correct name, implies unindexed do too

  # PPI Cropping
  keep_full_binder_in_spatial_crop: False
  max_binder_length: 170

  # PPI Hotspots
  max_ppi_hotspots_frac_to_provide: 0.2
  ppi_hotspot_max_distance: 4.5

  # Secondary structure features
  max_ss_frac_to_provide: 0.4
  min_ss_island_len: 1
  max_ss_island_len: 10

  train_conditions:
    unconditional:
      frequency: 5.0
    sequence_design:
      frequency: 2.0
    island:
      frequency: 1.0
    tipatom:
      frequency: 0.0
    ppi:
      frequency: 0.0

  # Used to create simple boolean flags for downstream conditioning
  meta_conditioning_probabilities:
    calculate_hbonds: 0.2
    calculate_rasa: 0.6

    keep_protein_motif_rasa: 0.1  # Small to prevent noisy input to model
    hbond_subsample: 0.5
    
    # fully indexed training
    unindex_leak_global_index: 0.10
    unindex_insert_random_break: 0.10
    unindex_remove_random_break: 0.10

    # Probability of adding 1d secondary structure conditioning
    add_1d_ss_features: 0.1
    featurize_plddt: 0.9  # Applied for monomer distillation only
    add_global_is_non_loopy_feature: 0.99

    # PPI
    add_ppi_hotspots: 0.75
    full_binder_crop: 0.75
