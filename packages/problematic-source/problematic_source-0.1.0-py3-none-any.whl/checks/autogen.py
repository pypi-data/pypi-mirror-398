import os

from checks.base import Checker
from problem import Problem, Severity

class AutogenChecker(Checker):
    STRINGS = [
        "has been AutoGen-ed",
        "Generated from AutoOpts",
    ]
    MAGIC = 0xA0E7

    def execute(self, file: str) -> Problem | None:
        has_def = False
        for filename in os.listdir(os.path.dirname(file)):
            if filename.endswith(".def"):
                has_def = True
                break

        if self._text_deep(file) or (self._is_text(file) and has_def):
            with open(file, "rb") as f:
                data = f.read()
                for string in self.STRINGS:
                    if string.encode("utf-8") in data:
                        return Problem(Severity.ERROR, "file generated by autogen", file, self.MAGIC)

        return None
