name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run linter
        run: uv run ruff check solvor/

  typecheck:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run type checker
        run: uv run mypy solvor/

  # Detect which solvers have changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      simplex: ${{ steps.filter.outputs.simplex }}
      milp: ${{ steps.filter.outputs.milp }}
      anneal: ${{ steps.filter.outputs.anneal }}
      tabu: ${{ steps.filter.outputs.tabu }}
      sat: ${{ steps.filter.outputs.sat }}
      cp: ${{ steps.filter.outputs.cp }}
      bayesian: ${{ steps.filter.outputs.bayesian }}
      genetic: ${{ steps.filter.outputs.genetic }}
      flow: ${{ steps.filter.outputs.flow }}
      gradient: ${{ steps.filter.outputs.gradient }}
      dlx: ${{ steps.filter.outputs.dlx }}
      bfs: ${{ steps.filter.outputs.bfs }}
      dijkstra: ${{ steps.filter.outputs.dijkstra }}
      a_star: ${{ steps.filter.outputs.a_star }}
      bellman_ford: ${{ steps.filter.outputs.bellman_ford }}
      floyd_warshall: ${{ steps.filter.outputs.floyd_warshall }}
      mst: ${{ steps.filter.outputs.mst }}
      network_simplex: ${{ steps.filter.outputs.network_simplex }}
      hungarian: ${{ steps.filter.outputs.hungarian }}
      utils: ${{ steps.filter.outputs.utils }}
      types: ${{ steps.filter.outputs.types }}
      infra: ${{ steps.filter.outputs.infra }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            simplex:
              - 'solvor/simplex.py'
              - 'tests/test_simplex.py'
            milp:
              - 'solvor/milp.py'
              - 'solvor/simplex.py'
              - 'tests/test_milp.py'
            anneal:
              - 'solvor/anneal.py'
              - 'tests/test_anneal.py'
            tabu:
              - 'solvor/tabu.py'
              - 'tests/test_tabu.py'
            sat:
              - 'solvor/sat.py'
              - 'tests/test_sat.py'
            cp:
              - 'solvor/cp.py'
              - 'solvor/sat.py'
              - 'tests/test_cp.py'
            bayesian:
              - 'solvor/bayesian.py'
              - 'tests/test_bayesian.py'
            genetic:
              - 'solvor/genetic.py'
              - 'tests/test_genetic.py'
            flow:
              - 'solvor/flow.py'
              - 'tests/test_flow.py'
            gradient:
              - 'solvor/gradient.py'
              - 'tests/test_gradient.py'
            dlx:
              - 'solvor/dlx.py'
              - 'tests/test_dlx.py'
            bfs:
              - 'solvor/bfs.py'
              - 'tests/test_bfs.py'
            dijkstra:
              - 'solvor/dijkstra.py'
              - 'tests/test_dijkstra.py'
            a_star:
              - 'solvor/a_star.py'
              - 'tests/test_a_star.py'
            bellman_ford:
              - 'solvor/bellman_ford.py'
              - 'tests/test_bellman_ford.py'
            floyd_warshall:
              - 'solvor/floyd_warshall.py'
              - 'tests/test_floyd_warshall.py'
            mst:
              - 'solvor/mst.py'
              - 'tests/test_mst.py'
            network_simplex:
              - 'solvor/network_simplex.py'
              - 'tests/test_network_simplex.py'
            hungarian:
              - 'solvor/hungarian.py'
              - 'tests/test_hungarian.py'
            utils:
              - 'solvor/utils.py'
              - 'tests/test_utils.py'
            types:
              - 'solvor/types.py'
              - 'solvor/__init__.py'
            infra:
              - 'pyproject.toml'
              - 'tests/conftest.py'

  # Full test suite with coverage on main branch or when test infrastructure changes
  test-all:
    needs: changes
    if: ${{ github.ref == 'refs/heads/main' || needs.changes.outputs.infra == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          python-version: ${{ matrix.python-version }}
      - run: uv sync --extra dev
      - name: Run tests with coverage
        run: uv run pytest tests/ -v --cov=solvor --cov-report=xml --cov-report=term-missing --cov-fail-under=88

      - name: Upload coverage reports to Codecov
        if: matrix.python-version == '3.13'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          fail_ci_if_error: true

      - name: Upload test results to Codecov
        if: ${{ !cancelled() && matrix.python-version == '3.13' }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  # Run tests for changed solvers only (skipped when test-all runs)
  test-simplex:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.simplex == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_simplex.py -v

  test-milp:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.milp == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_milp.py -v

  test-anneal:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.anneal == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_anneal.py -v

  test-tabu:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.tabu == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_tabu.py -v

  test-sat:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.sat == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_sat.py -v

  test-cp:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.cp == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_cp.py -v

  test-bayesian:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.bayesian == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_bayesian.py -v

  test-genetic:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.genetic == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_genetic.py -v

  test-flow:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.flow == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_flow.py -v

  test-gradient:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.gradient == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_gradient.py -v

  test-dlx:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.dlx == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_dlx.py -v

  test-bfs:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.bfs == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_bfs.py -v

  test-dijkstra:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.dijkstra == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_dijkstra.py -v

  test-a_star:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.a_star == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_a_star.py -v

  test-bellman_ford:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.bellman_ford == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_bellman_ford.py -v

  test-floyd_warshall:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.floyd_warshall == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_floyd_warshall.py -v

  test-mst:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.mst == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_mst.py -v

  test-network_simplex:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.network_simplex == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_network_simplex.py -v

  test-hungarian:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.hungarian == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_hungarian.py -v

  test-utils:
    needs: changes
    if: ${{ needs.changes.outputs.infra != 'true' && github.ref != 'refs/heads/main' && (needs.changes.outputs.utils == 'true' || needs.changes.outputs.types == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest tests/test_utils.py -v
