services:
  glurpc:
    #image: glucosedao/glurpc:latest
    image: ghcr.io/glucosedao/glurpc:latest
    container_name: glurpc-service
    restart: unless-stopped
    
    ports:
      # gRPC on localhost only
      - "127.0.0.1:7003:7003"
      # REST on all interfaces
      - "8000:8000"
    
    volumes:
      # Cache persistence using named volume
      - glurpc-cache:/app/cache_storage:z
      # Logs to host directory for easy access (parent dir)
      - ../logs:/app/logs:z
      # API keys file (parent dir)
      - ../api_keys_list:/app/api_keys_list:ro,Z
      # SNET daemon build directory (current dir = snetd_daemon)
      - .:/app/snetd_daemon:z
    
    environment:
      # --- Cache Configuration ---
      MAX_CACHE_SIZE: 128
      ENABLE_CACHE_PERSISTENCE: "True"
      
      # --- Data Processing Configuration ---
      # Note: These use model defaults if not set (MINIMUM_DURATION_MINUTES=540, MAXIMUM_WANTED_DURATION=1080)
      # Uncomment to override:
      MINIMUM_DURATION_MINUTES: 540
      MAXIMUM_WANTED_DURATION: 1080
      
      # --- API Configuration ---
      ENABLE_API_KEYS: "True"
      
      # --- Model and Inference Configuration ---
      NUM_COPIES_PER_DEVICE: 2
      BACKGROUND_WORKERS_COUNT: 4
      BATCH_SIZE: 32
      NUM_SAMPLES: 10
      
      # --- Timeout Configuration ---
      INFERENCE_TIMEOUT_GPU: 600.0
      INFERENCE_TIMEOUT_CPU: 7200.0
      
      # --- Queue Configuration ---
      MAX_INFERENCE_QUEUE_SIZE: 64
      MAX_CALC_QUEUE_SIZE: 8192
      
      # --- Logging Configuration ---
      LOG_LEVEL_ROOT: INFO
      LOG_LEVEL_LOGIC: INFO
      LOG_LEVEL_ENGINE: INFO
      LOG_LEVEL_CORE: INFO
      LOG_LEVEL_APP: INFO
      LOG_LEVEL_STATE: INFO
      LOG_LEVEL_CACHE: INFO
      LOG_LEVEL_LOCKS: ERROR
      GLURPC_LOGS_DIR: /app/logs
      GLURPC_VERBOSE: "False"
      
      # --- Application Paths Configuration ---
      GLURPC_APP_ROOT: /app
      GLURPC_CACHE_DIR: /app/cache_storage
      GLURPC_API_KEYS_FILE: /app/api_keys_list
    
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Override command for different modes:
    # Default (combined service, no daemon - daemon runs in separate container):
    command: ["glurpc-combined", "--combined"]
    #
    # REST only:
    #   command: ["glurpc-combined", "--rest"]
    #
    # gRPC only:
    #   command: ["glurpc-combined", "--grpc"]
  
  # SNET Daemon in separate container (optional, comment out if not using SNET)
  # Note: Paths are relative to snetd_daemon/ directory
  snetd:
    build:
      context: .
      dockerfile: Dockerfile.snetd
      args:
        SNETD_VERSION: v6.2.0  # or leave unset for latest
    container_name: glurpc-snetd
    restart: unless-stopped
    
    ports:
      # SNET daemon ports on localhost only
      - "127.0.0.1:7001:7001"
      - "127.0.0.1:7002:7002"
      # HTTP for Let's Encrypt certificate challenges (uncomment if needed)
      # - "127.0.0.1:80:80"
      # ETCD ports (uncomment if needed for external access)
      # - "127.0.0.1:2379:2379"
      # - "127.0.0.1:2380:2380"
    
    volumes:
      # SNET daemon ETCD data persistence
      - glurpc-etcd:/opt/singnet/etcd:z
      # SNET daemon configuration files (current dir)
      - ./snetd_configs:/opt/singnet/snetd_configs:z
      # SSL certificates (current dir)
      - ./certs:/opt/singnet/.certs:z
    
    # Daemon needs to reach the gRPC service
    depends_on:
      glurpc:
        condition: service_healthy
    
    # Override for different networks (sepolia, mainnet, etc)
    # Config file is in snetd_daemon/snetd_configs/ (auto-populated on first run)
    command: ["snetd", "serve", "--config", "/opt/singnet/snetd_configs/snetd.sepolia.json"]
    
    healthcheck:
      test: ["CMD-SHELL", "pgrep snetd || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Resource limits (optional, adjust based on your needs)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4.0'
    #       memory: 8G
    #     reservations:
    #       cpus: '2.0'
    #       memory: 4G

volumes:
  glurpc-cache:
    name: glurpc-cache
  glurpc-etcd:
    name: glurpc-etcd
    driver: local
